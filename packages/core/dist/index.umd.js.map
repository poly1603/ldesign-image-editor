{"version":3,"file":"index.umd.js","sources":["../src/constants/defaults.ts","../src/constants/events.ts","../src/utils/dom.utils.ts","../src/utils/image.utils.ts","../src/utils/event.utils.ts","../src/utils/device.utils.ts","../src/utils/export.utils.ts","../src/utils/placeholder.ts","../src/managers/EventManager.ts","../src/managers/ConfigManager.ts","../src/managers/HistoryManager.ts","../src/managers/PluginManager.ts","../src/managers/KeyboardManager.ts","../src/core/Canvas.ts","../src/ui/icons.ts","../src/ui/toolbar.styles.ts","../src/ui/ShapeLayer.ts","../src/ui/Toolbar.ts","../src/core/Editor.ts","../src/plugins/base/BasePlugin.ts","../src/plugins/mosaic/mosaic.utils.ts","../src/plugins/mosaic/MosaicPlugin.ts","../src/plugins/text/TextLayer.ts","../src/plugins/text/text.utils.ts","../src/plugins/text/TextPlugin.ts","../src/plugins/filter/filters/brightness.ts","../src/plugins/filter/filters/contrast.ts","../src/plugins/filter/filters/saturation.ts","../src/plugins/filter/filters/blur.ts","../src/plugins/filter/filters/grayscale.ts","../src/plugins/filter/FilterPlugin.ts","../src/i18n/locales/zh-CN.ts","../src/i18n/locales/en-US.ts","../src/i18n/index.ts","../src/ui/CropTool.ts","../src/ui/ContextMenu.ts","../src/ui/ExportDialog.ts","../src/ui/Rulers.ts","../src/index.ts"],"sourcesContent":["/**\r\n * Default configuration constants\r\n * Requirements: 10.1 - Configuration system\r\n */\r\n\r\nimport type {\r\n  EditorConfig,\r\n  MosaicConfig,\r\n  TextConfig,\r\n  FilterConfig,\r\n  ExportOptions,\r\n} from '../types';\r\n\r\n/**\r\n * Default editor configuration\r\n */\r\nexport const DEFAULT_EDITOR_CONFIG: Required<EditorConfig> = {\r\n  width: 800,\r\n  height: 600,\r\n  backgroundColor: 'transparent',\r\n  historyLimit: 50,\r\n  responsive: true,\r\n  deviceType: 'auto',\r\n};\r\n\r\n/**\r\n * Default mosaic plugin configuration\r\n */\r\nexport const DEFAULT_MOSAIC_CONFIG: MosaicConfig = {\r\n  blockSize: 10,\r\n  intensity: 100,\r\n  mode: 'free',\r\n  brushSize: 20,\r\n};\r\n\r\n/**\r\n * Default text plugin configuration\r\n */\r\nexport const DEFAULT_TEXT_CONFIG: TextConfig = {\r\n  fontSize: 16,\r\n  fontFamily: 'Arial',\r\n  color: '#000000',\r\n  bold: false,\r\n  italic: false,\r\n  underline: false,\r\n  align: 'left',\r\n  lineHeight: 1.2,\r\n};\r\n\r\n/**\r\n * Default filter plugin configuration\r\n */\r\nexport const DEFAULT_FILTER_CONFIG: FilterConfig = {\r\n  brightness: 0,\r\n  contrast: 0,\r\n  saturation: 0,\r\n  blur: 0,\r\n  grayscale: 0,\r\n  sepia: 0,\r\n  invert: 0,\r\n};\r\n\r\n/**\r\n * Default export options\r\n */\r\nexport const DEFAULT_EXPORT_OPTIONS: Required<ExportOptions> = {\r\n  format: 'png',\r\n  quality: 0.92,\r\n  width: 0, // 0 means use original size\r\n  height: 0,\r\n  type: 'base64',\r\n  fileName: 'image',\r\n};\r\n","/**\r\n * Event name constants\r\n * Requirements: 1.2, 1.4 - Event system\r\n */\r\n\r\n/**\r\n * Editor event names\r\n */\r\nexport const EDITOR_EVENTS = {\r\n  /** Editor is ready */\r\n  READY: 'ready',\r\n  /** Error occurred */\r\n  ERROR: 'error',\r\n  /** Image loaded */\r\n  IMAGE_LOADED: 'image-loaded',\r\n  /** Tool changed */\r\n  TOOL_CHANGE: 'tool-change',\r\n  /** History changed */\r\n  HISTORY_CHANGE: 'history-change',\r\n  /** Before export */\r\n  BEFORE_EXPORT: 'before-export',\r\n  /** After export */\r\n  AFTER_EXPORT: 'after-export',\r\n  /** Editor destroyed */\r\n  DESTROY: 'destroy',\r\n} as const;\r\n\r\n/**\r\n * Plugin event names\r\n */\r\nexport const PLUGIN_EVENTS = {\r\n  /** Plugin installed */\r\n  INSTALLED: 'plugin-installed',\r\n  /** Plugin activated */\r\n  ACTIVATED: 'plugin-activated',\r\n  /** Plugin deactivated */\r\n  DEACTIVATED: 'plugin-deactivated',\r\n  /** Plugin error */\r\n  ERROR: 'plugin-error',\r\n} as const;\r\n\r\n/**\r\n * Canvas event names\r\n */\r\nexport const CANVAS_EVENTS = {\r\n  /** Pointer down */\r\n  POINTER_DOWN: 'pointer-down',\r\n  /** Pointer move */\r\n  POINTER_MOVE: 'pointer-move',\r\n  /** Pointer up */\r\n  POINTER_UP: 'pointer-up',\r\n  /** Pinch gesture */\r\n  PINCH: 'pinch',\r\n  /** Pan gesture */\r\n  PAN: 'pan',\r\n  /** Canvas resized */\r\n  RESIZE: 'resize',\r\n} as const;\r\n\r\n/**\r\n * All event name types\r\n */\r\nexport type EditorEventName = (typeof EDITOR_EVENTS)[keyof typeof EDITOR_EVENTS];\r\nexport type PluginEventName = (typeof PLUGIN_EVENTS)[keyof typeof PLUGIN_EVENTS];\r\nexport type CanvasEventName = (typeof CANVAS_EVENTS)[keyof typeof CANVAS_EVENTS];\r\n","/**\r\n * DOM utility functions\r\n * Requirements: 8.5 - Device type auto-switching\r\n */\r\n\r\n/**\r\n * Get element by selector or return the element itself\r\n */\r\nexport function getElement(\r\n  selector: string | HTMLElement\r\n): HTMLElement | null {\r\n  if (typeof selector === 'string') {\r\n    return document.querySelector(selector);\r\n  }\r\n  return selector;\r\n}\r\n\r\n/**\r\n * Create a canvas element with specified dimensions\r\n */\r\nexport function createCanvas(\r\n  width: number,\r\n  height: number\r\n): HTMLCanvasElement {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  return canvas;\r\n}\r\n\r\n/**\r\n * Get 2D rendering context from canvas\r\n */\r\nexport function getContext2D(\r\n  canvas: HTMLCanvasElement\r\n): CanvasRenderingContext2D {\r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) {\r\n    throw new Error('Failed to get 2D context from canvas');\r\n  }\r\n  return ctx;\r\n}\r\n\r\n/**\r\n * Get element's bounding rect relative to viewport\r\n */\r\nexport function getElementRect(element: HTMLElement): DOMRect {\r\n  return element.getBoundingClientRect();\r\n}\r\n\r\n/**\r\n * Get coordinates relative to an element\r\n */\r\nexport function getRelativeCoordinates(\r\n  event: MouseEvent | Touch,\r\n  element: HTMLElement\r\n): { x: number; y: number } {\r\n  const rect = getElementRect(element);\r\n  return {\r\n    x: event.clientX - rect.left,\r\n    y: event.clientY - rect.top,\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Set canvas dimensions\r\n */\r\nexport function setCanvasSize(\r\n  canvas: HTMLCanvasElement,\r\n  width: number,\r\n  height: number\r\n): void {\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n}\r\n\r\n/**\r\n * Clear canvas content\r\n */\r\nexport function clearCanvas(\r\n  ctx: CanvasRenderingContext2D,\r\n  width: number,\r\n  height: number\r\n): void {\r\n  ctx.clearRect(0, 0, width, height);\r\n}\r\n\r\n/**\r\n * Fill canvas with a color\r\n */\r\nexport function fillCanvas(\r\n  ctx: CanvasRenderingContext2D,\r\n  width: number,\r\n  height: number,\r\n  color: string\r\n): void {\r\n  ctx.fillStyle = color;\r\n  ctx.fillRect(0, 0, width, height);\r\n}\r\n\r\n/**\r\n * Add CSS styles to an element\r\n */\r\nexport function setStyles(\r\n  element: HTMLElement,\r\n  styles: Partial<CSSStyleDeclaration>\r\n): void {\r\n  Object.assign(element.style, styles);\r\n}\r\n\r\n/**\r\n * Remove element from DOM\r\n */\r\nexport function removeElement(element: HTMLElement): void {\r\n  element.parentNode?.removeChild(element);\r\n}\r\n\r\n/**\r\n * Check if element is in viewport\r\n */\r\nexport function isInViewport(element: HTMLElement): boolean {\r\n  const rect = element.getBoundingClientRect();\r\n  return (\r\n    rect.top >= 0 &&\r\n    rect.left >= 0 &&\r\n    rect.bottom <= window.innerHeight &&\r\n    rect.right <= window.innerWidth\r\n  );\r\n}\r\n","/**\r\n * Image utility functions\r\n * Requirements: 8.5 - Image processing utilities\r\n */\r\n\r\n/**\r\n * Load an image from URL or HTMLImageElement\r\n */\r\nexport function loadImage(\r\n  source: string | HTMLImageElement\r\n): Promise<HTMLImageElement> {\r\n  return new Promise((resolve, reject) => {\r\n    if (source instanceof HTMLImageElement) {\r\n      if (source.complete) {\r\n        resolve(source);\r\n      } else {\r\n        source.onload = () => resolve(source);\r\n        source.onerror = () => reject(new Error('Failed to load image'));\r\n      }\r\n      return;\r\n    }\r\n\r\n    const img = new Image();\r\n    img.crossOrigin = 'anonymous';\r\n    img.onload = () => resolve(img);\r\n    img.onerror = () => reject(new Error(`Failed to load image: ${source}`));\r\n    img.src = source;\r\n  });\r\n}\r\n\r\n/**\r\n * Get image dimensions\r\n */\r\nexport function getImageDimensions(\r\n  image: HTMLImageElement\r\n): { width: number; height: number } {\r\n  return {\r\n    width: image.naturalWidth || image.width,\r\n    height: image.naturalHeight || image.height,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate scaled dimensions while maintaining aspect ratio\r\n */\r\nexport function calculateAspectRatioFit(\r\n  srcWidth: number,\r\n  srcHeight: number,\r\n  maxWidth: number,\r\n  maxHeight: number\r\n): { width: number; height: number } {\r\n  const ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);\r\n  return {\r\n    width: Math.round(srcWidth * ratio),\r\n    height: Math.round(srcHeight * ratio),\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Draw image to canvas context\r\n */\r\nexport function drawImageToCanvas(\r\n  ctx: CanvasRenderingContext2D,\r\n  image: HTMLImageElement,\r\n  x: number = 0,\r\n  y: number = 0,\r\n  width?: number,\r\n  height?: number\r\n): void {\r\n  if (width !== undefined && height !== undefined) {\r\n    ctx.drawImage(image, x, y, width, height);\r\n  } else {\r\n    ctx.drawImage(image, x, y);\r\n  }\r\n}\r\n\r\n/**\r\n * Get ImageData from canvas\r\n */\r\nexport function getImageData(\r\n  ctx: CanvasRenderingContext2D,\r\n  x: number = 0,\r\n  y: number = 0,\r\n  width?: number,\r\n  height?: number\r\n): ImageData {\r\n  const w = width ?? ctx.canvas.width;\r\n  const h = height ?? ctx.canvas.height;\r\n  return ctx.getImageData(x, y, w, h);\r\n}\r\n\r\n/**\r\n * Put ImageData to canvas\r\n */\r\nexport function putImageData(\r\n  ctx: CanvasRenderingContext2D,\r\n  imageData: ImageData,\r\n  x: number = 0,\r\n  y: number = 0\r\n): void {\r\n  ctx.putImageData(imageData, x, y);\r\n}\r\n\r\n/**\r\n * Clone ImageData\r\n */\r\nexport function cloneImageData(imageData: ImageData): ImageData {\r\n  return new ImageData(\r\n    new Uint8ClampedArray(imageData.data),\r\n    imageData.width,\r\n    imageData.height\r\n  );\r\n}\r\n\r\n/**\r\n * Create empty ImageData\r\n */\r\nexport function createImageData(\r\n  width: number,\r\n  height: number\r\n): ImageData {\r\n  return new ImageData(width, height);\r\n}\r\n\r\n/**\r\n * Convert canvas to data URL\r\n */\r\nexport function canvasToDataURL(\r\n  canvas: HTMLCanvasElement,\r\n  format: 'png' | 'jpeg' | 'webp' = 'png',\r\n  quality: number = 0.92\r\n): string {\r\n  const mimeType = `image/${format}`;\r\n  return canvas.toDataURL(mimeType, quality);\r\n}\r\n\r\n/**\r\n * Convert canvas to Blob\r\n */\r\nexport function canvasToBlob(\r\n  canvas: HTMLCanvasElement,\r\n  format: 'png' | 'jpeg' | 'webp' = 'png',\r\n  quality: number = 0.92\r\n): Promise<Blob> {\r\n  return new Promise((resolve, reject) => {\r\n    const mimeType = `image/${format}`;\r\n    canvas.toBlob(\r\n      (blob) => {\r\n        if (blob) {\r\n          resolve(blob);\r\n        } else {\r\n          reject(new Error('Failed to convert canvas to blob'));\r\n        }\r\n      },\r\n      mimeType,\r\n      quality\r\n    );\r\n  });\r\n}\r\n\r\n/**\r\n * Create a scaled canvas\r\n */\r\nexport function createScaledCanvas(\r\n  sourceCanvas: HTMLCanvasElement,\r\n  width: number,\r\n  height: number\r\n): HTMLCanvasElement {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  const ctx = canvas.getContext('2d');\r\n  if (ctx) {\r\n    ctx.drawImage(sourceCanvas, 0, 0, width, height);\r\n  }\r\n  return canvas;\r\n}\r\n","/**\r\n * Event utility functions\r\n * Requirements: 8.5 - Event handling utilities\r\n */\r\n\r\nimport type { PointerEventData, GestureEventData } from '../types';\r\n\r\n/**\r\n * Normalize mouse/touch event to unified pointer event\r\n */\r\nexport function normalizePointerEvent(\r\n  event: MouseEvent | TouchEvent,\r\n  element: HTMLElement,\r\n  type: 'start' | 'move' | 'end'\r\n): PointerEventData {\r\n  const rect = element.getBoundingClientRect();\r\n\r\n  if ('touches' in event) {\r\n    const touch = event.touches[0] || event.changedTouches[0];\r\n    return {\r\n      type,\r\n      x: touch.clientX - rect.left,\r\n      y: touch.clientY - rect.top,\r\n      pressure: touch.force || 0.5,\r\n      isPrimary: true,\r\n      pointerId: touch.identifier,\r\n    };\r\n  }\r\n\r\n  return {\r\n    type,\r\n    x: event.clientX - rect.left,\r\n    y: event.clientY - rect.top,\r\n    pressure: 0.5,\r\n    isPrimary: true,\r\n    pointerId: 0,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate distance between two touch points\r\n */\r\nexport function getTouchDistance(touch1: Touch, touch2: Touch): number {\r\n  const dx = touch1.clientX - touch2.clientX;\r\n  const dy = touch1.clientY - touch2.clientY;\r\n  return Math.sqrt(dx * dx + dy * dy);\r\n}\r\n\r\n/**\r\n * Calculate center point between two touch points\r\n */\r\nexport function getTouchCenter(\r\n  touch1: Touch,\r\n  touch2: Touch\r\n): { x: number; y: number } {\r\n  return {\r\n    x: (touch1.clientX + touch2.clientX) / 2,\r\n    y: (touch1.clientY + touch2.clientY) / 2,\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Create pinch gesture event data\r\n */\r\nexport function createPinchEvent(\r\n  touches: TouchList,\r\n  element: HTMLElement,\r\n  initialDistance: number\r\n): GestureEventData {\r\n  const touch1 = touches[0];\r\n  const touch2 = touches[1];\r\n  const currentDistance = getTouchDistance(touch1, touch2);\r\n  const rect = element.getBoundingClientRect();\r\n  const center = getTouchCenter(touch1, touch2);\r\n\r\n  return {\r\n    type: 'pinch',\r\n    scale: currentDistance / initialDistance,\r\n    center: {\r\n      x: center.x - rect.left,\r\n      y: center.y - rect.top,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Create pan gesture event data\r\n */\r\nexport function createPanEvent(\r\n  deltaX: number,\r\n  deltaY: number\r\n): GestureEventData {\r\n  return {\r\n    type: 'pan',\r\n    deltaX,\r\n    deltaY,\r\n  };\r\n}\r\n\r\n/**\r\n * Throttle function execution\r\n */\r\nexport function throttle<T extends (...args: unknown[]) => void>(\r\n  fn: T,\r\n  delay: number\r\n): T {\r\n  let lastCall = 0;\r\n  return ((...args: unknown[]) => {\r\n    const now = Date.now();\r\n    if (now - lastCall >= delay) {\r\n      lastCall = now;\r\n      fn(...args);\r\n    }\r\n  }) as T;\r\n}\r\n\r\n/**\r\n * Debounce function execution\r\n */\r\nexport function debounce<T extends (...args: unknown[]) => void>(\r\n  fn: T,\r\n  delay: number\r\n): T {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  return ((...args: unknown[]) => {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = setTimeout(() => {\r\n      fn(...args);\r\n      timeoutId = null;\r\n    }, delay);\r\n  }) as T;\r\n}\r\n\r\n/**\r\n * Prevent default event behavior\r\n */\r\nexport function preventDefault(event: Event): void {\r\n  event.preventDefault();\r\n}\r\n\r\n/**\r\n * Stop event propagation\r\n */\r\nexport function stopPropagation(event: Event): void {\r\n  event.stopPropagation();\r\n}\r\n\r\n/**\r\n * Add event listener with cleanup function\r\n */\r\nexport function addEventListenerWithCleanup<K extends keyof HTMLElementEventMap>(\r\n  element: HTMLElement | Window,\r\n  type: K,\r\n  listener: (event: HTMLElementEventMap[K]) => void,\r\n  options?: boolean | AddEventListenerOptions\r\n): () => void {\r\n  element.addEventListener(type, listener as EventListener, options);\r\n  return () => {\r\n    element.removeEventListener(type, listener as EventListener, options);\r\n  };\r\n}\r\n","/**\r\n * Device detection utility functions\r\n * Requirements: 8.5 - Device type auto-switching\r\n */\r\n\r\nimport type { DeviceType } from '../types';\r\n\r\n/**\r\n * Check if the device is a touch device\r\n */\r\nexport function isTouchDevice(): boolean {\r\n  if (typeof window === 'undefined') {\r\n    return false;\r\n  }\r\n  return (\r\n    'ontouchstart' in window ||\r\n    navigator.maxTouchPoints > 0 ||\r\n    // @ts-expect-error - msMaxTouchPoints is IE specific\r\n    navigator.msMaxTouchPoints > 0\r\n  );\r\n}\r\n\r\n/**\r\n * Check if the device is a mobile device based on user agent\r\n */\r\nexport function isMobileDevice(): boolean {\r\n  if (typeof navigator === 'undefined') {\r\n    return false;\r\n  }\r\n  const userAgent = navigator.userAgent.toLowerCase();\r\n  return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(\r\n    userAgent\r\n  );\r\n}\r\n\r\n/**\r\n * Check if the device is an iOS device\r\n */\r\nexport function isIOSDevice(): boolean {\r\n  if (typeof navigator === 'undefined') {\r\n    return false;\r\n  }\r\n  return /iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase());\r\n}\r\n\r\n/**\r\n * Check if the device is an Android device\r\n */\r\nexport function isAndroidDevice(): boolean {\r\n  if (typeof navigator === 'undefined') {\r\n    return false;\r\n  }\r\n  return /android/i.test(navigator.userAgent.toLowerCase());\r\n}\r\n\r\n\r\n/**\r\n * Detect device type automatically\r\n */\r\nexport function detectDeviceType(): 'pc' | 'mobile' {\r\n  if (isMobileDevice() || isTouchDevice()) {\r\n    return 'mobile';\r\n  }\r\n  return 'pc';\r\n}\r\n\r\n/**\r\n * Get resolved device type based on configuration\r\n */\r\nexport function getResolvedDeviceType(deviceType: DeviceType): 'pc' | 'mobile' {\r\n  if (deviceType === 'auto') {\r\n    return detectDeviceType();\r\n  }\r\n  return deviceType;\r\n}\r\n\r\n/**\r\n * Get device pixel ratio\r\n */\r\nexport function getDevicePixelRatio(): number {\r\n  if (typeof window === 'undefined') {\r\n    return 1;\r\n  }\r\n  return window.devicePixelRatio || 1;\r\n}\r\n\r\n/**\r\n * Check if the browser supports passive event listeners\r\n */\r\nexport function supportsPassiveEvents(): boolean {\r\n  let passiveSupported = false;\r\n  try {\r\n    const options = {\r\n      get passive() {\r\n        passiveSupported = true;\r\n        return false;\r\n      },\r\n    };\r\n    // @ts-expect-error - Testing passive support\r\n    window.addEventListener('test', null, options);\r\n    // @ts-expect-error - Testing passive support\r\n    window.removeEventListener('test', null, options);\r\n  } catch {\r\n    passiveSupported = false;\r\n  }\r\n  return passiveSupported;\r\n}\r\n\r\n/**\r\n * Get passive event listener options\r\n */\r\nexport function getPassiveOptions(): AddEventListenerOptions | boolean {\r\n  return supportsPassiveEvents() ? { passive: true } : false;\r\n}\r\n\r\n/**\r\n * Get non-passive event listener options (for preventing default)\r\n */\r\nexport function getNonPassiveOptions(): AddEventListenerOptions | boolean {\r\n  return supportsPassiveEvents() ? { passive: false } : false;\r\n}\r\n\r\n/**\r\n * Check if the browser supports pointer events\r\n */\r\nexport function supportsPointerEvents(): boolean {\r\n  if (typeof window === 'undefined') {\r\n    return false;\r\n  }\r\n  return 'PointerEvent' in window;\r\n}\r\n\r\n/**\r\n * Get viewport dimensions\r\n */\r\nexport function getViewportDimensions(): { width: number; height: number } {\r\n  if (typeof window === 'undefined') {\r\n    return { width: 0, height: 0 };\r\n  }\r\n  return {\r\n    width: window.innerWidth,\r\n    height: window.innerHeight,\r\n  };\r\n}\r\n","/**\r\n * Export utilities - Image export functionality\r\n * Requirements: 7.1, 7.2, 7.3, 7.4, 7.5\r\n * \r\n * Note: Full implementation in task 5.6\r\n */\r\n\r\nimport type { ExportOptions } from '../types/config.types';\r\nimport { DEFAULT_EXPORT_OPTIONS } from '../constants/defaults';\r\nimport { canvasToDataURL, canvasToBlob, createScaledCanvas } from './image.utils';\r\n\r\n/**\r\n * Export image from canvas with specified options\r\n * Requirements: 7.1, 7.2, 7.3, 7.4, 7.5\r\n * @param canvas - Source canvas element\r\n * @param options - Export options\r\n * @returns Promise with exported data (base64, Blob, or File)\r\n */\r\nexport async function exportImage(\r\n  canvas: HTMLCanvasElement,\r\n  options?: ExportOptions\r\n): Promise<string | Blob | File> {\r\n  const opts = {\r\n    ...DEFAULT_EXPORT_OPTIONS,\r\n    ...options,\r\n  };\r\n\r\n  // Determine target canvas (scaled or original)\r\n  let targetCanvas = canvas;\r\n  if (opts.width && opts.height && (opts.width !== canvas.width || opts.height !== canvas.height)) {\r\n    targetCanvas = createScaledCanvas(canvas, opts.width, opts.height);\r\n  } else if (opts.width && !opts.height) {\r\n    // Scale proportionally based on width\r\n    const ratio = opts.width / canvas.width;\r\n    const height = Math.round(canvas.height * ratio);\r\n    targetCanvas = createScaledCanvas(canvas, opts.width, height);\r\n  } else if (opts.height && !opts.width) {\r\n    // Scale proportionally based on height\r\n    const ratio = opts.height / canvas.height;\r\n    const width = Math.round(canvas.width * ratio);\r\n    targetCanvas = createScaledCanvas(canvas, width, opts.height);\r\n  }\r\n\r\n  // Export based on type\r\n  switch (opts.type) {\r\n    case 'base64':\r\n      return canvasToDataURL(targetCanvas, opts.format, opts.quality);\r\n\r\n    case 'blob':\r\n      return canvasToBlob(targetCanvas, opts.format, opts.quality);\r\n\r\n    case 'file': {\r\n      const blob = await canvasToBlob(targetCanvas, opts.format, opts.quality);\r\n      const extension = opts.format === 'jpeg' ? 'jpg' : opts.format;\r\n      const fileName = `${opts.fileName || 'image'}.${extension}`;\r\n      return new File([blob], fileName, { type: `image/${opts.format}` });\r\n    }\r\n\r\n    default:\r\n      return canvasToDataURL(targetCanvas, opts.format, opts.quality);\r\n  }\r\n}\r\n","/**\r\n * Placeholder image generator for editor\r\n */\r\n\r\nexport interface PlaceholderOptions {\r\n  width?: number;\r\n  height?: number;\r\n  text?: string;\r\n  subText?: string;\r\n  theme?: 'light' | 'dark';\r\n}\r\n\r\n/**\r\n * Create a placeholder image data URL\r\n */\r\nexport function createPlaceholder(options: PlaceholderOptions = {}): string {\r\n  const {\r\n    width: w = 800,\r\n    height: h = 600,\r\n    text = '点击上传或拖放图片',\r\n    subText = '支持 PNG、JPG、GIF 等格式',\r\n    theme = 'dark',\r\n  } = options;\r\n\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = w;\r\n  canvas.height = h;\r\n  \r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) return '';\r\n  \r\n  // Theme colors - high contrast for clarity\r\n  const isDark = theme === 'dark';\r\n  const borderColor = isDark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)';\r\n  const iconColor = isDark ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.35)';\r\n  const textColor = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.65)';\r\n  const subTextColor = isDark ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)';\r\n  \r\n  // Transparent background - inherits from container\r\n  ctx.clearRect(0, 0, w, h);\r\n  \r\n  // Dashed border with proper margin\r\n  const padding = Math.max(20, Math.min(w, h) * 0.05);\r\n  const cornerRadius = 8;\r\n  const boxLeft = padding;\r\n  const boxTop = padding;\r\n  const boxWidth = w - padding * 2;\r\n  const boxHeight = h - padding * 2;\r\n  \r\n  ctx.strokeStyle = borderColor;\r\n  ctx.lineWidth = 1;\r\n  ctx.setLineDash([4, 3]);\r\n  \r\n  // Draw rounded rectangle border\r\n  ctx.beginPath();\r\n  ctx.moveTo(boxLeft + cornerRadius, boxTop);\r\n  ctx.lineTo(boxLeft + boxWidth - cornerRadius, boxTop);\r\n  ctx.quadraticCurveTo(boxLeft + boxWidth, boxTop, boxLeft + boxWidth, boxTop + cornerRadius);\r\n  ctx.lineTo(boxLeft + boxWidth, boxTop + boxHeight - cornerRadius);\r\n  ctx.quadraticCurveTo(boxLeft + boxWidth, boxTop + boxHeight, boxLeft + boxWidth - cornerRadius, boxTop + boxHeight);\r\n  ctx.lineTo(boxLeft + cornerRadius, boxTop + boxHeight);\r\n  ctx.quadraticCurveTo(boxLeft, boxTop + boxHeight, boxLeft, boxTop + boxHeight - cornerRadius);\r\n  ctx.lineTo(boxLeft, boxTop + cornerRadius);\r\n  ctx.quadraticCurveTo(boxLeft, boxTop, boxLeft + cornerRadius, boxTop);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n  ctx.setLineDash([]);\r\n  \r\n  // Content centered\r\n  const centerX = w / 2;\r\n  const centerY = h / 2;\r\n  \r\n  ctx.strokeStyle = iconColor;\r\n  ctx.lineWidth = 2;\r\n  ctx.lineCap = 'round';\r\n  ctx.lineJoin = 'round';\r\n  \r\n  // Larger image icon for better visibility\r\n  const imgBoxW = 48;\r\n  const imgBoxH = 36;\r\n  const imgBoxX = centerX - imgBoxW / 2;\r\n  const imgBoxY = centerY - 45;\r\n  const imgRadius = 5;\r\n  \r\n  // Icon frame\r\n  ctx.beginPath();\r\n  ctx.moveTo(imgBoxX + imgRadius, imgBoxY);\r\n  ctx.lineTo(imgBoxX + imgBoxW - imgRadius, imgBoxY);\r\n  ctx.quadraticCurveTo(imgBoxX + imgBoxW, imgBoxY, imgBoxX + imgBoxW, imgBoxY + imgRadius);\r\n  ctx.lineTo(imgBoxX + imgBoxW, imgBoxY + imgBoxH - imgRadius);\r\n  ctx.quadraticCurveTo(imgBoxX + imgBoxW, imgBoxY + imgBoxH, imgBoxX + imgBoxW - imgRadius, imgBoxY + imgBoxH);\r\n  ctx.lineTo(imgBoxX + imgRadius, imgBoxY + imgBoxH);\r\n  ctx.quadraticCurveTo(imgBoxX, imgBoxY + imgBoxH, imgBoxX, imgBoxY + imgBoxH - imgRadius);\r\n  ctx.lineTo(imgBoxX, imgBoxY + imgRadius);\r\n  ctx.quadraticCurveTo(imgBoxX, imgBoxY, imgBoxX + imgRadius, imgBoxY);\r\n  ctx.stroke();\r\n  \r\n  // Mountain landscape (scaled up)\r\n  ctx.beginPath();\r\n  ctx.moveTo(imgBoxX + 8, imgBoxY + imgBoxH - 8);\r\n  ctx.lineTo(imgBoxX + 18, imgBoxY + 12);\r\n  ctx.lineTo(imgBoxX + 26, imgBoxY + imgBoxH - 12);\r\n  ctx.lineTo(imgBoxX + 34, imgBoxY + 14);\r\n  ctx.lineTo(imgBoxX + imgBoxW - 8, imgBoxY + imgBoxH - 8);\r\n  ctx.stroke();\r\n  \r\n  // Sun (scaled up)\r\n  ctx.beginPath();\r\n  ctx.arc(imgBoxX + imgBoxW - 12, imgBoxY + 11, 5, 0, Math.PI * 2);\r\n  ctx.stroke();\r\n  \r\n  // Title text - bold and clear\r\n  ctx.fillStyle = textColor;\r\n  ctx.font = '600 14px -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif';\r\n  ctx.textAlign = 'center';\r\n  ctx.textBaseline = 'middle';\r\n  ctx.fillText(text, centerX, centerY + 12);\r\n  \r\n  // Description text - smaller and lighter\r\n  if (subText) {\r\n    ctx.fillStyle = subTextColor;\r\n    ctx.font = '400 12px -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif';\r\n    ctx.fillText(subText, centerX, centerY + 34);\r\n  }\r\n  \r\n  return canvas.toDataURL('image/png');\r\n}\r\n\r\n/** Check if a data URL is a placeholder image */\r\nexport function isPlaceholderImage(dataUrl: string): boolean {\r\n  // Our placeholder images are always PNG and have a specific pattern\r\n  // We embed a marker in the placeholder to identify it\r\n  return dataUrl.includes('data:image/png') && dataUrl.length < 50000;\r\n}\r\n","/**\r\n * Event Manager - Handles event subscription, emission, and cleanup\r\n * Requirements: 1.2, 1.4 - Event system\r\n */\r\n\r\nimport type {\r\n  EventHandler,\r\n  EventListenerOptions,\r\n  EditorEvents,\r\n} from '../types/event.types';\r\n\r\n/**\r\n * Internal listener structure\r\n */\r\ninterface Listener<T = unknown> {\r\n  handler: EventHandler<T>;\r\n  once: boolean;\r\n}\r\n\r\n/**\r\n * EventManager class - Manages event subscriptions and emissions\r\n * Requirements: 1.2, 1.4\r\n */\r\nexport class EventManager {\r\n  private listeners: Map<string, Set<Listener>> = new Map();\r\n\r\n  /**\r\n   * Subscribe to an event\r\n   * @param event - Event name\r\n   * @param handler - Event handler function\r\n   * @param options - Listener options\r\n   */\r\n  on<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>,\r\n    options?: EventListenerOptions\r\n  ): void {\r\n    const eventName = event as string;\r\n    \r\n    if (!this.listeners.has(eventName)) {\r\n      this.listeners.set(eventName, new Set());\r\n    }\r\n\r\n    const listener: Listener<EditorEvents[K]> = {\r\n      handler,\r\n      once: options?.once ?? false,\r\n    };\r\n\r\n    this.listeners.get(eventName)!.add(listener as Listener);\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an event once (auto-unsubscribe after first trigger)\r\n   * @param event - Event name\r\n   * @param handler - Event handler function\r\n   */\r\n  once<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>\r\n  ): void {\r\n    this.on(event, handler, { once: true });\r\n  }\r\n\r\n\r\n  /**\r\n   * Unsubscribe from an event\r\n   * @param event - Event name\r\n   * @param handler - Event handler function to remove\r\n   */\r\n  off<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>\r\n  ): void {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n\r\n    if (!listeners) {\r\n      return;\r\n    }\r\n\r\n    for (const listener of listeners) {\r\n      if (listener.handler === handler) {\r\n        listeners.delete(listener);\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Clean up empty listener sets\r\n    if (listeners.size === 0) {\r\n      this.listeners.delete(eventName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit an event to all subscribers\r\n   * @param event - Event name\r\n   * @param data - Event data\r\n   */\r\n  emit<K extends keyof EditorEvents>(event: K, data: EditorEvents[K]): void {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n\r\n    if (!listeners) {\r\n      return;\r\n    }\r\n\r\n    // Create a copy to avoid modification during iteration\r\n    const listenersArray = Array.from(listeners);\r\n\r\n    for (const listener of listenersArray) {\r\n      try {\r\n        listener.handler(data);\r\n\r\n        // Remove one-time listeners after execution\r\n        if (listener.once) {\r\n          listeners.delete(listener);\r\n        }\r\n      } catch (error) {\r\n        console.error(`Error in event handler for \"${eventName}\":`, error);\r\n      }\r\n    }\r\n\r\n    // Clean up empty listener sets\r\n    if (listeners.size === 0) {\r\n      this.listeners.delete(eventName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if an event has any listeners\r\n   * @param event - Event name\r\n   * @returns True if the event has listeners\r\n   */\r\n  hasListeners<K extends keyof EditorEvents>(event: K): boolean {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n    return listeners !== undefined && listeners.size > 0;\r\n  }\r\n\r\n  /**\r\n   * Get the number of listeners for an event\r\n   * @param event - Event name\r\n   * @returns Number of listeners\r\n   */\r\n  listenerCount<K extends keyof EditorEvents>(event: K): number {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n    return listeners?.size ?? 0;\r\n  }\r\n\r\n  /**\r\n   * Remove all listeners for a specific event or all events\r\n   * @param event - Optional event name. If not provided, removes all listeners\r\n   */\r\n  removeAllListeners<K extends keyof EditorEvents>(event?: K): void {\r\n    if (event !== undefined) {\r\n      this.listeners.delete(event as string);\r\n    } else {\r\n      this.listeners.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the event manager and clean up all resources\r\n   */\r\n  destroy(): void {\r\n    this.listeners.clear();\r\n  }\r\n}\r\n","/**\r\n * Config Manager - Handles configuration merging and runtime updates\r\n * Requirements: 10.1, 10.5 - Configuration system\r\n */\r\n\r\nimport type { EditorConfig, DeepPartial } from '../types/config.types';\r\nimport { DEFAULT_EDITOR_CONFIG } from '../constants/defaults';\r\n\r\n/**\r\n * ConfigManager class - Manages editor configuration\r\n * Requirements: 10.1, 10.5\r\n */\r\nexport class ConfigManager {\r\n  private config: Required<EditorConfig>;\r\n  private listeners: Set<(config: Required<EditorConfig>) => void> = new Set();\r\n\r\n  /**\r\n   * Create a new ConfigManager instance\r\n   * @param userConfig - User provided configuration\r\n   */\r\n  constructor(userConfig?: DeepPartial<EditorConfig>) {\r\n    this.config = this.mergeConfig(DEFAULT_EDITOR_CONFIG, userConfig);\r\n  }\r\n\r\n  /**\r\n   * Deep merge two configuration objects\r\n   * User config values override default values\r\n   * @param defaultConfig - Default configuration\r\n   * @param userConfig - User configuration\r\n   * @returns Merged configuration\r\n   */\r\n  private mergeConfig(\r\n    defaultConfig: Required<EditorConfig>,\r\n    userConfig?: DeepPartial<EditorConfig>\r\n  ): Required<EditorConfig> {\r\n    if (!userConfig) {\r\n      return { ...defaultConfig };\r\n    }\r\n\r\n    const result = { ...defaultConfig };\r\n\r\n    for (const key of Object.keys(userConfig) as (keyof EditorConfig)[]) {\r\n      const userValue = userConfig[key];\r\n      if (userValue !== undefined) {\r\n        (result as Record<string, unknown>)[key] = userValue;\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n\r\n  /**\r\n   * Get the current configuration\r\n   * @returns Current configuration\r\n   */\r\n  getConfig(): Required<EditorConfig> {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Get a specific configuration value\r\n   * @param key - Configuration key\r\n   * @returns Configuration value\r\n   */\r\n  get<K extends keyof EditorConfig>(key: K): Required<EditorConfig>[K] {\r\n    return this.config[key];\r\n  }\r\n\r\n  /**\r\n   * Update configuration at runtime\r\n   * Requirements: 10.5 - Runtime configuration update\r\n   * @param updates - Partial configuration updates\r\n   */\r\n  update(updates: DeepPartial<EditorConfig>): void {\r\n    const oldConfig = { ...this.config };\r\n    this.config = this.mergeConfig(this.config, updates);\r\n\r\n    // Notify listeners if config changed\r\n    if (JSON.stringify(oldConfig) !== JSON.stringify(this.config)) {\r\n      this.notifyListeners();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a specific configuration value\r\n   * @param key - Configuration key\r\n   * @param value - Configuration value\r\n   */\r\n  set<K extends keyof EditorConfig>(\r\n    key: K,\r\n    value: Required<EditorConfig>[K]\r\n  ): void {\r\n    if (this.config[key] !== value) {\r\n      this.config[key] = value;\r\n      this.notifyListeners();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reset configuration to defaults\r\n   * @param userConfig - Optional user config to apply after reset\r\n   */\r\n  reset(userConfig?: DeepPartial<EditorConfig>): void {\r\n    this.config = this.mergeConfig(DEFAULT_EDITOR_CONFIG, userConfig);\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to configuration changes\r\n   * @param listener - Callback function\r\n   * @returns Unsubscribe function\r\n   */\r\n  onChange(\r\n    listener: (config: Required<EditorConfig>) => void\r\n  ): () => void {\r\n    this.listeners.add(listener);\r\n    return () => {\r\n      this.listeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of configuration changes\r\n   */\r\n  private notifyListeners(): void {\r\n    const currentConfig = this.getConfig();\r\n    for (const listener of this.listeners) {\r\n      try {\r\n        listener(currentConfig);\r\n      } catch (error) {\r\n        console.error('Error in config change listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the config manager and clean up resources\r\n   */\r\n  destroy(): void {\r\n    this.listeners.clear();\r\n  }\r\n}\r\n","/**\r\n * History Manager - Handles undo/redo functionality\r\n * Requirements: 6.1, 6.2, 6.3, 6.5\r\n */\r\n\r\nimport type { HistoryState, HistoryManagerInterface } from '../types/editor.types';\r\n\r\n/**\r\n * Generate a unique ID for history states\r\n */\r\nfunction generateId(): string {\r\n  return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n/**\r\n * HistoryManager class - Manages undo/redo history\r\n * Requirements: 6.1, 6.2, 6.3, 6.5\r\n */\r\nexport class HistoryManager implements HistoryManagerInterface {\r\n  /** History states stack */\r\n  states: HistoryState[] = [];\r\n  /** Current position in history */\r\n  currentIndex: number = -1;\r\n  /** Maximum number of history states */\r\n  limit: number;\r\n  /** Listeners for history changes */\r\n  private listeners: Set<(canUndo: boolean, canRedo: boolean) => void> = new Set();\r\n\r\n  /**\r\n   * Create a new HistoryManager instance\r\n   * @param limit - Maximum number of history states (default: 50)\r\n   */\r\n  constructor(limit: number = 50) {\r\n    this.limit = Math.max(1, limit);\r\n  }\r\n\r\n  /**\r\n   * Push a new state to history\r\n   * Requirements: 6.1 - Record operations to history stack\r\n   * @param state - State to push (without id and timestamp)\r\n   */\r\n  push(state: Omit<HistoryState, 'id' | 'timestamp'>): void {\r\n    // Remove any states after current index (discard redo history)\r\n    if (this.currentIndex < this.states.length - 1) {\r\n      this.states = this.states.slice(0, this.currentIndex + 1);\r\n    }\r\n\r\n    // Create new state with id and timestamp\r\n    const newState: HistoryState = {\r\n      ...state,\r\n      id: generateId(),\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    // Add new state\r\n    this.states.push(newState);\r\n    this.currentIndex = this.states.length - 1;\r\n\r\n    // Enforce limit - remove oldest states if exceeded\r\n    // Requirements: 6.5 - History record limit control\r\n    while (this.states.length > this.limit) {\r\n      this.states.shift();\r\n      this.currentIndex--;\r\n    }\r\n\r\n    this.notifyListeners();\r\n  }\r\n\r\n\r\n  /**\r\n   * Undo to previous state\r\n   * Requirements: 6.2 - Restore to previous state\r\n   * @returns Previous state or null if cannot undo\r\n   */\r\n  undo(): HistoryState | null {\r\n    if (!this.canUndo()) {\r\n      return null;\r\n    }\r\n\r\n    this.currentIndex--;\r\n    this.notifyListeners();\r\n    return this.states[this.currentIndex];\r\n  }\r\n\r\n  /**\r\n   * Redo to next state\r\n   * Requirements: 6.3 - Restore to next state\r\n   * @returns Next state or null if cannot redo\r\n   */\r\n  redo(): HistoryState | null {\r\n    if (!this.canRedo()) {\r\n      return null;\r\n    }\r\n\r\n    this.currentIndex++;\r\n    this.notifyListeners();\r\n    return this.states[this.currentIndex];\r\n  }\r\n\r\n  /**\r\n   * Check if undo is available\r\n   * Requirements: 6.4 - No operation when history stack is empty\r\n   * @returns True if can undo\r\n   */\r\n  canUndo(): boolean {\r\n    return this.currentIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Check if redo is available\r\n   * @returns True if can redo\r\n   */\r\n  canRedo(): boolean {\r\n    return this.currentIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Get current state\r\n   * @returns Current state or null if no states\r\n   */\r\n  getCurrentState(): HistoryState | null {\r\n    if (this.currentIndex < 0 || this.currentIndex >= this.states.length) {\r\n      return null;\r\n    }\r\n    return this.states[this.currentIndex];\r\n  }\r\n\r\n  /**\r\n   * Get the number of states in history\r\n   * @returns Number of states\r\n   */\r\n  getLength(): number {\r\n    return this.states.length;\r\n  }\r\n\r\n  /**\r\n   * Clear all history\r\n   */\r\n  clear(): void {\r\n    this.states = [];\r\n    this.currentIndex = -1;\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to history changes\r\n   * @param listener - Callback function\r\n   * @returns Unsubscribe function\r\n   */\r\n  onChange(listener: (canUndo: boolean, canRedo: boolean) => void): () => void {\r\n    this.listeners.add(listener);\r\n    return () => {\r\n      this.listeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of history changes\r\n   */\r\n  private notifyListeners(): void {\r\n    const canUndo = this.canUndo();\r\n    const canRedo = this.canRedo();\r\n    for (const listener of this.listeners) {\r\n      try {\r\n        listener(canUndo, canRedo);\r\n      } catch (error) {\r\n        console.error('Error in history change listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the history manager and clean up resources\r\n   */\r\n  destroy(): void {\r\n    this.clear();\r\n    this.listeners.clear();\r\n  }\r\n}\r\n","/**\r\n * Plugin Manager - Handles plugin registration, activation, and lifecycle\r\n * Requirements: 2.1, 2.2, 2.3, 2.4\r\n */\r\n\r\nimport type { Plugin, PluginConstructor, PluginContext } from '../types/plugin.types';\r\n\r\n/**\r\n * PluginManager class - Manages plugin lifecycle\r\n * Requirements: 2.1, 2.2, 2.3, 2.4\r\n */\r\nexport class PluginManager {\r\n  /** Registered plugins map */\r\n  private plugins: Map<string, Plugin> = new Map();\r\n  /** Currently active plugin name */\r\n  private activePluginName: string | null = null;\r\n  /** Plugin context for installation */\r\n  private context: PluginContext | null = null;\r\n  /** Listeners for plugin changes */\r\n  private listeners: Set<(pluginName: string | null, prevPluginName: string | null) => void> = new Set();\r\n\r\n  /**\r\n   * Set the plugin context\r\n   * @param context - Plugin context\r\n   */\r\n  setContext(context: PluginContext): void {\r\n    this.context = context;\r\n  }\r\n\r\n  /**\r\n   * Register a plugin\r\n   * Requirements: 2.1 - Add plugin to available tools list\r\n   * @param PluginClass - Plugin constructor\r\n   * @returns The plugin manager instance for chaining\r\n   */\r\n  register(PluginClass: PluginConstructor): this {\r\n    if (!this.context) {\r\n      throw new Error('Plugin context not set. Call setContext() first.');\r\n    }\r\n\r\n    const plugin = new PluginClass();\r\n    const name = plugin.name;\r\n\r\n    if (this.plugins.has(name)) {\r\n      console.warn(`Plugin \"${name}\" is already registered. Skipping.`);\r\n      return this;\r\n    }\r\n\r\n    // Install the plugin\r\n    plugin.install(this.context);\r\n    this.plugins.set(name, plugin);\r\n\r\n    return this;\r\n  }\r\n\r\n\r\n  /**\r\n   * Unregister a plugin\r\n   * @param name - Plugin name\r\n   * @returns True if plugin was unregistered\r\n   */\r\n  unregister(name: string): boolean {\r\n    const plugin = this.plugins.get(name);\r\n    if (!plugin) {\r\n      return false;\r\n    }\r\n\r\n    // Deactivate if active\r\n    if (this.activePluginName === name) {\r\n      this.deactivate(name);\r\n    }\r\n\r\n    // Destroy the plugin\r\n    plugin.destroy();\r\n    this.plugins.delete(name);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Activate a plugin\r\n   * Requirements: 2.3 - Call plugin's activate method with editor context\r\n   * @param name - Plugin name\r\n   * @returns True if plugin was activated\r\n   */\r\n  activate(name: string): boolean {\r\n    const plugin = this.plugins.get(name);\r\n    if (!plugin) {\r\n      console.warn(`Plugin \"${name}\" not found.`);\r\n      return false;\r\n    }\r\n\r\n    const prevPluginName = this.activePluginName;\r\n\r\n    // Deactivate current plugin if different\r\n    if (this.activePluginName && this.activePluginName !== name) {\r\n      this.deactivate(this.activePluginName);\r\n    }\r\n\r\n    // Activate the new plugin\r\n    plugin.activate();\r\n    this.activePluginName = name;\r\n\r\n    // Notify listeners\r\n    this.notifyListeners(name, prevPluginName);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Deactivate a plugin\r\n   * Requirements: 2.4 - Call plugin's deactivate method for cleanup\r\n   * @param name - Plugin name\r\n   * @returns True if plugin was deactivated\r\n   */\r\n  deactivate(name: string): boolean {\r\n    const plugin = this.plugins.get(name);\r\n    if (!plugin) {\r\n      return false;\r\n    }\r\n\r\n    if (this.activePluginName === name) {\r\n      plugin.deactivate();\r\n      const prevPluginName = this.activePluginName;\r\n      this.activePluginName = null;\r\n      this.notifyListeners(null, prevPluginName);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Get a plugin by name\r\n   * @param name - Plugin name\r\n   * @returns Plugin instance or undefined\r\n   */\r\n  get(name: string): Plugin | undefined {\r\n    return this.plugins.get(name);\r\n  }\r\n\r\n  /**\r\n   * Get the currently active plugin\r\n   * @returns Active plugin or null\r\n   */\r\n  getActive(): Plugin | null {\r\n    if (!this.activePluginName) {\r\n      return null;\r\n    }\r\n    return this.plugins.get(this.activePluginName) || null;\r\n  }\r\n\r\n  /**\r\n   * Get the name of the currently active plugin\r\n   * @returns Active plugin name or null\r\n   */\r\n  getActiveName(): string | null {\r\n    return this.activePluginName;\r\n  }\r\n\r\n  /**\r\n   * Check if a plugin is registered\r\n   * @param name - Plugin name\r\n   * @returns True if plugin is registered\r\n   */\r\n  has(name: string): boolean {\r\n    return this.plugins.has(name);\r\n  }\r\n\r\n  /**\r\n   * Check if a plugin is active\r\n   * @param name - Plugin name\r\n   * @returns True if plugin is active\r\n   */\r\n  isActive(name: string): boolean {\r\n    return this.activePluginName === name;\r\n  }\r\n\r\n  /**\r\n   * Get all registered plugin names\r\n   * @returns Array of plugin names\r\n   */\r\n  getNames(): string[] {\r\n    return Array.from(this.plugins.keys());\r\n  }\r\n\r\n  /**\r\n   * Get all registered plugins\r\n   * @returns Array of plugins\r\n   */\r\n  getAll(): Plugin[] {\r\n    return Array.from(this.plugins.values());\r\n  }\r\n\r\n  /**\r\n   * Subscribe to plugin activation changes\r\n   * @param listener - Callback function\r\n   * @returns Unsubscribe function\r\n   */\r\n  onChange(listener: (pluginName: string | null, prevPluginName: string | null) => void): () => void {\r\n    this.listeners.add(listener);\r\n    return () => {\r\n      this.listeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of plugin changes\r\n   */\r\n  private notifyListeners(pluginName: string | null, prevPluginName: string | null): void {\r\n    for (const listener of this.listeners) {\r\n      try {\r\n        listener(pluginName, prevPluginName);\r\n      } catch (error) {\r\n        console.error('Error in plugin change listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy all plugins and clean up resources\r\n   */\r\n  destroy(): void {\r\n    // Deactivate active plugin\r\n    if (this.activePluginName) {\r\n      this.deactivate(this.activePluginName);\r\n    }\r\n\r\n    // Destroy all plugins\r\n    for (const plugin of this.plugins.values()) {\r\n      plugin.destroy();\r\n    }\r\n\r\n    this.plugins.clear();\r\n    this.listeners.clear();\r\n    this.context = null;\r\n  }\r\n}\r\n","/**\r\n * KeyboardManager - Handles keyboard shortcuts\r\n */\r\n\r\nexport interface ShortcutConfig {\r\n  /** Key code or key name */\r\n  key: string;\r\n  /** Ctrl/Command key required */\r\n  ctrl?: boolean;\r\n  /** Shift key required */\r\n  shift?: boolean;\r\n  /** Alt key required */\r\n  alt?: boolean;\r\n  /** Callback function */\r\n  handler: (e: KeyboardEvent) => void;\r\n  /** Description for UI display */\r\n  description?: string;\r\n  /** Whether to prevent default browser behavior */\r\n  preventDefault?: boolean;\r\n  /** Whether shortcut is enabled */\r\n  enabled?: boolean;\r\n}\r\n\r\nexport interface ShortcutGroup {\r\n  name: string;\r\n  shortcuts: Map<string, ShortcutConfig>;\r\n}\r\n\r\n/**\r\n * Generate a unique key for a shortcut combination\r\n */\r\nfunction getShortcutKey(config: Omit<ShortcutConfig, 'handler' | 'description'>): string {\r\n  const parts: string[] = [];\r\n  if (config.ctrl) parts.push('ctrl');\r\n  if (config.alt) parts.push('alt');\r\n  if (config.shift) parts.push('shift');\r\n  parts.push(config.key.toLowerCase());\r\n  return parts.join('+');\r\n}\r\n\r\n/**\r\n * KeyboardManager - Manages keyboard shortcuts registration and handling\r\n */\r\nexport class KeyboardManager {\r\n  private shortcuts: Map<string, ShortcutConfig> = new Map();\r\n  private groups: Map<string, ShortcutGroup> = new Map();\r\n  private enabled: boolean = true;\r\n  private target: HTMLElement | Document;\r\n  private boundHandler: (e: KeyboardEvent) => void;\r\n\r\n  constructor(target: HTMLElement | Document = document) {\r\n    this.target = target;\r\n    this.boundHandler = this.handleKeyDown.bind(this);\r\n    this.attach();\r\n  }\r\n\r\n  /**\r\n   * Attach keyboard event listener\r\n   */\r\n  attach(): void {\r\n    this.target.addEventListener('keydown', this.boundHandler as EventListener);\r\n  }\r\n\r\n  /**\r\n   * Detach keyboard event listener\r\n   */\r\n  detach(): void {\r\n    this.target.removeEventListener('keydown', this.boundHandler as EventListener);\r\n  }\r\n\r\n  /**\r\n   * Enable/disable all shortcuts\r\n   */\r\n  setEnabled(enabled: boolean): void {\r\n    this.enabled = enabled;\r\n  }\r\n\r\n  /**\r\n   * Check if keyboard manager is enabled\r\n   */\r\n  isEnabled(): boolean {\r\n    return this.enabled;\r\n  }\r\n\r\n  /**\r\n   * Register a keyboard shortcut\r\n   * @param config - Shortcut configuration\r\n   * @param group - Optional group name\r\n   * @returns Unregister function\r\n   */\r\n  register(config: ShortcutConfig, group?: string): () => void {\r\n    const key = getShortcutKey(config);\r\n    \r\n    // Check for conflicts\r\n    if (this.shortcuts.has(key)) {\r\n      console.warn(`Keyboard shortcut \"${key}\" is already registered. Overwriting.`);\r\n    }\r\n\r\n    const fullConfig: ShortcutConfig = {\r\n      ...config,\r\n      enabled: config.enabled !== false,\r\n      preventDefault: config.preventDefault !== false,\r\n    };\r\n\r\n    this.shortcuts.set(key, fullConfig);\r\n\r\n    // Add to group if specified\r\n    if (group) {\r\n      if (!this.groups.has(group)) {\r\n        this.groups.set(group, { name: group, shortcuts: new Map() });\r\n      }\r\n      this.groups.get(group)!.shortcuts.set(key, fullConfig);\r\n    }\r\n\r\n    // Return unregister function\r\n    return () => this.unregister(key);\r\n  }\r\n\r\n  /**\r\n   * Register multiple shortcuts at once\r\n   * @param configs - Array of shortcut configs\r\n   * @param group - Optional group name\r\n   */\r\n  registerMultiple(configs: ShortcutConfig[], group?: string): () => void {\r\n    const unregisters = configs.map(config => this.register(config, group));\r\n    return () => unregisters.forEach(fn => fn());\r\n  }\r\n\r\n  /**\r\n   * Unregister a shortcut\r\n   * @param key - Shortcut key string\r\n   */\r\n  unregister(key: string): void {\r\n    this.shortcuts.delete(key);\r\n    // Remove from all groups\r\n    this.groups.forEach(group => {\r\n      group.shortcuts.delete(key);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unregister all shortcuts in a group\r\n   * @param groupName - Group name\r\n   */\r\n  unregisterGroup(groupName: string): void {\r\n    const group = this.groups.get(groupName);\r\n    if (group) {\r\n      group.shortcuts.forEach((_, key) => {\r\n        this.shortcuts.delete(key);\r\n      });\r\n      this.groups.delete(groupName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enable/disable a specific shortcut\r\n   * @param key - Shortcut key string\r\n   * @param enabled - Enable state\r\n   */\r\n  setShortcutEnabled(key: string, enabled: boolean): void {\r\n    const shortcut = this.shortcuts.get(key);\r\n    if (shortcut) {\r\n      shortcut.enabled = enabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all registered shortcuts\r\n   */\r\n  getShortcuts(): Map<string, ShortcutConfig> {\r\n    return new Map(this.shortcuts);\r\n  }\r\n\r\n  /**\r\n   * Get shortcuts for a specific group\r\n   */\r\n  getGroupShortcuts(groupName: string): Map<string, ShortcutConfig> | undefined {\r\n    return this.groups.get(groupName)?.shortcuts;\r\n  }\r\n\r\n  /**\r\n   * Handle keydown event\r\n   */\r\n  private handleKeyDown(e: KeyboardEvent): void {\r\n    if (!this.enabled) return;\r\n\r\n    // Skip if in input/textarea/contenteditable\r\n    const target = e.target as HTMLElement;\r\n    if (\r\n      target.tagName === 'INPUT' ||\r\n      target.tagName === 'TEXTAREA' ||\r\n      target.isContentEditable\r\n    ) {\r\n      // Allow Escape to work even in inputs\r\n      if (e.key !== 'Escape') {\r\n        return;\r\n      }\r\n    }\r\n\r\n    const key = getShortcutKey({\r\n      key: e.key,\r\n      ctrl: e.ctrlKey || e.metaKey, // Support both Ctrl and Cmd (Mac)\r\n      shift: e.shiftKey,\r\n      alt: e.altKey,\r\n    });\r\n\r\n    const shortcut = this.shortcuts.get(key);\r\n    \r\n    if (shortcut && shortcut.enabled !== false) {\r\n      if (shortcut.preventDefault !== false) {\r\n        e.preventDefault();\r\n      }\r\n      shortcut.handler(e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Format shortcut for display (e.g., \"Ctrl+Z\")\r\n   */\r\n  static formatShortcut(config: Partial<ShortcutConfig>): string {\r\n    const parts: string[] = [];\r\n    const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);\r\n    \r\n    if (config.ctrl) parts.push(isMac ? '⌘' : 'Ctrl');\r\n    if (config.alt) parts.push(isMac ? '⌥' : 'Alt');\r\n    if (config.shift) parts.push(isMac ? '⇧' : 'Shift');\r\n    \r\n    if (config.key) {\r\n      // Format special keys\r\n      const keyMap: Record<string, string> = {\r\n        ' ': 'Space',\r\n        'ArrowUp': '↑',\r\n        'ArrowDown': '↓',\r\n        'ArrowLeft': '←',\r\n        'ArrowRight': '→',\r\n        'Escape': 'Esc',\r\n        'Delete': 'Del',\r\n        'Backspace': '⌫',\r\n      };\r\n      parts.push(keyMap[config.key] || config.key.toUpperCase());\r\n    }\r\n    \r\n    return parts.join('+');\r\n  }\r\n\r\n  /**\r\n   * Destroy the keyboard manager\r\n   */\r\n  destroy(): void {\r\n    this.detach();\r\n    this.shortcuts.clear();\r\n    this.groups.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * Default editor shortcuts configuration\r\n */\r\nexport function createEditorShortcuts(handlers: {\r\n  undo?: () => void;\r\n  redo?: () => void;\r\n  copy?: () => void;\r\n  paste?: () => void;\r\n  delete?: () => void;\r\n  escape?: () => void;\r\n  zoomIn?: () => void;\r\n  zoomOut?: () => void;\r\n  zoomReset?: () => void;\r\n  selectTool?: (tool: string | null) => void;\r\n  save?: () => void;\r\n}): ShortcutConfig[] {\r\n  const shortcuts: ShortcutConfig[] = [];\r\n\r\n  if (handlers.undo) {\r\n    shortcuts.push({\r\n      key: 'z',\r\n      ctrl: true,\r\n      handler: handlers.undo,\r\n      description: 'Undo',\r\n    });\r\n  }\r\n\r\n  if (handlers.redo) {\r\n    shortcuts.push({\r\n      key: 'y',\r\n      ctrl: true,\r\n      handler: handlers.redo,\r\n      description: 'Redo',\r\n    });\r\n    // Also support Ctrl+Shift+Z\r\n    shortcuts.push({\r\n      key: 'z',\r\n      ctrl: true,\r\n      shift: true,\r\n      handler: handlers.redo,\r\n      description: 'Redo',\r\n    });\r\n  }\r\n\r\n  if (handlers.copy) {\r\n    shortcuts.push({\r\n      key: 'c',\r\n      ctrl: true,\r\n      handler: handlers.copy,\r\n      description: 'Copy',\r\n    });\r\n  }\r\n\r\n  if (handlers.paste) {\r\n    shortcuts.push({\r\n      key: 'v',\r\n      ctrl: true,\r\n      handler: handlers.paste,\r\n      description: 'Paste',\r\n    });\r\n  }\r\n\r\n  if (handlers.delete) {\r\n    shortcuts.push({\r\n      key: 'Delete',\r\n      handler: handlers.delete,\r\n      description: 'Delete',\r\n    });\r\n    shortcuts.push({\r\n      key: 'Backspace',\r\n      handler: handlers.delete,\r\n      description: 'Delete',\r\n    });\r\n  }\r\n\r\n  if (handlers.escape) {\r\n    shortcuts.push({\r\n      key: 'Escape',\r\n      handler: handlers.escape,\r\n      description: 'Cancel / Deselect',\r\n    });\r\n  }\r\n\r\n  if (handlers.zoomIn) {\r\n    shortcuts.push({\r\n      key: '=',\r\n      ctrl: true,\r\n      handler: handlers.zoomIn,\r\n      description: 'Zoom In',\r\n    });\r\n    shortcuts.push({\r\n      key: '+',\r\n      ctrl: true,\r\n      handler: handlers.zoomIn,\r\n      description: 'Zoom In',\r\n    });\r\n  }\r\n\r\n  if (handlers.zoomOut) {\r\n    shortcuts.push({\r\n      key: '-',\r\n      ctrl: true,\r\n      handler: handlers.zoomOut,\r\n      description: 'Zoom Out',\r\n    });\r\n  }\r\n\r\n  if (handlers.zoomReset) {\r\n    shortcuts.push({\r\n      key: '0',\r\n      ctrl: true,\r\n      handler: handlers.zoomReset,\r\n      description: 'Reset Zoom',\r\n    });\r\n  }\r\n\r\n  if (handlers.selectTool) {\r\n    // Number keys 1-9 for tool selection\r\n    const tools = [null, 'pen', 'rect', 'circle', 'arrow', 'text', 'mosaic', 'eraser', 'crop'];\r\n    tools.forEach((tool, index) => {\r\n      if (index < 10) {\r\n        shortcuts.push({\r\n          key: String(index),\r\n          handler: () => handlers.selectTool!(tool),\r\n          description: `Select ${tool || 'Move'} tool`,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  if (handlers.save) {\r\n    shortcuts.push({\r\n      key: 's',\r\n      ctrl: true,\r\n      handler: handlers.save,\r\n      description: 'Save / Export',\r\n    });\r\n  }\r\n\r\n  return shortcuts;\r\n}\r\n","/**\r\n * Canvas class - Manages canvas creation, sizing, and image data\r\n * Requirements: 1.1, 8.2\r\n */\r\n\r\nimport {\r\n  createCanvas,\r\n  getContext2D,\r\n  setCanvasSize,\r\n  clearCanvas,\r\n  fillCanvas,\r\n  setStyles,\r\n  removeElement,\r\n} from '../utils/dom.utils';\r\nimport {\r\n  loadImage,\r\n  getImageDimensions,\r\n  calculateAspectRatioFit,\r\n  drawImageToCanvas,\r\n  getImageData,\r\n  putImageData,\r\n  cloneImageData,\r\n} from '../utils/image.utils';\r\nimport type { EditorConfig } from '../types/config.types';\r\n\r\n/**\r\n * Canvas resize event data\r\n */\r\nexport interface CanvasResizeData {\r\n  width: number;\r\n  height: number;\r\n  previousWidth: number;\r\n  previousHeight: number;\r\n}\r\n\r\n/**\r\n * Canvas class - Handles canvas creation and management\r\n * Requirements: 1.1, 8.2\r\n */\r\nexport class Canvas {\r\n  /** Canvas element */\r\n  private _canvas: HTMLCanvasElement;\r\n  /** Canvas 2D context */\r\n  private _ctx: CanvasRenderingContext2D;\r\n  /** Container element */\r\n  private _container: HTMLElement;\r\n  /** Original image element */\r\n  private _originalImage: HTMLImageElement | null = null;\r\n  /** Original image data (for reset) */\r\n  private _originalImageData: ImageData | null = null;\r\n  /** Whether responsive mode is enabled */\r\n  private _responsive: boolean;\r\n  /** Background color */\r\n  private _backgroundColor: string;\r\n  /** Resize observer for responsive mode */\r\n  private _resizeObserver: ResizeObserver | null = null;\r\n  /** Resize listeners */\r\n  private _resizeListeners: Set<(data: CanvasResizeData) => void> = new Set();\r\n  /** Whether the canvas is destroyed */\r\n  private _destroyed: boolean = false;\r\n\r\n\r\n  /**\r\n   * Create a new Canvas instance\r\n   * @param container - Container element\r\n   * @param config - Editor configuration\r\n   */\r\n  constructor(container: HTMLElement, config: Required<EditorConfig>) {\r\n    this._container = container;\r\n    this._responsive = config.responsive;\r\n    this._backgroundColor = config.backgroundColor;\r\n\r\n    // Create canvas element\r\n    this._canvas = createCanvas(config.width, config.height);\r\n    this._ctx = getContext2D(this._canvas);\r\n\r\n    // Style the canvas\r\n    setStyles(this._canvas, {\r\n      display: 'block',\r\n      maxWidth: '100%',\r\n      maxHeight: '100%',\r\n    });\r\n\r\n    // Append to container\r\n    this._container.appendChild(this._canvas);\r\n\r\n    // Fill with background color\r\n    this.fillBackground();\r\n\r\n    // Setup responsive behavior if enabled\r\n    if (this._responsive) {\r\n      this.setupResponsive();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the canvas element\r\n   */\r\n  get canvas(): HTMLCanvasElement {\r\n    return this._canvas;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas 2D context\r\n   */\r\n  get ctx(): CanvasRenderingContext2D {\r\n    return this._ctx;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas width\r\n   */\r\n  get width(): number {\r\n    return this._canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas height\r\n   */\r\n  get height(): number {\r\n    return this._canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Get the container element\r\n   */\r\n  get container(): HTMLElement {\r\n    return this._container;\r\n  }\r\n\r\n  /**\r\n   * Get the original image\r\n   */\r\n  get originalImage(): HTMLImageElement | null {\r\n    return this._originalImage;\r\n  }\r\n\r\n  /**\r\n   * Check if canvas is destroyed\r\n   */\r\n  get isDestroyed(): boolean {\r\n    return this._destroyed;\r\n  }\r\n\r\n\r\n  /**\r\n   * Fill canvas with background color\r\n   */\r\n  private fillBackground(): void {\r\n    if (this._backgroundColor === 'transparent') {\r\n      clearCanvas(this._ctx, this.width, this.height);\r\n    } else {\r\n      fillCanvas(this._ctx, this.width, this.height, this._backgroundColor);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setup responsive behavior\r\n   * Requirements: 8.2 - Auto-adjust canvas size on container resize\r\n   */\r\n  private setupResponsive(): void {\r\n    if (typeof ResizeObserver === 'undefined') {\r\n      // Fallback to window resize event\r\n      window.addEventListener('resize', this.handleResize);\r\n      return;\r\n    }\r\n\r\n    this._resizeObserver = new ResizeObserver((entries) => {\r\n      for (const entry of entries) {\r\n        if (entry.target === this._container) {\r\n          this.handleContainerResize();\r\n        }\r\n      }\r\n    });\r\n\r\n    this._resizeObserver.observe(this._container);\r\n  }\r\n\r\n  /**\r\n   * Handle window resize (fallback)\r\n   */\r\n  private handleResize = (): void => {\r\n    this.handleContainerResize();\r\n  };\r\n\r\n  /**\r\n   * Handle container resize\r\n   * Requirements: 8.2 - Maintain aspect ratio on resize\r\n   */\r\n  private handleContainerResize(): void {\r\n    if (this._destroyed || !this._originalImage) {\r\n      return;\r\n    }\r\n\r\n    const containerRect = this._container.getBoundingClientRect();\r\n    const containerWidth = containerRect.width;\r\n    const containerHeight = containerRect.height;\r\n\r\n    if (containerWidth === 0 || containerHeight === 0) {\r\n      return;\r\n    }\r\n\r\n    const { width: imgWidth, height: imgHeight } = getImageDimensions(this._originalImage);\r\n    const previousWidth = this.width;\r\n    const previousHeight = this.height;\r\n\r\n    // Calculate new dimensions maintaining aspect ratio\r\n    const { width: newWidth, height: newHeight } = calculateAspectRatioFit(\r\n      imgWidth,\r\n      imgHeight,\r\n      containerWidth,\r\n      containerHeight\r\n    );\r\n\r\n    // Only resize if dimensions changed\r\n    if (newWidth !== previousWidth || newHeight !== previousHeight) {\r\n      this.resize(newWidth, newHeight, true);\r\n\r\n      // Notify listeners\r\n      this.notifyResizeListeners({\r\n        width: newWidth,\r\n        height: newHeight,\r\n        previousWidth,\r\n        previousHeight,\r\n      });\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Load an image onto the canvas\r\n   * Requirements: 1.1 - Load image into canvas\r\n   * @param source - Image source (URL or HTMLImageElement)\r\n   * @returns Promise with image dimensions\r\n   */\r\n  async loadImage(source: string | HTMLImageElement): Promise<{ width: number; height: number }> {\r\n    const image = await loadImage(source);\r\n    this._originalImage = image;\r\n\r\n    const { width: imgWidth, height: imgHeight } = getImageDimensions(image);\r\n\r\n    // Calculate dimensions based on container if responsive\r\n    let targetWidth = imgWidth;\r\n    let targetHeight = imgHeight;\r\n\r\n    if (this._responsive) {\r\n      const containerRect = this._container.getBoundingClientRect();\r\n      const containerWidth = containerRect.width || imgWidth;\r\n      const containerHeight = containerRect.height || imgHeight;\r\n\r\n      const scaled = calculateAspectRatioFit(\r\n        imgWidth,\r\n        imgHeight,\r\n        containerWidth,\r\n        containerHeight\r\n      );\r\n      targetWidth = scaled.width;\r\n      targetHeight = scaled.height;\r\n    }\r\n\r\n    // Resize canvas to fit image\r\n    this.resize(targetWidth, targetHeight, false);\r\n\r\n    // Draw image\r\n    drawImageToCanvas(this._ctx, image, 0, 0, targetWidth, targetHeight);\r\n\r\n    // Store original image data\r\n    this._originalImageData = this.getImageData();\r\n\r\n    return { width: targetWidth, height: targetHeight };\r\n  }\r\n\r\n  /**\r\n   * Resize the canvas\r\n   * @param width - New width\r\n   * @param height - New height\r\n   * @param preserveContent - Whether to preserve current content\r\n   */\r\n  resize(width: number, height: number, preserveContent: boolean = false): void {\r\n    // Resize canvas\r\n    setCanvasSize(this._canvas, width, height);\r\n\r\n    // Fill background\r\n    this.fillBackground();\r\n\r\n    // Restore content\r\n    if (preserveContent && this._originalImage) {\r\n      // Redraw original image at new size\r\n      drawImageToCanvas(this._ctx, this._originalImage, 0, 0, width, height);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get image data from canvas\r\n   * @param x - Start X coordinate\r\n   * @param y - Start Y coordinate\r\n   * @param width - Width (defaults to canvas width)\r\n   * @param height - Height (defaults to canvas height)\r\n   * @returns ImageData\r\n   */\r\n  getImageData(x: number = 0, y: number = 0, width?: number, height?: number): ImageData {\r\n    return getImageData(this._ctx, x, y, width ?? this.width, height ?? this.height);\r\n  }\r\n\r\n  /**\r\n   * Put image data to canvas\r\n   * @param imageData - ImageData to put\r\n   * @param x - X coordinate\r\n   * @param y - Y coordinate\r\n   */\r\n  putImageData(imageData: ImageData, x: number = 0, y: number = 0): void {\r\n    putImageData(this._ctx, imageData, x, y);\r\n  }\r\n\r\n  /**\r\n   * Get original image data (for reset)\r\n   * @returns Original ImageData or null\r\n   */\r\n  getOriginalImageData(): ImageData | null {\r\n    return this._originalImageData ? cloneImageData(this._originalImageData) : null;\r\n  }\r\n\r\n\r\n  /**\r\n   * Clear the canvas\r\n   */\r\n  clear(): void {\r\n    clearCanvas(this._ctx, this.width, this.height);\r\n    this.fillBackground();\r\n  }\r\n\r\n  /**\r\n   * Reset canvas to original image\r\n   */\r\n  reset(): void {\r\n    if (this._originalImageData) {\r\n      this.clear();\r\n      this.putImageData(this._originalImageData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set background color\r\n   * @param color - Background color\r\n   */\r\n  setBackgroundColor(color: string): void {\r\n    this._backgroundColor = color;\r\n  }\r\n\r\n  /**\r\n   * Subscribe to resize events\r\n   * @param listener - Resize listener\r\n   * @returns Unsubscribe function\r\n   */\r\n  onResize(listener: (data: CanvasResizeData) => void): () => void {\r\n    this._resizeListeners.add(listener);\r\n    return () => {\r\n      this._resizeListeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify resize listeners\r\n   */\r\n  private notifyResizeListeners(data: CanvasResizeData): void {\r\n    for (const listener of this._resizeListeners) {\r\n      try {\r\n        listener(data);\r\n      } catch (error) {\r\n        console.error('Error in resize listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the canvas and clean up resources\r\n   * Requirements: 1.5 - Clean up canvas resources\r\n   */\r\n  destroy(): void {\r\n    if (this._destroyed) {\r\n      return;\r\n    }\r\n\r\n    this._destroyed = true;\r\n\r\n    // Remove resize observer\r\n    if (this._resizeObserver) {\r\n      this._resizeObserver.disconnect();\r\n      this._resizeObserver = null;\r\n    }\r\n\r\n    // Remove window resize listener\r\n    window.removeEventListener('resize', this.handleResize);\r\n\r\n    // Clear listeners\r\n    this._resizeListeners.clear();\r\n\r\n    // Remove canvas from DOM\r\n    removeElement(this._canvas);\r\n\r\n    // Clear references\r\n    this._originalImage = null;\r\n    this._originalImageData = null;\r\n  }\r\n}\r\n","/**\r\n * SVG Icons - Lucide-style icons for the toolbar\r\n */\r\n\r\nconst createSvg = (paths: string, size = 20): string => `\r\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${size}\" height=\"${size}\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n  ${paths}\r\n</svg>`.trim();\r\n\r\nexport const icons = {\r\n  // Move/Hand\r\n  move: createSvg(`\r\n    <path d=\"M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2\"/>\r\n    <path d=\"M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2\"/>\r\n    <path d=\"M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8\"/>\r\n    <path d=\"M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15\"/>\r\n  `),\r\n\r\n  // Brush/Pencil\r\n  brush: createSvg(`\r\n    <path d=\"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08\"/>\r\n    <path d=\"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z\"/>\r\n  `),\r\n\r\n  // Text/Type\r\n  type: createSvg(`\r\n    <polyline points=\"4 7 4 4 20 4 20 7\"/>\r\n    <line x1=\"9\" y1=\"20\" x2=\"15\" y2=\"20\"/>\r\n    <line x1=\"12\" y1=\"4\" x2=\"12\" y2=\"20\"/>\r\n  `),\r\n\r\n  // Zoom In\r\n  zoomIn: createSvg(`\r\n    <circle cx=\"11\" cy=\"11\" r=\"8\"/>\r\n    <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\r\n    <line x1=\"11\" y1=\"8\" x2=\"11\" y2=\"14\"/>\r\n    <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\r\n  `),\r\n\r\n  // Zoom Out\r\n  zoomOut: createSvg(`\r\n    <circle cx=\"11\" cy=\"11\" r=\"8\"/>\r\n    <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\r\n    <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\r\n  `),\r\n\r\n  // Undo\r\n  undo: createSvg(`\r\n    <path d=\"M3 7v6h6\"/>\r\n    <path d=\"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13\"/>\r\n  `),\r\n\r\n  // Redo\r\n  redo: createSvg(`\r\n    <path d=\"M21 7v6h-6\"/>\r\n    <path d=\"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7\"/>\r\n  `),\r\n\r\n  // Download\r\n  download: createSvg(`\r\n    <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/>\r\n    <polyline points=\"7 10 12 15 17 10\"/>\r\n    <line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"/>\r\n  `),\r\n\r\n  // Reset/RotateCcw\r\n  reset: createSvg(`\r\n    <path d=\"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8\"/>\r\n    <path d=\"M3 3v5h5\"/>\r\n  `),\r\n\r\n  // Plus\r\n  plus: createSvg(`\r\n    <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/>\r\n    <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Minus\r\n  minus: createSvg(`\r\n    <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Check\r\n  check: createSvg(`\r\n    <polyline points=\"20 6 9 17 4 12\"/>\r\n  `),\r\n\r\n  // X/Close\r\n  close: createSvg(`\r\n    <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"/>\r\n    <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"/>\r\n  `),\r\n\r\n  // Upload\r\n  upload: createSvg(`\r\n    <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/>\r\n    <polyline points=\"17 8 12 3 7 8\"/>\r\n    <line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/>\r\n  `),\r\n\r\n  // Settings/Sliders\r\n  settings: createSvg(`\r\n    <line x1=\"4\" y1=\"21\" x2=\"4\" y2=\"14\"/>\r\n    <line x1=\"4\" y1=\"10\" x2=\"4\" y2=\"3\"/>\r\n    <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"12\"/>\r\n    <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"3\"/>\r\n    <line x1=\"20\" y1=\"21\" x2=\"20\" y2=\"16\"/>\r\n    <line x1=\"20\" y1=\"12\" x2=\"20\" y2=\"3\"/>\r\n    <line x1=\"1\" y1=\"14\" x2=\"7\" y2=\"14\"/>\r\n    <line x1=\"9\" y1=\"8\" x2=\"15\" y2=\"8\"/>\r\n    <line x1=\"17\" y1=\"16\" x2=\"23\" y2=\"16\"/>\r\n  `),\r\n\r\n  // Pen/Pencil (free draw)\r\n  pen: createSvg(`\r\n    <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/>\r\n    <path d=\"m15 5 4 4\"/>\r\n  `),\r\n\r\n  // Rectangle/Square\r\n  rect: createSvg(`\r\n    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/>\r\n  `),\r\n\r\n  // Circle\r\n  circle: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n  `),\r\n\r\n  // Arrow\r\n  arrow: createSvg(`\r\n    <path d=\"M5 12h14\"/>\r\n    <path d=\"m12 5 7 7-7 7\"/>\r\n  `),\r\n\r\n  // Mosaic/Blur\r\n  mosaic: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n    <circle cx=\"12\" cy=\"12\" r=\"6\" opacity=\"0.6\"/>\r\n    <circle cx=\"12\" cy=\"12\" r=\"9\" opacity=\"0.3\"/>\r\n  `),\r\n\r\n  // Crop\r\n  crop: createSvg(`\r\n    <path d=\"M6 2v14a2 2 0 0 0 2 2h14\"/>\r\n    <path d=\"M18 22V8a2 2 0 0 0-2-2H2\"/>\r\n  `),\r\n\r\n  // Filter/Adjustments\r\n  filter: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n    <path d=\"M12 2a10 10 0 0 0 0 20\"/>\r\n    <path d=\"M12 2a10 10 0 0 1 0 20\"/>\r\n    <line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Eraser\r\n  eraser: createSvg(`\r\n    <path d=\"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21\"/>\r\n    <path d=\"M22 21H7\"/>\r\n    <path d=\"m5 11 9 9\"/>\r\n  `),\r\n\r\n  // Line\r\n  line: createSvg(`\r\n    <path d=\"M4 20L20 4\"/>\r\n  `),\r\n\r\n  // Triangle\r\n  triangle: createSvg(`\r\n    <path d=\"M12 3L22 21H2L12 3Z\"/>\r\n  `),\r\n\r\n  // Rotate Left\r\n  rotateLeft: createSvg(`\r\n    <path d=\"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8\"/>\r\n    <path d=\"M3 3v5h5\"/>\r\n  `),\r\n\r\n  // Rotate Right\r\n  rotateRight: createSvg(`\r\n    <path d=\"M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"/>\r\n    <path d=\"M21 3v5h-5\"/>\r\n  `),\r\n\r\n  // Flip Horizontal\r\n  flipH: createSvg(`\r\n    <path d=\"M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3\"/>\r\n    <path d=\"M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3\"/>\r\n    <line x1=\"12\" y1=\"2\" x2=\"12\" y2=\"22\"/>\r\n  `),\r\n\r\n  // Flip Vertical\r\n  flipV: createSvg(`\r\n    <path d=\"M3 8V5a2 2 0 0 1 2-2h14c1.1 0 2 .9 2 2v3\"/>\r\n    <path d=\"M3 16v3a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-3\"/>\r\n    <line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Ruler\r\n  ruler: createSvg(`\r\n    <path d=\"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z\"/>\r\n    <path d=\"m14.5 12.5 2-2\"/>\r\n    <path d=\"m11.5 9.5 2-2\"/>\r\n    <path d=\"m8.5 6.5 2-2\"/>\r\n    <path d=\"m17.5 15.5 2-2\"/>\r\n  `),\r\n\r\n  // Grid\r\n  grid: createSvg(`\r\n    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/>\r\n    <line x1=\"3\" y1=\"9\" x2=\"21\" y2=\"9\"/>\r\n    <line x1=\"3\" y1=\"15\" x2=\"21\" y2=\"15\"/>\r\n    <line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\"/>\r\n    <line x1=\"15\" y1=\"3\" x2=\"15\" y2=\"21\"/>\r\n  `),\r\n\r\n  // Sun (for brightness)\r\n  sun: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"4\"/>\r\n    <path d=\"M12 2v2\"/>\r\n    <path d=\"M12 20v2\"/>\r\n    <path d=\"m4.93 4.93 1.41 1.41\"/>\r\n    <path d=\"m17.66 17.66 1.41 1.41\"/>\r\n    <path d=\"M2 12h2\"/>\r\n    <path d=\"M20 12h2\"/>\r\n    <path d=\"m6.34 17.66-1.41 1.41\"/>\r\n    <path d=\"m19.07 4.93-1.41 1.41\"/>\r\n  `),\r\n\r\n  // Contrast\r\n  contrast: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n    <path d=\"M12 2a10 10 0 0 1 0 20z\"/>\r\n  `),\r\n\r\n  // Image (for presets)\r\n  image: createSvg(`\r\n    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\r\n    <circle cx=\"9\" cy=\"9\" r=\"2\"/>\r\n    <path d=\"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\"/>\r\n  `),\r\n\r\n  // Layers\r\n  layers: createSvg(`\r\n    <polygon points=\"12 2 2 7 12 12 22 7 12 2\"/>\r\n    <polyline points=\"2 17 12 22 22 17\"/>\r\n    <polyline points=\"2 12 12 17 22 12\"/>\r\n  `),\r\n\r\n  // Bold\r\n  bold: createSvg(`\r\n    <path d=\"M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z\"/>\r\n    <path d=\"M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z\"/>\r\n  `),\r\n\r\n  // Italic\r\n  italic: createSvg(`\r\n    <line x1=\"19\" y1=\"4\" x2=\"10\" y2=\"4\"/>\r\n    <line x1=\"14\" y1=\"20\" x2=\"5\" y2=\"20\"/>\r\n    <line x1=\"15\" y1=\"4\" x2=\"9\" y2=\"20\"/>\r\n  `),\r\n\r\n  // Underline\r\n  underline: createSvg(`\r\n    <path d=\"M6 4v6a6 6 0 0 0 12 0V4\"/>\r\n    <line x1=\"4\" y1=\"20\" x2=\"20\" y2=\"20\"/>\r\n  `),\r\n\r\n  // Dashed line\r\n  dashed: createSvg(`\r\n    <line x1=\"3\" y1=\"12\" x2=\"8\" y2=\"12\" stroke-dasharray=\"5,5\"/>\r\n    <line x1=\"11\" y1=\"12\" x2=\"16\" y2=\"12\" stroke-dasharray=\"5,5\"/>\r\n    <line x1=\"19\" y1=\"12\" x2=\"21\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Fill\r\n  fill: createSvg(`\r\n    <path d=\"m19 11-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11Z\"/>\r\n    <path d=\"m5 2 5 5\"/>\r\n    <path d=\"M2 13h15\"/>\r\n    <path d=\"M22 20a2 2 0 1 1-4 0c0-1.6 1.7-2.4 2-4 .3 1.6 2 2.4 2 4Z\"/>\r\n  `),\r\n\r\n  // Copy\r\n  copy: createSvg(`\r\n    <rect width=\"14\" height=\"14\" x=\"8\" y=\"8\" rx=\"2\" ry=\"2\"/>\r\n    <path d=\"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2\"/>\r\n  `),\r\n\r\n  // Clipboard/Paste\r\n  paste: createSvg(`\r\n    <rect width=\"8\" height=\"4\" x=\"8\" y=\"2\" rx=\"1\" ry=\"1\"/>\r\n    <path d=\"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2\"/>\r\n  `),\r\n\r\n  // Trash/Delete\r\n  trash: createSvg(`\r\n    <path d=\"M3 6h18\"/>\r\n    <path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/>\r\n    <path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\r\n  `),\r\n\r\n  // Watermark\r\n  watermark: createSvg(`\r\n    <path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10\"/>\r\n    <path d=\"m9 12 2 2 4-4\"/>\r\n  `),\r\n\r\n  // More/Menu\r\n  more: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"1\"/>\r\n    <circle cx=\"19\" cy=\"12\" r=\"1\"/>\r\n    <circle cx=\"5\" cy=\"12\" r=\"1\"/>\r\n  `),\r\n};\r\n\r\nexport type IconName = keyof typeof icons;\r\n","/**\r\n * Toolbar CSS styles\r\n */\r\n\r\nexport const toolbarStyles = `\r\n/* Default (Dark theme) variables */\r\n.ie-editor-wrapper {\r\n  --ie-bg: #1e1e1e;\r\n  --ie-canvas-bg: #1a1a1a;\r\n  --ie-toolbar-bg: #2d2d2d;\r\n  --ie-toolbar-border: rgba(255,255,255,0.1);\r\n  --ie-btn-color: rgba(255,255,255,0.7);\r\n  --ie-btn-hover-bg: rgba(255,255,255,0.1);\r\n  --ie-btn-hover-color: #fff;\r\n  --ie-btn-active-bg: #667eea;\r\n  --ie-btn-active-color: #fff;\r\n  --ie-text-color: #fff;\r\n  --ie-text-muted: rgba(255,255,255,0.5);\r\n  --ie-divider: rgba(255,255,255,0.1);\r\n  --ie-panel-bg: #333;\r\n  --ie-input-bg: #222;\r\n  --ie-input-border: #444;\r\n  --ie-shadow: rgba(0,0,0,0.4);\r\n  --ie-radius: 8px;\r\n  --ie-transition: 0.15s ease;\r\n  \r\n  position: relative;\r\n  display: flex;\r\n  flex-direction: column;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: var(--ie-bg);\r\n  color: var(--ie-text-color);\r\n  user-select: none;\r\n  box-sizing: border-box;\r\n  overflow: visible;\r\n}\r\n\r\n/* Light theme */\r\n.ie-editor-wrapper.ie-theme-light {\r\n  --ie-bg: #f5f5f5;\r\n  --ie-canvas-bg: #f5f5f5;\r\n  --ie-toolbar-bg: #ffffff;\r\n  --ie-toolbar-border: rgba(0,0,0,0.1);\r\n  --ie-btn-color: rgba(0,0,0,0.7);\r\n  --ie-btn-hover-bg: rgba(0,0,0,0.08);\r\n  --ie-btn-hover-color: #000;\r\n  --ie-btn-active-bg: #667eea;\r\n  --ie-btn-active-color: #fff;\r\n  --ie-text-color: #333;\r\n  --ie-text-muted: rgba(0,0,0,0.5);\r\n  --ie-divider: rgba(0,0,0,0.1);\r\n  --ie-panel-bg: #ffffff;\r\n  --ie-input-bg: #f0f0f0;\r\n  --ie-input-border: #ddd;\r\n  --ie-shadow: rgba(0,0,0,0.15);\r\n}\r\n\r\n.ie-canvas-container {\r\n  position: relative;\r\n  flex: 1;\r\n  width: 100%;\r\n  min-height: 0;\r\n  overflow: hidden;\r\n  background: var(--ie-canvas-bg);\r\n  cursor: grab;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.ie-canvas-container.grabbing {\r\n  cursor: grabbing !important;\r\n}\r\n\r\n.ie-canvas-container.tool-draw {\r\n  cursor: crosshair;\r\n}\r\n\r\n.ie-canvas-container.tool-text {\r\n  cursor: text;\r\n}\r\n\r\n.ie-canvas-container.tool-move {\r\n  cursor: grab;\r\n}\r\n\r\n.ie-canvas-container.tool-move.grabbing {\r\n  cursor: grabbing;\r\n}\r\n\r\n.ie-canvas-viewport {\r\n  transform-origin: center center;\r\n  transition: none;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  will-change: transform;\r\n  backface-visibility: hidden;\r\n}\r\n\r\n.ie-canvas-viewport canvas {\r\n  display: block;\r\n  image-rendering: -webkit-optimize-contrast;\r\n  image-rendering: crisp-edges;\r\n}\r\n\r\n.ie-toolbar {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 6px;\r\n  padding: 10px 16px;\r\n  background: var(--ie-toolbar-bg);\r\n  border-top: 1px solid var(--ie-toolbar-border);\r\n  flex-shrink: 0;\r\n  transition: height 0.3s ease, padding 0.3s ease, opacity 0.3s ease, border-width 0.3s ease;\r\n  overflow: visible;\r\n}\r\n\r\n.ie-toolbar.ie-toolbar-hidden {\r\n  height: 0;\r\n  padding: 0;\r\n  border-top-width: 0;\r\n  opacity: 0;\r\n  pointer-events: none;\r\n  overflow: hidden;\r\n}\r\n\r\n.ie-toolbar-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n\r\n.ie-toolbar-divider {\r\n  width: 1px;\r\n  height: 24px;\r\n  background: var(--ie-divider);\r\n  margin: 0 6px;\r\n}\r\n\r\n.ie-btn {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color);\r\n  cursor: pointer;\r\n  transition: all var(--ie-transition);\r\n}\r\n\r\n.ie-btn:hover:not(:disabled) {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-btn:disabled {\r\n  opacity: 0.4;\r\n  cursor: not-allowed;\r\n}\r\n\r\n.ie-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: var(--ie-btn-active-color);\r\n}\r\n\r\n.ie-btn svg {\r\n  width: 20px;\r\n  height: 20px;\r\n}\r\n\r\n.ie-btn-export {\r\n  width: auto;\r\n  padding: 0 14px;\r\n  gap: 6px;\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n  font-size: 13px;\r\n}\r\n\r\n.ie-btn-export:hover:not(:disabled) {\r\n  background: var(--ie-btn-active-bg);\r\n  filter: brightness(0.9);\r\n}\r\n\r\n.ie-btn-export span {\r\n  font-weight: 500;\r\n}\r\n\r\n.ie-zoom-text {\r\n  min-width: 50px;\r\n  text-align: center;\r\n  font-size: 12px;\r\n  font-variant-numeric: tabular-nums;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n/* Settings Panel */\r\n.ie-panel {\r\n  position: absolute;\r\n  bottom: 100%;\r\n  left: 50%;\r\n  transform: translateX(-50%) translateY(0);\r\n  margin-bottom: 12px;\r\n  width: 240px;\r\n  padding: 16px;\r\n  background: var(--ie-panel-bg);\r\n  border: 1px solid var(--ie-toolbar-border);\r\n  border-radius: 12px;\r\n  box-shadow: 0 8px 32px var(--ie-shadow), 0 0 0 1px rgba(255,255,255,0.05) inset;\r\n  z-index: 100;\r\n  opacity: 1;\r\n  transition: opacity 0.2s ease, transform 0.2s ease;\r\n}\r\n\r\n.ie-panel.ie-panel-hidden {\r\n  opacity: 0;\r\n  transform: translateX(-50%) translateY(8px);\r\n  pointer-events: none;\r\n}\r\n\r\n.ie-panel::before {\r\n  content: '';\r\n  position: absolute;\r\n  bottom: -6px;\r\n  left: 50%;\r\n  transform: translateX(-50%) rotate(45deg);\r\n  width: 12px;\r\n  height: 12px;\r\n  background: var(--ie-panel-bg);\r\n  border-right: 1px solid var(--ie-toolbar-border);\r\n  border-bottom: 1px solid var(--ie-toolbar-border);\r\n}\r\n\r\n.ie-panel-title {\r\n  font-size: 13px;\r\n  font-weight: 600;\r\n  color: var(--ie-text-color);\r\n  margin-bottom: 14px;\r\n  padding-bottom: 10px;\r\n  border-bottom: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-panel-row {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  margin-bottom: 12px;\r\n}\r\n\r\n.ie-panel-row:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.ie-panel-label {\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n.ie-panel-value {\r\n  font-size: 12px;\r\n  font-variant-numeric: tabular-nums;\r\n  color: var(--ie-text-muted);\r\n  min-width: 36px;\r\n  text-align: center;\r\n}\r\n\r\n.ie-size-control {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  background: var(--ie-input-bg);\r\n  padding: 4px 6px;\r\n  border-radius: 8px;\r\n}\r\n\r\n.ie-size-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 28px;\r\n  height: 28px;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color);\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-size-btn:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-size-btn:active {\r\n  transform: scale(0.95);\r\n}\r\n\r\n.ie-size-btn svg {\r\n  width: 14px;\r\n  height: 14px;\r\n}\r\n\r\n.ie-slider {\r\n  flex: 1;\r\n  height: 4px;\r\n  appearance: none;\r\n  background: var(--ie-btn-hover-bg);\r\n  border-radius: 2px;\r\n  outline: none;\r\n}\r\n\r\n.ie-slider::-webkit-slider-thumb {\r\n  appearance: none;\r\n  width: 14px;\r\n  height: 14px;\r\n  background: var(--ie-btn-active-bg);\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n}\r\n\r\n/* Range slider for mosaic panel */\r\n.ie-slider-row {\r\n  flex-wrap: wrap;\r\n  gap: 10px;\r\n}\r\n\r\n.ie-slider-row .ie-panel-label {\r\n  width: 60px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.ie-slider-row .ie-panel-value {\r\n  width: 32px;\r\n  text-align: center;\r\n  background: var(--ie-input-bg);\r\n  padding: 4px 6px;\r\n  border-radius: 4px;\r\n  font-size: 11px;\r\n}\r\n\r\n.ie-range-slider {\r\n  flex: 1;\r\n  min-width: 80px;\r\n  height: 6px;\r\n  appearance: none;\r\n  background: var(--ie-divider);\r\n  border-radius: 3px;\r\n  outline: none;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-range-slider::-webkit-slider-thumb {\r\n  appearance: none;\r\n  width: 16px;\r\n  height: 16px;\r\n  background: var(--ie-btn-active-bg);\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n  transition: transform 0.15s, box-shadow 0.15s;\r\n  box-shadow: 0 2px 6px rgba(0,0,0,0.2);\r\n}\r\n\r\n.ie-range-slider::-webkit-slider-thumb:hover {\r\n  transform: scale(1.15);\r\n  box-shadow: 0 3px 10px rgba(0,0,0,0.3);\r\n}\r\n\r\n.ie-range-slider::-webkit-slider-thumb:active {\r\n  transform: scale(1.05);\r\n}\r\n\r\n.ie-range-slider::-moz-range-thumb {\r\n  width: 16px;\r\n  height: 16px;\r\n  background: var(--ie-btn-active-bg);\r\n  border: none;\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 6px rgba(0,0,0,0.2);\r\n}\r\n\r\n.ie-color-row {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n}\r\n\r\n.ie-color-input {\r\n  width: 36px;\r\n  height: 28px;\r\n  padding: 3px;\r\n  border: 2px solid var(--ie-input-border);\r\n  border-radius: 6px;\r\n  background: var(--ie-input-bg);\r\n  cursor: pointer;\r\n  transition: border-color 0.15s;\r\n}\r\n\r\n.ie-color-input:hover {\r\n  border-color: var(--ie-btn-active-bg);\r\n}\r\n\r\n.ie-color-hex {\r\n  font-size: 11px;\r\n  font-family: 'SF Mono', Monaco, monospace;\r\n  color: var(--ie-text-muted);\r\n  text-transform: uppercase;\r\n}\r\n\r\n/* Text Input */\r\n.ie-text-input-overlay {\r\n  position: absolute;\r\n  inset: 0;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: rgba(0,0,0,0.5);\r\n  z-index: 200;\r\n}\r\n\r\n.ie-text-input-box {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 8px;\r\n  background: var(--ie-panel-bg);\r\n  border-radius: var(--ie-radius);\r\n  box-shadow: 0 4px 20px var(--ie-shadow);\r\n}\r\n\r\n.ie-text-field {\r\n  width: 200px;\r\n  padding: 10px 12px;\r\n  background: var(--ie-input-bg);\r\n  border: 1px solid var(--ie-input-border);\r\n  border-radius: 6px;\r\n  color: var(--ie-text-color);\r\n  font-size: 14px;\r\n  outline: none;\r\n}\r\n\r\n.ie-text-field:focus {\r\n  border-color: var(--ie-btn-active-bg);\r\n}\r\n\r\n.ie-text-confirm {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 38px;\r\n  height: 38px;\r\n  background: var(--ie-btn-active-bg);\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: #fff;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-text-confirm:hover {\r\n  filter: brightness(0.9);\r\n}\r\n\r\n.ie-text-confirm svg {\r\n  width: 18px;\r\n  height: 18px;\r\n}\r\n\r\n/* Zoom badge */\r\n.ie-zoom-badge {\r\n  position: absolute;\r\n  top: 8px;\r\n  right: 8px;\r\n  padding: 4px 8px;\r\n  background: rgba(0,0,0,0.6);\r\n  border-radius: 4px;\r\n  font-size: 11px;\r\n  color: #fff;\r\n  font-variant-numeric: tabular-nums;\r\n  pointer-events: none;\r\n  transition: opacity 0.3s ease;\r\n}\r\n\r\n.ie-zoom-badge.ie-zoom-badge-hidden {\r\n  opacity: 0;\r\n}\r\n\r\n/* Custom brush cursor */\r\n.ie-brush-cursor {\r\n  position: absolute;\r\n  pointer-events: none;\r\n  border: 2px solid var(--ie-btn-active-bg);\r\n  border-radius: 50%;\r\n  background: color-mix(in srgb, var(--ie-btn-active-bg) 15%, transparent);\r\n  transform: translate(-50%, -50%);\r\n  z-index: 100;\r\n  transition: width 0.1s, height 0.1s;\r\n}\r\n\r\n.ie-canvas-container.tool-brush {\r\n  cursor: none;\r\n}\r\n\r\n.ie-canvas-container.tool-draw {\r\n  cursor: crosshair;\r\n}\r\n\r\n/* Inline text editing */\r\n.ie-inline-text-container {\r\n  position: absolute;\r\n  z-index: 200;\r\n  transform: translate(-2px, -50%);\r\n}\r\n\r\n.ie-inline-text-input {\r\n  min-width: 20px;\r\n  max-width: 400px;\r\n  padding: 4px 8px;\r\n  background: var(--ie-panel-bg);\r\n  border: 2px solid var(--ie-btn-active-bg);\r\n  border-radius: 4px;\r\n  outline: none;\r\n  white-space: pre-wrap;\r\n  word-break: break-word;\r\n  line-height: 1.3;\r\n  cursor: text;\r\n}\r\n\r\n.ie-inline-text-input:empty:before {\r\n  content: attr(data-placeholder);\r\n  color: var(--ie-text-muted);\r\n  pointer-events: none;\r\n}\r\n\r\n/* Text style floating bar */\r\n.ie-text-style-bar {\r\n  position: absolute;\r\n  z-index: 201;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n  padding: 6px 8px;\r\n  background: var(--ie-toolbar-bg);\r\n  border: 1px solid var(--ie-toolbar-border);\r\n  border-radius: 6px;\r\n  box-shadow: 0 4px 12px var(--ie-shadow);\r\n}\r\n\r\n.ie-style-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 28px;\r\n  height: 28px;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-style-btn:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-style-btn svg {\r\n  width: 16px;\r\n  height: 16px;\r\n}\r\n\r\n.ie-style-confirm {\r\n  background: #667eea;\r\n  color: #fff;\r\n}\r\n\r\n.ie-style-confirm:hover {\r\n  background: #5a6fd6;\r\n}\r\n\r\n.ie-style-value {\r\n  min-width: 28px;\r\n  text-align: center;\r\n  font-size: 12px;\r\n  color: var(--ie-btn-color);\r\n  font-variant-numeric: tabular-nums;\r\n}\r\n\r\n.ie-style-color {\r\n  width: 28px;\r\n  height: 28px;\r\n  padding: 2px;\r\n  border: none;\r\n  border-radius: 4px;\r\n  background: transparent;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-style-divider {\r\n  width: 1px;\r\n  height: 20px;\r\n  background: var(--ie-divider);\r\n  margin: 0 4px;\r\n}\r\n\r\n.ie-panel-text-hint {\r\n  width: auto;\r\n  min-width: 120px;\r\n}\r\n\r\n/* ========== Crop Tool ========== */\r\n.ie-crop-overlay {\r\n  position: absolute;\r\n  inset: 0;\r\n  z-index: 500;\r\n  background: transparent;\r\n}\r\n\r\n.ie-crop-mask {\r\n  position: absolute;\r\n  background: rgba(0, 0, 0, 0.6);\r\n  pointer-events: none;\r\n}\r\n\r\n.ie-crop-box {\r\n  position: absolute;\r\n  border: 2px solid #fff;\r\n  box-shadow: 0 0 0 1px rgba(0,0,0,0.3), 0 0 10px rgba(0,0,0,0.3);\r\n  cursor: move;\r\n}\r\n\r\n.ie-crop-grid {\r\n  position: absolute;\r\n  inset: 0;\r\n  pointer-events: none;\r\n}\r\n\r\n.ie-crop-grid-h,\r\n.ie-crop-grid-v {\r\n  position: absolute;\r\n  background: rgba(255,255,255,0.3);\r\n}\r\n\r\n.ie-crop-grid-h {\r\n  left: 0;\r\n  right: 0;\r\n  height: 1px;\r\n}\r\n\r\n.ie-crop-grid-h:nth-child(1) { top: 33.33%; }\r\n.ie-crop-grid-h:nth-child(2) { top: 66.66%; }\r\n\r\n.ie-crop-grid-v {\r\n  top: 0;\r\n  bottom: 0;\r\n  width: 1px;\r\n}\r\n\r\n.ie-crop-grid-v:nth-child(3) { left: 33.33%; }\r\n.ie-crop-grid-v:nth-child(4) { left: 66.66%; }\r\n\r\n.ie-crop-handle {\r\n  position: absolute;\r\n  width: 12px;\r\n  height: 12px;\r\n  background: #fff;\r\n  border: 1px solid rgba(0,0,0,0.3);\r\n  border-radius: 2px;\r\n}\r\n\r\n.ie-crop-handle-nw { top: -6px; left: -6px; cursor: nw-resize; }\r\n.ie-crop-handle-n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }\r\n.ie-crop-handle-ne { top: -6px; right: -6px; cursor: ne-resize; }\r\n.ie-crop-handle-e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }\r\n.ie-crop-handle-se { bottom: -6px; right: -6px; cursor: se-resize; }\r\n.ie-crop-handle-s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }\r\n.ie-crop-handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }\r\n.ie-crop-handle-w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }\r\n\r\n.ie-crop-panel {\r\n  position: absolute;\r\n  bottom: 20px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 16px;\r\n  padding: 12px 16px;\r\n  background: var(--ie-toolbar-bg);\r\n  border-radius: var(--ie-radius);\r\n  box-shadow: 0 4px 20px var(--ie-shadow);\r\n}\r\n\r\n.ie-crop-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.ie-crop-label {\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted);\r\n  margin-right: 4px;\r\n}\r\n\r\n.ie-crop-buttons {\r\n  display: flex;\r\n  gap: 4px;\r\n}\r\n\r\n.ie-crop-btn {\r\n  padding: 6px 12px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-crop-btn:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-crop-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n.ie-crop-btn-icon {\r\n  width: 32px;\r\n  padding: 6px;\r\n}\r\n\r\n.ie-crop-btn-icon svg {\r\n  width: 18px;\r\n  height: 18px;\r\n}\r\n\r\n.ie-crop-btn-cancel {\r\n  background: transparent;\r\n  border: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-crop-btn-apply {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n\r\n.ie-crop-btn-apply svg {\r\n  width: 14px;\r\n  height: 14px;\r\n}\r\n\r\n.ie-crop-actions {\r\n  position: absolute;\r\n  bottom: -50px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: flex;\r\n  gap: 8px;\r\n  padding: 8px 12px;\r\n  background: var(--ie-toolbar-bg);\r\n  border-radius: var(--ie-radius);\r\n  box-shadow: 0 4px 12px var(--ie-shadow);\r\n}\r\n\r\n/* Crop toolbar buttons */\r\n.ie-crop-action-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n\r\n.ie-crop-toolbar-btn {\r\n  width: auto !important;\r\n  padding: 0 12px !important;\r\n  gap: 4px;\r\n  font-size: 13px;\r\n}\r\n\r\n.ie-crop-toolbar-btn span {\r\n  font-weight: 500;\r\n}\r\n\r\n.ie-crop-toolbar-cancel {\r\n  background: transparent;\r\n  border: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-crop-toolbar-cancel:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n}\r\n\r\n.ie-crop-toolbar-confirm {\r\n  background: #10b981 !important;\r\n  color: #fff !important;\r\n}\r\n\r\n.ie-crop-toolbar-confirm:hover {\r\n  filter: brightness(0.9);\r\n}\r\n\r\n/* ========== Filter Panel ========== */\r\n.ie-filter-panel {\r\n  width: 280px;\r\n}\r\n\r\n.ie-filter-slider-row {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n.ie-filter-slider-row:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.ie-filter-slider-label {\r\n  width: 50px;\r\n  font-size: 11px;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n.ie-filter-slider-value {\r\n  width: 36px;\r\n  font-size: 11px;\r\n  text-align: right;\r\n  color: var(--ie-text-muted);\r\n  font-variant-numeric: tabular-nums;\r\n}\r\n\r\n.ie-filter-presets {\r\n  display: flex;\r\n  gap: 6px;\r\n  margin-top: 12px;\r\n  padding-top: 12px;\r\n  border-top: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-filter-preset {\r\n  flex: 1;\r\n  padding: 6px 4px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 10px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-filter-preset:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-filter-preset.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n.ie-filter-actions {\r\n  display: flex;\r\n  gap: 8px;\r\n  margin-top: 12px;\r\n}\r\n\r\n.ie-filter-actions button {\r\n  flex: 1;\r\n  padding: 8px;\r\n  border: none;\r\n  border-radius: 4px;\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-filter-reset {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-color);\r\n}\r\n\r\n.ie-filter-apply {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n/* ========== Context Menu ========== */\r\n.ie-context-menu {\r\n  position: fixed;\r\n  min-width: 160px;\r\n  padding: 6px 0;\r\n  background: var(--ie-panel-bg, #2d2d2d);\r\n  border: 1px solid var(--ie-toolbar-border, rgba(255,255,255,0.1));\r\n  border-radius: 6px;\r\n  box-shadow: 0 4px 20px rgba(0,0,0,0.3);\r\n  z-index: 10000;\r\n}\r\n\r\n.ie-context-menu-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n  padding: 8px 12px;\r\n  color: var(--ie-text-color, #fff);\r\n  font-size: 13px;\r\n  cursor: pointer;\r\n  transition: background 0.1s;\r\n}\r\n\r\n.ie-context-menu-item:hover:not(.disabled) {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-context-menu-item.disabled {\r\n  opacity: 0.5;\r\n  cursor: not-allowed;\r\n}\r\n\r\n.ie-context-menu-icon {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 18px;\r\n  height: 18px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-context-menu-icon svg {\r\n  width: 16px;\r\n  height: 16px;\r\n}\r\n\r\n.ie-context-menu-label {\r\n  flex: 1;\r\n}\r\n\r\n.ie-context-menu-shortcut {\r\n  font-size: 11px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-context-menu-divider {\r\n  height: 1px;\r\n  margin: 6px 12px;\r\n  background: var(--ie-divider, rgba(255,255,255,0.1));\r\n}\r\n\r\n/* ========== Export Dialog ========== */\r\n.ie-export-overlay {\r\n  position: fixed;\r\n  inset: 0;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: rgba(0,0,0,0.6);\r\n  z-index: 10000;\r\n}\r\n\r\n.ie-export-dialog {\r\n  width: 420px;\r\n  max-width: 90vw;\r\n  max-height: 90vh;\r\n  overflow: auto;\r\n  background: var(--ie-panel-bg, #2d2d2d);\r\n  border-radius: 12px;\r\n  box-shadow: 0 8px 32px rgba(0,0,0,0.4);\r\n}\r\n\r\n.ie-export-header {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  padding: 16px 20px;\r\n  border-bottom: 1px solid var(--ie-divider, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-export-title {\r\n  font-size: 16px;\r\n  font-weight: 500;\r\n  color: var(--ie-text-color, #fff);\r\n}\r\n\r\n.ie-export-close {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 32px;\r\n  height: 32px;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-export-close:hover {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-export-close svg {\r\n  width: 18px;\r\n  height: 18px;\r\n}\r\n\r\n.ie-export-body {\r\n  padding: 20px;\r\n}\r\n\r\n.ie-export-section {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.ie-export-section:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.ie-export-label {\r\n  display: block;\r\n  margin-bottom: 8px;\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-export-format-buttons {\r\n  display: flex;\r\n  gap: 8px;\r\n}\r\n\r\n.ie-export-format-btn {\r\n  flex: 1;\r\n  padding: 10px;\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n  border: 2px solid transparent;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n  font-size: 13px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-export-format-btn:hover {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.15));\r\n}\r\n\r\n.ie-export-format-btn.active {\r\n  border-color: var(--ie-btn-active-bg, #667eea);\r\n  color: var(--ie-btn-active-bg, #667eea);\r\n}\r\n\r\n.ie-export-size-inputs {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.ie-export-input {\r\n  flex: 1;\r\n  padding: 10px 12px;\r\n  background: var(--ie-input-bg, #222);\r\n  border: 1px solid var(--ie-input-border, #444);\r\n  border-radius: 6px;\r\n  color: var(--ie-text-color, #fff);\r\n  font-size: 14px;\r\n}\r\n\r\n.ie-export-input:focus {\r\n  outline: none;\r\n  border-color: var(--ie-btn-active-bg, #667eea);\r\n}\r\n\r\n.ie-export-link-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  background: transparent;\r\n  border: 1px solid var(--ie-input-border, #444);\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-export-link-btn.active {\r\n  background: var(--ie-btn-active-bg, #667eea);\r\n  border-color: var(--ie-btn-active-bg, #667eea);\r\n  color: #fff;\r\n}\r\n\r\n.ie-export-quality {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n}\r\n\r\n.ie-export-quality-slider {\r\n  flex: 1;\r\n}\r\n\r\n.ie-export-quality-value {\r\n  min-width: 40px;\r\n  text-align: right;\r\n  font-size: 13px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-export-preview {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  height: 120px;\r\n  background: var(--ie-input-bg, #222);\r\n  border-radius: 6px;\r\n  overflow: hidden;\r\n}\r\n\r\n.ie-export-preview img {\r\n  max-width: 100%;\r\n  max-height: 100%;\r\n  object-fit: contain;\r\n}\r\n\r\n.ie-export-footer {\r\n  display: flex;\r\n  gap: 12px;\r\n  padding: 16px 20px;\r\n  border-top: 1px solid var(--ie-divider, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-export-footer button {\r\n  flex: 1;\r\n  padding: 12px;\r\n  border: none;\r\n  border-radius: 6px;\r\n  font-size: 14px;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-export-cancel {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n}\r\n\r\n.ie-export-download {\r\n  background: var(--ie-btn-active-bg, #667eea);\r\n  color: #fff;\r\n}\r\n\r\n/* ========== Eraser Tool ========== */\r\n.ie-panel-eraser {\r\n  width: 200px;\r\n}\r\n\r\n.ie-eraser-mode {\r\n  display: flex;\r\n  gap: 6px;\r\n  margin-top: 8px;\r\n}\r\n\r\n.ie-eraser-mode-btn {\r\n  flex: 1;\r\n  padding: 8px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 11px;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-eraser-mode-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n/* ========== Tooltip ========== */\r\n.ie-tooltip {\r\n  position: absolute;\r\n  bottom: calc(100% + 8px);\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  padding: 10px 14px;\r\n  background: var(--ie-panel-bg);\r\n  border: 1px solid var(--ie-toolbar-border);\r\n  border-radius: 8px;\r\n  box-shadow: 0 4px 16px var(--ie-shadow);\r\n  white-space: nowrap;\r\n  z-index: 9999;\r\n  opacity: 0;\r\n  visibility: hidden;\r\n  pointer-events: none;\r\n  transition: opacity 0.2s 0.3s, visibility 0.2s 0.3s;\r\n}\r\n\r\n.ie-tooltip::after {\r\n  content: '';\r\n  position: absolute;\r\n  top: 100%;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  border: 6px solid transparent;\r\n  border-top-color: var(--ie-panel-bg);\r\n}\r\n\r\n.ie-btn:hover .ie-tooltip {\r\n  opacity: 1;\r\n  visibility: visible;\r\n  transition-delay: 0.3s;\r\n}\r\n\r\n.ie-tooltip-title {\r\n  font-size: 13px;\r\n  font-weight: 600;\r\n  color: var(--ie-text-color);\r\n  margin-bottom: 2px;\r\n}\r\n\r\n.ie-tooltip-desc {\r\n  font-size: 11px;\r\n  color: var(--ie-text-muted);\r\n  margin-bottom: 4px;\r\n}\r\n\r\n.ie-tooltip-shortcut {\r\n  display: inline-block;\r\n  padding: 2px 6px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border-radius: 4px;\r\n  font-size: 10px;\r\n  font-family: monospace;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n/* Filter panel button styles */\r\n.ie-btn-row {\r\n  display: flex;\r\n  gap: 10px;\r\n  margin-top: 16px;\r\n  padding-top: 14px;\r\n  border-top: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-btn-apply,\r\n.ie-btn-reset {\r\n  flex: 1;\r\n  padding: 10px 14px;\r\n  border: none;\r\n  border-radius: 8px;\r\n  font-size: 13px;\r\n  font-weight: 500;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-btn-apply {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n.ie-btn-apply:hover {\r\n  filter: brightness(1.05);\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.ie-btn-apply:active {\r\n  transform: translateY(0);\r\n}\r\n\r\n.ie-btn-reset {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-color);\r\n}\r\n\r\n.ie-btn-reset:hover {\r\n  background: var(--ie-divider);\r\n}\r\n\r\n/* Mode button group */\r\n.ie-btn-group {\r\n  display: flex;\r\n  gap: 6px;\r\n  background: var(--ie-input-bg);\r\n  padding: 4px;\r\n  border-radius: 8px;\r\n}\r\n\r\n.ie-mode-btn {\r\n  padding: 8px 14px;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-mode-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n  box-shadow: 0 2px 6px rgba(0,0,0,0.15);\r\n}\r\n\r\n.ie-mode-btn:hover:not(.active) {\r\n  background: var(--ie-btn-hover-bg);\r\n}\r\n\r\n/* Filter panel specific */\r\n.ie-panel-filter {\r\n  width: 300px;\r\n}\r\n\r\n/* Filter presets grid */\r\n.ie-filter-presets {\r\n  display: grid;\r\n  grid-template-columns: repeat(4, 1fr);\r\n  gap: 8px;\r\n  margin-bottom: 16px;\r\n  padding-bottom: 16px;\r\n  border-bottom: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-filter-preset {\r\n  padding: 10px 6px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: 2px solid transparent;\r\n  border-radius: 8px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 11px;\r\n  font-weight: 500;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n  text-align: center;\r\n}\r\n\r\n.ie-filter-preset:hover {\r\n  background: var(--ie-divider);\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.ie-filter-preset.active {\r\n  border-color: var(--ie-btn-active-bg);\r\n  background: rgba(102, 126, 234, 0.15);\r\n  color: var(--ie-btn-active-bg);\r\n}\r\n\r\n/* Font select in text style bar */\r\n.ie-style-select {\r\n  padding: 4px 8px;\r\n  background: var(--ie-input-bg);\r\n  border: 1px solid var(--ie-input-border);\r\n  border-radius: 4px;\r\n  color: var(--ie-text-color);\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n  outline: none;\r\n}\r\n\r\n.ie-style-select:focus {\r\n  border-color: var(--ie-btn-active-bg);\r\n}\r\n\r\n/* ========== Drop zone indicator ========== */\r\n.ie-drop-zone {\r\n  position: absolute;\r\n  inset: 0;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 12px;\r\n  background: rgba(102, 126, 234, 0.1);\r\n  border: 2px dashed var(--ie-btn-active-bg);\r\n  border-radius: 12px;\r\n  z-index: 1000;\r\n  pointer-events: none;\r\n  opacity: 0;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.ie-drop-zone.active {\r\n  opacity: 1;\r\n}\r\n\r\n.ie-drop-zone-icon {\r\n  width: 48px;\r\n  height: 48px;\r\n  color: var(--ie-btn-active-bg);\r\n  animation: ie-drop-bounce 0.6s ease infinite;\r\n}\r\n\r\n.ie-drop-zone-icon svg {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n\r\n.ie-drop-zone-text {\r\n  font-size: 15px;\r\n  font-weight: 500;\r\n  color: var(--ie-btn-active-bg);\r\n}\r\n\r\n.ie-drop-zone-hint {\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n@keyframes ie-drop-bounce {\r\n  0%, 100% { transform: translateY(0); }\r\n  50% { transform: translateY(-6px); }\r\n}\r\n\r\n/* ========== Touch improvements ========== */\r\n@media (pointer: coarse) {\r\n  .ie-btn {\r\n    width: 44px;\r\n    height: 44px;\r\n  }\r\n  \r\n  .ie-tooltip {\r\n    display: none;\r\n  }\r\n  \r\n  .ie-crop-handle {\r\n    width: 20px;\r\n    height: 20px;\r\n  }\r\n  \r\n  .ie-crop-handle-nw { top: -10px; left: -10px; }\r\n  .ie-crop-handle-n { top: -10px; margin-left: -10px; }\r\n  .ie-crop-handle-ne { top: -10px; right: -10px; }\r\n  .ie-crop-handle-e { margin-top: -10px; right: -10px; }\r\n  .ie-crop-handle-se { bottom: -10px; right: -10px; }\r\n  .ie-crop-handle-s { bottom: -10px; margin-left: -10px; }\r\n  .ie-crop-handle-sw { bottom: -10px; left: -10px; }\r\n  .ie-crop-handle-w { margin-top: -10px; left: -10px; }\r\n}\r\n`;\r\n\r\nexport function injectStyles(): void {\r\n  if (typeof document === 'undefined') return;\r\n  \r\n  const styleId = 'ie-toolbar-styles';\r\n  if (document.getElementById(styleId)) return;\r\n  \r\n  const style = document.createElement('style');\r\n  style.id = styleId;\r\n  style.textContent = toolbarStyles;\r\n  document.head.appendChild(style);\r\n}\r\n","/**\r\n * ShapeLayer - Manages drawable shapes as layers\r\n */\r\n\r\nexport type ShapeType = 'pen' | 'rect' | 'circle' | 'arrow' | 'text' | 'line' | 'triangle';\r\n\r\nexport interface Point {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nexport interface ShapeStyle {\r\n  strokeColor: string;\r\n  strokeWidth: number;\r\n  fillColor?: string;\r\n  strokeDash?: number[];  // For dashed lines\r\n  fillMode?: 'none' | 'fill' | 'stroke' | 'both';  // Fill mode\r\n}\r\n\r\nexport interface BaseShape {\r\n  id: string;\r\n  type: ShapeType;\r\n  style: ShapeStyle;\r\n  selected: boolean;\r\n}\r\n\r\nexport interface PenShape extends BaseShape {\r\n  type: 'pen';\r\n  points: Point[];\r\n}\r\n\r\nexport interface RectShape extends BaseShape {\r\n  type: 'rect';\r\n  x: number;\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface CircleShape extends BaseShape {\r\n  type: 'circle';\r\n  cx: number;\r\n  cy: number;\r\n  rx: number;\r\n  ry: number;\r\n}\r\n\r\nexport interface ArrowShape extends BaseShape {\r\n  type: 'arrow';\r\n  start: Point;\r\n  end: Point;\r\n}\r\n\r\nexport interface TextShape extends BaseShape {\r\n  type: 'text';\r\n  text: string;\r\n  x: number;\r\n  y: number;\r\n  fontSize: number;\r\n  color: string;\r\n  fontFamily?: string;\r\n  fontWeight?: 'normal' | 'bold';\r\n  fontStyle?: 'normal' | 'italic';\r\n  textDecoration?: 'none' | 'underline';\r\n  strokeEnabled?: boolean;\r\n  strokeColor?: string;\r\n  strokeWidth?: number;\r\n}\r\n\r\nexport interface LineShape extends BaseShape {\r\n  type: 'line';\r\n  start: Point;\r\n  end: Point;\r\n}\r\n\r\nexport interface TriangleShape extends BaseShape {\r\n  type: 'triangle';\r\n  points: [Point, Point, Point];\r\n}\r\n\r\nexport type Shape = PenShape | RectShape | CircleShape | ArrowShape | TextShape | LineShape | TriangleShape;\r\n\r\nlet shapeIdCounter = 0;\r\nfunction generateId(): string {\r\n  return `shape_${Date.now()}_${++shapeIdCounter}`;\r\n}\r\n\r\nexport class ShapeLayerManager {\r\n  private shapes: Shape[] = [];\r\n  private selectedShapeId: string | null = null;\r\n  private onChange: (() => void) | null = null;\r\n\r\n  /** Create a new shape */\r\n  createShape(type: ShapeType, style: ShapeStyle): string {\r\n    const id = generateId();\r\n    const baseShape = { id, type, style, selected: false };\r\n    \r\n    switch (type) {\r\n      case 'pen':\r\n        this.shapes.push({ ...baseShape, type: 'pen', points: [] } as PenShape);\r\n        break;\r\n      case 'rect':\r\n        this.shapes.push({ ...baseShape, type: 'rect', x: 0, y: 0, width: 0, height: 0 } as RectShape);\r\n        break;\r\n      case 'circle':\r\n        this.shapes.push({ ...baseShape, type: 'circle', cx: 0, cy: 0, rx: 0, ry: 0 } as CircleShape);\r\n        break;\r\n      case 'arrow':\r\n        this.shapes.push({ ...baseShape, type: 'arrow', start: { x: 0, y: 0 }, end: { x: 0, y: 0 } } as ArrowShape);\r\n        break;\r\n      case 'text':\r\n        this.shapes.push({ ...baseShape, type: 'text', text: '', x: 0, y: 0, fontSize: 24, color: style.strokeColor } as TextShape);\r\n        break;\r\n      case 'line':\r\n        this.shapes.push({ ...baseShape, type: 'line', start: { x: 0, y: 0 }, end: { x: 0, y: 0 } } as LineShape);\r\n        break;\r\n      case 'triangle':\r\n        this.shapes.push({ ...baseShape, type: 'triangle', points: [{ x: 0, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 0 }] } as TriangleShape);\r\n        break;\r\n    }\r\n    \r\n    return id;\r\n  }\r\n\r\n  /** Get shape by ID */\r\n  getShape(id: string): Shape | undefined {\r\n    return this.shapes.find(s => s.id === id);\r\n  }\r\n\r\n  /** Update shape data */\r\n  updateShape(id: string, updates: Partial<Shape>): void {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (shape) {\r\n      Object.assign(shape, updates);\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Delete shape */\r\n  deleteShape(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index !== -1) {\r\n      this.shapes.splice(index, 1);\r\n      if (this.selectedShapeId === id) {\r\n        this.selectedShapeId = null;\r\n      }\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Select shape */\r\n  selectShape(id: string | null): void {\r\n    // Deselect previous\r\n    if (this.selectedShapeId) {\r\n      const prev = this.shapes.find(s => s.id === this.selectedShapeId);\r\n      if (prev) prev.selected = false;\r\n    }\r\n    \r\n    // Select new\r\n    this.selectedShapeId = id;\r\n    if (id) {\r\n      const shape = this.shapes.find(s => s.id === id);\r\n      if (shape) shape.selected = true;\r\n    }\r\n    \r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Get selected shape */\r\n  getSelectedShape(): Shape | null {\r\n    if (!this.selectedShapeId) return null;\r\n    return this.shapes.find(s => s.id === this.selectedShapeId) || null;\r\n  }\r\n\r\n  /** Find shape at point */\r\n  findShapeAtPoint(x: number, y: number, tolerance: number = 5): Shape | null {\r\n    // Check from top to bottom (last drawn = top)\r\n    for (let i = this.shapes.length - 1; i >= 0; i--) {\r\n      const shape = this.shapes[i];\r\n      if (this.isPointInShape(shape, x, y, tolerance)) {\r\n        return shape;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /** Check if point is inside shape */\r\n  private isPointInShape(shape: Shape, x: number, y: number, tolerance: number): boolean {\r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        return x >= s.x - tolerance && x <= s.x + s.width + tolerance &&\r\n               y >= s.y - tolerance && y <= s.y + s.height + tolerance;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        const dx = (x - s.cx) / (s.rx + tolerance);\r\n        const dy = (y - s.cy) / (s.ry + tolerance);\r\n        return dx * dx + dy * dy <= 1;\r\n      }\r\n      case 'arrow':\r\n      case 'line': {\r\n        const s = shape as ArrowShape | LineShape;\r\n        // Check distance to line segment\r\n        const dist = this.pointToLineDistance(x, y, s.start.x, s.start.y, s.end.x, s.end.y);\r\n        return dist <= tolerance + s.style.strokeWidth;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        // Check if point is near any edge\r\n        for (let i = 0; i < 3; i++) {\r\n          const p1 = s.points[i];\r\n          const p2 = s.points[(i + 1) % 3];\r\n          const dist = this.pointToLineDistance(x, y, p1.x, p1.y, p2.x, p2.y);\r\n          if (dist <= tolerance + s.style.strokeWidth) return true;\r\n        }\r\n        return false;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        // Check distance to any segment\r\n        for (let i = 1; i < s.points.length; i++) {\r\n          const dist = this.pointToLineDistance(x, y, s.points[i-1].x, s.points[i-1].y, s.points[i].x, s.points[i].y);\r\n          if (dist <= tolerance + s.style.strokeWidth) return true;\r\n        }\r\n        return false;\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        // Approximate text bounds\r\n        const width = s.text.length * s.fontSize * 0.6;\r\n        const height = s.fontSize * 1.2;\r\n        return x >= s.x - tolerance && x <= s.x + width + tolerance &&\r\n               y >= s.y - height - tolerance && y <= s.y + tolerance;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /** Calculate distance from point to line segment */\r\n  private pointToLineDistance(px: number, py: number, x1: number, y1: number, x2: number, y2: number): number {\r\n    const dx = x2 - x1;\r\n    const dy = y2 - y1;\r\n    const len2 = dx * dx + dy * dy;\r\n    \r\n    if (len2 === 0) {\r\n      return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);\r\n    }\r\n    \r\n    let t = ((px - x1) * dx + (py - y1) * dy) / len2;\r\n    t = Math.max(0, Math.min(1, t));\r\n    \r\n    const nearX = x1 + t * dx;\r\n    const nearY = y1 + t * dy;\r\n    \r\n    return Math.sqrt((px - nearX) ** 2 + (py - nearY) ** 2);\r\n  }\r\n\r\n  /** Move shape by delta */\r\n  moveShape(id: string, dx: number, dy: number): void {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (!shape) return;\r\n    \r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        s.x += dx;\r\n        s.y += dy;\r\n        break;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        s.cx += dx;\r\n        s.cy += dy;\r\n        break;\r\n      }\r\n      case 'arrow': {\r\n        const s = shape as ArrowShape;\r\n        s.start.x += dx;\r\n        s.start.y += dy;\r\n        s.end.x += dx;\r\n        s.end.y += dy;\r\n        break;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        s.points.forEach(p => {\r\n          p.x += dx;\r\n          p.y += dy;\r\n        });\r\n        break;\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        s.x += dx;\r\n        s.y += dy;\r\n        break;\r\n      }\r\n      case 'line': {\r\n        const s = shape as LineShape;\r\n        s.start.x += dx;\r\n        s.start.y += dy;\r\n        s.end.x += dx;\r\n        s.end.y += dy;\r\n        break;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        s.points.forEach(p => {\r\n          p.x += dx;\r\n          p.y += dy;\r\n        });\r\n        break;\r\n      }\r\n    }\r\n    \r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Get all shapes */\r\n  getShapes(): Shape[] {\r\n    return [...this.shapes];\r\n  }\r\n\r\n  /** Clear all shapes */\r\n  clear(): void {\r\n    this.shapes = [];\r\n    this.selectedShapeId = null;\r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Set change callback */\r\n  setOnChange(callback: () => void): void {\r\n    this.onChange = callback;\r\n  }\r\n\r\n  // ========== Layer Management ==========\r\n  \r\n  /** Bring shape to front */\r\n  bringToFront(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index !== -1 && index < this.shapes.length - 1) {\r\n      const [shape] = this.shapes.splice(index, 1);\r\n      this.shapes.push(shape);\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Send shape to back */\r\n  sendToBack(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index > 0) {\r\n      const [shape] = this.shapes.splice(index, 1);\r\n      this.shapes.unshift(shape);\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Bring shape forward one level */\r\n  bringForward(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index !== -1 && index < this.shapes.length - 1) {\r\n      [this.shapes[index], this.shapes[index + 1]] = [this.shapes[index + 1], this.shapes[index]];\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Send shape backward one level */\r\n  sendBackward(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index > 0) {\r\n      [this.shapes[index - 1], this.shapes[index]] = [this.shapes[index], this.shapes[index - 1]];\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Duplicate a shape */\r\n  duplicateShape(id: string, offset: { x: number; y: number } = { x: 20, y: 20 }): string | null {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (!shape) return null;\r\n    \r\n    const newId = generateId();\r\n    const clonedShape = JSON.parse(JSON.stringify(shape));\r\n    clonedShape.id = newId;\r\n    clonedShape.selected = false;\r\n    \r\n    // Offset the clone\r\n    this.offsetShape(clonedShape, offset.x, offset.y);\r\n    \r\n    this.shapes.push(clonedShape);\r\n    this.notifyChange();\r\n    return newId;\r\n  }\r\n  \r\n  /** Offset shape position */\r\n  private offsetShape(shape: Shape, dx: number, dy: number): void {\r\n    switch (shape.type) {\r\n      case 'rect':\r\n        (shape as RectShape).x += dx;\r\n        (shape as RectShape).y += dy;\r\n        break;\r\n      case 'circle':\r\n        (shape as CircleShape).cx += dx;\r\n        (shape as CircleShape).cy += dy;\r\n        break;\r\n      case 'arrow':\r\n      case 'line':\r\n        (shape as ArrowShape).start.x += dx;\r\n        (shape as ArrowShape).start.y += dy;\r\n        (shape as ArrowShape).end.x += dx;\r\n        (shape as ArrowShape).end.y += dy;\r\n        break;\r\n      case 'pen':\r\n        (shape as PenShape).points.forEach(p => { p.x += dx; p.y += dy; });\r\n        break;\r\n      case 'text':\r\n        (shape as TextShape).x += dx;\r\n        (shape as TextShape).y += dy;\r\n        break;\r\n      case 'triangle':\r\n        (shape as TriangleShape).points.forEach(p => { p.x += dx; p.y += dy; });\r\n        break;\r\n    }\r\n  }\r\n\r\n  /** Get shape z-index (position in array) */\r\n  getShapeZIndex(id: string): number {\r\n    return this.shapes.findIndex(s => s.id === id);\r\n  }\r\n\r\n  /** Get shape count */\r\n  getShapeCount(): number {\r\n    return this.shapes.length;\r\n  }\r\n\r\n  private notifyChange(): void {\r\n    this.onChange?.();\r\n  }\r\n\r\n  /** Render all shapes to canvas context */\r\n  render(ctx: CanvasRenderingContext2D): void {\r\n    for (const shape of this.shapes) {\r\n      this.renderShape(ctx, shape);\r\n    }\r\n  }\r\n\r\n  /** Render single shape */\r\n  private renderShape(ctx: CanvasRenderingContext2D, shape: Shape): void {\r\n    ctx.save();\r\n    ctx.strokeStyle = shape.style.strokeColor;\r\n    ctx.lineWidth = shape.style.strokeWidth;\r\n    ctx.lineCap = 'round';\r\n    ctx.lineJoin = 'round';\r\n    \r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        ctx.beginPath();\r\n        ctx.rect(s.x, s.y, s.width, s.height);\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        ctx.beginPath();\r\n        ctx.ellipse(s.cx, s.cy, s.rx, s.ry, 0, 0, Math.PI * 2);\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'arrow': {\r\n        const s = shape as ArrowShape;\r\n        // Draw line\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.start.x, s.start.y);\r\n        ctx.lineTo(s.end.x, s.end.y);\r\n        ctx.stroke();\r\n        // Draw arrowhead\r\n        const headLen = Math.max(10, s.style.strokeWidth * 4);\r\n        const angle = Math.atan2(s.end.y - s.start.y, s.end.x - s.start.x);\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.end.x, s.end.y);\r\n        ctx.lineTo(s.end.x - headLen * Math.cos(angle - Math.PI / 6), s.end.y - headLen * Math.sin(angle - Math.PI / 6));\r\n        ctx.moveTo(s.end.x, s.end.y);\r\n        ctx.lineTo(s.end.x - headLen * Math.cos(angle + Math.PI / 6), s.end.y - headLen * Math.sin(angle + Math.PI / 6));\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        if (s.points.length < 2) break;\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.points[0].x, s.points[0].y);\r\n        for (let i = 1; i < s.points.length; i++) {\r\n          ctx.lineTo(s.points[i].x, s.points[i].y);\r\n        }\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        ctx.font = `${s.fontSize}px sans-serif`;\r\n        ctx.fillStyle = s.color;\r\n        ctx.fillText(s.text, s.x, s.y);\r\n        break;\r\n      }\r\n      case 'line': {\r\n        const s = shape as LineShape;\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.start.x, s.start.y);\r\n        ctx.lineTo(s.end.x, s.end.y);\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.points[0].x, s.points[0].y);\r\n        ctx.lineTo(s.points[1].x, s.points[1].y);\r\n        ctx.lineTo(s.points[2].x, s.points[2].y);\r\n        ctx.closePath();\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n    }\r\n    \r\n    // Draw selection indicator\r\n    if (shape.selected) {\r\n      this.renderSelectionBox(ctx, shape);\r\n    }\r\n    \r\n    ctx.restore();\r\n  }\r\n\r\n  /** Render selection box around shape */\r\n  private renderSelectionBox(ctx: CanvasRenderingContext2D, shape: Shape): void {\r\n    const bounds = this.getShapeBounds(shape);\r\n    if (!bounds) return;\r\n    \r\n    const padding = 4;\r\n    ctx.strokeStyle = '#667eea';\r\n    ctx.lineWidth = 1;\r\n    ctx.setLineDash([4, 4]);\r\n    ctx.strokeRect(\r\n      bounds.x - padding,\r\n      bounds.y - padding,\r\n      bounds.width + padding * 2,\r\n      bounds.height + padding * 2\r\n    );\r\n    ctx.setLineDash([]);\r\n  }\r\n\r\n  /** Get shape bounding box */\r\n  getShapeBounds(shape: Shape): { x: number; y: number; width: number; height: number } | null {\r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        return { x: s.x, y: s.y, width: s.width, height: s.height };\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        return { x: s.cx - s.rx, y: s.cy - s.ry, width: s.rx * 2, height: s.ry * 2 };\r\n      }\r\n      case 'arrow': {\r\n        const s = shape as ArrowShape;\r\n        const minX = Math.min(s.start.x, s.end.x);\r\n        const minY = Math.min(s.start.y, s.end.y);\r\n        const maxX = Math.max(s.start.x, s.end.x);\r\n        const maxY = Math.max(s.start.y, s.end.y);\r\n        return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        if (s.points.length === 0) return null;\r\n        let minX = s.points[0].x, maxX = s.points[0].x;\r\n        let minY = s.points[0].y, maxY = s.points[0].y;\r\n        for (const p of s.points) {\r\n          minX = Math.min(minX, p.x);\r\n          maxX = Math.max(maxX, p.x);\r\n          minY = Math.min(minY, p.y);\r\n          maxY = Math.max(maxY, p.y);\r\n        }\r\n        return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        const width = s.text.length * s.fontSize * 0.6;\r\n        const height = s.fontSize * 1.2;\r\n        return { x: s.x, y: s.y - height, width, height };\r\n      }\r\n      case 'line': {\r\n        const s = shape as LineShape;\r\n        const minX = Math.min(s.start.x, s.end.x);\r\n        const minY = Math.min(s.start.y, s.end.y);\r\n        const maxX = Math.max(s.start.x, s.end.x);\r\n        const maxY = Math.max(s.start.y, s.end.y);\r\n        return { x: minX, y: minY, width: maxX - minX || 1, height: maxY - minY || 1 };\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        const xs = s.points.map(p => p.x);\r\n        const ys = s.points.map(p => p.y);\r\n        const minX = Math.min(...xs);\r\n        const minY = Math.min(...ys);\r\n        const maxX = Math.max(...xs);\r\n        const maxY = Math.max(...ys);\r\n        return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /** Resize shape by scale factor */\r\n  resizeShape(id: string, scaleX: number, scaleY: number, anchorX: number, anchorY: number): void {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (!shape) return;\r\n    \r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        const newX = anchorX + (s.x - anchorX) * scaleX;\r\n        const newY = anchorY + (s.y - anchorY) * scaleY;\r\n        s.x = newX;\r\n        s.y = newY;\r\n        s.width *= scaleX;\r\n        s.height *= scaleY;\r\n        break;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        s.cx = anchorX + (s.cx - anchorX) * scaleX;\r\n        s.cy = anchorY + (s.cy - anchorY) * scaleY;\r\n        s.rx *= scaleX;\r\n        s.ry *= scaleY;\r\n        break;\r\n      }\r\n      case 'arrow':\r\n      case 'line': {\r\n        const s = shape as ArrowShape | LineShape;\r\n        s.start.x = anchorX + (s.start.x - anchorX) * scaleX;\r\n        s.start.y = anchorY + (s.start.y - anchorY) * scaleY;\r\n        s.end.x = anchorX + (s.end.x - anchorX) * scaleX;\r\n        s.end.y = anchorY + (s.end.y - anchorY) * scaleY;\r\n        break;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        s.points.forEach(p => {\r\n          p.x = anchorX + (p.x - anchorX) * scaleX;\r\n          p.y = anchorY + (p.y - anchorY) * scaleY;\r\n        });\r\n        break;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        s.points.forEach(p => {\r\n          p.x = anchorX + (p.x - anchorX) * scaleX;\r\n          p.y = anchorY + (p.y - anchorY) * scaleY;\r\n        });\r\n        break;\r\n      }\r\n    }\r\n    \r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Get control points for selected shape */\r\n  getControlPoints(shape: Shape): Array<{ x: number; y: number; type: string }> {\r\n    const bounds = this.getShapeBounds(shape);\r\n    if (!bounds) return [];\r\n    \r\n    const { x, y, width, height } = bounds;\r\n    return [\r\n      { x: x, y: y, type: 'nw' },\r\n      { x: x + width / 2, y: y, type: 'n' },\r\n      { x: x + width, y: y, type: 'ne' },\r\n      { x: x + width, y: y + height / 2, type: 'e' },\r\n      { x: x + width, y: y + height, type: 'se' },\r\n      { x: x + width / 2, y: y + height, type: 's' },\r\n      { x: x, y: y + height, type: 'sw' },\r\n      { x: x, y: y + height / 2, type: 'w' },\r\n    ];\r\n  }\r\n}\r\n","/**\r\n * Toolbar - Built-in toolbar UI for the editor\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport { injectStyles } from './toolbar.styles';\r\nimport type { Editor } from '../core/Editor';\r\nimport { ShapeLayerManager, type PenShape, type RectShape, type CircleShape, type ArrowShape, type LineShape, type TriangleShape } from './ShapeLayer';\r\nimport { createPlaceholder } from '../utils/placeholder';\r\n\r\n/** Available tool/button names that can be disabled */\r\nexport type ToolName = \r\n  | 'move' | 'pen' | 'rect' | 'circle' | 'arrow' | 'line' | 'triangle' | 'text' | 'mosaic' | 'eraser' | 'crop' | 'filter'  // Drawing tools\r\n  | 'zoomIn' | 'zoomOut' | 'reset'  // Zoom controls\r\n  | 'undo' | 'redo'  // History controls  \r\n  | 'export';  // Export button\r\n\r\nexport interface ToolbarOptions {\r\n  /** Show zoom controls */\r\n  zoom?: boolean;\r\n  /** Show tool buttons (brush, text) */\r\n  tools?: boolean;\r\n  /** Show history buttons (undo, redo) */\r\n  history?: boolean;\r\n  /** Show export button */\r\n  export?: boolean;\r\n  /** Theme: 'light' | 'dark' | 'auto' */\r\n  theme?: 'light' | 'dark' | 'auto';\r\n  /** Primary color for buttons and accents */\r\n  primaryColor?: string;\r\n  /** List of tools to disable */\r\n  disabledTools?: ToolName[];\r\n  /** Auto hide toolbar when no image is loaded */\r\n  autoHide?: boolean;\r\n  /** Placeholder text */\r\n  placeholderText?: string;\r\n  /** Placeholder sub text */\r\n  placeholderSubText?: string;\r\n  /** Placeholder width */\r\n  placeholderWidth?: number;\r\n  /** Placeholder height */\r\n  placeholderHeight?: number;\r\n  /** Locale for i18n */\r\n  locale?: 'zh-CN' | 'en-US';\r\n  /** Enable keyboard shortcuts */\r\n  enableKeyboardShortcuts?: boolean;\r\n  /** Enable advanced export dialog */\r\n  enableExportDialog?: boolean;\r\n  /** Enable watermark in export */\r\n  enableWatermark?: boolean;\r\n}\r\n\r\nconst defaultOptions: ToolbarOptions & { zoom: boolean; tools: boolean; history: boolean; export: boolean; theme: 'light' | 'dark' | 'auto'; autoHide: boolean } = {\r\n  zoom: true,\r\n  tools: true,\r\n  history: true,\r\n  export: true,\r\n  theme: 'dark',\r\n  autoHide: true,\r\n};\r\n\r\nexport class Toolbar {\r\n  private editor: Editor;\r\n  private options: ToolbarOptions;\r\n  private wrapper: HTMLElement;\r\n  private canvasContainer: HTMLElement;\r\n  private viewport: HTMLElement;\r\n  private toolbar: HTMLElement;\r\n  private zoomBadge: HTMLElement;\r\n  \r\n  // State\r\n  private scale = 1;\r\n  private translateX = 0;\r\n  private translateY = 0;\r\n  private isPanning = false;\r\n  private lastPanPoint = { x: 0, y: 0 };\r\n  private currentTool: string | null = null;\r\n  private activePanel: string | null = null;\r\n  \r\n  // Drawing state\r\n  private isDrawing = false;\r\n  private drawStartPoint = { x: 0, y: 0 };\r\n  private lastDrawPoint = { x: 0, y: 0 };\r\n  private brushCursor: HTMLElement | null = null;\r\n  \r\n  // Settings for all tools\r\n  private strokeWidth = 3;\r\n  private strokeColor = '#ff0000';\r\n  private mosaicSize = 10; // Block size for mosaic\r\n  private textSize = 24;\r\n  private textColor = '#ff0000';\r\n  private textFontFamily = 'sans-serif';\r\n  private textBold = false;\r\n  private textItalic = false;\r\n  private textUnderline = false;\r\n  private eraserSize = 20;\r\n  private eraserMode: 'pixel' | 'shape' = 'pixel';\r\n  \r\n  // Crop tool state\r\n  private isCropActive = false;\r\n  private cropOverlay: HTMLElement | null = null;\r\n  \r\n  // Touch gesture state\r\n  private touchStartDistance = 0;\r\n  private touchStartScale = 1;\r\n  private touchStartCenter = { x: 0, y: 0 };\r\n  private isTouchPanning = false;\r\n  private lastTouchCenter = { x: 0, y: 0 };\r\n  \r\n  // Elements\r\n  private panels: Map<string, HTMLElement> = new Map();\r\n  private buttons: Map<string, HTMLButtonElement> = new Map();\r\n  private groups: Map<string, HTMLElement> = new Map();\r\n  private dividers: HTMLElement[] = [];\r\n  private zoomText: HTMLElement | null = null;\r\n  \r\n  // Inline text editing\r\n  private inlineTextInput: HTMLDivElement | null = null;\r\n  private textStyleBar: HTMLElement | null = null;\r\n  private isAddingText = false;\r\n  \r\n  // Shape layer system\r\n  private shapeManager: ShapeLayerManager;\r\n  \r\n  // Image state\r\n  private hasRealImage = false;\r\n  private currentShapeId: string | null = null;\r\n  private isDraggingShape = false;\r\n  private dragStartPoint = { x: 0, y: 0 };\r\n  private originalImageData: ImageData | null = null;\r\n  private pureImageData: ImageData | null = null;  // Pure original image without any annotations (for eraser)\r\n\r\n  constructor(editor: Editor, container: HTMLElement, options: ToolbarOptions = {}) {\r\n    this.editor = editor;\r\n    this.options = { ...defaultOptions, ...options };\r\n    \r\n    // Initialize shape layer manager\r\n    this.shapeManager = new ShapeLayerManager();\r\n    this.shapeManager.setOnChange(() => this.renderAll());\r\n    \r\n    injectStyles();\r\n    \r\n    // Create wrapper\r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.className = 'ie-editor-wrapper';\r\n    \r\n    // Apply theme and primary color\r\n    this.applyTheme(this.options.theme || 'dark');\r\n    if (this.options.primaryColor) {\r\n      this.applyPrimaryColor(this.options.primaryColor);\r\n    }\r\n    \r\n    // Create canvas container\r\n    this.canvasContainer = document.createElement('div');\r\n    this.canvasContainer.className = 'ie-canvas-container';\r\n    \r\n    // Create viewport\r\n    this.viewport = document.createElement('div');\r\n    this.viewport.className = 'ie-canvas-viewport';\r\n    \r\n    // Move canvas to viewport\r\n    const canvas = editor.canvas;\r\n    if (canvas.parentElement) {\r\n      canvas.parentElement.removeChild(canvas);\r\n    }\r\n    this.viewport.appendChild(canvas);\r\n    this.canvasContainer.appendChild(this.viewport);\r\n    \r\n    // Create zoom badge\r\n    this.zoomBadge = document.createElement('div');\r\n    this.zoomBadge.className = 'ie-zoom-badge';\r\n    this.zoomBadge.textContent = '100%';\r\n    this.canvasContainer.appendChild(this.zoomBadge);\r\n    \r\n    this.wrapper.appendChild(this.canvasContainer);\r\n    \r\n    // Create toolbar\r\n    this.toolbar = this.createToolbar();\r\n    this.wrapper.appendChild(this.toolbar);\r\n    \r\n    // Add to container\r\n    container.appendChild(this.wrapper);\r\n    \r\n    // Setup events\r\n    this.setupEvents();\r\n    this.setupEditorEvents();\r\n    \r\n    // Set initial toolbar visibility\r\n    if (this.options.autoHide) {\r\n      this.setToolbarVisible(false);\r\n    }\r\n  }\r\n\r\n  private createToolbar(): HTMLElement {\r\n    const toolbar = document.createElement('div');\r\n    toolbar.className = 'ie-toolbar';\r\n    toolbar.style.position = 'relative';\r\n    const disabled = this.options.disabledTools || [];\r\n    \r\n    // Zoom controls (always create, respect disabledTools)\r\n    const zoomGroup = this.createGroup();\r\n    zoomGroup.className = 'ie-toolbar-group ie-zoom-group';\r\n    \r\n    const zoomOutBtn = this.createButton('zoomOut', icons.zoomOut, () => this.zoomOut());\r\n    if (disabled.includes('zoomOut')) zoomOutBtn.style.display = 'none';\r\n    zoomGroup.appendChild(zoomOutBtn);\r\n    \r\n    this.zoomText = document.createElement('span');\r\n    this.zoomText.className = 'ie-zoom-text';\r\n    this.zoomText.textContent = '100%';\r\n    zoomGroup.appendChild(this.zoomText);\r\n    \r\n    const zoomInBtn = this.createButton('zoomIn', icons.zoomIn, () => this.zoomIn());\r\n    if (disabled.includes('zoomIn')) zoomInBtn.style.display = 'none';\r\n    zoomGroup.appendChild(zoomInBtn);\r\n    \r\n    const resetBtn = this.createButton('reset', icons.reset, () => this.resetView());\r\n    if (disabled.includes('reset')) resetBtn.style.display = 'none';\r\n    zoomGroup.appendChild(resetBtn);\r\n    \r\n    this.groups.set('zoom', zoomGroup);\r\n    toolbar.appendChild(zoomGroup);\r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Tool controls (always create, respect disabledTools)\r\n    const toolGroup = this.createGroup();\r\n    toolGroup.className = 'ie-toolbar-group ie-tool-group';\r\n    \r\n    const moveBtn = this.createButton('move', icons.move, () => this.selectTool(null), true);\r\n    if (disabled.includes('move')) moveBtn.style.display = 'none';\r\n    toolGroup.appendChild(moveBtn);\r\n    \r\n    const penBtn = this.createButton('pen', icons.pen, () => this.selectTool('pen'));\r\n    if (disabled.includes('pen')) penBtn.style.display = 'none';\r\n    toolGroup.appendChild(penBtn);\r\n    \r\n    const rectBtn = this.createButton('rect', icons.rect, () => this.selectTool('rect'));\r\n    if (disabled.includes('rect')) rectBtn.style.display = 'none';\r\n    toolGroup.appendChild(rectBtn);\r\n    \r\n    const circleBtn = this.createButton('circle', icons.circle, () => this.selectTool('circle'));\r\n    if (disabled.includes('circle')) circleBtn.style.display = 'none';\r\n    toolGroup.appendChild(circleBtn);\r\n    \r\n    const arrowBtn = this.createButton('arrow', icons.arrow, () => this.selectTool('arrow'));\r\n    if (disabled.includes('arrow')) arrowBtn.style.display = 'none';\r\n    toolGroup.appendChild(arrowBtn);\r\n    \r\n    const lineBtn = this.createButton('line', icons.line, () => this.selectTool('line'));\r\n    if (disabled.includes('line')) lineBtn.style.display = 'none';\r\n    toolGroup.appendChild(lineBtn);\r\n    \r\n    const triangleBtn = this.createButton('triangle', icons.triangle, () => this.selectTool('triangle'));\r\n    if (disabled.includes('triangle')) triangleBtn.style.display = 'none';\r\n    toolGroup.appendChild(triangleBtn);\r\n    \r\n    const textBtn = this.createButton('text', icons.type, () => this.selectTool('text'));\r\n    if (disabled.includes('text')) textBtn.style.display = 'none';\r\n    toolGroup.appendChild(textBtn);\r\n    \r\n    const mosaicBtn = this.createButton('mosaic', icons.mosaic, () => this.selectTool('mosaic'));\r\n    if (disabled.includes('mosaic')) mosaicBtn.style.display = 'none';\r\n    toolGroup.appendChild(mosaicBtn);\r\n    \r\n    const eraserBtn = this.createButton('eraser', icons.eraser, () => this.selectTool('eraser'));\r\n    if (disabled.includes('eraser')) eraserBtn.style.display = 'none';\r\n    toolGroup.appendChild(eraserBtn);\r\n    \r\n    this.groups.set('tool', toolGroup);\r\n    toolbar.appendChild(toolGroup);\r\n    \r\n    // Crop and filter tools\r\n    const advancedGroup = this.createGroup();\r\n    advancedGroup.className = 'ie-toolbar-group ie-advanced-group';\r\n    \r\n    const cropBtn = this.createButton('crop', icons.crop, () => this.toggleCropTool());\r\n    if (disabled.includes('crop')) cropBtn.style.display = 'none';\r\n    advancedGroup.appendChild(cropBtn);\r\n    \r\n    const filterBtn = this.createButton('filter', icons.filter, () => this.toggleFilterPanel());\r\n    if (disabled.includes('filter')) filterBtn.style.display = 'none';\r\n    advancedGroup.appendChild(filterBtn);\r\n    \r\n    this.groups.set('advanced', advancedGroup);\r\n    toolbar.appendChild(advancedGroup);\r\n    \r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Create all settings panels (they are hidden until tool is selected)\r\n    this.createDrawPanel(toolbar);\r\n    this.createMosaicPanel(toolbar);\r\n    this.createTextPanel(toolbar);\r\n    this.createEraserPanel(toolbar);\r\n    this.createFilterPanel(toolbar);\r\n    \r\n    // History controls (always create, respect disabledTools)\r\n    const historyGroup = this.createGroup();\r\n    historyGroup.className = 'ie-toolbar-group ie-history-group';\r\n    \r\n    const undoBtn = this.createButton('undo', icons.undo, () => this.editor.undo(), false, true);\r\n    if (disabled.includes('undo')) undoBtn.style.display = 'none';\r\n    historyGroup.appendChild(undoBtn);\r\n    \r\n    const redoBtn = this.createButton('redo', icons.redo, () => this.editor.redo(), false, true);\r\n    if (disabled.includes('redo')) redoBtn.style.display = 'none';\r\n    historyGroup.appendChild(redoBtn);\r\n    \r\n    this.groups.set('history', historyGroup);\r\n    toolbar.appendChild(historyGroup);\r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Crop action buttons (hidden by default, shown when crop is active)\r\n    const cropActionGroup = document.createElement('div');\r\n    cropActionGroup.className = 'ie-toolbar-group ie-crop-action-group';\r\n    cropActionGroup.style.display = 'none';\r\n    \r\n    const cropCancelBtn = document.createElement('button');\r\n    cropCancelBtn.className = 'ie-btn ie-crop-toolbar-btn ie-crop-toolbar-cancel';\r\n    cropCancelBtn.innerHTML = `${icons.close}<span>取消</span>`;\r\n    cropCancelBtn.onclick = () => this.toggleCropTool();\r\n    cropActionGroup.appendChild(cropCancelBtn);\r\n    \r\n    const cropConfirmBtn = document.createElement('button');\r\n    cropConfirmBtn.className = 'ie-btn ie-crop-toolbar-btn ie-crop-toolbar-confirm';\r\n    cropConfirmBtn.innerHTML = `${icons.check}<span>确认裁剪</span>`;\r\n    cropConfirmBtn.onclick = () => this.applyCrop();\r\n    cropActionGroup.appendChild(cropConfirmBtn);\r\n    \r\n    this.groups.set('cropAction', cropActionGroup);\r\n    toolbar.appendChild(cropActionGroup);\r\n    this.buttons.set('cropActionGroup', cropCancelBtn); // Store reference\r\n    \r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Export (always create, respect disabledTools)\r\n    const exportBtn = this.createButton('export', icons.download, () => this.exportImage());\r\n    exportBtn.classList.add('ie-btn-export');\r\n    const span = document.createElement('span');\r\n    span.textContent = '导出';\r\n    exportBtn.appendChild(span);\r\n    if (disabled.includes('export')) exportBtn.style.display = 'none';\r\n    toolbar.appendChild(exportBtn);\r\n    \r\n    // Initialize divider visibility based on disabled tools\r\n    this.updateDividerVisibility(disabled);\r\n    \r\n    return toolbar;\r\n  }\r\n\r\n  private createGroup(): HTMLElement {\r\n    const group = document.createElement('div');\r\n    group.className = 'ie-toolbar-group';\r\n    return group;\r\n  }\r\n\r\n  private createDivider(): HTMLElement {\r\n    const divider = document.createElement('div');\r\n    divider.className = 'ie-toolbar-divider';\r\n    return divider;\r\n  }\r\n\r\n  private createButton(\r\n    name: string,\r\n    icon: string,\r\n    onClick: () => void,\r\n    active = false,\r\n    isHistoryBtn = false\r\n  ): HTMLButtonElement {\r\n    const btn = document.createElement('button');\r\n    btn.className = 'ie-btn' + (active ? ' active' : '');\r\n    btn.innerHTML = icon;\r\n    btn.onclick = onClick;\r\n    \r\n    // Add tooltip\r\n    const tooltipInfo = this.getTooltipInfo(name);\r\n    const tooltip = document.createElement('div');\r\n    tooltip.className = 'ie-tooltip';\r\n    tooltip.innerHTML = `\r\n      <div class=\"ie-tooltip-title\">${tooltipInfo.title}</div>\r\n      ${tooltipInfo.desc ? `<div class=\"ie-tooltip-desc\">${tooltipInfo.desc}</div>` : ''}\r\n      ${tooltipInfo.shortcut ? `<div class=\"ie-tooltip-shortcut\">${tooltipInfo.shortcut}</div>` : ''}\r\n    `;\r\n    btn.appendChild(tooltip);\r\n    \r\n    if (isHistoryBtn) {\r\n      btn.disabled = true;\r\n    }\r\n    \r\n    this.buttons.set(name, btn);\r\n    return btn;\r\n  }\r\n\r\n  private getTooltipInfo(name: string): { title: string; desc?: string; shortcut?: string } {\r\n    const tooltips: Record<string, { title: string; desc?: string; shortcut?: string }> = {\r\n      zoomOut: { title: '缩小', desc: '缩小图片视图', shortcut: '-' },\r\n      zoomIn: { title: '放大', desc: '放大图片视图', shortcut: '+' },\r\n      reset: { title: '重置视图', desc: '恢复默认缩放和位置', shortcut: '0' },\r\n      move: { title: '移动', desc: '拖拽平移画布，点击选中形状', shortcut: 'V' },\r\n      pen: { title: '画笔', desc: '自由绘制线条', shortcut: 'P' },\r\n      rect: { title: '矩形', desc: '绘制矩形框', shortcut: 'R' },\r\n      circle: { title: '圆形', desc: '绘制圆形/椭圆', shortcut: 'O' },\r\n      arrow: { title: '箭头', desc: '绘制带箭头的线条', shortcut: 'A' },\r\n      line: { title: '直线', desc: '绘制直线', shortcut: 'L' },\r\n      triangle: { title: '三角形', desc: '绘制三角形' },\r\n      text: { title: '文字', desc: '添加文字标注', shortcut: 'T' },\r\n      mosaic: { title: '马赛克', desc: '模糊敏感区域', shortcut: 'M' },\r\n      eraser: { title: '橡皮擦', desc: '擦除文字和标记', shortcut: 'E' },\r\n      crop: { title: '裁剪', desc: '裁剪图片区域', shortcut: 'C' },\r\n      filter: { title: '滤镜', desc: '调整亮度/对比度/饱和度', shortcut: 'F' },\r\n      undo: { title: '撤销', desc: '撤销上一步操作', shortcut: 'Ctrl+Z' },\r\n      redo: { title: '重做', desc: '恢复撤销的操作', shortcut: 'Ctrl+Y' },\r\n      export: { title: '导出', desc: '保存图片到本地', shortcut: 'Ctrl+S' },\r\n    };\r\n    return tooltips[name] || { title: name };\r\n  }\r\n\r\n  /** Create drawing tools panel (shared by pen, rect, circle, arrow) */\r\n  private createDrawPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">绘图设置</div>\r\n      <div class=\"ie-panel-row\">\r\n        <span class=\"ie-panel-label\">线宽</span>\r\n        <div class=\"ie-size-control\">\r\n          <button class=\"ie-size-btn\" data-action=\"stroke-dec\">${icons.minus}</button>\r\n          <span class=\"ie-panel-value\" data-value=\"stroke-width\">${this.strokeWidth}px</span>\r\n          <button class=\"ie-size-btn\" data-action=\"stroke-inc\">${icons.plus}</button>\r\n        </div>\r\n      </div>\r\n      <div class=\"ie-panel-row\">\r\n        <span class=\"ie-panel-label\">颜色</span>\r\n        <div class=\"ie-color-row\">\r\n          <input type=\"color\" class=\"ie-color-input\" value=\"${this.strokeColor}\" data-input=\"stroke-color\">\r\n          <span class=\"ie-color-hex\" data-value=\"stroke-color\">${this.strokeColor}</span>\r\n        </div>\r\n      </div>\r\n    `;\r\n    \r\n    // Events\r\n    panel.querySelector('[data-action=\"stroke-dec\"]')?.addEventListener('click', () => {\r\n      this.strokeWidth = Math.max(1, this.strokeWidth - 1);\r\n      this.updateDrawPanelUI();\r\n    });\r\n    panel.querySelector('[data-action=\"stroke-inc\"]')?.addEventListener('click', () => {\r\n      this.strokeWidth = Math.min(20, this.strokeWidth + 1);\r\n      this.updateDrawPanelUI();\r\n    });\r\n    panel.querySelector('[data-input=\"stroke-color\"]')?.addEventListener('input', (e) => {\r\n      this.strokeColor = (e.target as HTMLInputElement).value;\r\n      this.updateDrawPanelUI();\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('draw', panel);\r\n  }\r\n  \r\n  private updateDrawPanelUI(): void {\r\n    const panel = this.panels.get('draw');\r\n    if (!panel) return;\r\n    \r\n    const widthEl = panel.querySelector('[data-value=\"stroke-width\"]');\r\n    const colorEl = panel.querySelector('[data-value=\"stroke-color\"]');\r\n    const colorInput = panel.querySelector('[data-input=\"stroke-color\"]') as HTMLInputElement;\r\n    \r\n    if (widthEl) widthEl.textContent = `${this.strokeWidth}px`;\r\n    if (colorEl) colorEl.textContent = this.strokeColor;\r\n    if (colorInput) colorInput.value = this.strokeColor;\r\n    \r\n    // Update brush cursor if visible\r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  /** Create mosaic settings panel */\r\n  private createMosaicPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-mosaic';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">马赛克设置</div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">笔刷大小</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"1\" max=\"20\" value=\"${this.strokeWidth}\" data-slider=\"mosaic-brush\">\r\n        <span class=\"ie-panel-value\" data-value=\"mosaic-brush\">${this.strokeWidth * 3}</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">色块大小</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"3\" max=\"30\" value=\"${this.mosaicSize}\" data-slider=\"mosaic-block\">\r\n        <span class=\"ie-panel-value\" data-value=\"mosaic-block\">${this.mosaicSize}</span>\r\n      </div>\r\n    `;\r\n    \r\n    // Events for brush size slider\r\n    panel.querySelector('[data-slider=\"mosaic-brush\"]')?.addEventListener('input', (e) => {\r\n      this.strokeWidth = parseInt((e.target as HTMLInputElement).value);\r\n      this.updateMosaicPanelUI();\r\n    });\r\n    \r\n    // Events for block size slider\r\n    panel.querySelector('[data-slider=\"mosaic-block\"]')?.addEventListener('input', (e) => {\r\n      this.mosaicSize = parseInt((e.target as HTMLInputElement).value);\r\n      this.updateMosaicPanelUI();\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('mosaic', panel);\r\n  }\r\n  \r\n  private updateMosaicPanelUI(): void {\r\n    const panel = this.panels.get('mosaic');\r\n    if (!panel) return;\r\n    \r\n    const brushEl = panel.querySelector('[data-value=\"mosaic-brush\"]');\r\n    const blockEl = panel.querySelector('[data-value=\"mosaic-block\"]');\r\n    const brushSlider = panel.querySelector('[data-slider=\"mosaic-brush\"]') as HTMLInputElement;\r\n    const blockSlider = panel.querySelector('[data-slider=\"mosaic-block\"]') as HTMLInputElement;\r\n    \r\n    if (brushEl) brushEl.textContent = String(this.strokeWidth * 3);\r\n    if (blockEl) blockEl.textContent = String(this.mosaicSize);\r\n    if (brushSlider) brushSlider.value = String(this.strokeWidth);\r\n    if (blockSlider) blockSlider.value = String(this.mosaicSize);\r\n    \r\n    // Update brush cursor\r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  private createTextPanel(_toolbar: HTMLElement): void {\r\n    // Text panel is now inline on the canvas, not in the toolbar\r\n    // Create a simple hint panel\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-text-hint';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-row\" style=\"color:var(--ie-text-muted);font-size:12px;text-align:center;\">\r\n        点击图片添加文字\r\n      </div>\r\n    `;\r\n    _toolbar.appendChild(panel);\r\n    this.panels.set('text', panel);\r\n  }\r\n\r\n  /** Create eraser panel */\r\n  private createEraserPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-eraser';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">橡皮擦设置</div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">笔刷大小</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"5\" max=\"50\" value=\"${this.eraserSize}\" data-slider=\"eraser-size\">\r\n        <span class=\"ie-panel-value\" data-value=\"eraser-size\">${this.eraserSize}</span>\r\n      </div>\r\n      <div class=\"ie-panel-row\">\r\n        <span class=\"ie-panel-label\">模式</span>\r\n        <div class=\"ie-btn-group\">\r\n          <button class=\"ie-mode-btn ${this.eraserMode === 'pixel' ? 'active' : ''}\" data-mode=\"pixel\">像素</button>\r\n          <button class=\"ie-mode-btn ${this.eraserMode === 'shape' ? 'active' : ''}\" data-mode=\"shape\">形状</button>\r\n        </div>\r\n      </div>\r\n    `;\r\n    \r\n    // Events\r\n    panel.querySelector('[data-slider=\"eraser-size\"]')?.addEventListener('input', (e) => {\r\n      this.eraserSize = parseInt((e.target as HTMLInputElement).value);\r\n      this.updateEraserPanelUI();\r\n    });\r\n    \r\n    panel.querySelectorAll('[data-mode]').forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        this.eraserMode = btn.getAttribute('data-mode') as 'pixel' | 'shape';\r\n        this.updateEraserPanelUI();\r\n      });\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('eraser', panel);\r\n  }\r\n  \r\n  private updateEraserPanelUI(): void {\r\n    const panel = this.panels.get('eraser');\r\n    if (!panel) return;\r\n    \r\n    const sizeEl = panel.querySelector('[data-value=\"eraser-size\"]');\r\n    const sizeSlider = panel.querySelector('[data-slider=\"eraser-size\"]') as HTMLInputElement;\r\n    \r\n    if (sizeEl) sizeEl.textContent = String(this.eraserSize);\r\n    if (sizeSlider) sizeSlider.value = String(this.eraserSize);\r\n    \r\n    // Update mode buttons\r\n    panel.querySelectorAll('[data-mode]').forEach(btn => {\r\n      btn.classList.toggle('active', btn.getAttribute('data-mode') === this.eraserMode);\r\n    });\r\n    \r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  /** Create filter panel */\r\n  private createFilterPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-filter';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">滤镜调整</div>\r\n      <div class=\"ie-filter-presets\">\r\n        <button class=\"ie-filter-preset\" data-preset=\"none\" title=\"原图\">原图</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"grayscale\" title=\"灰度\">灰度</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"sepia\" title=\"怀旧\">怀旧</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"invert\" title=\"反色\">反色</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"warm\" title=\"暖色\">暖色</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"cool\" title=\"冷色\">冷色</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"vivid\" title=\"鲜艳\">鲜艳</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"vintage\" title=\"复古\">复古</button>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">亮度</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"-100\" max=\"100\" value=\"0\" data-filter=\"brightness\">\r\n        <span class=\"ie-panel-value\" data-value=\"brightness\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">对比度</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"-100\" max=\"100\" value=\"0\" data-filter=\"contrast\">\r\n        <span class=\"ie-panel-value\" data-value=\"contrast\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">饱和度</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"-100\" max=\"100\" value=\"0\" data-filter=\"saturation\">\r\n        <span class=\"ie-panel-value\" data-value=\"saturation\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">模糊</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"0\" max=\"20\" value=\"0\" data-filter=\"blur\">\r\n        <span class=\"ie-panel-value\" data-value=\"blur\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-btn-row\">\r\n        <button class=\"ie-btn-apply\" data-action=\"apply-filter\">应用</button>\r\n        <button class=\"ie-btn-reset\" data-action=\"reset-filter\">重置</button>\r\n      </div>\r\n    `;\r\n    \r\n    // Events for filter presets\r\n    panel.querySelectorAll('[data-preset]').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        const preset = (e.target as HTMLElement).getAttribute('data-preset') || 'none';\r\n        this.applyFilterPreset(preset);\r\n        // Highlight active preset\r\n        panel.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));\r\n        (e.target as HTMLElement).classList.add('active');\r\n      });\r\n    });\r\n    \r\n    // Events for sliders\r\n    panel.querySelectorAll('[data-filter]').forEach(slider => {\r\n      slider.addEventListener('input', (e) => {\r\n        const filterName = (e.target as HTMLInputElement).getAttribute('data-filter');\r\n        const value = (e.target as HTMLInputElement).value;\r\n        const valueEl = panel.querySelector(`[data-value=\"${filterName}\"]`);\r\n        if (valueEl) valueEl.textContent = value;\r\n        this.previewFilter();\r\n        // Clear preset highlight when manually adjusting\r\n        panel.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));\r\n      });\r\n    });\r\n    \r\n    // Apply button\r\n    panel.querySelector('[data-action=\"apply-filter\"]')?.addEventListener('click', () => {\r\n      this.applyFilter();\r\n    });\r\n    \r\n    // Reset button\r\n    panel.querySelector('[data-action=\"reset-filter\"]')?.addEventListener('click', () => {\r\n      this.resetFilterPanel();\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('filter', panel);\r\n  }\r\n  \r\n  private getFilterValues(): { brightness: number; contrast: number; saturation: number; blur: number } {\r\n    const panel = this.panels.get('filter');\r\n    if (!panel) return { brightness: 0, contrast: 0, saturation: 0, blur: 0 };\r\n    \r\n    return {\r\n      brightness: parseInt((panel.querySelector('[data-filter=\"brightness\"]') as HTMLInputElement)?.value || '0'),\r\n      contrast: parseInt((panel.querySelector('[data-filter=\"contrast\"]') as HTMLInputElement)?.value || '0'),\r\n      saturation: parseInt((panel.querySelector('[data-filter=\"saturation\"]') as HTMLInputElement)?.value || '0'),\r\n      blur: parseInt((panel.querySelector('[data-filter=\"blur\"]') as HTMLInputElement)?.value || '0'),\r\n    };\r\n  }\r\n  \r\n  private previewFilter(): void {\r\n    const { brightness, contrast, saturation, blur } = this.getFilterValues();\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas || !this.originalImageData) return;\r\n    \r\n    // Restore original image\r\n    ctx.putImageData(this.originalImageData, 0, 0);\r\n    \r\n    // Apply CSS filters for preview\r\n    const filters = [\r\n      `brightness(${100 + brightness}%)`,\r\n      `contrast(${100 + contrast}%)`,\r\n      `saturate(${100 + saturation}%)`,\r\n      blur > 0 ? `blur(${blur}px)` : '',\r\n    ].filter(Boolean).join(' ');\r\n    \r\n    ctx.filter = filters || 'none';\r\n    ctx.drawImage(canvas, 0, 0);\r\n    ctx.filter = 'none';\r\n  }\r\n  \r\n  private applyFilter(): void {\r\n    // The preview already drew the filtered result, just save it\r\n    this.saveOriginalImage();\r\n    this.resetFilterPanel();\r\n    (this.editor as any).saveToHistory?.('apply filter');\r\n  }\r\n  \r\n  private resetFilterPanel(): void {\r\n    const panel = this.panels.get('filter');\r\n    if (!panel) return;\r\n    \r\n    // Reset all sliders\r\n    panel.querySelectorAll<HTMLInputElement>('[data-filter]').forEach(slider => {\r\n      slider.value = '0';\r\n      const filterName = slider.getAttribute('data-filter');\r\n      const valueEl = panel.querySelector(`[data-value=\"${filterName}\"]`);\r\n      if (valueEl) valueEl.textContent = '0';\r\n    });\r\n    \r\n    // Reset preset buttons\r\n    panel.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));\r\n    panel.querySelector('[data-preset=\"none\"]')?.classList.add('active');\r\n    \r\n    // Restore original image\r\n    if (this.originalImageData) {\r\n      this.editor.ctx?.putImageData(this.originalImageData, 0, 0);\r\n    }\r\n  }\r\n  \r\n  /** Apply filter preset */\r\n  private applyFilterPreset(preset: string): void {\r\n    const panel = this.panels.get('filter');\r\n    if (!panel) return;\r\n    \r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas || !this.originalImageData) return;\r\n    \r\n    // Restore original image first\r\n    ctx.putImageData(this.originalImageData, 0, 0);\r\n    \r\n    // Get preset values\r\n    const presets: Record<string, { brightness: number; contrast: number; saturation: number; blur: number; css?: string }> = {\r\n      none: { brightness: 0, contrast: 0, saturation: 0, blur: 0 },\r\n      grayscale: { brightness: 0, contrast: 0, saturation: -100, blur: 0 },\r\n      sepia: { brightness: 0, contrast: 0, saturation: -30, blur: 0, css: 'sepia(80%)' },\r\n      invert: { brightness: 0, contrast: 0, saturation: 0, blur: 0, css: 'invert(100%)' },\r\n      warm: { brightness: 10, contrast: 10, saturation: 20, blur: 0, css: 'sepia(20%)' },\r\n      cool: { brightness: 0, contrast: 10, saturation: -10, blur: 0, css: 'hue-rotate(180deg) saturate(50%)' },\r\n      vivid: { brightness: 10, contrast: 30, saturation: 50, blur: 0 },\r\n      vintage: { brightness: -10, contrast: 20, saturation: -20, blur: 0, css: 'sepia(40%)' },\r\n    };\r\n    \r\n    const settings = presets[preset] || presets.none;\r\n    \r\n    // Update sliders\r\n    const brightnessSlider = panel.querySelector('[data-filter=\"brightness\"]') as HTMLInputElement;\r\n    const contrastSlider = panel.querySelector('[data-filter=\"contrast\"]') as HTMLInputElement;\r\n    const saturationSlider = panel.querySelector('[data-filter=\"saturation\"]') as HTMLInputElement;\r\n    const blurSlider = panel.querySelector('[data-filter=\"blur\"]') as HTMLInputElement;\r\n    \r\n    if (brightnessSlider) {\r\n      brightnessSlider.value = String(settings.brightness);\r\n      const val = panel.querySelector('[data-value=\"brightness\"]');\r\n      if (val) val.textContent = String(settings.brightness);\r\n    }\r\n    if (contrastSlider) {\r\n      contrastSlider.value = String(settings.contrast);\r\n      const val = panel.querySelector('[data-value=\"contrast\"]');\r\n      if (val) val.textContent = String(settings.contrast);\r\n    }\r\n    if (saturationSlider) {\r\n      saturationSlider.value = String(settings.saturation);\r\n      const val = panel.querySelector('[data-value=\"saturation\"]');\r\n      if (val) val.textContent = String(settings.saturation);\r\n    }\r\n    if (blurSlider) {\r\n      blurSlider.value = String(settings.blur);\r\n      const val = panel.querySelector('[data-value=\"blur\"]');\r\n      if (val) val.textContent = String(settings.blur);\r\n    }\r\n    \r\n    // Apply preview with CSS filter\r\n    const filters = [\r\n      `brightness(${100 + settings.brightness}%)`,\r\n      `contrast(${100 + settings.contrast}%)`,\r\n      `saturate(${100 + settings.saturation}%)`,\r\n      settings.blur > 0 ? `blur(${settings.blur}px)` : '',\r\n      settings.css || '',\r\n    ].filter(Boolean).join(' ');\r\n    \r\n    ctx.filter = filters || 'none';\r\n    ctx.drawImage(canvas, 0, 0);\r\n    ctx.filter = 'none';\r\n  }\r\n\r\n  private updateTextUI(): void {\r\n    // Update text style bar if visible\r\n    this.updateTextStyleBar();\r\n    // Apply to current editing text\r\n    this.applyTextStyle();\r\n  }\r\n\r\n  private showPanel(name: string | null): void {\r\n    this.panels.forEach((panel, key) => {\r\n      if (key === name) {\r\n        // Show with animation\r\n        panel.style.display = 'block';\r\n        panel.classList.remove('ie-panel-hidden');\r\n      } else if (panel.style.display !== 'none') {\r\n        // Hide with animation\r\n        panel.classList.add('ie-panel-hidden');\r\n        // Hide after animation completes\r\n        setTimeout(() => {\r\n          if (panel.classList.contains('ie-panel-hidden')) {\r\n            panel.style.display = 'none';\r\n          }\r\n        }, 200);\r\n      }\r\n    });\r\n    this.activePanel = name;\r\n  }\r\n  \r\n  /** Hide all panels */\r\n  private hideAllPanels(): void {\r\n    this.showPanel(null);\r\n  }\r\n\r\n  private setupEvents(): void {\r\n    // Wheel zoom - disabled when showing placeholder\r\n    this.canvasContainer.addEventListener('wheel', (e) => {\r\n      if (!this.hasRealImage) return; // Disable zoom for placeholder\r\n      e.preventDefault();\r\n      const delta = e.deltaY > 0 ? 0.9 : 1.1;\r\n      this.setScale(this.scale * delta, e.clientX, e.clientY);\r\n    }, { passive: false });\r\n    \r\n    // Pointer down - handle pan, drawing, or shape selection/dragging\r\n    this.canvasContainer.addEventListener('pointerdown', (e) => {\r\n      if (!this.hasRealImage) return; // Disable interactions for placeholder\r\n      \r\n      const pos = this.clientToCanvasCoords(e.clientX, e.clientY);\r\n      \r\n      // Drawing tools\r\n      if (this.isDrawingTool(this.currentTool)) {\r\n        this.startDrawing(pos);\r\n        this.canvasContainer.setPointerCapture(e.pointerId);\r\n      } else if (!this.currentTool || this.currentTool === '') {\r\n        // Move mode - check for shape selection first\r\n        const shape = this.shapeManager.findShapeAtPoint(pos.x, pos.y, 8);\r\n        if (shape) {\r\n          // Select and start dragging shape\r\n          this.shapeManager.selectShape(shape.id);\r\n          this.isDraggingShape = true;\r\n          this.dragStartPoint = pos;\r\n          this.canvasContainer.classList.add('grabbing');\r\n          this.canvasContainer.setPointerCapture(e.pointerId);\r\n        } else {\r\n          // Deselect any selected shape and start panning\r\n          this.shapeManager.selectShape(null);\r\n          this.isPanning = true;\r\n          this.lastPanPoint = { x: e.clientX, y: e.clientY };\r\n          this.canvasContainer.classList.add('grabbing');\r\n          this.canvasContainer.setPointerCapture(e.pointerId);\r\n        }\r\n      }\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointermove', (e) => {\r\n      // Default cursor for placeholder\r\n      if (!this.hasRealImage) {\r\n        this.canvasContainer.style.cursor = 'default';\r\n        return;\r\n      }\r\n      \r\n      const pos = this.clientToCanvasCoords(e.clientX, e.clientY);\r\n      \r\n      // Update brush cursor position\r\n      if (this.brushCursor && this.isDrawingTool(this.currentTool)) {\r\n        this.updateBrushCursorPosition(e.clientX, e.clientY);\r\n      }\r\n      \r\n      if (this.isDrawing) {\r\n        this.continueDrawing(pos);\r\n      } else if (this.isDraggingShape) {\r\n        // Drag selected shape\r\n        const selected = this.shapeManager.getSelectedShape();\r\n        if (selected) {\r\n          const dx = pos.x - this.dragStartPoint.x;\r\n          const dy = pos.y - this.dragStartPoint.y;\r\n          this.shapeManager.moveShape(selected.id, dx, dy);\r\n          this.dragStartPoint = pos;\r\n        }\r\n      } else if (this.isPanning) {\r\n        this.translateX += e.clientX - this.lastPanPoint.x;\r\n        this.translateY += e.clientY - this.lastPanPoint.y;\r\n        this.lastPanPoint = { x: e.clientX, y: e.clientY };\r\n        this.updateTransform();\r\n      } else if (!this.currentTool || this.currentTool === '') {\r\n        // Move mode - update cursor based on hovering over shape\r\n        const shape = this.shapeManager.findShapeAtPoint(pos.x, pos.y, 8);\r\n        this.canvasContainer.style.cursor = shape ? 'move' : 'grab';\r\n      }\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointerup', (e) => {\r\n      if (this.isDrawing) {\r\n        this.endDrawing();\r\n      }\r\n      if (this.isDraggingShape) {\r\n        this.isDraggingShape = false;\r\n        (this.editor as any).saveToHistory?.('move shape');\r\n      }\r\n      this.isPanning = false;\r\n      this.canvasContainer.classList.remove('grabbing');\r\n      this.canvasContainer.releasePointerCapture(e.pointerId);\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointerleave', () => {\r\n      if (this.brushCursor) {\r\n        this.brushCursor.style.display = 'none';\r\n      }\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointerenter', () => {\r\n      if (this.brushCursor && this.isDrawingTool(this.currentTool)) {\r\n        this.brushCursor.style.display = 'block';\r\n      }\r\n    });\r\n    \r\n    // Text tool click\r\n    this.canvasContainer.addEventListener('click', (e) => {\r\n      if (this.currentTool !== 'text') return;\r\n      if (this.isAddingText) return;\r\n      \r\n      const pos = this.clientToCanvasCoords(e.clientX, e.clientY);\r\n      this.showInlineTextInput(e.clientX, e.clientY, pos);\r\n    });\r\n    \r\n    // Keyboard events for delete\r\n    document.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Delete' || e.key === 'Backspace') {\r\n        // Don't delete if we're editing text\r\n        if (this.isAddingText || document.activeElement?.tagName === 'INPUT' || document.activeElement?.tagName === 'TEXTAREA') {\r\n          return;\r\n        }\r\n        const selected = this.shapeManager.getSelectedShape();\r\n        if (selected) {\r\n          e.preventDefault();\r\n          this.shapeManager.deleteShape(selected.id);\r\n          (this.editor as any).saveToHistory?.('delete shape');\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Touch events for pinch-to-zoom and two-finger pan\r\n    this.canvasContainer.addEventListener('touchstart', (e) => {\r\n      if (!this.hasRealImage) return;\r\n      \r\n      if (e.touches.length === 2) {\r\n        e.preventDefault();\r\n        // Pinch gesture start\r\n        const touch1 = e.touches[0];\r\n        const touch2 = e.touches[1];\r\n        this.touchStartDistance = Math.hypot(\r\n          touch2.clientX - touch1.clientX,\r\n          touch2.clientY - touch1.clientY\r\n        );\r\n        this.touchStartScale = this.scale;\r\n        this.touchStartCenter = {\r\n          x: (touch1.clientX + touch2.clientX) / 2,\r\n          y: (touch1.clientY + touch2.clientY) / 2\r\n        };\r\n        this.lastTouchCenter = { ...this.touchStartCenter };\r\n        this.isTouchPanning = true;\r\n      }\r\n    }, { passive: false });\r\n    \r\n    this.canvasContainer.addEventListener('touchmove', (e) => {\r\n      if (!this.hasRealImage) return;\r\n      \r\n      if (e.touches.length === 2 && this.touchStartDistance > 0) {\r\n        e.preventDefault();\r\n        const touch1 = e.touches[0];\r\n        const touch2 = e.touches[1];\r\n        \r\n        // Calculate new distance for pinch zoom\r\n        const currentDistance = Math.hypot(\r\n          touch2.clientX - touch1.clientX,\r\n          touch2.clientY - touch1.clientY\r\n        );\r\n        const scaleRatio = currentDistance / this.touchStartDistance;\r\n        const newScale = Math.max(0.1, Math.min(5, this.touchStartScale * scaleRatio));\r\n        \r\n        // Calculate center point for zoom\r\n        const currentCenter = {\r\n          x: (touch1.clientX + touch2.clientX) / 2,\r\n          y: (touch1.clientY + touch2.clientY) / 2\r\n        };\r\n        \r\n        // Apply zoom at center point\r\n        this.setScale(newScale, currentCenter.x, currentCenter.y);\r\n        \r\n        // Also apply pan from center movement\r\n        if (this.isTouchPanning) {\r\n          this.translateX += currentCenter.x - this.lastTouchCenter.x;\r\n          this.translateY += currentCenter.y - this.lastTouchCenter.y;\r\n          this.updateTransform();\r\n        }\r\n        \r\n        this.lastTouchCenter = currentCenter;\r\n      }\r\n    }, { passive: false });\r\n    \r\n    this.canvasContainer.addEventListener('touchend', (e) => {\r\n      if (e.touches.length < 2) {\r\n        this.touchStartDistance = 0;\r\n        this.isTouchPanning = false;\r\n      }\r\n    });\r\n    \r\n    // Click outside to close panels\r\n    document.addEventListener('click', (e) => {\r\n      if (this.activePanel) {\r\n        const target = e.target as HTMLElement;\r\n        // Check if click is outside panels and toolbar buttons\r\n        const isInPanel = target.closest('.ie-panel');\r\n        const isToolbarBtn = target.closest('.ie-btn');\r\n        if (!isInPanel && !isToolbarBtn) {\r\n          this.hideAllPanels();\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Drag and drop support\r\n    this.setupDropZone();\r\n  }\r\n  \r\n  private dropZone: HTMLElement | null = null;\r\n  \r\n  private setupDropZone(): void {\r\n    // Create drop zone overlay\r\n    this.dropZone = document.createElement('div');\r\n    this.dropZone.className = 'ie-drop-zone';\r\n    this.dropZone.innerHTML = `\r\n      <div class=\"ie-drop-zone-icon\">\r\n        <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n          <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/>\r\n          <polyline points=\"17 8 12 3 7 8\"/>\r\n          <line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/>\r\n        </svg>\r\n      </div>\r\n      <div class=\"ie-drop-zone-text\">松开鼠标上传图片</div>\r\n      <div class=\"ie-drop-zone-hint\">支持 PNG、JPG、GIF 等格式</div>\r\n    `;\r\n    this.canvasContainer.appendChild(this.dropZone);\r\n    \r\n    // Drag enter\r\n    this.canvasContainer.addEventListener('dragenter', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      if (this.isImageDrag(e)) {\r\n        this.dropZone?.classList.add('active');\r\n      }\r\n    });\r\n    \r\n    // Drag over\r\n    this.canvasContainer.addEventListener('dragover', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      if (this.isImageDrag(e)) {\r\n        e.dataTransfer!.dropEffect = 'copy';\r\n        this.dropZone?.classList.add('active');\r\n      }\r\n    });\r\n    \r\n    // Drag leave\r\n    this.canvasContainer.addEventListener('dragleave', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      // Only hide if leaving the container completely\r\n      const rect = this.canvasContainer.getBoundingClientRect();\r\n      if (e.clientX <= rect.left || e.clientX >= rect.right ||\r\n          e.clientY <= rect.top || e.clientY >= rect.bottom) {\r\n        this.dropZone?.classList.remove('active');\r\n      }\r\n    });\r\n    \r\n    // Drop\r\n    this.canvasContainer.addEventListener('drop', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.dropZone?.classList.remove('active');\r\n      \r\n      const file = e.dataTransfer?.files?.[0];\r\n      if (file?.type.startsWith('image/')) {\r\n        this.loadImageFile(file);\r\n      }\r\n    });\r\n  }\r\n  \r\n  private isImageDrag(e: DragEvent): boolean {\r\n    if (!e.dataTransfer) return false;\r\n    // Check if dragging files\r\n    if (e.dataTransfer.types.includes('Files')) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  \r\n  private loadImageFile(file: File): void {\r\n    const reader = new FileReader();\r\n    reader.onload = (e) => {\r\n      const dataUrl = e.target?.result as string;\r\n      if (dataUrl) {\r\n        this.editor.loadImage(dataUrl);\r\n      }\r\n    };\r\n    reader.readAsDataURL(file);\r\n  }\r\n  \r\n  private isDrawingTool(tool: string | null): boolean {\r\n    return ['pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'mosaic', 'eraser'].includes(tool || '');\r\n  }\r\n  \r\n  /** Check if tool creates shapes (vs direct canvas drawing like mosaic) */\r\n  private isShapeTool(tool: string | null): boolean {\r\n    return ['pen', 'rect', 'circle', 'arrow', 'line', 'triangle'].includes(tool || '');\r\n  }\r\n  \r\n  private startDrawing(pos: { x: number; y: number }): void {\r\n    this.isDrawing = true;\r\n    this.drawStartPoint = pos;\r\n    this.lastDrawPoint = pos;\r\n    \r\n    const style = { strokeColor: this.strokeColor, strokeWidth: this.strokeWidth };\r\n    \r\n    // Create shape via manager for shape tools\r\n    if (this.isShapeTool(this.currentTool)) {\r\n      const type = this.currentTool as 'pen' | 'rect' | 'circle' | 'arrow' | 'line' | 'triangle';\r\n      this.currentShapeId = this.shapeManager.createShape(type, style);\r\n      \r\n      // Initialize shape data\r\n      if (type === 'pen') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as PenShape;\r\n        if (shape) {\r\n          shape.points = [{ x: pos.x, y: pos.y }];\r\n        }\r\n      } else if (type === 'rect') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as RectShape;\r\n        if (shape) {\r\n          shape.x = pos.x;\r\n          shape.y = pos.y;\r\n          shape.width = 0;\r\n          shape.height = 0;\r\n        }\r\n      } else if (type === 'circle') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as CircleShape;\r\n        if (shape) {\r\n          shape.cx = pos.x;\r\n          shape.cy = pos.y;\r\n          shape.rx = 0;\r\n          shape.ry = 0;\r\n        }\r\n      } else if (type === 'arrow' || type === 'line') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as ArrowShape | LineShape;\r\n        if (shape) {\r\n          shape.start = { x: pos.x, y: pos.y };\r\n          shape.end = { x: pos.x, y: pos.y };\r\n        }\r\n      } else if (type === 'triangle') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as TriangleShape;\r\n        if (shape) {\r\n          // Initialize triangle with start point\r\n          shape.points = [{ x: pos.x, y: pos.y }, { x: pos.x, y: pos.y }, { x: pos.x, y: pos.y }];\r\n        }\r\n      }\r\n    } else if (this.currentTool === 'mosaic') {\r\n      // Mosaic draws directly to canvas (not as a shape)\r\n      this.applyMosaicAt(pos.x, pos.y);\r\n    } else if (this.currentTool === 'eraser') {\r\n      this.applyEraserAt(pos.x, pos.y);\r\n    }\r\n  }\r\n  \r\n  private continueDrawing(pos: { x: number; y: number }): void {\r\n    if (!this.isDrawing) return;\r\n    \r\n    if (this.isShapeTool(this.currentTool) && this.currentShapeId) {\r\n      const shape = this.shapeManager.getShape(this.currentShapeId);\r\n      if (!shape) return;\r\n      \r\n      switch (this.currentTool) {\r\n        case 'pen': {\r\n          const s = shape as PenShape;\r\n          s.points.push({ x: pos.x, y: pos.y });\r\n          break;\r\n        }\r\n        case 'rect': {\r\n          const s = shape as RectShape;\r\n          s.x = Math.min(this.drawStartPoint.x, pos.x);\r\n          s.y = Math.min(this.drawStartPoint.y, pos.y);\r\n          s.width = Math.abs(pos.x - this.drawStartPoint.x);\r\n          s.height = Math.abs(pos.y - this.drawStartPoint.y);\r\n          break;\r\n        }\r\n        case 'circle': {\r\n          const s = shape as CircleShape;\r\n          s.cx = (this.drawStartPoint.x + pos.x) / 2;\r\n          s.cy = (this.drawStartPoint.y + pos.y) / 2;\r\n          s.rx = Math.abs(pos.x - this.drawStartPoint.x) / 2;\r\n          s.ry = Math.abs(pos.y - this.drawStartPoint.y) / 2;\r\n          break;\r\n        }\r\n        case 'arrow':\r\n        case 'line': {\r\n          const s = shape as ArrowShape | LineShape;\r\n          s.end = { x: pos.x, y: pos.y };\r\n          break;\r\n        }\r\n        case 'triangle': {\r\n          const s = shape as TriangleShape;\r\n          // Create isoceles triangle based on drag\r\n          const midX = (this.drawStartPoint.x + pos.x) / 2;\r\n          s.points = [\r\n            { x: midX, y: this.drawStartPoint.y },  // Top vertex\r\n            { x: this.drawStartPoint.x, y: pos.y }, // Bottom left\r\n            { x: pos.x, y: pos.y }                   // Bottom right\r\n          ];\r\n          break;\r\n        }\r\n      }\r\n      \r\n      this.renderAll();\r\n      this.lastDrawPoint = pos;\r\n    } else if (this.currentTool === 'mosaic') {\r\n      this.interpolateMosaic(this.lastDrawPoint.x, this.lastDrawPoint.y, pos.x, pos.y);\r\n      this.lastDrawPoint = pos;\r\n    } else if (this.currentTool === 'eraser') {\r\n      this.interpolateEraser(this.lastDrawPoint.x, this.lastDrawPoint.y, pos.x, pos.y);\r\n      this.lastDrawPoint = pos;\r\n    }\r\n  }\r\n  \r\n  private endDrawing(): void {\r\n    if (!this.isDrawing) return;\r\n    \r\n    // Finalize shape - check if it's too small and should be deleted\r\n    if (this.isShapeTool(this.currentTool) && this.currentShapeId) {\r\n      const shape = this.shapeManager.getShape(this.currentShapeId);\r\n      if (shape) {\r\n        const bounds = this.shapeManager.getShapeBounds(shape);\r\n        // Delete shape if it's too small (less than 3px in any dimension)\r\n        if (bounds && bounds.width < 3 && bounds.height < 3) {\r\n          this.shapeManager.deleteShape(this.currentShapeId);\r\n        }\r\n      }\r\n    } else if (this.currentTool === 'mosaic' || this.currentTool === 'eraser') {\r\n      // Mosaic/Eraser modifies canvas directly, update originalImageData so shapes don't overwrite it\r\n      this.saveOriginalImage();\r\n    }\r\n    \r\n    this.isDrawing = false;\r\n    this.currentShapeId = null;\r\n    (this.editor as any).saveToHistory?.(this.currentTool + ' draw');\r\n  }\r\n  \r\n  /** Convert client coordinates to canvas coordinates */\r\n  private clientToCanvasCoords(clientX: number, clientY: number): { x: number; y: number } {\r\n    const rect = this.canvasContainer.getBoundingClientRect();\r\n    const canvas = this.editor.canvas;\r\n    const centerX = rect.width / 2;\r\n    const centerY = rect.height / 2;\r\n    const x = (clientX - rect.left - centerX - this.translateX) / this.scale + canvas.width / 2;\r\n    const y = (clientY - rect.top - centerY - this.translateY) / this.scale + canvas.height / 2;\r\n    return { x, y };\r\n  }\r\n  \r\n  // ============ Mosaic Tool Methods ============\r\n  \r\n  /** Apply mosaic at a point */\r\n  private applyMosaicAt(x: number, y: number): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    const radius = this.strokeWidth * 3;\r\n    this.applyMosaicCircle(imageData, x, y, radius, this.mosaicSize);\r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n  \r\n  /** Interpolate mosaic stroke */\r\n  private interpolateMosaic(x1: number, y1: number, x2: number, y2: number): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    const radius = this.strokeWidth * 3;\r\n    const dist = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);\r\n    const step = radius / 2;\r\n    const steps = Math.max(1, Math.ceil(dist / step));\r\n    \r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    for (let i = 0; i <= steps; i++) {\r\n      const t = i / steps;\r\n      const x = x1 + (x2 - x1) * t;\r\n      const y = y1 + (y2 - y1) * t;\r\n      this.applyMosaicCircle(imageData, x, y, radius, this.mosaicSize);\r\n    }\r\n    \r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n  \r\n  /** Apply mosaic effect in a circular region */\r\n  private applyMosaicCircle(imageData: ImageData, cx: number, cy: number, radius: number, blockSize: number): void {\r\n    const { width, height, data } = imageData;\r\n    \r\n    const minX = Math.max(0, Math.floor(cx - radius));\r\n    const maxX = Math.min(width - 1, Math.ceil(cx + radius));\r\n    const minY = Math.max(0, Math.floor(cy - radius));\r\n    const maxY = Math.min(height - 1, Math.ceil(cy + radius));\r\n    \r\n    for (let by = minY; by <= maxY; by += blockSize) {\r\n      for (let bx = minX; bx <= maxX; bx += blockSize) {\r\n        const bcx = bx + blockSize / 2;\r\n        const bcy = by + blockSize / 2;\r\n        const dist = Math.sqrt((bcx - cx) ** 2 + (bcy - cy) ** 2);\r\n        if (dist > radius) continue;\r\n        \r\n        let r = 0, g = 0, b = 0, count = 0;\r\n        const blockEndX = Math.min(bx + blockSize, maxX + 1);\r\n        const blockEndY = Math.min(by + blockSize, maxY + 1);\r\n        \r\n        for (let py = by; py < blockEndY; py++) {\r\n          for (let px = bx; px < blockEndX; px++) {\r\n            const idx = (py * width + px) * 4;\r\n            r += data[idx];\r\n            g += data[idx + 1];\r\n            b += data[idx + 2];\r\n            count++;\r\n          }\r\n        }\r\n        \r\n        if (count > 0) {\r\n          r = Math.round(r / count);\r\n          g = Math.round(g / count);\r\n          b = Math.round(b / count);\r\n          \r\n          for (let py = by; py < blockEndY; py++) {\r\n            for (let px = bx; px < blockEndX; px++) {\r\n              const pDist = Math.sqrt((px - cx) ** 2 + (py - cy) ** 2);\r\n              if (pDist <= radius) {\r\n                const idx = (py * width + px) * 4;\r\n                data[idx] = r;\r\n                data[idx + 1] = g;\r\n                data[idx + 2] = b;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private setupEditorEvents(): void {\r\n    this.editor.on('tool-change', ({ tool }) => {\r\n      this.currentTool = tool || null;\r\n      this.updateToolButtons();\r\n      this.updateCursor();\r\n    });\r\n    \r\n    this.editor.on('history-change', ({ canUndo, canRedo }) => {\r\n      const undoBtn = this.buttons.get('undo');\r\n      const redoBtn = this.buttons.get('redo');\r\n      if (undoBtn) undoBtn.disabled = !canUndo;\r\n      if (redoBtn) redoBtn.disabled = !canRedo;\r\n    });\r\n    \r\n    // Save original image when image is loaded\r\n    this.editor.on('image-loaded', () => {\r\n      // Delay slightly to ensure canvas is fully rendered\r\n      setTimeout(() => {\r\n        // Save pure image for eraser tool (only if not already saved)\r\n        if (!this.pureImageData) {\r\n          this.savePureImage();\r\n        }\r\n        this.saveOriginalImage();\r\n      }, 50);\r\n    });\r\n  }\r\n\r\n  private updateToolButtons(): void {\r\n    // Clear all active states\r\n    const toolButtons = ['move', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'text', 'mosaic', 'eraser', 'crop', 'filter'];\r\n    this.buttons.forEach((btn, name) => {\r\n      if (toolButtons.includes(name)) {\r\n        btn.classList.toggle('active', \r\n          (name === 'move' && !this.currentTool) ||\r\n          (name === this.currentTool)\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  private updateCursor(): void {\r\n    // Remove all tool cursor classes\r\n    this.canvasContainer.classList.remove('tool-draw', 'tool-text', 'tool-move');\r\n    // Reset inline style cursor\r\n    this.canvasContainer.style.cursor = '';\r\n    \r\n    // Remove existing brush cursor\r\n    if (this.brushCursor) {\r\n      this.brushCursor.remove();\r\n      this.brushCursor = null;\r\n    }\r\n    \r\n    if (this.isDrawingTool(this.currentTool)) {\r\n      this.canvasContainer.classList.add('tool-draw');\r\n      if (['pen', 'mosaic', 'eraser'].includes(this.currentTool || '')) {\r\n        this.createBrushCursor();\r\n      }\r\n    } else if (this.currentTool === 'text') {\r\n      this.canvasContainer.classList.add('tool-text');\r\n    } else {\r\n      // Move mode - default grab cursor, will change to move when hovering over shapes\r\n      this.canvasContainer.classList.add('tool-move');\r\n    }\r\n  }\r\n  \r\n  /** Create custom brush cursor */\r\n  private createBrushCursor(): void {\r\n    this.brushCursor = document.createElement('div');\r\n    this.brushCursor.className = 'ie-brush-cursor';\r\n    this.updateBrushCursorSize();\r\n    this.canvasContainer.appendChild(this.brushCursor);\r\n  }\r\n  \r\n  /** Update brush cursor size */\r\n  private updateBrushCursorSize(): void {\r\n    if (!this.brushCursor) return;\r\n    let baseSize: number;\r\n    if (this.currentTool === 'mosaic') {\r\n      baseSize = this.strokeWidth * 6;\r\n    } else if (this.currentTool === 'eraser') {\r\n      baseSize = this.eraserSize;\r\n    } else {\r\n      baseSize = this.strokeWidth * 2;\r\n    }\r\n    const size = baseSize * this.scale;\r\n    this.brushCursor.style.width = `${size}px`;\r\n    this.brushCursor.style.height = `${size}px`;\r\n  }\r\n  \r\n  /** Update brush cursor position */\r\n  private updateBrushCursorPosition(clientX: number, clientY: number): void {\r\n    if (!this.brushCursor) return;\r\n    const rect = this.canvasContainer.getBoundingClientRect();\r\n    const x = clientX - rect.left;\r\n    const y = clientY - rect.top;\r\n    this.brushCursor.style.left = `${x}px`;\r\n    this.brushCursor.style.top = `${y}px`;\r\n  }\r\n\r\n  private selectTool(tool: string | null): void {\r\n    if (tool === this.currentTool) {\r\n      // Toggle panel for tools that have one\r\n      const panelName = this.getPanelNameForTool(tool);\r\n      if (panelName && this.activePanel === panelName) {\r\n        this.showPanel(null);\r\n      } else if (panelName) {\r\n        this.showPanel(panelName);\r\n      }\r\n      return;\r\n    }\r\n    \r\n    this.editor.setTool(tool || '');\r\n    this.currentTool = tool;\r\n    this.updateToolButtons();\r\n    this.updateCursor();\r\n    \r\n    // Show corresponding panel\r\n    const panelName = this.getPanelNameForTool(tool);\r\n    if (panelName) {\r\n      this.showPanel(panelName);\r\n    } else {\r\n      this.showPanel(null);\r\n    }\r\n  }\r\n  \r\n  private getPanelNameForTool(tool: string | null): string | null {\r\n    if (!tool) return null;\r\n    if (['pen', 'rect', 'circle', 'arrow', 'line', 'triangle'].includes(tool)) return 'draw';\r\n    if (tool === 'mosaic') return 'mosaic';\r\n    if (tool === 'text') return 'text';\r\n    if (tool === 'eraser') return 'eraser';\r\n    if (tool === 'filter') return 'filter';\r\n    return null;\r\n  }\r\n\r\n  /** Show inline text input at click position */\r\n  private showInlineTextInput(clientX: number, clientY: number, canvasPos: { x: number; y: number }): void {\r\n    this.isAddingText = true;\r\n    \r\n    // Create inline input container\r\n    this.inlineTextInput = document.createElement('div');\r\n    this.inlineTextInput.className = 'ie-inline-text-container';\r\n    \r\n    // Position relative to canvas container\r\n    const rect = this.canvasContainer.getBoundingClientRect();\r\n    const left = clientX - rect.left;\r\n    const top = clientY - rect.top;\r\n    \r\n    this.inlineTextInput.style.left = `${left}px`;\r\n    this.inlineTextInput.style.top = `${top}px`;\r\n    \r\n    // Create editable text area\r\n    const textArea = document.createElement('div');\r\n    textArea.className = 'ie-inline-text-input';\r\n    textArea.contentEditable = 'true';\r\n    textArea.style.fontSize = `${this.textSize * this.scale}px`;\r\n    textArea.style.color = this.textColor;\r\n    textArea.setAttribute('data-placeholder', '输入文字...');\r\n    \r\n    this.inlineTextInput.appendChild(textArea);\r\n    this.canvasContainer.appendChild(this.inlineTextInput);\r\n    \r\n    // Create style bar\r\n    this.createTextStyleBar();\r\n    \r\n    // Focus and select\r\n    textArea.focus();\r\n    \r\n    // Store canvas position\r\n    (this.inlineTextInput as any).__canvasPos = canvasPos;\r\n    \r\n    // Events\r\n    textArea.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Escape') {\r\n        this.cancelInlineText();\r\n      } else if (e.key === 'Enter' && !e.shiftKey) {\r\n        e.preventDefault();\r\n        this.confirmInlineText();\r\n      }\r\n    });\r\n    \r\n    textArea.addEventListener('input', () => {\r\n      this.updateTextStyleBarPosition();\r\n    });\r\n    \r\n    // Click outside to confirm\r\n    setTimeout(() => {\r\n      document.addEventListener('pointerdown', this.handleOutsideClick);\r\n    }, 100);\r\n  }\r\n  \r\n  private handleOutsideClick = (e: PointerEvent): void => {\r\n    if (!this.inlineTextInput) return;\r\n    \r\n    const target = e.target as HTMLElement;\r\n    if (!this.inlineTextInput.contains(target) && \r\n        !this.textStyleBar?.contains(target)) {\r\n      this.confirmInlineText();\r\n    }\r\n  };\r\n  \r\n  /** Create floating text style bar */\r\n  private createTextStyleBar(): void {\r\n    if (this.textStyleBar) {\r\n      this.textStyleBar.remove();\r\n    }\r\n    \r\n    this.textStyleBar = document.createElement('div');\r\n    this.textStyleBar.className = 'ie-text-style-bar';\r\n    this.textStyleBar.innerHTML = `\r\n      <select class=\"ie-style-select\" data-input=\"font\" title=\"字体\">\r\n        <option value=\"sans-serif\">默认</option>\r\n        <option value=\"serif\">衬线</option>\r\n        <option value=\"monospace\">等宽</option>\r\n        <option value=\"cursive\">手写</option>\r\n        <option value=\"'Microsoft YaHei', sans-serif\">微软雅黑</option>\r\n        <option value=\"'SimSun', serif\">宋体</option>\r\n        <option value=\"'KaiTi', serif\">楷体</option>\r\n      </select>\r\n      <span class=\"ie-style-divider\"></span>\r\n      <button class=\"ie-style-btn\" data-action=\"size-dec\" title=\"减小字号\">${icons.minus}</button>\r\n      <span class=\"ie-style-value\" data-value=\"size\">${this.textSize}</span>\r\n      <button class=\"ie-style-btn\" data-action=\"size-inc\" title=\"增大字号\">${icons.plus}</button>\r\n      <span class=\"ie-style-divider\"></span>\r\n      <button class=\"ie-style-btn ${this.textBold ? 'active' : ''}\" data-action=\"bold\" title=\"粗体\">${icons.bold}</button>\r\n      <button class=\"ie-style-btn ${this.textItalic ? 'active' : ''}\" data-action=\"italic\" title=\"斜体\">${icons.italic}</button>\r\n      <button class=\"ie-style-btn ${this.textUnderline ? 'active' : ''}\" data-action=\"underline\" title=\"下划线\">${icons.underline}</button>\r\n      <span class=\"ie-style-divider\"></span>\r\n      <input type=\"color\" class=\"ie-style-color\" value=\"${this.textColor}\" data-input=\"color\" title=\"文字颜色\">\r\n      <span class=\"ie-style-divider\"></span>\r\n      <button class=\"ie-style-btn ie-style-confirm\" data-action=\"confirm\" title=\"确认\">${icons.check}</button>\r\n    `;\r\n    \r\n    // Set current font\r\n    const fontSelect = this.textStyleBar.querySelector('[data-input=\"font\"]') as HTMLSelectElement;\r\n    if (fontSelect) fontSelect.value = this.textFontFamily;\r\n    \r\n    // Bind events\r\n    fontSelect?.addEventListener('change', (e) => {\r\n      e.stopPropagation();\r\n      this.textFontFamily = (e.target as HTMLSelectElement).value;\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"size-dec\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textSize = Math.max(12, this.textSize - 2);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"size-inc\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textSize = Math.min(72, this.textSize + 2);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"bold\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textBold = !this.textBold;\r\n      (e.target as HTMLElement).closest('.ie-style-btn')?.classList.toggle('active', this.textBold);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"italic\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textItalic = !this.textItalic;\r\n      (e.target as HTMLElement).closest('.ie-style-btn')?.classList.toggle('active', this.textItalic);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"underline\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textUnderline = !this.textUnderline;\r\n      (e.target as HTMLElement).closest('.ie-style-btn')?.classList.toggle('active', this.textUnderline);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-input=\"color\"]')?.addEventListener('input', (e) => {\r\n      e.stopPropagation();\r\n      this.textColor = (e.target as HTMLInputElement).value;\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"confirm\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.confirmInlineText();\r\n    });\r\n    \r\n    this.canvasContainer.appendChild(this.textStyleBar);\r\n    this.updateTextStyleBarPosition();\r\n  }\r\n  \r\n  /** Update style bar position */\r\n  private updateTextStyleBarPosition(): void {\r\n    if (!this.textStyleBar || !this.inlineTextInput) return;\r\n    \r\n    const rect = this.inlineTextInput.getBoundingClientRect();\r\n    const containerRect = this.canvasContainer.getBoundingClientRect();\r\n    \r\n    let left = rect.left - containerRect.left;\r\n    let top = rect.top - containerRect.top - 40;\r\n    \r\n    // Keep within bounds\r\n    if (top < 5) top = rect.bottom - containerRect.top + 5;\r\n    if (left < 5) left = 5;\r\n    \r\n    this.textStyleBar.style.left = `${left}px`;\r\n    this.textStyleBar.style.top = `${top}px`;\r\n  }\r\n  \r\n  /** Update text style bar values */\r\n  private updateTextStyleBar(): void {\r\n    if (!this.textStyleBar) return;\r\n    \r\n    const sizeEl = this.textStyleBar.querySelector('[data-value=\"size\"]');\r\n    const colorInput = this.textStyleBar.querySelector('[data-input=\"color\"]') as HTMLInputElement;\r\n    \r\n    if (sizeEl) sizeEl.textContent = String(this.textSize);\r\n    if (colorInput) colorInput.value = this.textColor;\r\n  }\r\n  \r\n  /** Apply text style to current editing text */\r\n  private applyTextStyle(): void {\r\n    if (!this.inlineTextInput) return;\r\n    \r\n    const textArea = this.inlineTextInput.querySelector('.ie-inline-text-input') as HTMLElement;\r\n    if (textArea) {\r\n      textArea.style.fontSize = `${this.textSize * this.scale}px`;\r\n      textArea.style.color = this.textColor;\r\n      textArea.style.fontFamily = this.textFontFamily;\r\n      textArea.style.fontWeight = this.textBold ? 'bold' : 'normal';\r\n      textArea.style.fontStyle = this.textItalic ? 'italic' : 'normal';\r\n      textArea.style.textDecoration = this.textUnderline ? 'underline' : 'none';\r\n    }\r\n  }\r\n  \r\n  /** Cancel inline text editing */\r\n  private cancelInlineText(): void {\r\n    document.removeEventListener('pointerdown', this.handleOutsideClick);\r\n    \r\n    if (this.inlineTextInput) {\r\n      this.inlineTextInput.remove();\r\n      this.inlineTextInput = null;\r\n    }\r\n    if (this.textStyleBar) {\r\n      this.textStyleBar.remove();\r\n      this.textStyleBar = null;\r\n    }\r\n    this.isAddingText = false;\r\n  }\r\n  \r\n  /** Confirm and add text to canvas */\r\n  private confirmInlineText(): void {\r\n    if (!this.inlineTextInput) return;\r\n    \r\n    const textArea = this.inlineTextInput.querySelector('.ie-inline-text-input') as HTMLElement;\r\n    const text = textArea?.textContent?.trim() || '';\r\n    const canvasPos = (this.inlineTextInput as any).__canvasPos as { x: number; y: number };\r\n    \r\n    document.removeEventListener('pointerdown', this.handleOutsideClick);\r\n    \r\n    if (text && canvasPos) {\r\n      // Draw text directly to canvas with all style options\r\n      const ctx = this.editor.ctx;\r\n      if (ctx) {\r\n        ctx.save();\r\n        const fontStyle = this.textItalic ? 'italic' : 'normal';\r\n        const fontWeight = this.textBold ? 'bold' : 'normal';\r\n        ctx.font = `${fontStyle} ${fontWeight} ${this.textSize}px ${this.textFontFamily}`;\r\n        ctx.fillStyle = this.textColor;\r\n        ctx.textBaseline = 'top';\r\n        ctx.fillText(text, canvasPos.x, canvasPos.y);\r\n        \r\n        // Draw underline if enabled\r\n        if (this.textUnderline) {\r\n          const metrics = ctx.measureText(text);\r\n          ctx.strokeStyle = this.textColor;\r\n          ctx.lineWidth = Math.max(1, this.textSize / 15);\r\n          ctx.beginPath();\r\n          ctx.moveTo(canvasPos.x, canvasPos.y + this.textSize + 2);\r\n          ctx.lineTo(canvasPos.x + metrics.width, canvasPos.y + this.textSize + 2);\r\n          ctx.stroke();\r\n        }\r\n        ctx.restore();\r\n        \r\n        // Save to history\r\n        this.saveOriginalImage();\r\n        (this.editor as any).saveToHistory?.('add text');\r\n      }\r\n    }\r\n    \r\n    // Cleanup\r\n    if (this.inlineTextInput) {\r\n      this.inlineTextInput.remove();\r\n      this.inlineTextInput = null;\r\n    }\r\n    if (this.textStyleBar) {\r\n      this.textStyleBar.remove();\r\n      this.textStyleBar = null;\r\n    }\r\n    this.isAddingText = false;\r\n  }\r\n\r\n  // ============ Crop Tool ============\r\n  \r\n  /** Toggle crop tool */\r\n  private toggleCropTool(): void {\r\n    if (this.isCropActive) {\r\n      this.hideCropOverlay();\r\n    } else {\r\n      this.showCropOverlay();\r\n    }\r\n    this.isCropActive = !this.isCropActive;\r\n    this.buttons.get('crop')?.classList.toggle('active', this.isCropActive);\r\n    \r\n    // Show/hide crop action buttons in toolbar\r\n    const cropActionGroup = this.groups.get('cropAction');\r\n    if (cropActionGroup) {\r\n      cropActionGroup.style.display = this.isCropActive ? 'flex' : 'none';\r\n    }\r\n    \r\n    // Update divider visibility\r\n    this.updateDividerVisibility(this.options.disabledTools || []);\r\n  }\r\n  \r\n  /** Show crop overlay */\r\n  private showCropOverlay(): void {\r\n    if (this.cropOverlay) return;\r\n    \r\n    const canvas = this.editor.canvas;\r\n    \r\n    this.cropOverlay = document.createElement('div');\r\n    this.cropOverlay.className = 'ie-crop-overlay';\r\n    \r\n    // Initialize crop box at 80% of canvas size, centered\r\n    const margin = 0.1;\r\n    const boxWidth = canvas.width * (1 - margin * 2);\r\n    const boxHeight = canvas.height * (1 - margin * 2);\r\n    const boxX = canvas.width * margin;\r\n    const boxY = canvas.height * margin;\r\n    \r\n    this.cropOverlay.innerHTML = `\r\n      <div class=\"ie-crop-mask ie-crop-mask-top\"></div>\r\n      <div class=\"ie-crop-mask ie-crop-mask-left\"></div>\r\n      <div class=\"ie-crop-mask ie-crop-mask-right\"></div>\r\n      <div class=\"ie-crop-mask ie-crop-mask-bottom\"></div>\r\n      <div class=\"ie-crop-box\" style=\"left:${boxX}px;top:${boxY}px;width:${boxWidth}px;height:${boxHeight}px;\">\r\n        <div class=\"ie-crop-grid\">\r\n          <div class=\"ie-crop-grid-h\"></div>\r\n          <div class=\"ie-crop-grid-h\"></div>\r\n          <div class=\"ie-crop-grid-v\"></div>\r\n          <div class=\"ie-crop-grid-v\"></div>\r\n        </div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-nw\" data-handle=\"nw\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-n\" data-handle=\"n\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-ne\" data-handle=\"ne\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-e\" data-handle=\"e\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-se\" data-handle=\"se\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-s\" data-handle=\"s\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-sw\" data-handle=\"sw\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-w\" data-handle=\"w\"></div>\r\n      </div>\r\n      <div class=\"ie-crop-actions\">\r\n        <button class=\"ie-crop-btn ie-crop-btn-cancel\" data-action=\"cancel\">取消</button>\r\n        <button class=\"ie-crop-btn ie-crop-btn-apply\" data-action=\"apply\">\r\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"20 6 9 17 4 12\"/></svg>\r\n          裁剪\r\n        </button>\r\n      </div>\r\n    `;\r\n    \r\n    // Add to viewport\r\n    this.viewport.appendChild(this.cropOverlay);\r\n    \r\n    // Setup crop events\r\n    this.setupCropEvents();\r\n  }\r\n  \r\n  /** Setup crop overlay events */\r\n  private setupCropEvents(): void {\r\n    if (!this.cropOverlay) return;\r\n    \r\n    const cropBox = this.cropOverlay.querySelector('.ie-crop-box') as HTMLElement;\r\n    let isDragging = false;\r\n    let isResizing = false;\r\n    let activeHandle = '';\r\n    let startX = 0, startY = 0;\r\n    let startLeft = 0, startTop = 0, startWidth = 0, startHeight = 0;\r\n    \r\n    // Handle drag\r\n    cropBox.addEventListener('pointerdown', (e) => {\r\n      if ((e.target as HTMLElement).classList.contains('ie-crop-handle')) return;\r\n      e.stopPropagation();\r\n      isDragging = true;\r\n      startX = e.clientX;\r\n      startY = e.clientY;\r\n      startLeft = cropBox.offsetLeft;\r\n      startTop = cropBox.offsetTop;\r\n      cropBox.setPointerCapture(e.pointerId);\r\n    });\r\n    \r\n    // Handle resize\r\n    this.cropOverlay.querySelectorAll('.ie-crop-handle').forEach(handle => {\r\n      handle.addEventListener('pointerdown', (e) => {\r\n        e.stopPropagation();\r\n        isResizing = true;\r\n        activeHandle = (e.target as HTMLElement).getAttribute('data-handle') || '';\r\n        startX = (e as PointerEvent).clientX;\r\n        startY = (e as PointerEvent).clientY;\r\n        startLeft = cropBox.offsetLeft;\r\n        startTop = cropBox.offsetTop;\r\n        startWidth = cropBox.offsetWidth;\r\n        startHeight = cropBox.offsetHeight;\r\n        (handle as HTMLElement).setPointerCapture((e as PointerEvent).pointerId);\r\n      });\r\n    });\r\n    \r\n    // Move handler\r\n    this.cropOverlay.addEventListener('pointermove', (e) => {\r\n      if (!isDragging && !isResizing) return;\r\n      \r\n      const dx = (e.clientX - startX) / this.scale;\r\n      const dy = (e.clientY - startY) / this.scale;\r\n      const canvas = this.editor.canvas;\r\n      \r\n      if (isDragging) {\r\n        let newLeft = startLeft + dx;\r\n        let newTop = startTop + dy;\r\n        // Constrain to canvas bounds\r\n        newLeft = Math.max(0, Math.min(newLeft, canvas.width - cropBox.offsetWidth));\r\n        newTop = Math.max(0, Math.min(newTop, canvas.height - cropBox.offsetHeight));\r\n        cropBox.style.left = `${newLeft}px`;\r\n        cropBox.style.top = `${newTop}px`;\r\n      } else if (isResizing) {\r\n        let newLeft = startLeft, newTop = startTop, newWidth = startWidth, newHeight = startHeight;\r\n        \r\n        if (activeHandle.includes('e')) { newWidth = Math.max(50, startWidth + dx); }\r\n        if (activeHandle.includes('w')) { newWidth = Math.max(50, startWidth - dx); newLeft = startLeft + dx; }\r\n        if (activeHandle.includes('s')) { newHeight = Math.max(50, startHeight + dy); }\r\n        if (activeHandle.includes('n')) { newHeight = Math.max(50, startHeight - dy); newTop = startTop + dy; }\r\n        \r\n        // Constrain to canvas bounds\r\n        if (newLeft < 0) { newWidth += newLeft; newLeft = 0; }\r\n        if (newTop < 0) { newHeight += newTop; newTop = 0; }\r\n        if (newLeft + newWidth > canvas.width) newWidth = canvas.width - newLeft;\r\n        if (newTop + newHeight > canvas.height) newHeight = canvas.height - newTop;\r\n        \r\n        cropBox.style.left = `${newLeft}px`;\r\n        cropBox.style.top = `${newTop}px`;\r\n        cropBox.style.width = `${newWidth}px`;\r\n        cropBox.style.height = `${newHeight}px`;\r\n      }\r\n      \r\n      this.updateCropMask();\r\n    });\r\n    \r\n    // End handler\r\n    this.cropOverlay.addEventListener('pointerup', () => {\r\n      isDragging = false;\r\n      isResizing = false;\r\n      activeHandle = '';\r\n    });\r\n    \r\n    // Control buttons\r\n    this.cropOverlay.querySelector('[data-action=\"cancel\"]')?.addEventListener('click', () => {\r\n      this.toggleCropTool();\r\n    });\r\n    \r\n    this.cropOverlay.querySelector('[data-action=\"apply\"]')?.addEventListener('click', () => {\r\n      this.applyCrop();\r\n    });\r\n    \r\n    // Initial mask update\r\n    this.updateCropMask();\r\n  }\r\n  \r\n  /** Update crop mask to show cropped area */\r\n  private updateCropMask(): void {\r\n    if (!this.cropOverlay) return;\r\n    const cropBox = this.cropOverlay.querySelector('.ie-crop-box') as HTMLElement;\r\n    if (!cropBox) return;\r\n    \r\n    const canvas = this.editor.canvas;\r\n    const left = cropBox.offsetLeft;\r\n    const top = cropBox.offsetTop;\r\n    const width = cropBox.offsetWidth;\r\n    const height = cropBox.offsetHeight;\r\n    \r\n    // Update 4 mask blocks to surround the crop box\r\n    const maskTop = this.cropOverlay.querySelector('.ie-crop-mask-top') as HTMLElement;\r\n    const maskLeft = this.cropOverlay.querySelector('.ie-crop-mask-left') as HTMLElement;\r\n    const maskRight = this.cropOverlay.querySelector('.ie-crop-mask-right') as HTMLElement;\r\n    const maskBottom = this.cropOverlay.querySelector('.ie-crop-mask-bottom') as HTMLElement;\r\n    \r\n    if (maskTop) {\r\n      maskTop.style.cssText = `left:0;top:0;width:${canvas.width}px;height:${top}px;`;\r\n    }\r\n    if (maskLeft) {\r\n      maskLeft.style.cssText = `left:0;top:${top}px;width:${left}px;height:${height}px;`;\r\n    }\r\n    if (maskRight) {\r\n      maskRight.style.cssText = `left:${left + width}px;top:${top}px;width:${canvas.width - left - width}px;height:${height}px;`;\r\n    }\r\n    if (maskBottom) {\r\n      maskBottom.style.cssText = `left:0;top:${top + height}px;width:${canvas.width}px;height:${canvas.height - top - height}px;`;\r\n    }\r\n  }\r\n  \r\n  /** Apply crop to canvas */\r\n  private applyCrop(): void {\r\n    if (!this.cropOverlay) return;\r\n    const cropBox = this.cropOverlay.querySelector('.ie-crop-box') as HTMLElement;\r\n    if (!cropBox) return;\r\n    \r\n    const x = cropBox.offsetLeft;\r\n    const y = cropBox.offsetTop;\r\n    const width = cropBox.offsetWidth;\r\n    const height = cropBox.offsetHeight;\r\n    \r\n    // Get cropped image data\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    // Save current state to history BEFORE crop (so we can undo)\r\n    (this.editor as any).saveToHistory?.('before crop');\r\n    \r\n    // Fade out entire crop overlay\r\n    this.cropOverlay.style.transition = 'opacity 0.25s ease-out';\r\n    this.cropOverlay.style.opacity = '0';\r\n    \r\n    // After fade out, apply the actual crop\r\n    setTimeout(() => {\r\n      const croppedData = ctx.getImageData(x, y, width, height);\r\n      \r\n      // Resize canvas\r\n      canvas.width = width;\r\n      canvas.height = height;\r\n      \r\n      // Draw cropped image\r\n      ctx.putImageData(croppedData, 0, 0);\r\n      \r\n      // Update original image data\r\n      this.saveOriginalImage();\r\n      this.savePureImage();\r\n      \r\n      // Hide crop overlay (no animation since already faded)\r\n      if (this.cropOverlay) {\r\n        this.cropOverlay.remove();\r\n        this.cropOverlay = null;\r\n      }\r\n      this.isCropActive = false;\r\n      this.buttons.get('crop')?.classList.remove('active');\r\n      \r\n      // Hide crop action buttons in toolbar\r\n      const cropActionGroup = this.groups.get('cropAction');\r\n      if (cropActionGroup) {\r\n        cropActionGroup.style.display = 'none';\r\n      }\r\n      \r\n      // Update divider visibility\r\n      this.updateDividerVisibility(this.options.disabledTools || []);\r\n      \r\n      // Reset view with animation\r\n      this.viewport.style.transition = 'transform 0.3s ease-out';\r\n      this.resetView();\r\n      \r\n      // Remove transition after animation\r\n      setTimeout(() => {\r\n        this.viewport.style.transition = 'none';\r\n      }, 300);\r\n    }, 250);\r\n  }\r\n  \r\n  /** Hide crop overlay */\r\n  private hideCropOverlay(): void {\r\n    if (this.cropOverlay) {\r\n      // Add fade out animation\r\n      this.cropOverlay.style.transition = 'opacity 0.2s ease-out';\r\n      this.cropOverlay.style.opacity = '0';\r\n      \r\n      setTimeout(() => {\r\n        if (this.cropOverlay) {\r\n          this.cropOverlay.remove();\r\n          this.cropOverlay = null;\r\n        }\r\n      }, 200);\r\n    }\r\n  }\r\n\r\n  // ============ Filter Tool ============\r\n  \r\n  /** Toggle filter panel */\r\n  private toggleFilterPanel(): void {\r\n    const filterPanel = this.panels.get('filter');\r\n    if (!filterPanel) return;\r\n    \r\n    if (this.activePanel === 'filter') {\r\n      this.showPanel(null);\r\n      this.buttons.get('filter')?.classList.remove('active');\r\n    } else {\r\n      this.showPanel('filter');\r\n      this.buttons.get('filter')?.classList.add('active');\r\n    }\r\n  }\r\n\r\n  // ============ Eraser Tool ============\r\n  \r\n  /** Apply eraser at position - restores original image pixels */\r\n  private applyEraserAt(x: number, y: number): void {\r\n    if (this.eraserMode === 'shape') {\r\n      // Shape mode: delete shape under cursor\r\n      const shape = this.shapeManager.findShapeAtPoint(x, y, this.eraserSize / 2);\r\n      if (shape) {\r\n        this.shapeManager.deleteShape(shape.id);\r\n      }\r\n    } else {\r\n      // Pixel mode: restore original image pixels in the eraser area\r\n      this.restoreOriginalPixels(x, y, this.eraserSize / 2);\r\n    }\r\n  }\r\n  \r\n  /** Restore original image pixels in a circular area */\r\n  private restoreOriginalPixels(cx: number, cy: number, radius: number): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    const pureData = this.pureImageData;\r\n    \r\n    if (!ctx || !canvas || !pureData) {\r\n      console.warn('[Eraser] Missing required data, skipping restore');\r\n      return;\r\n    }\r\n    \r\n    const radiusSq = radius * radius;\r\n    const minX = Math.max(0, Math.floor(cx - radius));\r\n    const maxX = Math.min(canvas.width - 1, Math.ceil(cx + radius));\r\n    const minY = Math.max(0, Math.floor(cy - radius));\r\n    const maxY = Math.min(canvas.height - 1, Math.ceil(cy + radius));\r\n    \r\n    const regionWidth = maxX - minX + 1;\r\n    const regionHeight = maxY - minY + 1;\r\n    \r\n    if (regionWidth <= 0 || regionHeight <= 0) return;\r\n    \r\n    // Get current canvas data\r\n    const currentData = ctx.getImageData(minX, minY, regionWidth, regionHeight);\r\n    const currentPixels = currentData.data;\r\n    const purePixels = pureData.data;\r\n    const pureWidth = pureData.width;\r\n    \r\n    let pixelsChanged = 0;\r\n    \r\n    // Restore pixels within the circle\r\n    for (let py = minY; py <= maxY; py++) {\r\n      for (let px = minX; px <= maxX; px++) {\r\n        const dx = px - cx;\r\n        const dy = py - cy;\r\n        const distSq = dx * dx + dy * dy;\r\n        \r\n        if (distSq <= radiusSq) {\r\n          // Inside the eraser circle - restore from pure image\r\n          const pureIdx = (py * pureWidth + px) * 4;\r\n          const currentIdx = ((py - minY) * regionWidth + (px - minX)) * 4;\r\n          \r\n          // Check if pixel is different\r\n          if (currentPixels[currentIdx] !== purePixels[pureIdx] ||\r\n              currentPixels[currentIdx + 1] !== purePixels[pureIdx + 1] ||\r\n              currentPixels[currentIdx + 2] !== purePixels[pureIdx + 2] ||\r\n              currentPixels[currentIdx + 3] !== purePixels[pureIdx + 3]) {\r\n            pixelsChanged++;\r\n          }\r\n          \r\n          // Apply smooth edge (anti-aliasing)\r\n          const dist = Math.sqrt(distSq);\r\n          const edgeFade = Math.min(1, (radius - dist) / 2);\r\n          \r\n          if (edgeFade >= 1) {\r\n            // Full restore\r\n            currentPixels[currentIdx] = purePixels[pureIdx];\r\n            currentPixels[currentIdx + 1] = purePixels[pureIdx + 1];\r\n            currentPixels[currentIdx + 2] = purePixels[pureIdx + 2];\r\n            currentPixels[currentIdx + 3] = purePixels[pureIdx + 3];\r\n          } else {\r\n            // Blend for smooth edges\r\n            currentPixels[currentIdx] = Math.round(currentPixels[currentIdx] * (1 - edgeFade) + purePixels[pureIdx] * edgeFade);\r\n            currentPixels[currentIdx + 1] = Math.round(currentPixels[currentIdx + 1] * (1 - edgeFade) + purePixels[pureIdx + 1] * edgeFade);\r\n            currentPixels[currentIdx + 2] = Math.round(currentPixels[currentIdx + 2] * (1 - edgeFade) + purePixels[pureIdx + 2] * edgeFade);\r\n            currentPixels[currentIdx + 3] = Math.round(currentPixels[currentIdx + 3] * (1 - edgeFade) + purePixels[pureIdx + 3] * edgeFade);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (pixelsChanged > 0) {\r\n      console.log('[Eraser] Restoring', pixelsChanged, 'different pixels');\r\n    }\r\n    \r\n    ctx.putImageData(currentData, minX, minY);\r\n  }\r\n  \r\n  /** Interpolate eraser stroke */\r\n  private interpolateEraser(x1: number, y1: number, x2: number, y2: number): void {\r\n    const dist = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);\r\n    const step = Math.max(1, this.eraserSize / 6); // Smaller step for smoother strokes\r\n    const steps = Math.max(1, Math.ceil(dist / step));\r\n    \r\n    for (let i = 0; i <= steps; i++) {\r\n      const t = i / steps;\r\n      const x = x1 + (x2 - x1) * t;\r\n      const y = y1 + (y2 - y1) * t;\r\n      this.applyEraserAt(x, y);\r\n    }\r\n  }\r\n\r\n  // Zoom methods\r\n  private setScale(newScale: number, clientX?: number, clientY?: number): void {\r\n    newScale = Math.max(0.1, Math.min(5, newScale));\r\n    \r\n    if (clientX !== undefined && clientY !== undefined) {\r\n      const rect = this.canvasContainer.getBoundingClientRect();\r\n      const mouseX = clientX - rect.left - rect.width / 2;\r\n      const mouseY = clientY - rect.top - rect.height / 2;\r\n      \r\n      const scaleDiff = newScale - this.scale;\r\n      this.translateX -= mouseX * scaleDiff / this.scale;\r\n      this.translateY -= mouseY * scaleDiff / this.scale;\r\n    }\r\n    \r\n    this.scale = newScale;\r\n    this.updateTransform();\r\n  }\r\n\r\n  private updateTransform(): void {\r\n    this.viewport.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;\r\n    const percent = Math.round(this.scale * 100);\r\n    if (this.zoomText) this.zoomText.textContent = `${percent}%`;\r\n    this.zoomBadge.textContent = `${percent}%`;\r\n    // Update brush cursor size based on new scale\r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  private zoomIn(): void {\r\n    this.setScale(this.scale * 1.25);\r\n  }\r\n\r\n  private zoomOut(): void {\r\n    this.setScale(this.scale / 1.25);\r\n  }\r\n\r\n  private resetView(): void {\r\n    this.scale = 1;\r\n    this.translateX = 0;\r\n    this.translateY = 0;\r\n    this.updateTransform();\r\n  }\r\n\r\n  private async exportImage(): Promise<void> {\r\n    try {\r\n      const data = await this.editor.export({\r\n        format: 'png',\r\n        quality: 0.95,\r\n        type: 'base64',\r\n      });\r\n      \r\n      const link = document.createElement('a');\r\n      link.href = data as string;\r\n      link.download = `image-${Date.now()}.png`;\r\n      link.click();\r\n    } catch (err) {\r\n      console.error('Export failed:', err);\r\n    }\r\n  }\r\n\r\n  /** Apply theme to editor */\r\n  private applyTheme(theme: 'light' | 'dark' | 'auto'): void {\r\n    let resolvedTheme: 'light' | 'dark' = theme === 'auto' \r\n      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')\r\n      : theme;\r\n    \r\n    this.wrapper.classList.remove('ie-theme-light', 'ie-theme-dark');\r\n    this.wrapper.classList.add(`ie-theme-${resolvedTheme}`);\r\n  }\r\n  \r\n  /** Set theme at runtime */\r\n  setTheme(theme: 'light' | 'dark' | 'auto'): void {\r\n    this.options.theme = theme;\r\n    this.applyTheme(theme);\r\n    \r\n    // Update placeholder if showing\r\n    if (!this.hasRealImage) {\r\n      this.showPlaceholder();\r\n    }\r\n  }\r\n  \r\n  /** Apply primary color */\r\n  private applyPrimaryColor(color: string): void {\r\n    this.wrapper.style.setProperty('--ie-primary', color);\r\n    this.wrapper.style.setProperty('--ie-btn-active-bg', color);\r\n  }\r\n  \r\n  /** Set primary color at runtime */\r\n  setPrimaryColor(color: string): void {\r\n    this.options.primaryColor = color;\r\n    this.applyPrimaryColor(color);\r\n  }\r\n  \r\n  /** Get current theme */\r\n  getTheme(): 'light' | 'dark' | 'auto' {\r\n    return this.options.theme || 'dark';\r\n  }\r\n  \r\n  /** Update disabled tools list at runtime */\r\n  setDisabledTools(disabledTools: ToolName[]): void {\r\n    this.options.disabledTools = disabledTools;\r\n    \r\n    // All toggleable buttons\r\n    const allToggleableButtons: ToolName[] = [\r\n      'move', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'text', 'mosaic', 'eraser', 'crop', 'filter',  // Drawing tools\r\n      'zoomIn', 'zoomOut', 'reset',  // Zoom controls\r\n      'undo', 'redo',  // History controls\r\n      'export',  // Export button\r\n    ];\r\n    \r\n    for (const btnName of allToggleableButtons) {\r\n      const btn = this.buttons.get(btnName);\r\n      if (btn) {\r\n        if (disabledTools.includes(btnName)) {\r\n          btn.style.display = 'none';\r\n        } else {\r\n          btn.style.display = '';\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Handle zoom text visibility (shown only if any zoom button is visible)\r\n    if (this.zoomText) {\r\n      const zoomHidden = disabledTools.includes('zoomIn') && \r\n                         disabledTools.includes('zoomOut') && \r\n                         disabledTools.includes('reset');\r\n      this.zoomText.style.display = zoomHidden ? 'none' : '';\r\n    }\r\n    \r\n    // If current tool is now disabled, close its panel\r\n    if (this.activePanel) {\r\n      const panel = this.panels.get(this.activePanel);\r\n      if (panel) {\r\n        panel.style.display = 'none';\r\n      }\r\n      this.activePanel = null;\r\n    }\r\n    \r\n    // If current tool is now disabled, switch to move tool (if move is available)\r\n    if (this.currentTool && disabledTools.includes(this.currentTool as ToolName)) {\r\n      if (!disabledTools.includes('move')) {\r\n        this.selectTool(null);\r\n      } else {\r\n        this.currentTool = null;\r\n      }\r\n    }\r\n    \r\n    // Update divider visibility based on adjacent groups\r\n    this.updateDividerVisibility(disabledTools);\r\n  }\r\n  \r\n  /** Update divider visibility to avoid empty dividers between hidden groups */\r\n  private updateDividerVisibility(disabledTools: ToolName[]): void {\r\n    // Define which tools belong to which group\r\n    const groupTools: Record<string, ToolName[]> = {\r\n      zoom: ['zoomIn', 'zoomOut', 'reset'],\r\n      tool: ['move', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'text', 'mosaic', 'eraser'],\r\n      advanced: ['crop', 'filter'],\r\n      history: ['undo', 'redo'],\r\n      cropAction: [], // Special group, always hidden by default unless crop mode is active\r\n    };\r\n    \r\n    // Check if a group has any visible tools\r\n    const isGroupVisible = (groupName: string): boolean => {\r\n      // cropAction group is special - it's controlled separately\r\n      if (groupName === 'cropAction') {\r\n        const cropActionGroup = this.groups.get('cropAction');\r\n        return cropActionGroup ? cropActionGroup.style.display !== 'none' : false;\r\n      }\r\n      \r\n      const tools = groupTools[groupName];\r\n      if (!tools || tools.length === 0) return false;\r\n      return tools.some(tool => !disabledTools.includes(tool));\r\n    };\r\n    \r\n    // Check if export button is visible\r\n    const isExportVisible = !disabledTools.includes('export');\r\n    \r\n    // Dividers layout:\r\n    // [zoomGroup] [divider0] [toolGroup] [advancedGroup] [divider1] [panels] [historyGroup] [divider2] [cropActionGroup] [divider3] [export]\r\n    \r\n    // divider0: visible if zoom group AND (tool group OR advanced group) are visible\r\n    const zoomVisible = isGroupVisible('zoom');\r\n    const toolOrAdvancedVisible = isGroupVisible('tool') || isGroupVisible('advanced');\r\n    if (this.dividers[0]) {\r\n      this.dividers[0].style.display = (zoomVisible && toolOrAdvancedVisible) ? '' : 'none';\r\n    }\r\n    \r\n    // divider1: visible if (tool group OR advanced group) AND history group are visible\r\n    const historyVisible = isGroupVisible('history');\r\n    if (this.dividers[1]) {\r\n      this.dividers[1].style.display = (toolOrAdvancedVisible && historyVisible) ? '' : 'none';\r\n    }\r\n    \r\n    // divider2: visible if history group AND (cropAction group OR export) are visible\r\n    const cropActionVisible = isGroupVisible('cropAction');\r\n    if (this.dividers[2]) {\r\n      this.dividers[2].style.display = (historyVisible && (cropActionVisible || isExportVisible)) ? '' : 'none';\r\n    }\r\n    \r\n    // divider3: visible if cropAction group AND export are visible\r\n    if (this.dividers[3]) {\r\n      this.dividers[3].style.display = (cropActionVisible && isExportVisible) ? '' : 'none';\r\n    }\r\n  }\r\n  \r\n  /** Get current disabled tools */\r\n  getDisabledTools(): ToolName[] {\r\n    return this.options.disabledTools || [];\r\n  }\r\n\r\n  // ============ Shape Layer Rendering ============\r\n  \r\n  /** Save the current canvas state as original image (called after image load or flatten) */\r\n  saveOriginalImage(): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (ctx && canvas) {\r\n      this.originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    }\r\n  }\r\n  \r\n  /** Render original image + all shapes from manager */\r\n  private renderAll(): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    // If we have original image data, restore it first\r\n    if (this.originalImageData) {\r\n      ctx.putImageData(this.originalImageData, 0, 0);\r\n    } else {\r\n      // Otherwise just clear canvas with white background\r\n      ctx.fillStyle = '#ffffff';\r\n      ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n    }\r\n    \r\n    // Render all shapes from shape manager\r\n    this.shapeManager.render(ctx);\r\n  }\r\n  \r\n  /** Flatten all shapes into the original image (makes them permanent) */\r\n  flattenShapes(): void {\r\n    this.renderAll();\r\n    this.saveOriginalImage();\r\n    this.shapeManager.clear();\r\n  }\r\n  \r\n  /** Get the shape layer manager */\r\n  getShapeManager(): ShapeLayerManager {\r\n    return this.shapeManager;\r\n  }\r\n  \r\n  // ============ Toolbar Visibility ============\r\n  \r\n  /** Set toolbar visibility with animation */\r\n  setToolbarVisible(visible: boolean): void {\r\n    if (visible) {\r\n      this.toolbar.classList.remove('ie-toolbar-hidden');\r\n      this.zoomBadge.classList.remove('ie-zoom-badge-hidden');\r\n    } else {\r\n      this.toolbar.classList.add('ie-toolbar-hidden');\r\n      this.zoomBadge.classList.add('ie-zoom-badge-hidden');\r\n    }\r\n    this.hasRealImage = visible;\r\n  }\r\n  \r\n  /** Check if toolbar is visible */\r\n  isToolbarVisible(): boolean {\r\n    return !this.toolbar.classList.contains('ie-toolbar-hidden');\r\n  }\r\n  \r\n  /** Check if current image is placeholder */\r\n  hasImage(): boolean {\r\n    return this.hasRealImage;\r\n  }\r\n  \r\n  /** Generate and load placeholder image */\r\n  showPlaceholder(): void {\r\n    const theme = this.options.theme === 'auto'\r\n      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')\r\n      : (this.options.theme || 'dark');\r\n    \r\n    // Calculate placeholder size - fill the entire container\r\n    let width = this.options.placeholderWidth;\r\n    let height = this.options.placeholderHeight;\r\n    \r\n    if (!width || !height) {\r\n      const containerRect = this.canvasContainer.getBoundingClientRect();\r\n      // Use full container size\r\n      width = Math.max(400, Math.round(containerRect.width));\r\n      height = Math.max(300, Math.round(containerRect.height));\r\n    }\r\n    \r\n    const placeholder = createPlaceholder({\r\n      width,\r\n      height,\r\n      text: this.options.placeholderText,\r\n      subText: this.options.placeholderSubText,\r\n      theme,\r\n    });\r\n    \r\n    this.hasRealImage = false;\r\n    \r\n    // Load placeholder (isUserImage=false to prevent toolbar from showing)\r\n    this.editor.loadImage(placeholder, false).then(() => {\r\n      // Keep toolbar hidden for placeholder\r\n      if (this.options.autoHide) {\r\n        this.setToolbarVisible(false);\r\n      }\r\n    });\r\n  }\r\n  \r\n  /** Called when a real image is loaded */\r\n  onImageLoaded(): void {\r\n    this.hasRealImage = true;\r\n    if (this.options.autoHide) {\r\n      this.setToolbarVisible(true);\r\n    }\r\n    // Save pure image data first (before any annotations)\r\n    this.savePureImage();\r\n    this.saveOriginalImage();\r\n  }\r\n  \r\n  /** Save the pure original image (without any annotations) - for eraser tool */\r\n  private savePureImage(): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (ctx && canvas) {\r\n      this.pureImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    }\r\n  }\r\n\r\n  destroy(): void {\r\n    this.wrapper.remove();\r\n    this.panels.clear();\r\n    this.buttons.clear();\r\n    this.shapeManager.clear();\r\n  }\r\n}\r\n","/**\r\n * Editor class - Main image editor implementation\r\n * Requirements: 1.1, 1.2, 1.3, 1.4, 1.5\r\n */\r\n\r\nimport { Canvas } from './Canvas';\r\nimport { EventManager } from '../managers/EventManager';\r\nimport { HistoryManager } from '../managers/HistoryManager';\r\nimport { PluginManager } from '../managers/PluginManager';\r\nimport { ConfigManager } from '../managers/ConfigManager';\r\nimport { getElement } from '../utils/dom.utils';\r\nimport { Toolbar } from '../ui/Toolbar';\r\nimport { injectStyles } from '../ui/toolbar.styles';\r\nimport type { EditorOptions, EditorInterface, ToolbarConfig } from '../types/editor.types';\r\nimport type { PluginConstructor, Plugin, PluginContext } from '../types/plugin.types';\r\nimport type { EditorConfig, ExportOptions, DeepPartial } from '../types/config.types';\r\nimport type { EventHandler, EventListenerOptions, EditorEvents } from '../types/event.types';\r\n\r\n/**\r\n * Editor class - Main entry point for the image editor\r\n * Requirements: 1.1, 1.2, 1.3, 1.4, 1.5\r\n */\r\nexport class Editor implements EditorInterface {\r\n  /** Canvas manager instance */\r\n  private _canvas: Canvas;\r\n  /** Event manager instance */\r\n  private _eventManager: EventManager;\r\n  /** History manager instance */\r\n  private _historyManager: HistoryManager;\r\n  /** Plugin manager instance */\r\n  private _pluginManager: PluginManager;\r\n  /** Config manager instance */\r\n  private _configManager: ConfigManager;\r\n  /** Container element */\r\n  private _container: HTMLElement;\r\n  /** Built-in toolbar instance */\r\n  private _toolbar: Toolbar | null = null;\r\n  /** Whether the editor is destroyed */\r\n  private _destroyed: boolean = false;\r\n  /** Whether the editor is ready */\r\n  private _ready: boolean = false;\r\n\r\n  /**\r\n   * Create a new Editor instance\r\n   * Requirements: 1.1, 1.3 - Initialize editor with container and config\r\n   * @param options - Editor initialization options\r\n   */\r\n  constructor(options: EditorOptions) {\r\n    // Get container element\r\n    const container = getElement(options.container);\r\n    if (!container) {\r\n      throw new Error('Container element not found');\r\n    }\r\n    this._container = container;\r\n\r\n    // Initialize config manager\r\n    const editorConfig: DeepPartial<EditorConfig> = {\r\n      width: options.width,\r\n      height: options.height,\r\n      backgroundColor: options.backgroundColor,\r\n      historyLimit: options.historyLimit,\r\n      responsive: options.responsive,\r\n      deviceType: options.deviceType,\r\n    };\r\n    this._configManager = new ConfigManager(editorConfig);\r\n\r\n    // Initialize event manager\r\n    this._eventManager = new EventManager();\r\n\r\n    // Initialize history manager\r\n    const config = this._configManager.getConfig();\r\n    this._historyManager = new HistoryManager(config.historyLimit);\r\n\r\n    // Initialize canvas\r\n    this._canvas = new Canvas(this._container, config);\r\n\r\n    // Initialize plugin manager\r\n    this._pluginManager = new PluginManager();\r\n    this._pluginManager.setContext(this.createPluginContext());\r\n\r\n    // Setup history change listener\r\n    this._historyManager.onChange((canUndo, canRedo) => {\r\n      this._eventManager.emit('history-change', { canUndo, canRedo });\r\n    });\r\n\r\n    // Setup plugin change listener\r\n    this._pluginManager.onChange((tool, prevTool) => {\r\n      this._eventManager.emit('tool-change', { tool: tool || '', prevTool });\r\n    });\r\n\r\n    // Register initial plugins\r\n    if (options.plugins) {\r\n      for (const PluginClass of options.plugins) {\r\n        this.use(PluginClass);\r\n      }\r\n    }\r\n\r\n    // Create built-in toolbar if enabled (default: true)\r\n    const toolbarOption = options.toolbar;\r\n    if (toolbarOption !== false) {\r\n      injectStyles();\r\n      const toolbarConfig: ToolbarConfig = typeof toolbarOption === 'object' ? toolbarOption : {};\r\n      this._toolbar = new Toolbar(this, this._container, {\r\n        zoom: toolbarConfig.zoom !== false,\r\n        tools: toolbarConfig.tools !== false,\r\n        history: toolbarConfig.history !== false,\r\n        export: toolbarConfig.export !== false,\r\n        theme: toolbarConfig.theme || 'dark',\r\n        primaryColor: toolbarConfig.primaryColor,\r\n        disabledTools: toolbarConfig.disabledTools,\r\n        autoHide: toolbarConfig.autoHide !== false,\r\n        placeholderText: toolbarConfig.placeholderText,\r\n        placeholderSubText: toolbarConfig.placeholderSubText,\r\n      });\r\n    }\r\n\r\n    // Load image if provided, otherwise show placeholder\r\n    if (options.image) {\r\n      this.loadImage(options.image).catch((error) => {\r\n        this._eventManager.emit('error', { error });\r\n      });\r\n    } else if (this._toolbar) {\r\n      // Show placeholder when no image provided\r\n      this._toolbar.showPlaceholder();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the canvas element\r\n   */\r\n  get canvas(): HTMLCanvasElement {\r\n    return this._canvas.canvas;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas 2D context\r\n   */\r\n  get ctx(): CanvasRenderingContext2D {\r\n    return this._canvas.ctx;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas width\r\n   */\r\n  get width(): number {\r\n    return this._canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas height\r\n   */\r\n  get height(): number {\r\n    return this._canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Get the current tool name\r\n   */\r\n  get currentTool(): string | null {\r\n    return this._pluginManager.getActiveName();\r\n  }\r\n\r\n  /**\r\n   * Check if the editor is ready\r\n   */\r\n  get isReady(): boolean {\r\n    return this._ready;\r\n  }\r\n\r\n  /**\r\n   * Check if the editor is destroyed\r\n   */\r\n  get isDestroyed(): boolean {\r\n    return this._destroyed;\r\n  }\r\n\r\n  /**\r\n   * Create plugin context\r\n   * Requirements: 2.3 - Provide editor context to plugins\r\n   */\r\n  private createPluginContext(): PluginContext {\r\n    return {\r\n      editor: this,\r\n      canvas: this._canvas.canvas,\r\n      ctx: this._canvas.ctx,\r\n      saveState: () => this.saveState(),\r\n      getImageData: () => this._canvas.getImageData(),\r\n      putImageData: (data: ImageData) => this._canvas.putImageData(data),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Save current state to history\r\n   * Requirements: 6.1 - Record operations to history stack\r\n   */\r\n  private saveState(toolName?: string, description?: string): void {\r\n    const imageData = this._canvas.getImageData();\r\n    this._historyManager.push({\r\n      imageData,\r\n      toolName: toolName || this.currentTool || 'unknown',\r\n      description,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Load an image into the editor\r\n   * Requirements: 1.1, 1.2 - Load image and trigger ready event\r\n   * @param source - Image source (URL or HTMLImageElement)\r\n   * @param isUserImage - Whether this is a user-provided image (not placeholder)\r\n   */\r\n  async loadImage(source: string | HTMLImageElement, isUserImage = true): Promise<void> {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    try {\r\n      const { width, height } = await this._canvas.loadImage(source);\r\n\r\n      // Save initial state\r\n      this.saveState('init', 'Initial state');\r\n\r\n      // Mark as ready\r\n      this._ready = true;\r\n\r\n      // Emit events\r\n      this._eventManager.emit('image-loaded', { width, height });\r\n      this._eventManager.emit('ready', { width, height });\r\n      \r\n      // Notify toolbar if this is a user image\r\n      if (isUserImage && this._toolbar) {\r\n        this._toolbar.onImageLoaded();\r\n      }\r\n    } catch (error) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      this._eventManager.emit('error', { error: err });\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register a plugin\r\n   * Requirements: 2.1 - Add plugin to available tools list\r\n   * @param PluginClass - Plugin constructor\r\n   * @returns The editor instance for chaining\r\n   */\r\n  use(PluginClass: PluginConstructor): this {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._pluginManager.register(PluginClass);\r\n    return this;\r\n  }\r\n\r\n  /** Built-in tools that are not plugins */\r\n  private static BUILTIN_TOOLS = ['', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'mosaic', 'eraser', 'text', 'crop', 'filter'];\r\n\r\n  /**\r\n   * Set the current tool\r\n   * Requirements: 2.3 - Activate plugin\r\n   * @param toolName - Tool/plugin name\r\n   */\r\n  setTool(toolName: string): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    // Only activate plugins, not built-in toolbar tools\r\n    if (!Editor.BUILTIN_TOOLS.includes(toolName)) {\r\n      this._pluginManager.activate(toolName);\r\n    } else {\r\n      // Deactivate any active plugin when switching to built-in tool\r\n      const activeName = this._pluginManager.getActiveName();\r\n      if (activeName) {\r\n        this._pluginManager.deactivate(activeName);\r\n      }\r\n      // Emit tool-change event for built-in tools\r\n      this._eventManager.emit('tool-change', { tool: toolName, prevTool: activeName });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a tool/plugin by name\r\n   * @param toolName - Tool/plugin name\r\n   * @returns Plugin instance or undefined\r\n   */\r\n  getTool(toolName: string): Plugin | undefined {\r\n    return this._pluginManager.get(toolName);\r\n  }\r\n\r\n  /**\r\n   * Undo the last operation\r\n   * Requirements: 6.2 - Restore to previous state\r\n   */\r\n  undo(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    const state = this._historyManager.undo();\r\n    if (state) {\r\n      // Restore canvas size if it changed (e.g., after crop)\r\n      const imageData = state.imageData;\r\n      if (this._canvas.width !== imageData.width || this._canvas.height !== imageData.height) {\r\n        this._canvas.canvas.width = imageData.width;\r\n        this._canvas.canvas.height = imageData.height;\r\n      }\r\n      this._canvas.putImageData(imageData);\r\n      \r\n      // Notify toolbar to update its state\r\n      if (this._toolbar) {\r\n        this._toolbar.saveOriginalImage();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Redo the last undone operation\r\n   * Requirements: 6.3 - Restore to next state\r\n   */\r\n  redo(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    const state = this._historyManager.redo();\r\n    if (state) {\r\n      // Restore canvas size if it changed (e.g., after crop)\r\n      const imageData = state.imageData;\r\n      if (this._canvas.width !== imageData.width || this._canvas.height !== imageData.height) {\r\n        this._canvas.canvas.width = imageData.width;\r\n        this._canvas.canvas.height = imageData.height;\r\n      }\r\n      this._canvas.putImageData(imageData);\r\n      \r\n      // Notify toolbar to update its state\r\n      if (this._toolbar) {\r\n        this._toolbar.saveOriginalImage();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if undo is available\r\n   * @returns True if can undo\r\n   */\r\n  canUndo(): boolean {\r\n    return this._historyManager.canUndo();\r\n  }\r\n\r\n  /**\r\n   * Check if redo is available\r\n   * @returns True if can redo\r\n   */\r\n  canRedo(): boolean {\r\n    return this._historyManager.canRedo();\r\n  }\r\n\r\n  /**\r\n   * Save current state to history (public API)\r\n   * @param description - Optional description of the operation\r\n   */\r\n  saveToHistory(description?: string): void {\r\n    if (this._destroyed) return;\r\n    this.saveState(this.currentTool || 'toolbar', description);\r\n  }\r\n\r\n  /**\r\n   * Export the edited image\r\n   * Requirements: 7.1, 7.2, 7.3, 7.4, 7.5 - Export with various options\r\n   * @param options - Export options\r\n   * @returns Promise with exported data\r\n   */\r\n  async export(options?: ExportOptions): Promise<string | Blob | File> {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    // Import export utilities dynamically to avoid circular dependencies\r\n    const exportUtils = await import('../utils/export.utils');\r\n\r\n    const exportOptions = options || {};\r\n    this._eventManager.emit('before-export', { options: exportOptions });\r\n\r\n    const data = await exportUtils.exportImage(this._canvas.canvas, exportOptions);\r\n\r\n    this._eventManager.emit('after-export', { data });\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an event\r\n   * Requirements: 1.2 - Event subscription\r\n   * @param event - Event name\r\n   * @param handler - Event handler\r\n   * @param options - Listener options\r\n   */\r\n  on<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>,\r\n    options?: EventListenerOptions\r\n  ): void {\r\n    this._eventManager.on(event, handler, options);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe from an event\r\n   * @param event - Event name\r\n   * @param handler - Event handler\r\n   */\r\n  off<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>\r\n  ): void {\r\n    this._eventManager.off(event, handler);\r\n  }\r\n\r\n  /**\r\n   * Emit an event\r\n   * @param event - Event name\r\n   * @param data - Event data\r\n   */\r\n  emit<K extends keyof EditorEvents>(event: K, data: EditorEvents[K]): void {\r\n    this._eventManager.emit(event, data);\r\n  }\r\n\r\n  /**\r\n   * Get the current configuration\r\n   * @returns Current configuration\r\n   */\r\n  getConfig(): EditorConfig {\r\n    return this._configManager.getConfig();\r\n  }\r\n\r\n  /**\r\n   * Update configuration at runtime\r\n   * Requirements: 10.5 - Runtime configuration update\r\n   * @param updates - Configuration updates\r\n   */\r\n  updateConfig(updates: DeepPartial<EditorConfig>): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._configManager.update(updates);\r\n  }\r\n\r\n  /**\r\n   * Reset the canvas to original image\r\n   */\r\n  reset(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._canvas.reset();\r\n    this.saveState('reset', 'Reset to original');\r\n  }\r\n\r\n  /**\r\n   * Clear the canvas\r\n   */\r\n  clear(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._canvas.clear();\r\n    this.saveState('clear', 'Clear canvas');\r\n  }\r\n\r\n  /**\r\n   * Get the history manager\r\n   * @returns History manager instance\r\n   */\r\n  getHistoryManager(): HistoryManager {\r\n    return this._historyManager;\r\n  }\r\n\r\n  /**\r\n   * Get the plugin manager\r\n   * @returns Plugin manager instance\r\n   */\r\n  getPluginManager(): PluginManager {\r\n    return this._pluginManager;\r\n  }\r\n\r\n  /**\r\n   * Get the event manager\r\n   * @returns Event manager instance\r\n   */\r\n  getEventManager(): EventManager {\r\n    return this._eventManager;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas manager\r\n   * @returns Canvas manager instance\r\n   */\r\n  getCanvasManager(): Canvas {\r\n    return this._canvas;\r\n  }\r\n\r\n  /**\r\n   * Get the built-in toolbar instance\r\n   * @returns Toolbar instance or null if disabled\r\n   */\r\n  getToolbar(): Toolbar | null {\r\n    return this._toolbar;\r\n  }\r\n  \r\n  // ============ Image Data APIs ============\r\n  \r\n  /**\r\n   * Get current canvas image data\r\n   * @returns ImageData object\r\n   */\r\n  getImageData(): ImageData {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    return this._canvas.getImageData();\r\n  }\r\n  \r\n  /**\r\n   * Get canvas as data URL\r\n   * @param type - Image MIME type (default: 'image/png')\r\n   * @param quality - Image quality for jpeg (0-1)\r\n   * @returns Data URL string\r\n   */\r\n  toDataURL(type: string = 'image/png', quality?: number): string {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    return this._canvas.canvas.toDataURL(type, quality);\r\n  }\r\n  \r\n  /**\r\n   * Get canvas as Blob\r\n   * @param type - Image MIME type (default: 'image/png')\r\n   * @param quality - Image quality for jpeg (0-1)\r\n   * @returns Promise resolving to Blob\r\n   */\r\n  toBlob(type: string = 'image/png', quality?: number): Promise<Blob | null> {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    return new Promise((resolve) => {\r\n      this._canvas.canvas.toBlob(resolve, type, quality);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * Get image information\r\n   * @returns Object containing width, height, and other info\r\n   */\r\n  getImageInfo(): { width: number; height: number; aspectRatio: number } {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    const width = this._canvas.width;\r\n    const height = this._canvas.height;\r\n    return {\r\n      width,\r\n      height,\r\n      aspectRatio: width / height,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Destroy the editor and clean up all resources\r\n   * Requirements: 1.5 - Clean up all event listeners and canvas resources\r\n   */\r\n  destroy(): void {\r\n    if (this._destroyed) {\r\n      return;\r\n    }\r\n\r\n    this._destroyed = true;\r\n\r\n    // Emit destroy event before cleanup\r\n    this._eventManager.emit('destroy', undefined as unknown as void);\r\n\r\n    // Destroy toolbar first\r\n    if (this._toolbar) {\r\n      this._toolbar.destroy();\r\n      this._toolbar = null;\r\n    }\r\n\r\n    // Destroy all managers\r\n    this._pluginManager.destroy();\r\n    this._historyManager.destroy();\r\n    this._canvas.destroy();\r\n    this._eventManager.destroy();\r\n    this._configManager.destroy();\r\n\r\n    this._ready = false;\r\n  }\r\n}\r\n","/**\r\n * Base Plugin - Abstract base class for all plugins\r\n * Requirements: 2.5 - Plugin interface definition with unified lifecycle methods\r\n */\r\n\r\nimport type { Plugin, PluginContext } from '../../types/plugin.types';\r\n\r\n/**\r\n * Abstract base class for plugins\r\n * Provides common functionality and enforces plugin interface\r\n * Requirements: 2.5\r\n */\r\nexport abstract class BasePlugin<TConfig extends object = object> implements Plugin {\r\n  /** Plugin name - must be unique */\r\n  abstract readonly name: string;\r\n  /** Toolbar icon (optional) */\r\n  readonly icon?: string;\r\n  /** Toolbar title (optional) */\r\n  readonly title?: string;\r\n\r\n  /** Plugin context provided during installation */\r\n  protected context: PluginContext | null = null;\r\n  /** Current plugin configuration */\r\n  protected config: TConfig;\r\n  /** Whether the plugin is currently active */\r\n  protected isActive: boolean = false;\r\n\r\n  constructor() {\r\n    this.config = this.getDefaultConfig();\r\n  }\r\n\r\n  /**\r\n   * Get default configuration for the plugin\r\n   * Subclasses should override this to provide their default config\r\n   */\r\n  abstract getDefaultConfig(): TConfig;\r\n\r\n  /**\r\n   * Install the plugin with the provided context\r\n   * Requirements: 2.5 - install lifecycle method\r\n   * @param context - Plugin context from editor\r\n   */\r\n  install(context: PluginContext): void {\r\n    this.context = context;\r\n    this.onInstall();\r\n  }\r\n\r\n  /**\r\n   * Activate the plugin\r\n   * Requirements: 2.5 - activate lifecycle method\r\n   */\r\n  activate(): void {\r\n    if (!this.context) {\r\n      throw new Error(`Plugin \"${this.name}\" is not installed. Call install() first.`);\r\n    }\r\n    this.isActive = true;\r\n    this.onActivate();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the plugin\r\n   * Requirements: 2.5 - deactivate lifecycle method\r\n   */\r\n  deactivate(): void {\r\n    this.isActive = false;\r\n    this.onDeactivate();\r\n  }\r\n\r\n  /**\r\n   * Destroy the plugin and clean up resources\r\n   * Requirements: 2.5 - destroy lifecycle method\r\n   */\r\n  destroy(): void {\r\n    this.deactivate();\r\n    this.onDestroy();\r\n    this.context = null;\r\n  }\r\n\r\n  /**\r\n   * Set plugin configuration\r\n   * @param config - Partial configuration to merge\r\n   */\r\n  setConfig(config: Partial<TConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n    this.onConfigChange(this.config);\r\n  }\r\n\r\n  /**\r\n   * Get current plugin configuration\r\n   * @returns Current configuration\r\n   */\r\n  getConfig(): TConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Check if the plugin is currently active\r\n   * @returns True if active\r\n   */\r\n  getIsActive(): boolean {\r\n    return this.isActive;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas element\r\n   * @returns Canvas element or null if not installed\r\n   */\r\n  protected getCanvas(): HTMLCanvasElement | null {\r\n    return this.context?.canvas ?? null;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas 2D context\r\n   * @returns Canvas context or null if not installed\r\n   */\r\n  protected getContext(): CanvasRenderingContext2D | null {\r\n    return this.context?.ctx ?? null;\r\n  }\r\n\r\n  /**\r\n   * Save current state to history\r\n   */\r\n  protected saveState(): void {\r\n    this.context?.saveState();\r\n  }\r\n\r\n  /**\r\n   * Get current image data from canvas\r\n   * @returns ImageData or null if not available\r\n   */\r\n  protected getImageData(): ImageData | null {\r\n    return this.context?.getImageData() ?? null;\r\n  }\r\n\r\n  /**\r\n   * Put image data to canvas\r\n   * @param data - ImageData to put\r\n   */\r\n  protected putImageData(data: ImageData): void {\r\n    this.context?.putImageData(data);\r\n  }\r\n\r\n  /**\r\n   * Hook called after plugin is installed\r\n   * Subclasses can override to perform initialization\r\n   */\r\n  protected onInstall(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is activated\r\n   * Subclasses can override to set up event listeners, etc.\r\n   */\r\n  protected onActivate(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is deactivated\r\n   * Subclasses can override to clean up event listeners, etc.\r\n   */\r\n  protected onDeactivate(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is destroyed\r\n   * Subclasses can override to perform final cleanup\r\n   */\r\n  protected onDestroy(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when configuration changes\r\n   * Subclasses can override to react to config changes\r\n   * @param _config - New configuration\r\n   */\r\n  protected onConfigChange(_config: TConfig): void {\r\n    // Override in subclass if needed\r\n  }\r\n}\r\n","/**\r\n * Mosaic utility functions\r\n * Requirements: 3.1, 3.2, 3.4 - Mosaic algorithm implementation\r\n */\r\n\r\n/**\r\n * Apply mosaic effect to a rectangular region of image data\r\n * Requirements: 3.1, 3.2, 3.4\r\n * @param imageData - Source image data\r\n * @param x - Start X coordinate\r\n * @param y - Start Y coordinate\r\n * @param width - Region width\r\n * @param height - Region height\r\n * @param blockSize - Mosaic block size\r\n * @param intensity - Mosaic intensity (0-100)\r\n * @returns Modified image data\r\n */\r\nexport function applyMosaicToRegion(\r\n  imageData: ImageData,\r\n  x: number,\r\n  y: number,\r\n  width: number,\r\n  height: number,\r\n  blockSize: number,\r\n  intensity: number\r\n): ImageData {\r\n  const data = imageData.data;\r\n  const imgWidth = imageData.width;\r\n  const imgHeight = imageData.height;\r\n\r\n  // Clamp coordinates to image bounds\r\n  const startX = Math.max(0, Math.floor(x));\r\n  const startY = Math.max(0, Math.floor(y));\r\n  const endX = Math.min(imgWidth, Math.ceil(x + width));\r\n  const endY = Math.min(imgHeight, Math.ceil(y + height));\r\n\r\n  // Ensure block size is at least 1\r\n  const effectiveBlockSize = Math.max(1, Math.floor(blockSize));\r\n  \r\n  // Normalize intensity to 0-1 range\r\n  const normalizedIntensity = Math.max(0, Math.min(100, intensity)) / 100;\r\n\r\n  // Process each block\r\n  for (let blockY = startY; blockY < endY; blockY += effectiveBlockSize) {\r\n    for (let blockX = startX; blockX < endX; blockX += effectiveBlockSize) {\r\n      // Calculate block bounds\r\n      const blockEndX = Math.min(blockX + effectiveBlockSize, endX);\r\n      const blockEndY = Math.min(blockY + effectiveBlockSize, endY);\r\n      const blockWidth = blockEndX - blockX;\r\n      const blockHeight = blockEndY - blockY;\r\n      const pixelCount = blockWidth * blockHeight;\r\n\r\n      if (pixelCount === 0) continue;\r\n\r\n      // Calculate average color for the block\r\n      let totalR = 0;\r\n      let totalG = 0;\r\n      let totalB = 0;\r\n      let totalA = 0;\r\n\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const idx = (py * imgWidth + px) * 4;\r\n          totalR += data[idx];\r\n          totalG += data[idx + 1];\r\n          totalB += data[idx + 2];\r\n          totalA += data[idx + 3];\r\n        }\r\n      }\r\n\r\n      const avgR = Math.round(totalR / pixelCount);\r\n      const avgG = Math.round(totalG / pixelCount);\r\n      const avgB = Math.round(totalB / pixelCount);\r\n      const avgA = Math.round(totalA / pixelCount);\r\n\r\n      // Apply the average color to all pixels in the block with intensity blending\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const idx = (py * imgWidth + px) * 4;\r\n          \r\n          // Blend original and mosaic color based on intensity\r\n          data[idx] = Math.round(data[idx] * (1 - normalizedIntensity) + avgR * normalizedIntensity);\r\n          data[idx + 1] = Math.round(data[idx + 1] * (1 - normalizedIntensity) + avgG * normalizedIntensity);\r\n          data[idx + 2] = Math.round(data[idx + 2] * (1 - normalizedIntensity) + avgB * normalizedIntensity);\r\n          data[idx + 3] = Math.round(data[idx + 3] * (1 - normalizedIntensity) + avgA * normalizedIntensity);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return imageData;\r\n}\r\n\r\n/**\r\n * Apply mosaic effect along a brush stroke path\r\n * Requirements: 3.1, 3.5 - Free drawing mode\r\n * @param imageData - Source image data\r\n * @param points - Array of points along the stroke\r\n * @param brushSize - Brush diameter\r\n * @param blockSize - Mosaic block size\r\n * @param intensity - Mosaic intensity (0-100)\r\n * @returns Modified image data\r\n */\r\nexport function applyMosaicAlongPath(\r\n  imageData: ImageData,\r\n  points: Array<{ x: number; y: number }>,\r\n  brushSize: number,\r\n  blockSize: number,\r\n  intensity: number\r\n): ImageData {\r\n  if (points.length === 0) return imageData;\r\n\r\n  const radius = brushSize / 2;\r\n\r\n  // For each point, apply mosaic to a circular region\r\n  for (const point of points) {\r\n    applyMosaicToCircularRegion(\r\n      imageData,\r\n      point.x,\r\n      point.y,\r\n      radius,\r\n      blockSize,\r\n      intensity\r\n    );\r\n  }\r\n\r\n  return imageData;\r\n}\r\n\r\n/**\r\n * Apply mosaic effect to a circular region\r\n * @param imageData - Source image data\r\n * @param centerX - Center X coordinate\r\n * @param centerY - Center Y coordinate\r\n * @param radius - Circle radius\r\n * @param blockSize - Mosaic block size\r\n * @param intensity - Mosaic intensity (0-100)\r\n * @returns Modified image data\r\n */\r\nexport function applyMosaicToCircularRegion(\r\n  imageData: ImageData,\r\n  centerX: number,\r\n  centerY: number,\r\n  radius: number,\r\n  blockSize: number,\r\n  intensity: number\r\n): ImageData {\r\n  const data = imageData.data;\r\n  const imgWidth = imageData.width;\r\n  const imgHeight = imageData.height;\r\n\r\n  // Calculate bounding box\r\n  const startX = Math.max(0, Math.floor(centerX - radius));\r\n  const startY = Math.max(0, Math.floor(centerY - radius));\r\n  const endX = Math.min(imgWidth, Math.ceil(centerX + radius));\r\n  const endY = Math.min(imgHeight, Math.ceil(centerY + radius));\r\n\r\n  const effectiveBlockSize = Math.max(1, Math.floor(blockSize));\r\n  const normalizedIntensity = Math.max(0, Math.min(100, intensity)) / 100;\r\n  const radiusSquared = radius * radius;\r\n\r\n  // Process each block within the bounding box\r\n  for (let blockY = startY; blockY < endY; blockY += effectiveBlockSize) {\r\n    for (let blockX = startX; blockX < endX; blockX += effectiveBlockSize) {\r\n      const blockEndX = Math.min(blockX + effectiveBlockSize, endX);\r\n      const blockEndY = Math.min(blockY + effectiveBlockSize, endY);\r\n\r\n      // Check if block center is within the circle\r\n      const blockCenterX = blockX + effectiveBlockSize / 2;\r\n      const blockCenterY = blockY + effectiveBlockSize / 2;\r\n      const dx = blockCenterX - centerX;\r\n      const dy = blockCenterY - centerY;\r\n      \r\n      if (dx * dx + dy * dy > radiusSquared) continue;\r\n\r\n      // Calculate average color for pixels within the circle\r\n      let totalR = 0;\r\n      let totalG = 0;\r\n      let totalB = 0;\r\n      let totalA = 0;\r\n      let pixelCount = 0;\r\n\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const pdx = px - centerX;\r\n          const pdy = py - centerY;\r\n          if (pdx * pdx + pdy * pdy <= radiusSquared) {\r\n            const idx = (py * imgWidth + px) * 4;\r\n            totalR += data[idx];\r\n            totalG += data[idx + 1];\r\n            totalB += data[idx + 2];\r\n            totalA += data[idx + 3];\r\n            pixelCount++;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (pixelCount === 0) continue;\r\n\r\n      const avgR = Math.round(totalR / pixelCount);\r\n      const avgG = Math.round(totalG / pixelCount);\r\n      const avgB = Math.round(totalB / pixelCount);\r\n      const avgA = Math.round(totalA / pixelCount);\r\n\r\n      // Apply average color to pixels within the circle\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const pdx = px - centerX;\r\n          const pdy = py - centerY;\r\n          if (pdx * pdx + pdy * pdy <= radiusSquared) {\r\n            const idx = (py * imgWidth + px) * 4;\r\n            data[idx] = Math.round(data[idx] * (1 - normalizedIntensity) + avgR * normalizedIntensity);\r\n            data[idx + 1] = Math.round(data[idx + 1] * (1 - normalizedIntensity) + avgG * normalizedIntensity);\r\n            data[idx + 2] = Math.round(data[idx + 2] * (1 - normalizedIntensity) + avgB * normalizedIntensity);\r\n            data[idx + 3] = Math.round(data[idx + 3] * (1 - normalizedIntensity) + avgA * normalizedIntensity);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return imageData;\r\n}\r\n\r\n/**\r\n * Interpolate points between two coordinates for smooth brush strokes\r\n * @param x1 - Start X\r\n * @param y1 - Start Y\r\n * @param x2 - End X\r\n * @param y2 - End Y\r\n * @param spacing - Spacing between points\r\n * @returns Array of interpolated points\r\n */\r\nexport function interpolatePoints(\r\n  x1: number,\r\n  y1: number,\r\n  x2: number,\r\n  y2: number,\r\n  spacing: number\r\n): Array<{ x: number; y: number }> {\r\n  const points: Array<{ x: number; y: number }> = [];\r\n  const dx = x2 - x1;\r\n  const dy = y2 - y1;\r\n  const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n  if (distance < spacing) {\r\n    points.push({ x: x2, y: y2 });\r\n    return points;\r\n  }\r\n\r\n  const steps = Math.ceil(distance / spacing);\r\n  for (let i = 0; i <= steps; i++) {\r\n    const t = i / steps;\r\n    points.push({\r\n      x: x1 + dx * t,\r\n      y: y1 + dy * t,\r\n    });\r\n  }\r\n\r\n  return points;\r\n}\r\n","/**\r\n * Mosaic Plugin - Applies mosaic effect to image regions\r\n * Requirements: 3.1, 3.2, 3.3, 3.4, 3.5\r\n */\r\n\r\nimport { BasePlugin } from '../base/BasePlugin';\r\nimport type { MosaicConfig } from '../../types/config.types';\r\nimport type { MosaicPluginInterface } from '../../types/plugin.types';\r\nimport { normalizePointerEvent } from '../../utils/event.utils';\r\nimport { getResolvedDeviceType, getNonPassiveOptions } from '../../utils/device.utils';\r\nimport {\r\n  applyMosaicToRegion,\r\n  applyMosaicToCircularRegion,\r\n  interpolatePoints,\r\n} from './mosaic.utils';\r\nimport { cloneImageData } from '../../utils/image.utils';\r\n\r\n/**\r\n * Drawing state for tracking mouse/touch interactions\r\n */\r\ninterface DrawingState {\r\n  isDrawing: boolean;\r\n  startX: number;\r\n  startY: number;\r\n  lastX: number;\r\n  lastY: number;\r\n  originalImageData: ImageData | null;\r\n}\r\n\r\n/**\r\n * MosaicPlugin class - Implements mosaic drawing functionality\r\n * Requirements: 3.1, 3.2, 3.3, 3.4, 3.5\r\n */\r\nexport class MosaicPlugin extends BasePlugin<MosaicConfig> implements MosaicPluginInterface {\r\n  readonly name = 'mosaic' as const;\r\n  readonly icon = '▦';\r\n  readonly title = 'Mosaic';\r\n\r\n  /** Drawing state */\r\n  private drawingState: DrawingState = {\r\n    isDrawing: false,\r\n    startX: 0,\r\n    startY: 0,\r\n    lastX: 0,\r\n    lastY: 0,\r\n    originalImageData: null,\r\n  };\r\n\r\n  /** Event cleanup functions */\r\n  private cleanupFunctions: Array<() => void> = [];\r\n\r\n  /**\r\n   * Get default mosaic configuration\r\n   * Requirements: 3.2, 3.4, 3.5\r\n   */\r\n  getDefaultConfig(): MosaicConfig {\r\n    return {\r\n      blockSize: 10,\r\n      intensity: 100,\r\n      mode: 'free',\r\n      brushSize: 30,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Set mosaic block size\r\n   * Requirements: 3.2\r\n   * @param size - Block size in pixels\r\n   */\r\n  setBlockSize(size: number): void {\r\n    this.setConfig({ blockSize: Math.max(1, Math.floor(size)) });\r\n  }\r\n\r\n  /**\r\n   * Set mosaic intensity\r\n   * Requirements: 3.4\r\n   * @param intensity - Intensity value (0-100)\r\n   */\r\n  setIntensity(intensity: number): void {\r\n    this.setConfig({ intensity: Math.max(0, Math.min(100, intensity)) });\r\n  }\r\n\r\n  /**\r\n   * Set drawing mode\r\n   * Requirements: 3.5\r\n   * @param mode - Drawing mode ('rect' or 'free')\r\n   */\r\n  setMode(mode: 'rect' | 'free'): void {\r\n    this.setConfig({ mode });\r\n  }\r\n\r\n  /**\r\n   * Set brush size for free drawing mode\r\n   * Requirements: 3.5\r\n   * @param size - Brush size in pixels\r\n   */\r\n  setBrushSize(size: number): void {\r\n    this.setConfig({ brushSize: Math.max(1, size) });\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is activated\r\n   * Sets up event listeners for drawing\r\n   * Requirements: 3.1, 3.3\r\n   */\r\n  protected onActivate(): void {\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    this.setupEventListeners(canvas);\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is deactivated\r\n   * Cleans up event listeners\r\n   */\r\n  protected onDeactivate(): void {\r\n    this.cleanupEventListeners();\r\n    this.resetDrawingState();\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is destroyed\r\n   */\r\n  protected onDestroy(): void {\r\n    this.cleanupEventListeners();\r\n    this.resetDrawingState();\r\n  }\r\n\r\n  /**\r\n   * Set up mouse and touch event listeners\r\n   * Requirements: 3.3 - Touch event support\r\n   */\r\n  private setupEventListeners(canvas: HTMLCanvasElement): void {\r\n    const deviceType = getResolvedDeviceType('auto');\r\n    const nonPassiveOptions = getNonPassiveOptions();\r\n\r\n    if (deviceType === 'mobile') {\r\n      // Touch events for mobile\r\n      const touchStartHandler = this.handleTouchStart.bind(this);\r\n      const touchMoveHandler = this.handleTouchMove.bind(this);\r\n      const touchEndHandler = this.handleTouchEnd.bind(this);\r\n\r\n      canvas.addEventListener('touchstart', touchStartHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchmove', touchMoveHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchend', touchEndHandler);\r\n      canvas.addEventListener('touchcancel', touchEndHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('touchstart', touchStartHandler),\r\n        () => canvas.removeEventListener('touchmove', touchMoveHandler),\r\n        () => canvas.removeEventListener('touchend', touchEndHandler),\r\n        () => canvas.removeEventListener('touchcancel', touchEndHandler)\r\n      );\r\n    } else {\r\n      // Mouse events for PC\r\n      const mouseDownHandler = this.handleMouseDown.bind(this);\r\n      const mouseMoveHandler = this.handleMouseMove.bind(this);\r\n      const mouseUpHandler = this.handleMouseUp.bind(this);\r\n\r\n      canvas.addEventListener('mousedown', mouseDownHandler);\r\n      canvas.addEventListener('mousemove', mouseMoveHandler);\r\n      canvas.addEventListener('mouseup', mouseUpHandler);\r\n      canvas.addEventListener('mouseleave', mouseUpHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('mousedown', mouseDownHandler),\r\n        () => canvas.removeEventListener('mousemove', mouseMoveHandler),\r\n        () => canvas.removeEventListener('mouseup', mouseUpHandler),\r\n        () => canvas.removeEventListener('mouseleave', mouseUpHandler)\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up all event listeners\r\n   */\r\n  private cleanupEventListeners(): void {\r\n    for (const cleanup of this.cleanupFunctions) {\r\n      cleanup();\r\n    }\r\n    this.cleanupFunctions = [];\r\n  }\r\n\r\n  /**\r\n   * Reset drawing state\r\n   */\r\n  private resetDrawingState(): void {\r\n    this.drawingState = {\r\n      isDrawing: false,\r\n      startX: 0,\r\n      startY: 0,\r\n      lastX: 0,\r\n      lastY: 0,\r\n      originalImageData: null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle mouse down event\r\n   */\r\n  private handleMouseDown(event: MouseEvent): void {\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse move event\r\n   */\r\n  private handleMouseMove(event: MouseEvent): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse up event\r\n   */\r\n  private handleMouseUp(): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n    this.endDrawing();\r\n  }\r\n\r\n  /**\r\n   * Handle touch start event\r\n   * Requirements: 3.3\r\n   */\r\n  private handleTouchStart(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle touch move event\r\n   * Requirements: 3.3\r\n   */\r\n  private handleTouchMove(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle touch end event\r\n   * Requirements: 3.3\r\n   */\r\n  private handleTouchEnd(): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n    this.endDrawing();\r\n  }\r\n\r\n  /**\r\n   * Start drawing operation\r\n   */\r\n  private startDrawing(x: number, y: number): void {\r\n    const imageData = this.getImageData();\r\n    if (!imageData) return;\r\n\r\n    // Save original state for rect mode preview\r\n    this.drawingState = {\r\n      isDrawing: true,\r\n      startX: x,\r\n      startY: y,\r\n      lastX: x,\r\n      lastY: y,\r\n      originalImageData: cloneImageData(imageData),\r\n    };\r\n\r\n    // For free mode, apply mosaic at the starting point\r\n    if (this.config.mode === 'free') {\r\n      this.applyMosaicAtPoint(x, y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Continue drawing operation\r\n   */\r\n  private continueDrawing(x: number, y: number): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    if (this.config.mode === 'free') {\r\n      // Interpolate points for smooth brush stroke\r\n      const points = interpolatePoints(\r\n        this.drawingState.lastX,\r\n        this.drawingState.lastY,\r\n        x,\r\n        y,\r\n        this.config.brushSize / 4\r\n      );\r\n\r\n      for (const point of points) {\r\n        this.applyMosaicAtPoint(point.x, point.y);\r\n      }\r\n\r\n      this.drawingState.lastX = x;\r\n      this.drawingState.lastY = y;\r\n    } else {\r\n      // Rect mode: preview the rectangle\r\n      this.previewRectMosaic(x, y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * End drawing operation\r\n   */\r\n  private endDrawing(): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    if (this.config.mode === 'rect') {\r\n      // Apply final rect mosaic\r\n      this.applyRectMosaic(\r\n        this.drawingState.startX,\r\n        this.drawingState.startY,\r\n        this.drawingState.lastX,\r\n        this.drawingState.lastY\r\n      );\r\n    }\r\n\r\n    // Save state to history\r\n    this.saveState();\r\n\r\n    this.resetDrawingState();\r\n  }\r\n\r\n  /**\r\n   * Apply mosaic at a single point (free mode)\r\n   * Requirements: 3.1, 3.5\r\n   */\r\n  private applyMosaicAtPoint(x: number, y: number): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n\r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    applyMosaicToCircularRegion(\r\n      imageData,\r\n      x,\r\n      y,\r\n      this.config.brushSize / 2,\r\n      this.config.blockSize,\r\n      this.config.intensity\r\n    );\r\n\r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Preview rect mosaic (during drag)\r\n   * Requirements: 3.5\r\n   */\r\n  private previewRectMosaic(currentX: number, currentY: number): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas || !this.drawingState.originalImageData) return;\r\n\r\n    // Restore original image\r\n    ctx.putImageData(this.drawingState.originalImageData, 0, 0);\r\n\r\n    // Get fresh image data and apply mosaic\r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    const x = Math.min(this.drawingState.startX, currentX);\r\n    const y = Math.min(this.drawingState.startY, currentY);\r\n    const width = Math.abs(currentX - this.drawingState.startX);\r\n    const height = Math.abs(currentY - this.drawingState.startY);\r\n\r\n    applyMosaicToRegion(\r\n      imageData,\r\n      x,\r\n      y,\r\n      width,\r\n      height,\r\n      this.config.blockSize,\r\n      this.config.intensity\r\n    );\r\n\r\n    ctx.putImageData(imageData, 0, 0);\r\n    this.drawingState.lastX = currentX;\r\n    this.drawingState.lastY = currentY;\r\n  }\r\n\r\n  /**\r\n   * Apply final rect mosaic\r\n   * Requirements: 3.1, 3.5\r\n   */\r\n  private applyRectMosaic(startX: number, startY: number, endX: number, endY: number): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas || !this.drawingState.originalImageData) return;\r\n\r\n    // Restore original and apply final mosaic\r\n    ctx.putImageData(this.drawingState.originalImageData, 0, 0);\r\n    \r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    const x = Math.min(startX, endX);\r\n    const y = Math.min(startY, endY);\r\n    const width = Math.abs(endX - startX);\r\n    const height = Math.abs(endY - startY);\r\n\r\n    applyMosaicToRegion(\r\n      imageData,\r\n      x,\r\n      y,\r\n      width,\r\n      height,\r\n      this.config.blockSize,\r\n      this.config.intensity\r\n    );\r\n\r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n}\r\n","/**\r\n * TextLayer - Manages individual text elements on the canvas\r\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.6\r\n */\r\n\r\nimport type { TextConfig } from '../../types/config.types';\r\nimport type { TextLayer as TextLayerData } from '../../types/plugin.types';\r\n\r\n/**\r\n * Default text configuration\r\n * Requirements: 4.2, 4.3, 4.5, 4.6\r\n */\r\nexport const DEFAULT_TEXT_CONFIG: TextConfig = {\r\n  fontSize: 16,\r\n  fontFamily: 'Arial',\r\n  color: '#000000',\r\n  bold: false,\r\n  italic: false,\r\n  underline: false,\r\n  align: 'left',\r\n  lineHeight: 1.2,\r\n};\r\n\r\n/**\r\n * Generate unique ID for text layers\r\n */\r\nfunction generateId(): string {\r\n  return `text_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n/**\r\n * TextLayerManager - Manages text layer instances\r\n * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6\r\n */\r\nexport class TextLayerManager {\r\n  /** Map of text layers by ID */\r\n  private layers: Map<string, TextLayerData> = new Map();\r\n  /** Currently selected layer ID */\r\n  private selectedLayerId: string | null = null;\r\n\r\n  /**\r\n   * Create a new text layer\r\n   * Requirements: 4.1\r\n   * @param text - Text content\r\n   * @param x - X position\r\n   * @param y - Y position\r\n   * @param config - Optional text configuration\r\n   * @returns Created text layer\r\n   */\r\n  createLayer(\r\n    text: string,\r\n    x: number,\r\n    y: number,\r\n    config?: Partial<TextConfig>\r\n  ): TextLayerData {\r\n    const layer: TextLayerData = {\r\n      id: generateId(),\r\n      text,\r\n      x,\r\n      y,\r\n      config: { ...DEFAULT_TEXT_CONFIG, ...config },\r\n    };\r\n    this.layers.set(layer.id, layer);\r\n    return layer;\r\n  }\r\n\r\n\r\n  /**\r\n   * Get a text layer by ID\r\n   * @param id - Layer ID\r\n   * @returns Text layer or undefined\r\n   */\r\n  getLayer(id: string): TextLayerData | undefined {\r\n    return this.layers.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all text layers\r\n   * @returns Array of all text layers\r\n   */\r\n  getAllLayers(): TextLayerData[] {\r\n    return Array.from(this.layers.values());\r\n  }\r\n\r\n  /**\r\n   * Update text content\r\n   * Requirements: 4.1\r\n   * @param id - Layer ID\r\n   * @param text - New text content\r\n   * @returns Updated layer or undefined\r\n   */\r\n  updateText(id: string, text: string): TextLayerData | undefined {\r\n    const layer = this.layers.get(id);\r\n    if (layer) {\r\n      layer.text = text;\r\n    }\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Update layer position\r\n   * Requirements: 4.4\r\n   * @param id - Layer ID\r\n   * @param x - New X position\r\n   * @param y - New Y position\r\n   * @returns Updated layer or undefined\r\n   */\r\n  updatePosition(id: string, x: number, y: number): TextLayerData | undefined {\r\n    const layer = this.layers.get(id);\r\n    if (layer) {\r\n      layer.x = x;\r\n      layer.y = y;\r\n    }\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Update layer configuration\r\n   * Requirements: 4.2, 4.3, 4.5, 4.6\r\n   * @param id - Layer ID\r\n   * @param config - Partial configuration to merge\r\n   * @returns Updated layer or undefined\r\n   */\r\n  updateConfig(id: string, config: Partial<TextConfig>): TextLayerData | undefined {\r\n    const layer = this.layers.get(id);\r\n    if (layer) {\r\n      layer.config = { ...layer.config, ...config };\r\n    }\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a text layer\r\n   * @param id - Layer ID\r\n   * @returns True if layer was removed\r\n   */\r\n  removeLayer(id: string): boolean {\r\n    if (this.selectedLayerId === id) {\r\n      this.selectedLayerId = null;\r\n    }\r\n    return this.layers.delete(id);\r\n  }\r\n\r\n  /**\r\n   * Clear all text layers\r\n   */\r\n  clearAll(): void {\r\n    this.layers.clear();\r\n    this.selectedLayerId = null;\r\n  }\r\n\r\n  /**\r\n   * Select a text layer\r\n   * @param id - Layer ID or null to deselect\r\n   */\r\n  selectLayer(id: string | null): void {\r\n    this.selectedLayerId = id;\r\n  }\r\n\r\n  /**\r\n   * Get selected layer ID\r\n   * @returns Selected layer ID or null\r\n   */\r\n  getSelectedLayerId(): string | null {\r\n    return this.selectedLayerId;\r\n  }\r\n\r\n  /**\r\n   * Get selected layer\r\n   * @returns Selected layer or undefined\r\n   */\r\n  getSelectedLayer(): TextLayerData | undefined {\r\n    if (this.selectedLayerId) {\r\n      return this.layers.get(this.selectedLayerId);\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Check if a layer exists\r\n   * @param id - Layer ID\r\n   * @returns True if layer exists\r\n   */\r\n  hasLayer(id: string): boolean {\r\n    return this.layers.has(id);\r\n  }\r\n\r\n  /**\r\n   * Get layer count\r\n   * @returns Number of layers\r\n   */\r\n  getLayerCount(): number {\r\n    return this.layers.size;\r\n  }\r\n}\r\n","/**\r\n * Text rendering utility functions\r\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.6\r\n */\r\n\r\nimport type { TextConfig } from '../../types/config.types';\r\nimport type { TextLayer } from '../../types/plugin.types';\r\n\r\n/**\r\n * Build CSS font string from text configuration\r\n * Requirements: 4.2, 4.5\r\n * @param config - Text configuration\r\n * @returns CSS font string\r\n */\r\nexport function buildFontString(config: TextConfig): string {\r\n  const parts: string[] = [];\r\n  \r\n  if (config.italic) {\r\n    parts.push('italic');\r\n  }\r\n  \r\n  if (config.bold) {\r\n    parts.push('bold');\r\n  }\r\n  \r\n  parts.push(`${config.fontSize}px`);\r\n  parts.push(config.fontFamily);\r\n  \r\n  return parts.join(' ');\r\n}\r\n\r\n/**\r\n * Measure text dimensions\r\n * @param ctx - Canvas 2D context\r\n * @param text - Text to measure\r\n * @param config - Text configuration\r\n * @returns Text dimensions\r\n */\r\nexport function measureText(\r\n  ctx: CanvasRenderingContext2D,\r\n  text: string,\r\n  config: TextConfig\r\n): { width: number; height: number } {\r\n  const originalFont = ctx.font;\r\n  ctx.font = buildFontString(config);\r\n  \r\n  const lines = text.split('\\n');\r\n  const lineHeight = config.fontSize * config.lineHeight;\r\n  \r\n  let maxWidth = 0;\r\n  for (const line of lines) {\r\n    const metrics = ctx.measureText(line);\r\n    maxWidth = Math.max(maxWidth, metrics.width);\r\n  }\r\n  \r\n  ctx.font = originalFont;\r\n  \r\n  return {\r\n    width: maxWidth,\r\n    height: lines.length * lineHeight,\r\n  };\r\n}\r\n\r\n/**\r\n * Get text bounding box\r\n * @param layer - Text layer\r\n * @param ctx - Canvas 2D context\r\n * @returns Bounding box coordinates\r\n */\r\nexport function getTextBoundingBox(\r\n  layer: TextLayer,\r\n  ctx: CanvasRenderingContext2D\r\n): { x: number; y: number; width: number; height: number } {\r\n  const dimensions = measureText(ctx, layer.text, layer.config);\r\n  \r\n  let x = layer.x;\r\n  \r\n  // Adjust x based on alignment\r\n  if (layer.config.align === 'center') {\r\n    x -= dimensions.width / 2;\r\n  } else if (layer.config.align === 'right') {\r\n    x -= dimensions.width;\r\n  }\r\n  \r\n  return {\r\n    x,\r\n    y: layer.y - layer.config.fontSize,\r\n    width: dimensions.width,\r\n    height: dimensions.height,\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Check if a point is inside a text layer's bounding box\r\n * @param x - X coordinate\r\n * @param y - Y coordinate\r\n * @param layer - Text layer\r\n * @param ctx - Canvas 2D context\r\n * @param padding - Optional padding around the bounding box\r\n * @returns True if point is inside\r\n */\r\nexport function isPointInTextLayer(\r\n  x: number,\r\n  y: number,\r\n  layer: TextLayer,\r\n  ctx: CanvasRenderingContext2D,\r\n  padding: number = 5\r\n): boolean {\r\n  const box = getTextBoundingBox(layer, ctx);\r\n  \r\n  return (\r\n    x >= box.x - padding &&\r\n    x <= box.x + box.width + padding &&\r\n    y >= box.y - padding &&\r\n    y <= box.y + box.height + padding\r\n  );\r\n}\r\n\r\n/**\r\n * Find text layer at a given point\r\n * @param x - X coordinate\r\n * @param y - Y coordinate\r\n * @param layers - Array of text layers\r\n * @param ctx - Canvas 2D context\r\n * @returns Found layer or undefined\r\n */\r\nexport function findTextLayerAtPoint(\r\n  x: number,\r\n  y: number,\r\n  layers: TextLayer[],\r\n  ctx: CanvasRenderingContext2D\r\n): TextLayer | undefined {\r\n  // Search in reverse order (top layers first)\r\n  for (let i = layers.length - 1; i >= 0; i--) {\r\n    if (isPointInTextLayer(x, y, layers[i], ctx)) {\r\n      return layers[i];\r\n    }\r\n  }\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Render a single text layer to canvas\r\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.6\r\n * @param ctx - Canvas 2D context\r\n * @param layer - Text layer to render\r\n * @param isSelected - Whether the layer is selected\r\n */\r\nexport function renderTextLayer(\r\n  ctx: CanvasRenderingContext2D,\r\n  layer: TextLayer,\r\n  isSelected: boolean = false\r\n): void {\r\n  const { text, x, y, config } = layer;\r\n  \r\n  // Save context state\r\n  ctx.save();\r\n  \r\n  // Set font properties\r\n  ctx.font = buildFontString(config);\r\n  ctx.fillStyle = config.color;\r\n  ctx.textAlign = config.align;\r\n  ctx.textBaseline = 'alphabetic';\r\n  \r\n  // Render each line\r\n  const lines = text.split('\\n');\r\n  const lineHeight = config.fontSize * config.lineHeight;\r\n  \r\n  for (let i = 0; i < lines.length; i++) {\r\n    const lineY = y + i * lineHeight;\r\n    ctx.fillText(lines[i], x, lineY);\r\n    \r\n    // Draw underline if enabled\r\n    if (config.underline) {\r\n      drawUnderline(ctx, lines[i], x, lineY, config);\r\n    }\r\n  }\r\n  \r\n  // Draw selection box if selected\r\n  if (isSelected) {\r\n    drawSelectionBox(ctx, layer);\r\n  }\r\n  \r\n  // Restore context state\r\n  ctx.restore();\r\n}\r\n\r\n/**\r\n * Draw underline for text\r\n * Requirements: 4.5\r\n * @param ctx - Canvas 2D context\r\n * @param text - Text content\r\n * @param x - X position\r\n * @param y - Y position\r\n * @param config - Text configuration\r\n */\r\nfunction drawUnderline(\r\n  ctx: CanvasRenderingContext2D,\r\n  text: string,\r\n  x: number,\r\n  y: number,\r\n  config: TextConfig\r\n): void {\r\n  const metrics = ctx.measureText(text);\r\n  const underlineY = y + config.fontSize * 0.1;\r\n  const underlineThickness = Math.max(1, config.fontSize / 12);\r\n  \r\n  let startX = x;\r\n  if (config.align === 'center') {\r\n    startX = x - metrics.width / 2;\r\n  } else if (config.align === 'right') {\r\n    startX = x - metrics.width;\r\n  }\r\n  \r\n  ctx.strokeStyle = config.color;\r\n  ctx.lineWidth = underlineThickness;\r\n  ctx.beginPath();\r\n  ctx.moveTo(startX, underlineY);\r\n  ctx.lineTo(startX + metrics.width, underlineY);\r\n  ctx.stroke();\r\n}\r\n\r\n/**\r\n * Draw selection box around text layer\r\n * @param ctx - Canvas 2D context\r\n * @param layer - Text layer\r\n */\r\nfunction drawSelectionBox(\r\n  ctx: CanvasRenderingContext2D,\r\n  layer: TextLayer\r\n): void {\r\n  const box = getTextBoundingBox(layer, ctx);\r\n  const padding = 4;\r\n  \r\n  ctx.strokeStyle = '#0066ff';\r\n  ctx.lineWidth = 1;\r\n  ctx.setLineDash([4, 4]);\r\n  ctx.strokeRect(\r\n    box.x - padding,\r\n    box.y - padding,\r\n    box.width + padding * 2,\r\n    box.height + padding * 2\r\n  );\r\n  ctx.setLineDash([]);\r\n  \r\n  // Draw resize handles\r\n  const handleSize = 6;\r\n  ctx.fillStyle = '#0066ff';\r\n  \r\n  // Corner handles\r\n  const corners = [\r\n    { x: box.x - padding, y: box.y - padding },\r\n    { x: box.x + box.width + padding, y: box.y - padding },\r\n    { x: box.x - padding, y: box.y + box.height + padding },\r\n    { x: box.x + box.width + padding, y: box.y + box.height + padding },\r\n  ];\r\n  \r\n  for (const corner of corners) {\r\n    ctx.fillRect(\r\n      corner.x - handleSize / 2,\r\n      corner.y - handleSize / 2,\r\n      handleSize,\r\n      handleSize\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Render all text layers\r\n * @param ctx - Canvas 2D context\r\n * @param layers - Array of text layers\r\n * @param selectedId - ID of selected layer (optional)\r\n */\r\nexport function renderAllTextLayers(\r\n  ctx: CanvasRenderingContext2D,\r\n  layers: TextLayer[],\r\n  selectedId?: string | null\r\n): void {\r\n  for (const layer of layers) {\r\n    renderTextLayer(ctx, layer, layer.id === selectedId);\r\n  }\r\n}\r\n","/**\r\n * TextPlugin - Manages text overlays on the canvas\r\n * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6\r\n */\r\n\r\nimport { BasePlugin } from '../base/BasePlugin';\r\nimport type { TextConfig } from '../../types/config.types';\r\nimport type { TextPluginInterface, TextLayer } from '../../types/plugin.types';\r\nimport { normalizePointerEvent } from '../../utils/event.utils';\r\nimport { getResolvedDeviceType, getNonPassiveOptions } from '../../utils/device.utils';\r\nimport { TextLayerManager, DEFAULT_TEXT_CONFIG } from './TextLayer';\r\nimport {\r\n  renderAllTextLayers,\r\n  findTextLayerAtPoint,\r\n} from './text.utils';\r\n\r\n/**\r\n * Drag state for tracking text layer dragging\r\n */\r\ninterface DragState {\r\n  isDragging: boolean;\r\n  layerId: string | null;\r\n  startX: number;\r\n  startY: number;\r\n  offsetX: number;\r\n  offsetY: number;\r\n}\r\n\r\n/**\r\n * TextPlugin class - Implements text overlay functionality\r\n * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6\r\n */\r\nexport class TextPlugin extends BasePlugin<TextConfig> implements TextPluginInterface {\r\n  readonly name = 'text' as const;\r\n  readonly icon = 'T';\r\n  readonly title = 'Text';\r\n\r\n  /** Text layer manager */\r\n  private layerManager: TextLayerManager = new TextLayerManager();\r\n  \r\n  /** Base image data (without text layers) */\r\n  private baseImageData: ImageData | null = null;\r\n  \r\n  /** Drag state */\r\n  private dragState: DragState = {\r\n    isDragging: false,\r\n    layerId: null,\r\n    startX: 0,\r\n    startY: 0,\r\n    offsetX: 0,\r\n    offsetY: 0,\r\n  };\r\n\r\n  /** Event cleanup functions */\r\n  private cleanupFunctions: Array<() => void> = [];\r\n\r\n  /**\r\n   * Get default text configuration\r\n   * Requirements: 4.2, 4.3, 4.5, 4.6\r\n   */\r\n  getDefaultConfig(): TextConfig {\r\n    return { ...DEFAULT_TEXT_CONFIG };\r\n  }\r\n\r\n\r\n  /**\r\n   * Add text at specified position\r\n   * Requirements: 4.1\r\n   * @param text - Text content\r\n   * @param x - X position\r\n   * @param y - Y position\r\n   * @returns Created text layer\r\n   */\r\n  addText(text: string, x: number, y: number): TextLayer {\r\n    // Save base image if not already saved\r\n    if (!this.baseImageData) {\r\n      this.saveBaseImage();\r\n    }\r\n    \r\n    const layer = this.layerManager.createLayer(text, x, y, this.config);\r\n    this.layerManager.selectLayer(layer.id);\r\n    this.renderLayers();\r\n    this.saveState();\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Update text content of a layer\r\n   * Requirements: 4.1\r\n   * @param id - Layer ID\r\n   * @param text - New text content\r\n   */\r\n  updateText(id: string, text: string): void {\r\n    const layer = this.layerManager.updateText(id, text);\r\n    if (layer) {\r\n      this.renderLayers();\r\n      this.saveState();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update position of a layer\r\n   * Requirements: 4.4\r\n   * @param id - Layer ID\r\n   * @param x - New X position\r\n   * @param y - New Y position\r\n   */\r\n  updatePosition(id: string, x: number, y: number): void {\r\n    const layer = this.layerManager.updatePosition(id, x, y);\r\n    if (layer) {\r\n      this.renderLayers();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update configuration of a layer\r\n   * Requirements: 4.2, 4.3, 4.5, 4.6\r\n   * @param id - Layer ID\r\n   * @param config - Partial configuration to merge\r\n   */\r\n  updateConfig(id: string, config: Partial<TextConfig>): void {\r\n    const layer = this.layerManager.updateConfig(id, config);\r\n    if (layer) {\r\n      this.renderLayers();\r\n      this.saveState();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a text layer\r\n   * @param id - Layer ID\r\n   */\r\n  removeText(id: string): void {\r\n    if (this.layerManager.removeLayer(id)) {\r\n      this.renderLayers();\r\n      this.saveState();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all text layers\r\n   * @returns Array of text layers\r\n   */\r\n  getTextLayers(): TextLayer[] {\r\n    return this.layerManager.getAllLayers();\r\n  }\r\n\r\n  /**\r\n   * Get selected layer\r\n   * @returns Selected layer or undefined\r\n   */\r\n  getSelectedLayer(): TextLayer | undefined {\r\n    return this.layerManager.getSelectedLayer();\r\n  }\r\n\r\n  /**\r\n   * Select a layer by ID\r\n   * @param id - Layer ID or null to deselect\r\n   */\r\n  selectLayer(id: string | null): void {\r\n    this.layerManager.selectLayer(id);\r\n    this.renderLayers();\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is activated\r\n   * Sets up event listeners\r\n   */\r\n  protected onActivate(): void {\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    // Save current image as base\r\n    this.saveBaseImage();\r\n    this.setupEventListeners(canvas);\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is deactivated\r\n   * Cleans up event listeners\r\n   */\r\n  protected onDeactivate(): void {\r\n    this.cleanupEventListeners();\r\n    this.resetDragState();\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is destroyed\r\n   */\r\n  protected onDestroy(): void {\r\n    this.cleanupEventListeners();\r\n    this.layerManager.clearAll();\r\n    this.baseImageData = null;\r\n  }\r\n\r\n\r\n  /**\r\n   * Save base image data (without text layers)\r\n   */\r\n  private saveBaseImage(): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n    \r\n    this.baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n  }\r\n\r\n  /**\r\n   * Render all text layers on top of base image\r\n   */\r\n  private renderLayers(): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n\r\n    // Restore base image\r\n    if (this.baseImageData) {\r\n      ctx.putImageData(this.baseImageData, 0, 0);\r\n    }\r\n\r\n    // Render all text layers\r\n    const layers = this.layerManager.getAllLayers();\r\n    const selectedId = this.layerManager.getSelectedLayerId();\r\n    renderAllTextLayers(ctx, layers, selectedId);\r\n  }\r\n\r\n  /**\r\n   * Set up mouse and touch event listeners\r\n   * Requirements: 4.4 - Touch event support for dragging\r\n   */\r\n  private setupEventListeners(canvas: HTMLCanvasElement): void {\r\n    const deviceType = getResolvedDeviceType('auto');\r\n    const nonPassiveOptions = getNonPassiveOptions();\r\n\r\n    if (deviceType === 'mobile') {\r\n      // Touch events for mobile\r\n      const touchStartHandler = this.handleTouchStart.bind(this);\r\n      const touchMoveHandler = this.handleTouchMove.bind(this);\r\n      const touchEndHandler = this.handleTouchEnd.bind(this);\r\n\r\n      canvas.addEventListener('touchstart', touchStartHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchmove', touchMoveHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchend', touchEndHandler);\r\n      canvas.addEventListener('touchcancel', touchEndHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('touchstart', touchStartHandler),\r\n        () => canvas.removeEventListener('touchmove', touchMoveHandler),\r\n        () => canvas.removeEventListener('touchend', touchEndHandler),\r\n        () => canvas.removeEventListener('touchcancel', touchEndHandler)\r\n      );\r\n    } else {\r\n      // Mouse events for PC\r\n      const mouseDownHandler = this.handleMouseDown.bind(this);\r\n      const mouseMoveHandler = this.handleMouseMove.bind(this);\r\n      const mouseUpHandler = this.handleMouseUp.bind(this);\r\n      const dblClickHandler = this.handleDoubleClick.bind(this);\r\n\r\n      canvas.addEventListener('mousedown', mouseDownHandler);\r\n      canvas.addEventListener('mousemove', mouseMoveHandler);\r\n      canvas.addEventListener('mouseup', mouseUpHandler);\r\n      canvas.addEventListener('mouseleave', mouseUpHandler);\r\n      canvas.addEventListener('dblclick', dblClickHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('mousedown', mouseDownHandler),\r\n        () => canvas.removeEventListener('mousemove', mouseMoveHandler),\r\n        () => canvas.removeEventListener('mouseup', mouseUpHandler),\r\n        () => canvas.removeEventListener('mouseleave', mouseUpHandler),\r\n        () => canvas.removeEventListener('dblclick', dblClickHandler)\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up all event listeners\r\n   */\r\n  private cleanupEventListeners(): void {\r\n    for (const cleanup of this.cleanupFunctions) {\r\n      cleanup();\r\n    }\r\n    this.cleanupFunctions = [];\r\n  }\r\n\r\n  /**\r\n   * Reset drag state\r\n   */\r\n  private resetDragState(): void {\r\n    this.dragState = {\r\n      isDragging: false,\r\n      layerId: null,\r\n      startX: 0,\r\n      startY: 0,\r\n      offsetX: 0,\r\n      offsetY: 0,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle mouse down event\r\n   */\r\n  private handleMouseDown(event: MouseEvent): void {\r\n    const canvas = this.getCanvas();\r\n    const ctx = this.getContext();\r\n    if (!canvas || !ctx) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startInteraction(pointerEvent.x, pointerEvent.y, ctx);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse move event\r\n   */\r\n  private handleMouseMove(event: MouseEvent): void {\r\n    if (!this.dragState.isDragging) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrag(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse up event\r\n   */\r\n  private handleMouseUp(): void {\r\n    if (this.dragState.isDragging) {\r\n      this.endDrag();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle double click event - add new text\r\n   */\r\n  private handleDoubleClick(event: MouseEvent): void {\r\n    const canvas = this.getCanvas();\r\n    const ctx = this.getContext();\r\n    if (!canvas || !ctx) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    \r\n    // Check if clicking on existing layer\r\n    const layers = this.layerManager.getAllLayers();\r\n    const clickedLayer = findTextLayerAtPoint(pointerEvent.x, pointerEvent.y, layers, ctx);\r\n    \r\n    if (!clickedLayer) {\r\n      // Add new text at click position\r\n      const defaultText = 'Double click to edit';\r\n      this.addText(defaultText, pointerEvent.x, pointerEvent.y);\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle touch start event\r\n   */\r\n  private handleTouchStart(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    const canvas = this.getCanvas();\r\n    const ctx = this.getContext();\r\n    if (!canvas || !ctx) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startInteraction(pointerEvent.x, pointerEvent.y, ctx);\r\n  }\r\n\r\n  /**\r\n   * Handle touch move event\r\n   */\r\n  private handleTouchMove(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    if (!this.dragState.isDragging) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrag(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle touch end event\r\n   */\r\n  private handleTouchEnd(): void {\r\n    if (this.dragState.isDragging) {\r\n      this.endDrag();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start interaction (select or drag)\r\n   */\r\n  private startInteraction(x: number, y: number, ctx: CanvasRenderingContext2D): void {\r\n    const layers = this.layerManager.getAllLayers();\r\n    const clickedLayer = findTextLayerAtPoint(x, y, layers, ctx);\r\n\r\n    if (clickedLayer) {\r\n      // Select and start dragging\r\n      this.layerManager.selectLayer(clickedLayer.id);\r\n      \r\n      this.dragState = {\r\n        isDragging: true,\r\n        layerId: clickedLayer.id,\r\n        startX: x,\r\n        startY: y,\r\n        offsetX: x - clickedLayer.x,\r\n        offsetY: y - clickedLayer.y,\r\n      };\r\n      \r\n      this.renderLayers();\r\n    } else {\r\n      // Deselect\r\n      this.layerManager.selectLayer(null);\r\n      this.renderLayers();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Continue drag operation\r\n   * Requirements: 4.4\r\n   */\r\n  private continueDrag(x: number, y: number): void {\r\n    if (!this.dragState.isDragging || !this.dragState.layerId) return;\r\n\r\n    const newX = x - this.dragState.offsetX;\r\n    const newY = y - this.dragState.offsetY;\r\n\r\n    this.layerManager.updatePosition(this.dragState.layerId, newX, newY);\r\n    this.renderLayers();\r\n  }\r\n\r\n  /**\r\n   * End drag operation\r\n   * Requirements: 4.4\r\n   */\r\n  private endDrag(): void {\r\n    if (this.dragState.isDragging && this.dragState.layerId) {\r\n      this.saveState();\r\n    }\r\n    this.resetDragState();\r\n  }\r\n\r\n  /**\r\n   * Flatten text layers into the base image\r\n   * Call this before exporting or when finalizing edits\r\n   */\r\n  flattenLayers(): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n\r\n    // Render layers without selection\r\n    if (this.baseImageData) {\r\n      ctx.putImageData(this.baseImageData, 0, 0);\r\n    }\r\n    \r\n    const layers = this.layerManager.getAllLayers();\r\n    renderAllTextLayers(ctx, layers, null);\r\n\r\n    // Update base image with flattened result\r\n    this.baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    // Clear layers\r\n    this.layerManager.clearAll();\r\n  }\r\n\r\n  /**\r\n   * Update base image (call after external canvas changes)\r\n   */\r\n  updateBaseImage(): void {\r\n    this.saveBaseImage();\r\n    this.renderLayers();\r\n  }\r\n}\r\n","/**\r\n * Brightness filter algorithm\r\n * Requirements: 5.3 - Support brightness filter\r\n */\r\n\r\n/**\r\n * Apply brightness adjustment to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Brightness value from -100 to 100 (0 = no change)\r\n */\r\nexport function applyBrightness(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert -100 to 100 range to -255 to 255 adjustment\r\n  const adjustment = (value / 100) * 255;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    data[i] = clamp(data[i] + adjustment);     // R\r\n    data[i + 1] = clamp(data[i + 1] + adjustment); // G\r\n    data[i + 2] = clamp(data[i + 2] + adjustment); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to the 0-255 range\r\n */\r\nfunction clamp(value: number): number {\r\n  return Math.max(0, Math.min(255, Math.round(value)));\r\n}\r\n","/**\r\n * Contrast filter algorithm\r\n * Requirements: 5.3 - Support contrast filter\r\n */\r\n\r\n/**\r\n * Apply contrast adjustment to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Contrast value from -100 to 100 (0 = no change)\r\n */\r\nexport function applyContrast(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert -100 to 100 range to contrast factor\r\n  // At value = 100, factor ≈ 2.59 (high contrast)\r\n  // At value = -100, factor ≈ 0 (no contrast, all gray)\r\n  const factor = (259 * (value + 255)) / (255 * (259 - value));\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    data[i] = clamp(factor * (data[i] - 128) + 128);     // R\r\n    data[i + 1] = clamp(factor * (data[i + 1] - 128) + 128); // G\r\n    data[i + 2] = clamp(factor * (data[i + 2] - 128) + 128); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to the 0-255 range\r\n */\r\nfunction clamp(value: number): number {\r\n  return Math.max(0, Math.min(255, Math.round(value)));\r\n}\r\n","/**\r\n * Saturation filter algorithm\r\n * Requirements: 5.3 - Support saturation filter\r\n */\r\n\r\n/**\r\n * Apply saturation adjustment to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Saturation value from -100 to 100 (0 = no change)\r\n */\r\nexport function applySaturation(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert -100 to 100 range to saturation multiplier\r\n  // At value = -100, multiplier = 0 (grayscale)\r\n  // At value = 0, multiplier = 1 (no change)\r\n  // At value = 100, multiplier = 2 (double saturation)\r\n  const multiplier = 1 + value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Calculate grayscale value using luminance formula\r\n    const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;\r\n\r\n    // Interpolate between grayscale and original color\r\n    data[i] = clamp(gray + (r - gray) * multiplier);     // R\r\n    data[i + 1] = clamp(gray + (g - gray) * multiplier); // G\r\n    data[i + 2] = clamp(gray + (b - gray) * multiplier); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to the 0-255 range\r\n */\r\nfunction clamp(value: number): number {\r\n  return Math.max(0, Math.min(255, Math.round(value)));\r\n}\r\n","/**\r\n * Blur filter algorithm (Box blur)\r\n * Requirements: 5.3 - Support blur filter\r\n */\r\n\r\n/**\r\n * Apply blur effect to image data using box blur algorithm\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Blur value from 0 to 100 (0 = no blur)\r\n */\r\nexport function applyBlur(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const { width, height, data } = imageData;\r\n  // Convert 0-100 range to blur radius (0-10 pixels)\r\n  const radius = Math.round((value / 100) * 10);\r\n  \r\n  if (radius === 0) return;\r\n\r\n  // Create a copy of the original data\r\n  const original = new Uint8ClampedArray(data);\r\n\r\n  // Apply horizontal blur pass\r\n  const temp = new Uint8ClampedArray(data.length);\r\n  horizontalBlur(original, temp, width, height, radius);\r\n\r\n  // Apply vertical blur pass\r\n  verticalBlur(temp, data, width, height, radius);\r\n}\r\n\r\n/**\r\n * Horizontal blur pass\r\n */\r\nfunction horizontalBlur(\r\n  src: Uint8ClampedArray,\r\n  dst: Uint8ClampedArray,\r\n  width: number,\r\n  height: number,\r\n  radius: number\r\n): void {\r\n  const diameter = radius * 2 + 1;\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    let rSum = 0, gSum = 0, bSum = 0, aSum = 0;\r\n    \r\n    // Initialize sum for first pixel\r\n    for (let x = -radius; x <= radius; x++) {\r\n      const px = Math.max(0, Math.min(width - 1, x));\r\n      const idx = (y * width + px) * 4;\r\n      rSum += src[idx];\r\n      gSum += src[idx + 1];\r\n      bSum += src[idx + 2];\r\n      aSum += src[idx + 3];\r\n    }\r\n\r\n    for (let x = 0; x < width; x++) {\r\n      const dstIdx = (y * width + x) * 4;\r\n      dst[dstIdx] = Math.round(rSum / diameter);\r\n      dst[dstIdx + 1] = Math.round(gSum / diameter);\r\n      dst[dstIdx + 2] = Math.round(bSum / diameter);\r\n      dst[dstIdx + 3] = Math.round(aSum / diameter);\r\n\r\n      // Slide the window\r\n      const leftX = Math.max(0, x - radius);\r\n      const rightX = Math.min(width - 1, x + radius + 1);\r\n      \r\n      const leftIdx = (y * width + leftX) * 4;\r\n      const rightIdx = (y * width + rightX) * 4;\r\n\r\n      rSum += src[rightIdx] - src[leftIdx];\r\n      gSum += src[rightIdx + 1] - src[leftIdx + 1];\r\n      bSum += src[rightIdx + 2] - src[leftIdx + 2];\r\n      aSum += src[rightIdx + 3] - src[leftIdx + 3];\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Vertical blur pass\r\n */\r\nfunction verticalBlur(\r\n  src: Uint8ClampedArray,\r\n  dst: Uint8ClampedArray,\r\n  width: number,\r\n  height: number,\r\n  radius: number\r\n): void {\r\n  const diameter = radius * 2 + 1;\r\n\r\n  for (let x = 0; x < width; x++) {\r\n    let rSum = 0, gSum = 0, bSum = 0, aSum = 0;\r\n    \r\n    // Initialize sum for first pixel\r\n    for (let y = -radius; y <= radius; y++) {\r\n      const py = Math.max(0, Math.min(height - 1, y));\r\n      const idx = (py * width + x) * 4;\r\n      rSum += src[idx];\r\n      gSum += src[idx + 1];\r\n      bSum += src[idx + 2];\r\n      aSum += src[idx + 3];\r\n    }\r\n\r\n    for (let y = 0; y < height; y++) {\r\n      const dstIdx = (y * width + x) * 4;\r\n      dst[dstIdx] = Math.round(rSum / diameter);\r\n      dst[dstIdx + 1] = Math.round(gSum / diameter);\r\n      dst[dstIdx + 2] = Math.round(bSum / diameter);\r\n      dst[dstIdx + 3] = Math.round(aSum / diameter);\r\n\r\n      // Slide the window\r\n      const topY = Math.max(0, y - radius);\r\n      const bottomY = Math.min(height - 1, y + radius + 1);\r\n      \r\n      const topIdx = (topY * width + x) * 4;\r\n      const bottomIdx = (bottomY * width + x) * 4;\r\n\r\n      rSum += src[bottomIdx] - src[topIdx];\r\n      gSum += src[bottomIdx + 1] - src[topIdx + 1];\r\n      bSum += src[bottomIdx + 2] - src[topIdx + 2];\r\n      aSum += src[bottomIdx + 3] - src[topIdx + 3];\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Grayscale filter algorithm\r\n * Requirements: 5.3 - Support grayscale filter\r\n */\r\n\r\n/**\r\n * Apply grayscale effect to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Grayscale value from 0 to 100 (0 = no effect, 100 = full grayscale)\r\n */\r\nexport function applyGrayscale(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert 0-100 range to blend factor (0-1)\r\n  const factor = value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Calculate grayscale value using luminance formula (ITU-R BT.709)\r\n    const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;\r\n\r\n    // Blend between original and grayscale based on factor\r\n    data[i] = Math.round(r + (gray - r) * factor);     // R\r\n    data[i + 1] = Math.round(g + (gray - g) * factor); // G\r\n    data[i + 2] = Math.round(b + (gray - b) * factor); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Apply sepia effect to image data\r\n * Requirements: 5.3 - Support sepia (vintage) filter\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Sepia value from 0 to 100 (0 = no effect, 100 = full sepia)\r\n */\r\nexport function applySepia(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert 0-100 range to blend factor (0-1)\r\n  const factor = value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Sepia transformation matrix\r\n    const sepiaR = Math.min(255, 0.393 * r + 0.769 * g + 0.189 * b);\r\n    const sepiaG = Math.min(255, 0.349 * r + 0.686 * g + 0.168 * b);\r\n    const sepiaB = Math.min(255, 0.272 * r + 0.534 * g + 0.131 * b);\r\n\r\n    // Blend between original and sepia based on factor\r\n    data[i] = Math.round(r + (sepiaR - r) * factor);     // R\r\n    data[i + 1] = Math.round(g + (sepiaG - g) * factor); // G\r\n    data[i + 2] = Math.round(b + (sepiaB - b) * factor); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Apply invert (negative) effect to image data\r\n * Requirements: 5.3 - Support invert filter\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Invert value from 0 to 100 (0 = no effect, 100 = full invert)\r\n */\r\nexport function applyInvert(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert 0-100 range to blend factor (0-1)\r\n  const factor = value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Inverted colors\r\n    const invertR = 255 - r;\r\n    const invertG = 255 - g;\r\n    const invertB = 255 - b;\r\n\r\n    // Blend between original and inverted based on factor\r\n    data[i] = Math.round(r + (invertR - r) * factor);     // R\r\n    data[i + 1] = Math.round(g + (invertG - g) * factor); // G\r\n    data[i + 2] = Math.round(b + (invertB - b) * factor); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n","/**\r\n * Filter Plugin - Apply various image filters\r\n * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5\r\n */\r\n\r\nimport { BasePlugin } from '../base/BasePlugin';\r\nimport type { FilterConfig } from '../../types/config.types';\r\nimport type { FilterPluginInterface } from '../../types/plugin.types';\r\nimport {\r\n  applyBrightness,\r\n  applyContrast,\r\n  applySaturation,\r\n  applyBlur,\r\n  applyGrayscale,\r\n  applySepia,\r\n  applyInvert,\r\n} from './filters';\r\n\r\n/**\r\n * Default filter configuration\r\n */\r\nconst DEFAULT_FILTER_CONFIG: FilterConfig = {\r\n  brightness: 0,\r\n  contrast: 0,\r\n  saturation: 0,\r\n  blur: 0,\r\n  grayscale: 0,\r\n  sepia: 0,\r\n  invert: 0,\r\n};\r\n\r\n/**\r\n * FilterPlugin - Provides image filter functionality\r\n * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5\r\n */\r\nexport class FilterPlugin extends BasePlugin<FilterConfig> implements FilterPluginInterface {\r\n  readonly name = 'filter' as const;\r\n  readonly icon = '🎨';\r\n  readonly title = 'Filter';\r\n\r\n  /** Original image data before any filters applied */\r\n  private originalImageData: ImageData | null = null;\r\n\r\n  /**\r\n   * Get default filter configuration\r\n   */\r\n  getDefaultConfig(): FilterConfig {\r\n    return { ...DEFAULT_FILTER_CONFIG };\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is installed\r\n   */\r\n  protected onInstall(): void {\r\n    // Store original image data when installed\r\n    this.storeOriginalImageData();\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is activated\r\n   */\r\n  protected onActivate(): void {\r\n    // Ensure we have original image data\r\n    if (!this.originalImageData) {\r\n      this.storeOriginalImageData();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Store the original image data for reset functionality\r\n   */\r\n  private storeOriginalImageData(): void {\r\n    const imageData = this.getImageData();\r\n    if (imageData) {\r\n      this.originalImageData = createImageDataCopy(imageData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update original image data (call after external changes)\r\n   */\r\n  updateOriginalImageData(): void {\r\n    this.storeOriginalImageData();\r\n  }\r\n\r\n  /**\r\n   * Set brightness value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Brightness value from -100 to 100\r\n   */\r\n  setBrightness(value: number): void {\r\n    this.setConfig({ brightness: clampValue(value, -100, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set contrast value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Contrast value from -100 to 100\r\n   */\r\n  setContrast(value: number): void {\r\n    this.setConfig({ contrast: clampValue(value, -100, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set saturation value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Saturation value from -100 to 100\r\n   */\r\n  setSaturation(value: number): void {\r\n    this.setConfig({ saturation: clampValue(value, -100, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set blur value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Blur value from 0 to 100\r\n   */\r\n  setBlur(value: number): void {\r\n    this.setConfig({ blur: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set grayscale value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Grayscale value from 0 to 100\r\n   */\r\n  setGrayscale(value: number): void {\r\n    this.setConfig({ grayscale: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set sepia value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Sepia value from 0 to 100\r\n   */\r\n  setSepia(value: number): void {\r\n    this.setConfig({ sepia: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set invert value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Invert value from 0 to 100\r\n   */\r\n  setInvert(value: number): void {\r\n    this.setConfig({ invert: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Apply filter configuration\r\n   * Requirements: 5.1 - Apply filter to entire image\r\n   * @param config - Partial filter configuration to apply\r\n   */\r\n  applyFilter(config: Partial<FilterConfig>): void {\r\n    // Clamp all values\r\n    const clampedConfig: Partial<FilterConfig> = {};\r\n    if (config.brightness !== undefined) {\r\n      clampedConfig.brightness = clampValue(config.brightness, -100, 100);\r\n    }\r\n    if (config.contrast !== undefined) {\r\n      clampedConfig.contrast = clampValue(config.contrast, -100, 100);\r\n    }\r\n    if (config.saturation !== undefined) {\r\n      clampedConfig.saturation = clampValue(config.saturation, -100, 100);\r\n    }\r\n    if (config.blur !== undefined) {\r\n      clampedConfig.blur = clampValue(config.blur, 0, 100);\r\n    }\r\n    if (config.grayscale !== undefined) {\r\n      clampedConfig.grayscale = clampValue(config.grayscale, 0, 100);\r\n    }\r\n    if (config.sepia !== undefined) {\r\n      clampedConfig.sepia = clampValue(config.sepia, 0, 100);\r\n    }\r\n    if (config.invert !== undefined) {\r\n      clampedConfig.invert = clampValue(config.invert, 0, 100);\r\n    }\r\n\r\n    this.setConfig(clampedConfig);\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Reset all filters to default values\r\n   * Requirements: 5.5 - Reset to original state\r\n   */\r\n  reset(): void {\r\n    // Reset config to defaults\r\n    this.config = this.getDefaultConfig();\r\n    \r\n    // Restore original image data\r\n    if (this.originalImageData) {\r\n      const restoredData = createImageDataCopy(this.originalImageData);\r\n      this.putImageData(restoredData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get preview of current filter settings\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @returns ImageData with filters applied\r\n   */\r\n  getPreview(): ImageData {\r\n    if (!this.originalImageData) {\r\n      const currentData = this.getImageData();\r\n      if (!currentData) {\r\n        throw new Error('No image data available');\r\n      }\r\n      return currentData;\r\n    }\r\n\r\n    // Create a copy of original data\r\n    const previewData = createImageDataCopy(this.originalImageData);\r\n\r\n    // Apply all filters to the copy\r\n    this.applyFiltersToImageData(previewData);\r\n\r\n    return previewData;\r\n  }\r\n\r\n  /**\r\n   * Apply all filters in sequence\r\n   * Requirements: 5.4 - Multiple filters stacked in order\r\n   */\r\n  private applyAllFilters(): void {\r\n    if (!this.originalImageData) {\r\n      return;\r\n    }\r\n\r\n    // Start with a fresh copy of original data\r\n    const imageData = createImageDataCopy(this.originalImageData);\r\n\r\n    // Apply all filters\r\n    this.applyFiltersToImageData(imageData);\r\n\r\n    // Put the result back to canvas\r\n    this.putImageData(imageData);\r\n  }\r\n\r\n  /**\r\n   * Apply all configured filters to image data\r\n   * Requirements: 5.4 - Filters applied in order\r\n   * @param imageData - ImageData to modify in place\r\n   */\r\n  private applyFiltersToImageData(imageData: ImageData): void {\r\n    const config = this.config;\r\n\r\n    // Apply filters in a consistent order\r\n    // Order: brightness -> contrast -> saturation -> grayscale -> sepia -> invert -> blur\r\n    // (blur is last because it's computationally expensive and works better on final colors)\r\n    \r\n    if (config.brightness !== 0) {\r\n      applyBrightness(imageData, config.brightness);\r\n    }\r\n    \r\n    if (config.contrast !== 0) {\r\n      applyContrast(imageData, config.contrast);\r\n    }\r\n    \r\n    if (config.saturation !== 0) {\r\n      applySaturation(imageData, config.saturation);\r\n    }\r\n    \r\n    if (config.grayscale !== 0) {\r\n      applyGrayscale(imageData, config.grayscale);\r\n    }\r\n    \r\n    if (config.sepia !== 0) {\r\n      applySepia(imageData, config.sepia);\r\n    }\r\n    \r\n    if (config.invert !== 0) {\r\n      applyInvert(imageData, config.invert);\r\n    }\r\n    \r\n    if (config.blur !== 0) {\r\n      applyBlur(imageData, config.blur);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Commit current filter state to history\r\n   * Call this when user confirms filter changes\r\n   */\r\n  commit(): void {\r\n    this.saveState();\r\n    // Update original image data to current state\r\n    this.storeOriginalImageData();\r\n    // Reset config since changes are now committed\r\n    this.config = this.getDefaultConfig();\r\n  }\r\n\r\n  /**\r\n   * Check if any filter is currently applied\r\n   * @returns True if any filter value is non-zero\r\n   */\r\n  hasActiveFilters(): boolean {\r\n    const config = this.config;\r\n    return (\r\n      config.brightness !== 0 ||\r\n      config.contrast !== 0 ||\r\n      config.saturation !== 0 ||\r\n      config.blur !== 0 ||\r\n      config.grayscale !== 0 ||\r\n      config.sepia !== 0 ||\r\n      config.invert !== 0\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is destroyed\r\n   */\r\n  protected onDestroy(): void {\r\n    this.originalImageData = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to a range\r\n */\r\nfunction clampValue(value: number, min: number, max: number): number {\r\n  return Math.max(min, Math.min(max, value));\r\n}\r\n\r\n/**\r\n * Create a copy of ImageData\r\n * Works in both browser and test environments\r\n */\r\nfunction createImageDataCopy(imageData: ImageData): ImageData {\r\n  const data = new Uint8ClampedArray(imageData.data);\r\n  // Try to use ImageData constructor if available (browser)\r\n  if (typeof ImageData !== 'undefined') {\r\n    try {\r\n      return new ImageData(data, imageData.width, imageData.height);\r\n    } catch {\r\n      // Fall through to mock implementation\r\n    }\r\n  }\r\n  // Fallback for test environments\r\n  return {\r\n    data,\r\n    width: imageData.width,\r\n    height: imageData.height,\r\n    colorSpace: 'srgb',\r\n  } as ImageData;\r\n}\r\n","/**\r\n * 中文语言包 (Simplified Chinese)\r\n */\r\nexport const zhCN = {\r\n  // Tool names\r\n  'tool.move': '移动',\r\n  'tool.pen': '画笔',\r\n  'tool.rect': '矩形',\r\n  'tool.circle': '圆形',\r\n  'tool.arrow': '箭头',\r\n  'tool.line': '直线',\r\n  'tool.triangle': '三角形',\r\n  'tool.text': '文字',\r\n  'tool.mosaic': '马赛克',\r\n  'tool.eraser': '橡皮擦',\r\n  'tool.crop': '裁剪',\r\n  'tool.filter': '滤镜',\r\n\r\n  // Zoom controls\r\n  'zoom.in': '放大',\r\n  'zoom.out': '缩小',\r\n  'zoom.reset': '重置视图',\r\n  'zoom.fitScreen': '适应屏幕',\r\n\r\n  // History controls\r\n  'history.undo': '撤销',\r\n  'history.redo': '重做',\r\n\r\n  // Export\r\n  'export.button': '导出',\r\n  'export.title': '导出图片',\r\n  'export.format': '格式',\r\n  'export.quality': '质量',\r\n  'export.size': '尺寸',\r\n  'export.original': '原始尺寸',\r\n  'export.custom': '自定义',\r\n  'export.width': '宽度',\r\n  'export.height': '高度',\r\n  'export.keepRatio': '保持比例',\r\n  'export.watermark': '水印',\r\n  'export.watermarkText': '文字水印',\r\n  'export.watermarkImage': '图片水印',\r\n  'export.preview': '预览',\r\n  'export.download': '下载',\r\n  'export.cancel': '取消',\r\n\r\n  // Panels\r\n  'panel.draw': '绘图设置',\r\n  'panel.strokeWidth': '线宽',\r\n  'panel.strokeColor': '颜色',\r\n  'panel.fillColor': '填充颜色',\r\n  'panel.strokeStyle': '线条样式',\r\n  'panel.solid': '实线',\r\n  'panel.dashed': '虚线',\r\n  'panel.dotted': '点线',\r\n  'panel.fill': '填充',\r\n  'panel.stroke': '描边',\r\n  'panel.both': '描边+填充',\r\n\r\n  'panel.mosaic': '马赛克设置',\r\n  'panel.brushSize': '笔刷大小',\r\n  'panel.blockSize': '色块大小',\r\n\r\n  'panel.text': '文字设置',\r\n  'panel.textHint': '点击图片添加文字',\r\n  'panel.fontSize': '字号',\r\n  'panel.fontFamily': '字体',\r\n  'panel.fontStyle': '样式',\r\n  'panel.bold': '粗体',\r\n  'panel.italic': '斜体',\r\n  'panel.underline': '下划线',\r\n  'panel.textStroke': '文字描边',\r\n  'panel.textStrokeWidth': '描边宽度',\r\n  'panel.textStrokeColor': '描边颜色',\r\n\r\n  'panel.eraser': '橡皮擦设置',\r\n  'panel.eraserSize': '橡皮擦大小',\r\n  'panel.eraserMode': '擦除模式',\r\n  'panel.eraserShape': '擦除形状',\r\n  'panel.eraserPixel': '擦除像素',\r\n\r\n  // Filter\r\n  'filter.title': '滤镜调整',\r\n  'filter.brightness': '亮度',\r\n  'filter.contrast': '对比度',\r\n  'filter.saturation': '饱和度',\r\n  'filter.blur': '模糊',\r\n  'filter.grayscale': '灰度',\r\n  'filter.sepia': '复古',\r\n  'filter.invert': '反色',\r\n  'filter.presets': '预设滤镜',\r\n  'filter.preset.original': '原图',\r\n  'filter.preset.vintage': '复古',\r\n  'filter.preset.cold': '冷色',\r\n  'filter.preset.warm': '暖色',\r\n  'filter.preset.grayscale': '黑白',\r\n  'filter.reset': '重置',\r\n  'filter.apply': '应用',\r\n\r\n  // Crop\r\n  'crop.title': '裁剪',\r\n  'crop.ratio': '裁剪比例',\r\n  'crop.free': '自由',\r\n  'crop.square': '正方形 1:1',\r\n  'crop.ratio43': '标准 4:3',\r\n  'crop.ratio169': '宽屏 16:9',\r\n  'crop.ratio32': '横幅 3:2',\r\n  'crop.rotate': '旋转',\r\n  'crop.rotateLeft': '逆时针90°',\r\n  'crop.rotateRight': '顺时针90°',\r\n  'crop.flipH': '水平翻转',\r\n  'crop.flipV': '垂直翻转',\r\n  'crop.apply': '应用裁剪',\r\n  'crop.cancel': '取消',\r\n\r\n  // Ruler & Grid\r\n  'ruler.show': '显示标尺',\r\n  'ruler.hide': '隐藏标尺',\r\n  'grid.show': '显示网格',\r\n  'grid.hide': '隐藏网格',\r\n\r\n  // Context Menu\r\n  'context.copy': '复制',\r\n  'context.paste': '粘贴',\r\n  'context.delete': '删除',\r\n  'context.bringToFront': '置于顶层',\r\n  'context.sendToBack': '置于底层',\r\n  'context.bringForward': '上移一层',\r\n  'context.sendBackward': '下移一层',\r\n  'context.duplicate': '复制图层',\r\n\r\n  // Messages\r\n  'message.exportSuccess': '导出成功',\r\n  'message.exportFailed': '导出失败',\r\n  'message.loadImageFailed': '加载图片失败',\r\n  'message.noImageLoaded': '请先加载图片',\r\n  'message.cropApplied': '裁剪已应用',\r\n  'message.filterApplied': '滤镜已应用',\r\n  'message.copied': '已复制',\r\n  'message.pasted': '已粘贴',\r\n\r\n  // Placeholder\r\n  'placeholder.title': '点击或拖拽图片到此处',\r\n  'placeholder.subtitle': '支持 JPG、PNG、WebP 格式',\r\n\r\n  // Keyboard shortcuts hints\r\n  'shortcut.undo': 'Ctrl+Z',\r\n  'shortcut.redo': 'Ctrl+Y',\r\n  'shortcut.copy': 'Ctrl+C',\r\n  'shortcut.paste': 'Ctrl+V',\r\n  'shortcut.delete': 'Delete',\r\n  'shortcut.escape': 'Esc',\r\n  'shortcut.zoomIn': '+',\r\n  'shortcut.zoomOut': '-',\r\n};\r\n\r\nexport type LocaleMessages = typeof zhCN;\r\n","/**\r\n * English language pack (US)\r\n */\r\nimport type { LocaleMessages } from './zh-CN';\r\n\r\nexport const enUS: LocaleMessages = {\r\n  // Tool names\r\n  'tool.move': 'Move',\r\n  'tool.pen': 'Pen',\r\n  'tool.rect': 'Rectangle',\r\n  'tool.circle': 'Circle',\r\n  'tool.arrow': 'Arrow',\r\n  'tool.line': 'Line',\r\n  'tool.triangle': 'Triangle',\r\n  'tool.text': 'Text',\r\n  'tool.mosaic': 'Mosaic',\r\n  'tool.eraser': 'Eraser',\r\n  'tool.crop': 'Crop',\r\n  'tool.filter': 'Filter',\r\n\r\n  // Zoom controls\r\n  'zoom.in': 'Zoom In',\r\n  'zoom.out': 'Zoom Out',\r\n  'zoom.reset': 'Reset View',\r\n  'zoom.fitScreen': 'Fit to Screen',\r\n\r\n  // History controls\r\n  'history.undo': 'Undo',\r\n  'history.redo': 'Redo',\r\n\r\n  // Export\r\n  'export.button': 'Export',\r\n  'export.title': 'Export Image',\r\n  'export.format': 'Format',\r\n  'export.quality': 'Quality',\r\n  'export.size': 'Size',\r\n  'export.original': 'Original Size',\r\n  'export.custom': 'Custom',\r\n  'export.width': 'Width',\r\n  'export.height': 'Height',\r\n  'export.keepRatio': 'Keep Ratio',\r\n  'export.watermark': 'Watermark',\r\n  'export.watermarkText': 'Text Watermark',\r\n  'export.watermarkImage': 'Image Watermark',\r\n  'export.preview': 'Preview',\r\n  'export.download': 'Download',\r\n  'export.cancel': 'Cancel',\r\n\r\n  // Panels\r\n  'panel.draw': 'Drawing Settings',\r\n  'panel.strokeWidth': 'Stroke Width',\r\n  'panel.strokeColor': 'Color',\r\n  'panel.fillColor': 'Fill Color',\r\n  'panel.strokeStyle': 'Stroke Style',\r\n  'panel.solid': 'Solid',\r\n  'panel.dashed': 'Dashed',\r\n  'panel.dotted': 'Dotted',\r\n  'panel.fill': 'Fill',\r\n  'panel.stroke': 'Stroke',\r\n  'panel.both': 'Stroke + Fill',\r\n\r\n  'panel.mosaic': 'Mosaic Settings',\r\n  'panel.brushSize': 'Brush Size',\r\n  'panel.blockSize': 'Block Size',\r\n\r\n  'panel.text': 'Text Settings',\r\n  'panel.textHint': 'Click on image to add text',\r\n  'panel.fontSize': 'Font Size',\r\n  'panel.fontFamily': 'Font',\r\n  'panel.fontStyle': 'Style',\r\n  'panel.bold': 'Bold',\r\n  'panel.italic': 'Italic',\r\n  'panel.underline': 'Underline',\r\n  'panel.textStroke': 'Text Stroke',\r\n  'panel.textStrokeWidth': 'Stroke Width',\r\n  'panel.textStrokeColor': 'Stroke Color',\r\n\r\n  'panel.eraser': 'Eraser Settings',\r\n  'panel.eraserSize': 'Eraser Size',\r\n  'panel.eraserMode': 'Eraser Mode',\r\n  'panel.eraserShape': 'Erase Shapes',\r\n  'panel.eraserPixel': 'Erase Pixels',\r\n\r\n  // Filter\r\n  'filter.title': 'Filter Adjustments',\r\n  'filter.brightness': 'Brightness',\r\n  'filter.contrast': 'Contrast',\r\n  'filter.saturation': 'Saturation',\r\n  'filter.blur': 'Blur',\r\n  'filter.grayscale': 'Grayscale',\r\n  'filter.sepia': 'Sepia',\r\n  'filter.invert': 'Invert',\r\n  'filter.presets': 'Preset Filters',\r\n  'filter.preset.original': 'Original',\r\n  'filter.preset.vintage': 'Vintage',\r\n  'filter.preset.cold': 'Cold',\r\n  'filter.preset.warm': 'Warm',\r\n  'filter.preset.grayscale': 'B&W',\r\n  'filter.reset': 'Reset',\r\n  'filter.apply': 'Apply',\r\n\r\n  // Crop\r\n  'crop.title': 'Crop',\r\n  'crop.ratio': 'Aspect Ratio',\r\n  'crop.free': 'Free',\r\n  'crop.square': 'Square 1:1',\r\n  'crop.ratio43': 'Standard 4:3',\r\n  'crop.ratio169': 'Wide 16:9',\r\n  'crop.ratio32': 'Photo 3:2',\r\n  'crop.rotate': 'Rotate',\r\n  'crop.rotateLeft': 'Rotate Left 90°',\r\n  'crop.rotateRight': 'Rotate Right 90°',\r\n  'crop.flipH': 'Flip Horizontal',\r\n  'crop.flipV': 'Flip Vertical',\r\n  'crop.apply': 'Apply Crop',\r\n  'crop.cancel': 'Cancel',\r\n\r\n  // Ruler & Grid\r\n  'ruler.show': 'Show Rulers',\r\n  'ruler.hide': 'Hide Rulers',\r\n  'grid.show': 'Show Grid',\r\n  'grid.hide': 'Hide Grid',\r\n\r\n  // Context Menu\r\n  'context.copy': 'Copy',\r\n  'context.paste': 'Paste',\r\n  'context.delete': 'Delete',\r\n  'context.bringToFront': 'Bring to Front',\r\n  'context.sendToBack': 'Send to Back',\r\n  'context.bringForward': 'Bring Forward',\r\n  'context.sendBackward': 'Send Backward',\r\n  'context.duplicate': 'Duplicate',\r\n\r\n  // Messages\r\n  'message.exportSuccess': 'Export successful',\r\n  'message.exportFailed': 'Export failed',\r\n  'message.loadImageFailed': 'Failed to load image',\r\n  'message.noImageLoaded': 'Please load an image first',\r\n  'message.cropApplied': 'Crop applied',\r\n  'message.filterApplied': 'Filter applied',\r\n  'message.copied': 'Copied',\r\n  'message.pasted': 'Pasted',\r\n\r\n  // Placeholder\r\n  'placeholder.title': 'Click or drag image here',\r\n  'placeholder.subtitle': 'Supports JPG, PNG, WebP formats',\r\n\r\n  // Keyboard shortcuts hints\r\n  'shortcut.undo': 'Ctrl+Z',\r\n  'shortcut.redo': 'Ctrl+Y',\r\n  'shortcut.copy': 'Ctrl+C',\r\n  'shortcut.paste': 'Ctrl+V',\r\n  'shortcut.delete': 'Delete',\r\n  'shortcut.escape': 'Esc',\r\n  'shortcut.zoomIn': '+',\r\n  'shortcut.zoomOut': '-',\r\n};\r\n","/**\r\n * Internationalization (i18n) system for the image editor\r\n */\r\nimport { zhCN, type LocaleMessages } from './locales/zh-CN';\r\nimport { enUS } from './locales/en-US';\r\n\r\nexport type SupportedLocale = 'zh-CN' | 'en-US';\r\n\r\nexport type LocaleKey = keyof LocaleMessages;\r\n\r\n/** Available locale packs */\r\nconst locales: Record<SupportedLocale, LocaleMessages> = {\r\n  'zh-CN': zhCN,\r\n  'en-US': enUS,\r\n};\r\n\r\n/**\r\n * I18n class - Manages internationalization\r\n */\r\nexport class I18n {\r\n  private locale: SupportedLocale;\r\n  private messages: LocaleMessages;\r\n  private fallbackMessages: LocaleMessages;\r\n\r\n  constructor(locale: SupportedLocale = 'zh-CN') {\r\n    this.locale = locale;\r\n    this.messages = locales[locale] || zhCN;\r\n    this.fallbackMessages = zhCN;\r\n  }\r\n\r\n  /**\r\n   * Get translated message by key\r\n   * @param key - Message key\r\n   * @param params - Optional parameters for interpolation\r\n   * @returns Translated message\r\n   */\r\n  t(key: LocaleKey, params?: Record<string, string | number>): string {\r\n    let message = this.messages[key] || this.fallbackMessages[key] || key;\r\n    \r\n    if (params) {\r\n      Object.entries(params).forEach(([k, v]) => {\r\n        message = message.replace(new RegExp(`\\\\{${k}\\\\}`, 'g'), String(v));\r\n      });\r\n    }\r\n    \r\n    return message;\r\n  }\r\n\r\n  /**\r\n   * Set current locale\r\n   * @param locale - Locale code\r\n   */\r\n  setLocale(locale: SupportedLocale): void {\r\n    if (locales[locale]) {\r\n      this.locale = locale;\r\n      this.messages = locales[locale];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current locale\r\n   * @returns Current locale code\r\n   */\r\n  getLocale(): SupportedLocale {\r\n    return this.locale;\r\n  }\r\n\r\n  /**\r\n   * Get all supported locales\r\n   * @returns Array of supported locale codes\r\n   */\r\n  getSupportedLocales(): SupportedLocale[] {\r\n    return Object.keys(locales) as SupportedLocale[];\r\n  }\r\n\r\n  /**\r\n   * Add or extend a locale\r\n   * @param locale - Locale code\r\n   * @param messages - Messages to add/merge\r\n   */\r\n  extendLocale(locale: SupportedLocale, messages: Partial<LocaleMessages>): void {\r\n    if (locales[locale]) {\r\n      locales[locale] = { ...locales[locale], ...messages };\r\n      if (this.locale === locale) {\r\n        this.messages = locales[locale];\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register a new locale\r\n   * @param locale - Locale code\r\n   * @param messages - Full message set\r\n   */\r\n  registerLocale(locale: string, messages: LocaleMessages): void {\r\n    (locales as Record<string, LocaleMessages>)[locale] = messages;\r\n  }\r\n\r\n  /**\r\n   * Detect browser locale and return supported locale\r\n   * @returns Detected or default locale\r\n   */\r\n  static detectLocale(): SupportedLocale {\r\n    if (typeof navigator === 'undefined') {\r\n      return 'zh-CN';\r\n    }\r\n    \r\n    const browserLocale = navigator.language || (navigator as any).userLanguage || 'zh-CN';\r\n    \r\n    // Check for exact match\r\n    if (browserLocale in locales) {\r\n      return browserLocale as SupportedLocale;\r\n    }\r\n    \r\n    // Check for language prefix match\r\n    const lang = browserLocale.split('-')[0];\r\n    if (lang === 'zh') return 'zh-CN';\r\n    if (lang === 'en') return 'en-US';\r\n    \r\n    return 'zh-CN';\r\n  }\r\n}\r\n\r\n// Export types and locales\r\nexport { zhCN, enUS };\r\nexport type { LocaleMessages };\r\n\r\n// Default instance\r\nlet defaultI18n: I18n | null = null;\r\n\r\n/**\r\n * Get or create default i18n instance\r\n * @param locale - Optional locale to set\r\n * @returns I18n instance\r\n */\r\nexport function getI18n(locale?: SupportedLocale): I18n {\r\n  if (!defaultI18n) {\r\n    defaultI18n = new I18n(locale || I18n.detectLocale());\r\n  } else if (locale) {\r\n    defaultI18n.setLocale(locale);\r\n  }\r\n  return defaultI18n;\r\n}\r\n\r\n/**\r\n * Shorthand translation function using default instance\r\n * @param key - Message key\r\n * @param params - Optional parameters\r\n * @returns Translated message\r\n */\r\nexport function t(key: LocaleKey, params?: Record<string, string | number>): string {\r\n  return getI18n().t(key, params);\r\n}\r\n","/**\r\n * CropTool - Handles image cropping, rotation and flipping\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport type { I18n } from '../i18n';\r\nimport { getI18n } from '../i18n';\r\n\r\nexport type CropRatio = 'free' | '1:1' | '4:3' | '16:9' | '3:2' | '2:3' | '3:4' | '9:16';\r\n\r\nexport interface CropRect {\r\n  x: number;\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface CropToolOptions {\r\n  /** Initial aspect ratio */\r\n  ratio?: CropRatio;\r\n  /** Minimum crop size */\r\n  minSize?: number;\r\n  /** Enable rotation */\r\n  enableRotation?: boolean;\r\n  /** Enable flip */\r\n  enableFlip?: boolean;\r\n  /** i18n instance */\r\n  i18n?: I18n;\r\n}\r\n\r\nconst MIN_CROP_SIZE = 20;\r\n\r\ntype HandlePosition = 'nw' | 'n' | 'ne' | 'e' | 'se' | 's' | 'sw' | 'w';\r\n\r\n/**\r\n * CropTool - Provides crop overlay and manipulation\r\n */\r\nexport class CropTool {\r\n  private container: HTMLElement;\r\n  private canvas: HTMLCanvasElement;\r\n  private overlay: HTMLElement | null = null;\r\n  private cropBox: HTMLElement | null = null;\r\n  private controlPanel: HTMLElement | null = null;\r\n  \r\n  private i18n: I18n;\r\n  private options: Required<CropToolOptions>;\r\n  \r\n  // Crop state\r\n  private cropRect: CropRect = { x: 0, y: 0, width: 0, height: 0 };\r\n  private rotation: number = 0;\r\n  private flipH: boolean = false;\r\n  private flipV: boolean = false;\r\n  private currentRatio: CropRatio = 'free';\r\n  \r\n  // Interaction state\r\n  private isDragging: boolean = false;\r\n  private isResizing: boolean = false;\r\n  private activeHandle: HandlePosition | null = null;\r\n  private dragStart = { x: 0, y: 0 };\r\n  private cropStart: CropRect = { x: 0, y: 0, width: 0, height: 0 };\r\n  \r\n  // Callbacks\r\n  private onApplyCallback: ((rect: CropRect, rotation: number, flipH: boolean, flipV: boolean) => void) | null = null;\r\n  private onCancelCallback: (() => void) | null = null;\r\n\r\n  constructor(container: HTMLElement, canvas: HTMLCanvasElement, options: CropToolOptions = {}) {\r\n    this.container = container;\r\n    this.canvas = canvas;\r\n    this.i18n = options.i18n || getI18n();\r\n    \r\n    this.options = {\r\n      ratio: options.ratio || 'free',\r\n      minSize: options.minSize || MIN_CROP_SIZE,\r\n      enableRotation: options.enableRotation !== false,\r\n      enableFlip: options.enableFlip !== false,\r\n      i18n: this.i18n,\r\n    };\r\n    \r\n    this.currentRatio = this.options.ratio;\r\n  }\r\n\r\n  /**\r\n   * Show crop tool\r\n   */\r\n  show(): void {\r\n    this.createOverlay();\r\n    this.initCropRect();\r\n    this.updateCropBox();\r\n    this.setupEvents();\r\n  }\r\n\r\n  /**\r\n   * Hide and cleanup crop tool\r\n   */\r\n  hide(): void {\r\n    this.removeOverlay();\r\n    this.cleanup();\r\n  }\r\n\r\n  /**\r\n   * Set apply callback\r\n   */\r\n  onApply(callback: (rect: CropRect, rotation: number, flipH: boolean, flipV: boolean) => void): void {\r\n    this.onApplyCallback = callback;\r\n  }\r\n\r\n  /**\r\n   * Set cancel callback\r\n   */\r\n  onCancel(callback: () => void): void {\r\n    this.onCancelCallback = callback;\r\n  }\r\n\r\n  /**\r\n   * Get current crop rect\r\n   */\r\n  getCropRect(): CropRect {\r\n    return { ...this.cropRect };\r\n  }\r\n\r\n  /**\r\n   * Set aspect ratio\r\n   */\r\n  setRatio(ratio: CropRatio): void {\r\n    this.currentRatio = ratio;\r\n    this.applyRatioConstraint();\r\n    this.updateCropBox();\r\n    this.updateRatioButtons();\r\n  }\r\n\r\n  /**\r\n   * Rotate image\r\n   */\r\n  rotate(angle: number): void {\r\n    this.rotation = (this.rotation + angle) % 360;\r\n    if (this.rotation < 0) this.rotation += 360;\r\n    this.updateRotationPreview();\r\n  }\r\n\r\n  /**\r\n   * Flip horizontally\r\n   */\r\n  flipHorizontal(): void {\r\n    this.flipH = !this.flipH;\r\n    this.updateFlipPreview();\r\n  }\r\n\r\n  /**\r\n   * Flip vertically\r\n   */\r\n  flipVertical(): void {\r\n    this.flipV = !this.flipV;\r\n    this.updateFlipPreview();\r\n  }\r\n\r\n  /**\r\n   * Create overlay elements\r\n   */\r\n  private createOverlay(): void {\r\n    // Main overlay\r\n    this.overlay = document.createElement('div');\r\n    this.overlay.className = 'ie-crop-overlay';\r\n    \r\n    // Crop box\r\n    this.cropBox = document.createElement('div');\r\n    this.cropBox.className = 'ie-crop-box';\r\n    \r\n    // Grid lines\r\n    const grid = document.createElement('div');\r\n    grid.className = 'ie-crop-grid';\r\n    grid.innerHTML = `\r\n      <div class=\"ie-crop-grid-h\"></div>\r\n      <div class=\"ie-crop-grid-h\"></div>\r\n      <div class=\"ie-crop-grid-v\"></div>\r\n      <div class=\"ie-crop-grid-v\"></div>\r\n    `;\r\n    this.cropBox.appendChild(grid);\r\n    \r\n    // Resize handles\r\n    const handles: HandlePosition[] = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];\r\n    handles.forEach(pos => {\r\n      const handle = document.createElement('div');\r\n      handle.className = `ie-crop-handle ie-crop-handle-${pos}`;\r\n      handle.dataset.handle = pos;\r\n      this.cropBox!.appendChild(handle);\r\n    });\r\n    \r\n    this.overlay.appendChild(this.cropBox);\r\n    \r\n    // Control panel\r\n    this.controlPanel = this.createControlPanel();\r\n    this.overlay.appendChild(this.controlPanel);\r\n    \r\n    this.container.appendChild(this.overlay);\r\n  }\r\n\r\n  /**\r\n   * Create control panel with ratio, rotate, flip buttons\r\n   */\r\n  private createControlPanel(): HTMLElement {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-crop-panel';\r\n    \r\n    const t = (key: string) => this.i18n.t(key as any);\r\n    \r\n    // Ratio buttons\r\n    const ratioGroup = document.createElement('div');\r\n    ratioGroup.className = 'ie-crop-group';\r\n    ratioGroup.innerHTML = `\r\n      <span class=\"ie-crop-label\">${t('crop.ratio')}</span>\r\n      <div class=\"ie-crop-buttons ie-crop-ratio-buttons\">\r\n        <button class=\"ie-crop-btn ${this.currentRatio === 'free' ? 'active' : ''}\" data-ratio=\"free\">${t('crop.free')}</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '1:1' ? 'active' : ''}\" data-ratio=\"1:1\">1:1</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '4:3' ? 'active' : ''}\" data-ratio=\"4:3\">4:3</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '16:9' ? 'active' : ''}\" data-ratio=\"16:9\">16:9</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '3:2' ? 'active' : ''}\" data-ratio=\"3:2\">3:2</button>\r\n      </div>\r\n    `;\r\n    panel.appendChild(ratioGroup);\r\n    \r\n    // Rotate & flip buttons\r\n    if (this.options.enableRotation || this.options.enableFlip) {\r\n      const transformGroup = document.createElement('div');\r\n      transformGroup.className = 'ie-crop-group';\r\n      transformGroup.innerHTML = `\r\n        <span class=\"ie-crop-label\">${t('crop.rotate')}</span>\r\n        <div class=\"ie-crop-buttons\">\r\n          ${this.options.enableRotation ? `\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"rotate-left\" title=\"${t('crop.rotateLeft')}\">${icons.rotateLeft}</button>\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"rotate-right\" title=\"${t('crop.rotateRight')}\">${icons.rotateRight}</button>\r\n          ` : ''}\r\n          ${this.options.enableFlip ? `\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"flip-h\" title=\"${t('crop.flipH')}\">${icons.flipH}</button>\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"flip-v\" title=\"${t('crop.flipV')}\">${icons.flipV}</button>\r\n          ` : ''}\r\n        </div>\r\n      `;\r\n      panel.appendChild(transformGroup);\r\n    }\r\n    \r\n    // Action buttons\r\n    const actionGroup = document.createElement('div');\r\n    actionGroup.className = 'ie-crop-group ie-crop-actions';\r\n    actionGroup.innerHTML = `\r\n      <button class=\"ie-crop-btn ie-crop-btn-cancel\" data-action=\"cancel\">${t('crop.cancel')}</button>\r\n      <button class=\"ie-crop-btn ie-crop-btn-apply\" data-action=\"apply\">${icons.check} ${t('crop.apply')}</button>\r\n    `;\r\n    panel.appendChild(actionGroup);\r\n    \r\n    // Event bindings\r\n    panel.addEventListener('click', (e) => {\r\n      const target = e.target as HTMLElement;\r\n      const btn = target.closest('[data-ratio], [data-action]') as HTMLElement;\r\n      if (!btn) return;\r\n      \r\n      const ratio = btn.dataset.ratio as CropRatio;\r\n      const action = btn.dataset.action;\r\n      \r\n      if (ratio) {\r\n        this.setRatio(ratio);\r\n      } else if (action) {\r\n        switch (action) {\r\n          case 'rotate-left': this.rotate(-90); break;\r\n          case 'rotate-right': this.rotate(90); break;\r\n          case 'flip-h': this.flipHorizontal(); break;\r\n          case 'flip-v': this.flipVertical(); break;\r\n          case 'apply': this.apply(); break;\r\n          case 'cancel': this.cancel(); break;\r\n        }\r\n      }\r\n    });\r\n    \r\n    return panel;\r\n  }\r\n\r\n  /**\r\n   * Initialize crop rect to cover most of image\r\n   */\r\n  private initCropRect(): void {\r\n    const canvasRect = this.canvas.getBoundingClientRect();\r\n    const containerRect = this.container.getBoundingClientRect();\r\n    \r\n    // Calculate canvas position relative to container\r\n    const offsetX = canvasRect.left - containerRect.left;\r\n    const offsetY = canvasRect.top - containerRect.top;\r\n    \r\n    // Default to 80% of canvas\r\n    const padding = 0.1;\r\n    this.cropRect = {\r\n      x: offsetX + canvasRect.width * padding,\r\n      y: offsetY + canvasRect.height * padding,\r\n      width: canvasRect.width * (1 - 2 * padding),\r\n      height: canvasRect.height * (1 - 2 * padding),\r\n    };\r\n    \r\n    this.applyRatioConstraint();\r\n  }\r\n\r\n  /**\r\n   * Apply aspect ratio constraint\r\n   */\r\n  private applyRatioConstraint(): void {\r\n    if (this.currentRatio === 'free') return;\r\n    \r\n    const [w, h] = this.currentRatio.split(':').map(Number);\r\n    const ratio = w / h;\r\n    \r\n    const centerX = this.cropRect.x + this.cropRect.width / 2;\r\n    const centerY = this.cropRect.y + this.cropRect.height / 2;\r\n    \r\n    let newWidth = this.cropRect.width;\r\n    let newHeight = this.cropRect.height;\r\n    \r\n    if (newWidth / newHeight > ratio) {\r\n      newWidth = newHeight * ratio;\r\n    } else {\r\n      newHeight = newWidth / ratio;\r\n    }\r\n    \r\n    this.cropRect.width = newWidth;\r\n    this.cropRect.height = newHeight;\r\n    this.cropRect.x = centerX - newWidth / 2;\r\n    this.cropRect.y = centerY - newHeight / 2;\r\n  }\r\n\r\n  /**\r\n   * Update crop box position/size\r\n   */\r\n  private updateCropBox(): void {\r\n    if (!this.cropBox || !this.overlay) return;\r\n    \r\n    this.cropBox.style.left = `${this.cropRect.x}px`;\r\n    this.cropBox.style.top = `${this.cropRect.y}px`;\r\n    this.cropBox.style.width = `${this.cropRect.width}px`;\r\n    this.cropBox.style.height = `${this.cropRect.height}px`;\r\n    \r\n    // Update dark overlay regions\r\n    this.updateOverlayMask();\r\n  }\r\n\r\n  /**\r\n   * Update overlay mask to darken outside crop area\r\n   */\r\n  private updateOverlayMask(): void {\r\n    if (!this.overlay) return;\r\n    \r\n    const { x, y, width, height } = this.cropRect;\r\n    \r\n    // Use clip-path to create the dark overlay effect\r\n    this.overlay.style.setProperty('--crop-x', `${x}px`);\r\n    this.overlay.style.setProperty('--crop-y', `${y}px`);\r\n    this.overlay.style.setProperty('--crop-w', `${width}px`);\r\n    this.overlay.style.setProperty('--crop-h', `${height}px`);\r\n  }\r\n\r\n  /**\r\n   * Update ratio buttons active state\r\n   */\r\n  private updateRatioButtons(): void {\r\n    if (!this.controlPanel) return;\r\n    \r\n    this.controlPanel.querySelectorAll('[data-ratio]').forEach(btn => {\r\n      btn.classList.toggle('active', btn.getAttribute('data-ratio') === this.currentRatio);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update rotation preview\r\n   */\r\n  private updateRotationPreview(): void {\r\n    // Rotation is applied when crop is confirmed\r\n    // Could add visual preview here\r\n  }\r\n\r\n  /**\r\n   * Update flip preview\r\n   */\r\n  private updateFlipPreview(): void {\r\n    // Flip is applied when crop is confirmed\r\n    // Could add visual preview here\r\n  }\r\n\r\n  /**\r\n   * Setup event listeners\r\n   */\r\n  private setupEvents(): void {\r\n    if (!this.cropBox) return;\r\n    \r\n    // Crop box drag\r\n    this.cropBox.addEventListener('pointerdown', this.handlePointerDown);\r\n    document.addEventListener('pointermove', this.handlePointerMove);\r\n    document.addEventListener('pointerup', this.handlePointerUp);\r\n  }\r\n\r\n  private handlePointerDown = (e: PointerEvent): void => {\r\n    const target = e.target as HTMLElement;\r\n    \r\n    // Check if clicking on handle\r\n    if (target.classList.contains('ie-crop-handle')) {\r\n      this.isResizing = true;\r\n      this.activeHandle = target.dataset.handle as HandlePosition;\r\n    } else if (target.closest('.ie-crop-box')) {\r\n      this.isDragging = true;\r\n    }\r\n    \r\n    if (this.isDragging || this.isResizing) {\r\n      this.dragStart = { x: e.clientX, y: e.clientY };\r\n      this.cropStart = { ...this.cropRect };\r\n      e.preventDefault();\r\n    }\r\n  };\r\n\r\n  private handlePointerMove = (e: PointerEvent): void => {\r\n    if (!this.isDragging && !this.isResizing) return;\r\n    \r\n    const dx = e.clientX - this.dragStart.x;\r\n    const dy = e.clientY - this.dragStart.y;\r\n    \r\n    if (this.isDragging) {\r\n      this.cropRect.x = this.cropStart.x + dx;\r\n      this.cropRect.y = this.cropStart.y + dy;\r\n      this.constrainToContainer();\r\n    } else if (this.isResizing && this.activeHandle) {\r\n      this.resizeCropBox(dx, dy);\r\n    }\r\n    \r\n    this.updateCropBox();\r\n  };\r\n\r\n  private handlePointerUp = (): void => {\r\n    this.isDragging = false;\r\n    this.isResizing = false;\r\n    this.activeHandle = null;\r\n  };\r\n\r\n  /**\r\n   * Resize crop box based on handle\r\n   */\r\n  private resizeCropBox(dx: number, dy: number): void {\r\n    if (!this.activeHandle) return;\r\n    \r\n    const { x, y, width, height } = this.cropStart;\r\n    const minSize = this.options.minSize;\r\n    \r\n    let newX = x, newY = y, newW = width, newH = height;\r\n    \r\n    // Calculate new dimensions based on handle\r\n    switch (this.activeHandle) {\r\n      case 'nw':\r\n        newX = x + dx;\r\n        newY = y + dy;\r\n        newW = width - dx;\r\n        newH = height - dy;\r\n        break;\r\n      case 'n':\r\n        newY = y + dy;\r\n        newH = height - dy;\r\n        break;\r\n      case 'ne':\r\n        newY = y + dy;\r\n        newW = width + dx;\r\n        newH = height - dy;\r\n        break;\r\n      case 'e':\r\n        newW = width + dx;\r\n        break;\r\n      case 'se':\r\n        newW = width + dx;\r\n        newH = height + dy;\r\n        break;\r\n      case 's':\r\n        newH = height + dy;\r\n        break;\r\n      case 'sw':\r\n        newX = x + dx;\r\n        newW = width - dx;\r\n        newH = height + dy;\r\n        break;\r\n      case 'w':\r\n        newX = x + dx;\r\n        newW = width - dx;\r\n        break;\r\n    }\r\n    \r\n    // Apply minimum size\r\n    if (newW < minSize) {\r\n      if (this.activeHandle.includes('w')) {\r\n        newX = x + width - minSize;\r\n      }\r\n      newW = minSize;\r\n    }\r\n    if (newH < minSize) {\r\n      if (this.activeHandle.includes('n')) {\r\n        newY = y + height - minSize;\r\n      }\r\n      newH = minSize;\r\n    }\r\n    \r\n    // Apply ratio constraint if not free\r\n    if (this.currentRatio !== 'free') {\r\n      const [rw, rh] = this.currentRatio.split(':').map(Number);\r\n      const ratio = rw / rh;\r\n      \r\n      // Determine which dimension to adjust\r\n      if (['n', 's'].includes(this.activeHandle)) {\r\n        newW = newH * ratio;\r\n      } else if (['e', 'w'].includes(this.activeHandle)) {\r\n        newH = newW / ratio;\r\n      } else {\r\n        // Corner handles - use the larger change\r\n        const targetRatio = newW / newH;\r\n        if (targetRatio > ratio) {\r\n          newW = newH * ratio;\r\n        } else {\r\n          newH = newW / ratio;\r\n        }\r\n      }\r\n    }\r\n    \r\n    this.cropRect = { x: newX, y: newY, width: newW, height: newH };\r\n    this.constrainToContainer();\r\n  }\r\n\r\n  /**\r\n   * Constrain crop rect to container bounds\r\n   */\r\n  private constrainToContainer(): void {\r\n    const canvasRect = this.canvas.getBoundingClientRect();\r\n    const containerRect = this.container.getBoundingClientRect();\r\n    \r\n    const minX = canvasRect.left - containerRect.left;\r\n    const minY = canvasRect.top - containerRect.top;\r\n    const maxX = minX + canvasRect.width;\r\n    const maxY = minY + canvasRect.height;\r\n    \r\n    // Constrain position\r\n    this.cropRect.x = Math.max(minX, Math.min(maxX - this.cropRect.width, this.cropRect.x));\r\n    this.cropRect.y = Math.max(minY, Math.min(maxY - this.cropRect.height, this.cropRect.y));\r\n    \r\n    // Constrain size\r\n    this.cropRect.width = Math.min(this.cropRect.width, maxX - this.cropRect.x);\r\n    this.cropRect.height = Math.min(this.cropRect.height, maxY - this.cropRect.y);\r\n  }\r\n\r\n  /**\r\n   * Convert screen rect to canvas coordinates\r\n   */\r\n  private toCanvasCoords(): CropRect {\r\n    const canvasRect = this.canvas.getBoundingClientRect();\r\n    const containerRect = this.container.getBoundingClientRect();\r\n    \r\n    const offsetX = canvasRect.left - containerRect.left;\r\n    const offsetY = canvasRect.top - containerRect.top;\r\n    \r\n    const scaleX = this.canvas.width / canvasRect.width;\r\n    const scaleY = this.canvas.height / canvasRect.height;\r\n    \r\n    return {\r\n      x: (this.cropRect.x - offsetX) * scaleX,\r\n      y: (this.cropRect.y - offsetY) * scaleY,\r\n      width: this.cropRect.width * scaleX,\r\n      height: this.cropRect.height * scaleY,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Apply crop\r\n   */\r\n  private apply(): void {\r\n    const canvasRect = this.toCanvasCoords();\r\n    \r\n    if (this.onApplyCallback) {\r\n      this.onApplyCallback(canvasRect, this.rotation, this.flipH, this.flipV);\r\n    }\r\n    \r\n    this.hide();\r\n  }\r\n\r\n  /**\r\n   * Cancel crop\r\n   */\r\n  private cancel(): void {\r\n    if (this.onCancelCallback) {\r\n      this.onCancelCallback();\r\n    }\r\n    \r\n    this.hide();\r\n  }\r\n\r\n  /**\r\n   * Remove overlay\r\n   */\r\n  private removeOverlay(): void {\r\n    if (this.overlay) {\r\n      this.overlay.remove();\r\n      this.overlay = null;\r\n      this.cropBox = null;\r\n      this.controlPanel = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup event listeners\r\n   */\r\n  private cleanup(): void {\r\n    document.removeEventListener('pointermove', this.handlePointerMove);\r\n    document.removeEventListener('pointerup', this.handlePointerUp);\r\n  }\r\n\r\n  /**\r\n   * Destroy crop tool\r\n   */\r\n  destroy(): void {\r\n    this.hide();\r\n    this.onApplyCallback = null;\r\n    this.onCancelCallback = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Apply crop, rotation and flip to canvas\r\n */\r\nexport function applyCropToCanvas(\r\n  canvas: HTMLCanvasElement,\r\n  rect: CropRect,\r\n  rotation: number,\r\n  flipH: boolean,\r\n  flipV: boolean\r\n): HTMLCanvasElement {\r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) return canvas;\r\n  \r\n  // Create cropped canvas\r\n  let croppedWidth = rect.width;\r\n  let croppedHeight = rect.height;\r\n  \r\n  // Swap dimensions if rotated 90 or 270\r\n  if (rotation === 90 || rotation === 270) {\r\n    [croppedWidth, croppedHeight] = [croppedHeight, croppedWidth];\r\n  }\r\n  \r\n  const tempCanvas = document.createElement('canvas');\r\n  tempCanvas.width = croppedWidth;\r\n  tempCanvas.height = croppedHeight;\r\n  const tempCtx = tempCanvas.getContext('2d')!;\r\n  \r\n  // Apply transformations\r\n  tempCtx.save();\r\n  tempCtx.translate(croppedWidth / 2, croppedHeight / 2);\r\n  \r\n  if (rotation) {\r\n    tempCtx.rotate((rotation * Math.PI) / 180);\r\n  }\r\n  \r\n  if (flipH) {\r\n    tempCtx.scale(-1, 1);\r\n  }\r\n  \r\n  if (flipV) {\r\n    tempCtx.scale(1, -1);\r\n  }\r\n  \r\n  // Draw cropped region\r\n  let drawWidth = rect.width;\r\n  let drawHeight = rect.height;\r\n  if (rotation === 90 || rotation === 270) {\r\n    [drawWidth, drawHeight] = [drawHeight, drawWidth];\r\n  }\r\n  \r\n  tempCtx.drawImage(\r\n    canvas,\r\n    rect.x, rect.y, rect.width, rect.height,\r\n    -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight\r\n  );\r\n  \r\n  tempCtx.restore();\r\n  \r\n  // Update original canvas\r\n  canvas.width = croppedWidth;\r\n  canvas.height = croppedHeight;\r\n  ctx.drawImage(tempCanvas, 0, 0);\r\n  \r\n  return canvas;\r\n}\r\n","/**\r\n * ContextMenu - Right-click context menu for shape operations\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport type { I18n } from '../i18n';\r\n\r\nexport interface MenuItemConfig {\r\n  id: string;\r\n  label: string;\r\n  icon?: string;\r\n  shortcut?: string;\r\n  disabled?: boolean;\r\n  divider?: boolean;\r\n  action?: () => void;\r\n}\r\n\r\nexport interface ContextMenuOptions {\r\n  items: MenuItemConfig[];\r\n  i18n?: I18n;\r\n}\r\n\r\n/**\r\n * ContextMenu - Floating context menu\r\n */\r\nexport class ContextMenu {\r\n  private menu: HTMLElement | null = null;\r\n  private items: MenuItemConfig[] = [];\r\n  private boundHide: (e: MouseEvent) => void;\r\n\r\n  constructor(options?: Partial<ContextMenuOptions>) {\r\n    this.items = options?.items || [];\r\n    this.boundHide = this.handleOutsideClick.bind(this);\r\n  }\r\n\r\n  /**\r\n   * Show context menu at position\r\n   */\r\n  show(x: number, y: number, items?: MenuItemConfig[]): void {\r\n    this.hide();\r\n    \r\n    if (items) {\r\n      this.items = items;\r\n    }\r\n    \r\n    this.menu = this.createMenu();\r\n    document.body.appendChild(this.menu);\r\n    \r\n    // Position menu\r\n    this.positionMenu(x, y);\r\n    \r\n    // Add click outside listener\r\n    setTimeout(() => {\r\n      document.addEventListener('click', this.boundHide);\r\n      document.addEventListener('contextmenu', this.boundHide);\r\n    }, 0);\r\n  }\r\n\r\n  /**\r\n   * Hide context menu\r\n   */\r\n  hide(): void {\r\n    if (this.menu) {\r\n      this.menu.remove();\r\n      this.menu = null;\r\n    }\r\n    document.removeEventListener('click', this.boundHide);\r\n    document.removeEventListener('contextmenu', this.boundHide);\r\n  }\r\n\r\n  /**\r\n   * Check if menu is visible\r\n   */\r\n  isVisible(): boolean {\r\n    return this.menu !== null;\r\n  }\r\n\r\n  /**\r\n   * Set menu items\r\n   */\r\n  setItems(items: MenuItemConfig[]): void {\r\n    this.items = items;\r\n  }\r\n\r\n  /**\r\n   * Create menu element\r\n   */\r\n  private createMenu(): HTMLElement {\r\n    const menu = document.createElement('div');\r\n    menu.className = 'ie-context-menu';\r\n    \r\n    this.items.forEach(item => {\r\n      if (item.divider) {\r\n        const divider = document.createElement('div');\r\n        divider.className = 'ie-context-menu-divider';\r\n        menu.appendChild(divider);\r\n      } else {\r\n        const menuItem = document.createElement('div');\r\n        menuItem.className = `ie-context-menu-item${item.disabled ? ' disabled' : ''}`;\r\n        menuItem.dataset.id = item.id;\r\n        \r\n        menuItem.innerHTML = `\r\n          ${item.icon ? `<span class=\"ie-context-menu-icon\">${item.icon}</span>` : ''}\r\n          <span class=\"ie-context-menu-label\">${item.label}</span>\r\n          ${item.shortcut ? `<span class=\"ie-context-menu-shortcut\">${item.shortcut}</span>` : ''}\r\n        `;\r\n        \r\n        if (!item.disabled && item.action) {\r\n          menuItem.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            item.action!();\r\n            this.hide();\r\n          });\r\n        }\r\n        \r\n        menu.appendChild(menuItem);\r\n      }\r\n    });\r\n    \r\n    return menu;\r\n  }\r\n\r\n  /**\r\n   * Position menu to stay within viewport\r\n   */\r\n  private positionMenu(x: number, y: number): void {\r\n    if (!this.menu) return;\r\n    \r\n    const menuRect = this.menu.getBoundingClientRect();\r\n    const viewportWidth = window.innerWidth;\r\n    const viewportHeight = window.innerHeight;\r\n    \r\n    // Adjust horizontal position\r\n    if (x + menuRect.width > viewportWidth) {\r\n      x = viewportWidth - menuRect.width - 5;\r\n    }\r\n    \r\n    // Adjust vertical position\r\n    if (y + menuRect.height > viewportHeight) {\r\n      y = viewportHeight - menuRect.height - 5;\r\n    }\r\n    \r\n    this.menu.style.left = `${Math.max(5, x)}px`;\r\n    this.menu.style.top = `${Math.max(5, y)}px`;\r\n  }\r\n\r\n  /**\r\n   * Handle click outside menu\r\n   */\r\n  private handleOutsideClick(e: MouseEvent): void {\r\n    if (this.menu && !this.menu.contains(e.target as Node)) {\r\n      this.hide();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy context menu\r\n   */\r\n  destroy(): void {\r\n    this.hide();\r\n    this.items = [];\r\n  }\r\n}\r\n\r\n/**\r\n * Create default shape context menu items\r\n */\r\nexport function createShapeMenuItems(handlers: {\r\n  copy?: () => void;\r\n  paste?: () => void;\r\n  duplicate?: () => void;\r\n  delete?: () => void;\r\n  bringToFront?: () => void;\r\n  bringForward?: () => void;\r\n  sendBackward?: () => void;\r\n  sendToBack?: () => void;\r\n}, i18n?: I18n): MenuItemConfig[] {\r\n  const t = i18n?.t.bind(i18n) || ((key: string) => key);\r\n  \r\n  const items: MenuItemConfig[] = [];\r\n  \r\n  if (handlers.copy) {\r\n    items.push({\r\n      id: 'copy',\r\n      label: t('context.copy' as any),\r\n      icon: icons.copy,\r\n      shortcut: 'Ctrl+C',\r\n      action: handlers.copy,\r\n    });\r\n  }\r\n  \r\n  if (handlers.paste) {\r\n    items.push({\r\n      id: 'paste',\r\n      label: t('context.paste' as any),\r\n      icon: icons.paste,\r\n      shortcut: 'Ctrl+V',\r\n      action: handlers.paste,\r\n    });\r\n  }\r\n  \r\n  if (handlers.duplicate) {\r\n    items.push({\r\n      id: 'duplicate',\r\n      label: t('context.duplicate' as any),\r\n      icon: icons.copy,\r\n      shortcut: 'Ctrl+D',\r\n      action: handlers.duplicate,\r\n    });\r\n  }\r\n  \r\n  if (handlers.delete) {\r\n    items.push({\r\n      id: 'delete',\r\n      label: t('context.delete' as any),\r\n      icon: icons.trash,\r\n      shortcut: 'Del',\r\n      action: handlers.delete,\r\n    });\r\n  }\r\n  \r\n  // Add divider before layer operations\r\n  if (items.length > 0 && (handlers.bringToFront || handlers.sendToBack)) {\r\n    items.push({ id: 'divider1', label: '', divider: true });\r\n  }\r\n  \r\n  if (handlers.bringToFront) {\r\n    items.push({\r\n      id: 'bringToFront',\r\n      label: t('context.bringToFront' as any),\r\n      icon: icons.layers,\r\n      action: handlers.bringToFront,\r\n    });\r\n  }\r\n  \r\n  if (handlers.bringForward) {\r\n    items.push({\r\n      id: 'bringForward',\r\n      label: t('context.bringForward' as any),\r\n      action: handlers.bringForward,\r\n    });\r\n  }\r\n  \r\n  if (handlers.sendBackward) {\r\n    items.push({\r\n      id: 'sendBackward',\r\n      label: t('context.sendBackward' as any),\r\n      action: handlers.sendBackward,\r\n    });\r\n  }\r\n  \r\n  if (handlers.sendToBack) {\r\n    items.push({\r\n      id: 'sendToBack',\r\n      label: t('context.sendToBack' as any),\r\n      icon: icons.layers,\r\n      action: handlers.sendToBack,\r\n    });\r\n  }\r\n  \r\n  return items;\r\n}\r\n","/**\r\n * ExportDialog - Advanced export options dialog\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport type { I18n } from '../i18n';\r\nimport { getI18n } from '../i18n';\r\nimport type { ExportFormat } from '../types/config.types';\r\n\r\nexport interface ExportDialogOptions {\r\n  /** Initial format */\r\n  format?: ExportFormat;\r\n  /** Initial quality */\r\n  quality?: number;\r\n  /** Original canvas width */\r\n  width: number;\r\n  /** Original canvas height */\r\n  height: number;\r\n  /** Enable watermark */\r\n  enableWatermark?: boolean;\r\n  /** i18n instance */\r\n  i18n?: I18n;\r\n}\r\n\r\nexport interface ExportDialogResult {\r\n  format: ExportFormat;\r\n  quality: number;\r\n  width: number;\r\n  height: number;\r\n  watermark?: {\r\n    text?: string;\r\n    position?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center';\r\n    opacity?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * ExportDialog - Modal dialog for export options\r\n */\r\nexport class ExportDialog {\r\n  private overlay: HTMLElement | null = null;\r\n  private dialog: HTMLElement | null = null;\r\n  private i18n: I18n;\r\n  private options: ExportDialogOptions;\r\n  \r\n  // State\r\n  private format: ExportFormat = 'png';\r\n  private quality: number = 0.92;\r\n  private width: number;\r\n  private height: number;\r\n  private keepRatio: boolean = true;\r\n  private aspectRatio: number;\r\n  private watermarkText: string = '';\r\n  private watermarkEnabled: boolean = false;\r\n  \r\n  // Callbacks\r\n  private resolvePromise: ((result: ExportDialogResult | null) => void) | null = null;\r\n\r\n  constructor(options: ExportDialogOptions) {\r\n    this.options = options;\r\n    this.i18n = options.i18n || getI18n();\r\n    \r\n    this.format = options.format || 'png';\r\n    this.quality = options.quality || 0.92;\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.aspectRatio = options.width / options.height;\r\n  }\r\n\r\n  /**\r\n   * Show dialog and return promise with result\r\n   */\r\n  show(): Promise<ExportDialogResult | null> {\r\n    return new Promise((resolve) => {\r\n      this.resolvePromise = resolve;\r\n      this.createDialog();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Hide dialog\r\n   */\r\n  hide(): void {\r\n    if (this.overlay) {\r\n      this.overlay.remove();\r\n      this.overlay = null;\r\n      this.dialog = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create dialog elements\r\n   */\r\n  private createDialog(): void {\r\n    const t = (key: string) => this.i18n.t(key as any);\r\n    \r\n    this.overlay = document.createElement('div');\r\n    this.overlay.className = 'ie-export-overlay';\r\n    \r\n    this.dialog = document.createElement('div');\r\n    this.dialog.className = 'ie-export-dialog';\r\n    \r\n    this.dialog.innerHTML = `\r\n      <div class=\"ie-export-header\">\r\n        <span class=\"ie-export-title\">${t('export.title')}</span>\r\n        <button class=\"ie-export-close\" data-action=\"close\">${icons.close}</button>\r\n      </div>\r\n      \r\n      <div class=\"ie-export-body\">\r\n        <!-- Format -->\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">${t('export.format')}</label>\r\n          <div class=\"ie-export-format-buttons\">\r\n            <button class=\"ie-export-format-btn ${this.format === 'png' ? 'active' : ''}\" data-format=\"png\">PNG</button>\r\n            <button class=\"ie-export-format-btn ${this.format === 'jpeg' ? 'active' : ''}\" data-format=\"jpeg\">JPG</button>\r\n            <button class=\"ie-export-format-btn ${this.format === 'webp' ? 'active' : ''}\" data-format=\"webp\">WebP</button>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Size -->\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">${t('export.size')}</label>\r\n          <div class=\"ie-export-size-inputs\">\r\n            <input type=\"number\" class=\"ie-export-input\" data-input=\"width\" value=\"${this.width}\" min=\"1\" max=\"10000\">\r\n            <span style=\"color:var(--ie-text-muted)\">×</span>\r\n            <input type=\"number\" class=\"ie-export-input\" data-input=\"height\" value=\"${this.height}\" min=\"1\" max=\"10000\">\r\n            <button class=\"ie-export-link-btn ${this.keepRatio ? 'active' : ''}\" data-action=\"toggle-ratio\" title=\"${t('export.keepRatio')}\">\r\n              ${icons.layers}\r\n            </button>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Quality (only for jpeg/webp) -->\r\n        <div class=\"ie-export-section ie-quality-section\" style=\"display:${this.format === 'png' ? 'none' : 'block'}\">\r\n          <label class=\"ie-export-label\">${t('export.quality')}</label>\r\n          <div class=\"ie-export-quality\">\r\n            <input type=\"range\" class=\"ie-range-slider ie-export-quality-slider\" data-slider=\"quality\" \r\n                   min=\"0.1\" max=\"1\" step=\"0.01\" value=\"${this.quality}\">\r\n            <span class=\"ie-export-quality-value\" data-value=\"quality\">${Math.round(this.quality * 100)}%</span>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Watermark -->\r\n        ${this.options.enableWatermark ? `\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">\r\n            <input type=\"checkbox\" data-check=\"watermark\" ${this.watermarkEnabled ? 'checked' : ''}>\r\n            ${t('export.watermark')}\r\n          </label>\r\n          <div class=\"ie-watermark-options\" style=\"display:${this.watermarkEnabled ? 'block' : 'none'}\">\r\n            <input type=\"text\" class=\"ie-export-input\" data-input=\"watermark-text\" \r\n                   placeholder=\"${t('export.watermarkText')}\" value=\"${this.watermarkText}\">\r\n          </div>\r\n        </div>\r\n        ` : ''}\r\n        \r\n        <!-- Preview -->\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">${t('export.preview')}</label>\r\n          <div class=\"ie-export-preview\">\r\n            <div style=\"color:var(--ie-text-muted);font-size:12px;\">${this.width} × ${this.height} px</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      <div class=\"ie-export-footer\">\r\n        <button class=\"ie-export-cancel\" data-action=\"cancel\">${t('export.cancel')}</button>\r\n        <button class=\"ie-export-download\" data-action=\"export\">${icons.download} ${t('export.download')}</button>\r\n      </div>\r\n    `;\r\n    \r\n    this.overlay.appendChild(this.dialog);\r\n    document.body.appendChild(this.overlay);\r\n    \r\n    this.setupEvents();\r\n  }\r\n\r\n  /**\r\n   * Setup event listeners\r\n   */\r\n  private setupEvents(): void {\r\n    if (!this.dialog) return;\r\n    \r\n    // Close button\r\n    this.dialog.querySelector('[data-action=\"close\"]')?.addEventListener('click', () => {\r\n      this.cancel();\r\n    });\r\n    \r\n    // Cancel button\r\n    this.dialog.querySelector('[data-action=\"cancel\"]')?.addEventListener('click', () => {\r\n      this.cancel();\r\n    });\r\n    \r\n    // Export button\r\n    this.dialog.querySelector('[data-action=\"export\"]')?.addEventListener('click', () => {\r\n      this.confirm();\r\n    });\r\n    \r\n    // Format buttons\r\n    this.dialog.querySelectorAll('[data-format]').forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        this.setFormat(btn.getAttribute('data-format') as ExportFormat);\r\n      });\r\n    });\r\n    \r\n    // Size inputs\r\n    const widthInput = this.dialog.querySelector('[data-input=\"width\"]') as HTMLInputElement;\r\n    const heightInput = this.dialog.querySelector('[data-input=\"height\"]') as HTMLInputElement;\r\n    \r\n    widthInput?.addEventListener('input', () => {\r\n      this.width = parseInt(widthInput.value) || this.options.width;\r\n      if (this.keepRatio) {\r\n        this.height = Math.round(this.width / this.aspectRatio);\r\n        heightInput.value = String(this.height);\r\n      }\r\n      this.updatePreview();\r\n    });\r\n    \r\n    heightInput?.addEventListener('input', () => {\r\n      this.height = parseInt(heightInput.value) || this.options.height;\r\n      if (this.keepRatio) {\r\n        this.width = Math.round(this.height * this.aspectRatio);\r\n        widthInput.value = String(this.width);\r\n      }\r\n      this.updatePreview();\r\n    });\r\n    \r\n    // Keep ratio toggle\r\n    this.dialog.querySelector('[data-action=\"toggle-ratio\"]')?.addEventListener('click', (e) => {\r\n      this.keepRatio = !this.keepRatio;\r\n      (e.currentTarget as HTMLElement).classList.toggle('active', this.keepRatio);\r\n    });\r\n    \r\n    // Quality slider\r\n    const qualitySlider = this.dialog.querySelector('[data-slider=\"quality\"]') as HTMLInputElement;\r\n    qualitySlider?.addEventListener('input', () => {\r\n      this.quality = parseFloat(qualitySlider.value);\r\n      const valueEl = this.dialog!.querySelector('[data-value=\"quality\"]');\r\n      if (valueEl) valueEl.textContent = `${Math.round(this.quality * 100)}%`;\r\n    });\r\n    \r\n    // Watermark checkbox\r\n    this.dialog.querySelector('[data-check=\"watermark\"]')?.addEventListener('change', (e) => {\r\n      this.watermarkEnabled = (e.target as HTMLInputElement).checked;\r\n      const opts = this.dialog!.querySelector('.ie-watermark-options') as HTMLElement;\r\n      if (opts) opts.style.display = this.watermarkEnabled ? 'block' : 'none';\r\n    });\r\n    \r\n    // Watermark text\r\n    this.dialog.querySelector('[data-input=\"watermark-text\"]')?.addEventListener('input', (e) => {\r\n      this.watermarkText = (e.target as HTMLInputElement).value;\r\n    });\r\n    \r\n    // Close on overlay click\r\n    this.overlay?.addEventListener('click', (e) => {\r\n      if (e.target === this.overlay) {\r\n        this.cancel();\r\n      }\r\n    });\r\n    \r\n    // Close on Escape\r\n    document.addEventListener('keydown', this.handleKeyDown);\r\n  }\r\n\r\n  private handleKeyDown = (e: KeyboardEvent): void => {\r\n    if (e.key === 'Escape') {\r\n      this.cancel();\r\n    } else if (e.key === 'Enter') {\r\n      this.confirm();\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Set export format\r\n   */\r\n  private setFormat(format: ExportFormat): void {\r\n    this.format = format;\r\n    \r\n    // Update buttons\r\n    this.dialog?.querySelectorAll('[data-format]').forEach(btn => {\r\n      btn.classList.toggle('active', btn.getAttribute('data-format') === format);\r\n    });\r\n    \r\n    // Show/hide quality section\r\n    const qualitySection = this.dialog?.querySelector('.ie-quality-section') as HTMLElement;\r\n    if (qualitySection) {\r\n      qualitySection.style.display = format === 'png' ? 'none' : 'block';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update preview\r\n   */\r\n  private updatePreview(): void {\r\n    const preview = this.dialog?.querySelector('.ie-export-preview');\r\n    if (preview) {\r\n      preview.innerHTML = `<div style=\"color:var(--ie-text-muted);font-size:12px;\">${this.width} × ${this.height} px</div>`;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cancel and close\r\n   */\r\n  private cancel(): void {\r\n    document.removeEventListener('keydown', this.handleKeyDown);\r\n    this.hide();\r\n    this.resolvePromise?.(null);\r\n  }\r\n\r\n  /**\r\n   * Confirm and return result\r\n   */\r\n  private confirm(): void {\r\n    document.removeEventListener('keydown', this.handleKeyDown);\r\n    \r\n    const result: ExportDialogResult = {\r\n      format: this.format,\r\n      quality: this.quality,\r\n      width: this.width,\r\n      height: this.height,\r\n    };\r\n    \r\n    if (this.watermarkEnabled && this.watermarkText) {\r\n      result.watermark = {\r\n        text: this.watermarkText,\r\n        position: 'bottom-right',\r\n        opacity: 0.5,\r\n      };\r\n    }\r\n    \r\n    this.hide();\r\n    this.resolvePromise?.(result);\r\n  }\r\n\r\n  /**\r\n   * Destroy dialog\r\n   */\r\n  destroy(): void {\r\n    document.removeEventListener('keydown', this.handleKeyDown);\r\n    this.hide();\r\n    this.resolvePromise = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Apply watermark to canvas\r\n */\r\nexport function applyWatermark(\r\n  canvas: HTMLCanvasElement,\r\n  watermark: NonNullable<ExportDialogResult['watermark']>\r\n): void {\r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx || !watermark.text) return;\r\n  \r\n  ctx.save();\r\n  \r\n  // Set watermark style\r\n  const fontSize = Math.max(12, Math.min(canvas.width, canvas.height) * 0.03);\r\n  ctx.font = `${fontSize}px sans-serif`;\r\n  ctx.fillStyle = `rgba(255, 255, 255, ${watermark.opacity || 0.5})`;\r\n  ctx.strokeStyle = `rgba(0, 0, 0, ${(watermark.opacity || 0.5) * 0.5})`;\r\n  ctx.lineWidth = 1;\r\n  \r\n  // Calculate position\r\n  const metrics = ctx.measureText(watermark.text);\r\n  const padding = fontSize;\r\n  let x: number, y: number;\r\n  \r\n  switch (watermark.position) {\r\n    case 'top-left':\r\n      x = padding;\r\n      y = padding + fontSize;\r\n      break;\r\n    case 'top-right':\r\n      x = canvas.width - metrics.width - padding;\r\n      y = padding + fontSize;\r\n      break;\r\n    case 'bottom-left':\r\n      x = padding;\r\n      y = canvas.height - padding;\r\n      break;\r\n    case 'center':\r\n      x = (canvas.width - metrics.width) / 2;\r\n      y = canvas.height / 2;\r\n      break;\r\n    case 'bottom-right':\r\n    default:\r\n      x = canvas.width - metrics.width - padding;\r\n      y = canvas.height - padding;\r\n      break;\r\n  }\r\n  \r\n  // Draw watermark with stroke for visibility\r\n  ctx.strokeText(watermark.text, x, y);\r\n  ctx.fillText(watermark.text, x, y);\r\n  \r\n  ctx.restore();\r\n}\r\n","/**\r\n * Rulers - Pixel rulers and grid overlay for the editor\r\n */\r\n\r\nexport interface RulersOptions {\r\n  /** Show horizontal ruler */\r\n  showHorizontal?: boolean;\r\n  /** Show vertical ruler */\r\n  showVertical?: boolean;\r\n  /** Show grid */\r\n  showGrid?: boolean;\r\n  /** Grid size in pixels */\r\n  gridSize?: number;\r\n  /** Ruler color */\r\n  rulerColor?: string;\r\n  /** Grid color */\r\n  gridColor?: string;\r\n  /** Ruler background */\r\n  rulerBackground?: string;\r\n  /** Unit (pixels or percentage) */\r\n  unit?: 'px' | '%';\r\n}\r\n\r\nconst defaultOptions: Required<RulersOptions> = {\r\n  showHorizontal: true,\r\n  showVertical: true,\r\n  showGrid: false,\r\n  gridSize: 50,\r\n  rulerColor: '#666',\r\n  gridColor: 'rgba(128, 128, 128, 0.3)',\r\n  rulerBackground: '#f5f5f5',\r\n  unit: 'px',\r\n};\r\n\r\nexport class Rulers {\r\n  private options: Required<RulersOptions>;\r\n  private container: HTMLElement;\r\n  private horizontalRuler: HTMLCanvasElement | null = null;\r\n  private verticalRuler: HTMLCanvasElement | null = null;\r\n  private gridOverlay: HTMLCanvasElement | null = null;\r\n  \r\n  // View state\r\n  private scale = 1;\r\n  private offsetX = 0;\r\n  private offsetY = 0;\r\n  private canvasWidth = 0;\r\n  private canvasHeight = 0;\r\n  \r\n  constructor(container: HTMLElement, options: RulersOptions = {}) {\r\n    this.container = container;\r\n    this.options = { ...defaultOptions, ...options };\r\n    this.init();\r\n  }\r\n  \r\n  private init(): void {\r\n    // Create horizontal ruler\r\n    if (this.options.showHorizontal) {\r\n      this.horizontalRuler = document.createElement('canvas');\r\n      this.horizontalRuler.className = 'ie-ruler ie-ruler-horizontal';\r\n      this.horizontalRuler.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 24px;\r\n        height: 24px;\r\n        width: calc(100% - 24px);\r\n        background: ${this.options.rulerBackground};\r\n        border-bottom: 1px solid #ddd;\r\n        z-index: 100;\r\n      `;\r\n      this.container.appendChild(this.horizontalRuler);\r\n    }\r\n    \r\n    // Create vertical ruler\r\n    if (this.options.showVertical) {\r\n      this.verticalRuler = document.createElement('canvas');\r\n      this.verticalRuler.className = 'ie-ruler ie-ruler-vertical';\r\n      this.verticalRuler.style.cssText = `\r\n        position: absolute;\r\n        top: 24px;\r\n        left: 0;\r\n        width: 24px;\r\n        height: calc(100% - 24px);\r\n        background: ${this.options.rulerBackground};\r\n        border-right: 1px solid #ddd;\r\n        z-index: 100;\r\n      `;\r\n      this.container.appendChild(this.verticalRuler);\r\n    }\r\n    \r\n    // Create corner piece\r\n    if (this.options.showHorizontal && this.options.showVertical) {\r\n      const corner = document.createElement('div');\r\n      corner.className = 'ie-ruler-corner';\r\n      corner.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        width: 24px;\r\n        height: 24px;\r\n        background: ${this.options.rulerBackground};\r\n        border-right: 1px solid #ddd;\r\n        border-bottom: 1px solid #ddd;\r\n        z-index: 101;\r\n      `;\r\n      this.container.appendChild(corner);\r\n    }\r\n    \r\n    // Create grid overlay\r\n    if (this.options.showGrid) {\r\n      this.gridOverlay = document.createElement('canvas');\r\n      this.gridOverlay.className = 'ie-grid-overlay';\r\n      this.gridOverlay.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100%;\r\n        height: 100%;\r\n        pointer-events: none;\r\n        z-index: 50;\r\n      `;\r\n      this.container.appendChild(this.gridOverlay);\r\n    }\r\n    \r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Update view state */\r\n  updateView(scale: number, offsetX: number, offsetY: number, canvasWidth: number, canvasHeight: number): void {\r\n    this.scale = scale;\r\n    this.offsetX = offsetX;\r\n    this.offsetY = offsetY;\r\n    this.canvasWidth = canvasWidth;\r\n    this.canvasHeight = canvasHeight;\r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Update ruler drawings */\r\n  private updateRulers(): void {\r\n    this.drawHorizontalRuler();\r\n    this.drawVerticalRuler();\r\n    this.drawGrid();\r\n  }\r\n  \r\n  private drawHorizontalRuler(): void {\r\n    if (!this.horizontalRuler) return;\r\n    \r\n    const canvas = this.horizontalRuler;\r\n    const rect = canvas.getBoundingClientRect();\r\n    canvas.width = rect.width * window.devicePixelRatio;\r\n    canvas.height = rect.height * window.devicePixelRatio;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\r\n    ctx.clearRect(0, 0, rect.width, rect.height);\r\n    \r\n    ctx.fillStyle = this.options.rulerColor;\r\n    ctx.font = '10px sans-serif';\r\n    ctx.textAlign = 'center';\r\n    \r\n    // Calculate tick interval based on scale\r\n    const baseInterval = this.getTickInterval();\r\n    \r\n    // Calculate start position\r\n    const containerCenter = rect.width / 2;\r\n    const canvasStart = containerCenter + this.offsetX - (this.canvasWidth * this.scale) / 2;\r\n    \r\n    // Draw ticks\r\n    for (let i = 0; i <= this.canvasWidth; i += baseInterval) {\r\n      const x = canvasStart + i * this.scale;\r\n      if (x < 0 || x > rect.width) continue;\r\n      \r\n      const isMajor = i % (baseInterval * 5) === 0;\r\n      const tickHeight = isMajor ? 12 : 6;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(x, rect.height);\r\n      ctx.lineTo(x, rect.height - tickHeight);\r\n      ctx.stroke();\r\n      \r\n      if (isMajor) {\r\n        ctx.fillText(String(i), x, rect.height - 14);\r\n      }\r\n    }\r\n  }\r\n  \r\n  private drawVerticalRuler(): void {\r\n    if (!this.verticalRuler) return;\r\n    \r\n    const canvas = this.verticalRuler;\r\n    const rect = canvas.getBoundingClientRect();\r\n    canvas.width = rect.width * window.devicePixelRatio;\r\n    canvas.height = rect.height * window.devicePixelRatio;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\r\n    ctx.clearRect(0, 0, rect.width, rect.height);\r\n    \r\n    ctx.fillStyle = this.options.rulerColor;\r\n    ctx.font = '10px sans-serif';\r\n    ctx.textAlign = 'right';\r\n    \r\n    // Calculate tick interval based on scale\r\n    const baseInterval = this.getTickInterval();\r\n    \r\n    // Calculate start position\r\n    const containerCenter = rect.height / 2;\r\n    const canvasStart = containerCenter + this.offsetY - (this.canvasHeight * this.scale) / 2;\r\n    \r\n    // Draw ticks\r\n    for (let i = 0; i <= this.canvasHeight; i += baseInterval) {\r\n      const y = canvasStart + i * this.scale;\r\n      if (y < 0 || y > rect.height) continue;\r\n      \r\n      const isMajor = i % (baseInterval * 5) === 0;\r\n      const tickWidth = isMajor ? 12 : 6;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(rect.width, y);\r\n      ctx.lineTo(rect.width - tickWidth, y);\r\n      ctx.stroke();\r\n      \r\n      if (isMajor) {\r\n        ctx.save();\r\n        ctx.translate(rect.width - 14, y);\r\n        ctx.rotate(-Math.PI / 2);\r\n        ctx.textAlign = 'center';\r\n        ctx.fillText(String(i), 0, 0);\r\n        ctx.restore();\r\n      }\r\n    }\r\n  }\r\n  \r\n  private drawGrid(): void {\r\n    if (!this.gridOverlay) return;\r\n    \r\n    const canvas = this.gridOverlay;\r\n    const rect = canvas.getBoundingClientRect();\r\n    canvas.width = rect.width * window.devicePixelRatio;\r\n    canvas.height = rect.height * window.devicePixelRatio;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\r\n    ctx.clearRect(0, 0, rect.width, rect.height);\r\n    \r\n    ctx.strokeStyle = this.options.gridColor;\r\n    ctx.lineWidth = 1;\r\n    \r\n    // Calculate start position\r\n    const containerCenterX = rect.width / 2;\r\n    const containerCenterY = rect.height / 2;\r\n    const canvasStartX = containerCenterX + this.offsetX - (this.canvasWidth * this.scale) / 2;\r\n    const canvasStartY = containerCenterY + this.offsetY - (this.canvasHeight * this.scale) / 2;\r\n    const canvasEndX = canvasStartX + this.canvasWidth * this.scale;\r\n    const canvasEndY = canvasStartY + this.canvasHeight * this.scale;\r\n    \r\n    // Draw vertical lines\r\n    for (let i = 0; i <= this.canvasWidth; i += this.options.gridSize) {\r\n      const x = canvasStartX + i * this.scale;\r\n      if (x < 0 || x > rect.width) continue;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(x, Math.max(0, canvasStartY));\r\n      ctx.lineTo(x, Math.min(rect.height, canvasEndY));\r\n      ctx.stroke();\r\n    }\r\n    \r\n    // Draw horizontal lines\r\n    for (let i = 0; i <= this.canvasHeight; i += this.options.gridSize) {\r\n      const y = canvasStartY + i * this.scale;\r\n      if (y < 0 || y > rect.height) continue;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(Math.max(0, canvasStartX), y);\r\n      ctx.lineTo(Math.min(rect.width, canvasEndX), y);\r\n      ctx.stroke();\r\n    }\r\n  }\r\n  \r\n  /** Get tick interval based on scale */\r\n  private getTickInterval(): number {\r\n    if (this.scale < 0.25) return 100;\r\n    if (this.scale < 0.5) return 50;\r\n    if (this.scale < 1) return 25;\r\n    if (this.scale < 2) return 10;\r\n    return 5;\r\n  }\r\n  \r\n  /** Toggle grid visibility */\r\n  setGridVisible(visible: boolean): void {\r\n    this.options.showGrid = visible;\r\n    if (visible && !this.gridOverlay) {\r\n      this.gridOverlay = document.createElement('canvas');\r\n      this.gridOverlay.className = 'ie-grid-overlay';\r\n      this.gridOverlay.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100%;\r\n        height: 100%;\r\n        pointer-events: none;\r\n        z-index: 50;\r\n      `;\r\n      this.container.appendChild(this.gridOverlay);\r\n    } else if (!visible && this.gridOverlay) {\r\n      this.gridOverlay.remove();\r\n      this.gridOverlay = null;\r\n    }\r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Set grid size */\r\n  setGridSize(size: number): void {\r\n    this.options.gridSize = size;\r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Destroy rulers */\r\n  destroy(): void {\r\n    this.horizontalRuler?.remove();\r\n    this.verticalRuler?.remove();\r\n    this.gridOverlay?.remove();\r\n    // Remove corner\r\n    this.container.querySelector('.ie-ruler-corner')?.remove();\r\n  }\r\n}\r\n\r\n/** Create rulers helper */\r\nexport function createRulers(container: HTMLElement, options?: RulersOptions): Rulers {\r\n  return new Rulers(container, options);\r\n}\r\n","/**\n * @image-editor/core\n * Core library for image editor plugin - zero dependencies\n */\n\n// Types\nexport type {\n  EditorOptions,\n  EditorInterface,\n  HistoryState,\n  HistoryManagerInterface,\n} from './types/editor.types';\n\nexport type {\n  Plugin,\n  PluginConstructor,\n  PluginContext,\n  TextLayer,\n  MosaicPluginInterface,\n  TextPluginInterface,\n  FilterPluginInterface,\n} from './types/plugin.types';\n\nexport type {\n  EditorEvents,\n  EventHandler,\n  EventListenerOptions,\n  PointerEventData,\n  GestureEventData,\n  EventEmitter,\n} from './types/event.types';\n\nexport type {\n  ExportFormat,\n  ExportDataType,\n  DeviceType,\n  ExportOptions,\n  MosaicConfig,\n  TextConfig,\n  FilterConfig,\n  EditorConfig,\n  DeepPartial,\n} from './types/config.types';\n\n// Constants\nexport {\n  DEFAULT_EDITOR_CONFIG,\n  DEFAULT_MOSAIC_CONFIG,\n  DEFAULT_TEXT_CONFIG as DEFAULT_TEXT_STYLE,\n  DEFAULT_FILTER_CONFIG,\n  DEFAULT_EXPORT_OPTIONS,\n} from './constants/defaults';\n\nexport {\n  EDITOR_EVENTS,\n  PLUGIN_EVENTS,\n  CANVAS_EVENTS,\n} from './constants/events';\n\n// DOM utilities\nexport {\n  getElement,\n  createCanvas,\n  getContext2D,\n  getElementRect,\n  getRelativeCoordinates,\n  setCanvasSize,\n  clearCanvas,\n  fillCanvas,\n  setStyles,\n  removeElement,\n  isInViewport,\n} from './utils/dom.utils';\n\n// Image utilities\nexport {\n  loadImage,\n  getImageDimensions,\n  calculateAspectRatioFit,\n  drawImageToCanvas,\n  getImageData,\n  putImageData,\n  cloneImageData,\n  createImageData,\n  canvasToDataURL,\n  canvasToBlob,\n  createScaledCanvas,\n} from './utils/image.utils';\n\n// Event utilities\nexport {\n  normalizePointerEvent,\n  getTouchDistance,\n  getTouchCenter,\n  createPinchEvent,\n  createPanEvent,\n  throttle,\n  debounce,\n  preventDefault,\n  stopPropagation,\n  addEventListenerWithCleanup,\n} from './utils/event.utils';\n\n// Device utilities\nexport {\n  isTouchDevice,\n  isMobileDevice,\n  isIOSDevice,\n  isAndroidDevice,\n  detectDeviceType,\n  getResolvedDeviceType,\n  getDevicePixelRatio,\n  supportsPassiveEvents,\n  getPassiveOptions,\n  getNonPassiveOptions,\n  supportsPointerEvents,\n  getViewportDimensions,\n} from './utils/device.utils';\n\n// Export utilities\nexport { exportImage } from './utils/export.utils';\nexport { createPlaceholder } from './utils/placeholder';\nexport type { PlaceholderOptions } from './utils/placeholder';\n\n// Managers\nexport { EventManager } from './managers/EventManager';\nexport { ConfigManager } from './managers/ConfigManager';\nexport { HistoryManager } from './managers/HistoryManager';\nexport { PluginManager } from './managers/PluginManager';\nexport { KeyboardManager, createEditorShortcuts } from './managers/KeyboardManager';\nexport type { ShortcutConfig, ShortcutGroup } from './managers/KeyboardManager';\n\n// Core\nexport { Editor } from './core/Editor';\nexport { Canvas } from './core/Canvas';\n\n// Plugins\nexport { BasePlugin } from './plugins/base/BasePlugin';\n\nexport { MosaicPlugin } from './plugins/mosaic/MosaicPlugin';\nexport {\n  applyMosaicToRegion,\n  applyMosaicAlongPath,\n  applyMosaicToCircularRegion,\n  interpolatePoints,\n} from './plugins/mosaic/mosaic.utils';\n\nexport { TextPlugin } from './plugins/text/TextPlugin';\nexport { TextLayerManager, DEFAULT_TEXT_CONFIG } from './plugins/text/TextLayer';\nexport {\n  buildFontString,\n  measureText,\n  getTextBoundingBox,\n  isPointInTextLayer,\n  findTextLayerAtPoint,\n  renderTextLayer,\n  renderAllTextLayers,\n} from './plugins/text/text.utils';\n\nexport { FilterPlugin } from './plugins/filter/FilterPlugin';\nexport {\n  applyBrightness,\n  applyContrast,\n  applySaturation,\n  applyBlur,\n  applyGrayscale,\n  applySepia,\n  applyInvert,\n} from './plugins/filter/filters';\n\n// UI Components\nexport { Toolbar } from './ui/Toolbar';\nexport type { ToolbarOptions, ToolName } from './ui/Toolbar';\nexport { icons } from './ui/icons';\nexport type { IconName } from './ui/icons';\nexport { injectStyles, toolbarStyles } from './ui/toolbar.styles';\nexport { ShapeLayerManager } from './ui/ShapeLayer';\nexport type { Shape, ShapeType, ShapeStyle, Point, PenShape, RectShape, CircleShape, ArrowShape, TextShape, LineShape, TriangleShape } from './ui/ShapeLayer';\n\n// Crop Tool\nexport { CropTool, applyCropToCanvas } from './ui/CropTool';\nexport type { CropToolOptions, CropRect, CropRatio } from './ui/CropTool';\n\n// Context Menu\nexport { ContextMenu, createShapeMenuItems } from './ui/ContextMenu';\nexport type { MenuItemConfig, ContextMenuOptions } from './ui/ContextMenu';\n\n// Export Dialog\nexport { ExportDialog, applyWatermark } from './ui/ExportDialog';\nexport type { ExportDialogOptions, ExportDialogResult } from './ui/ExportDialog';\n\n// Rulers\nexport { Rulers, createRulers } from './ui/Rulers';\nexport type { RulersOptions } from './ui/Rulers';\n\n// i18n\nexport { I18n, getI18n, t, zhCN, enUS } from './i18n';\nexport type { SupportedLocale, LocaleKey, LocaleMessages } from './i18n';\n\n// Version\nexport const VERSION = '0.2.0';\n"],"names":["DEFAULT_EDITOR_CONFIG","DEFAULT_MOSAIC_CONFIG","DEFAULT_TEXT_CONFIG","DEFAULT_FILTER_CONFIG","DEFAULT_EXPORT_OPTIONS","EDITOR_EVENTS","PLUGIN_EVENTS","CANVAS_EVENTS","getElement","selector","createCanvas","width","height","canvas","getContext2D","ctx","getElementRect","element","getRelativeCoordinates","event","rect","setCanvasSize","clearCanvas","fillCanvas","color","setStyles","styles","removeElement","_a","isInViewport","loadImage","source","resolve","reject","img","getImageDimensions","image","calculateAspectRatioFit","srcWidth","srcHeight","maxWidth","maxHeight","ratio","drawImageToCanvas","x","y","getImageData","w","h","putImageData","imageData","cloneImageData","createImageData","canvasToDataURL","format","quality","mimeType","canvasToBlob","blob","createScaledCanvas","sourceCanvas","normalizePointerEvent","type","touch","getTouchDistance","touch1","touch2","dx","dy","getTouchCenter","createPinchEvent","touches","initialDistance","currentDistance","center","createPanEvent","deltaX","deltaY","throttle","fn","delay","lastCall","args","now","debounce","timeoutId","preventDefault","stopPropagation","addEventListenerWithCleanup","listener","options","isTouchDevice","isMobileDevice","userAgent","isIOSDevice","isAndroidDevice","detectDeviceType","getResolvedDeviceType","deviceType","getDevicePixelRatio","supportsPassiveEvents","passiveSupported","getPassiveOptions","getNonPassiveOptions","supportsPointerEvents","getViewportDimensions","exportImage","opts","targetCanvas","extension","fileName","createPlaceholder","text","subText","theme","isDark","borderColor","iconColor","textColor","subTextColor","padding","cornerRadius","boxLeft","boxTop","boxWidth","boxHeight","centerX","centerY","imgBoxW","imgBoxH","imgBoxX","imgBoxY","imgRadius","EventManager","__publicField","handler","eventName","listeners","data","listenersArray","error","ConfigManager","userConfig","defaultConfig","result","key","userValue","updates","oldConfig","value","currentConfig","generateId","HistoryManager","limit","state","newState","canUndo","canRedo","PluginManager","context","PluginClass","plugin","name","prevPluginName","pluginName","getShortcutKey","config","parts","KeyboardManager","target","enabled","group","fullConfig","configs","unregisters","groupName","_","shortcut","e","isMac","keyMap","createEditorShortcuts","handlers","shortcuts","tool","index","Canvas","container","entries","entry","containerRect","containerWidth","containerHeight","imgWidth","imgHeight","previousWidth","previousHeight","newWidth","newHeight","targetWidth","targetHeight","scaled","preserveContent","createSvg","paths","size","icons","toolbarStyles","injectStyles","styleId","style","shapeIdCounter","ShapeLayerManager","id","baseShape","s","shape","prev","tolerance","i","p1","p2","px","py","x1","y1","x2","y2","len2","t","nearX","nearY","p","callback","offset","newId","clonedShape","headLen","angle","bounds","minX","minY","maxX","maxY","xs","ys","scaleX","scaleY","anchorX","anchorY","newX","newY","defaultOptions","Toolbar","editor","toolbar","disabled","zoomGroup","zoomOutBtn","zoomInBtn","resetBtn","toolGroup","moveBtn","penBtn","rectBtn","circleBtn","arrowBtn","lineBtn","triangleBtn","textBtn","mosaicBtn","eraserBtn","advancedGroup","cropBtn","filterBtn","historyGroup","undoBtn","redoBtn","cropActionGroup","cropCancelBtn","cropConfirmBtn","exportBtn","span","divider","icon","onClick","active","isHistoryBtn","btn","tooltipInfo","tooltip","panel","_b","_c","widthEl","colorEl","colorInput","brushEl","blockEl","brushSlider","blockSlider","_toolbar","sizeEl","sizeSlider","preset","b","slider","filterName","valueEl","_d","brightness","contrast","saturation","blur","filters","presets","settings","brightnessSlider","contrastSlider","saturationSlider","blurSlider","val","delta","pos","selected","scaleRatio","newScale","currentCenter","isInPanel","isToolbarBtn","file","reader","dataUrl","midX","clientX","clientY","radius","dist","step","steps","cx","cy","blockSize","by","bx","bcx","bcy","r","g","count","blockEndX","blockEndY","idx","toolButtons","baseSize","panelName","canvasPos","left","top","textArea","fontSelect","_e","_f","_g","fontStyle","fontWeight","metrics","margin","boxX","boxY","cropBox","isDragging","isResizing","activeHandle","startX","startY","startLeft","startTop","startWidth","startHeight","handle","newLeft","newTop","maskTop","maskLeft","maskRight","maskBottom","croppedData","pureData","radiusSq","regionWidth","regionHeight","currentData","currentPixels","purePixels","pureWidth","pixelsChanged","distSq","pureIdx","currentIdx","edgeFade","mouseX","mouseY","scaleDiff","percent","link","err","resolvedTheme","disabledTools","allToggleableButtons","btnName","zoomHidden","groupTools","isGroupVisible","tools","isExportVisible","zoomVisible","toolOrAdvancedVisible","historyVisible","cropActionVisible","visible","placeholder","_Editor","editorConfig","prevTool","toolbarOption","toolbarConfig","toolName","description","isUserImage","activeName","exportUtils","export_utils","exportOptions","Editor","BasePlugin","_config","applyMosaicToRegion","intensity","endX","endY","effectiveBlockSize","normalizedIntensity","blockY","blockX","blockWidth","blockHeight","pixelCount","totalR","totalG","totalB","totalA","avgR","avgG","avgB","avgA","applyMosaicAlongPath","points","brushSize","point","applyMosaicToCircularRegion","radiusSquared","blockCenterX","blockCenterY","pdx","pdy","interpolatePoints","spacing","distance","MosaicPlugin","mode","nonPassiveOptions","touchStartHandler","touchMoveHandler","touchEndHandler","mouseDownHandler","mouseMoveHandler","mouseUpHandler","cleanup","pointerEvent","currentX","currentY","TextLayerManager","layer","buildFontString","measureText","originalFont","lines","lineHeight","line","getTextBoundingBox","dimensions","isPointInTextLayer","box","findTextLayerAtPoint","layers","renderTextLayer","isSelected","lineY","drawUnderline","drawSelectionBox","underlineY","underlineThickness","handleSize","corners","corner","renderAllTextLayers","selectedId","TextPlugin","dblClickHandler","clickedLayer","applyBrightness","adjustment","clamp","applyContrast","factor","applySaturation","multiplier","gray","applyBlur","original","temp","horizontalBlur","verticalBlur","src","dst","diameter","rSum","gSum","bSum","aSum","dstIdx","leftX","rightX","leftIdx","rightIdx","topY","bottomY","topIdx","bottomIdx","applyGrayscale","applySepia","sepiaR","sepiaG","sepiaB","applyInvert","invertR","invertG","invertB","FilterPlugin","createImageDataCopy","clampValue","clampedConfig","restoredData","previewData","min","max","zhCN","enUS","locales","I18n","locale","params","message","k","v","messages","browserLocale","lang","defaultI18n","getI18n","MIN_CROP_SIZE","CropTool","grid","ratioGroup","transformGroup","actionGroup","action","canvasRect","offsetX","offsetY","minSize","newW","newH","rw","rh","applyCropToCanvas","rotation","flipH","flipV","croppedWidth","croppedHeight","tempCanvas","tempCtx","drawWidth","drawHeight","ContextMenu","items","menu","item","menuItem","menuRect","viewportWidth","viewportHeight","createShapeMenuItems","i18n","ExportDialog","widthInput","heightInput","qualitySlider","qualitySection","preview","applyWatermark","watermark","fontSize","Rulers","scale","canvasWidth","canvasHeight","baseInterval","canvasStart","isMajor","tickHeight","tickWidth","containerCenterX","containerCenterY","canvasStartX","canvasStartY","canvasEndX","canvasEndY","createRulers","VERSION"],"mappings":"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A;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAA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"}