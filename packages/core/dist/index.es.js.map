{"version":3,"file":"index.es.js","sources":["../src/constants/defaults.ts","../src/constants/events.ts","../src/utils/dom.utils.ts","../src/utils/image.utils.ts","../src/utils/event.utils.ts","../src/utils/device.utils.ts","../src/utils/export.utils.ts","../src/utils/placeholder.ts","../src/managers/EventManager.ts","../src/managers/ConfigManager.ts","../src/managers/HistoryManager.ts","../src/managers/PluginManager.ts","../src/managers/KeyboardManager.ts","../src/core/Canvas.ts","../src/ui/icons.ts","../src/ui/toolbar.styles.ts","../src/ui/ShapeLayer.ts","../src/ui/Toolbar.ts","../src/core/Editor.ts","../src/plugins/base/BasePlugin.ts","../src/plugins/mosaic/mosaic.utils.ts","../src/plugins/mosaic/MosaicPlugin.ts","../src/plugins/text/TextLayer.ts","../src/plugins/text/text.utils.ts","../src/plugins/text/TextPlugin.ts","../src/plugins/filter/filters/brightness.ts","../src/plugins/filter/filters/contrast.ts","../src/plugins/filter/filters/saturation.ts","../src/plugins/filter/filters/blur.ts","../src/plugins/filter/filters/grayscale.ts","../src/plugins/filter/FilterPlugin.ts","../src/i18n/locales/zh-CN.ts","../src/i18n/locales/en-US.ts","../src/i18n/index.ts","../src/ui/CropTool.ts","../src/ui/ContextMenu.ts","../src/ui/ExportDialog.ts","../src/ui/Rulers.ts","../src/index.ts"],"sourcesContent":["/**\r\n * Default configuration constants\r\n * Requirements: 10.1 - Configuration system\r\n */\r\n\r\nimport type {\r\n  EditorConfig,\r\n  MosaicConfig,\r\n  TextConfig,\r\n  FilterConfig,\r\n  ExportOptions,\r\n} from '../types';\r\n\r\n/**\r\n * Default editor configuration\r\n */\r\nexport const DEFAULT_EDITOR_CONFIG: Required<EditorConfig> = {\r\n  width: 800,\r\n  height: 600,\r\n  backgroundColor: 'transparent',\r\n  historyLimit: 50,\r\n  responsive: true,\r\n  deviceType: 'auto',\r\n};\r\n\r\n/**\r\n * Default mosaic plugin configuration\r\n */\r\nexport const DEFAULT_MOSAIC_CONFIG: MosaicConfig = {\r\n  blockSize: 10,\r\n  intensity: 100,\r\n  mode: 'free',\r\n  brushSize: 20,\r\n};\r\n\r\n/**\r\n * Default text plugin configuration\r\n */\r\nexport const DEFAULT_TEXT_CONFIG: TextConfig = {\r\n  fontSize: 16,\r\n  fontFamily: 'Arial',\r\n  color: '#000000',\r\n  bold: false,\r\n  italic: false,\r\n  underline: false,\r\n  align: 'left',\r\n  lineHeight: 1.2,\r\n};\r\n\r\n/**\r\n * Default filter plugin configuration\r\n */\r\nexport const DEFAULT_FILTER_CONFIG: FilterConfig = {\r\n  brightness: 0,\r\n  contrast: 0,\r\n  saturation: 0,\r\n  blur: 0,\r\n  grayscale: 0,\r\n  sepia: 0,\r\n  invert: 0,\r\n};\r\n\r\n/**\r\n * Default export options\r\n */\r\nexport const DEFAULT_EXPORT_OPTIONS: Required<ExportOptions> = {\r\n  format: 'png',\r\n  quality: 0.92,\r\n  width: 0, // 0 means use original size\r\n  height: 0,\r\n  type: 'base64',\r\n  fileName: 'image',\r\n};\r\n","/**\r\n * Event name constants\r\n * Requirements: 1.2, 1.4 - Event system\r\n */\r\n\r\n/**\r\n * Editor event names\r\n */\r\nexport const EDITOR_EVENTS = {\r\n  /** Editor is ready */\r\n  READY: 'ready',\r\n  /** Error occurred */\r\n  ERROR: 'error',\r\n  /** Image loaded */\r\n  IMAGE_LOADED: 'image-loaded',\r\n  /** Tool changed */\r\n  TOOL_CHANGE: 'tool-change',\r\n  /** History changed */\r\n  HISTORY_CHANGE: 'history-change',\r\n  /** Before export */\r\n  BEFORE_EXPORT: 'before-export',\r\n  /** After export */\r\n  AFTER_EXPORT: 'after-export',\r\n  /** Editor destroyed */\r\n  DESTROY: 'destroy',\r\n} as const;\r\n\r\n/**\r\n * Plugin event names\r\n */\r\nexport const PLUGIN_EVENTS = {\r\n  /** Plugin installed */\r\n  INSTALLED: 'plugin-installed',\r\n  /** Plugin activated */\r\n  ACTIVATED: 'plugin-activated',\r\n  /** Plugin deactivated */\r\n  DEACTIVATED: 'plugin-deactivated',\r\n  /** Plugin error */\r\n  ERROR: 'plugin-error',\r\n} as const;\r\n\r\n/**\r\n * Canvas event names\r\n */\r\nexport const CANVAS_EVENTS = {\r\n  /** Pointer down */\r\n  POINTER_DOWN: 'pointer-down',\r\n  /** Pointer move */\r\n  POINTER_MOVE: 'pointer-move',\r\n  /** Pointer up */\r\n  POINTER_UP: 'pointer-up',\r\n  /** Pinch gesture */\r\n  PINCH: 'pinch',\r\n  /** Pan gesture */\r\n  PAN: 'pan',\r\n  /** Canvas resized */\r\n  RESIZE: 'resize',\r\n} as const;\r\n\r\n/**\r\n * All event name types\r\n */\r\nexport type EditorEventName = (typeof EDITOR_EVENTS)[keyof typeof EDITOR_EVENTS];\r\nexport type PluginEventName = (typeof PLUGIN_EVENTS)[keyof typeof PLUGIN_EVENTS];\r\nexport type CanvasEventName = (typeof CANVAS_EVENTS)[keyof typeof CANVAS_EVENTS];\r\n","/**\r\n * DOM utility functions\r\n * Requirements: 8.5 - Device type auto-switching\r\n */\r\n\r\n/**\r\n * Get element by selector or return the element itself\r\n */\r\nexport function getElement(\r\n  selector: string | HTMLElement\r\n): HTMLElement | null {\r\n  if (typeof selector === 'string') {\r\n    return document.querySelector(selector);\r\n  }\r\n  return selector;\r\n}\r\n\r\n/**\r\n * Create a canvas element with specified dimensions\r\n */\r\nexport function createCanvas(\r\n  width: number,\r\n  height: number\r\n): HTMLCanvasElement {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  return canvas;\r\n}\r\n\r\n/**\r\n * Get 2D rendering context from canvas\r\n */\r\nexport function getContext2D(\r\n  canvas: HTMLCanvasElement\r\n): CanvasRenderingContext2D {\r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) {\r\n    throw new Error('Failed to get 2D context from canvas');\r\n  }\r\n  return ctx;\r\n}\r\n\r\n/**\r\n * Get element's bounding rect relative to viewport\r\n */\r\nexport function getElementRect(element: HTMLElement): DOMRect {\r\n  return element.getBoundingClientRect();\r\n}\r\n\r\n/**\r\n * Get coordinates relative to an element\r\n */\r\nexport function getRelativeCoordinates(\r\n  event: MouseEvent | Touch,\r\n  element: HTMLElement\r\n): { x: number; y: number } {\r\n  const rect = getElementRect(element);\r\n  return {\r\n    x: event.clientX - rect.left,\r\n    y: event.clientY - rect.top,\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Set canvas dimensions\r\n */\r\nexport function setCanvasSize(\r\n  canvas: HTMLCanvasElement,\r\n  width: number,\r\n  height: number\r\n): void {\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n}\r\n\r\n/**\r\n * Clear canvas content\r\n */\r\nexport function clearCanvas(\r\n  ctx: CanvasRenderingContext2D,\r\n  width: number,\r\n  height: number\r\n): void {\r\n  ctx.clearRect(0, 0, width, height);\r\n}\r\n\r\n/**\r\n * Fill canvas with a color\r\n */\r\nexport function fillCanvas(\r\n  ctx: CanvasRenderingContext2D,\r\n  width: number,\r\n  height: number,\r\n  color: string\r\n): void {\r\n  ctx.fillStyle = color;\r\n  ctx.fillRect(0, 0, width, height);\r\n}\r\n\r\n/**\r\n * Add CSS styles to an element\r\n */\r\nexport function setStyles(\r\n  element: HTMLElement,\r\n  styles: Partial<CSSStyleDeclaration>\r\n): void {\r\n  Object.assign(element.style, styles);\r\n}\r\n\r\n/**\r\n * Remove element from DOM\r\n */\r\nexport function removeElement(element: HTMLElement): void {\r\n  element.parentNode?.removeChild(element);\r\n}\r\n\r\n/**\r\n * Check if element is in viewport\r\n */\r\nexport function isInViewport(element: HTMLElement): boolean {\r\n  const rect = element.getBoundingClientRect();\r\n  return (\r\n    rect.top >= 0 &&\r\n    rect.left >= 0 &&\r\n    rect.bottom <= window.innerHeight &&\r\n    rect.right <= window.innerWidth\r\n  );\r\n}\r\n","/**\r\n * Image utility functions\r\n * Requirements: 8.5 - Image processing utilities\r\n */\r\n\r\n/**\r\n * Load an image from URL or HTMLImageElement\r\n */\r\nexport function loadImage(\r\n  source: string | HTMLImageElement\r\n): Promise<HTMLImageElement> {\r\n  return new Promise((resolve, reject) => {\r\n    if (source instanceof HTMLImageElement) {\r\n      if (source.complete) {\r\n        resolve(source);\r\n      } else {\r\n        source.onload = () => resolve(source);\r\n        source.onerror = () => reject(new Error('Failed to load image'));\r\n      }\r\n      return;\r\n    }\r\n\r\n    const img = new Image();\r\n    img.crossOrigin = 'anonymous';\r\n    img.onload = () => resolve(img);\r\n    img.onerror = () => reject(new Error(`Failed to load image: ${source}`));\r\n    img.src = source;\r\n  });\r\n}\r\n\r\n/**\r\n * Get image dimensions\r\n */\r\nexport function getImageDimensions(\r\n  image: HTMLImageElement\r\n): { width: number; height: number } {\r\n  return {\r\n    width: image.naturalWidth || image.width,\r\n    height: image.naturalHeight || image.height,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate scaled dimensions while maintaining aspect ratio\r\n */\r\nexport function calculateAspectRatioFit(\r\n  srcWidth: number,\r\n  srcHeight: number,\r\n  maxWidth: number,\r\n  maxHeight: number\r\n): { width: number; height: number } {\r\n  const ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);\r\n  return {\r\n    width: Math.round(srcWidth * ratio),\r\n    height: Math.round(srcHeight * ratio),\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Draw image to canvas context\r\n */\r\nexport function drawImageToCanvas(\r\n  ctx: CanvasRenderingContext2D,\r\n  image: HTMLImageElement,\r\n  x: number = 0,\r\n  y: number = 0,\r\n  width?: number,\r\n  height?: number\r\n): void {\r\n  if (width !== undefined && height !== undefined) {\r\n    ctx.drawImage(image, x, y, width, height);\r\n  } else {\r\n    ctx.drawImage(image, x, y);\r\n  }\r\n}\r\n\r\n/**\r\n * Get ImageData from canvas\r\n */\r\nexport function getImageData(\r\n  ctx: CanvasRenderingContext2D,\r\n  x: number = 0,\r\n  y: number = 0,\r\n  width?: number,\r\n  height?: number\r\n): ImageData {\r\n  const w = width ?? ctx.canvas.width;\r\n  const h = height ?? ctx.canvas.height;\r\n  return ctx.getImageData(x, y, w, h);\r\n}\r\n\r\n/**\r\n * Put ImageData to canvas\r\n */\r\nexport function putImageData(\r\n  ctx: CanvasRenderingContext2D,\r\n  imageData: ImageData,\r\n  x: number = 0,\r\n  y: number = 0\r\n): void {\r\n  ctx.putImageData(imageData, x, y);\r\n}\r\n\r\n/**\r\n * Clone ImageData\r\n */\r\nexport function cloneImageData(imageData: ImageData): ImageData {\r\n  return new ImageData(\r\n    new Uint8ClampedArray(imageData.data),\r\n    imageData.width,\r\n    imageData.height\r\n  );\r\n}\r\n\r\n/**\r\n * Create empty ImageData\r\n */\r\nexport function createImageData(\r\n  width: number,\r\n  height: number\r\n): ImageData {\r\n  return new ImageData(width, height);\r\n}\r\n\r\n/**\r\n * Convert canvas to data URL\r\n */\r\nexport function canvasToDataURL(\r\n  canvas: HTMLCanvasElement,\r\n  format: 'png' | 'jpeg' | 'webp' = 'png',\r\n  quality: number = 0.92\r\n): string {\r\n  const mimeType = `image/${format}`;\r\n  return canvas.toDataURL(mimeType, quality);\r\n}\r\n\r\n/**\r\n * Convert canvas to Blob\r\n */\r\nexport function canvasToBlob(\r\n  canvas: HTMLCanvasElement,\r\n  format: 'png' | 'jpeg' | 'webp' = 'png',\r\n  quality: number = 0.92\r\n): Promise<Blob> {\r\n  return new Promise((resolve, reject) => {\r\n    const mimeType = `image/${format}`;\r\n    canvas.toBlob(\r\n      (blob) => {\r\n        if (blob) {\r\n          resolve(blob);\r\n        } else {\r\n          reject(new Error('Failed to convert canvas to blob'));\r\n        }\r\n      },\r\n      mimeType,\r\n      quality\r\n    );\r\n  });\r\n}\r\n\r\n/**\r\n * Create a scaled canvas\r\n */\r\nexport function createScaledCanvas(\r\n  sourceCanvas: HTMLCanvasElement,\r\n  width: number,\r\n  height: number\r\n): HTMLCanvasElement {\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = width;\r\n  canvas.height = height;\r\n  const ctx = canvas.getContext('2d');\r\n  if (ctx) {\r\n    ctx.drawImage(sourceCanvas, 0, 0, width, height);\r\n  }\r\n  return canvas;\r\n}\r\n","/**\r\n * Event utility functions\r\n * Requirements: 8.5 - Event handling utilities\r\n */\r\n\r\nimport type { PointerEventData, GestureEventData } from '../types';\r\n\r\n/**\r\n * Normalize mouse/touch event to unified pointer event\r\n */\r\nexport function normalizePointerEvent(\r\n  event: MouseEvent | TouchEvent,\r\n  element: HTMLElement,\r\n  type: 'start' | 'move' | 'end'\r\n): PointerEventData {\r\n  const rect = element.getBoundingClientRect();\r\n\r\n  if ('touches' in event) {\r\n    const touch = event.touches[0] || event.changedTouches[0];\r\n    return {\r\n      type,\r\n      x: touch.clientX - rect.left,\r\n      y: touch.clientY - rect.top,\r\n      pressure: touch.force || 0.5,\r\n      isPrimary: true,\r\n      pointerId: touch.identifier,\r\n    };\r\n  }\r\n\r\n  return {\r\n    type,\r\n    x: event.clientX - rect.left,\r\n    y: event.clientY - rect.top,\r\n    pressure: 0.5,\r\n    isPrimary: true,\r\n    pointerId: 0,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate distance between two touch points\r\n */\r\nexport function getTouchDistance(touch1: Touch, touch2: Touch): number {\r\n  const dx = touch1.clientX - touch2.clientX;\r\n  const dy = touch1.clientY - touch2.clientY;\r\n  return Math.sqrt(dx * dx + dy * dy);\r\n}\r\n\r\n/**\r\n * Calculate center point between two touch points\r\n */\r\nexport function getTouchCenter(\r\n  touch1: Touch,\r\n  touch2: Touch\r\n): { x: number; y: number } {\r\n  return {\r\n    x: (touch1.clientX + touch2.clientX) / 2,\r\n    y: (touch1.clientY + touch2.clientY) / 2,\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Create pinch gesture event data\r\n */\r\nexport function createPinchEvent(\r\n  touches: TouchList,\r\n  element: HTMLElement,\r\n  initialDistance: number\r\n): GestureEventData {\r\n  const touch1 = touches[0];\r\n  const touch2 = touches[1];\r\n  const currentDistance = getTouchDistance(touch1, touch2);\r\n  const rect = element.getBoundingClientRect();\r\n  const center = getTouchCenter(touch1, touch2);\r\n\r\n  return {\r\n    type: 'pinch',\r\n    scale: currentDistance / initialDistance,\r\n    center: {\r\n      x: center.x - rect.left,\r\n      y: center.y - rect.top,\r\n    },\r\n  };\r\n}\r\n\r\n/**\r\n * Create pan gesture event data\r\n */\r\nexport function createPanEvent(\r\n  deltaX: number,\r\n  deltaY: number\r\n): GestureEventData {\r\n  return {\r\n    type: 'pan',\r\n    deltaX,\r\n    deltaY,\r\n  };\r\n}\r\n\r\n/**\r\n * Throttle function execution\r\n */\r\nexport function throttle<T extends (...args: unknown[]) => void>(\r\n  fn: T,\r\n  delay: number\r\n): T {\r\n  let lastCall = 0;\r\n  return ((...args: unknown[]) => {\r\n    const now = Date.now();\r\n    if (now - lastCall >= delay) {\r\n      lastCall = now;\r\n      fn(...args);\r\n    }\r\n  }) as T;\r\n}\r\n\r\n/**\r\n * Debounce function execution\r\n */\r\nexport function debounce<T extends (...args: unknown[]) => void>(\r\n  fn: T,\r\n  delay: number\r\n): T {\r\n  let timeoutId: ReturnType<typeof setTimeout> | null = null;\r\n  return ((...args: unknown[]) => {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    timeoutId = setTimeout(() => {\r\n      fn(...args);\r\n      timeoutId = null;\r\n    }, delay);\r\n  }) as T;\r\n}\r\n\r\n/**\r\n * Prevent default event behavior\r\n */\r\nexport function preventDefault(event: Event): void {\r\n  event.preventDefault();\r\n}\r\n\r\n/**\r\n * Stop event propagation\r\n */\r\nexport function stopPropagation(event: Event): void {\r\n  event.stopPropagation();\r\n}\r\n\r\n/**\r\n * Add event listener with cleanup function\r\n */\r\nexport function addEventListenerWithCleanup<K extends keyof HTMLElementEventMap>(\r\n  element: HTMLElement | Window,\r\n  type: K,\r\n  listener: (event: HTMLElementEventMap[K]) => void,\r\n  options?: boolean | AddEventListenerOptions\r\n): () => void {\r\n  element.addEventListener(type, listener as EventListener, options);\r\n  return () => {\r\n    element.removeEventListener(type, listener as EventListener, options);\r\n  };\r\n}\r\n","/**\r\n * Device detection utility functions\r\n * Requirements: 8.5 - Device type auto-switching\r\n */\r\n\r\nimport type { DeviceType } from '../types';\r\n\r\n/**\r\n * Check if the device is a touch device\r\n */\r\nexport function isTouchDevice(): boolean {\r\n  if (typeof window === 'undefined') {\r\n    return false;\r\n  }\r\n  return (\r\n    'ontouchstart' in window ||\r\n    navigator.maxTouchPoints > 0 ||\r\n    // @ts-expect-error - msMaxTouchPoints is IE specific\r\n    navigator.msMaxTouchPoints > 0\r\n  );\r\n}\r\n\r\n/**\r\n * Check if the device is a mobile device based on user agent\r\n */\r\nexport function isMobileDevice(): boolean {\r\n  if (typeof navigator === 'undefined') {\r\n    return false;\r\n  }\r\n  const userAgent = navigator.userAgent.toLowerCase();\r\n  return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(\r\n    userAgent\r\n  );\r\n}\r\n\r\n/**\r\n * Check if the device is an iOS device\r\n */\r\nexport function isIOSDevice(): boolean {\r\n  if (typeof navigator === 'undefined') {\r\n    return false;\r\n  }\r\n  return /iphone|ipad|ipod/i.test(navigator.userAgent.toLowerCase());\r\n}\r\n\r\n/**\r\n * Check if the device is an Android device\r\n */\r\nexport function isAndroidDevice(): boolean {\r\n  if (typeof navigator === 'undefined') {\r\n    return false;\r\n  }\r\n  return /android/i.test(navigator.userAgent.toLowerCase());\r\n}\r\n\r\n\r\n/**\r\n * Detect device type automatically\r\n */\r\nexport function detectDeviceType(): 'pc' | 'mobile' {\r\n  if (isMobileDevice() || isTouchDevice()) {\r\n    return 'mobile';\r\n  }\r\n  return 'pc';\r\n}\r\n\r\n/**\r\n * Get resolved device type based on configuration\r\n */\r\nexport function getResolvedDeviceType(deviceType: DeviceType): 'pc' | 'mobile' {\r\n  if (deviceType === 'auto') {\r\n    return detectDeviceType();\r\n  }\r\n  return deviceType;\r\n}\r\n\r\n/**\r\n * Get device pixel ratio\r\n */\r\nexport function getDevicePixelRatio(): number {\r\n  if (typeof window === 'undefined') {\r\n    return 1;\r\n  }\r\n  return window.devicePixelRatio || 1;\r\n}\r\n\r\n/**\r\n * Check if the browser supports passive event listeners\r\n */\r\nexport function supportsPassiveEvents(): boolean {\r\n  let passiveSupported = false;\r\n  try {\r\n    const options = {\r\n      get passive() {\r\n        passiveSupported = true;\r\n        return false;\r\n      },\r\n    };\r\n    // @ts-expect-error - Testing passive support\r\n    window.addEventListener('test', null, options);\r\n    // @ts-expect-error - Testing passive support\r\n    window.removeEventListener('test', null, options);\r\n  } catch {\r\n    passiveSupported = false;\r\n  }\r\n  return passiveSupported;\r\n}\r\n\r\n/**\r\n * Get passive event listener options\r\n */\r\nexport function getPassiveOptions(): AddEventListenerOptions | boolean {\r\n  return supportsPassiveEvents() ? { passive: true } : false;\r\n}\r\n\r\n/**\r\n * Get non-passive event listener options (for preventing default)\r\n */\r\nexport function getNonPassiveOptions(): AddEventListenerOptions | boolean {\r\n  return supportsPassiveEvents() ? { passive: false } : false;\r\n}\r\n\r\n/**\r\n * Check if the browser supports pointer events\r\n */\r\nexport function supportsPointerEvents(): boolean {\r\n  if (typeof window === 'undefined') {\r\n    return false;\r\n  }\r\n  return 'PointerEvent' in window;\r\n}\r\n\r\n/**\r\n * Get viewport dimensions\r\n */\r\nexport function getViewportDimensions(): { width: number; height: number } {\r\n  if (typeof window === 'undefined') {\r\n    return { width: 0, height: 0 };\r\n  }\r\n  return {\r\n    width: window.innerWidth,\r\n    height: window.innerHeight,\r\n  };\r\n}\r\n","/**\r\n * Export utilities - Image export functionality\r\n * Requirements: 7.1, 7.2, 7.3, 7.4, 7.5\r\n * \r\n * Note: Full implementation in task 5.6\r\n */\r\n\r\nimport type { ExportOptions } from '../types/config.types';\r\nimport { DEFAULT_EXPORT_OPTIONS } from '../constants/defaults';\r\nimport { canvasToDataURL, canvasToBlob, createScaledCanvas } from './image.utils';\r\n\r\n/**\r\n * Export image from canvas with specified options\r\n * Requirements: 7.1, 7.2, 7.3, 7.4, 7.5\r\n * @param canvas - Source canvas element\r\n * @param options - Export options\r\n * @returns Promise with exported data (base64, Blob, or File)\r\n */\r\nexport async function exportImage(\r\n  canvas: HTMLCanvasElement,\r\n  options?: ExportOptions\r\n): Promise<string | Blob | File> {\r\n  const opts = {\r\n    ...DEFAULT_EXPORT_OPTIONS,\r\n    ...options,\r\n  };\r\n\r\n  // Determine target canvas (scaled or original)\r\n  let targetCanvas = canvas;\r\n  if (opts.width && opts.height && (opts.width !== canvas.width || opts.height !== canvas.height)) {\r\n    targetCanvas = createScaledCanvas(canvas, opts.width, opts.height);\r\n  } else if (opts.width && !opts.height) {\r\n    // Scale proportionally based on width\r\n    const ratio = opts.width / canvas.width;\r\n    const height = Math.round(canvas.height * ratio);\r\n    targetCanvas = createScaledCanvas(canvas, opts.width, height);\r\n  } else if (opts.height && !opts.width) {\r\n    // Scale proportionally based on height\r\n    const ratio = opts.height / canvas.height;\r\n    const width = Math.round(canvas.width * ratio);\r\n    targetCanvas = createScaledCanvas(canvas, width, opts.height);\r\n  }\r\n\r\n  // Export based on type\r\n  switch (opts.type) {\r\n    case 'base64':\r\n      return canvasToDataURL(targetCanvas, opts.format, opts.quality);\r\n\r\n    case 'blob':\r\n      return canvasToBlob(targetCanvas, opts.format, opts.quality);\r\n\r\n    case 'file': {\r\n      const blob = await canvasToBlob(targetCanvas, opts.format, opts.quality);\r\n      const extension = opts.format === 'jpeg' ? 'jpg' : opts.format;\r\n      const fileName = `${opts.fileName || 'image'}.${extension}`;\r\n      return new File([blob], fileName, { type: `image/${opts.format}` });\r\n    }\r\n\r\n    default:\r\n      return canvasToDataURL(targetCanvas, opts.format, opts.quality);\r\n  }\r\n}\r\n","/**\r\n * Placeholder image generator for editor\r\n */\r\n\r\nexport interface PlaceholderOptions {\r\n  width?: number;\r\n  height?: number;\r\n  text?: string;\r\n  subText?: string;\r\n  theme?: 'light' | 'dark';\r\n}\r\n\r\n/**\r\n * Create a placeholder image data URL\r\n */\r\nexport function createPlaceholder(options: PlaceholderOptions = {}): string {\r\n  const {\r\n    width: w = 800,\r\n    height: h = 600,\r\n    text = '点击上传或拖放图片',\r\n    subText = '支持 PNG、JPG、GIF 等格式',\r\n    theme = 'dark',\r\n  } = options;\r\n\r\n  const canvas = document.createElement('canvas');\r\n  canvas.width = w;\r\n  canvas.height = h;\r\n  \r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) return '';\r\n  \r\n  // Theme colors - high contrast for clarity\r\n  const isDark = theme === 'dark';\r\n  const borderColor = isDark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.12)';\r\n  const iconColor = isDark ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.35)';\r\n  const textColor = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.65)';\r\n  const subTextColor = isDark ? 'rgba(255,255,255,0.4)' : 'rgba(0,0,0,0.4)';\r\n  \r\n  // Transparent background - inherits from container\r\n  ctx.clearRect(0, 0, w, h);\r\n  \r\n  // Dashed border with proper margin\r\n  const padding = Math.max(20, Math.min(w, h) * 0.05);\r\n  const cornerRadius = 8;\r\n  const boxLeft = padding;\r\n  const boxTop = padding;\r\n  const boxWidth = w - padding * 2;\r\n  const boxHeight = h - padding * 2;\r\n  \r\n  ctx.strokeStyle = borderColor;\r\n  ctx.lineWidth = 1;\r\n  ctx.setLineDash([4, 3]);\r\n  \r\n  // Draw rounded rectangle border\r\n  ctx.beginPath();\r\n  ctx.moveTo(boxLeft + cornerRadius, boxTop);\r\n  ctx.lineTo(boxLeft + boxWidth - cornerRadius, boxTop);\r\n  ctx.quadraticCurveTo(boxLeft + boxWidth, boxTop, boxLeft + boxWidth, boxTop + cornerRadius);\r\n  ctx.lineTo(boxLeft + boxWidth, boxTop + boxHeight - cornerRadius);\r\n  ctx.quadraticCurveTo(boxLeft + boxWidth, boxTop + boxHeight, boxLeft + boxWidth - cornerRadius, boxTop + boxHeight);\r\n  ctx.lineTo(boxLeft + cornerRadius, boxTop + boxHeight);\r\n  ctx.quadraticCurveTo(boxLeft, boxTop + boxHeight, boxLeft, boxTop + boxHeight - cornerRadius);\r\n  ctx.lineTo(boxLeft, boxTop + cornerRadius);\r\n  ctx.quadraticCurveTo(boxLeft, boxTop, boxLeft + cornerRadius, boxTop);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n  ctx.setLineDash([]);\r\n  \r\n  // Content centered\r\n  const centerX = w / 2;\r\n  const centerY = h / 2;\r\n  \r\n  ctx.strokeStyle = iconColor;\r\n  ctx.lineWidth = 2;\r\n  ctx.lineCap = 'round';\r\n  ctx.lineJoin = 'round';\r\n  \r\n  // Larger image icon for better visibility\r\n  const imgBoxW = 48;\r\n  const imgBoxH = 36;\r\n  const imgBoxX = centerX - imgBoxW / 2;\r\n  const imgBoxY = centerY - 45;\r\n  const imgRadius = 5;\r\n  \r\n  // Icon frame\r\n  ctx.beginPath();\r\n  ctx.moveTo(imgBoxX + imgRadius, imgBoxY);\r\n  ctx.lineTo(imgBoxX + imgBoxW - imgRadius, imgBoxY);\r\n  ctx.quadraticCurveTo(imgBoxX + imgBoxW, imgBoxY, imgBoxX + imgBoxW, imgBoxY + imgRadius);\r\n  ctx.lineTo(imgBoxX + imgBoxW, imgBoxY + imgBoxH - imgRadius);\r\n  ctx.quadraticCurveTo(imgBoxX + imgBoxW, imgBoxY + imgBoxH, imgBoxX + imgBoxW - imgRadius, imgBoxY + imgBoxH);\r\n  ctx.lineTo(imgBoxX + imgRadius, imgBoxY + imgBoxH);\r\n  ctx.quadraticCurveTo(imgBoxX, imgBoxY + imgBoxH, imgBoxX, imgBoxY + imgBoxH - imgRadius);\r\n  ctx.lineTo(imgBoxX, imgBoxY + imgRadius);\r\n  ctx.quadraticCurveTo(imgBoxX, imgBoxY, imgBoxX + imgRadius, imgBoxY);\r\n  ctx.stroke();\r\n  \r\n  // Mountain landscape (scaled up)\r\n  ctx.beginPath();\r\n  ctx.moveTo(imgBoxX + 8, imgBoxY + imgBoxH - 8);\r\n  ctx.lineTo(imgBoxX + 18, imgBoxY + 12);\r\n  ctx.lineTo(imgBoxX + 26, imgBoxY + imgBoxH - 12);\r\n  ctx.lineTo(imgBoxX + 34, imgBoxY + 14);\r\n  ctx.lineTo(imgBoxX + imgBoxW - 8, imgBoxY + imgBoxH - 8);\r\n  ctx.stroke();\r\n  \r\n  // Sun (scaled up)\r\n  ctx.beginPath();\r\n  ctx.arc(imgBoxX + imgBoxW - 12, imgBoxY + 11, 5, 0, Math.PI * 2);\r\n  ctx.stroke();\r\n  \r\n  // Title text - bold and clear\r\n  ctx.fillStyle = textColor;\r\n  ctx.font = '600 14px -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif';\r\n  ctx.textAlign = 'center';\r\n  ctx.textBaseline = 'middle';\r\n  ctx.fillText(text, centerX, centerY + 12);\r\n  \r\n  // Description text - smaller and lighter\r\n  if (subText) {\r\n    ctx.fillStyle = subTextColor;\r\n    ctx.font = '400 12px -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif';\r\n    ctx.fillText(subText, centerX, centerY + 34);\r\n  }\r\n  \r\n  return canvas.toDataURL('image/png');\r\n}\r\n\r\n/** Check if a data URL is a placeholder image */\r\nexport function isPlaceholderImage(dataUrl: string): boolean {\r\n  // Our placeholder images are always PNG and have a specific pattern\r\n  // We embed a marker in the placeholder to identify it\r\n  return dataUrl.includes('data:image/png') && dataUrl.length < 50000;\r\n}\r\n","/**\r\n * Event Manager - Handles event subscription, emission, and cleanup\r\n * Requirements: 1.2, 1.4 - Event system\r\n */\r\n\r\nimport type {\r\n  EventHandler,\r\n  EventListenerOptions,\r\n  EditorEvents,\r\n} from '../types/event.types';\r\n\r\n/**\r\n * Internal listener structure\r\n */\r\ninterface Listener<T = unknown> {\r\n  handler: EventHandler<T>;\r\n  once: boolean;\r\n}\r\n\r\n/**\r\n * EventManager class - Manages event subscriptions and emissions\r\n * Requirements: 1.2, 1.4\r\n */\r\nexport class EventManager {\r\n  private listeners: Map<string, Set<Listener>> = new Map();\r\n\r\n  /**\r\n   * Subscribe to an event\r\n   * @param event - Event name\r\n   * @param handler - Event handler function\r\n   * @param options - Listener options\r\n   */\r\n  on<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>,\r\n    options?: EventListenerOptions\r\n  ): void {\r\n    const eventName = event as string;\r\n    \r\n    if (!this.listeners.has(eventName)) {\r\n      this.listeners.set(eventName, new Set());\r\n    }\r\n\r\n    const listener: Listener<EditorEvents[K]> = {\r\n      handler,\r\n      once: options?.once ?? false,\r\n    };\r\n\r\n    this.listeners.get(eventName)!.add(listener as Listener);\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an event once (auto-unsubscribe after first trigger)\r\n   * @param event - Event name\r\n   * @param handler - Event handler function\r\n   */\r\n  once<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>\r\n  ): void {\r\n    this.on(event, handler, { once: true });\r\n  }\r\n\r\n\r\n  /**\r\n   * Unsubscribe from an event\r\n   * @param event - Event name\r\n   * @param handler - Event handler function to remove\r\n   */\r\n  off<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>\r\n  ): void {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n\r\n    if (!listeners) {\r\n      return;\r\n    }\r\n\r\n    for (const listener of listeners) {\r\n      if (listener.handler === handler) {\r\n        listeners.delete(listener);\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Clean up empty listener sets\r\n    if (listeners.size === 0) {\r\n      this.listeners.delete(eventName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit an event to all subscribers\r\n   * @param event - Event name\r\n   * @param data - Event data\r\n   */\r\n  emit<K extends keyof EditorEvents>(event: K, data: EditorEvents[K]): void {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n\r\n    if (!listeners) {\r\n      return;\r\n    }\r\n\r\n    // Create a copy to avoid modification during iteration\r\n    const listenersArray = Array.from(listeners);\r\n\r\n    for (const listener of listenersArray) {\r\n      try {\r\n        listener.handler(data);\r\n\r\n        // Remove one-time listeners after execution\r\n        if (listener.once) {\r\n          listeners.delete(listener);\r\n        }\r\n      } catch (error) {\r\n        console.error(`Error in event handler for \"${eventName}\":`, error);\r\n      }\r\n    }\r\n\r\n    // Clean up empty listener sets\r\n    if (listeners.size === 0) {\r\n      this.listeners.delete(eventName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if an event has any listeners\r\n   * @param event - Event name\r\n   * @returns True if the event has listeners\r\n   */\r\n  hasListeners<K extends keyof EditorEvents>(event: K): boolean {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n    return listeners !== undefined && listeners.size > 0;\r\n  }\r\n\r\n  /**\r\n   * Get the number of listeners for an event\r\n   * @param event - Event name\r\n   * @returns Number of listeners\r\n   */\r\n  listenerCount<K extends keyof EditorEvents>(event: K): number {\r\n    const eventName = event as string;\r\n    const listeners = this.listeners.get(eventName);\r\n    return listeners?.size ?? 0;\r\n  }\r\n\r\n  /**\r\n   * Remove all listeners for a specific event or all events\r\n   * @param event - Optional event name. If not provided, removes all listeners\r\n   */\r\n  removeAllListeners<K extends keyof EditorEvents>(event?: K): void {\r\n    if (event !== undefined) {\r\n      this.listeners.delete(event as string);\r\n    } else {\r\n      this.listeners.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the event manager and clean up all resources\r\n   */\r\n  destroy(): void {\r\n    this.listeners.clear();\r\n  }\r\n}\r\n","/**\r\n * Config Manager - Handles configuration merging and runtime updates\r\n * Requirements: 10.1, 10.5 - Configuration system\r\n */\r\n\r\nimport type { EditorConfig, DeepPartial } from '../types/config.types';\r\nimport { DEFAULT_EDITOR_CONFIG } from '../constants/defaults';\r\n\r\n/**\r\n * ConfigManager class - Manages editor configuration\r\n * Requirements: 10.1, 10.5\r\n */\r\nexport class ConfigManager {\r\n  private config: Required<EditorConfig>;\r\n  private listeners: Set<(config: Required<EditorConfig>) => void> = new Set();\r\n\r\n  /**\r\n   * Create a new ConfigManager instance\r\n   * @param userConfig - User provided configuration\r\n   */\r\n  constructor(userConfig?: DeepPartial<EditorConfig>) {\r\n    this.config = this.mergeConfig(DEFAULT_EDITOR_CONFIG, userConfig);\r\n  }\r\n\r\n  /**\r\n   * Deep merge two configuration objects\r\n   * User config values override default values\r\n   * @param defaultConfig - Default configuration\r\n   * @param userConfig - User configuration\r\n   * @returns Merged configuration\r\n   */\r\n  private mergeConfig(\r\n    defaultConfig: Required<EditorConfig>,\r\n    userConfig?: DeepPartial<EditorConfig>\r\n  ): Required<EditorConfig> {\r\n    if (!userConfig) {\r\n      return { ...defaultConfig };\r\n    }\r\n\r\n    const result = { ...defaultConfig };\r\n\r\n    for (const key of Object.keys(userConfig) as (keyof EditorConfig)[]) {\r\n      const userValue = userConfig[key];\r\n      if (userValue !== undefined) {\r\n        (result as Record<string, unknown>)[key] = userValue;\r\n      }\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n\r\n  /**\r\n   * Get the current configuration\r\n   * @returns Current configuration\r\n   */\r\n  getConfig(): Required<EditorConfig> {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Get a specific configuration value\r\n   * @param key - Configuration key\r\n   * @returns Configuration value\r\n   */\r\n  get<K extends keyof EditorConfig>(key: K): Required<EditorConfig>[K] {\r\n    return this.config[key];\r\n  }\r\n\r\n  /**\r\n   * Update configuration at runtime\r\n   * Requirements: 10.5 - Runtime configuration update\r\n   * @param updates - Partial configuration updates\r\n   */\r\n  update(updates: DeepPartial<EditorConfig>): void {\r\n    const oldConfig = { ...this.config };\r\n    this.config = this.mergeConfig(this.config, updates);\r\n\r\n    // Notify listeners if config changed\r\n    if (JSON.stringify(oldConfig) !== JSON.stringify(this.config)) {\r\n      this.notifyListeners();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a specific configuration value\r\n   * @param key - Configuration key\r\n   * @param value - Configuration value\r\n   */\r\n  set<K extends keyof EditorConfig>(\r\n    key: K,\r\n    value: Required<EditorConfig>[K]\r\n  ): void {\r\n    if (this.config[key] !== value) {\r\n      this.config[key] = value;\r\n      this.notifyListeners();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Reset configuration to defaults\r\n   * @param userConfig - Optional user config to apply after reset\r\n   */\r\n  reset(userConfig?: DeepPartial<EditorConfig>): void {\r\n    this.config = this.mergeConfig(DEFAULT_EDITOR_CONFIG, userConfig);\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to configuration changes\r\n   * @param listener - Callback function\r\n   * @returns Unsubscribe function\r\n   */\r\n  onChange(\r\n    listener: (config: Required<EditorConfig>) => void\r\n  ): () => void {\r\n    this.listeners.add(listener);\r\n    return () => {\r\n      this.listeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of configuration changes\r\n   */\r\n  private notifyListeners(): void {\r\n    const currentConfig = this.getConfig();\r\n    for (const listener of this.listeners) {\r\n      try {\r\n        listener(currentConfig);\r\n      } catch (error) {\r\n        console.error('Error in config change listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the config manager and clean up resources\r\n   */\r\n  destroy(): void {\r\n    this.listeners.clear();\r\n  }\r\n}\r\n","/**\r\n * History Manager - Handles undo/redo functionality\r\n * Requirements: 6.1, 6.2, 6.3, 6.5\r\n */\r\n\r\nimport type { HistoryState, HistoryManagerInterface } from '../types/editor.types';\r\n\r\n/**\r\n * Generate a unique ID for history states\r\n */\r\nfunction generateId(): string {\r\n  return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n/**\r\n * HistoryManager class - Manages undo/redo history\r\n * Requirements: 6.1, 6.2, 6.3, 6.5\r\n */\r\nexport class HistoryManager implements HistoryManagerInterface {\r\n  /** History states stack */\r\n  states: HistoryState[] = [];\r\n  /** Current position in history */\r\n  currentIndex: number = -1;\r\n  /** Maximum number of history states */\r\n  limit: number;\r\n  /** Listeners for history changes */\r\n  private listeners: Set<(canUndo: boolean, canRedo: boolean) => void> = new Set();\r\n\r\n  /**\r\n   * Create a new HistoryManager instance\r\n   * @param limit - Maximum number of history states (default: 50)\r\n   */\r\n  constructor(limit: number = 50) {\r\n    this.limit = Math.max(1, limit);\r\n  }\r\n\r\n  /**\r\n   * Push a new state to history\r\n   * Requirements: 6.1 - Record operations to history stack\r\n   * @param state - State to push (without id and timestamp)\r\n   */\r\n  push(state: Omit<HistoryState, 'id' | 'timestamp'>): void {\r\n    // Remove any states after current index (discard redo history)\r\n    if (this.currentIndex < this.states.length - 1) {\r\n      this.states = this.states.slice(0, this.currentIndex + 1);\r\n    }\r\n\r\n    // Create new state with id and timestamp\r\n    const newState: HistoryState = {\r\n      ...state,\r\n      id: generateId(),\r\n      timestamp: Date.now(),\r\n    };\r\n\r\n    // Add new state\r\n    this.states.push(newState);\r\n    this.currentIndex = this.states.length - 1;\r\n\r\n    // Enforce limit - remove oldest states if exceeded\r\n    // Requirements: 6.5 - History record limit control\r\n    while (this.states.length > this.limit) {\r\n      this.states.shift();\r\n      this.currentIndex--;\r\n    }\r\n\r\n    this.notifyListeners();\r\n  }\r\n\r\n\r\n  /**\r\n   * Undo to previous state\r\n   * Requirements: 6.2 - Restore to previous state\r\n   * @returns Previous state or null if cannot undo\r\n   */\r\n  undo(): HistoryState | null {\r\n    if (!this.canUndo()) {\r\n      return null;\r\n    }\r\n\r\n    this.currentIndex--;\r\n    this.notifyListeners();\r\n    return this.states[this.currentIndex];\r\n  }\r\n\r\n  /**\r\n   * Redo to next state\r\n   * Requirements: 6.3 - Restore to next state\r\n   * @returns Next state or null if cannot redo\r\n   */\r\n  redo(): HistoryState | null {\r\n    if (!this.canRedo()) {\r\n      return null;\r\n    }\r\n\r\n    this.currentIndex++;\r\n    this.notifyListeners();\r\n    return this.states[this.currentIndex];\r\n  }\r\n\r\n  /**\r\n   * Check if undo is available\r\n   * Requirements: 6.4 - No operation when history stack is empty\r\n   * @returns True if can undo\r\n   */\r\n  canUndo(): boolean {\r\n    return this.currentIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Check if redo is available\r\n   * @returns True if can redo\r\n   */\r\n  canRedo(): boolean {\r\n    return this.currentIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Get current state\r\n   * @returns Current state or null if no states\r\n   */\r\n  getCurrentState(): HistoryState | null {\r\n    if (this.currentIndex < 0 || this.currentIndex >= this.states.length) {\r\n      return null;\r\n    }\r\n    return this.states[this.currentIndex];\r\n  }\r\n\r\n  /**\r\n   * Get the number of states in history\r\n   * @returns Number of states\r\n   */\r\n  getLength(): number {\r\n    return this.states.length;\r\n  }\r\n\r\n  /**\r\n   * Clear all history\r\n   */\r\n  clear(): void {\r\n    this.states = [];\r\n    this.currentIndex = -1;\r\n    this.notifyListeners();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to history changes\r\n   * @param listener - Callback function\r\n   * @returns Unsubscribe function\r\n   */\r\n  onChange(listener: (canUndo: boolean, canRedo: boolean) => void): () => void {\r\n    this.listeners.add(listener);\r\n    return () => {\r\n      this.listeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of history changes\r\n   */\r\n  private notifyListeners(): void {\r\n    const canUndo = this.canUndo();\r\n    const canRedo = this.canRedo();\r\n    for (const listener of this.listeners) {\r\n      try {\r\n        listener(canUndo, canRedo);\r\n      } catch (error) {\r\n        console.error('Error in history change listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the history manager and clean up resources\r\n   */\r\n  destroy(): void {\r\n    this.clear();\r\n    this.listeners.clear();\r\n  }\r\n}\r\n","/**\r\n * Plugin Manager - Handles plugin registration, activation, and lifecycle\r\n * Requirements: 2.1, 2.2, 2.3, 2.4\r\n */\r\n\r\nimport type { Plugin, PluginConstructor, PluginContext } from '../types/plugin.types';\r\n\r\n/**\r\n * PluginManager class - Manages plugin lifecycle\r\n * Requirements: 2.1, 2.2, 2.3, 2.4\r\n */\r\nexport class PluginManager {\r\n  /** Registered plugins map */\r\n  private plugins: Map<string, Plugin> = new Map();\r\n  /** Currently active plugin name */\r\n  private activePluginName: string | null = null;\r\n  /** Plugin context for installation */\r\n  private context: PluginContext | null = null;\r\n  /** Listeners for plugin changes */\r\n  private listeners: Set<(pluginName: string | null, prevPluginName: string | null) => void> = new Set();\r\n\r\n  /**\r\n   * Set the plugin context\r\n   * @param context - Plugin context\r\n   */\r\n  setContext(context: PluginContext): void {\r\n    this.context = context;\r\n  }\r\n\r\n  /**\r\n   * Register a plugin\r\n   * Requirements: 2.1 - Add plugin to available tools list\r\n   * @param PluginClass - Plugin constructor\r\n   * @returns The plugin manager instance for chaining\r\n   */\r\n  register(PluginClass: PluginConstructor): this {\r\n    if (!this.context) {\r\n      throw new Error('Plugin context not set. Call setContext() first.');\r\n    }\r\n\r\n    const plugin = new PluginClass();\r\n    const name = plugin.name;\r\n\r\n    if (this.plugins.has(name)) {\r\n      console.warn(`Plugin \"${name}\" is already registered. Skipping.`);\r\n      return this;\r\n    }\r\n\r\n    // Install the plugin\r\n    plugin.install(this.context);\r\n    this.plugins.set(name, plugin);\r\n\r\n    return this;\r\n  }\r\n\r\n\r\n  /**\r\n   * Unregister a plugin\r\n   * @param name - Plugin name\r\n   * @returns True if plugin was unregistered\r\n   */\r\n  unregister(name: string): boolean {\r\n    const plugin = this.plugins.get(name);\r\n    if (!plugin) {\r\n      return false;\r\n    }\r\n\r\n    // Deactivate if active\r\n    if (this.activePluginName === name) {\r\n      this.deactivate(name);\r\n    }\r\n\r\n    // Destroy the plugin\r\n    plugin.destroy();\r\n    this.plugins.delete(name);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Activate a plugin\r\n   * Requirements: 2.3 - Call plugin's activate method with editor context\r\n   * @param name - Plugin name\r\n   * @returns True if plugin was activated\r\n   */\r\n  activate(name: string): boolean {\r\n    const plugin = this.plugins.get(name);\r\n    if (!plugin) {\r\n      console.warn(`Plugin \"${name}\" not found.`);\r\n      return false;\r\n    }\r\n\r\n    const prevPluginName = this.activePluginName;\r\n\r\n    // Deactivate current plugin if different\r\n    if (this.activePluginName && this.activePluginName !== name) {\r\n      this.deactivate(this.activePluginName);\r\n    }\r\n\r\n    // Activate the new plugin\r\n    plugin.activate();\r\n    this.activePluginName = name;\r\n\r\n    // Notify listeners\r\n    this.notifyListeners(name, prevPluginName);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Deactivate a plugin\r\n   * Requirements: 2.4 - Call plugin's deactivate method for cleanup\r\n   * @param name - Plugin name\r\n   * @returns True if plugin was deactivated\r\n   */\r\n  deactivate(name: string): boolean {\r\n    const plugin = this.plugins.get(name);\r\n    if (!plugin) {\r\n      return false;\r\n    }\r\n\r\n    if (this.activePluginName === name) {\r\n      plugin.deactivate();\r\n      const prevPluginName = this.activePluginName;\r\n      this.activePluginName = null;\r\n      this.notifyListeners(null, prevPluginName);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Get a plugin by name\r\n   * @param name - Plugin name\r\n   * @returns Plugin instance or undefined\r\n   */\r\n  get(name: string): Plugin | undefined {\r\n    return this.plugins.get(name);\r\n  }\r\n\r\n  /**\r\n   * Get the currently active plugin\r\n   * @returns Active plugin or null\r\n   */\r\n  getActive(): Plugin | null {\r\n    if (!this.activePluginName) {\r\n      return null;\r\n    }\r\n    return this.plugins.get(this.activePluginName) || null;\r\n  }\r\n\r\n  /**\r\n   * Get the name of the currently active plugin\r\n   * @returns Active plugin name or null\r\n   */\r\n  getActiveName(): string | null {\r\n    return this.activePluginName;\r\n  }\r\n\r\n  /**\r\n   * Check if a plugin is registered\r\n   * @param name - Plugin name\r\n   * @returns True if plugin is registered\r\n   */\r\n  has(name: string): boolean {\r\n    return this.plugins.has(name);\r\n  }\r\n\r\n  /**\r\n   * Check if a plugin is active\r\n   * @param name - Plugin name\r\n   * @returns True if plugin is active\r\n   */\r\n  isActive(name: string): boolean {\r\n    return this.activePluginName === name;\r\n  }\r\n\r\n  /**\r\n   * Get all registered plugin names\r\n   * @returns Array of plugin names\r\n   */\r\n  getNames(): string[] {\r\n    return Array.from(this.plugins.keys());\r\n  }\r\n\r\n  /**\r\n   * Get all registered plugins\r\n   * @returns Array of plugins\r\n   */\r\n  getAll(): Plugin[] {\r\n    return Array.from(this.plugins.values());\r\n  }\r\n\r\n  /**\r\n   * Subscribe to plugin activation changes\r\n   * @param listener - Callback function\r\n   * @returns Unsubscribe function\r\n   */\r\n  onChange(listener: (pluginName: string | null, prevPluginName: string | null) => void): () => void {\r\n    this.listeners.add(listener);\r\n    return () => {\r\n      this.listeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of plugin changes\r\n   */\r\n  private notifyListeners(pluginName: string | null, prevPluginName: string | null): void {\r\n    for (const listener of this.listeners) {\r\n      try {\r\n        listener(pluginName, prevPluginName);\r\n      } catch (error) {\r\n        console.error('Error in plugin change listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy all plugins and clean up resources\r\n   */\r\n  destroy(): void {\r\n    // Deactivate active plugin\r\n    if (this.activePluginName) {\r\n      this.deactivate(this.activePluginName);\r\n    }\r\n\r\n    // Destroy all plugins\r\n    for (const plugin of this.plugins.values()) {\r\n      plugin.destroy();\r\n    }\r\n\r\n    this.plugins.clear();\r\n    this.listeners.clear();\r\n    this.context = null;\r\n  }\r\n}\r\n","/**\r\n * KeyboardManager - Handles keyboard shortcuts\r\n */\r\n\r\nexport interface ShortcutConfig {\r\n  /** Key code or key name */\r\n  key: string;\r\n  /** Ctrl/Command key required */\r\n  ctrl?: boolean;\r\n  /** Shift key required */\r\n  shift?: boolean;\r\n  /** Alt key required */\r\n  alt?: boolean;\r\n  /** Callback function */\r\n  handler: (e: KeyboardEvent) => void;\r\n  /** Description for UI display */\r\n  description?: string;\r\n  /** Whether to prevent default browser behavior */\r\n  preventDefault?: boolean;\r\n  /** Whether shortcut is enabled */\r\n  enabled?: boolean;\r\n}\r\n\r\nexport interface ShortcutGroup {\r\n  name: string;\r\n  shortcuts: Map<string, ShortcutConfig>;\r\n}\r\n\r\n/**\r\n * Generate a unique key for a shortcut combination\r\n */\r\nfunction getShortcutKey(config: Omit<ShortcutConfig, 'handler' | 'description'>): string {\r\n  const parts: string[] = [];\r\n  if (config.ctrl) parts.push('ctrl');\r\n  if (config.alt) parts.push('alt');\r\n  if (config.shift) parts.push('shift');\r\n  parts.push(config.key.toLowerCase());\r\n  return parts.join('+');\r\n}\r\n\r\n/**\r\n * KeyboardManager - Manages keyboard shortcuts registration and handling\r\n */\r\nexport class KeyboardManager {\r\n  private shortcuts: Map<string, ShortcutConfig> = new Map();\r\n  private groups: Map<string, ShortcutGroup> = new Map();\r\n  private enabled: boolean = true;\r\n  private target: HTMLElement | Document;\r\n  private boundHandler: (e: KeyboardEvent) => void;\r\n\r\n  constructor(target: HTMLElement | Document = document) {\r\n    this.target = target;\r\n    this.boundHandler = this.handleKeyDown.bind(this);\r\n    this.attach();\r\n  }\r\n\r\n  /**\r\n   * Attach keyboard event listener\r\n   */\r\n  attach(): void {\r\n    this.target.addEventListener('keydown', this.boundHandler as EventListener);\r\n  }\r\n\r\n  /**\r\n   * Detach keyboard event listener\r\n   */\r\n  detach(): void {\r\n    this.target.removeEventListener('keydown', this.boundHandler as EventListener);\r\n  }\r\n\r\n  /**\r\n   * Enable/disable all shortcuts\r\n   */\r\n  setEnabled(enabled: boolean): void {\r\n    this.enabled = enabled;\r\n  }\r\n\r\n  /**\r\n   * Check if keyboard manager is enabled\r\n   */\r\n  isEnabled(): boolean {\r\n    return this.enabled;\r\n  }\r\n\r\n  /**\r\n   * Register a keyboard shortcut\r\n   * @param config - Shortcut configuration\r\n   * @param group - Optional group name\r\n   * @returns Unregister function\r\n   */\r\n  register(config: ShortcutConfig, group?: string): () => void {\r\n    const key = getShortcutKey(config);\r\n    \r\n    // Check for conflicts\r\n    if (this.shortcuts.has(key)) {\r\n      console.warn(`Keyboard shortcut \"${key}\" is already registered. Overwriting.`);\r\n    }\r\n\r\n    const fullConfig: ShortcutConfig = {\r\n      ...config,\r\n      enabled: config.enabled !== false,\r\n      preventDefault: config.preventDefault !== false,\r\n    };\r\n\r\n    this.shortcuts.set(key, fullConfig);\r\n\r\n    // Add to group if specified\r\n    if (group) {\r\n      if (!this.groups.has(group)) {\r\n        this.groups.set(group, { name: group, shortcuts: new Map() });\r\n      }\r\n      this.groups.get(group)!.shortcuts.set(key, fullConfig);\r\n    }\r\n\r\n    // Return unregister function\r\n    return () => this.unregister(key);\r\n  }\r\n\r\n  /**\r\n   * Register multiple shortcuts at once\r\n   * @param configs - Array of shortcut configs\r\n   * @param group - Optional group name\r\n   */\r\n  registerMultiple(configs: ShortcutConfig[], group?: string): () => void {\r\n    const unregisters = configs.map(config => this.register(config, group));\r\n    return () => unregisters.forEach(fn => fn());\r\n  }\r\n\r\n  /**\r\n   * Unregister a shortcut\r\n   * @param key - Shortcut key string\r\n   */\r\n  unregister(key: string): void {\r\n    this.shortcuts.delete(key);\r\n    // Remove from all groups\r\n    this.groups.forEach(group => {\r\n      group.shortcuts.delete(key);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unregister all shortcuts in a group\r\n   * @param groupName - Group name\r\n   */\r\n  unregisterGroup(groupName: string): void {\r\n    const group = this.groups.get(groupName);\r\n    if (group) {\r\n      group.shortcuts.forEach((_, key) => {\r\n        this.shortcuts.delete(key);\r\n      });\r\n      this.groups.delete(groupName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enable/disable a specific shortcut\r\n   * @param key - Shortcut key string\r\n   * @param enabled - Enable state\r\n   */\r\n  setShortcutEnabled(key: string, enabled: boolean): void {\r\n    const shortcut = this.shortcuts.get(key);\r\n    if (shortcut) {\r\n      shortcut.enabled = enabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all registered shortcuts\r\n   */\r\n  getShortcuts(): Map<string, ShortcutConfig> {\r\n    return new Map(this.shortcuts);\r\n  }\r\n\r\n  /**\r\n   * Get shortcuts for a specific group\r\n   */\r\n  getGroupShortcuts(groupName: string): Map<string, ShortcutConfig> | undefined {\r\n    return this.groups.get(groupName)?.shortcuts;\r\n  }\r\n\r\n  /**\r\n   * Handle keydown event\r\n   */\r\n  private handleKeyDown(e: KeyboardEvent): void {\r\n    if (!this.enabled) return;\r\n\r\n    // Skip if in input/textarea/contenteditable\r\n    const target = e.target as HTMLElement;\r\n    if (\r\n      target.tagName === 'INPUT' ||\r\n      target.tagName === 'TEXTAREA' ||\r\n      target.isContentEditable\r\n    ) {\r\n      // Allow Escape to work even in inputs\r\n      if (e.key !== 'Escape') {\r\n        return;\r\n      }\r\n    }\r\n\r\n    const key = getShortcutKey({\r\n      key: e.key,\r\n      ctrl: e.ctrlKey || e.metaKey, // Support both Ctrl and Cmd (Mac)\r\n      shift: e.shiftKey,\r\n      alt: e.altKey,\r\n    });\r\n\r\n    const shortcut = this.shortcuts.get(key);\r\n    \r\n    if (shortcut && shortcut.enabled !== false) {\r\n      if (shortcut.preventDefault !== false) {\r\n        e.preventDefault();\r\n      }\r\n      shortcut.handler(e);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Format shortcut for display (e.g., \"Ctrl+Z\")\r\n   */\r\n  static formatShortcut(config: Partial<ShortcutConfig>): string {\r\n    const parts: string[] = [];\r\n    const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);\r\n    \r\n    if (config.ctrl) parts.push(isMac ? '⌘' : 'Ctrl');\r\n    if (config.alt) parts.push(isMac ? '⌥' : 'Alt');\r\n    if (config.shift) parts.push(isMac ? '⇧' : 'Shift');\r\n    \r\n    if (config.key) {\r\n      // Format special keys\r\n      const keyMap: Record<string, string> = {\r\n        ' ': 'Space',\r\n        'ArrowUp': '↑',\r\n        'ArrowDown': '↓',\r\n        'ArrowLeft': '←',\r\n        'ArrowRight': '→',\r\n        'Escape': 'Esc',\r\n        'Delete': 'Del',\r\n        'Backspace': '⌫',\r\n      };\r\n      parts.push(keyMap[config.key] || config.key.toUpperCase());\r\n    }\r\n    \r\n    return parts.join('+');\r\n  }\r\n\r\n  /**\r\n   * Destroy the keyboard manager\r\n   */\r\n  destroy(): void {\r\n    this.detach();\r\n    this.shortcuts.clear();\r\n    this.groups.clear();\r\n  }\r\n}\r\n\r\n/**\r\n * Default editor shortcuts configuration\r\n */\r\nexport function createEditorShortcuts(handlers: {\r\n  undo?: () => void;\r\n  redo?: () => void;\r\n  copy?: () => void;\r\n  paste?: () => void;\r\n  delete?: () => void;\r\n  escape?: () => void;\r\n  zoomIn?: () => void;\r\n  zoomOut?: () => void;\r\n  zoomReset?: () => void;\r\n  selectTool?: (tool: string | null) => void;\r\n  save?: () => void;\r\n}): ShortcutConfig[] {\r\n  const shortcuts: ShortcutConfig[] = [];\r\n\r\n  if (handlers.undo) {\r\n    shortcuts.push({\r\n      key: 'z',\r\n      ctrl: true,\r\n      handler: handlers.undo,\r\n      description: 'Undo',\r\n    });\r\n  }\r\n\r\n  if (handlers.redo) {\r\n    shortcuts.push({\r\n      key: 'y',\r\n      ctrl: true,\r\n      handler: handlers.redo,\r\n      description: 'Redo',\r\n    });\r\n    // Also support Ctrl+Shift+Z\r\n    shortcuts.push({\r\n      key: 'z',\r\n      ctrl: true,\r\n      shift: true,\r\n      handler: handlers.redo,\r\n      description: 'Redo',\r\n    });\r\n  }\r\n\r\n  if (handlers.copy) {\r\n    shortcuts.push({\r\n      key: 'c',\r\n      ctrl: true,\r\n      handler: handlers.copy,\r\n      description: 'Copy',\r\n    });\r\n  }\r\n\r\n  if (handlers.paste) {\r\n    shortcuts.push({\r\n      key: 'v',\r\n      ctrl: true,\r\n      handler: handlers.paste,\r\n      description: 'Paste',\r\n    });\r\n  }\r\n\r\n  if (handlers.delete) {\r\n    shortcuts.push({\r\n      key: 'Delete',\r\n      handler: handlers.delete,\r\n      description: 'Delete',\r\n    });\r\n    shortcuts.push({\r\n      key: 'Backspace',\r\n      handler: handlers.delete,\r\n      description: 'Delete',\r\n    });\r\n  }\r\n\r\n  if (handlers.escape) {\r\n    shortcuts.push({\r\n      key: 'Escape',\r\n      handler: handlers.escape,\r\n      description: 'Cancel / Deselect',\r\n    });\r\n  }\r\n\r\n  if (handlers.zoomIn) {\r\n    shortcuts.push({\r\n      key: '=',\r\n      ctrl: true,\r\n      handler: handlers.zoomIn,\r\n      description: 'Zoom In',\r\n    });\r\n    shortcuts.push({\r\n      key: '+',\r\n      ctrl: true,\r\n      handler: handlers.zoomIn,\r\n      description: 'Zoom In',\r\n    });\r\n  }\r\n\r\n  if (handlers.zoomOut) {\r\n    shortcuts.push({\r\n      key: '-',\r\n      ctrl: true,\r\n      handler: handlers.zoomOut,\r\n      description: 'Zoom Out',\r\n    });\r\n  }\r\n\r\n  if (handlers.zoomReset) {\r\n    shortcuts.push({\r\n      key: '0',\r\n      ctrl: true,\r\n      handler: handlers.zoomReset,\r\n      description: 'Reset Zoom',\r\n    });\r\n  }\r\n\r\n  if (handlers.selectTool) {\r\n    // Number keys 1-9 for tool selection\r\n    const tools = [null, 'pen', 'rect', 'circle', 'arrow', 'text', 'mosaic', 'eraser', 'crop'];\r\n    tools.forEach((tool, index) => {\r\n      if (index < 10) {\r\n        shortcuts.push({\r\n          key: String(index),\r\n          handler: () => handlers.selectTool!(tool),\r\n          description: `Select ${tool || 'Move'} tool`,\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  if (handlers.save) {\r\n    shortcuts.push({\r\n      key: 's',\r\n      ctrl: true,\r\n      handler: handlers.save,\r\n      description: 'Save / Export',\r\n    });\r\n  }\r\n\r\n  return shortcuts;\r\n}\r\n","/**\r\n * Canvas class - Manages canvas creation, sizing, and image data\r\n * Requirements: 1.1, 8.2\r\n */\r\n\r\nimport {\r\n  createCanvas,\r\n  getContext2D,\r\n  setCanvasSize,\r\n  clearCanvas,\r\n  fillCanvas,\r\n  setStyles,\r\n  removeElement,\r\n} from '../utils/dom.utils';\r\nimport {\r\n  loadImage,\r\n  getImageDimensions,\r\n  calculateAspectRatioFit,\r\n  drawImageToCanvas,\r\n  getImageData,\r\n  putImageData,\r\n  cloneImageData,\r\n} from '../utils/image.utils';\r\nimport type { EditorConfig } from '../types/config.types';\r\n\r\n/**\r\n * Canvas resize event data\r\n */\r\nexport interface CanvasResizeData {\r\n  width: number;\r\n  height: number;\r\n  previousWidth: number;\r\n  previousHeight: number;\r\n}\r\n\r\n/**\r\n * Canvas class - Handles canvas creation and management\r\n * Requirements: 1.1, 8.2\r\n */\r\nexport class Canvas {\r\n  /** Canvas element */\r\n  private _canvas: HTMLCanvasElement;\r\n  /** Canvas 2D context */\r\n  private _ctx: CanvasRenderingContext2D;\r\n  /** Container element */\r\n  private _container: HTMLElement;\r\n  /** Original image element */\r\n  private _originalImage: HTMLImageElement | null = null;\r\n  /** Original image data (for reset) */\r\n  private _originalImageData: ImageData | null = null;\r\n  /** Whether responsive mode is enabled */\r\n  private _responsive: boolean;\r\n  /** Background color */\r\n  private _backgroundColor: string;\r\n  /** Resize observer for responsive mode */\r\n  private _resizeObserver: ResizeObserver | null = null;\r\n  /** Resize listeners */\r\n  private _resizeListeners: Set<(data: CanvasResizeData) => void> = new Set();\r\n  /** Whether the canvas is destroyed */\r\n  private _destroyed: boolean = false;\r\n\r\n\r\n  /**\r\n   * Create a new Canvas instance\r\n   * @param container - Container element\r\n   * @param config - Editor configuration\r\n   */\r\n  constructor(container: HTMLElement, config: Required<EditorConfig>) {\r\n    this._container = container;\r\n    this._responsive = config.responsive;\r\n    this._backgroundColor = config.backgroundColor;\r\n\r\n    // Create canvas element\r\n    this._canvas = createCanvas(config.width, config.height);\r\n    this._ctx = getContext2D(this._canvas);\r\n\r\n    // Style the canvas\r\n    setStyles(this._canvas, {\r\n      display: 'block',\r\n      maxWidth: '100%',\r\n      maxHeight: '100%',\r\n    });\r\n\r\n    // Append to container\r\n    this._container.appendChild(this._canvas);\r\n\r\n    // Fill with background color\r\n    this.fillBackground();\r\n\r\n    // Setup responsive behavior if enabled\r\n    if (this._responsive) {\r\n      this.setupResponsive();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the canvas element\r\n   */\r\n  get canvas(): HTMLCanvasElement {\r\n    return this._canvas;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas 2D context\r\n   */\r\n  get ctx(): CanvasRenderingContext2D {\r\n    return this._ctx;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas width\r\n   */\r\n  get width(): number {\r\n    return this._canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas height\r\n   */\r\n  get height(): number {\r\n    return this._canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Get the container element\r\n   */\r\n  get container(): HTMLElement {\r\n    return this._container;\r\n  }\r\n\r\n  /**\r\n   * Get the original image\r\n   */\r\n  get originalImage(): HTMLImageElement | null {\r\n    return this._originalImage;\r\n  }\r\n\r\n  /**\r\n   * Check if canvas is destroyed\r\n   */\r\n  get isDestroyed(): boolean {\r\n    return this._destroyed;\r\n  }\r\n\r\n\r\n  /**\r\n   * Fill canvas with background color\r\n   */\r\n  private fillBackground(): void {\r\n    if (this._backgroundColor === 'transparent') {\r\n      clearCanvas(this._ctx, this.width, this.height);\r\n    } else {\r\n      fillCanvas(this._ctx, this.width, this.height, this._backgroundColor);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setup responsive behavior\r\n   * Requirements: 8.2 - Auto-adjust canvas size on container resize\r\n   */\r\n  private setupResponsive(): void {\r\n    if (typeof ResizeObserver === 'undefined') {\r\n      // Fallback to window resize event\r\n      window.addEventListener('resize', this.handleResize);\r\n      return;\r\n    }\r\n\r\n    this._resizeObserver = new ResizeObserver((entries) => {\r\n      for (const entry of entries) {\r\n        if (entry.target === this._container) {\r\n          this.handleContainerResize();\r\n        }\r\n      }\r\n    });\r\n\r\n    this._resizeObserver.observe(this._container);\r\n  }\r\n\r\n  /**\r\n   * Handle window resize (fallback)\r\n   */\r\n  private handleResize = (): void => {\r\n    this.handleContainerResize();\r\n  };\r\n\r\n  /**\r\n   * Handle container resize\r\n   * Requirements: 8.2 - Maintain aspect ratio on resize\r\n   */\r\n  private handleContainerResize(): void {\r\n    if (this._destroyed || !this._originalImage) {\r\n      return;\r\n    }\r\n\r\n    const containerRect = this._container.getBoundingClientRect();\r\n    const containerWidth = containerRect.width;\r\n    const containerHeight = containerRect.height;\r\n\r\n    if (containerWidth === 0 || containerHeight === 0) {\r\n      return;\r\n    }\r\n\r\n    const { width: imgWidth, height: imgHeight } = getImageDimensions(this._originalImage);\r\n    const previousWidth = this.width;\r\n    const previousHeight = this.height;\r\n\r\n    // Calculate new dimensions maintaining aspect ratio\r\n    const { width: newWidth, height: newHeight } = calculateAspectRatioFit(\r\n      imgWidth,\r\n      imgHeight,\r\n      containerWidth,\r\n      containerHeight\r\n    );\r\n\r\n    // Only resize if dimensions changed\r\n    if (newWidth !== previousWidth || newHeight !== previousHeight) {\r\n      this.resize(newWidth, newHeight, true);\r\n\r\n      // Notify listeners\r\n      this.notifyResizeListeners({\r\n        width: newWidth,\r\n        height: newHeight,\r\n        previousWidth,\r\n        previousHeight,\r\n      });\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Load an image onto the canvas\r\n   * Requirements: 1.1 - Load image into canvas\r\n   * @param source - Image source (URL or HTMLImageElement)\r\n   * @returns Promise with image dimensions\r\n   */\r\n  async loadImage(source: string | HTMLImageElement): Promise<{ width: number; height: number }> {\r\n    const image = await loadImage(source);\r\n    this._originalImage = image;\r\n\r\n    const { width: imgWidth, height: imgHeight } = getImageDimensions(image);\r\n\r\n    // Calculate dimensions based on container if responsive\r\n    let targetWidth = imgWidth;\r\n    let targetHeight = imgHeight;\r\n\r\n    if (this._responsive) {\r\n      const containerRect = this._container.getBoundingClientRect();\r\n      const containerWidth = containerRect.width || imgWidth;\r\n      const containerHeight = containerRect.height || imgHeight;\r\n\r\n      const scaled = calculateAspectRatioFit(\r\n        imgWidth,\r\n        imgHeight,\r\n        containerWidth,\r\n        containerHeight\r\n      );\r\n      targetWidth = scaled.width;\r\n      targetHeight = scaled.height;\r\n    }\r\n\r\n    // Resize canvas to fit image\r\n    this.resize(targetWidth, targetHeight, false);\r\n\r\n    // Draw image\r\n    drawImageToCanvas(this._ctx, image, 0, 0, targetWidth, targetHeight);\r\n\r\n    // Store original image data\r\n    this._originalImageData = this.getImageData();\r\n\r\n    return { width: targetWidth, height: targetHeight };\r\n  }\r\n\r\n  /**\r\n   * Resize the canvas\r\n   * @param width - New width\r\n   * @param height - New height\r\n   * @param preserveContent - Whether to preserve current content\r\n   */\r\n  resize(width: number, height: number, preserveContent: boolean = false): void {\r\n    // Resize canvas\r\n    setCanvasSize(this._canvas, width, height);\r\n\r\n    // Fill background\r\n    this.fillBackground();\r\n\r\n    // Restore content\r\n    if (preserveContent && this._originalImage) {\r\n      // Redraw original image at new size\r\n      drawImageToCanvas(this._ctx, this._originalImage, 0, 0, width, height);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get image data from canvas\r\n   * @param x - Start X coordinate\r\n   * @param y - Start Y coordinate\r\n   * @param width - Width (defaults to canvas width)\r\n   * @param height - Height (defaults to canvas height)\r\n   * @returns ImageData\r\n   */\r\n  getImageData(x: number = 0, y: number = 0, width?: number, height?: number): ImageData {\r\n    return getImageData(this._ctx, x, y, width ?? this.width, height ?? this.height);\r\n  }\r\n\r\n  /**\r\n   * Put image data to canvas\r\n   * @param imageData - ImageData to put\r\n   * @param x - X coordinate\r\n   * @param y - Y coordinate\r\n   */\r\n  putImageData(imageData: ImageData, x: number = 0, y: number = 0): void {\r\n    putImageData(this._ctx, imageData, x, y);\r\n  }\r\n\r\n  /**\r\n   * Get original image data (for reset)\r\n   * @returns Original ImageData or null\r\n   */\r\n  getOriginalImageData(): ImageData | null {\r\n    return this._originalImageData ? cloneImageData(this._originalImageData) : null;\r\n  }\r\n\r\n\r\n  /**\r\n   * Clear the canvas\r\n   */\r\n  clear(): void {\r\n    clearCanvas(this._ctx, this.width, this.height);\r\n    this.fillBackground();\r\n  }\r\n\r\n  /**\r\n   * Reset canvas to original image\r\n   */\r\n  reset(): void {\r\n    if (this._originalImageData) {\r\n      this.clear();\r\n      this.putImageData(this._originalImageData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set background color\r\n   * @param color - Background color\r\n   */\r\n  setBackgroundColor(color: string): void {\r\n    this._backgroundColor = color;\r\n  }\r\n\r\n  /**\r\n   * Subscribe to resize events\r\n   * @param listener - Resize listener\r\n   * @returns Unsubscribe function\r\n   */\r\n  onResize(listener: (data: CanvasResizeData) => void): () => void {\r\n    this._resizeListeners.add(listener);\r\n    return () => {\r\n      this._resizeListeners.delete(listener);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Notify resize listeners\r\n   */\r\n  private notifyResizeListeners(data: CanvasResizeData): void {\r\n    for (const listener of this._resizeListeners) {\r\n      try {\r\n        listener(data);\r\n      } catch (error) {\r\n        console.error('Error in resize listener:', error);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy the canvas and clean up resources\r\n   * Requirements: 1.5 - Clean up canvas resources\r\n   */\r\n  destroy(): void {\r\n    if (this._destroyed) {\r\n      return;\r\n    }\r\n\r\n    this._destroyed = true;\r\n\r\n    // Remove resize observer\r\n    if (this._resizeObserver) {\r\n      this._resizeObserver.disconnect();\r\n      this._resizeObserver = null;\r\n    }\r\n\r\n    // Remove window resize listener\r\n    window.removeEventListener('resize', this.handleResize);\r\n\r\n    // Clear listeners\r\n    this._resizeListeners.clear();\r\n\r\n    // Remove canvas from DOM\r\n    removeElement(this._canvas);\r\n\r\n    // Clear references\r\n    this._originalImage = null;\r\n    this._originalImageData = null;\r\n  }\r\n}\r\n","/**\r\n * SVG Icons - Lucide-style icons for the toolbar\r\n */\r\n\r\nconst createSvg = (paths: string, size = 20): string => `\r\n<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${size}\" height=\"${size}\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n  ${paths}\r\n</svg>`.trim();\r\n\r\nexport const icons = {\r\n  // Move/Hand\r\n  move: createSvg(`\r\n    <path d=\"M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2\"/>\r\n    <path d=\"M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2\"/>\r\n    <path d=\"M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8\"/>\r\n    <path d=\"M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15\"/>\r\n  `),\r\n\r\n  // Brush/Pencil\r\n  brush: createSvg(`\r\n    <path d=\"m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08\"/>\r\n    <path d=\"M7.07 14.94c-1.66 0-3 1.35-3 3.02 0 1.33-2.5 1.52-2 2.02 1.08 1.1 2.49 2.02 4 2.02 2.2 0 4-1.8 4-4.04a3.01 3.01 0 0 0-3-3.02z\"/>\r\n  `),\r\n\r\n  // Text/Type\r\n  type: createSvg(`\r\n    <polyline points=\"4 7 4 4 20 4 20 7\"/>\r\n    <line x1=\"9\" y1=\"20\" x2=\"15\" y2=\"20\"/>\r\n    <line x1=\"12\" y1=\"4\" x2=\"12\" y2=\"20\"/>\r\n  `),\r\n\r\n  // Zoom In\r\n  zoomIn: createSvg(`\r\n    <circle cx=\"11\" cy=\"11\" r=\"8\"/>\r\n    <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\r\n    <line x1=\"11\" y1=\"8\" x2=\"11\" y2=\"14\"/>\r\n    <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\r\n  `),\r\n\r\n  // Zoom Out\r\n  zoomOut: createSvg(`\r\n    <circle cx=\"11\" cy=\"11\" r=\"8\"/>\r\n    <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/>\r\n    <line x1=\"8\" y1=\"11\" x2=\"14\" y2=\"11\"/>\r\n  `),\r\n\r\n  // Undo\r\n  undo: createSvg(`\r\n    <path d=\"M3 7v6h6\"/>\r\n    <path d=\"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13\"/>\r\n  `),\r\n\r\n  // Redo\r\n  redo: createSvg(`\r\n    <path d=\"M21 7v6h-6\"/>\r\n    <path d=\"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7\"/>\r\n  `),\r\n\r\n  // Download\r\n  download: createSvg(`\r\n    <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/>\r\n    <polyline points=\"7 10 12 15 17 10\"/>\r\n    <line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"/>\r\n  `),\r\n\r\n  // Reset/RotateCcw\r\n  reset: createSvg(`\r\n    <path d=\"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8\"/>\r\n    <path d=\"M3 3v5h5\"/>\r\n  `),\r\n\r\n  // Plus\r\n  plus: createSvg(`\r\n    <line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/>\r\n    <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Minus\r\n  minus: createSvg(`\r\n    <line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Check\r\n  check: createSvg(`\r\n    <polyline points=\"20 6 9 17 4 12\"/>\r\n  `),\r\n\r\n  // X/Close\r\n  close: createSvg(`\r\n    <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"/>\r\n    <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"/>\r\n  `),\r\n\r\n  // Upload\r\n  upload: createSvg(`\r\n    <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/>\r\n    <polyline points=\"17 8 12 3 7 8\"/>\r\n    <line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/>\r\n  `),\r\n\r\n  // Settings/Sliders\r\n  settings: createSvg(`\r\n    <line x1=\"4\" y1=\"21\" x2=\"4\" y2=\"14\"/>\r\n    <line x1=\"4\" y1=\"10\" x2=\"4\" y2=\"3\"/>\r\n    <line x1=\"12\" y1=\"21\" x2=\"12\" y2=\"12\"/>\r\n    <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"3\"/>\r\n    <line x1=\"20\" y1=\"21\" x2=\"20\" y2=\"16\"/>\r\n    <line x1=\"20\" y1=\"12\" x2=\"20\" y2=\"3\"/>\r\n    <line x1=\"1\" y1=\"14\" x2=\"7\" y2=\"14\"/>\r\n    <line x1=\"9\" y1=\"8\" x2=\"15\" y2=\"8\"/>\r\n    <line x1=\"17\" y1=\"16\" x2=\"23\" y2=\"16\"/>\r\n  `),\r\n\r\n  // Pen/Pencil (free draw)\r\n  pen: createSvg(`\r\n    <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\"/>\r\n    <path d=\"m15 5 4 4\"/>\r\n  `),\r\n\r\n  // Rectangle/Square\r\n  rect: createSvg(`\r\n    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/>\r\n  `),\r\n\r\n  // Circle\r\n  circle: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n  `),\r\n\r\n  // Arrow\r\n  arrow: createSvg(`\r\n    <path d=\"M5 12h14\"/>\r\n    <path d=\"m12 5 7 7-7 7\"/>\r\n  `),\r\n\r\n  // Mosaic/Blur\r\n  mosaic: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"3\"/>\r\n    <circle cx=\"12\" cy=\"12\" r=\"6\" opacity=\"0.6\"/>\r\n    <circle cx=\"12\" cy=\"12\" r=\"9\" opacity=\"0.3\"/>\r\n  `),\r\n\r\n  // Crop\r\n  crop: createSvg(`\r\n    <path d=\"M6 2v14a2 2 0 0 0 2 2h14\"/>\r\n    <path d=\"M18 22V8a2 2 0 0 0-2-2H2\"/>\r\n  `),\r\n\r\n  // Filter/Adjustments\r\n  filter: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n    <path d=\"M12 2a10 10 0 0 0 0 20\"/>\r\n    <path d=\"M12 2a10 10 0 0 1 0 20\"/>\r\n    <line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Eraser\r\n  eraser: createSvg(`\r\n    <path d=\"m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21\"/>\r\n    <path d=\"M22 21H7\"/>\r\n    <path d=\"m5 11 9 9\"/>\r\n  `),\r\n\r\n  // Line\r\n  line: createSvg(`\r\n    <path d=\"M4 20L20 4\"/>\r\n  `),\r\n\r\n  // Triangle\r\n  triangle: createSvg(`\r\n    <path d=\"M12 3L22 21H2L12 3Z\"/>\r\n  `),\r\n\r\n  // Rotate Left\r\n  rotateLeft: createSvg(`\r\n    <path d=\"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8\"/>\r\n    <path d=\"M3 3v5h5\"/>\r\n  `),\r\n\r\n  // Rotate Right\r\n  rotateRight: createSvg(`\r\n    <path d=\"M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"/>\r\n    <path d=\"M21 3v5h-5\"/>\r\n  `),\r\n\r\n  // Flip Horizontal\r\n  flipH: createSvg(`\r\n    <path d=\"M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3\"/>\r\n    <path d=\"M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3\"/>\r\n    <line x1=\"12\" y1=\"2\" x2=\"12\" y2=\"22\"/>\r\n  `),\r\n\r\n  // Flip Vertical\r\n  flipV: createSvg(`\r\n    <path d=\"M3 8V5a2 2 0 0 1 2-2h14c1.1 0 2 .9 2 2v3\"/>\r\n    <path d=\"M3 16v3a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-3\"/>\r\n    <line x1=\"2\" y1=\"12\" x2=\"22\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Ruler\r\n  ruler: createSvg(`\r\n    <path d=\"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z\"/>\r\n    <path d=\"m14.5 12.5 2-2\"/>\r\n    <path d=\"m11.5 9.5 2-2\"/>\r\n    <path d=\"m8.5 6.5 2-2\"/>\r\n    <path d=\"m17.5 15.5 2-2\"/>\r\n  `),\r\n\r\n  // Grid\r\n  grid: createSvg(`\r\n    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/>\r\n    <line x1=\"3\" y1=\"9\" x2=\"21\" y2=\"9\"/>\r\n    <line x1=\"3\" y1=\"15\" x2=\"21\" y2=\"15\"/>\r\n    <line x1=\"9\" y1=\"3\" x2=\"9\" y2=\"21\"/>\r\n    <line x1=\"15\" y1=\"3\" x2=\"15\" y2=\"21\"/>\r\n  `),\r\n\r\n  // Sun (for brightness)\r\n  sun: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"4\"/>\r\n    <path d=\"M12 2v2\"/>\r\n    <path d=\"M12 20v2\"/>\r\n    <path d=\"m4.93 4.93 1.41 1.41\"/>\r\n    <path d=\"m17.66 17.66 1.41 1.41\"/>\r\n    <path d=\"M2 12h2\"/>\r\n    <path d=\"M20 12h2\"/>\r\n    <path d=\"m6.34 17.66-1.41 1.41\"/>\r\n    <path d=\"m19.07 4.93-1.41 1.41\"/>\r\n  `),\r\n\r\n  // Contrast\r\n  contrast: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\r\n    <path d=\"M12 2a10 10 0 0 1 0 20z\"/>\r\n  `),\r\n\r\n  // Image (for presets)\r\n  image: createSvg(`\r\n    <rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/>\r\n    <circle cx=\"9\" cy=\"9\" r=\"2\"/>\r\n    <path d=\"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\"/>\r\n  `),\r\n\r\n  // Layers\r\n  layers: createSvg(`\r\n    <polygon points=\"12 2 2 7 12 12 22 7 12 2\"/>\r\n    <polyline points=\"2 17 12 22 22 17\"/>\r\n    <polyline points=\"2 12 12 17 22 12\"/>\r\n  `),\r\n\r\n  // Bold\r\n  bold: createSvg(`\r\n    <path d=\"M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z\"/>\r\n    <path d=\"M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z\"/>\r\n  `),\r\n\r\n  // Italic\r\n  italic: createSvg(`\r\n    <line x1=\"19\" y1=\"4\" x2=\"10\" y2=\"4\"/>\r\n    <line x1=\"14\" y1=\"20\" x2=\"5\" y2=\"20\"/>\r\n    <line x1=\"15\" y1=\"4\" x2=\"9\" y2=\"20\"/>\r\n  `),\r\n\r\n  // Underline\r\n  underline: createSvg(`\r\n    <path d=\"M6 4v6a6 6 0 0 0 12 0V4\"/>\r\n    <line x1=\"4\" y1=\"20\" x2=\"20\" y2=\"20\"/>\r\n  `),\r\n\r\n  // Dashed line\r\n  dashed: createSvg(`\r\n    <line x1=\"3\" y1=\"12\" x2=\"8\" y2=\"12\" stroke-dasharray=\"5,5\"/>\r\n    <line x1=\"11\" y1=\"12\" x2=\"16\" y2=\"12\" stroke-dasharray=\"5,5\"/>\r\n    <line x1=\"19\" y1=\"12\" x2=\"21\" y2=\"12\"/>\r\n  `),\r\n\r\n  // Fill\r\n  fill: createSvg(`\r\n    <path d=\"m19 11-8-8-8.6 8.6a2 2 0 0 0 0 2.8l5.2 5.2c.8.8 2 .8 2.8 0L19 11Z\"/>\r\n    <path d=\"m5 2 5 5\"/>\r\n    <path d=\"M2 13h15\"/>\r\n    <path d=\"M22 20a2 2 0 1 1-4 0c0-1.6 1.7-2.4 2-4 .3 1.6 2 2.4 2 4Z\"/>\r\n  `),\r\n\r\n  // Copy\r\n  copy: createSvg(`\r\n    <rect width=\"14\" height=\"14\" x=\"8\" y=\"8\" rx=\"2\" ry=\"2\"/>\r\n    <path d=\"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2\"/>\r\n  `),\r\n\r\n  // Clipboard/Paste\r\n  paste: createSvg(`\r\n    <rect width=\"8\" height=\"4\" x=\"8\" y=\"2\" rx=\"1\" ry=\"1\"/>\r\n    <path d=\"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2\"/>\r\n  `),\r\n\r\n  // Trash/Delete\r\n  trash: createSvg(`\r\n    <path d=\"M3 6h18\"/>\r\n    <path d=\"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6\"/>\r\n    <path d=\"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\r\n  `),\r\n\r\n  // Watermark\r\n  watermark: createSvg(`\r\n    <path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10\"/>\r\n    <path d=\"m9 12 2 2 4-4\"/>\r\n  `),\r\n\r\n  // More/Menu\r\n  more: createSvg(`\r\n    <circle cx=\"12\" cy=\"12\" r=\"1\"/>\r\n    <circle cx=\"19\" cy=\"12\" r=\"1\"/>\r\n    <circle cx=\"5\" cy=\"12\" r=\"1\"/>\r\n  `),\r\n};\r\n\r\nexport type IconName = keyof typeof icons;\r\n","/**\r\n * Toolbar CSS styles\r\n */\r\n\r\nexport const toolbarStyles = `\r\n/* Default (Dark theme) variables */\r\n.ie-editor-wrapper {\r\n  --ie-bg: #1e1e1e;\r\n  --ie-canvas-bg: #1a1a1a;\r\n  --ie-toolbar-bg: #2d2d2d;\r\n  --ie-toolbar-border: rgba(255,255,255,0.1);\r\n  --ie-btn-color: rgba(255,255,255,0.7);\r\n  --ie-btn-hover-bg: rgba(255,255,255,0.1);\r\n  --ie-btn-hover-color: #fff;\r\n  --ie-btn-active-bg: #667eea;\r\n  --ie-btn-active-color: #fff;\r\n  --ie-text-color: #fff;\r\n  --ie-text-muted: rgba(255,255,255,0.5);\r\n  --ie-divider: rgba(255,255,255,0.1);\r\n  --ie-panel-bg: #333;\r\n  --ie-input-bg: #222;\r\n  --ie-input-border: #444;\r\n  --ie-shadow: rgba(0,0,0,0.4);\r\n  --ie-radius: 8px;\r\n  --ie-transition: 0.15s ease;\r\n  \r\n  position: relative;\r\n  display: flex;\r\n  flex-direction: column;\r\n  width: 100%;\r\n  height: 100%;\r\n  background: var(--ie-bg);\r\n  color: var(--ie-text-color);\r\n  user-select: none;\r\n  box-sizing: border-box;\r\n  overflow: visible;\r\n}\r\n\r\n/* Light theme */\r\n.ie-editor-wrapper.ie-theme-light {\r\n  --ie-bg: #f5f5f5;\r\n  --ie-canvas-bg: #f5f5f5;\r\n  --ie-toolbar-bg: #ffffff;\r\n  --ie-toolbar-border: rgba(0,0,0,0.1);\r\n  --ie-btn-color: rgba(0,0,0,0.7);\r\n  --ie-btn-hover-bg: rgba(0,0,0,0.08);\r\n  --ie-btn-hover-color: #000;\r\n  --ie-btn-active-bg: #667eea;\r\n  --ie-btn-active-color: #fff;\r\n  --ie-text-color: #333;\r\n  --ie-text-muted: rgba(0,0,0,0.5);\r\n  --ie-divider: rgba(0,0,0,0.1);\r\n  --ie-panel-bg: #ffffff;\r\n  --ie-input-bg: #f0f0f0;\r\n  --ie-input-border: #ddd;\r\n  --ie-shadow: rgba(0,0,0,0.15);\r\n}\r\n\r\n.ie-canvas-container {\r\n  position: relative;\r\n  flex: 1;\r\n  width: 100%;\r\n  min-height: 0;\r\n  overflow: hidden;\r\n  background: var(--ie-canvas-bg);\r\n  cursor: grab;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n\r\n.ie-canvas-container.grabbing {\r\n  cursor: grabbing !important;\r\n}\r\n\r\n.ie-canvas-container.tool-draw {\r\n  cursor: crosshair;\r\n}\r\n\r\n.ie-canvas-container.tool-text {\r\n  cursor: text;\r\n}\r\n\r\n.ie-canvas-container.tool-move {\r\n  cursor: grab;\r\n}\r\n\r\n.ie-canvas-container.tool-move.grabbing {\r\n  cursor: grabbing;\r\n}\r\n\r\n.ie-canvas-viewport {\r\n  transform-origin: center center;\r\n  transition: none;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  will-change: transform;\r\n  backface-visibility: hidden;\r\n}\r\n\r\n.ie-canvas-viewport canvas {\r\n  display: block;\r\n  image-rendering: -webkit-optimize-contrast;\r\n  image-rendering: crisp-edges;\r\n}\r\n\r\n.ie-toolbar {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 6px;\r\n  padding: 10px 16px;\r\n  background: var(--ie-toolbar-bg);\r\n  border-top: 1px solid var(--ie-toolbar-border);\r\n  flex-shrink: 0;\r\n  transition: height 0.3s ease, padding 0.3s ease, opacity 0.3s ease, border-width 0.3s ease;\r\n  overflow: visible;\r\n}\r\n\r\n.ie-toolbar.ie-toolbar-hidden {\r\n  height: 0;\r\n  padding: 0;\r\n  border-top-width: 0;\r\n  opacity: 0;\r\n  pointer-events: none;\r\n  overflow: hidden;\r\n}\r\n\r\n.ie-toolbar-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n\r\n.ie-toolbar-divider {\r\n  width: 1px;\r\n  height: 24px;\r\n  background: var(--ie-divider);\r\n  margin: 0 6px;\r\n}\r\n\r\n.ie-btn {\r\n  position: relative;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color);\r\n  cursor: pointer;\r\n  transition: all var(--ie-transition);\r\n}\r\n\r\n.ie-btn:hover:not(:disabled) {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-btn:disabled {\r\n  opacity: 0.4;\r\n  cursor: not-allowed;\r\n}\r\n\r\n.ie-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: var(--ie-btn-active-color);\r\n}\r\n\r\n.ie-btn svg {\r\n  width: 20px;\r\n  height: 20px;\r\n}\r\n\r\n.ie-btn-export {\r\n  width: auto;\r\n  padding: 0 14px;\r\n  gap: 6px;\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n  font-size: 13px;\r\n}\r\n\r\n.ie-btn-export:hover:not(:disabled) {\r\n  background: var(--ie-btn-active-bg);\r\n  filter: brightness(0.9);\r\n}\r\n\r\n.ie-btn-export span {\r\n  font-weight: 500;\r\n}\r\n\r\n.ie-zoom-text {\r\n  min-width: 50px;\r\n  text-align: center;\r\n  font-size: 12px;\r\n  font-variant-numeric: tabular-nums;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n/* Settings Panel */\r\n.ie-panel {\r\n  position: absolute;\r\n  bottom: 100%;\r\n  left: 50%;\r\n  transform: translateX(-50%) translateY(0);\r\n  margin-bottom: 12px;\r\n  width: 240px;\r\n  padding: 16px;\r\n  background: var(--ie-panel-bg);\r\n  border: 1px solid var(--ie-toolbar-border);\r\n  border-radius: 12px;\r\n  box-shadow: 0 8px 32px var(--ie-shadow), 0 0 0 1px rgba(255,255,255,0.05) inset;\r\n  z-index: 100;\r\n  opacity: 1;\r\n  transition: opacity 0.2s ease, transform 0.2s ease;\r\n}\r\n\r\n.ie-panel.ie-panel-hidden {\r\n  opacity: 0;\r\n  transform: translateX(-50%) translateY(8px);\r\n  pointer-events: none;\r\n}\r\n\r\n.ie-panel::before {\r\n  content: '';\r\n  position: absolute;\r\n  bottom: -6px;\r\n  left: 50%;\r\n  transform: translateX(-50%) rotate(45deg);\r\n  width: 12px;\r\n  height: 12px;\r\n  background: var(--ie-panel-bg);\r\n  border-right: 1px solid var(--ie-toolbar-border);\r\n  border-bottom: 1px solid var(--ie-toolbar-border);\r\n}\r\n\r\n.ie-panel-title {\r\n  font-size: 13px;\r\n  font-weight: 600;\r\n  color: var(--ie-text-color);\r\n  margin-bottom: 14px;\r\n  padding-bottom: 10px;\r\n  border-bottom: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-panel-row {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  margin-bottom: 12px;\r\n}\r\n\r\n.ie-panel-row:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.ie-panel-label {\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n.ie-panel-value {\r\n  font-size: 12px;\r\n  font-variant-numeric: tabular-nums;\r\n  color: var(--ie-text-muted);\r\n  min-width: 36px;\r\n  text-align: center;\r\n}\r\n\r\n.ie-size-control {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  background: var(--ie-input-bg);\r\n  padding: 4px 6px;\r\n  border-radius: 8px;\r\n}\r\n\r\n.ie-size-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 28px;\r\n  height: 28px;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color);\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-size-btn:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-size-btn:active {\r\n  transform: scale(0.95);\r\n}\r\n\r\n.ie-size-btn svg {\r\n  width: 14px;\r\n  height: 14px;\r\n}\r\n\r\n.ie-slider {\r\n  flex: 1;\r\n  height: 4px;\r\n  appearance: none;\r\n  background: var(--ie-btn-hover-bg);\r\n  border-radius: 2px;\r\n  outline: none;\r\n}\r\n\r\n.ie-slider::-webkit-slider-thumb {\r\n  appearance: none;\r\n  width: 14px;\r\n  height: 14px;\r\n  background: var(--ie-btn-active-bg);\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n}\r\n\r\n/* Range slider for mosaic panel */\r\n.ie-slider-row {\r\n  flex-wrap: wrap;\r\n  gap: 10px;\r\n}\r\n\r\n.ie-slider-row .ie-panel-label {\r\n  width: 60px;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.ie-slider-row .ie-panel-value {\r\n  width: 32px;\r\n  text-align: center;\r\n  background: var(--ie-input-bg);\r\n  padding: 4px 6px;\r\n  border-radius: 4px;\r\n  font-size: 11px;\r\n}\r\n\r\n.ie-range-slider {\r\n  flex: 1;\r\n  min-width: 80px;\r\n  height: 6px;\r\n  appearance: none;\r\n  background: var(--ie-divider);\r\n  border-radius: 3px;\r\n  outline: none;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-range-slider::-webkit-slider-thumb {\r\n  appearance: none;\r\n  width: 16px;\r\n  height: 16px;\r\n  background: var(--ie-btn-active-bg);\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n  transition: transform 0.15s, box-shadow 0.15s;\r\n  box-shadow: 0 2px 6px rgba(0,0,0,0.2);\r\n}\r\n\r\n.ie-range-slider::-webkit-slider-thumb:hover {\r\n  transform: scale(1.15);\r\n  box-shadow: 0 3px 10px rgba(0,0,0,0.3);\r\n}\r\n\r\n.ie-range-slider::-webkit-slider-thumb:active {\r\n  transform: scale(1.05);\r\n}\r\n\r\n.ie-range-slider::-moz-range-thumb {\r\n  width: 16px;\r\n  height: 16px;\r\n  background: var(--ie-btn-active-bg);\r\n  border: none;\r\n  border-radius: 50%;\r\n  cursor: pointer;\r\n  box-shadow: 0 2px 6px rgba(0,0,0,0.2);\r\n}\r\n\r\n.ie-color-row {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n}\r\n\r\n.ie-color-input {\r\n  width: 36px;\r\n  height: 28px;\r\n  padding: 3px;\r\n  border: 2px solid var(--ie-input-border);\r\n  border-radius: 6px;\r\n  background: var(--ie-input-bg);\r\n  cursor: pointer;\r\n  transition: border-color 0.15s;\r\n}\r\n\r\n.ie-color-input:hover {\r\n  border-color: var(--ie-btn-active-bg);\r\n}\r\n\r\n.ie-color-hex {\r\n  font-size: 11px;\r\n  font-family: 'SF Mono', Monaco, monospace;\r\n  color: var(--ie-text-muted);\r\n  text-transform: uppercase;\r\n}\r\n\r\n/* Text Input */\r\n.ie-text-input-overlay {\r\n  position: absolute;\r\n  inset: 0;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: rgba(0,0,0,0.5);\r\n  z-index: 200;\r\n}\r\n\r\n.ie-text-input-box {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  padding: 8px;\r\n  background: var(--ie-panel-bg);\r\n  border-radius: var(--ie-radius);\r\n  box-shadow: 0 4px 20px var(--ie-shadow);\r\n}\r\n\r\n.ie-text-field {\r\n  width: 200px;\r\n  padding: 10px 12px;\r\n  background: var(--ie-input-bg);\r\n  border: 1px solid var(--ie-input-border);\r\n  border-radius: 6px;\r\n  color: var(--ie-text-color);\r\n  font-size: 14px;\r\n  outline: none;\r\n}\r\n\r\n.ie-text-field:focus {\r\n  border-color: var(--ie-btn-active-bg);\r\n}\r\n\r\n.ie-text-confirm {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 38px;\r\n  height: 38px;\r\n  background: var(--ie-btn-active-bg);\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: #fff;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-text-confirm:hover {\r\n  filter: brightness(0.9);\r\n}\r\n\r\n.ie-text-confirm svg {\r\n  width: 18px;\r\n  height: 18px;\r\n}\r\n\r\n/* Zoom badge */\r\n.ie-zoom-badge {\r\n  position: absolute;\r\n  top: 8px;\r\n  right: 8px;\r\n  padding: 4px 8px;\r\n  background: rgba(0,0,0,0.6);\r\n  border-radius: 4px;\r\n  font-size: 11px;\r\n  color: #fff;\r\n  font-variant-numeric: tabular-nums;\r\n  pointer-events: none;\r\n  transition: opacity 0.3s ease;\r\n}\r\n\r\n.ie-zoom-badge.ie-zoom-badge-hidden {\r\n  opacity: 0;\r\n}\r\n\r\n/* Custom brush cursor */\r\n.ie-brush-cursor {\r\n  position: absolute;\r\n  pointer-events: none;\r\n  border: 2px solid var(--ie-btn-active-bg);\r\n  border-radius: 50%;\r\n  background: color-mix(in srgb, var(--ie-btn-active-bg) 15%, transparent);\r\n  transform: translate(-50%, -50%);\r\n  z-index: 100;\r\n  transition: width 0.1s, height 0.1s;\r\n}\r\n\r\n.ie-canvas-container.tool-brush {\r\n  cursor: none;\r\n}\r\n\r\n.ie-canvas-container.tool-draw {\r\n  cursor: crosshair;\r\n}\r\n\r\n/* Inline text editing */\r\n.ie-inline-text-container {\r\n  position: absolute;\r\n  z-index: 200;\r\n  transform: translate(-2px, -50%);\r\n}\r\n\r\n.ie-inline-text-input {\r\n  min-width: 20px;\r\n  max-width: 400px;\r\n  padding: 4px 8px;\r\n  background: var(--ie-panel-bg);\r\n  border: 2px solid var(--ie-btn-active-bg);\r\n  border-radius: 4px;\r\n  outline: none;\r\n  white-space: pre-wrap;\r\n  word-break: break-word;\r\n  line-height: 1.3;\r\n  cursor: text;\r\n}\r\n\r\n.ie-inline-text-input:empty:before {\r\n  content: attr(data-placeholder);\r\n  color: var(--ie-text-muted);\r\n  pointer-events: none;\r\n}\r\n\r\n/* Text style floating bar */\r\n.ie-text-style-bar {\r\n  position: absolute;\r\n  z-index: 201;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n  padding: 6px 8px;\r\n  background: var(--ie-toolbar-bg);\r\n  border: 1px solid var(--ie-toolbar-border);\r\n  border-radius: 6px;\r\n  box-shadow: 0 4px 12px var(--ie-shadow);\r\n}\r\n\r\n.ie-style-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 28px;\r\n  height: 28px;\r\n  padding: 0;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-style-btn:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-style-btn svg {\r\n  width: 16px;\r\n  height: 16px;\r\n}\r\n\r\n.ie-style-confirm {\r\n  background: #667eea;\r\n  color: #fff;\r\n}\r\n\r\n.ie-style-confirm:hover {\r\n  background: #5a6fd6;\r\n}\r\n\r\n.ie-style-value {\r\n  min-width: 28px;\r\n  text-align: center;\r\n  font-size: 12px;\r\n  color: var(--ie-btn-color);\r\n  font-variant-numeric: tabular-nums;\r\n}\r\n\r\n.ie-style-color {\r\n  width: 28px;\r\n  height: 28px;\r\n  padding: 2px;\r\n  border: none;\r\n  border-radius: 4px;\r\n  background: transparent;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-style-divider {\r\n  width: 1px;\r\n  height: 20px;\r\n  background: var(--ie-divider);\r\n  margin: 0 4px;\r\n}\r\n\r\n.ie-panel-text-hint {\r\n  width: auto;\r\n  min-width: 120px;\r\n}\r\n\r\n/* ========== Crop Tool ========== */\r\n.ie-crop-overlay {\r\n  position: absolute;\r\n  inset: 0;\r\n  z-index: 500;\r\n  background: transparent;\r\n}\r\n\r\n.ie-crop-mask {\r\n  position: absolute;\r\n  background: rgba(0, 0, 0, 0.6);\r\n  pointer-events: none;\r\n}\r\n\r\n.ie-crop-box {\r\n  position: absolute;\r\n  border: 2px solid #fff;\r\n  box-shadow: 0 0 0 1px rgba(0,0,0,0.3), 0 0 10px rgba(0,0,0,0.3);\r\n  cursor: move;\r\n}\r\n\r\n.ie-crop-grid {\r\n  position: absolute;\r\n  inset: 0;\r\n  pointer-events: none;\r\n}\r\n\r\n.ie-crop-grid-h,\r\n.ie-crop-grid-v {\r\n  position: absolute;\r\n  background: rgba(255,255,255,0.3);\r\n}\r\n\r\n.ie-crop-grid-h {\r\n  left: 0;\r\n  right: 0;\r\n  height: 1px;\r\n}\r\n\r\n.ie-crop-grid-h:nth-child(1) { top: 33.33%; }\r\n.ie-crop-grid-h:nth-child(2) { top: 66.66%; }\r\n\r\n.ie-crop-grid-v {\r\n  top: 0;\r\n  bottom: 0;\r\n  width: 1px;\r\n}\r\n\r\n.ie-crop-grid-v:nth-child(3) { left: 33.33%; }\r\n.ie-crop-grid-v:nth-child(4) { left: 66.66%; }\r\n\r\n.ie-crop-handle {\r\n  position: absolute;\r\n  width: 12px;\r\n  height: 12px;\r\n  background: #fff;\r\n  border: 1px solid rgba(0,0,0,0.3);\r\n  border-radius: 2px;\r\n}\r\n\r\n.ie-crop-handle-nw { top: -6px; left: -6px; cursor: nw-resize; }\r\n.ie-crop-handle-n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }\r\n.ie-crop-handle-ne { top: -6px; right: -6px; cursor: ne-resize; }\r\n.ie-crop-handle-e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }\r\n.ie-crop-handle-se { bottom: -6px; right: -6px; cursor: se-resize; }\r\n.ie-crop-handle-s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }\r\n.ie-crop-handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }\r\n.ie-crop-handle-w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }\r\n\r\n.ie-crop-panel {\r\n  position: absolute;\r\n  bottom: 20px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 16px;\r\n  padding: 12px 16px;\r\n  background: var(--ie-toolbar-bg);\r\n  border-radius: var(--ie-radius);\r\n  box-shadow: 0 4px 20px var(--ie-shadow);\r\n}\r\n\r\n.ie-crop-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.ie-crop-label {\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted);\r\n  margin-right: 4px;\r\n}\r\n\r\n.ie-crop-buttons {\r\n  display: flex;\r\n  gap: 4px;\r\n}\r\n\r\n.ie-crop-btn {\r\n  padding: 6px 12px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-crop-btn:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-crop-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n.ie-crop-btn-icon {\r\n  width: 32px;\r\n  padding: 6px;\r\n}\r\n\r\n.ie-crop-btn-icon svg {\r\n  width: 18px;\r\n  height: 18px;\r\n}\r\n\r\n.ie-crop-btn-cancel {\r\n  background: transparent;\r\n  border: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-crop-btn-apply {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n\r\n.ie-crop-btn-apply svg {\r\n  width: 14px;\r\n  height: 14px;\r\n}\r\n\r\n.ie-crop-actions {\r\n  position: absolute;\r\n  bottom: -50px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  display: flex;\r\n  gap: 8px;\r\n  padding: 8px 12px;\r\n  background: var(--ie-toolbar-bg);\r\n  border-radius: var(--ie-radius);\r\n  box-shadow: 0 4px 12px var(--ie-shadow);\r\n}\r\n\r\n/* Crop toolbar buttons */\r\n.ie-crop-action-group {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n\r\n.ie-crop-toolbar-btn {\r\n  width: auto !important;\r\n  padding: 0 12px !important;\r\n  gap: 4px;\r\n  font-size: 13px;\r\n}\r\n\r\n.ie-crop-toolbar-btn span {\r\n  font-weight: 500;\r\n}\r\n\r\n.ie-crop-toolbar-cancel {\r\n  background: transparent;\r\n  border: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-crop-toolbar-cancel:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n}\r\n\r\n.ie-crop-toolbar-confirm {\r\n  background: #10b981 !important;\r\n  color: #fff !important;\r\n}\r\n\r\n.ie-crop-toolbar-confirm:hover {\r\n  filter: brightness(0.9);\r\n}\r\n\r\n/* ========== Filter Panel ========== */\r\n.ie-filter-panel {\r\n  width: 280px;\r\n}\r\n\r\n.ie-filter-slider-row {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n.ie-filter-slider-row:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.ie-filter-slider-label {\r\n  width: 50px;\r\n  font-size: 11px;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n.ie-filter-slider-value {\r\n  width: 36px;\r\n  font-size: 11px;\r\n  text-align: right;\r\n  color: var(--ie-text-muted);\r\n  font-variant-numeric: tabular-nums;\r\n}\r\n\r\n.ie-filter-presets {\r\n  display: flex;\r\n  gap: 6px;\r\n  margin-top: 12px;\r\n  padding-top: 12px;\r\n  border-top: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-filter-preset {\r\n  flex: 1;\r\n  padding: 6px 4px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 10px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-filter-preset:hover {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-hover-color);\r\n}\r\n\r\n.ie-filter-preset.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n.ie-filter-actions {\r\n  display: flex;\r\n  gap: 8px;\r\n  margin-top: 12px;\r\n}\r\n\r\n.ie-filter-actions button {\r\n  flex: 1;\r\n  padding: 8px;\r\n  border: none;\r\n  border-radius: 4px;\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-filter-reset {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-color);\r\n}\r\n\r\n.ie-filter-apply {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n/* ========== Context Menu ========== */\r\n.ie-context-menu {\r\n  position: fixed;\r\n  min-width: 160px;\r\n  padding: 6px 0;\r\n  background: var(--ie-panel-bg, #2d2d2d);\r\n  border: 1px solid var(--ie-toolbar-border, rgba(255,255,255,0.1));\r\n  border-radius: 6px;\r\n  box-shadow: 0 4px 20px rgba(0,0,0,0.3);\r\n  z-index: 10000;\r\n}\r\n\r\n.ie-context-menu-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n  padding: 8px 12px;\r\n  color: var(--ie-text-color, #fff);\r\n  font-size: 13px;\r\n  cursor: pointer;\r\n  transition: background 0.1s;\r\n}\r\n\r\n.ie-context-menu-item:hover:not(.disabled) {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-context-menu-item.disabled {\r\n  opacity: 0.5;\r\n  cursor: not-allowed;\r\n}\r\n\r\n.ie-context-menu-icon {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 18px;\r\n  height: 18px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-context-menu-icon svg {\r\n  width: 16px;\r\n  height: 16px;\r\n}\r\n\r\n.ie-context-menu-label {\r\n  flex: 1;\r\n}\r\n\r\n.ie-context-menu-shortcut {\r\n  font-size: 11px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-context-menu-divider {\r\n  height: 1px;\r\n  margin: 6px 12px;\r\n  background: var(--ie-divider, rgba(255,255,255,0.1));\r\n}\r\n\r\n/* ========== Export Dialog ========== */\r\n.ie-export-overlay {\r\n  position: fixed;\r\n  inset: 0;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  background: rgba(0,0,0,0.6);\r\n  z-index: 10000;\r\n}\r\n\r\n.ie-export-dialog {\r\n  width: 420px;\r\n  max-width: 90vw;\r\n  max-height: 90vh;\r\n  overflow: auto;\r\n  background: var(--ie-panel-bg, #2d2d2d);\r\n  border-radius: 12px;\r\n  box-shadow: 0 8px 32px rgba(0,0,0,0.4);\r\n}\r\n\r\n.ie-export-header {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: space-between;\r\n  padding: 16px 20px;\r\n  border-bottom: 1px solid var(--ie-divider, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-export-title {\r\n  font-size: 16px;\r\n  font-weight: 500;\r\n  color: var(--ie-text-color, #fff);\r\n}\r\n\r\n.ie-export-close {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 32px;\r\n  height: 32px;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-export-close:hover {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-export-close svg {\r\n  width: 18px;\r\n  height: 18px;\r\n}\r\n\r\n.ie-export-body {\r\n  padding: 20px;\r\n}\r\n\r\n.ie-export-section {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.ie-export-section:last-child {\r\n  margin-bottom: 0;\r\n}\r\n\r\n.ie-export-label {\r\n  display: block;\r\n  margin-bottom: 8px;\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-export-format-buttons {\r\n  display: flex;\r\n  gap: 8px;\r\n}\r\n\r\n.ie-export-format-btn {\r\n  flex: 1;\r\n  padding: 10px;\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n  border: 2px solid transparent;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n  font-size: 13px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-export-format-btn:hover {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.15));\r\n}\r\n\r\n.ie-export-format-btn.active {\r\n  border-color: var(--ie-btn-active-bg, #667eea);\r\n  color: var(--ie-btn-active-bg, #667eea);\r\n}\r\n\r\n.ie-export-size-inputs {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.ie-export-input {\r\n  flex: 1;\r\n  padding: 10px 12px;\r\n  background: var(--ie-input-bg, #222);\r\n  border: 1px solid var(--ie-input-border, #444);\r\n  border-radius: 6px;\r\n  color: var(--ie-text-color, #fff);\r\n  font-size: 14px;\r\n}\r\n\r\n.ie-export-input:focus {\r\n  outline: none;\r\n  border-color: var(--ie-btn-active-bg, #667eea);\r\n}\r\n\r\n.ie-export-link-btn {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  width: 36px;\r\n  height: 36px;\r\n  background: transparent;\r\n  border: 1px solid var(--ie-input-border, #444);\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-export-link-btn.active {\r\n  background: var(--ie-btn-active-bg, #667eea);\r\n  border-color: var(--ie-btn-active-bg, #667eea);\r\n  color: #fff;\r\n}\r\n\r\n.ie-export-quality {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 12px;\r\n}\r\n\r\n.ie-export-quality-slider {\r\n  flex: 1;\r\n}\r\n\r\n.ie-export-quality-value {\r\n  min-width: 40px;\r\n  text-align: right;\r\n  font-size: 13px;\r\n  color: var(--ie-text-muted, rgba(255,255,255,0.5));\r\n}\r\n\r\n.ie-export-preview {\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  height: 120px;\r\n  background: var(--ie-input-bg, #222);\r\n  border-radius: 6px;\r\n  overflow: hidden;\r\n}\r\n\r\n.ie-export-preview img {\r\n  max-width: 100%;\r\n  max-height: 100%;\r\n  object-fit: contain;\r\n}\r\n\r\n.ie-export-footer {\r\n  display: flex;\r\n  gap: 12px;\r\n  padding: 16px 20px;\r\n  border-top: 1px solid var(--ie-divider, rgba(255,255,255,0.1));\r\n}\r\n\r\n.ie-export-footer button {\r\n  flex: 1;\r\n  padding: 12px;\r\n  border: none;\r\n  border-radius: 6px;\r\n  font-size: 14px;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-export-cancel {\r\n  background: var(--ie-btn-hover-bg, rgba(255,255,255,0.1));\r\n  color: var(--ie-btn-color, rgba(255,255,255,0.7));\r\n}\r\n\r\n.ie-export-download {\r\n  background: var(--ie-btn-active-bg, #667eea);\r\n  color: #fff;\r\n}\r\n\r\n/* ========== Eraser Tool ========== */\r\n.ie-panel-eraser {\r\n  width: 200px;\r\n}\r\n\r\n.ie-eraser-mode {\r\n  display: flex;\r\n  gap: 6px;\r\n  margin-top: 8px;\r\n}\r\n\r\n.ie-eraser-mode-btn {\r\n  flex: 1;\r\n  padding: 8px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: none;\r\n  border-radius: 4px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 11px;\r\n  cursor: pointer;\r\n}\r\n\r\n.ie-eraser-mode-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n/* ========== Tooltip ========== */\r\n.ie-tooltip {\r\n  position: absolute;\r\n  bottom: calc(100% + 8px);\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  padding: 10px 14px;\r\n  background: var(--ie-panel-bg);\r\n  border: 1px solid var(--ie-toolbar-border);\r\n  border-radius: 8px;\r\n  box-shadow: 0 4px 16px var(--ie-shadow);\r\n  white-space: nowrap;\r\n  z-index: 9999;\r\n  opacity: 0;\r\n  visibility: hidden;\r\n  pointer-events: none;\r\n  transition: opacity 0.2s 0.3s, visibility 0.2s 0.3s;\r\n}\r\n\r\n.ie-tooltip::after {\r\n  content: '';\r\n  position: absolute;\r\n  top: 100%;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  border: 6px solid transparent;\r\n  border-top-color: var(--ie-panel-bg);\r\n}\r\n\r\n.ie-btn:hover .ie-tooltip {\r\n  opacity: 1;\r\n  visibility: visible;\r\n  transition-delay: 0.3s;\r\n}\r\n\r\n.ie-tooltip-title {\r\n  font-size: 13px;\r\n  font-weight: 600;\r\n  color: var(--ie-text-color);\r\n  margin-bottom: 2px;\r\n}\r\n\r\n.ie-tooltip-desc {\r\n  font-size: 11px;\r\n  color: var(--ie-text-muted);\r\n  margin-bottom: 4px;\r\n}\r\n\r\n.ie-tooltip-shortcut {\r\n  display: inline-block;\r\n  padding: 2px 6px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border-radius: 4px;\r\n  font-size: 10px;\r\n  font-family: monospace;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n/* Filter panel button styles */\r\n.ie-btn-row {\r\n  display: flex;\r\n  gap: 10px;\r\n  margin-top: 16px;\r\n  padding-top: 14px;\r\n  border-top: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-btn-apply,\r\n.ie-btn-reset {\r\n  flex: 1;\r\n  padding: 10px 14px;\r\n  border: none;\r\n  border-radius: 8px;\r\n  font-size: 13px;\r\n  font-weight: 500;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-btn-apply {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n}\r\n\r\n.ie-btn-apply:hover {\r\n  filter: brightness(1.05);\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.ie-btn-apply:active {\r\n  transform: translateY(0);\r\n}\r\n\r\n.ie-btn-reset {\r\n  background: var(--ie-btn-hover-bg);\r\n  color: var(--ie-btn-color);\r\n}\r\n\r\n.ie-btn-reset:hover {\r\n  background: var(--ie-divider);\r\n}\r\n\r\n/* Mode button group */\r\n.ie-btn-group {\r\n  display: flex;\r\n  gap: 6px;\r\n  background: var(--ie-input-bg);\r\n  padding: 4px;\r\n  border-radius: 8px;\r\n}\r\n\r\n.ie-mode-btn {\r\n  padding: 8px 14px;\r\n  background: transparent;\r\n  border: none;\r\n  border-radius: 6px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n}\r\n\r\n.ie-mode-btn.active {\r\n  background: var(--ie-btn-active-bg);\r\n  color: #fff;\r\n  box-shadow: 0 2px 6px rgba(0,0,0,0.15);\r\n}\r\n\r\n.ie-mode-btn:hover:not(.active) {\r\n  background: var(--ie-btn-hover-bg);\r\n}\r\n\r\n/* Filter panel specific */\r\n.ie-panel-filter {\r\n  width: 300px;\r\n}\r\n\r\n/* Filter presets grid */\r\n.ie-filter-presets {\r\n  display: grid;\r\n  grid-template-columns: repeat(4, 1fr);\r\n  gap: 8px;\r\n  margin-bottom: 16px;\r\n  padding-bottom: 16px;\r\n  border-bottom: 1px solid var(--ie-divider);\r\n}\r\n\r\n.ie-filter-preset {\r\n  padding: 10px 6px;\r\n  background: var(--ie-btn-hover-bg);\r\n  border: 2px solid transparent;\r\n  border-radius: 8px;\r\n  color: var(--ie-btn-color);\r\n  font-size: 11px;\r\n  font-weight: 500;\r\n  cursor: pointer;\r\n  transition: all 0.15s;\r\n  text-align: center;\r\n}\r\n\r\n.ie-filter-preset:hover {\r\n  background: var(--ie-divider);\r\n  transform: translateY(-1px);\r\n}\r\n\r\n.ie-filter-preset.active {\r\n  border-color: var(--ie-btn-active-bg);\r\n  background: rgba(102, 126, 234, 0.15);\r\n  color: var(--ie-btn-active-bg);\r\n}\r\n\r\n/* Font select in text style bar */\r\n.ie-style-select {\r\n  padding: 4px 8px;\r\n  background: var(--ie-input-bg);\r\n  border: 1px solid var(--ie-input-border);\r\n  border-radius: 4px;\r\n  color: var(--ie-text-color);\r\n  font-size: 12px;\r\n  cursor: pointer;\r\n  outline: none;\r\n}\r\n\r\n.ie-style-select:focus {\r\n  border-color: var(--ie-btn-active-bg);\r\n}\r\n\r\n/* ========== Drop zone indicator ========== */\r\n.ie-drop-zone {\r\n  position: absolute;\r\n  inset: 0;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 12px;\r\n  background: rgba(102, 126, 234, 0.1);\r\n  border: 2px dashed var(--ie-btn-active-bg);\r\n  border-radius: 12px;\r\n  z-index: 1000;\r\n  pointer-events: none;\r\n  opacity: 0;\r\n  transition: opacity 0.2s ease;\r\n}\r\n\r\n.ie-drop-zone.active {\r\n  opacity: 1;\r\n}\r\n\r\n.ie-drop-zone-icon {\r\n  width: 48px;\r\n  height: 48px;\r\n  color: var(--ie-btn-active-bg);\r\n  animation: ie-drop-bounce 0.6s ease infinite;\r\n}\r\n\r\n.ie-drop-zone-icon svg {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n\r\n.ie-drop-zone-text {\r\n  font-size: 15px;\r\n  font-weight: 500;\r\n  color: var(--ie-btn-active-bg);\r\n}\r\n\r\n.ie-drop-zone-hint {\r\n  font-size: 12px;\r\n  color: var(--ie-text-muted);\r\n}\r\n\r\n@keyframes ie-drop-bounce {\r\n  0%, 100% { transform: translateY(0); }\r\n  50% { transform: translateY(-6px); }\r\n}\r\n\r\n/* ========== Touch improvements ========== */\r\n@media (pointer: coarse) {\r\n  .ie-btn {\r\n    width: 44px;\r\n    height: 44px;\r\n  }\r\n  \r\n  .ie-tooltip {\r\n    display: none;\r\n  }\r\n  \r\n  .ie-crop-handle {\r\n    width: 20px;\r\n    height: 20px;\r\n  }\r\n  \r\n  .ie-crop-handle-nw { top: -10px; left: -10px; }\r\n  .ie-crop-handle-n { top: -10px; margin-left: -10px; }\r\n  .ie-crop-handle-ne { top: -10px; right: -10px; }\r\n  .ie-crop-handle-e { margin-top: -10px; right: -10px; }\r\n  .ie-crop-handle-se { bottom: -10px; right: -10px; }\r\n  .ie-crop-handle-s { bottom: -10px; margin-left: -10px; }\r\n  .ie-crop-handle-sw { bottom: -10px; left: -10px; }\r\n  .ie-crop-handle-w { margin-top: -10px; left: -10px; }\r\n}\r\n`;\r\n\r\nexport function injectStyles(): void {\r\n  if (typeof document === 'undefined') return;\r\n  \r\n  const styleId = 'ie-toolbar-styles';\r\n  if (document.getElementById(styleId)) return;\r\n  \r\n  const style = document.createElement('style');\r\n  style.id = styleId;\r\n  style.textContent = toolbarStyles;\r\n  document.head.appendChild(style);\r\n}\r\n","/**\r\n * ShapeLayer - Manages drawable shapes as layers\r\n */\r\n\r\nexport type ShapeType = 'pen' | 'rect' | 'circle' | 'arrow' | 'text' | 'line' | 'triangle';\r\n\r\nexport interface Point {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nexport interface ShapeStyle {\r\n  strokeColor: string;\r\n  strokeWidth: number;\r\n  fillColor?: string;\r\n  strokeDash?: number[];  // For dashed lines\r\n  fillMode?: 'none' | 'fill' | 'stroke' | 'both';  // Fill mode\r\n}\r\n\r\nexport interface BaseShape {\r\n  id: string;\r\n  type: ShapeType;\r\n  style: ShapeStyle;\r\n  selected: boolean;\r\n}\r\n\r\nexport interface PenShape extends BaseShape {\r\n  type: 'pen';\r\n  points: Point[];\r\n}\r\n\r\nexport interface RectShape extends BaseShape {\r\n  type: 'rect';\r\n  x: number;\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface CircleShape extends BaseShape {\r\n  type: 'circle';\r\n  cx: number;\r\n  cy: number;\r\n  rx: number;\r\n  ry: number;\r\n}\r\n\r\nexport interface ArrowShape extends BaseShape {\r\n  type: 'arrow';\r\n  start: Point;\r\n  end: Point;\r\n}\r\n\r\nexport interface TextShape extends BaseShape {\r\n  type: 'text';\r\n  text: string;\r\n  x: number;\r\n  y: number;\r\n  fontSize: number;\r\n  color: string;\r\n  fontFamily?: string;\r\n  fontWeight?: 'normal' | 'bold';\r\n  fontStyle?: 'normal' | 'italic';\r\n  textDecoration?: 'none' | 'underline';\r\n  strokeEnabled?: boolean;\r\n  strokeColor?: string;\r\n  strokeWidth?: number;\r\n}\r\n\r\nexport interface LineShape extends BaseShape {\r\n  type: 'line';\r\n  start: Point;\r\n  end: Point;\r\n}\r\n\r\nexport interface TriangleShape extends BaseShape {\r\n  type: 'triangle';\r\n  points: [Point, Point, Point];\r\n}\r\n\r\nexport type Shape = PenShape | RectShape | CircleShape | ArrowShape | TextShape | LineShape | TriangleShape;\r\n\r\nlet shapeIdCounter = 0;\r\nfunction generateId(): string {\r\n  return `shape_${Date.now()}_${++shapeIdCounter}`;\r\n}\r\n\r\nexport class ShapeLayerManager {\r\n  private shapes: Shape[] = [];\r\n  private selectedShapeId: string | null = null;\r\n  private onChange: (() => void) | null = null;\r\n\r\n  /** Create a new shape */\r\n  createShape(type: ShapeType, style: ShapeStyle): string {\r\n    const id = generateId();\r\n    const baseShape = { id, type, style, selected: false };\r\n    \r\n    switch (type) {\r\n      case 'pen':\r\n        this.shapes.push({ ...baseShape, type: 'pen', points: [] } as PenShape);\r\n        break;\r\n      case 'rect':\r\n        this.shapes.push({ ...baseShape, type: 'rect', x: 0, y: 0, width: 0, height: 0 } as RectShape);\r\n        break;\r\n      case 'circle':\r\n        this.shapes.push({ ...baseShape, type: 'circle', cx: 0, cy: 0, rx: 0, ry: 0 } as CircleShape);\r\n        break;\r\n      case 'arrow':\r\n        this.shapes.push({ ...baseShape, type: 'arrow', start: { x: 0, y: 0 }, end: { x: 0, y: 0 } } as ArrowShape);\r\n        break;\r\n      case 'text':\r\n        this.shapes.push({ ...baseShape, type: 'text', text: '', x: 0, y: 0, fontSize: 24, color: style.strokeColor } as TextShape);\r\n        break;\r\n      case 'line':\r\n        this.shapes.push({ ...baseShape, type: 'line', start: { x: 0, y: 0 }, end: { x: 0, y: 0 } } as LineShape);\r\n        break;\r\n      case 'triangle':\r\n        this.shapes.push({ ...baseShape, type: 'triangle', points: [{ x: 0, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 0 }] } as TriangleShape);\r\n        break;\r\n    }\r\n    \r\n    return id;\r\n  }\r\n\r\n  /** Get shape by ID */\r\n  getShape(id: string): Shape | undefined {\r\n    return this.shapes.find(s => s.id === id);\r\n  }\r\n\r\n  /** Update shape data */\r\n  updateShape(id: string, updates: Partial<Shape>): void {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (shape) {\r\n      Object.assign(shape, updates);\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Delete shape */\r\n  deleteShape(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index !== -1) {\r\n      this.shapes.splice(index, 1);\r\n      if (this.selectedShapeId === id) {\r\n        this.selectedShapeId = null;\r\n      }\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Select shape */\r\n  selectShape(id: string | null): void {\r\n    // Deselect previous\r\n    if (this.selectedShapeId) {\r\n      const prev = this.shapes.find(s => s.id === this.selectedShapeId);\r\n      if (prev) prev.selected = false;\r\n    }\r\n    \r\n    // Select new\r\n    this.selectedShapeId = id;\r\n    if (id) {\r\n      const shape = this.shapes.find(s => s.id === id);\r\n      if (shape) shape.selected = true;\r\n    }\r\n    \r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Get selected shape */\r\n  getSelectedShape(): Shape | null {\r\n    if (!this.selectedShapeId) return null;\r\n    return this.shapes.find(s => s.id === this.selectedShapeId) || null;\r\n  }\r\n\r\n  /** Find shape at point */\r\n  findShapeAtPoint(x: number, y: number, tolerance: number = 5): Shape | null {\r\n    // Check from top to bottom (last drawn = top)\r\n    for (let i = this.shapes.length - 1; i >= 0; i--) {\r\n      const shape = this.shapes[i];\r\n      if (this.isPointInShape(shape, x, y, tolerance)) {\r\n        return shape;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /** Check if point is inside shape */\r\n  private isPointInShape(shape: Shape, x: number, y: number, tolerance: number): boolean {\r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        return x >= s.x - tolerance && x <= s.x + s.width + tolerance &&\r\n               y >= s.y - tolerance && y <= s.y + s.height + tolerance;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        const dx = (x - s.cx) / (s.rx + tolerance);\r\n        const dy = (y - s.cy) / (s.ry + tolerance);\r\n        return dx * dx + dy * dy <= 1;\r\n      }\r\n      case 'arrow':\r\n      case 'line': {\r\n        const s = shape as ArrowShape | LineShape;\r\n        // Check distance to line segment\r\n        const dist = this.pointToLineDistance(x, y, s.start.x, s.start.y, s.end.x, s.end.y);\r\n        return dist <= tolerance + s.style.strokeWidth;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        // Check if point is near any edge\r\n        for (let i = 0; i < 3; i++) {\r\n          const p1 = s.points[i];\r\n          const p2 = s.points[(i + 1) % 3];\r\n          const dist = this.pointToLineDistance(x, y, p1.x, p1.y, p2.x, p2.y);\r\n          if (dist <= tolerance + s.style.strokeWidth) return true;\r\n        }\r\n        return false;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        // Check distance to any segment\r\n        for (let i = 1; i < s.points.length; i++) {\r\n          const dist = this.pointToLineDistance(x, y, s.points[i-1].x, s.points[i-1].y, s.points[i].x, s.points[i].y);\r\n          if (dist <= tolerance + s.style.strokeWidth) return true;\r\n        }\r\n        return false;\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        // Approximate text bounds\r\n        const width = s.text.length * s.fontSize * 0.6;\r\n        const height = s.fontSize * 1.2;\r\n        return x >= s.x - tolerance && x <= s.x + width + tolerance &&\r\n               y >= s.y - height - tolerance && y <= s.y + tolerance;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /** Calculate distance from point to line segment */\r\n  private pointToLineDistance(px: number, py: number, x1: number, y1: number, x2: number, y2: number): number {\r\n    const dx = x2 - x1;\r\n    const dy = y2 - y1;\r\n    const len2 = dx * dx + dy * dy;\r\n    \r\n    if (len2 === 0) {\r\n      return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2);\r\n    }\r\n    \r\n    let t = ((px - x1) * dx + (py - y1) * dy) / len2;\r\n    t = Math.max(0, Math.min(1, t));\r\n    \r\n    const nearX = x1 + t * dx;\r\n    const nearY = y1 + t * dy;\r\n    \r\n    return Math.sqrt((px - nearX) ** 2 + (py - nearY) ** 2);\r\n  }\r\n\r\n  /** Move shape by delta */\r\n  moveShape(id: string, dx: number, dy: number): void {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (!shape) return;\r\n    \r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        s.x += dx;\r\n        s.y += dy;\r\n        break;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        s.cx += dx;\r\n        s.cy += dy;\r\n        break;\r\n      }\r\n      case 'arrow': {\r\n        const s = shape as ArrowShape;\r\n        s.start.x += dx;\r\n        s.start.y += dy;\r\n        s.end.x += dx;\r\n        s.end.y += dy;\r\n        break;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        s.points.forEach(p => {\r\n          p.x += dx;\r\n          p.y += dy;\r\n        });\r\n        break;\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        s.x += dx;\r\n        s.y += dy;\r\n        break;\r\n      }\r\n      case 'line': {\r\n        const s = shape as LineShape;\r\n        s.start.x += dx;\r\n        s.start.y += dy;\r\n        s.end.x += dx;\r\n        s.end.y += dy;\r\n        break;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        s.points.forEach(p => {\r\n          p.x += dx;\r\n          p.y += dy;\r\n        });\r\n        break;\r\n      }\r\n    }\r\n    \r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Get all shapes */\r\n  getShapes(): Shape[] {\r\n    return [...this.shapes];\r\n  }\r\n\r\n  /** Clear all shapes */\r\n  clear(): void {\r\n    this.shapes = [];\r\n    this.selectedShapeId = null;\r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Set change callback */\r\n  setOnChange(callback: () => void): void {\r\n    this.onChange = callback;\r\n  }\r\n\r\n  // ========== Layer Management ==========\r\n  \r\n  /** Bring shape to front */\r\n  bringToFront(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index !== -1 && index < this.shapes.length - 1) {\r\n      const [shape] = this.shapes.splice(index, 1);\r\n      this.shapes.push(shape);\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Send shape to back */\r\n  sendToBack(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index > 0) {\r\n      const [shape] = this.shapes.splice(index, 1);\r\n      this.shapes.unshift(shape);\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Bring shape forward one level */\r\n  bringForward(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index !== -1 && index < this.shapes.length - 1) {\r\n      [this.shapes[index], this.shapes[index + 1]] = [this.shapes[index + 1], this.shapes[index]];\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Send shape backward one level */\r\n  sendBackward(id: string): void {\r\n    const index = this.shapes.findIndex(s => s.id === id);\r\n    if (index > 0) {\r\n      [this.shapes[index - 1], this.shapes[index]] = [this.shapes[index], this.shapes[index - 1]];\r\n      this.notifyChange();\r\n    }\r\n  }\r\n\r\n  /** Duplicate a shape */\r\n  duplicateShape(id: string, offset: { x: number; y: number } = { x: 20, y: 20 }): string | null {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (!shape) return null;\r\n    \r\n    const newId = generateId();\r\n    const clonedShape = JSON.parse(JSON.stringify(shape));\r\n    clonedShape.id = newId;\r\n    clonedShape.selected = false;\r\n    \r\n    // Offset the clone\r\n    this.offsetShape(clonedShape, offset.x, offset.y);\r\n    \r\n    this.shapes.push(clonedShape);\r\n    this.notifyChange();\r\n    return newId;\r\n  }\r\n  \r\n  /** Offset shape position */\r\n  private offsetShape(shape: Shape, dx: number, dy: number): void {\r\n    switch (shape.type) {\r\n      case 'rect':\r\n        (shape as RectShape).x += dx;\r\n        (shape as RectShape).y += dy;\r\n        break;\r\n      case 'circle':\r\n        (shape as CircleShape).cx += dx;\r\n        (shape as CircleShape).cy += dy;\r\n        break;\r\n      case 'arrow':\r\n      case 'line':\r\n        (shape as ArrowShape).start.x += dx;\r\n        (shape as ArrowShape).start.y += dy;\r\n        (shape as ArrowShape).end.x += dx;\r\n        (shape as ArrowShape).end.y += dy;\r\n        break;\r\n      case 'pen':\r\n        (shape as PenShape).points.forEach(p => { p.x += dx; p.y += dy; });\r\n        break;\r\n      case 'text':\r\n        (shape as TextShape).x += dx;\r\n        (shape as TextShape).y += dy;\r\n        break;\r\n      case 'triangle':\r\n        (shape as TriangleShape).points.forEach(p => { p.x += dx; p.y += dy; });\r\n        break;\r\n    }\r\n  }\r\n\r\n  /** Get shape z-index (position in array) */\r\n  getShapeZIndex(id: string): number {\r\n    return this.shapes.findIndex(s => s.id === id);\r\n  }\r\n\r\n  /** Get shape count */\r\n  getShapeCount(): number {\r\n    return this.shapes.length;\r\n  }\r\n\r\n  private notifyChange(): void {\r\n    this.onChange?.();\r\n  }\r\n\r\n  /** Render all shapes to canvas context */\r\n  render(ctx: CanvasRenderingContext2D): void {\r\n    for (const shape of this.shapes) {\r\n      this.renderShape(ctx, shape);\r\n    }\r\n  }\r\n\r\n  /** Render single shape */\r\n  private renderShape(ctx: CanvasRenderingContext2D, shape: Shape): void {\r\n    ctx.save();\r\n    ctx.strokeStyle = shape.style.strokeColor;\r\n    ctx.lineWidth = shape.style.strokeWidth;\r\n    ctx.lineCap = 'round';\r\n    ctx.lineJoin = 'round';\r\n    \r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        ctx.beginPath();\r\n        ctx.rect(s.x, s.y, s.width, s.height);\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        ctx.beginPath();\r\n        ctx.ellipse(s.cx, s.cy, s.rx, s.ry, 0, 0, Math.PI * 2);\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'arrow': {\r\n        const s = shape as ArrowShape;\r\n        // Draw line\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.start.x, s.start.y);\r\n        ctx.lineTo(s.end.x, s.end.y);\r\n        ctx.stroke();\r\n        // Draw arrowhead\r\n        const headLen = Math.max(10, s.style.strokeWidth * 4);\r\n        const angle = Math.atan2(s.end.y - s.start.y, s.end.x - s.start.x);\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.end.x, s.end.y);\r\n        ctx.lineTo(s.end.x - headLen * Math.cos(angle - Math.PI / 6), s.end.y - headLen * Math.sin(angle - Math.PI / 6));\r\n        ctx.moveTo(s.end.x, s.end.y);\r\n        ctx.lineTo(s.end.x - headLen * Math.cos(angle + Math.PI / 6), s.end.y - headLen * Math.sin(angle + Math.PI / 6));\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        if (s.points.length < 2) break;\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.points[0].x, s.points[0].y);\r\n        for (let i = 1; i < s.points.length; i++) {\r\n          ctx.lineTo(s.points[i].x, s.points[i].y);\r\n        }\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        ctx.font = `${s.fontSize}px sans-serif`;\r\n        ctx.fillStyle = s.color;\r\n        ctx.fillText(s.text, s.x, s.y);\r\n        break;\r\n      }\r\n      case 'line': {\r\n        const s = shape as LineShape;\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.start.x, s.start.y);\r\n        ctx.lineTo(s.end.x, s.end.y);\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        ctx.beginPath();\r\n        ctx.moveTo(s.points[0].x, s.points[0].y);\r\n        ctx.lineTo(s.points[1].x, s.points[1].y);\r\n        ctx.lineTo(s.points[2].x, s.points[2].y);\r\n        ctx.closePath();\r\n        ctx.stroke();\r\n        break;\r\n      }\r\n    }\r\n    \r\n    // Draw selection indicator\r\n    if (shape.selected) {\r\n      this.renderSelectionBox(ctx, shape);\r\n    }\r\n    \r\n    ctx.restore();\r\n  }\r\n\r\n  /** Render selection box around shape */\r\n  private renderSelectionBox(ctx: CanvasRenderingContext2D, shape: Shape): void {\r\n    const bounds = this.getShapeBounds(shape);\r\n    if (!bounds) return;\r\n    \r\n    const padding = 4;\r\n    ctx.strokeStyle = '#667eea';\r\n    ctx.lineWidth = 1;\r\n    ctx.setLineDash([4, 4]);\r\n    ctx.strokeRect(\r\n      bounds.x - padding,\r\n      bounds.y - padding,\r\n      bounds.width + padding * 2,\r\n      bounds.height + padding * 2\r\n    );\r\n    ctx.setLineDash([]);\r\n  }\r\n\r\n  /** Get shape bounding box */\r\n  getShapeBounds(shape: Shape): { x: number; y: number; width: number; height: number } | null {\r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        return { x: s.x, y: s.y, width: s.width, height: s.height };\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        return { x: s.cx - s.rx, y: s.cy - s.ry, width: s.rx * 2, height: s.ry * 2 };\r\n      }\r\n      case 'arrow': {\r\n        const s = shape as ArrowShape;\r\n        const minX = Math.min(s.start.x, s.end.x);\r\n        const minY = Math.min(s.start.y, s.end.y);\r\n        const maxX = Math.max(s.start.x, s.end.x);\r\n        const maxY = Math.max(s.start.y, s.end.y);\r\n        return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        if (s.points.length === 0) return null;\r\n        let minX = s.points[0].x, maxX = s.points[0].x;\r\n        let minY = s.points[0].y, maxY = s.points[0].y;\r\n        for (const p of s.points) {\r\n          minX = Math.min(minX, p.x);\r\n          maxX = Math.max(maxX, p.x);\r\n          minY = Math.min(minY, p.y);\r\n          maxY = Math.max(maxY, p.y);\r\n        }\r\n        return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\r\n      }\r\n      case 'text': {\r\n        const s = shape as TextShape;\r\n        const width = s.text.length * s.fontSize * 0.6;\r\n        const height = s.fontSize * 1.2;\r\n        return { x: s.x, y: s.y - height, width, height };\r\n      }\r\n      case 'line': {\r\n        const s = shape as LineShape;\r\n        const minX = Math.min(s.start.x, s.end.x);\r\n        const minY = Math.min(s.start.y, s.end.y);\r\n        const maxX = Math.max(s.start.x, s.end.x);\r\n        const maxY = Math.max(s.start.y, s.end.y);\r\n        return { x: minX, y: minY, width: maxX - minX || 1, height: maxY - minY || 1 };\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        const xs = s.points.map(p => p.x);\r\n        const ys = s.points.map(p => p.y);\r\n        const minX = Math.min(...xs);\r\n        const minY = Math.min(...ys);\r\n        const maxX = Math.max(...xs);\r\n        const maxY = Math.max(...ys);\r\n        return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /** Resize shape by scale factor */\r\n  resizeShape(id: string, scaleX: number, scaleY: number, anchorX: number, anchorY: number): void {\r\n    const shape = this.shapes.find(s => s.id === id);\r\n    if (!shape) return;\r\n    \r\n    switch (shape.type) {\r\n      case 'rect': {\r\n        const s = shape as RectShape;\r\n        const newX = anchorX + (s.x - anchorX) * scaleX;\r\n        const newY = anchorY + (s.y - anchorY) * scaleY;\r\n        s.x = newX;\r\n        s.y = newY;\r\n        s.width *= scaleX;\r\n        s.height *= scaleY;\r\n        break;\r\n      }\r\n      case 'circle': {\r\n        const s = shape as CircleShape;\r\n        s.cx = anchorX + (s.cx - anchorX) * scaleX;\r\n        s.cy = anchorY + (s.cy - anchorY) * scaleY;\r\n        s.rx *= scaleX;\r\n        s.ry *= scaleY;\r\n        break;\r\n      }\r\n      case 'arrow':\r\n      case 'line': {\r\n        const s = shape as ArrowShape | LineShape;\r\n        s.start.x = anchorX + (s.start.x - anchorX) * scaleX;\r\n        s.start.y = anchorY + (s.start.y - anchorY) * scaleY;\r\n        s.end.x = anchorX + (s.end.x - anchorX) * scaleX;\r\n        s.end.y = anchorY + (s.end.y - anchorY) * scaleY;\r\n        break;\r\n      }\r\n      case 'pen': {\r\n        const s = shape as PenShape;\r\n        s.points.forEach(p => {\r\n          p.x = anchorX + (p.x - anchorX) * scaleX;\r\n          p.y = anchorY + (p.y - anchorY) * scaleY;\r\n        });\r\n        break;\r\n      }\r\n      case 'triangle': {\r\n        const s = shape as TriangleShape;\r\n        s.points.forEach(p => {\r\n          p.x = anchorX + (p.x - anchorX) * scaleX;\r\n          p.y = anchorY + (p.y - anchorY) * scaleY;\r\n        });\r\n        break;\r\n      }\r\n    }\r\n    \r\n    this.notifyChange();\r\n  }\r\n\r\n  /** Get control points for selected shape */\r\n  getControlPoints(shape: Shape): Array<{ x: number; y: number; type: string }> {\r\n    const bounds = this.getShapeBounds(shape);\r\n    if (!bounds) return [];\r\n    \r\n    const { x, y, width, height } = bounds;\r\n    return [\r\n      { x: x, y: y, type: 'nw' },\r\n      { x: x + width / 2, y: y, type: 'n' },\r\n      { x: x + width, y: y, type: 'ne' },\r\n      { x: x + width, y: y + height / 2, type: 'e' },\r\n      { x: x + width, y: y + height, type: 'se' },\r\n      { x: x + width / 2, y: y + height, type: 's' },\r\n      { x: x, y: y + height, type: 'sw' },\r\n      { x: x, y: y + height / 2, type: 'w' },\r\n    ];\r\n  }\r\n}\r\n","/**\r\n * Toolbar - Built-in toolbar UI for the editor\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport { injectStyles } from './toolbar.styles';\r\nimport type { Editor } from '../core/Editor';\r\nimport { ShapeLayerManager, type PenShape, type RectShape, type CircleShape, type ArrowShape, type LineShape, type TriangleShape } from './ShapeLayer';\r\nimport { createPlaceholder } from '../utils/placeholder';\r\n\r\n/** Available tool/button names that can be disabled */\r\nexport type ToolName = \r\n  | 'move' | 'pen' | 'rect' | 'circle' | 'arrow' | 'line' | 'triangle' | 'text' | 'mosaic' | 'eraser' | 'crop' | 'filter'  // Drawing tools\r\n  | 'zoomIn' | 'zoomOut' | 'reset'  // Zoom controls\r\n  | 'undo' | 'redo'  // History controls  \r\n  | 'export';  // Export button\r\n\r\nexport interface ToolbarOptions {\r\n  /** Show zoom controls */\r\n  zoom?: boolean;\r\n  /** Show tool buttons (brush, text) */\r\n  tools?: boolean;\r\n  /** Show history buttons (undo, redo) */\r\n  history?: boolean;\r\n  /** Show export button */\r\n  export?: boolean;\r\n  /** Theme: 'light' | 'dark' | 'auto' */\r\n  theme?: 'light' | 'dark' | 'auto';\r\n  /** Primary color for buttons and accents */\r\n  primaryColor?: string;\r\n  /** List of tools to disable */\r\n  disabledTools?: ToolName[];\r\n  /** Auto hide toolbar when no image is loaded */\r\n  autoHide?: boolean;\r\n  /** Placeholder text */\r\n  placeholderText?: string;\r\n  /** Placeholder sub text */\r\n  placeholderSubText?: string;\r\n  /** Placeholder width */\r\n  placeholderWidth?: number;\r\n  /** Placeholder height */\r\n  placeholderHeight?: number;\r\n  /** Locale for i18n */\r\n  locale?: 'zh-CN' | 'en-US';\r\n  /** Enable keyboard shortcuts */\r\n  enableKeyboardShortcuts?: boolean;\r\n  /** Enable advanced export dialog */\r\n  enableExportDialog?: boolean;\r\n  /** Enable watermark in export */\r\n  enableWatermark?: boolean;\r\n}\r\n\r\nconst defaultOptions: ToolbarOptions & { zoom: boolean; tools: boolean; history: boolean; export: boolean; theme: 'light' | 'dark' | 'auto'; autoHide: boolean } = {\r\n  zoom: true,\r\n  tools: true,\r\n  history: true,\r\n  export: true,\r\n  theme: 'dark',\r\n  autoHide: true,\r\n};\r\n\r\nexport class Toolbar {\r\n  private editor: Editor;\r\n  private options: ToolbarOptions;\r\n  private wrapper: HTMLElement;\r\n  private canvasContainer: HTMLElement;\r\n  private viewport: HTMLElement;\r\n  private toolbar: HTMLElement;\r\n  private zoomBadge: HTMLElement;\r\n  \r\n  // State\r\n  private scale = 1;\r\n  private translateX = 0;\r\n  private translateY = 0;\r\n  private isPanning = false;\r\n  private lastPanPoint = { x: 0, y: 0 };\r\n  private currentTool: string | null = null;\r\n  private activePanel: string | null = null;\r\n  \r\n  // Drawing state\r\n  private isDrawing = false;\r\n  private drawStartPoint = { x: 0, y: 0 };\r\n  private lastDrawPoint = { x: 0, y: 0 };\r\n  private brushCursor: HTMLElement | null = null;\r\n  \r\n  // Settings for all tools\r\n  private strokeWidth = 3;\r\n  private strokeColor = '#ff0000';\r\n  private mosaicSize = 10; // Block size for mosaic\r\n  private textSize = 24;\r\n  private textColor = '#ff0000';\r\n  private textFontFamily = 'sans-serif';\r\n  private textBold = false;\r\n  private textItalic = false;\r\n  private textUnderline = false;\r\n  private eraserSize = 20;\r\n  private eraserMode: 'pixel' | 'shape' = 'pixel';\r\n  \r\n  // Crop tool state\r\n  private isCropActive = false;\r\n  private cropOverlay: HTMLElement | null = null;\r\n  \r\n  // Touch gesture state\r\n  private touchStartDistance = 0;\r\n  private touchStartScale = 1;\r\n  private touchStartCenter = { x: 0, y: 0 };\r\n  private isTouchPanning = false;\r\n  private lastTouchCenter = { x: 0, y: 0 };\r\n  \r\n  // Elements\r\n  private panels: Map<string, HTMLElement> = new Map();\r\n  private buttons: Map<string, HTMLButtonElement> = new Map();\r\n  private groups: Map<string, HTMLElement> = new Map();\r\n  private dividers: HTMLElement[] = [];\r\n  private zoomText: HTMLElement | null = null;\r\n  \r\n  // Inline text editing\r\n  private inlineTextInput: HTMLDivElement | null = null;\r\n  private textStyleBar: HTMLElement | null = null;\r\n  private isAddingText = false;\r\n  \r\n  // Shape layer system\r\n  private shapeManager: ShapeLayerManager;\r\n  \r\n  // Image state\r\n  private hasRealImage = false;\r\n  private currentShapeId: string | null = null;\r\n  private isDraggingShape = false;\r\n  private dragStartPoint = { x: 0, y: 0 };\r\n  private originalImageData: ImageData | null = null;\r\n  private pureImageData: ImageData | null = null;  // Pure original image without any annotations (for eraser)\r\n\r\n  constructor(editor: Editor, container: HTMLElement, options: ToolbarOptions = {}) {\r\n    this.editor = editor;\r\n    this.options = { ...defaultOptions, ...options };\r\n    \r\n    // Initialize shape layer manager\r\n    this.shapeManager = new ShapeLayerManager();\r\n    this.shapeManager.setOnChange(() => this.renderAll());\r\n    \r\n    injectStyles();\r\n    \r\n    // Create wrapper\r\n    this.wrapper = document.createElement('div');\r\n    this.wrapper.className = 'ie-editor-wrapper';\r\n    \r\n    // Apply theme and primary color\r\n    this.applyTheme(this.options.theme || 'dark');\r\n    if (this.options.primaryColor) {\r\n      this.applyPrimaryColor(this.options.primaryColor);\r\n    }\r\n    \r\n    // Create canvas container\r\n    this.canvasContainer = document.createElement('div');\r\n    this.canvasContainer.className = 'ie-canvas-container';\r\n    \r\n    // Create viewport\r\n    this.viewport = document.createElement('div');\r\n    this.viewport.className = 'ie-canvas-viewport';\r\n    \r\n    // Move canvas to viewport\r\n    const canvas = editor.canvas;\r\n    if (canvas.parentElement) {\r\n      canvas.parentElement.removeChild(canvas);\r\n    }\r\n    this.viewport.appendChild(canvas);\r\n    this.canvasContainer.appendChild(this.viewport);\r\n    \r\n    // Create zoom badge\r\n    this.zoomBadge = document.createElement('div');\r\n    this.zoomBadge.className = 'ie-zoom-badge';\r\n    this.zoomBadge.textContent = '100%';\r\n    this.canvasContainer.appendChild(this.zoomBadge);\r\n    \r\n    this.wrapper.appendChild(this.canvasContainer);\r\n    \r\n    // Create toolbar\r\n    this.toolbar = this.createToolbar();\r\n    this.wrapper.appendChild(this.toolbar);\r\n    \r\n    // Add to container\r\n    container.appendChild(this.wrapper);\r\n    \r\n    // Setup events\r\n    this.setupEvents();\r\n    this.setupEditorEvents();\r\n    \r\n    // Set initial toolbar visibility\r\n    if (this.options.autoHide) {\r\n      this.setToolbarVisible(false);\r\n    }\r\n  }\r\n\r\n  private createToolbar(): HTMLElement {\r\n    const toolbar = document.createElement('div');\r\n    toolbar.className = 'ie-toolbar';\r\n    toolbar.style.position = 'relative';\r\n    const disabled = this.options.disabledTools || [];\r\n    \r\n    // Zoom controls (always create, respect disabledTools)\r\n    const zoomGroup = this.createGroup();\r\n    zoomGroup.className = 'ie-toolbar-group ie-zoom-group';\r\n    \r\n    const zoomOutBtn = this.createButton('zoomOut', icons.zoomOut, () => this.zoomOut());\r\n    if (disabled.includes('zoomOut')) zoomOutBtn.style.display = 'none';\r\n    zoomGroup.appendChild(zoomOutBtn);\r\n    \r\n    this.zoomText = document.createElement('span');\r\n    this.zoomText.className = 'ie-zoom-text';\r\n    this.zoomText.textContent = '100%';\r\n    zoomGroup.appendChild(this.zoomText);\r\n    \r\n    const zoomInBtn = this.createButton('zoomIn', icons.zoomIn, () => this.zoomIn());\r\n    if (disabled.includes('zoomIn')) zoomInBtn.style.display = 'none';\r\n    zoomGroup.appendChild(zoomInBtn);\r\n    \r\n    const resetBtn = this.createButton('reset', icons.reset, () => this.resetView());\r\n    if (disabled.includes('reset')) resetBtn.style.display = 'none';\r\n    zoomGroup.appendChild(resetBtn);\r\n    \r\n    this.groups.set('zoom', zoomGroup);\r\n    toolbar.appendChild(zoomGroup);\r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Tool controls (always create, respect disabledTools)\r\n    const toolGroup = this.createGroup();\r\n    toolGroup.className = 'ie-toolbar-group ie-tool-group';\r\n    \r\n    const moveBtn = this.createButton('move', icons.move, () => this.selectTool(null), true);\r\n    if (disabled.includes('move')) moveBtn.style.display = 'none';\r\n    toolGroup.appendChild(moveBtn);\r\n    \r\n    const penBtn = this.createButton('pen', icons.pen, () => this.selectTool('pen'));\r\n    if (disabled.includes('pen')) penBtn.style.display = 'none';\r\n    toolGroup.appendChild(penBtn);\r\n    \r\n    const rectBtn = this.createButton('rect', icons.rect, () => this.selectTool('rect'));\r\n    if (disabled.includes('rect')) rectBtn.style.display = 'none';\r\n    toolGroup.appendChild(rectBtn);\r\n    \r\n    const circleBtn = this.createButton('circle', icons.circle, () => this.selectTool('circle'));\r\n    if (disabled.includes('circle')) circleBtn.style.display = 'none';\r\n    toolGroup.appendChild(circleBtn);\r\n    \r\n    const arrowBtn = this.createButton('arrow', icons.arrow, () => this.selectTool('arrow'));\r\n    if (disabled.includes('arrow')) arrowBtn.style.display = 'none';\r\n    toolGroup.appendChild(arrowBtn);\r\n    \r\n    const lineBtn = this.createButton('line', icons.line, () => this.selectTool('line'));\r\n    if (disabled.includes('line')) lineBtn.style.display = 'none';\r\n    toolGroup.appendChild(lineBtn);\r\n    \r\n    const triangleBtn = this.createButton('triangle', icons.triangle, () => this.selectTool('triangle'));\r\n    if (disabled.includes('triangle')) triangleBtn.style.display = 'none';\r\n    toolGroup.appendChild(triangleBtn);\r\n    \r\n    const textBtn = this.createButton('text', icons.type, () => this.selectTool('text'));\r\n    if (disabled.includes('text')) textBtn.style.display = 'none';\r\n    toolGroup.appendChild(textBtn);\r\n    \r\n    const mosaicBtn = this.createButton('mosaic', icons.mosaic, () => this.selectTool('mosaic'));\r\n    if (disabled.includes('mosaic')) mosaicBtn.style.display = 'none';\r\n    toolGroup.appendChild(mosaicBtn);\r\n    \r\n    const eraserBtn = this.createButton('eraser', icons.eraser, () => this.selectTool('eraser'));\r\n    if (disabled.includes('eraser')) eraserBtn.style.display = 'none';\r\n    toolGroup.appendChild(eraserBtn);\r\n    \r\n    this.groups.set('tool', toolGroup);\r\n    toolbar.appendChild(toolGroup);\r\n    \r\n    // Crop and filter tools\r\n    const advancedGroup = this.createGroup();\r\n    advancedGroup.className = 'ie-toolbar-group ie-advanced-group';\r\n    \r\n    const cropBtn = this.createButton('crop', icons.crop, () => this.toggleCropTool());\r\n    if (disabled.includes('crop')) cropBtn.style.display = 'none';\r\n    advancedGroup.appendChild(cropBtn);\r\n    \r\n    const filterBtn = this.createButton('filter', icons.filter, () => this.toggleFilterPanel());\r\n    if (disabled.includes('filter')) filterBtn.style.display = 'none';\r\n    advancedGroup.appendChild(filterBtn);\r\n    \r\n    this.groups.set('advanced', advancedGroup);\r\n    toolbar.appendChild(advancedGroup);\r\n    \r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Create all settings panels (they are hidden until tool is selected)\r\n    this.createDrawPanel(toolbar);\r\n    this.createMosaicPanel(toolbar);\r\n    this.createTextPanel(toolbar);\r\n    this.createEraserPanel(toolbar);\r\n    this.createFilterPanel(toolbar);\r\n    \r\n    // History controls (always create, respect disabledTools)\r\n    const historyGroup = this.createGroup();\r\n    historyGroup.className = 'ie-toolbar-group ie-history-group';\r\n    \r\n    const undoBtn = this.createButton('undo', icons.undo, () => this.editor.undo(), false, true);\r\n    if (disabled.includes('undo')) undoBtn.style.display = 'none';\r\n    historyGroup.appendChild(undoBtn);\r\n    \r\n    const redoBtn = this.createButton('redo', icons.redo, () => this.editor.redo(), false, true);\r\n    if (disabled.includes('redo')) redoBtn.style.display = 'none';\r\n    historyGroup.appendChild(redoBtn);\r\n    \r\n    this.groups.set('history', historyGroup);\r\n    toolbar.appendChild(historyGroup);\r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Crop action buttons (hidden by default, shown when crop is active)\r\n    const cropActionGroup = document.createElement('div');\r\n    cropActionGroup.className = 'ie-toolbar-group ie-crop-action-group';\r\n    cropActionGroup.style.display = 'none';\r\n    \r\n    const cropCancelBtn = document.createElement('button');\r\n    cropCancelBtn.className = 'ie-btn ie-crop-toolbar-btn ie-crop-toolbar-cancel';\r\n    cropCancelBtn.innerHTML = `${icons.close}<span>取消</span>`;\r\n    cropCancelBtn.onclick = () => this.toggleCropTool();\r\n    cropActionGroup.appendChild(cropCancelBtn);\r\n    \r\n    const cropConfirmBtn = document.createElement('button');\r\n    cropConfirmBtn.className = 'ie-btn ie-crop-toolbar-btn ie-crop-toolbar-confirm';\r\n    cropConfirmBtn.innerHTML = `${icons.check}<span>确认裁剪</span>`;\r\n    cropConfirmBtn.onclick = () => this.applyCrop();\r\n    cropActionGroup.appendChild(cropConfirmBtn);\r\n    \r\n    this.groups.set('cropAction', cropActionGroup);\r\n    toolbar.appendChild(cropActionGroup);\r\n    this.buttons.set('cropActionGroup', cropCancelBtn); // Store reference\r\n    \r\n    this.dividers.push(this.createDivider());\r\n    toolbar.appendChild(this.dividers[this.dividers.length - 1]);\r\n    \r\n    // Export (always create, respect disabledTools)\r\n    const exportBtn = this.createButton('export', icons.download, () => this.exportImage());\r\n    exportBtn.classList.add('ie-btn-export');\r\n    const span = document.createElement('span');\r\n    span.textContent = '导出';\r\n    exportBtn.appendChild(span);\r\n    if (disabled.includes('export')) exportBtn.style.display = 'none';\r\n    toolbar.appendChild(exportBtn);\r\n    \r\n    // Initialize divider visibility based on disabled tools\r\n    this.updateDividerVisibility(disabled);\r\n    \r\n    return toolbar;\r\n  }\r\n\r\n  private createGroup(): HTMLElement {\r\n    const group = document.createElement('div');\r\n    group.className = 'ie-toolbar-group';\r\n    return group;\r\n  }\r\n\r\n  private createDivider(): HTMLElement {\r\n    const divider = document.createElement('div');\r\n    divider.className = 'ie-toolbar-divider';\r\n    return divider;\r\n  }\r\n\r\n  private createButton(\r\n    name: string,\r\n    icon: string,\r\n    onClick: () => void,\r\n    active = false,\r\n    isHistoryBtn = false\r\n  ): HTMLButtonElement {\r\n    const btn = document.createElement('button');\r\n    btn.className = 'ie-btn' + (active ? ' active' : '');\r\n    btn.innerHTML = icon;\r\n    btn.onclick = onClick;\r\n    \r\n    // Add tooltip\r\n    const tooltipInfo = this.getTooltipInfo(name);\r\n    const tooltip = document.createElement('div');\r\n    tooltip.className = 'ie-tooltip';\r\n    tooltip.innerHTML = `\r\n      <div class=\"ie-tooltip-title\">${tooltipInfo.title}</div>\r\n      ${tooltipInfo.desc ? `<div class=\"ie-tooltip-desc\">${tooltipInfo.desc}</div>` : ''}\r\n      ${tooltipInfo.shortcut ? `<div class=\"ie-tooltip-shortcut\">${tooltipInfo.shortcut}</div>` : ''}\r\n    `;\r\n    btn.appendChild(tooltip);\r\n    \r\n    if (isHistoryBtn) {\r\n      btn.disabled = true;\r\n    }\r\n    \r\n    this.buttons.set(name, btn);\r\n    return btn;\r\n  }\r\n\r\n  private getTooltipInfo(name: string): { title: string; desc?: string; shortcut?: string } {\r\n    const tooltips: Record<string, { title: string; desc?: string; shortcut?: string }> = {\r\n      zoomOut: { title: '缩小', desc: '缩小图片视图', shortcut: '-' },\r\n      zoomIn: { title: '放大', desc: '放大图片视图', shortcut: '+' },\r\n      reset: { title: '重置视图', desc: '恢复默认缩放和位置', shortcut: '0' },\r\n      move: { title: '移动', desc: '拖拽平移画布，点击选中形状', shortcut: 'V' },\r\n      pen: { title: '画笔', desc: '自由绘制线条', shortcut: 'P' },\r\n      rect: { title: '矩形', desc: '绘制矩形框', shortcut: 'R' },\r\n      circle: { title: '圆形', desc: '绘制圆形/椭圆', shortcut: 'O' },\r\n      arrow: { title: '箭头', desc: '绘制带箭头的线条', shortcut: 'A' },\r\n      line: { title: '直线', desc: '绘制直线', shortcut: 'L' },\r\n      triangle: { title: '三角形', desc: '绘制三角形' },\r\n      text: { title: '文字', desc: '添加文字标注', shortcut: 'T' },\r\n      mosaic: { title: '马赛克', desc: '模糊敏感区域', shortcut: 'M' },\r\n      eraser: { title: '橡皮擦', desc: '擦除文字和标记', shortcut: 'E' },\r\n      crop: { title: '裁剪', desc: '裁剪图片区域', shortcut: 'C' },\r\n      filter: { title: '滤镜', desc: '调整亮度/对比度/饱和度', shortcut: 'F' },\r\n      undo: { title: '撤销', desc: '撤销上一步操作', shortcut: 'Ctrl+Z' },\r\n      redo: { title: '重做', desc: '恢复撤销的操作', shortcut: 'Ctrl+Y' },\r\n      export: { title: '导出', desc: '保存图片到本地', shortcut: 'Ctrl+S' },\r\n    };\r\n    return tooltips[name] || { title: name };\r\n  }\r\n\r\n  /** Create drawing tools panel (shared by pen, rect, circle, arrow) */\r\n  private createDrawPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">绘图设置</div>\r\n      <div class=\"ie-panel-row\">\r\n        <span class=\"ie-panel-label\">线宽</span>\r\n        <div class=\"ie-size-control\">\r\n          <button class=\"ie-size-btn\" data-action=\"stroke-dec\">${icons.minus}</button>\r\n          <span class=\"ie-panel-value\" data-value=\"stroke-width\">${this.strokeWidth}px</span>\r\n          <button class=\"ie-size-btn\" data-action=\"stroke-inc\">${icons.plus}</button>\r\n        </div>\r\n      </div>\r\n      <div class=\"ie-panel-row\">\r\n        <span class=\"ie-panel-label\">颜色</span>\r\n        <div class=\"ie-color-row\">\r\n          <input type=\"color\" class=\"ie-color-input\" value=\"${this.strokeColor}\" data-input=\"stroke-color\">\r\n          <span class=\"ie-color-hex\" data-value=\"stroke-color\">${this.strokeColor}</span>\r\n        </div>\r\n      </div>\r\n    `;\r\n    \r\n    // Events\r\n    panel.querySelector('[data-action=\"stroke-dec\"]')?.addEventListener('click', () => {\r\n      this.strokeWidth = Math.max(1, this.strokeWidth - 1);\r\n      this.updateDrawPanelUI();\r\n    });\r\n    panel.querySelector('[data-action=\"stroke-inc\"]')?.addEventListener('click', () => {\r\n      this.strokeWidth = Math.min(20, this.strokeWidth + 1);\r\n      this.updateDrawPanelUI();\r\n    });\r\n    panel.querySelector('[data-input=\"stroke-color\"]')?.addEventListener('input', (e) => {\r\n      this.strokeColor = (e.target as HTMLInputElement).value;\r\n      this.updateDrawPanelUI();\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('draw', panel);\r\n  }\r\n  \r\n  private updateDrawPanelUI(): void {\r\n    const panel = this.panels.get('draw');\r\n    if (!panel) return;\r\n    \r\n    const widthEl = panel.querySelector('[data-value=\"stroke-width\"]');\r\n    const colorEl = panel.querySelector('[data-value=\"stroke-color\"]');\r\n    const colorInput = panel.querySelector('[data-input=\"stroke-color\"]') as HTMLInputElement;\r\n    \r\n    if (widthEl) widthEl.textContent = `${this.strokeWidth}px`;\r\n    if (colorEl) colorEl.textContent = this.strokeColor;\r\n    if (colorInput) colorInput.value = this.strokeColor;\r\n    \r\n    // Update brush cursor if visible\r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  /** Create mosaic settings panel */\r\n  private createMosaicPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-mosaic';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">马赛克设置</div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">笔刷大小</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"1\" max=\"20\" value=\"${this.strokeWidth}\" data-slider=\"mosaic-brush\">\r\n        <span class=\"ie-panel-value\" data-value=\"mosaic-brush\">${this.strokeWidth * 3}</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">色块大小</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"3\" max=\"30\" value=\"${this.mosaicSize}\" data-slider=\"mosaic-block\">\r\n        <span class=\"ie-panel-value\" data-value=\"mosaic-block\">${this.mosaicSize}</span>\r\n      </div>\r\n    `;\r\n    \r\n    // Events for brush size slider\r\n    panel.querySelector('[data-slider=\"mosaic-brush\"]')?.addEventListener('input', (e) => {\r\n      this.strokeWidth = parseInt((e.target as HTMLInputElement).value);\r\n      this.updateMosaicPanelUI();\r\n    });\r\n    \r\n    // Events for block size slider\r\n    panel.querySelector('[data-slider=\"mosaic-block\"]')?.addEventListener('input', (e) => {\r\n      this.mosaicSize = parseInt((e.target as HTMLInputElement).value);\r\n      this.updateMosaicPanelUI();\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('mosaic', panel);\r\n  }\r\n  \r\n  private updateMosaicPanelUI(): void {\r\n    const panel = this.panels.get('mosaic');\r\n    if (!panel) return;\r\n    \r\n    const brushEl = panel.querySelector('[data-value=\"mosaic-brush\"]');\r\n    const blockEl = panel.querySelector('[data-value=\"mosaic-block\"]');\r\n    const brushSlider = panel.querySelector('[data-slider=\"mosaic-brush\"]') as HTMLInputElement;\r\n    const blockSlider = panel.querySelector('[data-slider=\"mosaic-block\"]') as HTMLInputElement;\r\n    \r\n    if (brushEl) brushEl.textContent = String(this.strokeWidth * 3);\r\n    if (blockEl) blockEl.textContent = String(this.mosaicSize);\r\n    if (brushSlider) brushSlider.value = String(this.strokeWidth);\r\n    if (blockSlider) blockSlider.value = String(this.mosaicSize);\r\n    \r\n    // Update brush cursor\r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  private createTextPanel(_toolbar: HTMLElement): void {\r\n    // Text panel is now inline on the canvas, not in the toolbar\r\n    // Create a simple hint panel\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-text-hint';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-row\" style=\"color:var(--ie-text-muted);font-size:12px;text-align:center;\">\r\n        点击图片添加文字\r\n      </div>\r\n    `;\r\n    _toolbar.appendChild(panel);\r\n    this.panels.set('text', panel);\r\n  }\r\n\r\n  /** Create eraser panel */\r\n  private createEraserPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-eraser';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">橡皮擦设置</div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">笔刷大小</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"5\" max=\"50\" value=\"${this.eraserSize}\" data-slider=\"eraser-size\">\r\n        <span class=\"ie-panel-value\" data-value=\"eraser-size\">${this.eraserSize}</span>\r\n      </div>\r\n      <div class=\"ie-panel-row\">\r\n        <span class=\"ie-panel-label\">模式</span>\r\n        <div class=\"ie-btn-group\">\r\n          <button class=\"ie-mode-btn ${this.eraserMode === 'pixel' ? 'active' : ''}\" data-mode=\"pixel\">像素</button>\r\n          <button class=\"ie-mode-btn ${this.eraserMode === 'shape' ? 'active' : ''}\" data-mode=\"shape\">形状</button>\r\n        </div>\r\n      </div>\r\n    `;\r\n    \r\n    // Events\r\n    panel.querySelector('[data-slider=\"eraser-size\"]')?.addEventListener('input', (e) => {\r\n      this.eraserSize = parseInt((e.target as HTMLInputElement).value);\r\n      this.updateEraserPanelUI();\r\n    });\r\n    \r\n    panel.querySelectorAll('[data-mode]').forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        this.eraserMode = btn.getAttribute('data-mode') as 'pixel' | 'shape';\r\n        this.updateEraserPanelUI();\r\n      });\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('eraser', panel);\r\n  }\r\n  \r\n  private updateEraserPanelUI(): void {\r\n    const panel = this.panels.get('eraser');\r\n    if (!panel) return;\r\n    \r\n    const sizeEl = panel.querySelector('[data-value=\"eraser-size\"]');\r\n    const sizeSlider = panel.querySelector('[data-slider=\"eraser-size\"]') as HTMLInputElement;\r\n    \r\n    if (sizeEl) sizeEl.textContent = String(this.eraserSize);\r\n    if (sizeSlider) sizeSlider.value = String(this.eraserSize);\r\n    \r\n    // Update mode buttons\r\n    panel.querySelectorAll('[data-mode]').forEach(btn => {\r\n      btn.classList.toggle('active', btn.getAttribute('data-mode') === this.eraserMode);\r\n    });\r\n    \r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  /** Create filter panel */\r\n  private createFilterPanel(toolbar: HTMLElement): void {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-panel ie-panel-filter';\r\n    panel.style.display = 'none';\r\n    panel.innerHTML = `\r\n      <div class=\"ie-panel-title\">滤镜调整</div>\r\n      <div class=\"ie-filter-presets\">\r\n        <button class=\"ie-filter-preset\" data-preset=\"none\" title=\"原图\">原图</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"grayscale\" title=\"灰度\">灰度</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"sepia\" title=\"怀旧\">怀旧</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"invert\" title=\"反色\">反色</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"warm\" title=\"暖色\">暖色</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"cool\" title=\"冷色\">冷色</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"vivid\" title=\"鲜艳\">鲜艳</button>\r\n        <button class=\"ie-filter-preset\" data-preset=\"vintage\" title=\"复古\">复古</button>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">亮度</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"-100\" max=\"100\" value=\"0\" data-filter=\"brightness\">\r\n        <span class=\"ie-panel-value\" data-value=\"brightness\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">对比度</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"-100\" max=\"100\" value=\"0\" data-filter=\"contrast\">\r\n        <span class=\"ie-panel-value\" data-value=\"contrast\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">饱和度</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"-100\" max=\"100\" value=\"0\" data-filter=\"saturation\">\r\n        <span class=\"ie-panel-value\" data-value=\"saturation\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-slider-row\">\r\n        <span class=\"ie-panel-label\">模糊</span>\r\n        <input type=\"range\" class=\"ie-range-slider\" min=\"0\" max=\"20\" value=\"0\" data-filter=\"blur\">\r\n        <span class=\"ie-panel-value\" data-value=\"blur\">0</span>\r\n      </div>\r\n      <div class=\"ie-panel-row ie-btn-row\">\r\n        <button class=\"ie-btn-apply\" data-action=\"apply-filter\">应用</button>\r\n        <button class=\"ie-btn-reset\" data-action=\"reset-filter\">重置</button>\r\n      </div>\r\n    `;\r\n    \r\n    // Events for filter presets\r\n    panel.querySelectorAll('[data-preset]').forEach(btn => {\r\n      btn.addEventListener('click', (e) => {\r\n        const preset = (e.target as HTMLElement).getAttribute('data-preset') || 'none';\r\n        this.applyFilterPreset(preset);\r\n        // Highlight active preset\r\n        panel.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));\r\n        (e.target as HTMLElement).classList.add('active');\r\n      });\r\n    });\r\n    \r\n    // Events for sliders\r\n    panel.querySelectorAll('[data-filter]').forEach(slider => {\r\n      slider.addEventListener('input', (e) => {\r\n        const filterName = (e.target as HTMLInputElement).getAttribute('data-filter');\r\n        const value = (e.target as HTMLInputElement).value;\r\n        const valueEl = panel.querySelector(`[data-value=\"${filterName}\"]`);\r\n        if (valueEl) valueEl.textContent = value;\r\n        this.previewFilter();\r\n        // Clear preset highlight when manually adjusting\r\n        panel.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));\r\n      });\r\n    });\r\n    \r\n    // Apply button\r\n    panel.querySelector('[data-action=\"apply-filter\"]')?.addEventListener('click', () => {\r\n      this.applyFilter();\r\n    });\r\n    \r\n    // Reset button\r\n    panel.querySelector('[data-action=\"reset-filter\"]')?.addEventListener('click', () => {\r\n      this.resetFilterPanel();\r\n    });\r\n    \r\n    toolbar.appendChild(panel);\r\n    this.panels.set('filter', panel);\r\n  }\r\n  \r\n  private getFilterValues(): { brightness: number; contrast: number; saturation: number; blur: number } {\r\n    const panel = this.panels.get('filter');\r\n    if (!panel) return { brightness: 0, contrast: 0, saturation: 0, blur: 0 };\r\n    \r\n    return {\r\n      brightness: parseInt((panel.querySelector('[data-filter=\"brightness\"]') as HTMLInputElement)?.value || '0'),\r\n      contrast: parseInt((panel.querySelector('[data-filter=\"contrast\"]') as HTMLInputElement)?.value || '0'),\r\n      saturation: parseInt((panel.querySelector('[data-filter=\"saturation\"]') as HTMLInputElement)?.value || '0'),\r\n      blur: parseInt((panel.querySelector('[data-filter=\"blur\"]') as HTMLInputElement)?.value || '0'),\r\n    };\r\n  }\r\n  \r\n  private previewFilter(): void {\r\n    const { brightness, contrast, saturation, blur } = this.getFilterValues();\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas || !this.originalImageData) return;\r\n    \r\n    // Restore original image\r\n    ctx.putImageData(this.originalImageData, 0, 0);\r\n    \r\n    // Apply CSS filters for preview\r\n    const filters = [\r\n      `brightness(${100 + brightness}%)`,\r\n      `contrast(${100 + contrast}%)`,\r\n      `saturate(${100 + saturation}%)`,\r\n      blur > 0 ? `blur(${blur}px)` : '',\r\n    ].filter(Boolean).join(' ');\r\n    \r\n    ctx.filter = filters || 'none';\r\n    ctx.drawImage(canvas, 0, 0);\r\n    ctx.filter = 'none';\r\n  }\r\n  \r\n  private applyFilter(): void {\r\n    // The preview already drew the filtered result, just save it\r\n    this.saveOriginalImage();\r\n    this.resetFilterPanel();\r\n    (this.editor as any).saveToHistory?.('apply filter');\r\n  }\r\n  \r\n  private resetFilterPanel(): void {\r\n    const panel = this.panels.get('filter');\r\n    if (!panel) return;\r\n    \r\n    // Reset all sliders\r\n    panel.querySelectorAll<HTMLInputElement>('[data-filter]').forEach(slider => {\r\n      slider.value = '0';\r\n      const filterName = slider.getAttribute('data-filter');\r\n      const valueEl = panel.querySelector(`[data-value=\"${filterName}\"]`);\r\n      if (valueEl) valueEl.textContent = '0';\r\n    });\r\n    \r\n    // Reset preset buttons\r\n    panel.querySelectorAll('[data-preset]').forEach(b => b.classList.remove('active'));\r\n    panel.querySelector('[data-preset=\"none\"]')?.classList.add('active');\r\n    \r\n    // Restore original image\r\n    if (this.originalImageData) {\r\n      this.editor.ctx?.putImageData(this.originalImageData, 0, 0);\r\n    }\r\n  }\r\n  \r\n  /** Apply filter preset */\r\n  private applyFilterPreset(preset: string): void {\r\n    const panel = this.panels.get('filter');\r\n    if (!panel) return;\r\n    \r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas || !this.originalImageData) return;\r\n    \r\n    // Restore original image first\r\n    ctx.putImageData(this.originalImageData, 0, 0);\r\n    \r\n    // Get preset values\r\n    const presets: Record<string, { brightness: number; contrast: number; saturation: number; blur: number; css?: string }> = {\r\n      none: { brightness: 0, contrast: 0, saturation: 0, blur: 0 },\r\n      grayscale: { brightness: 0, contrast: 0, saturation: -100, blur: 0 },\r\n      sepia: { brightness: 0, contrast: 0, saturation: -30, blur: 0, css: 'sepia(80%)' },\r\n      invert: { brightness: 0, contrast: 0, saturation: 0, blur: 0, css: 'invert(100%)' },\r\n      warm: { brightness: 10, contrast: 10, saturation: 20, blur: 0, css: 'sepia(20%)' },\r\n      cool: { brightness: 0, contrast: 10, saturation: -10, blur: 0, css: 'hue-rotate(180deg) saturate(50%)' },\r\n      vivid: { brightness: 10, contrast: 30, saturation: 50, blur: 0 },\r\n      vintage: { brightness: -10, contrast: 20, saturation: -20, blur: 0, css: 'sepia(40%)' },\r\n    };\r\n    \r\n    const settings = presets[preset] || presets.none;\r\n    \r\n    // Update sliders\r\n    const brightnessSlider = panel.querySelector('[data-filter=\"brightness\"]') as HTMLInputElement;\r\n    const contrastSlider = panel.querySelector('[data-filter=\"contrast\"]') as HTMLInputElement;\r\n    const saturationSlider = panel.querySelector('[data-filter=\"saturation\"]') as HTMLInputElement;\r\n    const blurSlider = panel.querySelector('[data-filter=\"blur\"]') as HTMLInputElement;\r\n    \r\n    if (brightnessSlider) {\r\n      brightnessSlider.value = String(settings.brightness);\r\n      const val = panel.querySelector('[data-value=\"brightness\"]');\r\n      if (val) val.textContent = String(settings.brightness);\r\n    }\r\n    if (contrastSlider) {\r\n      contrastSlider.value = String(settings.contrast);\r\n      const val = panel.querySelector('[data-value=\"contrast\"]');\r\n      if (val) val.textContent = String(settings.contrast);\r\n    }\r\n    if (saturationSlider) {\r\n      saturationSlider.value = String(settings.saturation);\r\n      const val = panel.querySelector('[data-value=\"saturation\"]');\r\n      if (val) val.textContent = String(settings.saturation);\r\n    }\r\n    if (blurSlider) {\r\n      blurSlider.value = String(settings.blur);\r\n      const val = panel.querySelector('[data-value=\"blur\"]');\r\n      if (val) val.textContent = String(settings.blur);\r\n    }\r\n    \r\n    // Apply preview with CSS filter\r\n    const filters = [\r\n      `brightness(${100 + settings.brightness}%)`,\r\n      `contrast(${100 + settings.contrast}%)`,\r\n      `saturate(${100 + settings.saturation}%)`,\r\n      settings.blur > 0 ? `blur(${settings.blur}px)` : '',\r\n      settings.css || '',\r\n    ].filter(Boolean).join(' ');\r\n    \r\n    ctx.filter = filters || 'none';\r\n    ctx.drawImage(canvas, 0, 0);\r\n    ctx.filter = 'none';\r\n  }\r\n\r\n  private updateTextUI(): void {\r\n    // Update text style bar if visible\r\n    this.updateTextStyleBar();\r\n    // Apply to current editing text\r\n    this.applyTextStyle();\r\n  }\r\n\r\n  private showPanel(name: string | null): void {\r\n    this.panels.forEach((panel, key) => {\r\n      if (key === name) {\r\n        // Show with animation\r\n        panel.style.display = 'block';\r\n        panel.classList.remove('ie-panel-hidden');\r\n      } else if (panel.style.display !== 'none') {\r\n        // Hide with animation\r\n        panel.classList.add('ie-panel-hidden');\r\n        // Hide after animation completes\r\n        setTimeout(() => {\r\n          if (panel.classList.contains('ie-panel-hidden')) {\r\n            panel.style.display = 'none';\r\n          }\r\n        }, 200);\r\n      }\r\n    });\r\n    this.activePanel = name;\r\n  }\r\n  \r\n  /** Hide all panels */\r\n  private hideAllPanels(): void {\r\n    this.showPanel(null);\r\n  }\r\n\r\n  private setupEvents(): void {\r\n    // Wheel zoom - disabled when showing placeholder\r\n    this.canvasContainer.addEventListener('wheel', (e) => {\r\n      if (!this.hasRealImage) return; // Disable zoom for placeholder\r\n      e.preventDefault();\r\n      const delta = e.deltaY > 0 ? 0.9 : 1.1;\r\n      this.setScale(this.scale * delta, e.clientX, e.clientY);\r\n    }, { passive: false });\r\n    \r\n    // Pointer down - handle pan, drawing, or shape selection/dragging\r\n    this.canvasContainer.addEventListener('pointerdown', (e) => {\r\n      if (!this.hasRealImage) return; // Disable interactions for placeholder\r\n      \r\n      const pos = this.clientToCanvasCoords(e.clientX, e.clientY);\r\n      \r\n      // Drawing tools\r\n      if (this.isDrawingTool(this.currentTool)) {\r\n        this.startDrawing(pos);\r\n        this.canvasContainer.setPointerCapture(e.pointerId);\r\n      } else if (!this.currentTool || this.currentTool === '') {\r\n        // Move mode - check for shape selection first\r\n        const shape = this.shapeManager.findShapeAtPoint(pos.x, pos.y, 8);\r\n        if (shape) {\r\n          // Select and start dragging shape\r\n          this.shapeManager.selectShape(shape.id);\r\n          this.isDraggingShape = true;\r\n          this.dragStartPoint = pos;\r\n          this.canvasContainer.classList.add('grabbing');\r\n          this.canvasContainer.setPointerCapture(e.pointerId);\r\n        } else {\r\n          // Deselect any selected shape and start panning\r\n          this.shapeManager.selectShape(null);\r\n          this.isPanning = true;\r\n          this.lastPanPoint = { x: e.clientX, y: e.clientY };\r\n          this.canvasContainer.classList.add('grabbing');\r\n          this.canvasContainer.setPointerCapture(e.pointerId);\r\n        }\r\n      }\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointermove', (e) => {\r\n      // Default cursor for placeholder\r\n      if (!this.hasRealImage) {\r\n        this.canvasContainer.style.cursor = 'default';\r\n        return;\r\n      }\r\n      \r\n      const pos = this.clientToCanvasCoords(e.clientX, e.clientY);\r\n      \r\n      // Update brush cursor position\r\n      if (this.brushCursor && this.isDrawingTool(this.currentTool)) {\r\n        this.updateBrushCursorPosition(e.clientX, e.clientY);\r\n      }\r\n      \r\n      if (this.isDrawing) {\r\n        this.continueDrawing(pos);\r\n      } else if (this.isDraggingShape) {\r\n        // Drag selected shape\r\n        const selected = this.shapeManager.getSelectedShape();\r\n        if (selected) {\r\n          const dx = pos.x - this.dragStartPoint.x;\r\n          const dy = pos.y - this.dragStartPoint.y;\r\n          this.shapeManager.moveShape(selected.id, dx, dy);\r\n          this.dragStartPoint = pos;\r\n        }\r\n      } else if (this.isPanning) {\r\n        this.translateX += e.clientX - this.lastPanPoint.x;\r\n        this.translateY += e.clientY - this.lastPanPoint.y;\r\n        this.lastPanPoint = { x: e.clientX, y: e.clientY };\r\n        this.updateTransform();\r\n      } else if (!this.currentTool || this.currentTool === '') {\r\n        // Move mode - update cursor based on hovering over shape\r\n        const shape = this.shapeManager.findShapeAtPoint(pos.x, pos.y, 8);\r\n        this.canvasContainer.style.cursor = shape ? 'move' : 'grab';\r\n      }\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointerup', (e) => {\r\n      if (this.isDrawing) {\r\n        this.endDrawing();\r\n      }\r\n      if (this.isDraggingShape) {\r\n        this.isDraggingShape = false;\r\n        (this.editor as any).saveToHistory?.('move shape');\r\n      }\r\n      this.isPanning = false;\r\n      this.canvasContainer.classList.remove('grabbing');\r\n      this.canvasContainer.releasePointerCapture(e.pointerId);\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointerleave', () => {\r\n      if (this.brushCursor) {\r\n        this.brushCursor.style.display = 'none';\r\n      }\r\n    });\r\n    \r\n    this.canvasContainer.addEventListener('pointerenter', () => {\r\n      if (this.brushCursor && this.isDrawingTool(this.currentTool)) {\r\n        this.brushCursor.style.display = 'block';\r\n      }\r\n    });\r\n    \r\n    // Text tool click\r\n    this.canvasContainer.addEventListener('click', (e) => {\r\n      if (this.currentTool !== 'text') return;\r\n      if (this.isAddingText) return;\r\n      \r\n      const pos = this.clientToCanvasCoords(e.clientX, e.clientY);\r\n      this.showInlineTextInput(e.clientX, e.clientY, pos);\r\n    });\r\n    \r\n    // Keyboard events for delete\r\n    document.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Delete' || e.key === 'Backspace') {\r\n        // Don't delete if we're editing text\r\n        if (this.isAddingText || document.activeElement?.tagName === 'INPUT' || document.activeElement?.tagName === 'TEXTAREA') {\r\n          return;\r\n        }\r\n        const selected = this.shapeManager.getSelectedShape();\r\n        if (selected) {\r\n          e.preventDefault();\r\n          this.shapeManager.deleteShape(selected.id);\r\n          (this.editor as any).saveToHistory?.('delete shape');\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Touch events for pinch-to-zoom and two-finger pan\r\n    this.canvasContainer.addEventListener('touchstart', (e) => {\r\n      if (!this.hasRealImage) return;\r\n      \r\n      if (e.touches.length === 2) {\r\n        e.preventDefault();\r\n        // Pinch gesture start\r\n        const touch1 = e.touches[0];\r\n        const touch2 = e.touches[1];\r\n        this.touchStartDistance = Math.hypot(\r\n          touch2.clientX - touch1.clientX,\r\n          touch2.clientY - touch1.clientY\r\n        );\r\n        this.touchStartScale = this.scale;\r\n        this.touchStartCenter = {\r\n          x: (touch1.clientX + touch2.clientX) / 2,\r\n          y: (touch1.clientY + touch2.clientY) / 2\r\n        };\r\n        this.lastTouchCenter = { ...this.touchStartCenter };\r\n        this.isTouchPanning = true;\r\n      }\r\n    }, { passive: false });\r\n    \r\n    this.canvasContainer.addEventListener('touchmove', (e) => {\r\n      if (!this.hasRealImage) return;\r\n      \r\n      if (e.touches.length === 2 && this.touchStartDistance > 0) {\r\n        e.preventDefault();\r\n        const touch1 = e.touches[0];\r\n        const touch2 = e.touches[1];\r\n        \r\n        // Calculate new distance for pinch zoom\r\n        const currentDistance = Math.hypot(\r\n          touch2.clientX - touch1.clientX,\r\n          touch2.clientY - touch1.clientY\r\n        );\r\n        const scaleRatio = currentDistance / this.touchStartDistance;\r\n        const newScale = Math.max(0.1, Math.min(5, this.touchStartScale * scaleRatio));\r\n        \r\n        // Calculate center point for zoom\r\n        const currentCenter = {\r\n          x: (touch1.clientX + touch2.clientX) / 2,\r\n          y: (touch1.clientY + touch2.clientY) / 2\r\n        };\r\n        \r\n        // Apply zoom at center point\r\n        this.setScale(newScale, currentCenter.x, currentCenter.y);\r\n        \r\n        // Also apply pan from center movement\r\n        if (this.isTouchPanning) {\r\n          this.translateX += currentCenter.x - this.lastTouchCenter.x;\r\n          this.translateY += currentCenter.y - this.lastTouchCenter.y;\r\n          this.updateTransform();\r\n        }\r\n        \r\n        this.lastTouchCenter = currentCenter;\r\n      }\r\n    }, { passive: false });\r\n    \r\n    this.canvasContainer.addEventListener('touchend', (e) => {\r\n      if (e.touches.length < 2) {\r\n        this.touchStartDistance = 0;\r\n        this.isTouchPanning = false;\r\n      }\r\n    });\r\n    \r\n    // Click outside to close panels\r\n    document.addEventListener('click', (e) => {\r\n      if (this.activePanel) {\r\n        const target = e.target as HTMLElement;\r\n        // Check if click is outside panels and toolbar buttons\r\n        const isInPanel = target.closest('.ie-panel');\r\n        const isToolbarBtn = target.closest('.ie-btn');\r\n        if (!isInPanel && !isToolbarBtn) {\r\n          this.hideAllPanels();\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Drag and drop support\r\n    this.setupDropZone();\r\n  }\r\n  \r\n  private dropZone: HTMLElement | null = null;\r\n  \r\n  private setupDropZone(): void {\r\n    // Create drop zone overlay\r\n    this.dropZone = document.createElement('div');\r\n    this.dropZone.className = 'ie-drop-zone';\r\n    this.dropZone.innerHTML = `\r\n      <div class=\"ie-drop-zone-icon\">\r\n        <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n          <path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/>\r\n          <polyline points=\"17 8 12 3 7 8\"/>\r\n          <line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/>\r\n        </svg>\r\n      </div>\r\n      <div class=\"ie-drop-zone-text\">松开鼠标上传图片</div>\r\n      <div class=\"ie-drop-zone-hint\">支持 PNG、JPG、GIF 等格式</div>\r\n    `;\r\n    this.canvasContainer.appendChild(this.dropZone);\r\n    \r\n    // Drag enter\r\n    this.canvasContainer.addEventListener('dragenter', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      if (this.isImageDrag(e)) {\r\n        this.dropZone?.classList.add('active');\r\n      }\r\n    });\r\n    \r\n    // Drag over\r\n    this.canvasContainer.addEventListener('dragover', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      if (this.isImageDrag(e)) {\r\n        e.dataTransfer!.dropEffect = 'copy';\r\n        this.dropZone?.classList.add('active');\r\n      }\r\n    });\r\n    \r\n    // Drag leave\r\n    this.canvasContainer.addEventListener('dragleave', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      // Only hide if leaving the container completely\r\n      const rect = this.canvasContainer.getBoundingClientRect();\r\n      if (e.clientX <= rect.left || e.clientX >= rect.right ||\r\n          e.clientY <= rect.top || e.clientY >= rect.bottom) {\r\n        this.dropZone?.classList.remove('active');\r\n      }\r\n    });\r\n    \r\n    // Drop\r\n    this.canvasContainer.addEventListener('drop', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      this.dropZone?.classList.remove('active');\r\n      \r\n      const file = e.dataTransfer?.files?.[0];\r\n      if (file?.type.startsWith('image/')) {\r\n        this.loadImageFile(file);\r\n      }\r\n    });\r\n  }\r\n  \r\n  private isImageDrag(e: DragEvent): boolean {\r\n    if (!e.dataTransfer) return false;\r\n    // Check if dragging files\r\n    if (e.dataTransfer.types.includes('Files')) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n  \r\n  private loadImageFile(file: File): void {\r\n    const reader = new FileReader();\r\n    reader.onload = (e) => {\r\n      const dataUrl = e.target?.result as string;\r\n      if (dataUrl) {\r\n        this.editor.loadImage(dataUrl);\r\n      }\r\n    };\r\n    reader.readAsDataURL(file);\r\n  }\r\n  \r\n  private isDrawingTool(tool: string | null): boolean {\r\n    return ['pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'mosaic', 'eraser'].includes(tool || '');\r\n  }\r\n  \r\n  /** Check if tool creates shapes (vs direct canvas drawing like mosaic) */\r\n  private isShapeTool(tool: string | null): boolean {\r\n    return ['pen', 'rect', 'circle', 'arrow', 'line', 'triangle'].includes(tool || '');\r\n  }\r\n  \r\n  private startDrawing(pos: { x: number; y: number }): void {\r\n    this.isDrawing = true;\r\n    this.drawStartPoint = pos;\r\n    this.lastDrawPoint = pos;\r\n    \r\n    const style = { strokeColor: this.strokeColor, strokeWidth: this.strokeWidth };\r\n    \r\n    // Create shape via manager for shape tools\r\n    if (this.isShapeTool(this.currentTool)) {\r\n      const type = this.currentTool as 'pen' | 'rect' | 'circle' | 'arrow' | 'line' | 'triangle';\r\n      this.currentShapeId = this.shapeManager.createShape(type, style);\r\n      \r\n      // Initialize shape data\r\n      if (type === 'pen') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as PenShape;\r\n        if (shape) {\r\n          shape.points = [{ x: pos.x, y: pos.y }];\r\n        }\r\n      } else if (type === 'rect') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as RectShape;\r\n        if (shape) {\r\n          shape.x = pos.x;\r\n          shape.y = pos.y;\r\n          shape.width = 0;\r\n          shape.height = 0;\r\n        }\r\n      } else if (type === 'circle') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as CircleShape;\r\n        if (shape) {\r\n          shape.cx = pos.x;\r\n          shape.cy = pos.y;\r\n          shape.rx = 0;\r\n          shape.ry = 0;\r\n        }\r\n      } else if (type === 'arrow' || type === 'line') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as ArrowShape | LineShape;\r\n        if (shape) {\r\n          shape.start = { x: pos.x, y: pos.y };\r\n          shape.end = { x: pos.x, y: pos.y };\r\n        }\r\n      } else if (type === 'triangle') {\r\n        const shape = this.shapeManager.getShape(this.currentShapeId) as TriangleShape;\r\n        if (shape) {\r\n          // Initialize triangle with start point\r\n          shape.points = [{ x: pos.x, y: pos.y }, { x: pos.x, y: pos.y }, { x: pos.x, y: pos.y }];\r\n        }\r\n      }\r\n    } else if (this.currentTool === 'mosaic') {\r\n      // Mosaic draws directly to canvas (not as a shape)\r\n      this.applyMosaicAt(pos.x, pos.y);\r\n    } else if (this.currentTool === 'eraser') {\r\n      this.applyEraserAt(pos.x, pos.y);\r\n    }\r\n  }\r\n  \r\n  private continueDrawing(pos: { x: number; y: number }): void {\r\n    if (!this.isDrawing) return;\r\n    \r\n    if (this.isShapeTool(this.currentTool) && this.currentShapeId) {\r\n      const shape = this.shapeManager.getShape(this.currentShapeId);\r\n      if (!shape) return;\r\n      \r\n      switch (this.currentTool) {\r\n        case 'pen': {\r\n          const s = shape as PenShape;\r\n          s.points.push({ x: pos.x, y: pos.y });\r\n          break;\r\n        }\r\n        case 'rect': {\r\n          const s = shape as RectShape;\r\n          s.x = Math.min(this.drawStartPoint.x, pos.x);\r\n          s.y = Math.min(this.drawStartPoint.y, pos.y);\r\n          s.width = Math.abs(pos.x - this.drawStartPoint.x);\r\n          s.height = Math.abs(pos.y - this.drawStartPoint.y);\r\n          break;\r\n        }\r\n        case 'circle': {\r\n          const s = shape as CircleShape;\r\n          s.cx = (this.drawStartPoint.x + pos.x) / 2;\r\n          s.cy = (this.drawStartPoint.y + pos.y) / 2;\r\n          s.rx = Math.abs(pos.x - this.drawStartPoint.x) / 2;\r\n          s.ry = Math.abs(pos.y - this.drawStartPoint.y) / 2;\r\n          break;\r\n        }\r\n        case 'arrow':\r\n        case 'line': {\r\n          const s = shape as ArrowShape | LineShape;\r\n          s.end = { x: pos.x, y: pos.y };\r\n          break;\r\n        }\r\n        case 'triangle': {\r\n          const s = shape as TriangleShape;\r\n          // Create isoceles triangle based on drag\r\n          const midX = (this.drawStartPoint.x + pos.x) / 2;\r\n          s.points = [\r\n            { x: midX, y: this.drawStartPoint.y },  // Top vertex\r\n            { x: this.drawStartPoint.x, y: pos.y }, // Bottom left\r\n            { x: pos.x, y: pos.y }                   // Bottom right\r\n          ];\r\n          break;\r\n        }\r\n      }\r\n      \r\n      this.renderAll();\r\n      this.lastDrawPoint = pos;\r\n    } else if (this.currentTool === 'mosaic') {\r\n      this.interpolateMosaic(this.lastDrawPoint.x, this.lastDrawPoint.y, pos.x, pos.y);\r\n      this.lastDrawPoint = pos;\r\n    } else if (this.currentTool === 'eraser') {\r\n      this.interpolateEraser(this.lastDrawPoint.x, this.lastDrawPoint.y, pos.x, pos.y);\r\n      this.lastDrawPoint = pos;\r\n    }\r\n  }\r\n  \r\n  private endDrawing(): void {\r\n    if (!this.isDrawing) return;\r\n    \r\n    // Finalize shape - check if it's too small and should be deleted\r\n    if (this.isShapeTool(this.currentTool) && this.currentShapeId) {\r\n      const shape = this.shapeManager.getShape(this.currentShapeId);\r\n      if (shape) {\r\n        const bounds = this.shapeManager.getShapeBounds(shape);\r\n        // Delete shape if it's too small (less than 3px in any dimension)\r\n        if (bounds && bounds.width < 3 && bounds.height < 3) {\r\n          this.shapeManager.deleteShape(this.currentShapeId);\r\n        }\r\n      }\r\n    } else if (this.currentTool === 'mosaic' || this.currentTool === 'eraser') {\r\n      // Mosaic/Eraser modifies canvas directly, update originalImageData so shapes don't overwrite it\r\n      this.saveOriginalImage();\r\n    }\r\n    \r\n    this.isDrawing = false;\r\n    this.currentShapeId = null;\r\n    (this.editor as any).saveToHistory?.(this.currentTool + ' draw');\r\n  }\r\n  \r\n  /** Convert client coordinates to canvas coordinates */\r\n  private clientToCanvasCoords(clientX: number, clientY: number): { x: number; y: number } {\r\n    const rect = this.canvasContainer.getBoundingClientRect();\r\n    const canvas = this.editor.canvas;\r\n    const centerX = rect.width / 2;\r\n    const centerY = rect.height / 2;\r\n    const x = (clientX - rect.left - centerX - this.translateX) / this.scale + canvas.width / 2;\r\n    const y = (clientY - rect.top - centerY - this.translateY) / this.scale + canvas.height / 2;\r\n    return { x, y };\r\n  }\r\n  \r\n  // ============ Mosaic Tool Methods ============\r\n  \r\n  /** Apply mosaic at a point */\r\n  private applyMosaicAt(x: number, y: number): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    const radius = this.strokeWidth * 3;\r\n    this.applyMosaicCircle(imageData, x, y, radius, this.mosaicSize);\r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n  \r\n  /** Interpolate mosaic stroke */\r\n  private interpolateMosaic(x1: number, y1: number, x2: number, y2: number): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    const radius = this.strokeWidth * 3;\r\n    const dist = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);\r\n    const step = radius / 2;\r\n    const steps = Math.max(1, Math.ceil(dist / step));\r\n    \r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    for (let i = 0; i <= steps; i++) {\r\n      const t = i / steps;\r\n      const x = x1 + (x2 - x1) * t;\r\n      const y = y1 + (y2 - y1) * t;\r\n      this.applyMosaicCircle(imageData, x, y, radius, this.mosaicSize);\r\n    }\r\n    \r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n  \r\n  /** Apply mosaic effect in a circular region */\r\n  private applyMosaicCircle(imageData: ImageData, cx: number, cy: number, radius: number, blockSize: number): void {\r\n    const { width, height, data } = imageData;\r\n    \r\n    const minX = Math.max(0, Math.floor(cx - radius));\r\n    const maxX = Math.min(width - 1, Math.ceil(cx + radius));\r\n    const minY = Math.max(0, Math.floor(cy - radius));\r\n    const maxY = Math.min(height - 1, Math.ceil(cy + radius));\r\n    \r\n    for (let by = minY; by <= maxY; by += blockSize) {\r\n      for (let bx = minX; bx <= maxX; bx += blockSize) {\r\n        const bcx = bx + blockSize / 2;\r\n        const bcy = by + blockSize / 2;\r\n        const dist = Math.sqrt((bcx - cx) ** 2 + (bcy - cy) ** 2);\r\n        if (dist > radius) continue;\r\n        \r\n        let r = 0, g = 0, b = 0, count = 0;\r\n        const blockEndX = Math.min(bx + blockSize, maxX + 1);\r\n        const blockEndY = Math.min(by + blockSize, maxY + 1);\r\n        \r\n        for (let py = by; py < blockEndY; py++) {\r\n          for (let px = bx; px < blockEndX; px++) {\r\n            const idx = (py * width + px) * 4;\r\n            r += data[idx];\r\n            g += data[idx + 1];\r\n            b += data[idx + 2];\r\n            count++;\r\n          }\r\n        }\r\n        \r\n        if (count > 0) {\r\n          r = Math.round(r / count);\r\n          g = Math.round(g / count);\r\n          b = Math.round(b / count);\r\n          \r\n          for (let py = by; py < blockEndY; py++) {\r\n            for (let px = bx; px < blockEndX; px++) {\r\n              const pDist = Math.sqrt((px - cx) ** 2 + (py - cy) ** 2);\r\n              if (pDist <= radius) {\r\n                const idx = (py * width + px) * 4;\r\n                data[idx] = r;\r\n                data[idx + 1] = g;\r\n                data[idx + 2] = b;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private setupEditorEvents(): void {\r\n    this.editor.on('tool-change', ({ tool }) => {\r\n      this.currentTool = tool || null;\r\n      this.updateToolButtons();\r\n      this.updateCursor();\r\n    });\r\n    \r\n    this.editor.on('history-change', ({ canUndo, canRedo }) => {\r\n      const undoBtn = this.buttons.get('undo');\r\n      const redoBtn = this.buttons.get('redo');\r\n      if (undoBtn) undoBtn.disabled = !canUndo;\r\n      if (redoBtn) redoBtn.disabled = !canRedo;\r\n    });\r\n    \r\n    // Save original image when image is loaded\r\n    this.editor.on('image-loaded', () => {\r\n      // Delay slightly to ensure canvas is fully rendered\r\n      setTimeout(() => {\r\n        // Save pure image for eraser tool (only if not already saved)\r\n        if (!this.pureImageData) {\r\n          this.savePureImage();\r\n        }\r\n        this.saveOriginalImage();\r\n      }, 50);\r\n    });\r\n  }\r\n\r\n  private updateToolButtons(): void {\r\n    // Clear all active states\r\n    const toolButtons = ['move', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'text', 'mosaic', 'eraser', 'crop', 'filter'];\r\n    this.buttons.forEach((btn, name) => {\r\n      if (toolButtons.includes(name)) {\r\n        btn.classList.toggle('active', \r\n          (name === 'move' && !this.currentTool) ||\r\n          (name === this.currentTool)\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  private updateCursor(): void {\r\n    // Remove all tool cursor classes\r\n    this.canvasContainer.classList.remove('tool-draw', 'tool-text', 'tool-move');\r\n    // Reset inline style cursor\r\n    this.canvasContainer.style.cursor = '';\r\n    \r\n    // Remove existing brush cursor\r\n    if (this.brushCursor) {\r\n      this.brushCursor.remove();\r\n      this.brushCursor = null;\r\n    }\r\n    \r\n    if (this.isDrawingTool(this.currentTool)) {\r\n      this.canvasContainer.classList.add('tool-draw');\r\n      if (['pen', 'mosaic', 'eraser'].includes(this.currentTool || '')) {\r\n        this.createBrushCursor();\r\n      }\r\n    } else if (this.currentTool === 'text') {\r\n      this.canvasContainer.classList.add('tool-text');\r\n    } else {\r\n      // Move mode - default grab cursor, will change to move when hovering over shapes\r\n      this.canvasContainer.classList.add('tool-move');\r\n    }\r\n  }\r\n  \r\n  /** Create custom brush cursor */\r\n  private createBrushCursor(): void {\r\n    this.brushCursor = document.createElement('div');\r\n    this.brushCursor.className = 'ie-brush-cursor';\r\n    this.updateBrushCursorSize();\r\n    this.canvasContainer.appendChild(this.brushCursor);\r\n  }\r\n  \r\n  /** Update brush cursor size */\r\n  private updateBrushCursorSize(): void {\r\n    if (!this.brushCursor) return;\r\n    let baseSize: number;\r\n    if (this.currentTool === 'mosaic') {\r\n      baseSize = this.strokeWidth * 6;\r\n    } else if (this.currentTool === 'eraser') {\r\n      baseSize = this.eraserSize;\r\n    } else {\r\n      baseSize = this.strokeWidth * 2;\r\n    }\r\n    const size = baseSize * this.scale;\r\n    this.brushCursor.style.width = `${size}px`;\r\n    this.brushCursor.style.height = `${size}px`;\r\n  }\r\n  \r\n  /** Update brush cursor position */\r\n  private updateBrushCursorPosition(clientX: number, clientY: number): void {\r\n    if (!this.brushCursor) return;\r\n    const rect = this.canvasContainer.getBoundingClientRect();\r\n    const x = clientX - rect.left;\r\n    const y = clientY - rect.top;\r\n    this.brushCursor.style.left = `${x}px`;\r\n    this.brushCursor.style.top = `${y}px`;\r\n  }\r\n\r\n  private selectTool(tool: string | null): void {\r\n    if (tool === this.currentTool) {\r\n      // Toggle panel for tools that have one\r\n      const panelName = this.getPanelNameForTool(tool);\r\n      if (panelName && this.activePanel === panelName) {\r\n        this.showPanel(null);\r\n      } else if (panelName) {\r\n        this.showPanel(panelName);\r\n      }\r\n      return;\r\n    }\r\n    \r\n    this.editor.setTool(tool || '');\r\n    this.currentTool = tool;\r\n    this.updateToolButtons();\r\n    this.updateCursor();\r\n    \r\n    // Show corresponding panel\r\n    const panelName = this.getPanelNameForTool(tool);\r\n    if (panelName) {\r\n      this.showPanel(panelName);\r\n    } else {\r\n      this.showPanel(null);\r\n    }\r\n  }\r\n  \r\n  private getPanelNameForTool(tool: string | null): string | null {\r\n    if (!tool) return null;\r\n    if (['pen', 'rect', 'circle', 'arrow', 'line', 'triangle'].includes(tool)) return 'draw';\r\n    if (tool === 'mosaic') return 'mosaic';\r\n    if (tool === 'text') return 'text';\r\n    if (tool === 'eraser') return 'eraser';\r\n    if (tool === 'filter') return 'filter';\r\n    return null;\r\n  }\r\n\r\n  /** Show inline text input at click position */\r\n  private showInlineTextInput(clientX: number, clientY: number, canvasPos: { x: number; y: number }): void {\r\n    this.isAddingText = true;\r\n    \r\n    // Create inline input container\r\n    this.inlineTextInput = document.createElement('div');\r\n    this.inlineTextInput.className = 'ie-inline-text-container';\r\n    \r\n    // Position relative to canvas container\r\n    const rect = this.canvasContainer.getBoundingClientRect();\r\n    const left = clientX - rect.left;\r\n    const top = clientY - rect.top;\r\n    \r\n    this.inlineTextInput.style.left = `${left}px`;\r\n    this.inlineTextInput.style.top = `${top}px`;\r\n    \r\n    // Create editable text area\r\n    const textArea = document.createElement('div');\r\n    textArea.className = 'ie-inline-text-input';\r\n    textArea.contentEditable = 'true';\r\n    textArea.style.fontSize = `${this.textSize * this.scale}px`;\r\n    textArea.style.color = this.textColor;\r\n    textArea.setAttribute('data-placeholder', '输入文字...');\r\n    \r\n    this.inlineTextInput.appendChild(textArea);\r\n    this.canvasContainer.appendChild(this.inlineTextInput);\r\n    \r\n    // Create style bar\r\n    this.createTextStyleBar();\r\n    \r\n    // Focus and select\r\n    textArea.focus();\r\n    \r\n    // Store canvas position\r\n    (this.inlineTextInput as any).__canvasPos = canvasPos;\r\n    \r\n    // Events\r\n    textArea.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Escape') {\r\n        this.cancelInlineText();\r\n      } else if (e.key === 'Enter' && !e.shiftKey) {\r\n        e.preventDefault();\r\n        this.confirmInlineText();\r\n      }\r\n    });\r\n    \r\n    textArea.addEventListener('input', () => {\r\n      this.updateTextStyleBarPosition();\r\n    });\r\n    \r\n    // Click outside to confirm\r\n    setTimeout(() => {\r\n      document.addEventListener('pointerdown', this.handleOutsideClick);\r\n    }, 100);\r\n  }\r\n  \r\n  private handleOutsideClick = (e: PointerEvent): void => {\r\n    if (!this.inlineTextInput) return;\r\n    \r\n    const target = e.target as HTMLElement;\r\n    if (!this.inlineTextInput.contains(target) && \r\n        !this.textStyleBar?.contains(target)) {\r\n      this.confirmInlineText();\r\n    }\r\n  };\r\n  \r\n  /** Create floating text style bar */\r\n  private createTextStyleBar(): void {\r\n    if (this.textStyleBar) {\r\n      this.textStyleBar.remove();\r\n    }\r\n    \r\n    this.textStyleBar = document.createElement('div');\r\n    this.textStyleBar.className = 'ie-text-style-bar';\r\n    this.textStyleBar.innerHTML = `\r\n      <select class=\"ie-style-select\" data-input=\"font\" title=\"字体\">\r\n        <option value=\"sans-serif\">默认</option>\r\n        <option value=\"serif\">衬线</option>\r\n        <option value=\"monospace\">等宽</option>\r\n        <option value=\"cursive\">手写</option>\r\n        <option value=\"'Microsoft YaHei', sans-serif\">微软雅黑</option>\r\n        <option value=\"'SimSun', serif\">宋体</option>\r\n        <option value=\"'KaiTi', serif\">楷体</option>\r\n      </select>\r\n      <span class=\"ie-style-divider\"></span>\r\n      <button class=\"ie-style-btn\" data-action=\"size-dec\" title=\"减小字号\">${icons.minus}</button>\r\n      <span class=\"ie-style-value\" data-value=\"size\">${this.textSize}</span>\r\n      <button class=\"ie-style-btn\" data-action=\"size-inc\" title=\"增大字号\">${icons.plus}</button>\r\n      <span class=\"ie-style-divider\"></span>\r\n      <button class=\"ie-style-btn ${this.textBold ? 'active' : ''}\" data-action=\"bold\" title=\"粗体\">${icons.bold}</button>\r\n      <button class=\"ie-style-btn ${this.textItalic ? 'active' : ''}\" data-action=\"italic\" title=\"斜体\">${icons.italic}</button>\r\n      <button class=\"ie-style-btn ${this.textUnderline ? 'active' : ''}\" data-action=\"underline\" title=\"下划线\">${icons.underline}</button>\r\n      <span class=\"ie-style-divider\"></span>\r\n      <input type=\"color\" class=\"ie-style-color\" value=\"${this.textColor}\" data-input=\"color\" title=\"文字颜色\">\r\n      <span class=\"ie-style-divider\"></span>\r\n      <button class=\"ie-style-btn ie-style-confirm\" data-action=\"confirm\" title=\"确认\">${icons.check}</button>\r\n    `;\r\n    \r\n    // Set current font\r\n    const fontSelect = this.textStyleBar.querySelector('[data-input=\"font\"]') as HTMLSelectElement;\r\n    if (fontSelect) fontSelect.value = this.textFontFamily;\r\n    \r\n    // Bind events\r\n    fontSelect?.addEventListener('change', (e) => {\r\n      e.stopPropagation();\r\n      this.textFontFamily = (e.target as HTMLSelectElement).value;\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"size-dec\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textSize = Math.max(12, this.textSize - 2);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"size-inc\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textSize = Math.min(72, this.textSize + 2);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"bold\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textBold = !this.textBold;\r\n      (e.target as HTMLElement).closest('.ie-style-btn')?.classList.toggle('active', this.textBold);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"italic\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textItalic = !this.textItalic;\r\n      (e.target as HTMLElement).closest('.ie-style-btn')?.classList.toggle('active', this.textItalic);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"underline\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.textUnderline = !this.textUnderline;\r\n      (e.target as HTMLElement).closest('.ie-style-btn')?.classList.toggle('active', this.textUnderline);\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-input=\"color\"]')?.addEventListener('input', (e) => {\r\n      e.stopPropagation();\r\n      this.textColor = (e.target as HTMLInputElement).value;\r\n      this.updateTextUI();\r\n    });\r\n    \r\n    this.textStyleBar.querySelector('[data-action=\"confirm\"]')?.addEventListener('click', (e) => {\r\n      e.stopPropagation();\r\n      this.confirmInlineText();\r\n    });\r\n    \r\n    this.canvasContainer.appendChild(this.textStyleBar);\r\n    this.updateTextStyleBarPosition();\r\n  }\r\n  \r\n  /** Update style bar position */\r\n  private updateTextStyleBarPosition(): void {\r\n    if (!this.textStyleBar || !this.inlineTextInput) return;\r\n    \r\n    const rect = this.inlineTextInput.getBoundingClientRect();\r\n    const containerRect = this.canvasContainer.getBoundingClientRect();\r\n    \r\n    let left = rect.left - containerRect.left;\r\n    let top = rect.top - containerRect.top - 40;\r\n    \r\n    // Keep within bounds\r\n    if (top < 5) top = rect.bottom - containerRect.top + 5;\r\n    if (left < 5) left = 5;\r\n    \r\n    this.textStyleBar.style.left = `${left}px`;\r\n    this.textStyleBar.style.top = `${top}px`;\r\n  }\r\n  \r\n  /** Update text style bar values */\r\n  private updateTextStyleBar(): void {\r\n    if (!this.textStyleBar) return;\r\n    \r\n    const sizeEl = this.textStyleBar.querySelector('[data-value=\"size\"]');\r\n    const colorInput = this.textStyleBar.querySelector('[data-input=\"color\"]') as HTMLInputElement;\r\n    \r\n    if (sizeEl) sizeEl.textContent = String(this.textSize);\r\n    if (colorInput) colorInput.value = this.textColor;\r\n  }\r\n  \r\n  /** Apply text style to current editing text */\r\n  private applyTextStyle(): void {\r\n    if (!this.inlineTextInput) return;\r\n    \r\n    const textArea = this.inlineTextInput.querySelector('.ie-inline-text-input') as HTMLElement;\r\n    if (textArea) {\r\n      textArea.style.fontSize = `${this.textSize * this.scale}px`;\r\n      textArea.style.color = this.textColor;\r\n      textArea.style.fontFamily = this.textFontFamily;\r\n      textArea.style.fontWeight = this.textBold ? 'bold' : 'normal';\r\n      textArea.style.fontStyle = this.textItalic ? 'italic' : 'normal';\r\n      textArea.style.textDecoration = this.textUnderline ? 'underline' : 'none';\r\n    }\r\n  }\r\n  \r\n  /** Cancel inline text editing */\r\n  private cancelInlineText(): void {\r\n    document.removeEventListener('pointerdown', this.handleOutsideClick);\r\n    \r\n    if (this.inlineTextInput) {\r\n      this.inlineTextInput.remove();\r\n      this.inlineTextInput = null;\r\n    }\r\n    if (this.textStyleBar) {\r\n      this.textStyleBar.remove();\r\n      this.textStyleBar = null;\r\n    }\r\n    this.isAddingText = false;\r\n  }\r\n  \r\n  /** Confirm and add text to canvas */\r\n  private confirmInlineText(): void {\r\n    if (!this.inlineTextInput) return;\r\n    \r\n    const textArea = this.inlineTextInput.querySelector('.ie-inline-text-input') as HTMLElement;\r\n    const text = textArea?.textContent?.trim() || '';\r\n    const canvasPos = (this.inlineTextInput as any).__canvasPos as { x: number; y: number };\r\n    \r\n    document.removeEventListener('pointerdown', this.handleOutsideClick);\r\n    \r\n    if (text && canvasPos) {\r\n      // Draw text directly to canvas with all style options\r\n      const ctx = this.editor.ctx;\r\n      if (ctx) {\r\n        ctx.save();\r\n        const fontStyle = this.textItalic ? 'italic' : 'normal';\r\n        const fontWeight = this.textBold ? 'bold' : 'normal';\r\n        ctx.font = `${fontStyle} ${fontWeight} ${this.textSize}px ${this.textFontFamily}`;\r\n        ctx.fillStyle = this.textColor;\r\n        ctx.textBaseline = 'top';\r\n        ctx.fillText(text, canvasPos.x, canvasPos.y);\r\n        \r\n        // Draw underline if enabled\r\n        if (this.textUnderline) {\r\n          const metrics = ctx.measureText(text);\r\n          ctx.strokeStyle = this.textColor;\r\n          ctx.lineWidth = Math.max(1, this.textSize / 15);\r\n          ctx.beginPath();\r\n          ctx.moveTo(canvasPos.x, canvasPos.y + this.textSize + 2);\r\n          ctx.lineTo(canvasPos.x + metrics.width, canvasPos.y + this.textSize + 2);\r\n          ctx.stroke();\r\n        }\r\n        ctx.restore();\r\n        \r\n        // Save to history\r\n        this.saveOriginalImage();\r\n        (this.editor as any).saveToHistory?.('add text');\r\n      }\r\n    }\r\n    \r\n    // Cleanup\r\n    if (this.inlineTextInput) {\r\n      this.inlineTextInput.remove();\r\n      this.inlineTextInput = null;\r\n    }\r\n    if (this.textStyleBar) {\r\n      this.textStyleBar.remove();\r\n      this.textStyleBar = null;\r\n    }\r\n    this.isAddingText = false;\r\n  }\r\n\r\n  // ============ Crop Tool ============\r\n  \r\n  /** Toggle crop tool */\r\n  private toggleCropTool(): void {\r\n    if (this.isCropActive) {\r\n      this.hideCropOverlay();\r\n    } else {\r\n      this.showCropOverlay();\r\n    }\r\n    this.isCropActive = !this.isCropActive;\r\n    this.buttons.get('crop')?.classList.toggle('active', this.isCropActive);\r\n    \r\n    // Show/hide crop action buttons in toolbar\r\n    const cropActionGroup = this.groups.get('cropAction');\r\n    if (cropActionGroup) {\r\n      cropActionGroup.style.display = this.isCropActive ? 'flex' : 'none';\r\n    }\r\n    \r\n    // Update divider visibility\r\n    this.updateDividerVisibility(this.options.disabledTools || []);\r\n  }\r\n  \r\n  /** Show crop overlay */\r\n  private showCropOverlay(): void {\r\n    if (this.cropOverlay) return;\r\n    \r\n    const canvas = this.editor.canvas;\r\n    \r\n    this.cropOverlay = document.createElement('div');\r\n    this.cropOverlay.className = 'ie-crop-overlay';\r\n    \r\n    // Initialize crop box at 80% of canvas size, centered\r\n    const margin = 0.1;\r\n    const boxWidth = canvas.width * (1 - margin * 2);\r\n    const boxHeight = canvas.height * (1 - margin * 2);\r\n    const boxX = canvas.width * margin;\r\n    const boxY = canvas.height * margin;\r\n    \r\n    this.cropOverlay.innerHTML = `\r\n      <div class=\"ie-crop-mask ie-crop-mask-top\"></div>\r\n      <div class=\"ie-crop-mask ie-crop-mask-left\"></div>\r\n      <div class=\"ie-crop-mask ie-crop-mask-right\"></div>\r\n      <div class=\"ie-crop-mask ie-crop-mask-bottom\"></div>\r\n      <div class=\"ie-crop-box\" style=\"left:${boxX}px;top:${boxY}px;width:${boxWidth}px;height:${boxHeight}px;\">\r\n        <div class=\"ie-crop-grid\">\r\n          <div class=\"ie-crop-grid-h\"></div>\r\n          <div class=\"ie-crop-grid-h\"></div>\r\n          <div class=\"ie-crop-grid-v\"></div>\r\n          <div class=\"ie-crop-grid-v\"></div>\r\n        </div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-nw\" data-handle=\"nw\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-n\" data-handle=\"n\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-ne\" data-handle=\"ne\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-e\" data-handle=\"e\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-se\" data-handle=\"se\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-s\" data-handle=\"s\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-sw\" data-handle=\"sw\"></div>\r\n        <div class=\"ie-crop-handle ie-crop-handle-w\" data-handle=\"w\"></div>\r\n      </div>\r\n      <div class=\"ie-crop-actions\">\r\n        <button class=\"ie-crop-btn ie-crop-btn-cancel\" data-action=\"cancel\">取消</button>\r\n        <button class=\"ie-crop-btn ie-crop-btn-apply\" data-action=\"apply\">\r\n          <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"20 6 9 17 4 12\"/></svg>\r\n          裁剪\r\n        </button>\r\n      </div>\r\n    `;\r\n    \r\n    // Add to viewport\r\n    this.viewport.appendChild(this.cropOverlay);\r\n    \r\n    // Setup crop events\r\n    this.setupCropEvents();\r\n  }\r\n  \r\n  /** Setup crop overlay events */\r\n  private setupCropEvents(): void {\r\n    if (!this.cropOverlay) return;\r\n    \r\n    const cropBox = this.cropOverlay.querySelector('.ie-crop-box') as HTMLElement;\r\n    let isDragging = false;\r\n    let isResizing = false;\r\n    let activeHandle = '';\r\n    let startX = 0, startY = 0;\r\n    let startLeft = 0, startTop = 0, startWidth = 0, startHeight = 0;\r\n    \r\n    // Handle drag\r\n    cropBox.addEventListener('pointerdown', (e) => {\r\n      if ((e.target as HTMLElement).classList.contains('ie-crop-handle')) return;\r\n      e.stopPropagation();\r\n      isDragging = true;\r\n      startX = e.clientX;\r\n      startY = e.clientY;\r\n      startLeft = cropBox.offsetLeft;\r\n      startTop = cropBox.offsetTop;\r\n      cropBox.setPointerCapture(e.pointerId);\r\n    });\r\n    \r\n    // Handle resize\r\n    this.cropOverlay.querySelectorAll('.ie-crop-handle').forEach(handle => {\r\n      handle.addEventListener('pointerdown', (e) => {\r\n        e.stopPropagation();\r\n        isResizing = true;\r\n        activeHandle = (e.target as HTMLElement).getAttribute('data-handle') || '';\r\n        startX = (e as PointerEvent).clientX;\r\n        startY = (e as PointerEvent).clientY;\r\n        startLeft = cropBox.offsetLeft;\r\n        startTop = cropBox.offsetTop;\r\n        startWidth = cropBox.offsetWidth;\r\n        startHeight = cropBox.offsetHeight;\r\n        (handle as HTMLElement).setPointerCapture((e as PointerEvent).pointerId);\r\n      });\r\n    });\r\n    \r\n    // Move handler\r\n    this.cropOverlay.addEventListener('pointermove', (e) => {\r\n      if (!isDragging && !isResizing) return;\r\n      \r\n      const dx = (e.clientX - startX) / this.scale;\r\n      const dy = (e.clientY - startY) / this.scale;\r\n      const canvas = this.editor.canvas;\r\n      \r\n      if (isDragging) {\r\n        let newLeft = startLeft + dx;\r\n        let newTop = startTop + dy;\r\n        // Constrain to canvas bounds\r\n        newLeft = Math.max(0, Math.min(newLeft, canvas.width - cropBox.offsetWidth));\r\n        newTop = Math.max(0, Math.min(newTop, canvas.height - cropBox.offsetHeight));\r\n        cropBox.style.left = `${newLeft}px`;\r\n        cropBox.style.top = `${newTop}px`;\r\n      } else if (isResizing) {\r\n        let newLeft = startLeft, newTop = startTop, newWidth = startWidth, newHeight = startHeight;\r\n        \r\n        if (activeHandle.includes('e')) { newWidth = Math.max(50, startWidth + dx); }\r\n        if (activeHandle.includes('w')) { newWidth = Math.max(50, startWidth - dx); newLeft = startLeft + dx; }\r\n        if (activeHandle.includes('s')) { newHeight = Math.max(50, startHeight + dy); }\r\n        if (activeHandle.includes('n')) { newHeight = Math.max(50, startHeight - dy); newTop = startTop + dy; }\r\n        \r\n        // Constrain to canvas bounds\r\n        if (newLeft < 0) { newWidth += newLeft; newLeft = 0; }\r\n        if (newTop < 0) { newHeight += newTop; newTop = 0; }\r\n        if (newLeft + newWidth > canvas.width) newWidth = canvas.width - newLeft;\r\n        if (newTop + newHeight > canvas.height) newHeight = canvas.height - newTop;\r\n        \r\n        cropBox.style.left = `${newLeft}px`;\r\n        cropBox.style.top = `${newTop}px`;\r\n        cropBox.style.width = `${newWidth}px`;\r\n        cropBox.style.height = `${newHeight}px`;\r\n      }\r\n      \r\n      this.updateCropMask();\r\n    });\r\n    \r\n    // End handler\r\n    this.cropOverlay.addEventListener('pointerup', () => {\r\n      isDragging = false;\r\n      isResizing = false;\r\n      activeHandle = '';\r\n    });\r\n    \r\n    // Control buttons\r\n    this.cropOverlay.querySelector('[data-action=\"cancel\"]')?.addEventListener('click', () => {\r\n      this.toggleCropTool();\r\n    });\r\n    \r\n    this.cropOverlay.querySelector('[data-action=\"apply\"]')?.addEventListener('click', () => {\r\n      this.applyCrop();\r\n    });\r\n    \r\n    // Initial mask update\r\n    this.updateCropMask();\r\n  }\r\n  \r\n  /** Update crop mask to show cropped area */\r\n  private updateCropMask(): void {\r\n    if (!this.cropOverlay) return;\r\n    const cropBox = this.cropOverlay.querySelector('.ie-crop-box') as HTMLElement;\r\n    if (!cropBox) return;\r\n    \r\n    const canvas = this.editor.canvas;\r\n    const left = cropBox.offsetLeft;\r\n    const top = cropBox.offsetTop;\r\n    const width = cropBox.offsetWidth;\r\n    const height = cropBox.offsetHeight;\r\n    \r\n    // Update 4 mask blocks to surround the crop box\r\n    const maskTop = this.cropOverlay.querySelector('.ie-crop-mask-top') as HTMLElement;\r\n    const maskLeft = this.cropOverlay.querySelector('.ie-crop-mask-left') as HTMLElement;\r\n    const maskRight = this.cropOverlay.querySelector('.ie-crop-mask-right') as HTMLElement;\r\n    const maskBottom = this.cropOverlay.querySelector('.ie-crop-mask-bottom') as HTMLElement;\r\n    \r\n    if (maskTop) {\r\n      maskTop.style.cssText = `left:0;top:0;width:${canvas.width}px;height:${top}px;`;\r\n    }\r\n    if (maskLeft) {\r\n      maskLeft.style.cssText = `left:0;top:${top}px;width:${left}px;height:${height}px;`;\r\n    }\r\n    if (maskRight) {\r\n      maskRight.style.cssText = `left:${left + width}px;top:${top}px;width:${canvas.width - left - width}px;height:${height}px;`;\r\n    }\r\n    if (maskBottom) {\r\n      maskBottom.style.cssText = `left:0;top:${top + height}px;width:${canvas.width}px;height:${canvas.height - top - height}px;`;\r\n    }\r\n  }\r\n  \r\n  /** Apply crop to canvas */\r\n  private applyCrop(): void {\r\n    if (!this.cropOverlay) return;\r\n    const cropBox = this.cropOverlay.querySelector('.ie-crop-box') as HTMLElement;\r\n    if (!cropBox) return;\r\n    \r\n    const x = cropBox.offsetLeft;\r\n    const y = cropBox.offsetTop;\r\n    const width = cropBox.offsetWidth;\r\n    const height = cropBox.offsetHeight;\r\n    \r\n    // Get cropped image data\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    // Save current state to history BEFORE crop (so we can undo)\r\n    (this.editor as any).saveToHistory?.('before crop');\r\n    \r\n    // Fade out entire crop overlay\r\n    this.cropOverlay.style.transition = 'opacity 0.25s ease-out';\r\n    this.cropOverlay.style.opacity = '0';\r\n    \r\n    // After fade out, apply the actual crop\r\n    setTimeout(() => {\r\n      const croppedData = ctx.getImageData(x, y, width, height);\r\n      \r\n      // Resize canvas\r\n      canvas.width = width;\r\n      canvas.height = height;\r\n      \r\n      // Draw cropped image\r\n      ctx.putImageData(croppedData, 0, 0);\r\n      \r\n      // Update original image data\r\n      this.saveOriginalImage();\r\n      this.savePureImage();\r\n      \r\n      // Hide crop overlay (no animation since already faded)\r\n      if (this.cropOverlay) {\r\n        this.cropOverlay.remove();\r\n        this.cropOverlay = null;\r\n      }\r\n      this.isCropActive = false;\r\n      this.buttons.get('crop')?.classList.remove('active');\r\n      \r\n      // Hide crop action buttons in toolbar\r\n      const cropActionGroup = this.groups.get('cropAction');\r\n      if (cropActionGroup) {\r\n        cropActionGroup.style.display = 'none';\r\n      }\r\n      \r\n      // Update divider visibility\r\n      this.updateDividerVisibility(this.options.disabledTools || []);\r\n      \r\n      // Reset view with animation\r\n      this.viewport.style.transition = 'transform 0.3s ease-out';\r\n      this.resetView();\r\n      \r\n      // Remove transition after animation\r\n      setTimeout(() => {\r\n        this.viewport.style.transition = 'none';\r\n      }, 300);\r\n    }, 250);\r\n  }\r\n  \r\n  /** Hide crop overlay */\r\n  private hideCropOverlay(): void {\r\n    if (this.cropOverlay) {\r\n      // Add fade out animation\r\n      this.cropOverlay.style.transition = 'opacity 0.2s ease-out';\r\n      this.cropOverlay.style.opacity = '0';\r\n      \r\n      setTimeout(() => {\r\n        if (this.cropOverlay) {\r\n          this.cropOverlay.remove();\r\n          this.cropOverlay = null;\r\n        }\r\n      }, 200);\r\n    }\r\n  }\r\n\r\n  // ============ Filter Tool ============\r\n  \r\n  /** Toggle filter panel */\r\n  private toggleFilterPanel(): void {\r\n    const filterPanel = this.panels.get('filter');\r\n    if (!filterPanel) return;\r\n    \r\n    if (this.activePanel === 'filter') {\r\n      this.showPanel(null);\r\n      this.buttons.get('filter')?.classList.remove('active');\r\n    } else {\r\n      this.showPanel('filter');\r\n      this.buttons.get('filter')?.classList.add('active');\r\n    }\r\n  }\r\n\r\n  // ============ Eraser Tool ============\r\n  \r\n  /** Apply eraser at position - restores original image pixels */\r\n  private applyEraserAt(x: number, y: number): void {\r\n    if (this.eraserMode === 'shape') {\r\n      // Shape mode: delete shape under cursor\r\n      const shape = this.shapeManager.findShapeAtPoint(x, y, this.eraserSize / 2);\r\n      if (shape) {\r\n        this.shapeManager.deleteShape(shape.id);\r\n      }\r\n    } else {\r\n      // Pixel mode: restore original image pixels in the eraser area\r\n      this.restoreOriginalPixels(x, y, this.eraserSize / 2);\r\n    }\r\n  }\r\n  \r\n  /** Restore original image pixels in a circular area */\r\n  private restoreOriginalPixels(cx: number, cy: number, radius: number): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    const pureData = this.pureImageData;\r\n    \r\n    if (!ctx || !canvas || !pureData) {\r\n      console.warn('[Eraser] Missing required data, skipping restore');\r\n      return;\r\n    }\r\n    \r\n    const radiusSq = radius * radius;\r\n    const minX = Math.max(0, Math.floor(cx - radius));\r\n    const maxX = Math.min(canvas.width - 1, Math.ceil(cx + radius));\r\n    const minY = Math.max(0, Math.floor(cy - radius));\r\n    const maxY = Math.min(canvas.height - 1, Math.ceil(cy + radius));\r\n    \r\n    const regionWidth = maxX - minX + 1;\r\n    const regionHeight = maxY - minY + 1;\r\n    \r\n    if (regionWidth <= 0 || regionHeight <= 0) return;\r\n    \r\n    // Get current canvas data\r\n    const currentData = ctx.getImageData(minX, minY, regionWidth, regionHeight);\r\n    const currentPixels = currentData.data;\r\n    const purePixels = pureData.data;\r\n    const pureWidth = pureData.width;\r\n    \r\n    let pixelsChanged = 0;\r\n    \r\n    // Restore pixels within the circle\r\n    for (let py = minY; py <= maxY; py++) {\r\n      for (let px = minX; px <= maxX; px++) {\r\n        const dx = px - cx;\r\n        const dy = py - cy;\r\n        const distSq = dx * dx + dy * dy;\r\n        \r\n        if (distSq <= radiusSq) {\r\n          // Inside the eraser circle - restore from pure image\r\n          const pureIdx = (py * pureWidth + px) * 4;\r\n          const currentIdx = ((py - minY) * regionWidth + (px - minX)) * 4;\r\n          \r\n          // Check if pixel is different\r\n          if (currentPixels[currentIdx] !== purePixels[pureIdx] ||\r\n              currentPixels[currentIdx + 1] !== purePixels[pureIdx + 1] ||\r\n              currentPixels[currentIdx + 2] !== purePixels[pureIdx + 2] ||\r\n              currentPixels[currentIdx + 3] !== purePixels[pureIdx + 3]) {\r\n            pixelsChanged++;\r\n          }\r\n          \r\n          // Apply smooth edge (anti-aliasing)\r\n          const dist = Math.sqrt(distSq);\r\n          const edgeFade = Math.min(1, (radius - dist) / 2);\r\n          \r\n          if (edgeFade >= 1) {\r\n            // Full restore\r\n            currentPixels[currentIdx] = purePixels[pureIdx];\r\n            currentPixels[currentIdx + 1] = purePixels[pureIdx + 1];\r\n            currentPixels[currentIdx + 2] = purePixels[pureIdx + 2];\r\n            currentPixels[currentIdx + 3] = purePixels[pureIdx + 3];\r\n          } else {\r\n            // Blend for smooth edges\r\n            currentPixels[currentIdx] = Math.round(currentPixels[currentIdx] * (1 - edgeFade) + purePixels[pureIdx] * edgeFade);\r\n            currentPixels[currentIdx + 1] = Math.round(currentPixels[currentIdx + 1] * (1 - edgeFade) + purePixels[pureIdx + 1] * edgeFade);\r\n            currentPixels[currentIdx + 2] = Math.round(currentPixels[currentIdx + 2] * (1 - edgeFade) + purePixels[pureIdx + 2] * edgeFade);\r\n            currentPixels[currentIdx + 3] = Math.round(currentPixels[currentIdx + 3] * (1 - edgeFade) + purePixels[pureIdx + 3] * edgeFade);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (pixelsChanged > 0) {\r\n      console.log('[Eraser] Restoring', pixelsChanged, 'different pixels');\r\n    }\r\n    \r\n    ctx.putImageData(currentData, minX, minY);\r\n  }\r\n  \r\n  /** Interpolate eraser stroke */\r\n  private interpolateEraser(x1: number, y1: number, x2: number, y2: number): void {\r\n    const dist = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);\r\n    const step = Math.max(1, this.eraserSize / 6); // Smaller step for smoother strokes\r\n    const steps = Math.max(1, Math.ceil(dist / step));\r\n    \r\n    for (let i = 0; i <= steps; i++) {\r\n      const t = i / steps;\r\n      const x = x1 + (x2 - x1) * t;\r\n      const y = y1 + (y2 - y1) * t;\r\n      this.applyEraserAt(x, y);\r\n    }\r\n  }\r\n\r\n  // Zoom methods\r\n  private setScale(newScale: number, clientX?: number, clientY?: number): void {\r\n    newScale = Math.max(0.1, Math.min(5, newScale));\r\n    \r\n    if (clientX !== undefined && clientY !== undefined) {\r\n      const rect = this.canvasContainer.getBoundingClientRect();\r\n      const mouseX = clientX - rect.left - rect.width / 2;\r\n      const mouseY = clientY - rect.top - rect.height / 2;\r\n      \r\n      const scaleDiff = newScale - this.scale;\r\n      this.translateX -= mouseX * scaleDiff / this.scale;\r\n      this.translateY -= mouseY * scaleDiff / this.scale;\r\n    }\r\n    \r\n    this.scale = newScale;\r\n    this.updateTransform();\r\n  }\r\n\r\n  private updateTransform(): void {\r\n    this.viewport.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;\r\n    const percent = Math.round(this.scale * 100);\r\n    if (this.zoomText) this.zoomText.textContent = `${percent}%`;\r\n    this.zoomBadge.textContent = `${percent}%`;\r\n    // Update brush cursor size based on new scale\r\n    this.updateBrushCursorSize();\r\n  }\r\n\r\n  private zoomIn(): void {\r\n    this.setScale(this.scale * 1.25);\r\n  }\r\n\r\n  private zoomOut(): void {\r\n    this.setScale(this.scale / 1.25);\r\n  }\r\n\r\n  private resetView(): void {\r\n    this.scale = 1;\r\n    this.translateX = 0;\r\n    this.translateY = 0;\r\n    this.updateTransform();\r\n  }\r\n\r\n  private async exportImage(): Promise<void> {\r\n    try {\r\n      const data = await this.editor.export({\r\n        format: 'png',\r\n        quality: 0.95,\r\n        type: 'base64',\r\n      });\r\n      \r\n      const link = document.createElement('a');\r\n      link.href = data as string;\r\n      link.download = `image-${Date.now()}.png`;\r\n      link.click();\r\n    } catch (err) {\r\n      console.error('Export failed:', err);\r\n    }\r\n  }\r\n\r\n  /** Apply theme to editor */\r\n  private applyTheme(theme: 'light' | 'dark' | 'auto'): void {\r\n    let resolvedTheme: 'light' | 'dark' = theme === 'auto' \r\n      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')\r\n      : theme;\r\n    \r\n    this.wrapper.classList.remove('ie-theme-light', 'ie-theme-dark');\r\n    this.wrapper.classList.add(`ie-theme-${resolvedTheme}`);\r\n  }\r\n  \r\n  /** Set theme at runtime */\r\n  setTheme(theme: 'light' | 'dark' | 'auto'): void {\r\n    this.options.theme = theme;\r\n    this.applyTheme(theme);\r\n    \r\n    // Update placeholder if showing\r\n    if (!this.hasRealImage) {\r\n      this.showPlaceholder();\r\n    }\r\n  }\r\n  \r\n  /** Apply primary color */\r\n  private applyPrimaryColor(color: string): void {\r\n    this.wrapper.style.setProperty('--ie-primary', color);\r\n    this.wrapper.style.setProperty('--ie-btn-active-bg', color);\r\n  }\r\n  \r\n  /** Set primary color at runtime */\r\n  setPrimaryColor(color: string): void {\r\n    this.options.primaryColor = color;\r\n    this.applyPrimaryColor(color);\r\n  }\r\n  \r\n  /** Get current theme */\r\n  getTheme(): 'light' | 'dark' | 'auto' {\r\n    return this.options.theme || 'dark';\r\n  }\r\n  \r\n  /** Update disabled tools list at runtime */\r\n  setDisabledTools(disabledTools: ToolName[]): void {\r\n    this.options.disabledTools = disabledTools;\r\n    \r\n    // All toggleable buttons\r\n    const allToggleableButtons: ToolName[] = [\r\n      'move', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'text', 'mosaic', 'eraser', 'crop', 'filter',  // Drawing tools\r\n      'zoomIn', 'zoomOut', 'reset',  // Zoom controls\r\n      'undo', 'redo',  // History controls\r\n      'export',  // Export button\r\n    ];\r\n    \r\n    for (const btnName of allToggleableButtons) {\r\n      const btn = this.buttons.get(btnName);\r\n      if (btn) {\r\n        if (disabledTools.includes(btnName)) {\r\n          btn.style.display = 'none';\r\n        } else {\r\n          btn.style.display = '';\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Handle zoom text visibility (shown only if any zoom button is visible)\r\n    if (this.zoomText) {\r\n      const zoomHidden = disabledTools.includes('zoomIn') && \r\n                         disabledTools.includes('zoomOut') && \r\n                         disabledTools.includes('reset');\r\n      this.zoomText.style.display = zoomHidden ? 'none' : '';\r\n    }\r\n    \r\n    // If current tool is now disabled, close its panel\r\n    if (this.activePanel) {\r\n      const panel = this.panels.get(this.activePanel);\r\n      if (panel) {\r\n        panel.style.display = 'none';\r\n      }\r\n      this.activePanel = null;\r\n    }\r\n    \r\n    // If current tool is now disabled, switch to move tool (if move is available)\r\n    if (this.currentTool && disabledTools.includes(this.currentTool as ToolName)) {\r\n      if (!disabledTools.includes('move')) {\r\n        this.selectTool(null);\r\n      } else {\r\n        this.currentTool = null;\r\n      }\r\n    }\r\n    \r\n    // Update divider visibility based on adjacent groups\r\n    this.updateDividerVisibility(disabledTools);\r\n  }\r\n  \r\n  /** Update divider visibility to avoid empty dividers between hidden groups */\r\n  private updateDividerVisibility(disabledTools: ToolName[]): void {\r\n    // Define which tools belong to which group\r\n    const groupTools: Record<string, ToolName[]> = {\r\n      zoom: ['zoomIn', 'zoomOut', 'reset'],\r\n      tool: ['move', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'text', 'mosaic', 'eraser'],\r\n      advanced: ['crop', 'filter'],\r\n      history: ['undo', 'redo'],\r\n      cropAction: [], // Special group, always hidden by default unless crop mode is active\r\n    };\r\n    \r\n    // Check if a group has any visible tools\r\n    const isGroupVisible = (groupName: string): boolean => {\r\n      // cropAction group is special - it's controlled separately\r\n      if (groupName === 'cropAction') {\r\n        const cropActionGroup = this.groups.get('cropAction');\r\n        return cropActionGroup ? cropActionGroup.style.display !== 'none' : false;\r\n      }\r\n      \r\n      const tools = groupTools[groupName];\r\n      if (!tools || tools.length === 0) return false;\r\n      return tools.some(tool => !disabledTools.includes(tool));\r\n    };\r\n    \r\n    // Check if export button is visible\r\n    const isExportVisible = !disabledTools.includes('export');\r\n    \r\n    // Dividers layout:\r\n    // [zoomGroup] [divider0] [toolGroup] [advancedGroup] [divider1] [panels] [historyGroup] [divider2] [cropActionGroup] [divider3] [export]\r\n    \r\n    // divider0: visible if zoom group AND (tool group OR advanced group) are visible\r\n    const zoomVisible = isGroupVisible('zoom');\r\n    const toolOrAdvancedVisible = isGroupVisible('tool') || isGroupVisible('advanced');\r\n    if (this.dividers[0]) {\r\n      this.dividers[0].style.display = (zoomVisible && toolOrAdvancedVisible) ? '' : 'none';\r\n    }\r\n    \r\n    // divider1: visible if (tool group OR advanced group) AND history group are visible\r\n    const historyVisible = isGroupVisible('history');\r\n    if (this.dividers[1]) {\r\n      this.dividers[1].style.display = (toolOrAdvancedVisible && historyVisible) ? '' : 'none';\r\n    }\r\n    \r\n    // divider2: visible if history group AND (cropAction group OR export) are visible\r\n    const cropActionVisible = isGroupVisible('cropAction');\r\n    if (this.dividers[2]) {\r\n      this.dividers[2].style.display = (historyVisible && (cropActionVisible || isExportVisible)) ? '' : 'none';\r\n    }\r\n    \r\n    // divider3: visible if cropAction group AND export are visible\r\n    if (this.dividers[3]) {\r\n      this.dividers[3].style.display = (cropActionVisible && isExportVisible) ? '' : 'none';\r\n    }\r\n  }\r\n  \r\n  /** Get current disabled tools */\r\n  getDisabledTools(): ToolName[] {\r\n    return this.options.disabledTools || [];\r\n  }\r\n\r\n  // ============ Shape Layer Rendering ============\r\n  \r\n  /** Save the current canvas state as original image (called after image load or flatten) */\r\n  saveOriginalImage(): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (ctx && canvas) {\r\n      this.originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    }\r\n  }\r\n  \r\n  /** Render original image + all shapes from manager */\r\n  private renderAll(): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (!ctx || !canvas) return;\r\n    \r\n    // If we have original image data, restore it first\r\n    if (this.originalImageData) {\r\n      ctx.putImageData(this.originalImageData, 0, 0);\r\n    } else {\r\n      // Otherwise just clear canvas with white background\r\n      ctx.fillStyle = '#ffffff';\r\n      ctx.fillRect(0, 0, canvas.width, canvas.height);\r\n    }\r\n    \r\n    // Render all shapes from shape manager\r\n    this.shapeManager.render(ctx);\r\n  }\r\n  \r\n  /** Flatten all shapes into the original image (makes them permanent) */\r\n  flattenShapes(): void {\r\n    this.renderAll();\r\n    this.saveOriginalImage();\r\n    this.shapeManager.clear();\r\n  }\r\n  \r\n  /** Get the shape layer manager */\r\n  getShapeManager(): ShapeLayerManager {\r\n    return this.shapeManager;\r\n  }\r\n  \r\n  // ============ Toolbar Visibility ============\r\n  \r\n  /** Set toolbar visibility with animation */\r\n  setToolbarVisible(visible: boolean): void {\r\n    if (visible) {\r\n      this.toolbar.classList.remove('ie-toolbar-hidden');\r\n      this.zoomBadge.classList.remove('ie-zoom-badge-hidden');\r\n    } else {\r\n      this.toolbar.classList.add('ie-toolbar-hidden');\r\n      this.zoomBadge.classList.add('ie-zoom-badge-hidden');\r\n    }\r\n    this.hasRealImage = visible;\r\n  }\r\n  \r\n  /** Check if toolbar is visible */\r\n  isToolbarVisible(): boolean {\r\n    return !this.toolbar.classList.contains('ie-toolbar-hidden');\r\n  }\r\n  \r\n  /** Check if current image is placeholder */\r\n  hasImage(): boolean {\r\n    return this.hasRealImage;\r\n  }\r\n  \r\n  /** Generate and load placeholder image */\r\n  showPlaceholder(): void {\r\n    const theme = this.options.theme === 'auto'\r\n      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')\r\n      : (this.options.theme || 'dark');\r\n    \r\n    // Calculate placeholder size - fill the entire container\r\n    let width = this.options.placeholderWidth;\r\n    let height = this.options.placeholderHeight;\r\n    \r\n    if (!width || !height) {\r\n      const containerRect = this.canvasContainer.getBoundingClientRect();\r\n      // Use full container size\r\n      width = Math.max(400, Math.round(containerRect.width));\r\n      height = Math.max(300, Math.round(containerRect.height));\r\n    }\r\n    \r\n    const placeholder = createPlaceholder({\r\n      width,\r\n      height,\r\n      text: this.options.placeholderText,\r\n      subText: this.options.placeholderSubText,\r\n      theme,\r\n    });\r\n    \r\n    this.hasRealImage = false;\r\n    \r\n    // Load placeholder (isUserImage=false to prevent toolbar from showing)\r\n    this.editor.loadImage(placeholder, false).then(() => {\r\n      // Keep toolbar hidden for placeholder\r\n      if (this.options.autoHide) {\r\n        this.setToolbarVisible(false);\r\n      }\r\n    });\r\n  }\r\n  \r\n  /** Called when a real image is loaded */\r\n  onImageLoaded(): void {\r\n    this.hasRealImage = true;\r\n    if (this.options.autoHide) {\r\n      this.setToolbarVisible(true);\r\n    }\r\n    // Save pure image data first (before any annotations)\r\n    this.savePureImage();\r\n    this.saveOriginalImage();\r\n  }\r\n  \r\n  /** Save the pure original image (without any annotations) - for eraser tool */\r\n  private savePureImage(): void {\r\n    const ctx = this.editor.ctx;\r\n    const canvas = this.editor.canvas;\r\n    if (ctx && canvas) {\r\n      this.pureImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    }\r\n  }\r\n\r\n  destroy(): void {\r\n    this.wrapper.remove();\r\n    this.panels.clear();\r\n    this.buttons.clear();\r\n    this.shapeManager.clear();\r\n  }\r\n}\r\n","/**\r\n * Editor class - Main image editor implementation\r\n * Requirements: 1.1, 1.2, 1.3, 1.4, 1.5\r\n */\r\n\r\nimport { Canvas } from './Canvas';\r\nimport { EventManager } from '../managers/EventManager';\r\nimport { HistoryManager } from '../managers/HistoryManager';\r\nimport { PluginManager } from '../managers/PluginManager';\r\nimport { ConfigManager } from '../managers/ConfigManager';\r\nimport { getElement } from '../utils/dom.utils';\r\nimport { Toolbar } from '../ui/Toolbar';\r\nimport { injectStyles } from '../ui/toolbar.styles';\r\nimport type { EditorOptions, EditorInterface, ToolbarConfig } from '../types/editor.types';\r\nimport type { PluginConstructor, Plugin, PluginContext } from '../types/plugin.types';\r\nimport type { EditorConfig, ExportOptions, DeepPartial } from '../types/config.types';\r\nimport type { EventHandler, EventListenerOptions, EditorEvents } from '../types/event.types';\r\n\r\n/**\r\n * Editor class - Main entry point for the image editor\r\n * Requirements: 1.1, 1.2, 1.3, 1.4, 1.5\r\n */\r\nexport class Editor implements EditorInterface {\r\n  /** Canvas manager instance */\r\n  private _canvas: Canvas;\r\n  /** Event manager instance */\r\n  private _eventManager: EventManager;\r\n  /** History manager instance */\r\n  private _historyManager: HistoryManager;\r\n  /** Plugin manager instance */\r\n  private _pluginManager: PluginManager;\r\n  /** Config manager instance */\r\n  private _configManager: ConfigManager;\r\n  /** Container element */\r\n  private _container: HTMLElement;\r\n  /** Built-in toolbar instance */\r\n  private _toolbar: Toolbar | null = null;\r\n  /** Whether the editor is destroyed */\r\n  private _destroyed: boolean = false;\r\n  /** Whether the editor is ready */\r\n  private _ready: boolean = false;\r\n\r\n  /**\r\n   * Create a new Editor instance\r\n   * Requirements: 1.1, 1.3 - Initialize editor with container and config\r\n   * @param options - Editor initialization options\r\n   */\r\n  constructor(options: EditorOptions) {\r\n    // Get container element\r\n    const container = getElement(options.container);\r\n    if (!container) {\r\n      throw new Error('Container element not found');\r\n    }\r\n    this._container = container;\r\n\r\n    // Initialize config manager\r\n    const editorConfig: DeepPartial<EditorConfig> = {\r\n      width: options.width,\r\n      height: options.height,\r\n      backgroundColor: options.backgroundColor,\r\n      historyLimit: options.historyLimit,\r\n      responsive: options.responsive,\r\n      deviceType: options.deviceType,\r\n    };\r\n    this._configManager = new ConfigManager(editorConfig);\r\n\r\n    // Initialize event manager\r\n    this._eventManager = new EventManager();\r\n\r\n    // Initialize history manager\r\n    const config = this._configManager.getConfig();\r\n    this._historyManager = new HistoryManager(config.historyLimit);\r\n\r\n    // Initialize canvas\r\n    this._canvas = new Canvas(this._container, config);\r\n\r\n    // Initialize plugin manager\r\n    this._pluginManager = new PluginManager();\r\n    this._pluginManager.setContext(this.createPluginContext());\r\n\r\n    // Setup history change listener\r\n    this._historyManager.onChange((canUndo, canRedo) => {\r\n      this._eventManager.emit('history-change', { canUndo, canRedo });\r\n    });\r\n\r\n    // Setup plugin change listener\r\n    this._pluginManager.onChange((tool, prevTool) => {\r\n      this._eventManager.emit('tool-change', { tool: tool || '', prevTool });\r\n    });\r\n\r\n    // Register initial plugins\r\n    if (options.plugins) {\r\n      for (const PluginClass of options.plugins) {\r\n        this.use(PluginClass);\r\n      }\r\n    }\r\n\r\n    // Create built-in toolbar if enabled (default: true)\r\n    const toolbarOption = options.toolbar;\r\n    if (toolbarOption !== false) {\r\n      injectStyles();\r\n      const toolbarConfig: ToolbarConfig = typeof toolbarOption === 'object' ? toolbarOption : {};\r\n      this._toolbar = new Toolbar(this, this._container, {\r\n        zoom: toolbarConfig.zoom !== false,\r\n        tools: toolbarConfig.tools !== false,\r\n        history: toolbarConfig.history !== false,\r\n        export: toolbarConfig.export !== false,\r\n        theme: toolbarConfig.theme || 'dark',\r\n        primaryColor: toolbarConfig.primaryColor,\r\n        disabledTools: toolbarConfig.disabledTools,\r\n        autoHide: toolbarConfig.autoHide !== false,\r\n        placeholderText: toolbarConfig.placeholderText,\r\n        placeholderSubText: toolbarConfig.placeholderSubText,\r\n      });\r\n    }\r\n\r\n    // Load image if provided, otherwise show placeholder\r\n    if (options.image) {\r\n      this.loadImage(options.image).catch((error) => {\r\n        this._eventManager.emit('error', { error });\r\n      });\r\n    } else if (this._toolbar) {\r\n      // Show placeholder when no image provided\r\n      this._toolbar.showPlaceholder();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the canvas element\r\n   */\r\n  get canvas(): HTMLCanvasElement {\r\n    return this._canvas.canvas;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas 2D context\r\n   */\r\n  get ctx(): CanvasRenderingContext2D {\r\n    return this._canvas.ctx;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas width\r\n   */\r\n  get width(): number {\r\n    return this._canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas height\r\n   */\r\n  get height(): number {\r\n    return this._canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Get the current tool name\r\n   */\r\n  get currentTool(): string | null {\r\n    return this._pluginManager.getActiveName();\r\n  }\r\n\r\n  /**\r\n   * Check if the editor is ready\r\n   */\r\n  get isReady(): boolean {\r\n    return this._ready;\r\n  }\r\n\r\n  /**\r\n   * Check if the editor is destroyed\r\n   */\r\n  get isDestroyed(): boolean {\r\n    return this._destroyed;\r\n  }\r\n\r\n  /**\r\n   * Create plugin context\r\n   * Requirements: 2.3 - Provide editor context to plugins\r\n   */\r\n  private createPluginContext(): PluginContext {\r\n    return {\r\n      editor: this,\r\n      canvas: this._canvas.canvas,\r\n      ctx: this._canvas.ctx,\r\n      saveState: () => this.saveState(),\r\n      getImageData: () => this._canvas.getImageData(),\r\n      putImageData: (data: ImageData) => this._canvas.putImageData(data),\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Save current state to history\r\n   * Requirements: 6.1 - Record operations to history stack\r\n   */\r\n  private saveState(toolName?: string, description?: string): void {\r\n    const imageData = this._canvas.getImageData();\r\n    this._historyManager.push({\r\n      imageData,\r\n      toolName: toolName || this.currentTool || 'unknown',\r\n      description,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Load an image into the editor\r\n   * Requirements: 1.1, 1.2 - Load image and trigger ready event\r\n   * @param source - Image source (URL or HTMLImageElement)\r\n   * @param isUserImage - Whether this is a user-provided image (not placeholder)\r\n   */\r\n  async loadImage(source: string | HTMLImageElement, isUserImage = true): Promise<void> {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    try {\r\n      const { width, height } = await this._canvas.loadImage(source);\r\n\r\n      // Save initial state\r\n      this.saveState('init', 'Initial state');\r\n\r\n      // Mark as ready\r\n      this._ready = true;\r\n\r\n      // Emit events\r\n      this._eventManager.emit('image-loaded', { width, height });\r\n      this._eventManager.emit('ready', { width, height });\r\n      \r\n      // Notify toolbar if this is a user image\r\n      if (isUserImage && this._toolbar) {\r\n        this._toolbar.onImageLoaded();\r\n      }\r\n    } catch (error) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      this._eventManager.emit('error', { error: err });\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register a plugin\r\n   * Requirements: 2.1 - Add plugin to available tools list\r\n   * @param PluginClass - Plugin constructor\r\n   * @returns The editor instance for chaining\r\n   */\r\n  use(PluginClass: PluginConstructor): this {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._pluginManager.register(PluginClass);\r\n    return this;\r\n  }\r\n\r\n  /** Built-in tools that are not plugins */\r\n  private static BUILTIN_TOOLS = ['', 'pen', 'rect', 'circle', 'arrow', 'line', 'triangle', 'mosaic', 'eraser', 'text', 'crop', 'filter'];\r\n\r\n  /**\r\n   * Set the current tool\r\n   * Requirements: 2.3 - Activate plugin\r\n   * @param toolName - Tool/plugin name\r\n   */\r\n  setTool(toolName: string): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    // Only activate plugins, not built-in toolbar tools\r\n    if (!Editor.BUILTIN_TOOLS.includes(toolName)) {\r\n      this._pluginManager.activate(toolName);\r\n    } else {\r\n      // Deactivate any active plugin when switching to built-in tool\r\n      const activeName = this._pluginManager.getActiveName();\r\n      if (activeName) {\r\n        this._pluginManager.deactivate(activeName);\r\n      }\r\n      // Emit tool-change event for built-in tools\r\n      this._eventManager.emit('tool-change', { tool: toolName, prevTool: activeName });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a tool/plugin by name\r\n   * @param toolName - Tool/plugin name\r\n   * @returns Plugin instance or undefined\r\n   */\r\n  getTool(toolName: string): Plugin | undefined {\r\n    return this._pluginManager.get(toolName);\r\n  }\r\n\r\n  /**\r\n   * Undo the last operation\r\n   * Requirements: 6.2 - Restore to previous state\r\n   */\r\n  undo(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    const state = this._historyManager.undo();\r\n    if (state) {\r\n      // Restore canvas size if it changed (e.g., after crop)\r\n      const imageData = state.imageData;\r\n      if (this._canvas.width !== imageData.width || this._canvas.height !== imageData.height) {\r\n        this._canvas.canvas.width = imageData.width;\r\n        this._canvas.canvas.height = imageData.height;\r\n      }\r\n      this._canvas.putImageData(imageData);\r\n      \r\n      // Notify toolbar to update its state\r\n      if (this._toolbar) {\r\n        this._toolbar.saveOriginalImage();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Redo the last undone operation\r\n   * Requirements: 6.3 - Restore to next state\r\n   */\r\n  redo(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    const state = this._historyManager.redo();\r\n    if (state) {\r\n      // Restore canvas size if it changed (e.g., after crop)\r\n      const imageData = state.imageData;\r\n      if (this._canvas.width !== imageData.width || this._canvas.height !== imageData.height) {\r\n        this._canvas.canvas.width = imageData.width;\r\n        this._canvas.canvas.height = imageData.height;\r\n      }\r\n      this._canvas.putImageData(imageData);\r\n      \r\n      // Notify toolbar to update its state\r\n      if (this._toolbar) {\r\n        this._toolbar.saveOriginalImage();\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if undo is available\r\n   * @returns True if can undo\r\n   */\r\n  canUndo(): boolean {\r\n    return this._historyManager.canUndo();\r\n  }\r\n\r\n  /**\r\n   * Check if redo is available\r\n   * @returns True if can redo\r\n   */\r\n  canRedo(): boolean {\r\n    return this._historyManager.canRedo();\r\n  }\r\n\r\n  /**\r\n   * Save current state to history (public API)\r\n   * @param description - Optional description of the operation\r\n   */\r\n  saveToHistory(description?: string): void {\r\n    if (this._destroyed) return;\r\n    this.saveState(this.currentTool || 'toolbar', description);\r\n  }\r\n\r\n  /**\r\n   * Export the edited image\r\n   * Requirements: 7.1, 7.2, 7.3, 7.4, 7.5 - Export with various options\r\n   * @param options - Export options\r\n   * @returns Promise with exported data\r\n   */\r\n  async export(options?: ExportOptions): Promise<string | Blob | File> {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    // Import export utilities dynamically to avoid circular dependencies\r\n    const exportUtils = await import('../utils/export.utils');\r\n\r\n    const exportOptions = options || {};\r\n    this._eventManager.emit('before-export', { options: exportOptions });\r\n\r\n    const data = await exportUtils.exportImage(this._canvas.canvas, exportOptions);\r\n\r\n    this._eventManager.emit('after-export', { data });\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an event\r\n   * Requirements: 1.2 - Event subscription\r\n   * @param event - Event name\r\n   * @param handler - Event handler\r\n   * @param options - Listener options\r\n   */\r\n  on<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>,\r\n    options?: EventListenerOptions\r\n  ): void {\r\n    this._eventManager.on(event, handler, options);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe from an event\r\n   * @param event - Event name\r\n   * @param handler - Event handler\r\n   */\r\n  off<K extends keyof EditorEvents>(\r\n    event: K,\r\n    handler: EventHandler<EditorEvents[K]>\r\n  ): void {\r\n    this._eventManager.off(event, handler);\r\n  }\r\n\r\n  /**\r\n   * Emit an event\r\n   * @param event - Event name\r\n   * @param data - Event data\r\n   */\r\n  emit<K extends keyof EditorEvents>(event: K, data: EditorEvents[K]): void {\r\n    this._eventManager.emit(event, data);\r\n  }\r\n\r\n  /**\r\n   * Get the current configuration\r\n   * @returns Current configuration\r\n   */\r\n  getConfig(): EditorConfig {\r\n    return this._configManager.getConfig();\r\n  }\r\n\r\n  /**\r\n   * Update configuration at runtime\r\n   * Requirements: 10.5 - Runtime configuration update\r\n   * @param updates - Configuration updates\r\n   */\r\n  updateConfig(updates: DeepPartial<EditorConfig>): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._configManager.update(updates);\r\n  }\r\n\r\n  /**\r\n   * Reset the canvas to original image\r\n   */\r\n  reset(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._canvas.reset();\r\n    this.saveState('reset', 'Reset to original');\r\n  }\r\n\r\n  /**\r\n   * Clear the canvas\r\n   */\r\n  clear(): void {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n\r\n    this._canvas.clear();\r\n    this.saveState('clear', 'Clear canvas');\r\n  }\r\n\r\n  /**\r\n   * Get the history manager\r\n   * @returns History manager instance\r\n   */\r\n  getHistoryManager(): HistoryManager {\r\n    return this._historyManager;\r\n  }\r\n\r\n  /**\r\n   * Get the plugin manager\r\n   * @returns Plugin manager instance\r\n   */\r\n  getPluginManager(): PluginManager {\r\n    return this._pluginManager;\r\n  }\r\n\r\n  /**\r\n   * Get the event manager\r\n   * @returns Event manager instance\r\n   */\r\n  getEventManager(): EventManager {\r\n    return this._eventManager;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas manager\r\n   * @returns Canvas manager instance\r\n   */\r\n  getCanvasManager(): Canvas {\r\n    return this._canvas;\r\n  }\r\n\r\n  /**\r\n   * Get the built-in toolbar instance\r\n   * @returns Toolbar instance or null if disabled\r\n   */\r\n  getToolbar(): Toolbar | null {\r\n    return this._toolbar;\r\n  }\r\n  \r\n  // ============ Image Data APIs ============\r\n  \r\n  /**\r\n   * Get current canvas image data\r\n   * @returns ImageData object\r\n   */\r\n  getImageData(): ImageData {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    return this._canvas.getImageData();\r\n  }\r\n  \r\n  /**\r\n   * Get canvas as data URL\r\n   * @param type - Image MIME type (default: 'image/png')\r\n   * @param quality - Image quality for jpeg (0-1)\r\n   * @returns Data URL string\r\n   */\r\n  toDataURL(type: string = 'image/png', quality?: number): string {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    return this._canvas.canvas.toDataURL(type, quality);\r\n  }\r\n  \r\n  /**\r\n   * Get canvas as Blob\r\n   * @param type - Image MIME type (default: 'image/png')\r\n   * @param quality - Image quality for jpeg (0-1)\r\n   * @returns Promise resolving to Blob\r\n   */\r\n  toBlob(type: string = 'image/png', quality?: number): Promise<Blob | null> {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    return new Promise((resolve) => {\r\n      this._canvas.canvas.toBlob(resolve, type, quality);\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * Get image information\r\n   * @returns Object containing width, height, and other info\r\n   */\r\n  getImageInfo(): { width: number; height: number; aspectRatio: number } {\r\n    if (this._destroyed) {\r\n      throw new Error('Editor is destroyed');\r\n    }\r\n    const width = this._canvas.width;\r\n    const height = this._canvas.height;\r\n    return {\r\n      width,\r\n      height,\r\n      aspectRatio: width / height,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Destroy the editor and clean up all resources\r\n   * Requirements: 1.5 - Clean up all event listeners and canvas resources\r\n   */\r\n  destroy(): void {\r\n    if (this._destroyed) {\r\n      return;\r\n    }\r\n\r\n    this._destroyed = true;\r\n\r\n    // Emit destroy event before cleanup\r\n    this._eventManager.emit('destroy', undefined as unknown as void);\r\n\r\n    // Destroy toolbar first\r\n    if (this._toolbar) {\r\n      this._toolbar.destroy();\r\n      this._toolbar = null;\r\n    }\r\n\r\n    // Destroy all managers\r\n    this._pluginManager.destroy();\r\n    this._historyManager.destroy();\r\n    this._canvas.destroy();\r\n    this._eventManager.destroy();\r\n    this._configManager.destroy();\r\n\r\n    this._ready = false;\r\n  }\r\n}\r\n","/**\r\n * Base Plugin - Abstract base class for all plugins\r\n * Requirements: 2.5 - Plugin interface definition with unified lifecycle methods\r\n */\r\n\r\nimport type { Plugin, PluginContext } from '../../types/plugin.types';\r\n\r\n/**\r\n * Abstract base class for plugins\r\n * Provides common functionality and enforces plugin interface\r\n * Requirements: 2.5\r\n */\r\nexport abstract class BasePlugin<TConfig extends object = object> implements Plugin {\r\n  /** Plugin name - must be unique */\r\n  abstract readonly name: string;\r\n  /** Toolbar icon (optional) */\r\n  readonly icon?: string;\r\n  /** Toolbar title (optional) */\r\n  readonly title?: string;\r\n\r\n  /** Plugin context provided during installation */\r\n  protected context: PluginContext | null = null;\r\n  /** Current plugin configuration */\r\n  protected config: TConfig;\r\n  /** Whether the plugin is currently active */\r\n  protected isActive: boolean = false;\r\n\r\n  constructor() {\r\n    this.config = this.getDefaultConfig();\r\n  }\r\n\r\n  /**\r\n   * Get default configuration for the plugin\r\n   * Subclasses should override this to provide their default config\r\n   */\r\n  abstract getDefaultConfig(): TConfig;\r\n\r\n  /**\r\n   * Install the plugin with the provided context\r\n   * Requirements: 2.5 - install lifecycle method\r\n   * @param context - Plugin context from editor\r\n   */\r\n  install(context: PluginContext): void {\r\n    this.context = context;\r\n    this.onInstall();\r\n  }\r\n\r\n  /**\r\n   * Activate the plugin\r\n   * Requirements: 2.5 - activate lifecycle method\r\n   */\r\n  activate(): void {\r\n    if (!this.context) {\r\n      throw new Error(`Plugin \"${this.name}\" is not installed. Call install() first.`);\r\n    }\r\n    this.isActive = true;\r\n    this.onActivate();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the plugin\r\n   * Requirements: 2.5 - deactivate lifecycle method\r\n   */\r\n  deactivate(): void {\r\n    this.isActive = false;\r\n    this.onDeactivate();\r\n  }\r\n\r\n  /**\r\n   * Destroy the plugin and clean up resources\r\n   * Requirements: 2.5 - destroy lifecycle method\r\n   */\r\n  destroy(): void {\r\n    this.deactivate();\r\n    this.onDestroy();\r\n    this.context = null;\r\n  }\r\n\r\n  /**\r\n   * Set plugin configuration\r\n   * @param config - Partial configuration to merge\r\n   */\r\n  setConfig(config: Partial<TConfig>): void {\r\n    this.config = { ...this.config, ...config };\r\n    this.onConfigChange(this.config);\r\n  }\r\n\r\n  /**\r\n   * Get current plugin configuration\r\n   * @returns Current configuration\r\n   */\r\n  getConfig(): TConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  /**\r\n   * Check if the plugin is currently active\r\n   * @returns True if active\r\n   */\r\n  getIsActive(): boolean {\r\n    return this.isActive;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas element\r\n   * @returns Canvas element or null if not installed\r\n   */\r\n  protected getCanvas(): HTMLCanvasElement | null {\r\n    return this.context?.canvas ?? null;\r\n  }\r\n\r\n  /**\r\n   * Get the canvas 2D context\r\n   * @returns Canvas context or null if not installed\r\n   */\r\n  protected getContext(): CanvasRenderingContext2D | null {\r\n    return this.context?.ctx ?? null;\r\n  }\r\n\r\n  /**\r\n   * Save current state to history\r\n   */\r\n  protected saveState(): void {\r\n    this.context?.saveState();\r\n  }\r\n\r\n  /**\r\n   * Get current image data from canvas\r\n   * @returns ImageData or null if not available\r\n   */\r\n  protected getImageData(): ImageData | null {\r\n    return this.context?.getImageData() ?? null;\r\n  }\r\n\r\n  /**\r\n   * Put image data to canvas\r\n   * @param data - ImageData to put\r\n   */\r\n  protected putImageData(data: ImageData): void {\r\n    this.context?.putImageData(data);\r\n  }\r\n\r\n  /**\r\n   * Hook called after plugin is installed\r\n   * Subclasses can override to perform initialization\r\n   */\r\n  protected onInstall(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is activated\r\n   * Subclasses can override to set up event listeners, etc.\r\n   */\r\n  protected onActivate(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is deactivated\r\n   * Subclasses can override to clean up event listeners, etc.\r\n   */\r\n  protected onDeactivate(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is destroyed\r\n   * Subclasses can override to perform final cleanup\r\n   */\r\n  protected onDestroy(): void {\r\n    // Override in subclass if needed\r\n  }\r\n\r\n  /**\r\n   * Hook called when configuration changes\r\n   * Subclasses can override to react to config changes\r\n   * @param _config - New configuration\r\n   */\r\n  protected onConfigChange(_config: TConfig): void {\r\n    // Override in subclass if needed\r\n  }\r\n}\r\n","/**\r\n * Mosaic utility functions\r\n * Requirements: 3.1, 3.2, 3.4 - Mosaic algorithm implementation\r\n */\r\n\r\n/**\r\n * Apply mosaic effect to a rectangular region of image data\r\n * Requirements: 3.1, 3.2, 3.4\r\n * @param imageData - Source image data\r\n * @param x - Start X coordinate\r\n * @param y - Start Y coordinate\r\n * @param width - Region width\r\n * @param height - Region height\r\n * @param blockSize - Mosaic block size\r\n * @param intensity - Mosaic intensity (0-100)\r\n * @returns Modified image data\r\n */\r\nexport function applyMosaicToRegion(\r\n  imageData: ImageData,\r\n  x: number,\r\n  y: number,\r\n  width: number,\r\n  height: number,\r\n  blockSize: number,\r\n  intensity: number\r\n): ImageData {\r\n  const data = imageData.data;\r\n  const imgWidth = imageData.width;\r\n  const imgHeight = imageData.height;\r\n\r\n  // Clamp coordinates to image bounds\r\n  const startX = Math.max(0, Math.floor(x));\r\n  const startY = Math.max(0, Math.floor(y));\r\n  const endX = Math.min(imgWidth, Math.ceil(x + width));\r\n  const endY = Math.min(imgHeight, Math.ceil(y + height));\r\n\r\n  // Ensure block size is at least 1\r\n  const effectiveBlockSize = Math.max(1, Math.floor(blockSize));\r\n  \r\n  // Normalize intensity to 0-1 range\r\n  const normalizedIntensity = Math.max(0, Math.min(100, intensity)) / 100;\r\n\r\n  // Process each block\r\n  for (let blockY = startY; blockY < endY; blockY += effectiveBlockSize) {\r\n    for (let blockX = startX; blockX < endX; blockX += effectiveBlockSize) {\r\n      // Calculate block bounds\r\n      const blockEndX = Math.min(blockX + effectiveBlockSize, endX);\r\n      const blockEndY = Math.min(blockY + effectiveBlockSize, endY);\r\n      const blockWidth = blockEndX - blockX;\r\n      const blockHeight = blockEndY - blockY;\r\n      const pixelCount = blockWidth * blockHeight;\r\n\r\n      if (pixelCount === 0) continue;\r\n\r\n      // Calculate average color for the block\r\n      let totalR = 0;\r\n      let totalG = 0;\r\n      let totalB = 0;\r\n      let totalA = 0;\r\n\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const idx = (py * imgWidth + px) * 4;\r\n          totalR += data[idx];\r\n          totalG += data[idx + 1];\r\n          totalB += data[idx + 2];\r\n          totalA += data[idx + 3];\r\n        }\r\n      }\r\n\r\n      const avgR = Math.round(totalR / pixelCount);\r\n      const avgG = Math.round(totalG / pixelCount);\r\n      const avgB = Math.round(totalB / pixelCount);\r\n      const avgA = Math.round(totalA / pixelCount);\r\n\r\n      // Apply the average color to all pixels in the block with intensity blending\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const idx = (py * imgWidth + px) * 4;\r\n          \r\n          // Blend original and mosaic color based on intensity\r\n          data[idx] = Math.round(data[idx] * (1 - normalizedIntensity) + avgR * normalizedIntensity);\r\n          data[idx + 1] = Math.round(data[idx + 1] * (1 - normalizedIntensity) + avgG * normalizedIntensity);\r\n          data[idx + 2] = Math.round(data[idx + 2] * (1 - normalizedIntensity) + avgB * normalizedIntensity);\r\n          data[idx + 3] = Math.round(data[idx + 3] * (1 - normalizedIntensity) + avgA * normalizedIntensity);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return imageData;\r\n}\r\n\r\n/**\r\n * Apply mosaic effect along a brush stroke path\r\n * Requirements: 3.1, 3.5 - Free drawing mode\r\n * @param imageData - Source image data\r\n * @param points - Array of points along the stroke\r\n * @param brushSize - Brush diameter\r\n * @param blockSize - Mosaic block size\r\n * @param intensity - Mosaic intensity (0-100)\r\n * @returns Modified image data\r\n */\r\nexport function applyMosaicAlongPath(\r\n  imageData: ImageData,\r\n  points: Array<{ x: number; y: number }>,\r\n  brushSize: number,\r\n  blockSize: number,\r\n  intensity: number\r\n): ImageData {\r\n  if (points.length === 0) return imageData;\r\n\r\n  const radius = brushSize / 2;\r\n\r\n  // For each point, apply mosaic to a circular region\r\n  for (const point of points) {\r\n    applyMosaicToCircularRegion(\r\n      imageData,\r\n      point.x,\r\n      point.y,\r\n      radius,\r\n      blockSize,\r\n      intensity\r\n    );\r\n  }\r\n\r\n  return imageData;\r\n}\r\n\r\n/**\r\n * Apply mosaic effect to a circular region\r\n * @param imageData - Source image data\r\n * @param centerX - Center X coordinate\r\n * @param centerY - Center Y coordinate\r\n * @param radius - Circle radius\r\n * @param blockSize - Mosaic block size\r\n * @param intensity - Mosaic intensity (0-100)\r\n * @returns Modified image data\r\n */\r\nexport function applyMosaicToCircularRegion(\r\n  imageData: ImageData,\r\n  centerX: number,\r\n  centerY: number,\r\n  radius: number,\r\n  blockSize: number,\r\n  intensity: number\r\n): ImageData {\r\n  const data = imageData.data;\r\n  const imgWidth = imageData.width;\r\n  const imgHeight = imageData.height;\r\n\r\n  // Calculate bounding box\r\n  const startX = Math.max(0, Math.floor(centerX - radius));\r\n  const startY = Math.max(0, Math.floor(centerY - radius));\r\n  const endX = Math.min(imgWidth, Math.ceil(centerX + radius));\r\n  const endY = Math.min(imgHeight, Math.ceil(centerY + radius));\r\n\r\n  const effectiveBlockSize = Math.max(1, Math.floor(blockSize));\r\n  const normalizedIntensity = Math.max(0, Math.min(100, intensity)) / 100;\r\n  const radiusSquared = radius * radius;\r\n\r\n  // Process each block within the bounding box\r\n  for (let blockY = startY; blockY < endY; blockY += effectiveBlockSize) {\r\n    for (let blockX = startX; blockX < endX; blockX += effectiveBlockSize) {\r\n      const blockEndX = Math.min(blockX + effectiveBlockSize, endX);\r\n      const blockEndY = Math.min(blockY + effectiveBlockSize, endY);\r\n\r\n      // Check if block center is within the circle\r\n      const blockCenterX = blockX + effectiveBlockSize / 2;\r\n      const blockCenterY = blockY + effectiveBlockSize / 2;\r\n      const dx = blockCenterX - centerX;\r\n      const dy = blockCenterY - centerY;\r\n      \r\n      if (dx * dx + dy * dy > radiusSquared) continue;\r\n\r\n      // Calculate average color for pixels within the circle\r\n      let totalR = 0;\r\n      let totalG = 0;\r\n      let totalB = 0;\r\n      let totalA = 0;\r\n      let pixelCount = 0;\r\n\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const pdx = px - centerX;\r\n          const pdy = py - centerY;\r\n          if (pdx * pdx + pdy * pdy <= radiusSquared) {\r\n            const idx = (py * imgWidth + px) * 4;\r\n            totalR += data[idx];\r\n            totalG += data[idx + 1];\r\n            totalB += data[idx + 2];\r\n            totalA += data[idx + 3];\r\n            pixelCount++;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (pixelCount === 0) continue;\r\n\r\n      const avgR = Math.round(totalR / pixelCount);\r\n      const avgG = Math.round(totalG / pixelCount);\r\n      const avgB = Math.round(totalB / pixelCount);\r\n      const avgA = Math.round(totalA / pixelCount);\r\n\r\n      // Apply average color to pixels within the circle\r\n      for (let py = blockY; py < blockEndY; py++) {\r\n        for (let px = blockX; px < blockEndX; px++) {\r\n          const pdx = px - centerX;\r\n          const pdy = py - centerY;\r\n          if (pdx * pdx + pdy * pdy <= radiusSquared) {\r\n            const idx = (py * imgWidth + px) * 4;\r\n            data[idx] = Math.round(data[idx] * (1 - normalizedIntensity) + avgR * normalizedIntensity);\r\n            data[idx + 1] = Math.round(data[idx + 1] * (1 - normalizedIntensity) + avgG * normalizedIntensity);\r\n            data[idx + 2] = Math.round(data[idx + 2] * (1 - normalizedIntensity) + avgB * normalizedIntensity);\r\n            data[idx + 3] = Math.round(data[idx + 3] * (1 - normalizedIntensity) + avgA * normalizedIntensity);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return imageData;\r\n}\r\n\r\n/**\r\n * Interpolate points between two coordinates for smooth brush strokes\r\n * @param x1 - Start X\r\n * @param y1 - Start Y\r\n * @param x2 - End X\r\n * @param y2 - End Y\r\n * @param spacing - Spacing between points\r\n * @returns Array of interpolated points\r\n */\r\nexport function interpolatePoints(\r\n  x1: number,\r\n  y1: number,\r\n  x2: number,\r\n  y2: number,\r\n  spacing: number\r\n): Array<{ x: number; y: number }> {\r\n  const points: Array<{ x: number; y: number }> = [];\r\n  const dx = x2 - x1;\r\n  const dy = y2 - y1;\r\n  const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n  if (distance < spacing) {\r\n    points.push({ x: x2, y: y2 });\r\n    return points;\r\n  }\r\n\r\n  const steps = Math.ceil(distance / spacing);\r\n  for (let i = 0; i <= steps; i++) {\r\n    const t = i / steps;\r\n    points.push({\r\n      x: x1 + dx * t,\r\n      y: y1 + dy * t,\r\n    });\r\n  }\r\n\r\n  return points;\r\n}\r\n","/**\r\n * Mosaic Plugin - Applies mosaic effect to image regions\r\n * Requirements: 3.1, 3.2, 3.3, 3.4, 3.5\r\n */\r\n\r\nimport { BasePlugin } from '../base/BasePlugin';\r\nimport type { MosaicConfig } from '../../types/config.types';\r\nimport type { MosaicPluginInterface } from '../../types/plugin.types';\r\nimport { normalizePointerEvent } from '../../utils/event.utils';\r\nimport { getResolvedDeviceType, getNonPassiveOptions } from '../../utils/device.utils';\r\nimport {\r\n  applyMosaicToRegion,\r\n  applyMosaicToCircularRegion,\r\n  interpolatePoints,\r\n} from './mosaic.utils';\r\nimport { cloneImageData } from '../../utils/image.utils';\r\n\r\n/**\r\n * Drawing state for tracking mouse/touch interactions\r\n */\r\ninterface DrawingState {\r\n  isDrawing: boolean;\r\n  startX: number;\r\n  startY: number;\r\n  lastX: number;\r\n  lastY: number;\r\n  originalImageData: ImageData | null;\r\n}\r\n\r\n/**\r\n * MosaicPlugin class - Implements mosaic drawing functionality\r\n * Requirements: 3.1, 3.2, 3.3, 3.4, 3.5\r\n */\r\nexport class MosaicPlugin extends BasePlugin<MosaicConfig> implements MosaicPluginInterface {\r\n  readonly name = 'mosaic' as const;\r\n  readonly icon = '▦';\r\n  readonly title = 'Mosaic';\r\n\r\n  /** Drawing state */\r\n  private drawingState: DrawingState = {\r\n    isDrawing: false,\r\n    startX: 0,\r\n    startY: 0,\r\n    lastX: 0,\r\n    lastY: 0,\r\n    originalImageData: null,\r\n  };\r\n\r\n  /** Event cleanup functions */\r\n  private cleanupFunctions: Array<() => void> = [];\r\n\r\n  /**\r\n   * Get default mosaic configuration\r\n   * Requirements: 3.2, 3.4, 3.5\r\n   */\r\n  getDefaultConfig(): MosaicConfig {\r\n    return {\r\n      blockSize: 10,\r\n      intensity: 100,\r\n      mode: 'free',\r\n      brushSize: 30,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Set mosaic block size\r\n   * Requirements: 3.2\r\n   * @param size - Block size in pixels\r\n   */\r\n  setBlockSize(size: number): void {\r\n    this.setConfig({ blockSize: Math.max(1, Math.floor(size)) });\r\n  }\r\n\r\n  /**\r\n   * Set mosaic intensity\r\n   * Requirements: 3.4\r\n   * @param intensity - Intensity value (0-100)\r\n   */\r\n  setIntensity(intensity: number): void {\r\n    this.setConfig({ intensity: Math.max(0, Math.min(100, intensity)) });\r\n  }\r\n\r\n  /**\r\n   * Set drawing mode\r\n   * Requirements: 3.5\r\n   * @param mode - Drawing mode ('rect' or 'free')\r\n   */\r\n  setMode(mode: 'rect' | 'free'): void {\r\n    this.setConfig({ mode });\r\n  }\r\n\r\n  /**\r\n   * Set brush size for free drawing mode\r\n   * Requirements: 3.5\r\n   * @param size - Brush size in pixels\r\n   */\r\n  setBrushSize(size: number): void {\r\n    this.setConfig({ brushSize: Math.max(1, size) });\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is activated\r\n   * Sets up event listeners for drawing\r\n   * Requirements: 3.1, 3.3\r\n   */\r\n  protected onActivate(): void {\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    this.setupEventListeners(canvas);\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is deactivated\r\n   * Cleans up event listeners\r\n   */\r\n  protected onDeactivate(): void {\r\n    this.cleanupEventListeners();\r\n    this.resetDrawingState();\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is destroyed\r\n   */\r\n  protected onDestroy(): void {\r\n    this.cleanupEventListeners();\r\n    this.resetDrawingState();\r\n  }\r\n\r\n  /**\r\n   * Set up mouse and touch event listeners\r\n   * Requirements: 3.3 - Touch event support\r\n   */\r\n  private setupEventListeners(canvas: HTMLCanvasElement): void {\r\n    const deviceType = getResolvedDeviceType('auto');\r\n    const nonPassiveOptions = getNonPassiveOptions();\r\n\r\n    if (deviceType === 'mobile') {\r\n      // Touch events for mobile\r\n      const touchStartHandler = this.handleTouchStart.bind(this);\r\n      const touchMoveHandler = this.handleTouchMove.bind(this);\r\n      const touchEndHandler = this.handleTouchEnd.bind(this);\r\n\r\n      canvas.addEventListener('touchstart', touchStartHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchmove', touchMoveHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchend', touchEndHandler);\r\n      canvas.addEventListener('touchcancel', touchEndHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('touchstart', touchStartHandler),\r\n        () => canvas.removeEventListener('touchmove', touchMoveHandler),\r\n        () => canvas.removeEventListener('touchend', touchEndHandler),\r\n        () => canvas.removeEventListener('touchcancel', touchEndHandler)\r\n      );\r\n    } else {\r\n      // Mouse events for PC\r\n      const mouseDownHandler = this.handleMouseDown.bind(this);\r\n      const mouseMoveHandler = this.handleMouseMove.bind(this);\r\n      const mouseUpHandler = this.handleMouseUp.bind(this);\r\n\r\n      canvas.addEventListener('mousedown', mouseDownHandler);\r\n      canvas.addEventListener('mousemove', mouseMoveHandler);\r\n      canvas.addEventListener('mouseup', mouseUpHandler);\r\n      canvas.addEventListener('mouseleave', mouseUpHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('mousedown', mouseDownHandler),\r\n        () => canvas.removeEventListener('mousemove', mouseMoveHandler),\r\n        () => canvas.removeEventListener('mouseup', mouseUpHandler),\r\n        () => canvas.removeEventListener('mouseleave', mouseUpHandler)\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up all event listeners\r\n   */\r\n  private cleanupEventListeners(): void {\r\n    for (const cleanup of this.cleanupFunctions) {\r\n      cleanup();\r\n    }\r\n    this.cleanupFunctions = [];\r\n  }\r\n\r\n  /**\r\n   * Reset drawing state\r\n   */\r\n  private resetDrawingState(): void {\r\n    this.drawingState = {\r\n      isDrawing: false,\r\n      startX: 0,\r\n      startY: 0,\r\n      lastX: 0,\r\n      lastY: 0,\r\n      originalImageData: null,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle mouse down event\r\n   */\r\n  private handleMouseDown(event: MouseEvent): void {\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse move event\r\n   */\r\n  private handleMouseMove(event: MouseEvent): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse up event\r\n   */\r\n  private handleMouseUp(): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n    this.endDrawing();\r\n  }\r\n\r\n  /**\r\n   * Handle touch start event\r\n   * Requirements: 3.3\r\n   */\r\n  private handleTouchStart(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle touch move event\r\n   * Requirements: 3.3\r\n   */\r\n  private handleTouchMove(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrawing(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle touch end event\r\n   * Requirements: 3.3\r\n   */\r\n  private handleTouchEnd(): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n    this.endDrawing();\r\n  }\r\n\r\n  /**\r\n   * Start drawing operation\r\n   */\r\n  private startDrawing(x: number, y: number): void {\r\n    const imageData = this.getImageData();\r\n    if (!imageData) return;\r\n\r\n    // Save original state for rect mode preview\r\n    this.drawingState = {\r\n      isDrawing: true,\r\n      startX: x,\r\n      startY: y,\r\n      lastX: x,\r\n      lastY: y,\r\n      originalImageData: cloneImageData(imageData),\r\n    };\r\n\r\n    // For free mode, apply mosaic at the starting point\r\n    if (this.config.mode === 'free') {\r\n      this.applyMosaicAtPoint(x, y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Continue drawing operation\r\n   */\r\n  private continueDrawing(x: number, y: number): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    if (this.config.mode === 'free') {\r\n      // Interpolate points for smooth brush stroke\r\n      const points = interpolatePoints(\r\n        this.drawingState.lastX,\r\n        this.drawingState.lastY,\r\n        x,\r\n        y,\r\n        this.config.brushSize / 4\r\n      );\r\n\r\n      for (const point of points) {\r\n        this.applyMosaicAtPoint(point.x, point.y);\r\n      }\r\n\r\n      this.drawingState.lastX = x;\r\n      this.drawingState.lastY = y;\r\n    } else {\r\n      // Rect mode: preview the rectangle\r\n      this.previewRectMosaic(x, y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * End drawing operation\r\n   */\r\n  private endDrawing(): void {\r\n    if (!this.drawingState.isDrawing) return;\r\n\r\n    if (this.config.mode === 'rect') {\r\n      // Apply final rect mosaic\r\n      this.applyRectMosaic(\r\n        this.drawingState.startX,\r\n        this.drawingState.startY,\r\n        this.drawingState.lastX,\r\n        this.drawingState.lastY\r\n      );\r\n    }\r\n\r\n    // Save state to history\r\n    this.saveState();\r\n\r\n    this.resetDrawingState();\r\n  }\r\n\r\n  /**\r\n   * Apply mosaic at a single point (free mode)\r\n   * Requirements: 3.1, 3.5\r\n   */\r\n  private applyMosaicAtPoint(x: number, y: number): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n\r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    applyMosaicToCircularRegion(\r\n      imageData,\r\n      x,\r\n      y,\r\n      this.config.brushSize / 2,\r\n      this.config.blockSize,\r\n      this.config.intensity\r\n    );\r\n\r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Preview rect mosaic (during drag)\r\n   * Requirements: 3.5\r\n   */\r\n  private previewRectMosaic(currentX: number, currentY: number): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas || !this.drawingState.originalImageData) return;\r\n\r\n    // Restore original image\r\n    ctx.putImageData(this.drawingState.originalImageData, 0, 0);\r\n\r\n    // Get fresh image data and apply mosaic\r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    const x = Math.min(this.drawingState.startX, currentX);\r\n    const y = Math.min(this.drawingState.startY, currentY);\r\n    const width = Math.abs(currentX - this.drawingState.startX);\r\n    const height = Math.abs(currentY - this.drawingState.startY);\r\n\r\n    applyMosaicToRegion(\r\n      imageData,\r\n      x,\r\n      y,\r\n      width,\r\n      height,\r\n      this.config.blockSize,\r\n      this.config.intensity\r\n    );\r\n\r\n    ctx.putImageData(imageData, 0, 0);\r\n    this.drawingState.lastX = currentX;\r\n    this.drawingState.lastY = currentY;\r\n  }\r\n\r\n  /**\r\n   * Apply final rect mosaic\r\n   * Requirements: 3.1, 3.5\r\n   */\r\n  private applyRectMosaic(startX: number, startY: number, endX: number, endY: number): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas || !this.drawingState.originalImageData) return;\r\n\r\n    // Restore original and apply final mosaic\r\n    ctx.putImageData(this.drawingState.originalImageData, 0, 0);\r\n    \r\n    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    const x = Math.min(startX, endX);\r\n    const y = Math.min(startY, endY);\r\n    const width = Math.abs(endX - startX);\r\n    const height = Math.abs(endY - startY);\r\n\r\n    applyMosaicToRegion(\r\n      imageData,\r\n      x,\r\n      y,\r\n      width,\r\n      height,\r\n      this.config.blockSize,\r\n      this.config.intensity\r\n    );\r\n\r\n    ctx.putImageData(imageData, 0, 0);\r\n  }\r\n}\r\n","/**\r\n * TextLayer - Manages individual text elements on the canvas\r\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.6\r\n */\r\n\r\nimport type { TextConfig } from '../../types/config.types';\r\nimport type { TextLayer as TextLayerData } from '../../types/plugin.types';\r\n\r\n/**\r\n * Default text configuration\r\n * Requirements: 4.2, 4.3, 4.5, 4.6\r\n */\r\nexport const DEFAULT_TEXT_CONFIG: TextConfig = {\r\n  fontSize: 16,\r\n  fontFamily: 'Arial',\r\n  color: '#000000',\r\n  bold: false,\r\n  italic: false,\r\n  underline: false,\r\n  align: 'left',\r\n  lineHeight: 1.2,\r\n};\r\n\r\n/**\r\n * Generate unique ID for text layers\r\n */\r\nfunction generateId(): string {\r\n  return `text_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n}\r\n\r\n/**\r\n * TextLayerManager - Manages text layer instances\r\n * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6\r\n */\r\nexport class TextLayerManager {\r\n  /** Map of text layers by ID */\r\n  private layers: Map<string, TextLayerData> = new Map();\r\n  /** Currently selected layer ID */\r\n  private selectedLayerId: string | null = null;\r\n\r\n  /**\r\n   * Create a new text layer\r\n   * Requirements: 4.1\r\n   * @param text - Text content\r\n   * @param x - X position\r\n   * @param y - Y position\r\n   * @param config - Optional text configuration\r\n   * @returns Created text layer\r\n   */\r\n  createLayer(\r\n    text: string,\r\n    x: number,\r\n    y: number,\r\n    config?: Partial<TextConfig>\r\n  ): TextLayerData {\r\n    const layer: TextLayerData = {\r\n      id: generateId(),\r\n      text,\r\n      x,\r\n      y,\r\n      config: { ...DEFAULT_TEXT_CONFIG, ...config },\r\n    };\r\n    this.layers.set(layer.id, layer);\r\n    return layer;\r\n  }\r\n\r\n\r\n  /**\r\n   * Get a text layer by ID\r\n   * @param id - Layer ID\r\n   * @returns Text layer or undefined\r\n   */\r\n  getLayer(id: string): TextLayerData | undefined {\r\n    return this.layers.get(id);\r\n  }\r\n\r\n  /**\r\n   * Get all text layers\r\n   * @returns Array of all text layers\r\n   */\r\n  getAllLayers(): TextLayerData[] {\r\n    return Array.from(this.layers.values());\r\n  }\r\n\r\n  /**\r\n   * Update text content\r\n   * Requirements: 4.1\r\n   * @param id - Layer ID\r\n   * @param text - New text content\r\n   * @returns Updated layer or undefined\r\n   */\r\n  updateText(id: string, text: string): TextLayerData | undefined {\r\n    const layer = this.layers.get(id);\r\n    if (layer) {\r\n      layer.text = text;\r\n    }\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Update layer position\r\n   * Requirements: 4.4\r\n   * @param id - Layer ID\r\n   * @param x - New X position\r\n   * @param y - New Y position\r\n   * @returns Updated layer or undefined\r\n   */\r\n  updatePosition(id: string, x: number, y: number): TextLayerData | undefined {\r\n    const layer = this.layers.get(id);\r\n    if (layer) {\r\n      layer.x = x;\r\n      layer.y = y;\r\n    }\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Update layer configuration\r\n   * Requirements: 4.2, 4.3, 4.5, 4.6\r\n   * @param id - Layer ID\r\n   * @param config - Partial configuration to merge\r\n   * @returns Updated layer or undefined\r\n   */\r\n  updateConfig(id: string, config: Partial<TextConfig>): TextLayerData | undefined {\r\n    const layer = this.layers.get(id);\r\n    if (layer) {\r\n      layer.config = { ...layer.config, ...config };\r\n    }\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a text layer\r\n   * @param id - Layer ID\r\n   * @returns True if layer was removed\r\n   */\r\n  removeLayer(id: string): boolean {\r\n    if (this.selectedLayerId === id) {\r\n      this.selectedLayerId = null;\r\n    }\r\n    return this.layers.delete(id);\r\n  }\r\n\r\n  /**\r\n   * Clear all text layers\r\n   */\r\n  clearAll(): void {\r\n    this.layers.clear();\r\n    this.selectedLayerId = null;\r\n  }\r\n\r\n  /**\r\n   * Select a text layer\r\n   * @param id - Layer ID or null to deselect\r\n   */\r\n  selectLayer(id: string | null): void {\r\n    this.selectedLayerId = id;\r\n  }\r\n\r\n  /**\r\n   * Get selected layer ID\r\n   * @returns Selected layer ID or null\r\n   */\r\n  getSelectedLayerId(): string | null {\r\n    return this.selectedLayerId;\r\n  }\r\n\r\n  /**\r\n   * Get selected layer\r\n   * @returns Selected layer or undefined\r\n   */\r\n  getSelectedLayer(): TextLayerData | undefined {\r\n    if (this.selectedLayerId) {\r\n      return this.layers.get(this.selectedLayerId);\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Check if a layer exists\r\n   * @param id - Layer ID\r\n   * @returns True if layer exists\r\n   */\r\n  hasLayer(id: string): boolean {\r\n    return this.layers.has(id);\r\n  }\r\n\r\n  /**\r\n   * Get layer count\r\n   * @returns Number of layers\r\n   */\r\n  getLayerCount(): number {\r\n    return this.layers.size;\r\n  }\r\n}\r\n","/**\r\n * Text rendering utility functions\r\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.6\r\n */\r\n\r\nimport type { TextConfig } from '../../types/config.types';\r\nimport type { TextLayer } from '../../types/plugin.types';\r\n\r\n/**\r\n * Build CSS font string from text configuration\r\n * Requirements: 4.2, 4.5\r\n * @param config - Text configuration\r\n * @returns CSS font string\r\n */\r\nexport function buildFontString(config: TextConfig): string {\r\n  const parts: string[] = [];\r\n  \r\n  if (config.italic) {\r\n    parts.push('italic');\r\n  }\r\n  \r\n  if (config.bold) {\r\n    parts.push('bold');\r\n  }\r\n  \r\n  parts.push(`${config.fontSize}px`);\r\n  parts.push(config.fontFamily);\r\n  \r\n  return parts.join(' ');\r\n}\r\n\r\n/**\r\n * Measure text dimensions\r\n * @param ctx - Canvas 2D context\r\n * @param text - Text to measure\r\n * @param config - Text configuration\r\n * @returns Text dimensions\r\n */\r\nexport function measureText(\r\n  ctx: CanvasRenderingContext2D,\r\n  text: string,\r\n  config: TextConfig\r\n): { width: number; height: number } {\r\n  const originalFont = ctx.font;\r\n  ctx.font = buildFontString(config);\r\n  \r\n  const lines = text.split('\\n');\r\n  const lineHeight = config.fontSize * config.lineHeight;\r\n  \r\n  let maxWidth = 0;\r\n  for (const line of lines) {\r\n    const metrics = ctx.measureText(line);\r\n    maxWidth = Math.max(maxWidth, metrics.width);\r\n  }\r\n  \r\n  ctx.font = originalFont;\r\n  \r\n  return {\r\n    width: maxWidth,\r\n    height: lines.length * lineHeight,\r\n  };\r\n}\r\n\r\n/**\r\n * Get text bounding box\r\n * @param layer - Text layer\r\n * @param ctx - Canvas 2D context\r\n * @returns Bounding box coordinates\r\n */\r\nexport function getTextBoundingBox(\r\n  layer: TextLayer,\r\n  ctx: CanvasRenderingContext2D\r\n): { x: number; y: number; width: number; height: number } {\r\n  const dimensions = measureText(ctx, layer.text, layer.config);\r\n  \r\n  let x = layer.x;\r\n  \r\n  // Adjust x based on alignment\r\n  if (layer.config.align === 'center') {\r\n    x -= dimensions.width / 2;\r\n  } else if (layer.config.align === 'right') {\r\n    x -= dimensions.width;\r\n  }\r\n  \r\n  return {\r\n    x,\r\n    y: layer.y - layer.config.fontSize,\r\n    width: dimensions.width,\r\n    height: dimensions.height,\r\n  };\r\n}\r\n\r\n\r\n/**\r\n * Check if a point is inside a text layer's bounding box\r\n * @param x - X coordinate\r\n * @param y - Y coordinate\r\n * @param layer - Text layer\r\n * @param ctx - Canvas 2D context\r\n * @param padding - Optional padding around the bounding box\r\n * @returns True if point is inside\r\n */\r\nexport function isPointInTextLayer(\r\n  x: number,\r\n  y: number,\r\n  layer: TextLayer,\r\n  ctx: CanvasRenderingContext2D,\r\n  padding: number = 5\r\n): boolean {\r\n  const box = getTextBoundingBox(layer, ctx);\r\n  \r\n  return (\r\n    x >= box.x - padding &&\r\n    x <= box.x + box.width + padding &&\r\n    y >= box.y - padding &&\r\n    y <= box.y + box.height + padding\r\n  );\r\n}\r\n\r\n/**\r\n * Find text layer at a given point\r\n * @param x - X coordinate\r\n * @param y - Y coordinate\r\n * @param layers - Array of text layers\r\n * @param ctx - Canvas 2D context\r\n * @returns Found layer or undefined\r\n */\r\nexport function findTextLayerAtPoint(\r\n  x: number,\r\n  y: number,\r\n  layers: TextLayer[],\r\n  ctx: CanvasRenderingContext2D\r\n): TextLayer | undefined {\r\n  // Search in reverse order (top layers first)\r\n  for (let i = layers.length - 1; i >= 0; i--) {\r\n    if (isPointInTextLayer(x, y, layers[i], ctx)) {\r\n      return layers[i];\r\n    }\r\n  }\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Render a single text layer to canvas\r\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.6\r\n * @param ctx - Canvas 2D context\r\n * @param layer - Text layer to render\r\n * @param isSelected - Whether the layer is selected\r\n */\r\nexport function renderTextLayer(\r\n  ctx: CanvasRenderingContext2D,\r\n  layer: TextLayer,\r\n  isSelected: boolean = false\r\n): void {\r\n  const { text, x, y, config } = layer;\r\n  \r\n  // Save context state\r\n  ctx.save();\r\n  \r\n  // Set font properties\r\n  ctx.font = buildFontString(config);\r\n  ctx.fillStyle = config.color;\r\n  ctx.textAlign = config.align;\r\n  ctx.textBaseline = 'alphabetic';\r\n  \r\n  // Render each line\r\n  const lines = text.split('\\n');\r\n  const lineHeight = config.fontSize * config.lineHeight;\r\n  \r\n  for (let i = 0; i < lines.length; i++) {\r\n    const lineY = y + i * lineHeight;\r\n    ctx.fillText(lines[i], x, lineY);\r\n    \r\n    // Draw underline if enabled\r\n    if (config.underline) {\r\n      drawUnderline(ctx, lines[i], x, lineY, config);\r\n    }\r\n  }\r\n  \r\n  // Draw selection box if selected\r\n  if (isSelected) {\r\n    drawSelectionBox(ctx, layer);\r\n  }\r\n  \r\n  // Restore context state\r\n  ctx.restore();\r\n}\r\n\r\n/**\r\n * Draw underline for text\r\n * Requirements: 4.5\r\n * @param ctx - Canvas 2D context\r\n * @param text - Text content\r\n * @param x - X position\r\n * @param y - Y position\r\n * @param config - Text configuration\r\n */\r\nfunction drawUnderline(\r\n  ctx: CanvasRenderingContext2D,\r\n  text: string,\r\n  x: number,\r\n  y: number,\r\n  config: TextConfig\r\n): void {\r\n  const metrics = ctx.measureText(text);\r\n  const underlineY = y + config.fontSize * 0.1;\r\n  const underlineThickness = Math.max(1, config.fontSize / 12);\r\n  \r\n  let startX = x;\r\n  if (config.align === 'center') {\r\n    startX = x - metrics.width / 2;\r\n  } else if (config.align === 'right') {\r\n    startX = x - metrics.width;\r\n  }\r\n  \r\n  ctx.strokeStyle = config.color;\r\n  ctx.lineWidth = underlineThickness;\r\n  ctx.beginPath();\r\n  ctx.moveTo(startX, underlineY);\r\n  ctx.lineTo(startX + metrics.width, underlineY);\r\n  ctx.stroke();\r\n}\r\n\r\n/**\r\n * Draw selection box around text layer\r\n * @param ctx - Canvas 2D context\r\n * @param layer - Text layer\r\n */\r\nfunction drawSelectionBox(\r\n  ctx: CanvasRenderingContext2D,\r\n  layer: TextLayer\r\n): void {\r\n  const box = getTextBoundingBox(layer, ctx);\r\n  const padding = 4;\r\n  \r\n  ctx.strokeStyle = '#0066ff';\r\n  ctx.lineWidth = 1;\r\n  ctx.setLineDash([4, 4]);\r\n  ctx.strokeRect(\r\n    box.x - padding,\r\n    box.y - padding,\r\n    box.width + padding * 2,\r\n    box.height + padding * 2\r\n  );\r\n  ctx.setLineDash([]);\r\n  \r\n  // Draw resize handles\r\n  const handleSize = 6;\r\n  ctx.fillStyle = '#0066ff';\r\n  \r\n  // Corner handles\r\n  const corners = [\r\n    { x: box.x - padding, y: box.y - padding },\r\n    { x: box.x + box.width + padding, y: box.y - padding },\r\n    { x: box.x - padding, y: box.y + box.height + padding },\r\n    { x: box.x + box.width + padding, y: box.y + box.height + padding },\r\n  ];\r\n  \r\n  for (const corner of corners) {\r\n    ctx.fillRect(\r\n      corner.x - handleSize / 2,\r\n      corner.y - handleSize / 2,\r\n      handleSize,\r\n      handleSize\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Render all text layers\r\n * @param ctx - Canvas 2D context\r\n * @param layers - Array of text layers\r\n * @param selectedId - ID of selected layer (optional)\r\n */\r\nexport function renderAllTextLayers(\r\n  ctx: CanvasRenderingContext2D,\r\n  layers: TextLayer[],\r\n  selectedId?: string | null\r\n): void {\r\n  for (const layer of layers) {\r\n    renderTextLayer(ctx, layer, layer.id === selectedId);\r\n  }\r\n}\r\n","/**\r\n * TextPlugin - Manages text overlays on the canvas\r\n * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6\r\n */\r\n\r\nimport { BasePlugin } from '../base/BasePlugin';\r\nimport type { TextConfig } from '../../types/config.types';\r\nimport type { TextPluginInterface, TextLayer } from '../../types/plugin.types';\r\nimport { normalizePointerEvent } from '../../utils/event.utils';\r\nimport { getResolvedDeviceType, getNonPassiveOptions } from '../../utils/device.utils';\r\nimport { TextLayerManager, DEFAULT_TEXT_CONFIG } from './TextLayer';\r\nimport {\r\n  renderAllTextLayers,\r\n  findTextLayerAtPoint,\r\n} from './text.utils';\r\n\r\n/**\r\n * Drag state for tracking text layer dragging\r\n */\r\ninterface DragState {\r\n  isDragging: boolean;\r\n  layerId: string | null;\r\n  startX: number;\r\n  startY: number;\r\n  offsetX: number;\r\n  offsetY: number;\r\n}\r\n\r\n/**\r\n * TextPlugin class - Implements text overlay functionality\r\n * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6\r\n */\r\nexport class TextPlugin extends BasePlugin<TextConfig> implements TextPluginInterface {\r\n  readonly name = 'text' as const;\r\n  readonly icon = 'T';\r\n  readonly title = 'Text';\r\n\r\n  /** Text layer manager */\r\n  private layerManager: TextLayerManager = new TextLayerManager();\r\n  \r\n  /** Base image data (without text layers) */\r\n  private baseImageData: ImageData | null = null;\r\n  \r\n  /** Drag state */\r\n  private dragState: DragState = {\r\n    isDragging: false,\r\n    layerId: null,\r\n    startX: 0,\r\n    startY: 0,\r\n    offsetX: 0,\r\n    offsetY: 0,\r\n  };\r\n\r\n  /** Event cleanup functions */\r\n  private cleanupFunctions: Array<() => void> = [];\r\n\r\n  /**\r\n   * Get default text configuration\r\n   * Requirements: 4.2, 4.3, 4.5, 4.6\r\n   */\r\n  getDefaultConfig(): TextConfig {\r\n    return { ...DEFAULT_TEXT_CONFIG };\r\n  }\r\n\r\n\r\n  /**\r\n   * Add text at specified position\r\n   * Requirements: 4.1\r\n   * @param text - Text content\r\n   * @param x - X position\r\n   * @param y - Y position\r\n   * @returns Created text layer\r\n   */\r\n  addText(text: string, x: number, y: number): TextLayer {\r\n    // Save base image if not already saved\r\n    if (!this.baseImageData) {\r\n      this.saveBaseImage();\r\n    }\r\n    \r\n    const layer = this.layerManager.createLayer(text, x, y, this.config);\r\n    this.layerManager.selectLayer(layer.id);\r\n    this.renderLayers();\r\n    this.saveState();\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Update text content of a layer\r\n   * Requirements: 4.1\r\n   * @param id - Layer ID\r\n   * @param text - New text content\r\n   */\r\n  updateText(id: string, text: string): void {\r\n    const layer = this.layerManager.updateText(id, text);\r\n    if (layer) {\r\n      this.renderLayers();\r\n      this.saveState();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update position of a layer\r\n   * Requirements: 4.4\r\n   * @param id - Layer ID\r\n   * @param x - New X position\r\n   * @param y - New Y position\r\n   */\r\n  updatePosition(id: string, x: number, y: number): void {\r\n    const layer = this.layerManager.updatePosition(id, x, y);\r\n    if (layer) {\r\n      this.renderLayers();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update configuration of a layer\r\n   * Requirements: 4.2, 4.3, 4.5, 4.6\r\n   * @param id - Layer ID\r\n   * @param config - Partial configuration to merge\r\n   */\r\n  updateConfig(id: string, config: Partial<TextConfig>): void {\r\n    const layer = this.layerManager.updateConfig(id, config);\r\n    if (layer) {\r\n      this.renderLayers();\r\n      this.saveState();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a text layer\r\n   * @param id - Layer ID\r\n   */\r\n  removeText(id: string): void {\r\n    if (this.layerManager.removeLayer(id)) {\r\n      this.renderLayers();\r\n      this.saveState();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all text layers\r\n   * @returns Array of text layers\r\n   */\r\n  getTextLayers(): TextLayer[] {\r\n    return this.layerManager.getAllLayers();\r\n  }\r\n\r\n  /**\r\n   * Get selected layer\r\n   * @returns Selected layer or undefined\r\n   */\r\n  getSelectedLayer(): TextLayer | undefined {\r\n    return this.layerManager.getSelectedLayer();\r\n  }\r\n\r\n  /**\r\n   * Select a layer by ID\r\n   * @param id - Layer ID or null to deselect\r\n   */\r\n  selectLayer(id: string | null): void {\r\n    this.layerManager.selectLayer(id);\r\n    this.renderLayers();\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is activated\r\n   * Sets up event listeners\r\n   */\r\n  protected onActivate(): void {\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    // Save current image as base\r\n    this.saveBaseImage();\r\n    this.setupEventListeners(canvas);\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is deactivated\r\n   * Cleans up event listeners\r\n   */\r\n  protected onDeactivate(): void {\r\n    this.cleanupEventListeners();\r\n    this.resetDragState();\r\n  }\r\n\r\n  /**\r\n   * Called when plugin is destroyed\r\n   */\r\n  protected onDestroy(): void {\r\n    this.cleanupEventListeners();\r\n    this.layerManager.clearAll();\r\n    this.baseImageData = null;\r\n  }\r\n\r\n\r\n  /**\r\n   * Save base image data (without text layers)\r\n   */\r\n  private saveBaseImage(): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n    \r\n    this.baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n  }\r\n\r\n  /**\r\n   * Render all text layers on top of base image\r\n   */\r\n  private renderLayers(): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n\r\n    // Restore base image\r\n    if (this.baseImageData) {\r\n      ctx.putImageData(this.baseImageData, 0, 0);\r\n    }\r\n\r\n    // Render all text layers\r\n    const layers = this.layerManager.getAllLayers();\r\n    const selectedId = this.layerManager.getSelectedLayerId();\r\n    renderAllTextLayers(ctx, layers, selectedId);\r\n  }\r\n\r\n  /**\r\n   * Set up mouse and touch event listeners\r\n   * Requirements: 4.4 - Touch event support for dragging\r\n   */\r\n  private setupEventListeners(canvas: HTMLCanvasElement): void {\r\n    const deviceType = getResolvedDeviceType('auto');\r\n    const nonPassiveOptions = getNonPassiveOptions();\r\n\r\n    if (deviceType === 'mobile') {\r\n      // Touch events for mobile\r\n      const touchStartHandler = this.handleTouchStart.bind(this);\r\n      const touchMoveHandler = this.handleTouchMove.bind(this);\r\n      const touchEndHandler = this.handleTouchEnd.bind(this);\r\n\r\n      canvas.addEventListener('touchstart', touchStartHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchmove', touchMoveHandler, nonPassiveOptions);\r\n      canvas.addEventListener('touchend', touchEndHandler);\r\n      canvas.addEventListener('touchcancel', touchEndHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('touchstart', touchStartHandler),\r\n        () => canvas.removeEventListener('touchmove', touchMoveHandler),\r\n        () => canvas.removeEventListener('touchend', touchEndHandler),\r\n        () => canvas.removeEventListener('touchcancel', touchEndHandler)\r\n      );\r\n    } else {\r\n      // Mouse events for PC\r\n      const mouseDownHandler = this.handleMouseDown.bind(this);\r\n      const mouseMoveHandler = this.handleMouseMove.bind(this);\r\n      const mouseUpHandler = this.handleMouseUp.bind(this);\r\n      const dblClickHandler = this.handleDoubleClick.bind(this);\r\n\r\n      canvas.addEventListener('mousedown', mouseDownHandler);\r\n      canvas.addEventListener('mousemove', mouseMoveHandler);\r\n      canvas.addEventListener('mouseup', mouseUpHandler);\r\n      canvas.addEventListener('mouseleave', mouseUpHandler);\r\n      canvas.addEventListener('dblclick', dblClickHandler);\r\n\r\n      this.cleanupFunctions.push(\r\n        () => canvas.removeEventListener('mousedown', mouseDownHandler),\r\n        () => canvas.removeEventListener('mousemove', mouseMoveHandler),\r\n        () => canvas.removeEventListener('mouseup', mouseUpHandler),\r\n        () => canvas.removeEventListener('mouseleave', mouseUpHandler),\r\n        () => canvas.removeEventListener('dblclick', dblClickHandler)\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up all event listeners\r\n   */\r\n  private cleanupEventListeners(): void {\r\n    for (const cleanup of this.cleanupFunctions) {\r\n      cleanup();\r\n    }\r\n    this.cleanupFunctions = [];\r\n  }\r\n\r\n  /**\r\n   * Reset drag state\r\n   */\r\n  private resetDragState(): void {\r\n    this.dragState = {\r\n      isDragging: false,\r\n      layerId: null,\r\n      startX: 0,\r\n      startY: 0,\r\n      offsetX: 0,\r\n      offsetY: 0,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle mouse down event\r\n   */\r\n  private handleMouseDown(event: MouseEvent): void {\r\n    const canvas = this.getCanvas();\r\n    const ctx = this.getContext();\r\n    if (!canvas || !ctx) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startInteraction(pointerEvent.x, pointerEvent.y, ctx);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse move event\r\n   */\r\n  private handleMouseMove(event: MouseEvent): void {\r\n    if (!this.dragState.isDragging) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrag(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle mouse up event\r\n   */\r\n  private handleMouseUp(): void {\r\n    if (this.dragState.isDragging) {\r\n      this.endDrag();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle double click event - add new text\r\n   */\r\n  private handleDoubleClick(event: MouseEvent): void {\r\n    const canvas = this.getCanvas();\r\n    const ctx = this.getContext();\r\n    if (!canvas || !ctx) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    \r\n    // Check if clicking on existing layer\r\n    const layers = this.layerManager.getAllLayers();\r\n    const clickedLayer = findTextLayerAtPoint(pointerEvent.x, pointerEvent.y, layers, ctx);\r\n    \r\n    if (!clickedLayer) {\r\n      // Add new text at click position\r\n      const defaultText = 'Double click to edit';\r\n      this.addText(defaultText, pointerEvent.x, pointerEvent.y);\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle touch start event\r\n   */\r\n  private handleTouchStart(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    const canvas = this.getCanvas();\r\n    const ctx = this.getContext();\r\n    if (!canvas || !ctx) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'start');\r\n    this.startInteraction(pointerEvent.x, pointerEvent.y, ctx);\r\n  }\r\n\r\n  /**\r\n   * Handle touch move event\r\n   */\r\n  private handleTouchMove(event: TouchEvent): void {\r\n    event.preventDefault();\r\n    if (!this.dragState.isDragging) return;\r\n\r\n    const canvas = this.getCanvas();\r\n    if (!canvas) return;\r\n\r\n    const pointerEvent = normalizePointerEvent(event, canvas, 'move');\r\n    this.continueDrag(pointerEvent.x, pointerEvent.y);\r\n  }\r\n\r\n  /**\r\n   * Handle touch end event\r\n   */\r\n  private handleTouchEnd(): void {\r\n    if (this.dragState.isDragging) {\r\n      this.endDrag();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start interaction (select or drag)\r\n   */\r\n  private startInteraction(x: number, y: number, ctx: CanvasRenderingContext2D): void {\r\n    const layers = this.layerManager.getAllLayers();\r\n    const clickedLayer = findTextLayerAtPoint(x, y, layers, ctx);\r\n\r\n    if (clickedLayer) {\r\n      // Select and start dragging\r\n      this.layerManager.selectLayer(clickedLayer.id);\r\n      \r\n      this.dragState = {\r\n        isDragging: true,\r\n        layerId: clickedLayer.id,\r\n        startX: x,\r\n        startY: y,\r\n        offsetX: x - clickedLayer.x,\r\n        offsetY: y - clickedLayer.y,\r\n      };\r\n      \r\n      this.renderLayers();\r\n    } else {\r\n      // Deselect\r\n      this.layerManager.selectLayer(null);\r\n      this.renderLayers();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Continue drag operation\r\n   * Requirements: 4.4\r\n   */\r\n  private continueDrag(x: number, y: number): void {\r\n    if (!this.dragState.isDragging || !this.dragState.layerId) return;\r\n\r\n    const newX = x - this.dragState.offsetX;\r\n    const newY = y - this.dragState.offsetY;\r\n\r\n    this.layerManager.updatePosition(this.dragState.layerId, newX, newY);\r\n    this.renderLayers();\r\n  }\r\n\r\n  /**\r\n   * End drag operation\r\n   * Requirements: 4.4\r\n   */\r\n  private endDrag(): void {\r\n    if (this.dragState.isDragging && this.dragState.layerId) {\r\n      this.saveState();\r\n    }\r\n    this.resetDragState();\r\n  }\r\n\r\n  /**\r\n   * Flatten text layers into the base image\r\n   * Call this before exporting or when finalizing edits\r\n   */\r\n  flattenLayers(): void {\r\n    const ctx = this.getContext();\r\n    const canvas = this.getCanvas();\r\n    if (!ctx || !canvas) return;\r\n\r\n    // Render layers without selection\r\n    if (this.baseImageData) {\r\n      ctx.putImageData(this.baseImageData, 0, 0);\r\n    }\r\n    \r\n    const layers = this.layerManager.getAllLayers();\r\n    renderAllTextLayers(ctx, layers, null);\r\n\r\n    // Update base image with flattened result\r\n    this.baseImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n    \r\n    // Clear layers\r\n    this.layerManager.clearAll();\r\n  }\r\n\r\n  /**\r\n   * Update base image (call after external canvas changes)\r\n   */\r\n  updateBaseImage(): void {\r\n    this.saveBaseImage();\r\n    this.renderLayers();\r\n  }\r\n}\r\n","/**\r\n * Brightness filter algorithm\r\n * Requirements: 5.3 - Support brightness filter\r\n */\r\n\r\n/**\r\n * Apply brightness adjustment to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Brightness value from -100 to 100 (0 = no change)\r\n */\r\nexport function applyBrightness(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert -100 to 100 range to -255 to 255 adjustment\r\n  const adjustment = (value / 100) * 255;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    data[i] = clamp(data[i] + adjustment);     // R\r\n    data[i + 1] = clamp(data[i + 1] + adjustment); // G\r\n    data[i + 2] = clamp(data[i + 2] + adjustment); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to the 0-255 range\r\n */\r\nfunction clamp(value: number): number {\r\n  return Math.max(0, Math.min(255, Math.round(value)));\r\n}\r\n","/**\r\n * Contrast filter algorithm\r\n * Requirements: 5.3 - Support contrast filter\r\n */\r\n\r\n/**\r\n * Apply contrast adjustment to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Contrast value from -100 to 100 (0 = no change)\r\n */\r\nexport function applyContrast(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert -100 to 100 range to contrast factor\r\n  // At value = 100, factor ≈ 2.59 (high contrast)\r\n  // At value = -100, factor ≈ 0 (no contrast, all gray)\r\n  const factor = (259 * (value + 255)) / (255 * (259 - value));\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    data[i] = clamp(factor * (data[i] - 128) + 128);     // R\r\n    data[i + 1] = clamp(factor * (data[i + 1] - 128) + 128); // G\r\n    data[i + 2] = clamp(factor * (data[i + 2] - 128) + 128); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to the 0-255 range\r\n */\r\nfunction clamp(value: number): number {\r\n  return Math.max(0, Math.min(255, Math.round(value)));\r\n}\r\n","/**\r\n * Saturation filter algorithm\r\n * Requirements: 5.3 - Support saturation filter\r\n */\r\n\r\n/**\r\n * Apply saturation adjustment to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Saturation value from -100 to 100 (0 = no change)\r\n */\r\nexport function applySaturation(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert -100 to 100 range to saturation multiplier\r\n  // At value = -100, multiplier = 0 (grayscale)\r\n  // At value = 0, multiplier = 1 (no change)\r\n  // At value = 100, multiplier = 2 (double saturation)\r\n  const multiplier = 1 + value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Calculate grayscale value using luminance formula\r\n    const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;\r\n\r\n    // Interpolate between grayscale and original color\r\n    data[i] = clamp(gray + (r - gray) * multiplier);     // R\r\n    data[i + 1] = clamp(gray + (g - gray) * multiplier); // G\r\n    data[i + 2] = clamp(gray + (b - gray) * multiplier); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to the 0-255 range\r\n */\r\nfunction clamp(value: number): number {\r\n  return Math.max(0, Math.min(255, Math.round(value)));\r\n}\r\n","/**\r\n * Blur filter algorithm (Box blur)\r\n * Requirements: 5.3 - Support blur filter\r\n */\r\n\r\n/**\r\n * Apply blur effect to image data using box blur algorithm\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Blur value from 0 to 100 (0 = no blur)\r\n */\r\nexport function applyBlur(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const { width, height, data } = imageData;\r\n  // Convert 0-100 range to blur radius (0-10 pixels)\r\n  const radius = Math.round((value / 100) * 10);\r\n  \r\n  if (radius === 0) return;\r\n\r\n  // Create a copy of the original data\r\n  const original = new Uint8ClampedArray(data);\r\n\r\n  // Apply horizontal blur pass\r\n  const temp = new Uint8ClampedArray(data.length);\r\n  horizontalBlur(original, temp, width, height, radius);\r\n\r\n  // Apply vertical blur pass\r\n  verticalBlur(temp, data, width, height, radius);\r\n}\r\n\r\n/**\r\n * Horizontal blur pass\r\n */\r\nfunction horizontalBlur(\r\n  src: Uint8ClampedArray,\r\n  dst: Uint8ClampedArray,\r\n  width: number,\r\n  height: number,\r\n  radius: number\r\n): void {\r\n  const diameter = radius * 2 + 1;\r\n\r\n  for (let y = 0; y < height; y++) {\r\n    let rSum = 0, gSum = 0, bSum = 0, aSum = 0;\r\n    \r\n    // Initialize sum for first pixel\r\n    for (let x = -radius; x <= radius; x++) {\r\n      const px = Math.max(0, Math.min(width - 1, x));\r\n      const idx = (y * width + px) * 4;\r\n      rSum += src[idx];\r\n      gSum += src[idx + 1];\r\n      bSum += src[idx + 2];\r\n      aSum += src[idx + 3];\r\n    }\r\n\r\n    for (let x = 0; x < width; x++) {\r\n      const dstIdx = (y * width + x) * 4;\r\n      dst[dstIdx] = Math.round(rSum / diameter);\r\n      dst[dstIdx + 1] = Math.round(gSum / diameter);\r\n      dst[dstIdx + 2] = Math.round(bSum / diameter);\r\n      dst[dstIdx + 3] = Math.round(aSum / diameter);\r\n\r\n      // Slide the window\r\n      const leftX = Math.max(0, x - radius);\r\n      const rightX = Math.min(width - 1, x + radius + 1);\r\n      \r\n      const leftIdx = (y * width + leftX) * 4;\r\n      const rightIdx = (y * width + rightX) * 4;\r\n\r\n      rSum += src[rightIdx] - src[leftIdx];\r\n      gSum += src[rightIdx + 1] - src[leftIdx + 1];\r\n      bSum += src[rightIdx + 2] - src[leftIdx + 2];\r\n      aSum += src[rightIdx + 3] - src[leftIdx + 3];\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Vertical blur pass\r\n */\r\nfunction verticalBlur(\r\n  src: Uint8ClampedArray,\r\n  dst: Uint8ClampedArray,\r\n  width: number,\r\n  height: number,\r\n  radius: number\r\n): void {\r\n  const diameter = radius * 2 + 1;\r\n\r\n  for (let x = 0; x < width; x++) {\r\n    let rSum = 0, gSum = 0, bSum = 0, aSum = 0;\r\n    \r\n    // Initialize sum for first pixel\r\n    for (let y = -radius; y <= radius; y++) {\r\n      const py = Math.max(0, Math.min(height - 1, y));\r\n      const idx = (py * width + x) * 4;\r\n      rSum += src[idx];\r\n      gSum += src[idx + 1];\r\n      bSum += src[idx + 2];\r\n      aSum += src[idx + 3];\r\n    }\r\n\r\n    for (let y = 0; y < height; y++) {\r\n      const dstIdx = (y * width + x) * 4;\r\n      dst[dstIdx] = Math.round(rSum / diameter);\r\n      dst[dstIdx + 1] = Math.round(gSum / diameter);\r\n      dst[dstIdx + 2] = Math.round(bSum / diameter);\r\n      dst[dstIdx + 3] = Math.round(aSum / diameter);\r\n\r\n      // Slide the window\r\n      const topY = Math.max(0, y - radius);\r\n      const bottomY = Math.min(height - 1, y + radius + 1);\r\n      \r\n      const topIdx = (topY * width + x) * 4;\r\n      const bottomIdx = (bottomY * width + x) * 4;\r\n\r\n      rSum += src[bottomIdx] - src[topIdx];\r\n      gSum += src[bottomIdx + 1] - src[topIdx + 1];\r\n      bSum += src[bottomIdx + 2] - src[topIdx + 2];\r\n      aSum += src[bottomIdx + 3] - src[topIdx + 3];\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Grayscale filter algorithm\r\n * Requirements: 5.3 - Support grayscale filter\r\n */\r\n\r\n/**\r\n * Apply grayscale effect to image data\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Grayscale value from 0 to 100 (0 = no effect, 100 = full grayscale)\r\n */\r\nexport function applyGrayscale(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert 0-100 range to blend factor (0-1)\r\n  const factor = value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Calculate grayscale value using luminance formula (ITU-R BT.709)\r\n    const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;\r\n\r\n    // Blend between original and grayscale based on factor\r\n    data[i] = Math.round(r + (gray - r) * factor);     // R\r\n    data[i + 1] = Math.round(g + (gray - g) * factor); // G\r\n    data[i + 2] = Math.round(b + (gray - b) * factor); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Apply sepia effect to image data\r\n * Requirements: 5.3 - Support sepia (vintage) filter\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Sepia value from 0 to 100 (0 = no effect, 100 = full sepia)\r\n */\r\nexport function applySepia(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert 0-100 range to blend factor (0-1)\r\n  const factor = value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Sepia transformation matrix\r\n    const sepiaR = Math.min(255, 0.393 * r + 0.769 * g + 0.189 * b);\r\n    const sepiaG = Math.min(255, 0.349 * r + 0.686 * g + 0.168 * b);\r\n    const sepiaB = Math.min(255, 0.272 * r + 0.534 * g + 0.131 * b);\r\n\r\n    // Blend between original and sepia based on factor\r\n    data[i] = Math.round(r + (sepiaR - r) * factor);     // R\r\n    data[i + 1] = Math.round(g + (sepiaG - g) * factor); // G\r\n    data[i + 2] = Math.round(b + (sepiaB - b) * factor); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n\r\n/**\r\n * Apply invert (negative) effect to image data\r\n * Requirements: 5.3 - Support invert filter\r\n * @param imageData - The image data to modify (modified in place)\r\n * @param value - Invert value from 0 to 100 (0 = no effect, 100 = full invert)\r\n */\r\nexport function applyInvert(imageData: ImageData, value: number): void {\r\n  if (value === 0) return;\r\n\r\n  const data = imageData.data;\r\n  // Convert 0-100 range to blend factor (0-1)\r\n  const factor = value / 100;\r\n\r\n  for (let i = 0; i < data.length; i += 4) {\r\n    const r = data[i];\r\n    const g = data[i + 1];\r\n    const b = data[i + 2];\r\n\r\n    // Inverted colors\r\n    const invertR = 255 - r;\r\n    const invertG = 255 - g;\r\n    const invertB = 255 - b;\r\n\r\n    // Blend between original and inverted based on factor\r\n    data[i] = Math.round(r + (invertR - r) * factor);     // R\r\n    data[i + 1] = Math.round(g + (invertG - g) * factor); // G\r\n    data[i + 2] = Math.round(b + (invertB - b) * factor); // B\r\n    // Alpha channel (i + 3) remains unchanged\r\n  }\r\n}\r\n","/**\r\n * Filter Plugin - Apply various image filters\r\n * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5\r\n */\r\n\r\nimport { BasePlugin } from '../base/BasePlugin';\r\nimport type { FilterConfig } from '../../types/config.types';\r\nimport type { FilterPluginInterface } from '../../types/plugin.types';\r\nimport {\r\n  applyBrightness,\r\n  applyContrast,\r\n  applySaturation,\r\n  applyBlur,\r\n  applyGrayscale,\r\n  applySepia,\r\n  applyInvert,\r\n} from './filters';\r\n\r\n/**\r\n * Default filter configuration\r\n */\r\nconst DEFAULT_FILTER_CONFIG: FilterConfig = {\r\n  brightness: 0,\r\n  contrast: 0,\r\n  saturation: 0,\r\n  blur: 0,\r\n  grayscale: 0,\r\n  sepia: 0,\r\n  invert: 0,\r\n};\r\n\r\n/**\r\n * FilterPlugin - Provides image filter functionality\r\n * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5\r\n */\r\nexport class FilterPlugin extends BasePlugin<FilterConfig> implements FilterPluginInterface {\r\n  readonly name = 'filter' as const;\r\n  readonly icon = '🎨';\r\n  readonly title = 'Filter';\r\n\r\n  /** Original image data before any filters applied */\r\n  private originalImageData: ImageData | null = null;\r\n\r\n  /**\r\n   * Get default filter configuration\r\n   */\r\n  getDefaultConfig(): FilterConfig {\r\n    return { ...DEFAULT_FILTER_CONFIG };\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is installed\r\n   */\r\n  protected onInstall(): void {\r\n    // Store original image data when installed\r\n    this.storeOriginalImageData();\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is activated\r\n   */\r\n  protected onActivate(): void {\r\n    // Ensure we have original image data\r\n    if (!this.originalImageData) {\r\n      this.storeOriginalImageData();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Store the original image data for reset functionality\r\n   */\r\n  private storeOriginalImageData(): void {\r\n    const imageData = this.getImageData();\r\n    if (imageData) {\r\n      this.originalImageData = createImageDataCopy(imageData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update original image data (call after external changes)\r\n   */\r\n  updateOriginalImageData(): void {\r\n    this.storeOriginalImageData();\r\n  }\r\n\r\n  /**\r\n   * Set brightness value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Brightness value from -100 to 100\r\n   */\r\n  setBrightness(value: number): void {\r\n    this.setConfig({ brightness: clampValue(value, -100, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set contrast value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Contrast value from -100 to 100\r\n   */\r\n  setContrast(value: number): void {\r\n    this.setConfig({ contrast: clampValue(value, -100, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set saturation value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Saturation value from -100 to 100\r\n   */\r\n  setSaturation(value: number): void {\r\n    this.setConfig({ saturation: clampValue(value, -100, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set blur value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Blur value from 0 to 100\r\n   */\r\n  setBlur(value: number): void {\r\n    this.setConfig({ blur: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set grayscale value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Grayscale value from 0 to 100\r\n   */\r\n  setGrayscale(value: number): void {\r\n    this.setConfig({ grayscale: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set sepia value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Sepia value from 0 to 100\r\n   */\r\n  setSepia(value: number): void {\r\n    this.setConfig({ sepia: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Set invert value\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @param value - Invert value from 0 to 100\r\n   */\r\n  setInvert(value: number): void {\r\n    this.setConfig({ invert: clampValue(value, 0, 100) });\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Apply filter configuration\r\n   * Requirements: 5.1 - Apply filter to entire image\r\n   * @param config - Partial filter configuration to apply\r\n   */\r\n  applyFilter(config: Partial<FilterConfig>): void {\r\n    // Clamp all values\r\n    const clampedConfig: Partial<FilterConfig> = {};\r\n    if (config.brightness !== undefined) {\r\n      clampedConfig.brightness = clampValue(config.brightness, -100, 100);\r\n    }\r\n    if (config.contrast !== undefined) {\r\n      clampedConfig.contrast = clampValue(config.contrast, -100, 100);\r\n    }\r\n    if (config.saturation !== undefined) {\r\n      clampedConfig.saturation = clampValue(config.saturation, -100, 100);\r\n    }\r\n    if (config.blur !== undefined) {\r\n      clampedConfig.blur = clampValue(config.blur, 0, 100);\r\n    }\r\n    if (config.grayscale !== undefined) {\r\n      clampedConfig.grayscale = clampValue(config.grayscale, 0, 100);\r\n    }\r\n    if (config.sepia !== undefined) {\r\n      clampedConfig.sepia = clampValue(config.sepia, 0, 100);\r\n    }\r\n    if (config.invert !== undefined) {\r\n      clampedConfig.invert = clampValue(config.invert, 0, 100);\r\n    }\r\n\r\n    this.setConfig(clampedConfig);\r\n    this.applyAllFilters();\r\n  }\r\n\r\n  /**\r\n   * Reset all filters to default values\r\n   * Requirements: 5.5 - Reset to original state\r\n   */\r\n  reset(): void {\r\n    // Reset config to defaults\r\n    this.config = this.getDefaultConfig();\r\n    \r\n    // Restore original image data\r\n    if (this.originalImageData) {\r\n      const restoredData = createImageDataCopy(this.originalImageData);\r\n      this.putImageData(restoredData);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get preview of current filter settings\r\n   * Requirements: 5.2 - Real-time preview\r\n   * @returns ImageData with filters applied\r\n   */\r\n  getPreview(): ImageData {\r\n    if (!this.originalImageData) {\r\n      const currentData = this.getImageData();\r\n      if (!currentData) {\r\n        throw new Error('No image data available');\r\n      }\r\n      return currentData;\r\n    }\r\n\r\n    // Create a copy of original data\r\n    const previewData = createImageDataCopy(this.originalImageData);\r\n\r\n    // Apply all filters to the copy\r\n    this.applyFiltersToImageData(previewData);\r\n\r\n    return previewData;\r\n  }\r\n\r\n  /**\r\n   * Apply all filters in sequence\r\n   * Requirements: 5.4 - Multiple filters stacked in order\r\n   */\r\n  private applyAllFilters(): void {\r\n    if (!this.originalImageData) {\r\n      return;\r\n    }\r\n\r\n    // Start with a fresh copy of original data\r\n    const imageData = createImageDataCopy(this.originalImageData);\r\n\r\n    // Apply all filters\r\n    this.applyFiltersToImageData(imageData);\r\n\r\n    // Put the result back to canvas\r\n    this.putImageData(imageData);\r\n  }\r\n\r\n  /**\r\n   * Apply all configured filters to image data\r\n   * Requirements: 5.4 - Filters applied in order\r\n   * @param imageData - ImageData to modify in place\r\n   */\r\n  private applyFiltersToImageData(imageData: ImageData): void {\r\n    const config = this.config;\r\n\r\n    // Apply filters in a consistent order\r\n    // Order: brightness -> contrast -> saturation -> grayscale -> sepia -> invert -> blur\r\n    // (blur is last because it's computationally expensive and works better on final colors)\r\n    \r\n    if (config.brightness !== 0) {\r\n      applyBrightness(imageData, config.brightness);\r\n    }\r\n    \r\n    if (config.contrast !== 0) {\r\n      applyContrast(imageData, config.contrast);\r\n    }\r\n    \r\n    if (config.saturation !== 0) {\r\n      applySaturation(imageData, config.saturation);\r\n    }\r\n    \r\n    if (config.grayscale !== 0) {\r\n      applyGrayscale(imageData, config.grayscale);\r\n    }\r\n    \r\n    if (config.sepia !== 0) {\r\n      applySepia(imageData, config.sepia);\r\n    }\r\n    \r\n    if (config.invert !== 0) {\r\n      applyInvert(imageData, config.invert);\r\n    }\r\n    \r\n    if (config.blur !== 0) {\r\n      applyBlur(imageData, config.blur);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Commit current filter state to history\r\n   * Call this when user confirms filter changes\r\n   */\r\n  commit(): void {\r\n    this.saveState();\r\n    // Update original image data to current state\r\n    this.storeOriginalImageData();\r\n    // Reset config since changes are now committed\r\n    this.config = this.getDefaultConfig();\r\n  }\r\n\r\n  /**\r\n   * Check if any filter is currently applied\r\n   * @returns True if any filter value is non-zero\r\n   */\r\n  hasActiveFilters(): boolean {\r\n    const config = this.config;\r\n    return (\r\n      config.brightness !== 0 ||\r\n      config.contrast !== 0 ||\r\n      config.saturation !== 0 ||\r\n      config.blur !== 0 ||\r\n      config.grayscale !== 0 ||\r\n      config.sepia !== 0 ||\r\n      config.invert !== 0\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Hook called when plugin is destroyed\r\n   */\r\n  protected onDestroy(): void {\r\n    this.originalImageData = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Clamp a value to a range\r\n */\r\nfunction clampValue(value: number, min: number, max: number): number {\r\n  return Math.max(min, Math.min(max, value));\r\n}\r\n\r\n/**\r\n * Create a copy of ImageData\r\n * Works in both browser and test environments\r\n */\r\nfunction createImageDataCopy(imageData: ImageData): ImageData {\r\n  const data = new Uint8ClampedArray(imageData.data);\r\n  // Try to use ImageData constructor if available (browser)\r\n  if (typeof ImageData !== 'undefined') {\r\n    try {\r\n      return new ImageData(data, imageData.width, imageData.height);\r\n    } catch {\r\n      // Fall through to mock implementation\r\n    }\r\n  }\r\n  // Fallback for test environments\r\n  return {\r\n    data,\r\n    width: imageData.width,\r\n    height: imageData.height,\r\n    colorSpace: 'srgb',\r\n  } as ImageData;\r\n}\r\n","/**\r\n * 中文语言包 (Simplified Chinese)\r\n */\r\nexport const zhCN = {\r\n  // Tool names\r\n  'tool.move': '移动',\r\n  'tool.pen': '画笔',\r\n  'tool.rect': '矩形',\r\n  'tool.circle': '圆形',\r\n  'tool.arrow': '箭头',\r\n  'tool.line': '直线',\r\n  'tool.triangle': '三角形',\r\n  'tool.text': '文字',\r\n  'tool.mosaic': '马赛克',\r\n  'tool.eraser': '橡皮擦',\r\n  'tool.crop': '裁剪',\r\n  'tool.filter': '滤镜',\r\n\r\n  // Zoom controls\r\n  'zoom.in': '放大',\r\n  'zoom.out': '缩小',\r\n  'zoom.reset': '重置视图',\r\n  'zoom.fitScreen': '适应屏幕',\r\n\r\n  // History controls\r\n  'history.undo': '撤销',\r\n  'history.redo': '重做',\r\n\r\n  // Export\r\n  'export.button': '导出',\r\n  'export.title': '导出图片',\r\n  'export.format': '格式',\r\n  'export.quality': '质量',\r\n  'export.size': '尺寸',\r\n  'export.original': '原始尺寸',\r\n  'export.custom': '自定义',\r\n  'export.width': '宽度',\r\n  'export.height': '高度',\r\n  'export.keepRatio': '保持比例',\r\n  'export.watermark': '水印',\r\n  'export.watermarkText': '文字水印',\r\n  'export.watermarkImage': '图片水印',\r\n  'export.preview': '预览',\r\n  'export.download': '下载',\r\n  'export.cancel': '取消',\r\n\r\n  // Panels\r\n  'panel.draw': '绘图设置',\r\n  'panel.strokeWidth': '线宽',\r\n  'panel.strokeColor': '颜色',\r\n  'panel.fillColor': '填充颜色',\r\n  'panel.strokeStyle': '线条样式',\r\n  'panel.solid': '实线',\r\n  'panel.dashed': '虚线',\r\n  'panel.dotted': '点线',\r\n  'panel.fill': '填充',\r\n  'panel.stroke': '描边',\r\n  'panel.both': '描边+填充',\r\n\r\n  'panel.mosaic': '马赛克设置',\r\n  'panel.brushSize': '笔刷大小',\r\n  'panel.blockSize': '色块大小',\r\n\r\n  'panel.text': '文字设置',\r\n  'panel.textHint': '点击图片添加文字',\r\n  'panel.fontSize': '字号',\r\n  'panel.fontFamily': '字体',\r\n  'panel.fontStyle': '样式',\r\n  'panel.bold': '粗体',\r\n  'panel.italic': '斜体',\r\n  'panel.underline': '下划线',\r\n  'panel.textStroke': '文字描边',\r\n  'panel.textStrokeWidth': '描边宽度',\r\n  'panel.textStrokeColor': '描边颜色',\r\n\r\n  'panel.eraser': '橡皮擦设置',\r\n  'panel.eraserSize': '橡皮擦大小',\r\n  'panel.eraserMode': '擦除模式',\r\n  'panel.eraserShape': '擦除形状',\r\n  'panel.eraserPixel': '擦除像素',\r\n\r\n  // Filter\r\n  'filter.title': '滤镜调整',\r\n  'filter.brightness': '亮度',\r\n  'filter.contrast': '对比度',\r\n  'filter.saturation': '饱和度',\r\n  'filter.blur': '模糊',\r\n  'filter.grayscale': '灰度',\r\n  'filter.sepia': '复古',\r\n  'filter.invert': '反色',\r\n  'filter.presets': '预设滤镜',\r\n  'filter.preset.original': '原图',\r\n  'filter.preset.vintage': '复古',\r\n  'filter.preset.cold': '冷色',\r\n  'filter.preset.warm': '暖色',\r\n  'filter.preset.grayscale': '黑白',\r\n  'filter.reset': '重置',\r\n  'filter.apply': '应用',\r\n\r\n  // Crop\r\n  'crop.title': '裁剪',\r\n  'crop.ratio': '裁剪比例',\r\n  'crop.free': '自由',\r\n  'crop.square': '正方形 1:1',\r\n  'crop.ratio43': '标准 4:3',\r\n  'crop.ratio169': '宽屏 16:9',\r\n  'crop.ratio32': '横幅 3:2',\r\n  'crop.rotate': '旋转',\r\n  'crop.rotateLeft': '逆时针90°',\r\n  'crop.rotateRight': '顺时针90°',\r\n  'crop.flipH': '水平翻转',\r\n  'crop.flipV': '垂直翻转',\r\n  'crop.apply': '应用裁剪',\r\n  'crop.cancel': '取消',\r\n\r\n  // Ruler & Grid\r\n  'ruler.show': '显示标尺',\r\n  'ruler.hide': '隐藏标尺',\r\n  'grid.show': '显示网格',\r\n  'grid.hide': '隐藏网格',\r\n\r\n  // Context Menu\r\n  'context.copy': '复制',\r\n  'context.paste': '粘贴',\r\n  'context.delete': '删除',\r\n  'context.bringToFront': '置于顶层',\r\n  'context.sendToBack': '置于底层',\r\n  'context.bringForward': '上移一层',\r\n  'context.sendBackward': '下移一层',\r\n  'context.duplicate': '复制图层',\r\n\r\n  // Messages\r\n  'message.exportSuccess': '导出成功',\r\n  'message.exportFailed': '导出失败',\r\n  'message.loadImageFailed': '加载图片失败',\r\n  'message.noImageLoaded': '请先加载图片',\r\n  'message.cropApplied': '裁剪已应用',\r\n  'message.filterApplied': '滤镜已应用',\r\n  'message.copied': '已复制',\r\n  'message.pasted': '已粘贴',\r\n\r\n  // Placeholder\r\n  'placeholder.title': '点击或拖拽图片到此处',\r\n  'placeholder.subtitle': '支持 JPG、PNG、WebP 格式',\r\n\r\n  // Keyboard shortcuts hints\r\n  'shortcut.undo': 'Ctrl+Z',\r\n  'shortcut.redo': 'Ctrl+Y',\r\n  'shortcut.copy': 'Ctrl+C',\r\n  'shortcut.paste': 'Ctrl+V',\r\n  'shortcut.delete': 'Delete',\r\n  'shortcut.escape': 'Esc',\r\n  'shortcut.zoomIn': '+',\r\n  'shortcut.zoomOut': '-',\r\n};\r\n\r\nexport type LocaleMessages = typeof zhCN;\r\n","/**\r\n * English language pack (US)\r\n */\r\nimport type { LocaleMessages } from './zh-CN';\r\n\r\nexport const enUS: LocaleMessages = {\r\n  // Tool names\r\n  'tool.move': 'Move',\r\n  'tool.pen': 'Pen',\r\n  'tool.rect': 'Rectangle',\r\n  'tool.circle': 'Circle',\r\n  'tool.arrow': 'Arrow',\r\n  'tool.line': 'Line',\r\n  'tool.triangle': 'Triangle',\r\n  'tool.text': 'Text',\r\n  'tool.mosaic': 'Mosaic',\r\n  'tool.eraser': 'Eraser',\r\n  'tool.crop': 'Crop',\r\n  'tool.filter': 'Filter',\r\n\r\n  // Zoom controls\r\n  'zoom.in': 'Zoom In',\r\n  'zoom.out': 'Zoom Out',\r\n  'zoom.reset': 'Reset View',\r\n  'zoom.fitScreen': 'Fit to Screen',\r\n\r\n  // History controls\r\n  'history.undo': 'Undo',\r\n  'history.redo': 'Redo',\r\n\r\n  // Export\r\n  'export.button': 'Export',\r\n  'export.title': 'Export Image',\r\n  'export.format': 'Format',\r\n  'export.quality': 'Quality',\r\n  'export.size': 'Size',\r\n  'export.original': 'Original Size',\r\n  'export.custom': 'Custom',\r\n  'export.width': 'Width',\r\n  'export.height': 'Height',\r\n  'export.keepRatio': 'Keep Ratio',\r\n  'export.watermark': 'Watermark',\r\n  'export.watermarkText': 'Text Watermark',\r\n  'export.watermarkImage': 'Image Watermark',\r\n  'export.preview': 'Preview',\r\n  'export.download': 'Download',\r\n  'export.cancel': 'Cancel',\r\n\r\n  // Panels\r\n  'panel.draw': 'Drawing Settings',\r\n  'panel.strokeWidth': 'Stroke Width',\r\n  'panel.strokeColor': 'Color',\r\n  'panel.fillColor': 'Fill Color',\r\n  'panel.strokeStyle': 'Stroke Style',\r\n  'panel.solid': 'Solid',\r\n  'panel.dashed': 'Dashed',\r\n  'panel.dotted': 'Dotted',\r\n  'panel.fill': 'Fill',\r\n  'panel.stroke': 'Stroke',\r\n  'panel.both': 'Stroke + Fill',\r\n\r\n  'panel.mosaic': 'Mosaic Settings',\r\n  'panel.brushSize': 'Brush Size',\r\n  'panel.blockSize': 'Block Size',\r\n\r\n  'panel.text': 'Text Settings',\r\n  'panel.textHint': 'Click on image to add text',\r\n  'panel.fontSize': 'Font Size',\r\n  'panel.fontFamily': 'Font',\r\n  'panel.fontStyle': 'Style',\r\n  'panel.bold': 'Bold',\r\n  'panel.italic': 'Italic',\r\n  'panel.underline': 'Underline',\r\n  'panel.textStroke': 'Text Stroke',\r\n  'panel.textStrokeWidth': 'Stroke Width',\r\n  'panel.textStrokeColor': 'Stroke Color',\r\n\r\n  'panel.eraser': 'Eraser Settings',\r\n  'panel.eraserSize': 'Eraser Size',\r\n  'panel.eraserMode': 'Eraser Mode',\r\n  'panel.eraserShape': 'Erase Shapes',\r\n  'panel.eraserPixel': 'Erase Pixels',\r\n\r\n  // Filter\r\n  'filter.title': 'Filter Adjustments',\r\n  'filter.brightness': 'Brightness',\r\n  'filter.contrast': 'Contrast',\r\n  'filter.saturation': 'Saturation',\r\n  'filter.blur': 'Blur',\r\n  'filter.grayscale': 'Grayscale',\r\n  'filter.sepia': 'Sepia',\r\n  'filter.invert': 'Invert',\r\n  'filter.presets': 'Preset Filters',\r\n  'filter.preset.original': 'Original',\r\n  'filter.preset.vintage': 'Vintage',\r\n  'filter.preset.cold': 'Cold',\r\n  'filter.preset.warm': 'Warm',\r\n  'filter.preset.grayscale': 'B&W',\r\n  'filter.reset': 'Reset',\r\n  'filter.apply': 'Apply',\r\n\r\n  // Crop\r\n  'crop.title': 'Crop',\r\n  'crop.ratio': 'Aspect Ratio',\r\n  'crop.free': 'Free',\r\n  'crop.square': 'Square 1:1',\r\n  'crop.ratio43': 'Standard 4:3',\r\n  'crop.ratio169': 'Wide 16:9',\r\n  'crop.ratio32': 'Photo 3:2',\r\n  'crop.rotate': 'Rotate',\r\n  'crop.rotateLeft': 'Rotate Left 90°',\r\n  'crop.rotateRight': 'Rotate Right 90°',\r\n  'crop.flipH': 'Flip Horizontal',\r\n  'crop.flipV': 'Flip Vertical',\r\n  'crop.apply': 'Apply Crop',\r\n  'crop.cancel': 'Cancel',\r\n\r\n  // Ruler & Grid\r\n  'ruler.show': 'Show Rulers',\r\n  'ruler.hide': 'Hide Rulers',\r\n  'grid.show': 'Show Grid',\r\n  'grid.hide': 'Hide Grid',\r\n\r\n  // Context Menu\r\n  'context.copy': 'Copy',\r\n  'context.paste': 'Paste',\r\n  'context.delete': 'Delete',\r\n  'context.bringToFront': 'Bring to Front',\r\n  'context.sendToBack': 'Send to Back',\r\n  'context.bringForward': 'Bring Forward',\r\n  'context.sendBackward': 'Send Backward',\r\n  'context.duplicate': 'Duplicate',\r\n\r\n  // Messages\r\n  'message.exportSuccess': 'Export successful',\r\n  'message.exportFailed': 'Export failed',\r\n  'message.loadImageFailed': 'Failed to load image',\r\n  'message.noImageLoaded': 'Please load an image first',\r\n  'message.cropApplied': 'Crop applied',\r\n  'message.filterApplied': 'Filter applied',\r\n  'message.copied': 'Copied',\r\n  'message.pasted': 'Pasted',\r\n\r\n  // Placeholder\r\n  'placeholder.title': 'Click or drag image here',\r\n  'placeholder.subtitle': 'Supports JPG, PNG, WebP formats',\r\n\r\n  // Keyboard shortcuts hints\r\n  'shortcut.undo': 'Ctrl+Z',\r\n  'shortcut.redo': 'Ctrl+Y',\r\n  'shortcut.copy': 'Ctrl+C',\r\n  'shortcut.paste': 'Ctrl+V',\r\n  'shortcut.delete': 'Delete',\r\n  'shortcut.escape': 'Esc',\r\n  'shortcut.zoomIn': '+',\r\n  'shortcut.zoomOut': '-',\r\n};\r\n","/**\r\n * Internationalization (i18n) system for the image editor\r\n */\r\nimport { zhCN, type LocaleMessages } from './locales/zh-CN';\r\nimport { enUS } from './locales/en-US';\r\n\r\nexport type SupportedLocale = 'zh-CN' | 'en-US';\r\n\r\nexport type LocaleKey = keyof LocaleMessages;\r\n\r\n/** Available locale packs */\r\nconst locales: Record<SupportedLocale, LocaleMessages> = {\r\n  'zh-CN': zhCN,\r\n  'en-US': enUS,\r\n};\r\n\r\n/**\r\n * I18n class - Manages internationalization\r\n */\r\nexport class I18n {\r\n  private locale: SupportedLocale;\r\n  private messages: LocaleMessages;\r\n  private fallbackMessages: LocaleMessages;\r\n\r\n  constructor(locale: SupportedLocale = 'zh-CN') {\r\n    this.locale = locale;\r\n    this.messages = locales[locale] || zhCN;\r\n    this.fallbackMessages = zhCN;\r\n  }\r\n\r\n  /**\r\n   * Get translated message by key\r\n   * @param key - Message key\r\n   * @param params - Optional parameters for interpolation\r\n   * @returns Translated message\r\n   */\r\n  t(key: LocaleKey, params?: Record<string, string | number>): string {\r\n    let message = this.messages[key] || this.fallbackMessages[key] || key;\r\n    \r\n    if (params) {\r\n      Object.entries(params).forEach(([k, v]) => {\r\n        message = message.replace(new RegExp(`\\\\{${k}\\\\}`, 'g'), String(v));\r\n      });\r\n    }\r\n    \r\n    return message;\r\n  }\r\n\r\n  /**\r\n   * Set current locale\r\n   * @param locale - Locale code\r\n   */\r\n  setLocale(locale: SupportedLocale): void {\r\n    if (locales[locale]) {\r\n      this.locale = locale;\r\n      this.messages = locales[locale];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current locale\r\n   * @returns Current locale code\r\n   */\r\n  getLocale(): SupportedLocale {\r\n    return this.locale;\r\n  }\r\n\r\n  /**\r\n   * Get all supported locales\r\n   * @returns Array of supported locale codes\r\n   */\r\n  getSupportedLocales(): SupportedLocale[] {\r\n    return Object.keys(locales) as SupportedLocale[];\r\n  }\r\n\r\n  /**\r\n   * Add or extend a locale\r\n   * @param locale - Locale code\r\n   * @param messages - Messages to add/merge\r\n   */\r\n  extendLocale(locale: SupportedLocale, messages: Partial<LocaleMessages>): void {\r\n    if (locales[locale]) {\r\n      locales[locale] = { ...locales[locale], ...messages };\r\n      if (this.locale === locale) {\r\n        this.messages = locales[locale];\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Register a new locale\r\n   * @param locale - Locale code\r\n   * @param messages - Full message set\r\n   */\r\n  registerLocale(locale: string, messages: LocaleMessages): void {\r\n    (locales as Record<string, LocaleMessages>)[locale] = messages;\r\n  }\r\n\r\n  /**\r\n   * Detect browser locale and return supported locale\r\n   * @returns Detected or default locale\r\n   */\r\n  static detectLocale(): SupportedLocale {\r\n    if (typeof navigator === 'undefined') {\r\n      return 'zh-CN';\r\n    }\r\n    \r\n    const browserLocale = navigator.language || (navigator as any).userLanguage || 'zh-CN';\r\n    \r\n    // Check for exact match\r\n    if (browserLocale in locales) {\r\n      return browserLocale as SupportedLocale;\r\n    }\r\n    \r\n    // Check for language prefix match\r\n    const lang = browserLocale.split('-')[0];\r\n    if (lang === 'zh') return 'zh-CN';\r\n    if (lang === 'en') return 'en-US';\r\n    \r\n    return 'zh-CN';\r\n  }\r\n}\r\n\r\n// Export types and locales\r\nexport { zhCN, enUS };\r\nexport type { LocaleMessages };\r\n\r\n// Default instance\r\nlet defaultI18n: I18n | null = null;\r\n\r\n/**\r\n * Get or create default i18n instance\r\n * @param locale - Optional locale to set\r\n * @returns I18n instance\r\n */\r\nexport function getI18n(locale?: SupportedLocale): I18n {\r\n  if (!defaultI18n) {\r\n    defaultI18n = new I18n(locale || I18n.detectLocale());\r\n  } else if (locale) {\r\n    defaultI18n.setLocale(locale);\r\n  }\r\n  return defaultI18n;\r\n}\r\n\r\n/**\r\n * Shorthand translation function using default instance\r\n * @param key - Message key\r\n * @param params - Optional parameters\r\n * @returns Translated message\r\n */\r\nexport function t(key: LocaleKey, params?: Record<string, string | number>): string {\r\n  return getI18n().t(key, params);\r\n}\r\n","/**\r\n * CropTool - Handles image cropping, rotation and flipping\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport type { I18n } from '../i18n';\r\nimport { getI18n } from '../i18n';\r\n\r\nexport type CropRatio = 'free' | '1:1' | '4:3' | '16:9' | '3:2' | '2:3' | '3:4' | '9:16';\r\n\r\nexport interface CropRect {\r\n  x: number;\r\n  y: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface CropToolOptions {\r\n  /** Initial aspect ratio */\r\n  ratio?: CropRatio;\r\n  /** Minimum crop size */\r\n  minSize?: number;\r\n  /** Enable rotation */\r\n  enableRotation?: boolean;\r\n  /** Enable flip */\r\n  enableFlip?: boolean;\r\n  /** i18n instance */\r\n  i18n?: I18n;\r\n}\r\n\r\nconst MIN_CROP_SIZE = 20;\r\n\r\ntype HandlePosition = 'nw' | 'n' | 'ne' | 'e' | 'se' | 's' | 'sw' | 'w';\r\n\r\n/**\r\n * CropTool - Provides crop overlay and manipulation\r\n */\r\nexport class CropTool {\r\n  private container: HTMLElement;\r\n  private canvas: HTMLCanvasElement;\r\n  private overlay: HTMLElement | null = null;\r\n  private cropBox: HTMLElement | null = null;\r\n  private controlPanel: HTMLElement | null = null;\r\n  \r\n  private i18n: I18n;\r\n  private options: Required<CropToolOptions>;\r\n  \r\n  // Crop state\r\n  private cropRect: CropRect = { x: 0, y: 0, width: 0, height: 0 };\r\n  private rotation: number = 0;\r\n  private flipH: boolean = false;\r\n  private flipV: boolean = false;\r\n  private currentRatio: CropRatio = 'free';\r\n  \r\n  // Interaction state\r\n  private isDragging: boolean = false;\r\n  private isResizing: boolean = false;\r\n  private activeHandle: HandlePosition | null = null;\r\n  private dragStart = { x: 0, y: 0 };\r\n  private cropStart: CropRect = { x: 0, y: 0, width: 0, height: 0 };\r\n  \r\n  // Callbacks\r\n  private onApplyCallback: ((rect: CropRect, rotation: number, flipH: boolean, flipV: boolean) => void) | null = null;\r\n  private onCancelCallback: (() => void) | null = null;\r\n\r\n  constructor(container: HTMLElement, canvas: HTMLCanvasElement, options: CropToolOptions = {}) {\r\n    this.container = container;\r\n    this.canvas = canvas;\r\n    this.i18n = options.i18n || getI18n();\r\n    \r\n    this.options = {\r\n      ratio: options.ratio || 'free',\r\n      minSize: options.minSize || MIN_CROP_SIZE,\r\n      enableRotation: options.enableRotation !== false,\r\n      enableFlip: options.enableFlip !== false,\r\n      i18n: this.i18n,\r\n    };\r\n    \r\n    this.currentRatio = this.options.ratio;\r\n  }\r\n\r\n  /**\r\n   * Show crop tool\r\n   */\r\n  show(): void {\r\n    this.createOverlay();\r\n    this.initCropRect();\r\n    this.updateCropBox();\r\n    this.setupEvents();\r\n  }\r\n\r\n  /**\r\n   * Hide and cleanup crop tool\r\n   */\r\n  hide(): void {\r\n    this.removeOverlay();\r\n    this.cleanup();\r\n  }\r\n\r\n  /**\r\n   * Set apply callback\r\n   */\r\n  onApply(callback: (rect: CropRect, rotation: number, flipH: boolean, flipV: boolean) => void): void {\r\n    this.onApplyCallback = callback;\r\n  }\r\n\r\n  /**\r\n   * Set cancel callback\r\n   */\r\n  onCancel(callback: () => void): void {\r\n    this.onCancelCallback = callback;\r\n  }\r\n\r\n  /**\r\n   * Get current crop rect\r\n   */\r\n  getCropRect(): CropRect {\r\n    return { ...this.cropRect };\r\n  }\r\n\r\n  /**\r\n   * Set aspect ratio\r\n   */\r\n  setRatio(ratio: CropRatio): void {\r\n    this.currentRatio = ratio;\r\n    this.applyRatioConstraint();\r\n    this.updateCropBox();\r\n    this.updateRatioButtons();\r\n  }\r\n\r\n  /**\r\n   * Rotate image\r\n   */\r\n  rotate(angle: number): void {\r\n    this.rotation = (this.rotation + angle) % 360;\r\n    if (this.rotation < 0) this.rotation += 360;\r\n    this.updateRotationPreview();\r\n  }\r\n\r\n  /**\r\n   * Flip horizontally\r\n   */\r\n  flipHorizontal(): void {\r\n    this.flipH = !this.flipH;\r\n    this.updateFlipPreview();\r\n  }\r\n\r\n  /**\r\n   * Flip vertically\r\n   */\r\n  flipVertical(): void {\r\n    this.flipV = !this.flipV;\r\n    this.updateFlipPreview();\r\n  }\r\n\r\n  /**\r\n   * Create overlay elements\r\n   */\r\n  private createOverlay(): void {\r\n    // Main overlay\r\n    this.overlay = document.createElement('div');\r\n    this.overlay.className = 'ie-crop-overlay';\r\n    \r\n    // Crop box\r\n    this.cropBox = document.createElement('div');\r\n    this.cropBox.className = 'ie-crop-box';\r\n    \r\n    // Grid lines\r\n    const grid = document.createElement('div');\r\n    grid.className = 'ie-crop-grid';\r\n    grid.innerHTML = `\r\n      <div class=\"ie-crop-grid-h\"></div>\r\n      <div class=\"ie-crop-grid-h\"></div>\r\n      <div class=\"ie-crop-grid-v\"></div>\r\n      <div class=\"ie-crop-grid-v\"></div>\r\n    `;\r\n    this.cropBox.appendChild(grid);\r\n    \r\n    // Resize handles\r\n    const handles: HandlePosition[] = ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'];\r\n    handles.forEach(pos => {\r\n      const handle = document.createElement('div');\r\n      handle.className = `ie-crop-handle ie-crop-handle-${pos}`;\r\n      handle.dataset.handle = pos;\r\n      this.cropBox!.appendChild(handle);\r\n    });\r\n    \r\n    this.overlay.appendChild(this.cropBox);\r\n    \r\n    // Control panel\r\n    this.controlPanel = this.createControlPanel();\r\n    this.overlay.appendChild(this.controlPanel);\r\n    \r\n    this.container.appendChild(this.overlay);\r\n  }\r\n\r\n  /**\r\n   * Create control panel with ratio, rotate, flip buttons\r\n   */\r\n  private createControlPanel(): HTMLElement {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'ie-crop-panel';\r\n    \r\n    const t = (key: string) => this.i18n.t(key as any);\r\n    \r\n    // Ratio buttons\r\n    const ratioGroup = document.createElement('div');\r\n    ratioGroup.className = 'ie-crop-group';\r\n    ratioGroup.innerHTML = `\r\n      <span class=\"ie-crop-label\">${t('crop.ratio')}</span>\r\n      <div class=\"ie-crop-buttons ie-crop-ratio-buttons\">\r\n        <button class=\"ie-crop-btn ${this.currentRatio === 'free' ? 'active' : ''}\" data-ratio=\"free\">${t('crop.free')}</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '1:1' ? 'active' : ''}\" data-ratio=\"1:1\">1:1</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '4:3' ? 'active' : ''}\" data-ratio=\"4:3\">4:3</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '16:9' ? 'active' : ''}\" data-ratio=\"16:9\">16:9</button>\r\n        <button class=\"ie-crop-btn ${this.currentRatio === '3:2' ? 'active' : ''}\" data-ratio=\"3:2\">3:2</button>\r\n      </div>\r\n    `;\r\n    panel.appendChild(ratioGroup);\r\n    \r\n    // Rotate & flip buttons\r\n    if (this.options.enableRotation || this.options.enableFlip) {\r\n      const transformGroup = document.createElement('div');\r\n      transformGroup.className = 'ie-crop-group';\r\n      transformGroup.innerHTML = `\r\n        <span class=\"ie-crop-label\">${t('crop.rotate')}</span>\r\n        <div class=\"ie-crop-buttons\">\r\n          ${this.options.enableRotation ? `\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"rotate-left\" title=\"${t('crop.rotateLeft')}\">${icons.rotateLeft}</button>\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"rotate-right\" title=\"${t('crop.rotateRight')}\">${icons.rotateRight}</button>\r\n          ` : ''}\r\n          ${this.options.enableFlip ? `\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"flip-h\" title=\"${t('crop.flipH')}\">${icons.flipH}</button>\r\n            <button class=\"ie-crop-btn ie-crop-btn-icon\" data-action=\"flip-v\" title=\"${t('crop.flipV')}\">${icons.flipV}</button>\r\n          ` : ''}\r\n        </div>\r\n      `;\r\n      panel.appendChild(transformGroup);\r\n    }\r\n    \r\n    // Action buttons\r\n    const actionGroup = document.createElement('div');\r\n    actionGroup.className = 'ie-crop-group ie-crop-actions';\r\n    actionGroup.innerHTML = `\r\n      <button class=\"ie-crop-btn ie-crop-btn-cancel\" data-action=\"cancel\">${t('crop.cancel')}</button>\r\n      <button class=\"ie-crop-btn ie-crop-btn-apply\" data-action=\"apply\">${icons.check} ${t('crop.apply')}</button>\r\n    `;\r\n    panel.appendChild(actionGroup);\r\n    \r\n    // Event bindings\r\n    panel.addEventListener('click', (e) => {\r\n      const target = e.target as HTMLElement;\r\n      const btn = target.closest('[data-ratio], [data-action]') as HTMLElement;\r\n      if (!btn) return;\r\n      \r\n      const ratio = btn.dataset.ratio as CropRatio;\r\n      const action = btn.dataset.action;\r\n      \r\n      if (ratio) {\r\n        this.setRatio(ratio);\r\n      } else if (action) {\r\n        switch (action) {\r\n          case 'rotate-left': this.rotate(-90); break;\r\n          case 'rotate-right': this.rotate(90); break;\r\n          case 'flip-h': this.flipHorizontal(); break;\r\n          case 'flip-v': this.flipVertical(); break;\r\n          case 'apply': this.apply(); break;\r\n          case 'cancel': this.cancel(); break;\r\n        }\r\n      }\r\n    });\r\n    \r\n    return panel;\r\n  }\r\n\r\n  /**\r\n   * Initialize crop rect to cover most of image\r\n   */\r\n  private initCropRect(): void {\r\n    const canvasRect = this.canvas.getBoundingClientRect();\r\n    const containerRect = this.container.getBoundingClientRect();\r\n    \r\n    // Calculate canvas position relative to container\r\n    const offsetX = canvasRect.left - containerRect.left;\r\n    const offsetY = canvasRect.top - containerRect.top;\r\n    \r\n    // Default to 80% of canvas\r\n    const padding = 0.1;\r\n    this.cropRect = {\r\n      x: offsetX + canvasRect.width * padding,\r\n      y: offsetY + canvasRect.height * padding,\r\n      width: canvasRect.width * (1 - 2 * padding),\r\n      height: canvasRect.height * (1 - 2 * padding),\r\n    };\r\n    \r\n    this.applyRatioConstraint();\r\n  }\r\n\r\n  /**\r\n   * Apply aspect ratio constraint\r\n   */\r\n  private applyRatioConstraint(): void {\r\n    if (this.currentRatio === 'free') return;\r\n    \r\n    const [w, h] = this.currentRatio.split(':').map(Number);\r\n    const ratio = w / h;\r\n    \r\n    const centerX = this.cropRect.x + this.cropRect.width / 2;\r\n    const centerY = this.cropRect.y + this.cropRect.height / 2;\r\n    \r\n    let newWidth = this.cropRect.width;\r\n    let newHeight = this.cropRect.height;\r\n    \r\n    if (newWidth / newHeight > ratio) {\r\n      newWidth = newHeight * ratio;\r\n    } else {\r\n      newHeight = newWidth / ratio;\r\n    }\r\n    \r\n    this.cropRect.width = newWidth;\r\n    this.cropRect.height = newHeight;\r\n    this.cropRect.x = centerX - newWidth / 2;\r\n    this.cropRect.y = centerY - newHeight / 2;\r\n  }\r\n\r\n  /**\r\n   * Update crop box position/size\r\n   */\r\n  private updateCropBox(): void {\r\n    if (!this.cropBox || !this.overlay) return;\r\n    \r\n    this.cropBox.style.left = `${this.cropRect.x}px`;\r\n    this.cropBox.style.top = `${this.cropRect.y}px`;\r\n    this.cropBox.style.width = `${this.cropRect.width}px`;\r\n    this.cropBox.style.height = `${this.cropRect.height}px`;\r\n    \r\n    // Update dark overlay regions\r\n    this.updateOverlayMask();\r\n  }\r\n\r\n  /**\r\n   * Update overlay mask to darken outside crop area\r\n   */\r\n  private updateOverlayMask(): void {\r\n    if (!this.overlay) return;\r\n    \r\n    const { x, y, width, height } = this.cropRect;\r\n    \r\n    // Use clip-path to create the dark overlay effect\r\n    this.overlay.style.setProperty('--crop-x', `${x}px`);\r\n    this.overlay.style.setProperty('--crop-y', `${y}px`);\r\n    this.overlay.style.setProperty('--crop-w', `${width}px`);\r\n    this.overlay.style.setProperty('--crop-h', `${height}px`);\r\n  }\r\n\r\n  /**\r\n   * Update ratio buttons active state\r\n   */\r\n  private updateRatioButtons(): void {\r\n    if (!this.controlPanel) return;\r\n    \r\n    this.controlPanel.querySelectorAll('[data-ratio]').forEach(btn => {\r\n      btn.classList.toggle('active', btn.getAttribute('data-ratio') === this.currentRatio);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update rotation preview\r\n   */\r\n  private updateRotationPreview(): void {\r\n    // Rotation is applied when crop is confirmed\r\n    // Could add visual preview here\r\n  }\r\n\r\n  /**\r\n   * Update flip preview\r\n   */\r\n  private updateFlipPreview(): void {\r\n    // Flip is applied when crop is confirmed\r\n    // Could add visual preview here\r\n  }\r\n\r\n  /**\r\n   * Setup event listeners\r\n   */\r\n  private setupEvents(): void {\r\n    if (!this.cropBox) return;\r\n    \r\n    // Crop box drag\r\n    this.cropBox.addEventListener('pointerdown', this.handlePointerDown);\r\n    document.addEventListener('pointermove', this.handlePointerMove);\r\n    document.addEventListener('pointerup', this.handlePointerUp);\r\n  }\r\n\r\n  private handlePointerDown = (e: PointerEvent): void => {\r\n    const target = e.target as HTMLElement;\r\n    \r\n    // Check if clicking on handle\r\n    if (target.classList.contains('ie-crop-handle')) {\r\n      this.isResizing = true;\r\n      this.activeHandle = target.dataset.handle as HandlePosition;\r\n    } else if (target.closest('.ie-crop-box')) {\r\n      this.isDragging = true;\r\n    }\r\n    \r\n    if (this.isDragging || this.isResizing) {\r\n      this.dragStart = { x: e.clientX, y: e.clientY };\r\n      this.cropStart = { ...this.cropRect };\r\n      e.preventDefault();\r\n    }\r\n  };\r\n\r\n  private handlePointerMove = (e: PointerEvent): void => {\r\n    if (!this.isDragging && !this.isResizing) return;\r\n    \r\n    const dx = e.clientX - this.dragStart.x;\r\n    const dy = e.clientY - this.dragStart.y;\r\n    \r\n    if (this.isDragging) {\r\n      this.cropRect.x = this.cropStart.x + dx;\r\n      this.cropRect.y = this.cropStart.y + dy;\r\n      this.constrainToContainer();\r\n    } else if (this.isResizing && this.activeHandle) {\r\n      this.resizeCropBox(dx, dy);\r\n    }\r\n    \r\n    this.updateCropBox();\r\n  };\r\n\r\n  private handlePointerUp = (): void => {\r\n    this.isDragging = false;\r\n    this.isResizing = false;\r\n    this.activeHandle = null;\r\n  };\r\n\r\n  /**\r\n   * Resize crop box based on handle\r\n   */\r\n  private resizeCropBox(dx: number, dy: number): void {\r\n    if (!this.activeHandle) return;\r\n    \r\n    const { x, y, width, height } = this.cropStart;\r\n    const minSize = this.options.minSize;\r\n    \r\n    let newX = x, newY = y, newW = width, newH = height;\r\n    \r\n    // Calculate new dimensions based on handle\r\n    switch (this.activeHandle) {\r\n      case 'nw':\r\n        newX = x + dx;\r\n        newY = y + dy;\r\n        newW = width - dx;\r\n        newH = height - dy;\r\n        break;\r\n      case 'n':\r\n        newY = y + dy;\r\n        newH = height - dy;\r\n        break;\r\n      case 'ne':\r\n        newY = y + dy;\r\n        newW = width + dx;\r\n        newH = height - dy;\r\n        break;\r\n      case 'e':\r\n        newW = width + dx;\r\n        break;\r\n      case 'se':\r\n        newW = width + dx;\r\n        newH = height + dy;\r\n        break;\r\n      case 's':\r\n        newH = height + dy;\r\n        break;\r\n      case 'sw':\r\n        newX = x + dx;\r\n        newW = width - dx;\r\n        newH = height + dy;\r\n        break;\r\n      case 'w':\r\n        newX = x + dx;\r\n        newW = width - dx;\r\n        break;\r\n    }\r\n    \r\n    // Apply minimum size\r\n    if (newW < minSize) {\r\n      if (this.activeHandle.includes('w')) {\r\n        newX = x + width - minSize;\r\n      }\r\n      newW = minSize;\r\n    }\r\n    if (newH < minSize) {\r\n      if (this.activeHandle.includes('n')) {\r\n        newY = y + height - minSize;\r\n      }\r\n      newH = minSize;\r\n    }\r\n    \r\n    // Apply ratio constraint if not free\r\n    if (this.currentRatio !== 'free') {\r\n      const [rw, rh] = this.currentRatio.split(':').map(Number);\r\n      const ratio = rw / rh;\r\n      \r\n      // Determine which dimension to adjust\r\n      if (['n', 's'].includes(this.activeHandle)) {\r\n        newW = newH * ratio;\r\n      } else if (['e', 'w'].includes(this.activeHandle)) {\r\n        newH = newW / ratio;\r\n      } else {\r\n        // Corner handles - use the larger change\r\n        const targetRatio = newW / newH;\r\n        if (targetRatio > ratio) {\r\n          newW = newH * ratio;\r\n        } else {\r\n          newH = newW / ratio;\r\n        }\r\n      }\r\n    }\r\n    \r\n    this.cropRect = { x: newX, y: newY, width: newW, height: newH };\r\n    this.constrainToContainer();\r\n  }\r\n\r\n  /**\r\n   * Constrain crop rect to container bounds\r\n   */\r\n  private constrainToContainer(): void {\r\n    const canvasRect = this.canvas.getBoundingClientRect();\r\n    const containerRect = this.container.getBoundingClientRect();\r\n    \r\n    const minX = canvasRect.left - containerRect.left;\r\n    const minY = canvasRect.top - containerRect.top;\r\n    const maxX = minX + canvasRect.width;\r\n    const maxY = minY + canvasRect.height;\r\n    \r\n    // Constrain position\r\n    this.cropRect.x = Math.max(minX, Math.min(maxX - this.cropRect.width, this.cropRect.x));\r\n    this.cropRect.y = Math.max(minY, Math.min(maxY - this.cropRect.height, this.cropRect.y));\r\n    \r\n    // Constrain size\r\n    this.cropRect.width = Math.min(this.cropRect.width, maxX - this.cropRect.x);\r\n    this.cropRect.height = Math.min(this.cropRect.height, maxY - this.cropRect.y);\r\n  }\r\n\r\n  /**\r\n   * Convert screen rect to canvas coordinates\r\n   */\r\n  private toCanvasCoords(): CropRect {\r\n    const canvasRect = this.canvas.getBoundingClientRect();\r\n    const containerRect = this.container.getBoundingClientRect();\r\n    \r\n    const offsetX = canvasRect.left - containerRect.left;\r\n    const offsetY = canvasRect.top - containerRect.top;\r\n    \r\n    const scaleX = this.canvas.width / canvasRect.width;\r\n    const scaleY = this.canvas.height / canvasRect.height;\r\n    \r\n    return {\r\n      x: (this.cropRect.x - offsetX) * scaleX,\r\n      y: (this.cropRect.y - offsetY) * scaleY,\r\n      width: this.cropRect.width * scaleX,\r\n      height: this.cropRect.height * scaleY,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Apply crop\r\n   */\r\n  private apply(): void {\r\n    const canvasRect = this.toCanvasCoords();\r\n    \r\n    if (this.onApplyCallback) {\r\n      this.onApplyCallback(canvasRect, this.rotation, this.flipH, this.flipV);\r\n    }\r\n    \r\n    this.hide();\r\n  }\r\n\r\n  /**\r\n   * Cancel crop\r\n   */\r\n  private cancel(): void {\r\n    if (this.onCancelCallback) {\r\n      this.onCancelCallback();\r\n    }\r\n    \r\n    this.hide();\r\n  }\r\n\r\n  /**\r\n   * Remove overlay\r\n   */\r\n  private removeOverlay(): void {\r\n    if (this.overlay) {\r\n      this.overlay.remove();\r\n      this.overlay = null;\r\n      this.cropBox = null;\r\n      this.controlPanel = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup event listeners\r\n   */\r\n  private cleanup(): void {\r\n    document.removeEventListener('pointermove', this.handlePointerMove);\r\n    document.removeEventListener('pointerup', this.handlePointerUp);\r\n  }\r\n\r\n  /**\r\n   * Destroy crop tool\r\n   */\r\n  destroy(): void {\r\n    this.hide();\r\n    this.onApplyCallback = null;\r\n    this.onCancelCallback = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Apply crop, rotation and flip to canvas\r\n */\r\nexport function applyCropToCanvas(\r\n  canvas: HTMLCanvasElement,\r\n  rect: CropRect,\r\n  rotation: number,\r\n  flipH: boolean,\r\n  flipV: boolean\r\n): HTMLCanvasElement {\r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx) return canvas;\r\n  \r\n  // Create cropped canvas\r\n  let croppedWidth = rect.width;\r\n  let croppedHeight = rect.height;\r\n  \r\n  // Swap dimensions if rotated 90 or 270\r\n  if (rotation === 90 || rotation === 270) {\r\n    [croppedWidth, croppedHeight] = [croppedHeight, croppedWidth];\r\n  }\r\n  \r\n  const tempCanvas = document.createElement('canvas');\r\n  tempCanvas.width = croppedWidth;\r\n  tempCanvas.height = croppedHeight;\r\n  const tempCtx = tempCanvas.getContext('2d')!;\r\n  \r\n  // Apply transformations\r\n  tempCtx.save();\r\n  tempCtx.translate(croppedWidth / 2, croppedHeight / 2);\r\n  \r\n  if (rotation) {\r\n    tempCtx.rotate((rotation * Math.PI) / 180);\r\n  }\r\n  \r\n  if (flipH) {\r\n    tempCtx.scale(-1, 1);\r\n  }\r\n  \r\n  if (flipV) {\r\n    tempCtx.scale(1, -1);\r\n  }\r\n  \r\n  // Draw cropped region\r\n  let drawWidth = rect.width;\r\n  let drawHeight = rect.height;\r\n  if (rotation === 90 || rotation === 270) {\r\n    [drawWidth, drawHeight] = [drawHeight, drawWidth];\r\n  }\r\n  \r\n  tempCtx.drawImage(\r\n    canvas,\r\n    rect.x, rect.y, rect.width, rect.height,\r\n    -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight\r\n  );\r\n  \r\n  tempCtx.restore();\r\n  \r\n  // Update original canvas\r\n  canvas.width = croppedWidth;\r\n  canvas.height = croppedHeight;\r\n  ctx.drawImage(tempCanvas, 0, 0);\r\n  \r\n  return canvas;\r\n}\r\n","/**\r\n * ContextMenu - Right-click context menu for shape operations\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport type { I18n } from '../i18n';\r\n\r\nexport interface MenuItemConfig {\r\n  id: string;\r\n  label: string;\r\n  icon?: string;\r\n  shortcut?: string;\r\n  disabled?: boolean;\r\n  divider?: boolean;\r\n  action?: () => void;\r\n}\r\n\r\nexport interface ContextMenuOptions {\r\n  items: MenuItemConfig[];\r\n  i18n?: I18n;\r\n}\r\n\r\n/**\r\n * ContextMenu - Floating context menu\r\n */\r\nexport class ContextMenu {\r\n  private menu: HTMLElement | null = null;\r\n  private items: MenuItemConfig[] = [];\r\n  private boundHide: (e: MouseEvent) => void;\r\n\r\n  constructor(options?: Partial<ContextMenuOptions>) {\r\n    this.items = options?.items || [];\r\n    this.boundHide = this.handleOutsideClick.bind(this);\r\n  }\r\n\r\n  /**\r\n   * Show context menu at position\r\n   */\r\n  show(x: number, y: number, items?: MenuItemConfig[]): void {\r\n    this.hide();\r\n    \r\n    if (items) {\r\n      this.items = items;\r\n    }\r\n    \r\n    this.menu = this.createMenu();\r\n    document.body.appendChild(this.menu);\r\n    \r\n    // Position menu\r\n    this.positionMenu(x, y);\r\n    \r\n    // Add click outside listener\r\n    setTimeout(() => {\r\n      document.addEventListener('click', this.boundHide);\r\n      document.addEventListener('contextmenu', this.boundHide);\r\n    }, 0);\r\n  }\r\n\r\n  /**\r\n   * Hide context menu\r\n   */\r\n  hide(): void {\r\n    if (this.menu) {\r\n      this.menu.remove();\r\n      this.menu = null;\r\n    }\r\n    document.removeEventListener('click', this.boundHide);\r\n    document.removeEventListener('contextmenu', this.boundHide);\r\n  }\r\n\r\n  /**\r\n   * Check if menu is visible\r\n   */\r\n  isVisible(): boolean {\r\n    return this.menu !== null;\r\n  }\r\n\r\n  /**\r\n   * Set menu items\r\n   */\r\n  setItems(items: MenuItemConfig[]): void {\r\n    this.items = items;\r\n  }\r\n\r\n  /**\r\n   * Create menu element\r\n   */\r\n  private createMenu(): HTMLElement {\r\n    const menu = document.createElement('div');\r\n    menu.className = 'ie-context-menu';\r\n    \r\n    this.items.forEach(item => {\r\n      if (item.divider) {\r\n        const divider = document.createElement('div');\r\n        divider.className = 'ie-context-menu-divider';\r\n        menu.appendChild(divider);\r\n      } else {\r\n        const menuItem = document.createElement('div');\r\n        menuItem.className = `ie-context-menu-item${item.disabled ? ' disabled' : ''}`;\r\n        menuItem.dataset.id = item.id;\r\n        \r\n        menuItem.innerHTML = `\r\n          ${item.icon ? `<span class=\"ie-context-menu-icon\">${item.icon}</span>` : ''}\r\n          <span class=\"ie-context-menu-label\">${item.label}</span>\r\n          ${item.shortcut ? `<span class=\"ie-context-menu-shortcut\">${item.shortcut}</span>` : ''}\r\n        `;\r\n        \r\n        if (!item.disabled && item.action) {\r\n          menuItem.addEventListener('click', (e) => {\r\n            e.stopPropagation();\r\n            item.action!();\r\n            this.hide();\r\n          });\r\n        }\r\n        \r\n        menu.appendChild(menuItem);\r\n      }\r\n    });\r\n    \r\n    return menu;\r\n  }\r\n\r\n  /**\r\n   * Position menu to stay within viewport\r\n   */\r\n  private positionMenu(x: number, y: number): void {\r\n    if (!this.menu) return;\r\n    \r\n    const menuRect = this.menu.getBoundingClientRect();\r\n    const viewportWidth = window.innerWidth;\r\n    const viewportHeight = window.innerHeight;\r\n    \r\n    // Adjust horizontal position\r\n    if (x + menuRect.width > viewportWidth) {\r\n      x = viewportWidth - menuRect.width - 5;\r\n    }\r\n    \r\n    // Adjust vertical position\r\n    if (y + menuRect.height > viewportHeight) {\r\n      y = viewportHeight - menuRect.height - 5;\r\n    }\r\n    \r\n    this.menu.style.left = `${Math.max(5, x)}px`;\r\n    this.menu.style.top = `${Math.max(5, y)}px`;\r\n  }\r\n\r\n  /**\r\n   * Handle click outside menu\r\n   */\r\n  private handleOutsideClick(e: MouseEvent): void {\r\n    if (this.menu && !this.menu.contains(e.target as Node)) {\r\n      this.hide();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destroy context menu\r\n   */\r\n  destroy(): void {\r\n    this.hide();\r\n    this.items = [];\r\n  }\r\n}\r\n\r\n/**\r\n * Create default shape context menu items\r\n */\r\nexport function createShapeMenuItems(handlers: {\r\n  copy?: () => void;\r\n  paste?: () => void;\r\n  duplicate?: () => void;\r\n  delete?: () => void;\r\n  bringToFront?: () => void;\r\n  bringForward?: () => void;\r\n  sendBackward?: () => void;\r\n  sendToBack?: () => void;\r\n}, i18n?: I18n): MenuItemConfig[] {\r\n  const t = i18n?.t.bind(i18n) || ((key: string) => key);\r\n  \r\n  const items: MenuItemConfig[] = [];\r\n  \r\n  if (handlers.copy) {\r\n    items.push({\r\n      id: 'copy',\r\n      label: t('context.copy' as any),\r\n      icon: icons.copy,\r\n      shortcut: 'Ctrl+C',\r\n      action: handlers.copy,\r\n    });\r\n  }\r\n  \r\n  if (handlers.paste) {\r\n    items.push({\r\n      id: 'paste',\r\n      label: t('context.paste' as any),\r\n      icon: icons.paste,\r\n      shortcut: 'Ctrl+V',\r\n      action: handlers.paste,\r\n    });\r\n  }\r\n  \r\n  if (handlers.duplicate) {\r\n    items.push({\r\n      id: 'duplicate',\r\n      label: t('context.duplicate' as any),\r\n      icon: icons.copy,\r\n      shortcut: 'Ctrl+D',\r\n      action: handlers.duplicate,\r\n    });\r\n  }\r\n  \r\n  if (handlers.delete) {\r\n    items.push({\r\n      id: 'delete',\r\n      label: t('context.delete' as any),\r\n      icon: icons.trash,\r\n      shortcut: 'Del',\r\n      action: handlers.delete,\r\n    });\r\n  }\r\n  \r\n  // Add divider before layer operations\r\n  if (items.length > 0 && (handlers.bringToFront || handlers.sendToBack)) {\r\n    items.push({ id: 'divider1', label: '', divider: true });\r\n  }\r\n  \r\n  if (handlers.bringToFront) {\r\n    items.push({\r\n      id: 'bringToFront',\r\n      label: t('context.bringToFront' as any),\r\n      icon: icons.layers,\r\n      action: handlers.bringToFront,\r\n    });\r\n  }\r\n  \r\n  if (handlers.bringForward) {\r\n    items.push({\r\n      id: 'bringForward',\r\n      label: t('context.bringForward' as any),\r\n      action: handlers.bringForward,\r\n    });\r\n  }\r\n  \r\n  if (handlers.sendBackward) {\r\n    items.push({\r\n      id: 'sendBackward',\r\n      label: t('context.sendBackward' as any),\r\n      action: handlers.sendBackward,\r\n    });\r\n  }\r\n  \r\n  if (handlers.sendToBack) {\r\n    items.push({\r\n      id: 'sendToBack',\r\n      label: t('context.sendToBack' as any),\r\n      icon: icons.layers,\r\n      action: handlers.sendToBack,\r\n    });\r\n  }\r\n  \r\n  return items;\r\n}\r\n","/**\r\n * ExportDialog - Advanced export options dialog\r\n */\r\n\r\nimport { icons } from './icons';\r\nimport type { I18n } from '../i18n';\r\nimport { getI18n } from '../i18n';\r\nimport type { ExportFormat } from '../types/config.types';\r\n\r\nexport interface ExportDialogOptions {\r\n  /** Initial format */\r\n  format?: ExportFormat;\r\n  /** Initial quality */\r\n  quality?: number;\r\n  /** Original canvas width */\r\n  width: number;\r\n  /** Original canvas height */\r\n  height: number;\r\n  /** Enable watermark */\r\n  enableWatermark?: boolean;\r\n  /** i18n instance */\r\n  i18n?: I18n;\r\n}\r\n\r\nexport interface ExportDialogResult {\r\n  format: ExportFormat;\r\n  quality: number;\r\n  width: number;\r\n  height: number;\r\n  watermark?: {\r\n    text?: string;\r\n    position?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center';\r\n    opacity?: number;\r\n  };\r\n}\r\n\r\n/**\r\n * ExportDialog - Modal dialog for export options\r\n */\r\nexport class ExportDialog {\r\n  private overlay: HTMLElement | null = null;\r\n  private dialog: HTMLElement | null = null;\r\n  private i18n: I18n;\r\n  private options: ExportDialogOptions;\r\n  \r\n  // State\r\n  private format: ExportFormat = 'png';\r\n  private quality: number = 0.92;\r\n  private width: number;\r\n  private height: number;\r\n  private keepRatio: boolean = true;\r\n  private aspectRatio: number;\r\n  private watermarkText: string = '';\r\n  private watermarkEnabled: boolean = false;\r\n  \r\n  // Callbacks\r\n  private resolvePromise: ((result: ExportDialogResult | null) => void) | null = null;\r\n\r\n  constructor(options: ExportDialogOptions) {\r\n    this.options = options;\r\n    this.i18n = options.i18n || getI18n();\r\n    \r\n    this.format = options.format || 'png';\r\n    this.quality = options.quality || 0.92;\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.aspectRatio = options.width / options.height;\r\n  }\r\n\r\n  /**\r\n   * Show dialog and return promise with result\r\n   */\r\n  show(): Promise<ExportDialogResult | null> {\r\n    return new Promise((resolve) => {\r\n      this.resolvePromise = resolve;\r\n      this.createDialog();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Hide dialog\r\n   */\r\n  hide(): void {\r\n    if (this.overlay) {\r\n      this.overlay.remove();\r\n      this.overlay = null;\r\n      this.dialog = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create dialog elements\r\n   */\r\n  private createDialog(): void {\r\n    const t = (key: string) => this.i18n.t(key as any);\r\n    \r\n    this.overlay = document.createElement('div');\r\n    this.overlay.className = 'ie-export-overlay';\r\n    \r\n    this.dialog = document.createElement('div');\r\n    this.dialog.className = 'ie-export-dialog';\r\n    \r\n    this.dialog.innerHTML = `\r\n      <div class=\"ie-export-header\">\r\n        <span class=\"ie-export-title\">${t('export.title')}</span>\r\n        <button class=\"ie-export-close\" data-action=\"close\">${icons.close}</button>\r\n      </div>\r\n      \r\n      <div class=\"ie-export-body\">\r\n        <!-- Format -->\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">${t('export.format')}</label>\r\n          <div class=\"ie-export-format-buttons\">\r\n            <button class=\"ie-export-format-btn ${this.format === 'png' ? 'active' : ''}\" data-format=\"png\">PNG</button>\r\n            <button class=\"ie-export-format-btn ${this.format === 'jpeg' ? 'active' : ''}\" data-format=\"jpeg\">JPG</button>\r\n            <button class=\"ie-export-format-btn ${this.format === 'webp' ? 'active' : ''}\" data-format=\"webp\">WebP</button>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Size -->\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">${t('export.size')}</label>\r\n          <div class=\"ie-export-size-inputs\">\r\n            <input type=\"number\" class=\"ie-export-input\" data-input=\"width\" value=\"${this.width}\" min=\"1\" max=\"10000\">\r\n            <span style=\"color:var(--ie-text-muted)\">×</span>\r\n            <input type=\"number\" class=\"ie-export-input\" data-input=\"height\" value=\"${this.height}\" min=\"1\" max=\"10000\">\r\n            <button class=\"ie-export-link-btn ${this.keepRatio ? 'active' : ''}\" data-action=\"toggle-ratio\" title=\"${t('export.keepRatio')}\">\r\n              ${icons.layers}\r\n            </button>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Quality (only for jpeg/webp) -->\r\n        <div class=\"ie-export-section ie-quality-section\" style=\"display:${this.format === 'png' ? 'none' : 'block'}\">\r\n          <label class=\"ie-export-label\">${t('export.quality')}</label>\r\n          <div class=\"ie-export-quality\">\r\n            <input type=\"range\" class=\"ie-range-slider ie-export-quality-slider\" data-slider=\"quality\" \r\n                   min=\"0.1\" max=\"1\" step=\"0.01\" value=\"${this.quality}\">\r\n            <span class=\"ie-export-quality-value\" data-value=\"quality\">${Math.round(this.quality * 100)}%</span>\r\n          </div>\r\n        </div>\r\n        \r\n        <!-- Watermark -->\r\n        ${this.options.enableWatermark ? `\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">\r\n            <input type=\"checkbox\" data-check=\"watermark\" ${this.watermarkEnabled ? 'checked' : ''}>\r\n            ${t('export.watermark')}\r\n          </label>\r\n          <div class=\"ie-watermark-options\" style=\"display:${this.watermarkEnabled ? 'block' : 'none'}\">\r\n            <input type=\"text\" class=\"ie-export-input\" data-input=\"watermark-text\" \r\n                   placeholder=\"${t('export.watermarkText')}\" value=\"${this.watermarkText}\">\r\n          </div>\r\n        </div>\r\n        ` : ''}\r\n        \r\n        <!-- Preview -->\r\n        <div class=\"ie-export-section\">\r\n          <label class=\"ie-export-label\">${t('export.preview')}</label>\r\n          <div class=\"ie-export-preview\">\r\n            <div style=\"color:var(--ie-text-muted);font-size:12px;\">${this.width} × ${this.height} px</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      <div class=\"ie-export-footer\">\r\n        <button class=\"ie-export-cancel\" data-action=\"cancel\">${t('export.cancel')}</button>\r\n        <button class=\"ie-export-download\" data-action=\"export\">${icons.download} ${t('export.download')}</button>\r\n      </div>\r\n    `;\r\n    \r\n    this.overlay.appendChild(this.dialog);\r\n    document.body.appendChild(this.overlay);\r\n    \r\n    this.setupEvents();\r\n  }\r\n\r\n  /**\r\n   * Setup event listeners\r\n   */\r\n  private setupEvents(): void {\r\n    if (!this.dialog) return;\r\n    \r\n    // Close button\r\n    this.dialog.querySelector('[data-action=\"close\"]')?.addEventListener('click', () => {\r\n      this.cancel();\r\n    });\r\n    \r\n    // Cancel button\r\n    this.dialog.querySelector('[data-action=\"cancel\"]')?.addEventListener('click', () => {\r\n      this.cancel();\r\n    });\r\n    \r\n    // Export button\r\n    this.dialog.querySelector('[data-action=\"export\"]')?.addEventListener('click', () => {\r\n      this.confirm();\r\n    });\r\n    \r\n    // Format buttons\r\n    this.dialog.querySelectorAll('[data-format]').forEach(btn => {\r\n      btn.addEventListener('click', () => {\r\n        this.setFormat(btn.getAttribute('data-format') as ExportFormat);\r\n      });\r\n    });\r\n    \r\n    // Size inputs\r\n    const widthInput = this.dialog.querySelector('[data-input=\"width\"]') as HTMLInputElement;\r\n    const heightInput = this.dialog.querySelector('[data-input=\"height\"]') as HTMLInputElement;\r\n    \r\n    widthInput?.addEventListener('input', () => {\r\n      this.width = parseInt(widthInput.value) || this.options.width;\r\n      if (this.keepRatio) {\r\n        this.height = Math.round(this.width / this.aspectRatio);\r\n        heightInput.value = String(this.height);\r\n      }\r\n      this.updatePreview();\r\n    });\r\n    \r\n    heightInput?.addEventListener('input', () => {\r\n      this.height = parseInt(heightInput.value) || this.options.height;\r\n      if (this.keepRatio) {\r\n        this.width = Math.round(this.height * this.aspectRatio);\r\n        widthInput.value = String(this.width);\r\n      }\r\n      this.updatePreview();\r\n    });\r\n    \r\n    // Keep ratio toggle\r\n    this.dialog.querySelector('[data-action=\"toggle-ratio\"]')?.addEventListener('click', (e) => {\r\n      this.keepRatio = !this.keepRatio;\r\n      (e.currentTarget as HTMLElement).classList.toggle('active', this.keepRatio);\r\n    });\r\n    \r\n    // Quality slider\r\n    const qualitySlider = this.dialog.querySelector('[data-slider=\"quality\"]') as HTMLInputElement;\r\n    qualitySlider?.addEventListener('input', () => {\r\n      this.quality = parseFloat(qualitySlider.value);\r\n      const valueEl = this.dialog!.querySelector('[data-value=\"quality\"]');\r\n      if (valueEl) valueEl.textContent = `${Math.round(this.quality * 100)}%`;\r\n    });\r\n    \r\n    // Watermark checkbox\r\n    this.dialog.querySelector('[data-check=\"watermark\"]')?.addEventListener('change', (e) => {\r\n      this.watermarkEnabled = (e.target as HTMLInputElement).checked;\r\n      const opts = this.dialog!.querySelector('.ie-watermark-options') as HTMLElement;\r\n      if (opts) opts.style.display = this.watermarkEnabled ? 'block' : 'none';\r\n    });\r\n    \r\n    // Watermark text\r\n    this.dialog.querySelector('[data-input=\"watermark-text\"]')?.addEventListener('input', (e) => {\r\n      this.watermarkText = (e.target as HTMLInputElement).value;\r\n    });\r\n    \r\n    // Close on overlay click\r\n    this.overlay?.addEventListener('click', (e) => {\r\n      if (e.target === this.overlay) {\r\n        this.cancel();\r\n      }\r\n    });\r\n    \r\n    // Close on Escape\r\n    document.addEventListener('keydown', this.handleKeyDown);\r\n  }\r\n\r\n  private handleKeyDown = (e: KeyboardEvent): void => {\r\n    if (e.key === 'Escape') {\r\n      this.cancel();\r\n    } else if (e.key === 'Enter') {\r\n      this.confirm();\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Set export format\r\n   */\r\n  private setFormat(format: ExportFormat): void {\r\n    this.format = format;\r\n    \r\n    // Update buttons\r\n    this.dialog?.querySelectorAll('[data-format]').forEach(btn => {\r\n      btn.classList.toggle('active', btn.getAttribute('data-format') === format);\r\n    });\r\n    \r\n    // Show/hide quality section\r\n    const qualitySection = this.dialog?.querySelector('.ie-quality-section') as HTMLElement;\r\n    if (qualitySection) {\r\n      qualitySection.style.display = format === 'png' ? 'none' : 'block';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update preview\r\n   */\r\n  private updatePreview(): void {\r\n    const preview = this.dialog?.querySelector('.ie-export-preview');\r\n    if (preview) {\r\n      preview.innerHTML = `<div style=\"color:var(--ie-text-muted);font-size:12px;\">${this.width} × ${this.height} px</div>`;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cancel and close\r\n   */\r\n  private cancel(): void {\r\n    document.removeEventListener('keydown', this.handleKeyDown);\r\n    this.hide();\r\n    this.resolvePromise?.(null);\r\n  }\r\n\r\n  /**\r\n   * Confirm and return result\r\n   */\r\n  private confirm(): void {\r\n    document.removeEventListener('keydown', this.handleKeyDown);\r\n    \r\n    const result: ExportDialogResult = {\r\n      format: this.format,\r\n      quality: this.quality,\r\n      width: this.width,\r\n      height: this.height,\r\n    };\r\n    \r\n    if (this.watermarkEnabled && this.watermarkText) {\r\n      result.watermark = {\r\n        text: this.watermarkText,\r\n        position: 'bottom-right',\r\n        opacity: 0.5,\r\n      };\r\n    }\r\n    \r\n    this.hide();\r\n    this.resolvePromise?.(result);\r\n  }\r\n\r\n  /**\r\n   * Destroy dialog\r\n   */\r\n  destroy(): void {\r\n    document.removeEventListener('keydown', this.handleKeyDown);\r\n    this.hide();\r\n    this.resolvePromise = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Apply watermark to canvas\r\n */\r\nexport function applyWatermark(\r\n  canvas: HTMLCanvasElement,\r\n  watermark: NonNullable<ExportDialogResult['watermark']>\r\n): void {\r\n  const ctx = canvas.getContext('2d');\r\n  if (!ctx || !watermark.text) return;\r\n  \r\n  ctx.save();\r\n  \r\n  // Set watermark style\r\n  const fontSize = Math.max(12, Math.min(canvas.width, canvas.height) * 0.03);\r\n  ctx.font = `${fontSize}px sans-serif`;\r\n  ctx.fillStyle = `rgba(255, 255, 255, ${watermark.opacity || 0.5})`;\r\n  ctx.strokeStyle = `rgba(0, 0, 0, ${(watermark.opacity || 0.5) * 0.5})`;\r\n  ctx.lineWidth = 1;\r\n  \r\n  // Calculate position\r\n  const metrics = ctx.measureText(watermark.text);\r\n  const padding = fontSize;\r\n  let x: number, y: number;\r\n  \r\n  switch (watermark.position) {\r\n    case 'top-left':\r\n      x = padding;\r\n      y = padding + fontSize;\r\n      break;\r\n    case 'top-right':\r\n      x = canvas.width - metrics.width - padding;\r\n      y = padding + fontSize;\r\n      break;\r\n    case 'bottom-left':\r\n      x = padding;\r\n      y = canvas.height - padding;\r\n      break;\r\n    case 'center':\r\n      x = (canvas.width - metrics.width) / 2;\r\n      y = canvas.height / 2;\r\n      break;\r\n    case 'bottom-right':\r\n    default:\r\n      x = canvas.width - metrics.width - padding;\r\n      y = canvas.height - padding;\r\n      break;\r\n  }\r\n  \r\n  // Draw watermark with stroke for visibility\r\n  ctx.strokeText(watermark.text, x, y);\r\n  ctx.fillText(watermark.text, x, y);\r\n  \r\n  ctx.restore();\r\n}\r\n","/**\r\n * Rulers - Pixel rulers and grid overlay for the editor\r\n */\r\n\r\nexport interface RulersOptions {\r\n  /** Show horizontal ruler */\r\n  showHorizontal?: boolean;\r\n  /** Show vertical ruler */\r\n  showVertical?: boolean;\r\n  /** Show grid */\r\n  showGrid?: boolean;\r\n  /** Grid size in pixels */\r\n  gridSize?: number;\r\n  /** Ruler color */\r\n  rulerColor?: string;\r\n  /** Grid color */\r\n  gridColor?: string;\r\n  /** Ruler background */\r\n  rulerBackground?: string;\r\n  /** Unit (pixels or percentage) */\r\n  unit?: 'px' | '%';\r\n}\r\n\r\nconst defaultOptions: Required<RulersOptions> = {\r\n  showHorizontal: true,\r\n  showVertical: true,\r\n  showGrid: false,\r\n  gridSize: 50,\r\n  rulerColor: '#666',\r\n  gridColor: 'rgba(128, 128, 128, 0.3)',\r\n  rulerBackground: '#f5f5f5',\r\n  unit: 'px',\r\n};\r\n\r\nexport class Rulers {\r\n  private options: Required<RulersOptions>;\r\n  private container: HTMLElement;\r\n  private horizontalRuler: HTMLCanvasElement | null = null;\r\n  private verticalRuler: HTMLCanvasElement | null = null;\r\n  private gridOverlay: HTMLCanvasElement | null = null;\r\n  \r\n  // View state\r\n  private scale = 1;\r\n  private offsetX = 0;\r\n  private offsetY = 0;\r\n  private canvasWidth = 0;\r\n  private canvasHeight = 0;\r\n  \r\n  constructor(container: HTMLElement, options: RulersOptions = {}) {\r\n    this.container = container;\r\n    this.options = { ...defaultOptions, ...options };\r\n    this.init();\r\n  }\r\n  \r\n  private init(): void {\r\n    // Create horizontal ruler\r\n    if (this.options.showHorizontal) {\r\n      this.horizontalRuler = document.createElement('canvas');\r\n      this.horizontalRuler.className = 'ie-ruler ie-ruler-horizontal';\r\n      this.horizontalRuler.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 24px;\r\n        height: 24px;\r\n        width: calc(100% - 24px);\r\n        background: ${this.options.rulerBackground};\r\n        border-bottom: 1px solid #ddd;\r\n        z-index: 100;\r\n      `;\r\n      this.container.appendChild(this.horizontalRuler);\r\n    }\r\n    \r\n    // Create vertical ruler\r\n    if (this.options.showVertical) {\r\n      this.verticalRuler = document.createElement('canvas');\r\n      this.verticalRuler.className = 'ie-ruler ie-ruler-vertical';\r\n      this.verticalRuler.style.cssText = `\r\n        position: absolute;\r\n        top: 24px;\r\n        left: 0;\r\n        width: 24px;\r\n        height: calc(100% - 24px);\r\n        background: ${this.options.rulerBackground};\r\n        border-right: 1px solid #ddd;\r\n        z-index: 100;\r\n      `;\r\n      this.container.appendChild(this.verticalRuler);\r\n    }\r\n    \r\n    // Create corner piece\r\n    if (this.options.showHorizontal && this.options.showVertical) {\r\n      const corner = document.createElement('div');\r\n      corner.className = 'ie-ruler-corner';\r\n      corner.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        width: 24px;\r\n        height: 24px;\r\n        background: ${this.options.rulerBackground};\r\n        border-right: 1px solid #ddd;\r\n        border-bottom: 1px solid #ddd;\r\n        z-index: 101;\r\n      `;\r\n      this.container.appendChild(corner);\r\n    }\r\n    \r\n    // Create grid overlay\r\n    if (this.options.showGrid) {\r\n      this.gridOverlay = document.createElement('canvas');\r\n      this.gridOverlay.className = 'ie-grid-overlay';\r\n      this.gridOverlay.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100%;\r\n        height: 100%;\r\n        pointer-events: none;\r\n        z-index: 50;\r\n      `;\r\n      this.container.appendChild(this.gridOverlay);\r\n    }\r\n    \r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Update view state */\r\n  updateView(scale: number, offsetX: number, offsetY: number, canvasWidth: number, canvasHeight: number): void {\r\n    this.scale = scale;\r\n    this.offsetX = offsetX;\r\n    this.offsetY = offsetY;\r\n    this.canvasWidth = canvasWidth;\r\n    this.canvasHeight = canvasHeight;\r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Update ruler drawings */\r\n  private updateRulers(): void {\r\n    this.drawHorizontalRuler();\r\n    this.drawVerticalRuler();\r\n    this.drawGrid();\r\n  }\r\n  \r\n  private drawHorizontalRuler(): void {\r\n    if (!this.horizontalRuler) return;\r\n    \r\n    const canvas = this.horizontalRuler;\r\n    const rect = canvas.getBoundingClientRect();\r\n    canvas.width = rect.width * window.devicePixelRatio;\r\n    canvas.height = rect.height * window.devicePixelRatio;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\r\n    ctx.clearRect(0, 0, rect.width, rect.height);\r\n    \r\n    ctx.fillStyle = this.options.rulerColor;\r\n    ctx.font = '10px sans-serif';\r\n    ctx.textAlign = 'center';\r\n    \r\n    // Calculate tick interval based on scale\r\n    const baseInterval = this.getTickInterval();\r\n    \r\n    // Calculate start position\r\n    const containerCenter = rect.width / 2;\r\n    const canvasStart = containerCenter + this.offsetX - (this.canvasWidth * this.scale) / 2;\r\n    \r\n    // Draw ticks\r\n    for (let i = 0; i <= this.canvasWidth; i += baseInterval) {\r\n      const x = canvasStart + i * this.scale;\r\n      if (x < 0 || x > rect.width) continue;\r\n      \r\n      const isMajor = i % (baseInterval * 5) === 0;\r\n      const tickHeight = isMajor ? 12 : 6;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(x, rect.height);\r\n      ctx.lineTo(x, rect.height - tickHeight);\r\n      ctx.stroke();\r\n      \r\n      if (isMajor) {\r\n        ctx.fillText(String(i), x, rect.height - 14);\r\n      }\r\n    }\r\n  }\r\n  \r\n  private drawVerticalRuler(): void {\r\n    if (!this.verticalRuler) return;\r\n    \r\n    const canvas = this.verticalRuler;\r\n    const rect = canvas.getBoundingClientRect();\r\n    canvas.width = rect.width * window.devicePixelRatio;\r\n    canvas.height = rect.height * window.devicePixelRatio;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\r\n    ctx.clearRect(0, 0, rect.width, rect.height);\r\n    \r\n    ctx.fillStyle = this.options.rulerColor;\r\n    ctx.font = '10px sans-serif';\r\n    ctx.textAlign = 'right';\r\n    \r\n    // Calculate tick interval based on scale\r\n    const baseInterval = this.getTickInterval();\r\n    \r\n    // Calculate start position\r\n    const containerCenter = rect.height / 2;\r\n    const canvasStart = containerCenter + this.offsetY - (this.canvasHeight * this.scale) / 2;\r\n    \r\n    // Draw ticks\r\n    for (let i = 0; i <= this.canvasHeight; i += baseInterval) {\r\n      const y = canvasStart + i * this.scale;\r\n      if (y < 0 || y > rect.height) continue;\r\n      \r\n      const isMajor = i % (baseInterval * 5) === 0;\r\n      const tickWidth = isMajor ? 12 : 6;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(rect.width, y);\r\n      ctx.lineTo(rect.width - tickWidth, y);\r\n      ctx.stroke();\r\n      \r\n      if (isMajor) {\r\n        ctx.save();\r\n        ctx.translate(rect.width - 14, y);\r\n        ctx.rotate(-Math.PI / 2);\r\n        ctx.textAlign = 'center';\r\n        ctx.fillText(String(i), 0, 0);\r\n        ctx.restore();\r\n      }\r\n    }\r\n  }\r\n  \r\n  private drawGrid(): void {\r\n    if (!this.gridOverlay) return;\r\n    \r\n    const canvas = this.gridOverlay;\r\n    const rect = canvas.getBoundingClientRect();\r\n    canvas.width = rect.width * window.devicePixelRatio;\r\n    canvas.height = rect.height * window.devicePixelRatio;\r\n    \r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) return;\r\n    \r\n    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);\r\n    ctx.clearRect(0, 0, rect.width, rect.height);\r\n    \r\n    ctx.strokeStyle = this.options.gridColor;\r\n    ctx.lineWidth = 1;\r\n    \r\n    // Calculate start position\r\n    const containerCenterX = rect.width / 2;\r\n    const containerCenterY = rect.height / 2;\r\n    const canvasStartX = containerCenterX + this.offsetX - (this.canvasWidth * this.scale) / 2;\r\n    const canvasStartY = containerCenterY + this.offsetY - (this.canvasHeight * this.scale) / 2;\r\n    const canvasEndX = canvasStartX + this.canvasWidth * this.scale;\r\n    const canvasEndY = canvasStartY + this.canvasHeight * this.scale;\r\n    \r\n    // Draw vertical lines\r\n    for (let i = 0; i <= this.canvasWidth; i += this.options.gridSize) {\r\n      const x = canvasStartX + i * this.scale;\r\n      if (x < 0 || x > rect.width) continue;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(x, Math.max(0, canvasStartY));\r\n      ctx.lineTo(x, Math.min(rect.height, canvasEndY));\r\n      ctx.stroke();\r\n    }\r\n    \r\n    // Draw horizontal lines\r\n    for (let i = 0; i <= this.canvasHeight; i += this.options.gridSize) {\r\n      const y = canvasStartY + i * this.scale;\r\n      if (y < 0 || y > rect.height) continue;\r\n      \r\n      ctx.beginPath();\r\n      ctx.moveTo(Math.max(0, canvasStartX), y);\r\n      ctx.lineTo(Math.min(rect.width, canvasEndX), y);\r\n      ctx.stroke();\r\n    }\r\n  }\r\n  \r\n  /** Get tick interval based on scale */\r\n  private getTickInterval(): number {\r\n    if (this.scale < 0.25) return 100;\r\n    if (this.scale < 0.5) return 50;\r\n    if (this.scale < 1) return 25;\r\n    if (this.scale < 2) return 10;\r\n    return 5;\r\n  }\r\n  \r\n  /** Toggle grid visibility */\r\n  setGridVisible(visible: boolean): void {\r\n    this.options.showGrid = visible;\r\n    if (visible && !this.gridOverlay) {\r\n      this.gridOverlay = document.createElement('canvas');\r\n      this.gridOverlay.className = 'ie-grid-overlay';\r\n      this.gridOverlay.style.cssText = `\r\n        position: absolute;\r\n        top: 0;\r\n        left: 0;\r\n        width: 100%;\r\n        height: 100%;\r\n        pointer-events: none;\r\n        z-index: 50;\r\n      `;\r\n      this.container.appendChild(this.gridOverlay);\r\n    } else if (!visible && this.gridOverlay) {\r\n      this.gridOverlay.remove();\r\n      this.gridOverlay = null;\r\n    }\r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Set grid size */\r\n  setGridSize(size: number): void {\r\n    this.options.gridSize = size;\r\n    this.updateRulers();\r\n  }\r\n  \r\n  /** Destroy rulers */\r\n  destroy(): void {\r\n    this.horizontalRuler?.remove();\r\n    this.verticalRuler?.remove();\r\n    this.gridOverlay?.remove();\r\n    // Remove corner\r\n    this.container.querySelector('.ie-ruler-corner')?.remove();\r\n  }\r\n}\r\n\r\n/** Create rulers helper */\r\nexport function createRulers(container: HTMLElement, options?: RulersOptions): Rulers {\r\n  return new Rulers(container, options);\r\n}\r\n","/**\n * @image-editor/core\n * Core library for image editor plugin - zero dependencies\n */\n\n// Types\nexport type {\n  EditorOptions,\n  EditorInterface,\n  HistoryState,\n  HistoryManagerInterface,\n} from './types/editor.types';\n\nexport type {\n  Plugin,\n  PluginConstructor,\n  PluginContext,\n  TextLayer,\n  MosaicPluginInterface,\n  TextPluginInterface,\n  FilterPluginInterface,\n} from './types/plugin.types';\n\nexport type {\n  EditorEvents,\n  EventHandler,\n  EventListenerOptions,\n  PointerEventData,\n  GestureEventData,\n  EventEmitter,\n} from './types/event.types';\n\nexport type {\n  ExportFormat,\n  ExportDataType,\n  DeviceType,\n  ExportOptions,\n  MosaicConfig,\n  TextConfig,\n  FilterConfig,\n  EditorConfig,\n  DeepPartial,\n} from './types/config.types';\n\n// Constants\nexport {\n  DEFAULT_EDITOR_CONFIG,\n  DEFAULT_MOSAIC_CONFIG,\n  DEFAULT_TEXT_CONFIG as DEFAULT_TEXT_STYLE,\n  DEFAULT_FILTER_CONFIG,\n  DEFAULT_EXPORT_OPTIONS,\n} from './constants/defaults';\n\nexport {\n  EDITOR_EVENTS,\n  PLUGIN_EVENTS,\n  CANVAS_EVENTS,\n} from './constants/events';\n\n// DOM utilities\nexport {\n  getElement,\n  createCanvas,\n  getContext2D,\n  getElementRect,\n  getRelativeCoordinates,\n  setCanvasSize,\n  clearCanvas,\n  fillCanvas,\n  setStyles,\n  removeElement,\n  isInViewport,\n} from './utils/dom.utils';\n\n// Image utilities\nexport {\n  loadImage,\n  getImageDimensions,\n  calculateAspectRatioFit,\n  drawImageToCanvas,\n  getImageData,\n  putImageData,\n  cloneImageData,\n  createImageData,\n  canvasToDataURL,\n  canvasToBlob,\n  createScaledCanvas,\n} from './utils/image.utils';\n\n// Event utilities\nexport {\n  normalizePointerEvent,\n  getTouchDistance,\n  getTouchCenter,\n  createPinchEvent,\n  createPanEvent,\n  throttle,\n  debounce,\n  preventDefault,\n  stopPropagation,\n  addEventListenerWithCleanup,\n} from './utils/event.utils';\n\n// Device utilities\nexport {\n  isTouchDevice,\n  isMobileDevice,\n  isIOSDevice,\n  isAndroidDevice,\n  detectDeviceType,\n  getResolvedDeviceType,\n  getDevicePixelRatio,\n  supportsPassiveEvents,\n  getPassiveOptions,\n  getNonPassiveOptions,\n  supportsPointerEvents,\n  getViewportDimensions,\n} from './utils/device.utils';\n\n// Export utilities\nexport { exportImage } from './utils/export.utils';\nexport { createPlaceholder } from './utils/placeholder';\nexport type { PlaceholderOptions } from './utils/placeholder';\n\n// Managers\nexport { EventManager } from './managers/EventManager';\nexport { ConfigManager } from './managers/ConfigManager';\nexport { HistoryManager } from './managers/HistoryManager';\nexport { PluginManager } from './managers/PluginManager';\nexport { KeyboardManager, createEditorShortcuts } from './managers/KeyboardManager';\nexport type { ShortcutConfig, ShortcutGroup } from './managers/KeyboardManager';\n\n// Core\nexport { Editor } from './core/Editor';\nexport { Canvas } from './core/Canvas';\n\n// Plugins\nexport { BasePlugin } from './plugins/base/BasePlugin';\n\nexport { MosaicPlugin } from './plugins/mosaic/MosaicPlugin';\nexport {\n  applyMosaicToRegion,\n  applyMosaicAlongPath,\n  applyMosaicToCircularRegion,\n  interpolatePoints,\n} from './plugins/mosaic/mosaic.utils';\n\nexport { TextPlugin } from './plugins/text/TextPlugin';\nexport { TextLayerManager, DEFAULT_TEXT_CONFIG } from './plugins/text/TextLayer';\nexport {\n  buildFontString,\n  measureText,\n  getTextBoundingBox,\n  isPointInTextLayer,\n  findTextLayerAtPoint,\n  renderTextLayer,\n  renderAllTextLayers,\n} from './plugins/text/text.utils';\n\nexport { FilterPlugin } from './plugins/filter/FilterPlugin';\nexport {\n  applyBrightness,\n  applyContrast,\n  applySaturation,\n  applyBlur,\n  applyGrayscale,\n  applySepia,\n  applyInvert,\n} from './plugins/filter/filters';\n\n// UI Components\nexport { Toolbar } from './ui/Toolbar';\nexport type { ToolbarOptions, ToolName } from './ui/Toolbar';\nexport { icons } from './ui/icons';\nexport type { IconName } from './ui/icons';\nexport { injectStyles, toolbarStyles } from './ui/toolbar.styles';\nexport { ShapeLayerManager } from './ui/ShapeLayer';\nexport type { Shape, ShapeType, ShapeStyle, Point, PenShape, RectShape, CircleShape, ArrowShape, TextShape, LineShape, TriangleShape } from './ui/ShapeLayer';\n\n// Crop Tool\nexport { CropTool, applyCropToCanvas } from './ui/CropTool';\nexport type { CropToolOptions, CropRect, CropRatio } from './ui/CropTool';\n\n// Context Menu\nexport { ContextMenu, createShapeMenuItems } from './ui/ContextMenu';\nexport type { MenuItemConfig, ContextMenuOptions } from './ui/ContextMenu';\n\n// Export Dialog\nexport { ExportDialog, applyWatermark } from './ui/ExportDialog';\nexport type { ExportDialogOptions, ExportDialogResult } from './ui/ExportDialog';\n\n// Rulers\nexport { Rulers, createRulers } from './ui/Rulers';\nexport type { RulersOptions } from './ui/Rulers';\n\n// i18n\nexport { I18n, getI18n, t, zhCN, enUS } from './i18n';\nexport type { SupportedLocale, LocaleKey, LocaleMessages } from './i18n';\n\n// Version\nexport const VERSION = '0.2.0';\n"],"names":["DEFAULT_EDITOR_CONFIG","DEFAULT_MOSAIC_CONFIG","DEFAULT_TEXT_CONFIG","DEFAULT_FILTER_CONFIG","DEFAULT_EXPORT_OPTIONS","EDITOR_EVENTS","PLUGIN_EVENTS","CANVAS_EVENTS","getElement","selector","createCanvas","width","height","canvas","getContext2D","ctx","getElementRect","element","getRelativeCoordinates","event","rect","setCanvasSize","clearCanvas","fillCanvas","color","setStyles","styles","removeElement","_a","isInViewport","loadImage","source","resolve","reject","img","getImageDimensions","image","calculateAspectRatioFit","srcWidth","srcHeight","maxWidth","maxHeight","ratio","drawImageToCanvas","x","y","getImageData","w","h","putImageData","imageData","cloneImageData","createImageData","canvasToDataURL","format","quality","mimeType","canvasToBlob","blob","createScaledCanvas","sourceCanvas","normalizePointerEvent","type","touch","getTouchDistance","touch1","touch2","dx","dy","getTouchCenter","createPinchEvent","touches","initialDistance","currentDistance","center","createPanEvent","deltaX","deltaY","throttle","fn","delay","lastCall","args","now","debounce","timeoutId","preventDefault","stopPropagation","addEventListenerWithCleanup","listener","options","isTouchDevice","isMobileDevice","userAgent","isIOSDevice","isAndroidDevice","detectDeviceType","getResolvedDeviceType","deviceType","getDevicePixelRatio","supportsPassiveEvents","passiveSupported","getPassiveOptions","getNonPassiveOptions","supportsPointerEvents","getViewportDimensions","exportImage","opts","targetCanvas","extension","fileName","createPlaceholder","text","subText","theme","isDark","borderColor","iconColor","textColor","subTextColor","padding","cornerRadius","boxLeft","boxTop","boxWidth","boxHeight","centerX","centerY","imgBoxW","imgBoxH","imgBoxX","imgBoxY","imgRadius","EventManager","__publicField","handler","eventName","listeners","data","listenersArray","error","ConfigManager","userConfig","defaultConfig","result","key","userValue","updates","oldConfig","value","currentConfig","generateId","HistoryManager","limit","state","newState","canUndo","canRedo","PluginManager","context","PluginClass","plugin","name","prevPluginName","pluginName","getShortcutKey","config","parts","KeyboardManager","target","enabled","group","fullConfig","configs","unregisters","groupName","_","shortcut","e","isMac","keyMap","createEditorShortcuts","handlers","shortcuts","tool","index","Canvas","container","entries","entry","containerRect","containerWidth","containerHeight","imgWidth","imgHeight","previousWidth","previousHeight","newWidth","newHeight","targetWidth","targetHeight","scaled","preserveContent","createSvg","paths","size","icons","toolbarStyles","injectStyles","styleId","style","shapeIdCounter","ShapeLayerManager","id","baseShape","s","shape","prev","tolerance","i","p1","p2","px","py","x1","y1","x2","y2","len2","t","nearX","nearY","p","callback","offset","newId","clonedShape","headLen","angle","bounds","minX","minY","maxX","maxY","xs","ys","scaleX","scaleY","anchorX","anchorY","newX","newY","defaultOptions","Toolbar","editor","toolbar","disabled","zoomGroup","zoomOutBtn","zoomInBtn","resetBtn","toolGroup","moveBtn","penBtn","rectBtn","circleBtn","arrowBtn","lineBtn","triangleBtn","textBtn","mosaicBtn","eraserBtn","advancedGroup","cropBtn","filterBtn","historyGroup","undoBtn","redoBtn","cropActionGroup","cropCancelBtn","cropConfirmBtn","exportBtn","span","divider","icon","onClick","active","isHistoryBtn","btn","tooltipInfo","tooltip","_b","_c","panel","widthEl","colorEl","colorInput","brushEl","blockEl","brushSlider","blockSlider","_toolbar","sizeEl","sizeSlider","preset","b","slider","filterName","valueEl","_d","brightness","contrast","saturation","blur","filters","presets","settings","brightnessSlider","contrastSlider","saturationSlider","blurSlider","val","delta","pos","selected","scaleRatio","newScale","currentCenter","isInPanel","isToolbarBtn","file","reader","dataUrl","midX","clientX","clientY","radius","dist","step","steps","cx","cy","blockSize","by","bx","bcx","bcy","r","g","count","blockEndX","blockEndY","idx","toolButtons","baseSize","panelName","canvasPos","left","top","textArea","_e","_f","_g","fontSelect","fontStyle","fontWeight","metrics","margin","boxX","boxY","cropBox","isDragging","isResizing","activeHandle","startX","startY","startLeft","startTop","startWidth","startHeight","handle","newLeft","newTop","maskTop","maskLeft","maskRight","maskBottom","croppedData","pureData","radiusSq","regionWidth","regionHeight","currentData","currentPixels","purePixels","pureWidth","pixelsChanged","distSq","pureIdx","currentIdx","edgeFade","mouseX","mouseY","scaleDiff","percent","link","err","resolvedTheme","disabledTools","allToggleableButtons","btnName","zoomHidden","groupTools","isGroupVisible","tools","isExportVisible","zoomVisible","toolOrAdvancedVisible","historyVisible","cropActionVisible","visible","placeholder","_Editor","editorConfig","prevTool","toolbarOption","toolbarConfig","toolName","description","isUserImage","activeName","exportUtils","export_utils","exportOptions","Editor","BasePlugin","_config","applyMosaicToRegion","intensity","endX","endY","effectiveBlockSize","normalizedIntensity","blockY","blockX","blockWidth","blockHeight","pixelCount","totalR","totalG","totalB","totalA","avgR","avgG","avgB","avgA","applyMosaicAlongPath","points","brushSize","point","applyMosaicToCircularRegion","radiusSquared","blockCenterX","blockCenterY","pdx","pdy","interpolatePoints","spacing","distance","MosaicPlugin","mode","nonPassiveOptions","touchStartHandler","touchMoveHandler","touchEndHandler","mouseDownHandler","mouseMoveHandler","mouseUpHandler","cleanup","pointerEvent","currentX","currentY","TextLayerManager","layer","buildFontString","measureText","originalFont","lines","lineHeight","line","getTextBoundingBox","dimensions","isPointInTextLayer","box","findTextLayerAtPoint","layers","renderTextLayer","isSelected","lineY","drawUnderline","drawSelectionBox","underlineY","underlineThickness","handleSize","corners","corner","renderAllTextLayers","selectedId","TextPlugin","dblClickHandler","clickedLayer","applyBrightness","adjustment","clamp","applyContrast","factor","applySaturation","multiplier","gray","applyBlur","original","temp","horizontalBlur","verticalBlur","src","dst","diameter","rSum","gSum","bSum","aSum","dstIdx","leftX","rightX","leftIdx","rightIdx","topY","bottomY","topIdx","bottomIdx","applyGrayscale","applySepia","sepiaR","sepiaG","sepiaB","applyInvert","invertR","invertG","invertB","FilterPlugin","createImageDataCopy","clampValue","clampedConfig","restoredData","previewData","min","max","zhCN","enUS","locales","I18n","locale","params","message","k","v","messages","browserLocale","lang","defaultI18n","getI18n","MIN_CROP_SIZE","CropTool","grid","ratioGroup","transformGroup","actionGroup","action","canvasRect","offsetX","offsetY","minSize","newW","newH","rw","rh","applyCropToCanvas","rotation","flipH","flipV","croppedWidth","croppedHeight","tempCanvas","tempCtx","drawWidth","drawHeight","ContextMenu","items","menu","item","menuItem","menuRect","viewportWidth","viewportHeight","createShapeMenuItems","i18n","ExportDialog","widthInput","heightInput","qualitySlider","qualitySection","preview","applyWatermark","watermark","fontSize","Rulers","scale","canvasWidth","canvasHeight","baseInterval","canvasStart","isMajor","tickHeight","tickWidth","containerCenterX","containerCenterY","canvasStartX","canvasStartY","canvasEndX","canvasEndY","createRulers","VERSION"],"mappings":"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;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA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"}